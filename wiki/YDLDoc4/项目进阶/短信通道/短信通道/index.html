
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.33.1" theme-name="Stellar" theme-version="1.33.1">
  <link rel="canonical" href="https://blog.thatcoder.cn/wiki/YDLDoc4/项目进阶/短信通道/短信通道">
  
  <meta name="generator" content="Hexo 7.3.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  <meta name="theme-color" content="#f9fafb">
  <title>YDLDoc4：短信通道 - 钟意博客</title>

  
    <meta name="description" content="# 第1章 项目概述及管理端提示课程视频教程链接：https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1bL4y1871topen in new window# 1. 项目概述# 1.1 背景介绍随着企业业务扩张、应用成倍的增加、短信规模化使用，传统短信平台的接入方式和单一的信息发送功能，已经不能完全满足现代企业管理的需求，所以统一入口、减少对接成本、同时兼顾多种短信业务、简单易行的">
<meta property="og:type" content="website">
<meta property="og:title" content="短信通道">
<meta property="og:url" content="https://blog.thatcoder.cn/wiki/YDLDoc4/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/">
<meta property="og:site_name" content="钟意博客">
<meta property="og:description" content="# 第1章 项目概述及管理端提示课程视频教程链接：https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1bL4y1871topen in new window# 1. 项目概述# 1.1 背景介绍随着企业业务扩张、应用成倍的增加、短信规模化使用，传统短信平台的接入方式和单一的信息发送功能，已经不能完全满足现代企业管理的需求，所以统一入口、减少对接成本、同时兼顾多种短信业务、简单易行的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.thatcoder.cn/favicon.ico">
<meta property="article:published_time" content="2025-07-21T12:21:47.665Z">
<meta property="article:modified_time" content="2025-07-21T12:21:47.665Z">
<meta property="article:author" content="钟意">
<meta property="article:tag" content="那个码农">
<meta property="article:tag" content="码农钟意">
<meta property="article:tag" content="钟意的博客">
<meta property="article:tag" content="钟意博客">
<meta property="article:tag" content="That Coder">
<meta property="article:tag" content="thatcoder">
<meta property="article:tag" content="源柒拾柒雅舍">
<meta property="article:tag" content="源WebGary">
<meta property="article:tag" content="giligili.work">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.thatcoder.cn/favicon.ico">
  
  

  <meta name="keywords" content="那个码农,码农钟意,钟意的博客,钟意博客,That Coder,thatcoder,源柒拾柒雅舍,源WebGary,giligili.work">

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="钟意博客" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/main.css?v=1.33.1">


  
    <link rel="shortcut icon" href="/favicon.ico">
  

  
    
<link rel="stylesheet" href="/custom/css/ZYCode.css">

  

  <script type="application/ld+json">{"@context":"https://schema.org","@type":"Website","@id":"https://blog.thatcoder.cn/wiki/YDLDoc4/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/","author":{"@type":"Person","name":"钟意","sameAs":[],"image":"/favicon.ico"},"name":"短信通道","description":"# 第1章 项目概述及管理端提示课程视频教程链接：https://www.bilibili.com/video/BV1bL4y1871topen in new window# 1. 项目概述# 1.1 背景介绍随着企业业务扩张、应用成倍的增加、短信规模化使用，传统短信平台的接入方式和单一的信息发送功能，已经不能完全满足现代企业管理的需求，所以统一入口、减少对接成本、同时兼顾多种短信业务、简单...","url":"https://blog.thatcoder.cn/wiki/YDLDoc4/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/","keywords":["那个码农","码农钟意","钟意的博客","钟意博客","That Coder","thatcoder","源柒拾柒雅舍","源WebGary","giligili.work"]}</script>
  <link rel="Shortcut Icon" href="/favicon.ico" type="image/x-icon" /><link rel='stylesheet' href='https://public.thatcdn.cn/font/old_song/result.css' /><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.5.1/css/all.min.css"><link rel="stylesheet" href="/custom/css/ZYTimetmpl.css" /><meta itemprop="name" content="钟意博客"><meta itemprop="author" content="钟意"><meta itemprop="description" content="笔名钟意, 记录代码与生活."><meta name="sogou_site_verification" content="spLj7Zz5dI" /><meta itemprop="image" content="https://upyun.thatcdn.cn/hexo/stellar/image/shot.webp"><link rel="stylesheet" href="/custom/css/ZYGlobal.css"><link rel="stylesheet" href="/custom/css/ZYWaline.css"><link rel="stylesheet" href="/custom/css/ZYPage.css"><script type="text/javascript" src="/custom/js/header.js"></script><!-- Clarity tracking code for https://blog.thatcoder.cn/ -->
<script>    (function(c,l,a,r,i,t,y){        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i+"?ref=bwt";        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);    })(window, document, "clarity", "script", "fi1zg7i5q5");</script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-H6GM3XZWV7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-H6GM3XZWV7');
</script>
<!-- BaiDu-ZhanZhang
<meta name="baidu-site-verification" content="codeva-8tnFVr706d" />
<!-- BaiDu-Tongji -->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?233765a020502d5d6a92d4fe306d36c2";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</head>
<body>



<div class="l_body s:aa content tech " id="start" layout="page" type="tech" ><aside class="l_left"><div class="sidebg"></div><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><div class="icon"><img no-lazy class="icon" src="/custom/img/ydl.png" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></div><a class="title" href="/wiki/YDLDoc4/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93"><div class="main">YDLDoc4</div><div class="sub normal cap">关于YDLDoc的笔记</div><div class="sub hover cap" style="opacity:0"> 不对之处请指出</div></a></div></header>

<div class="nav-area">

<nav class="menu dis-select"><a class="nav-item" title="博客" href="/"><span>博客</span></a><a class="nav-item active" title="笔记" href="/wiki/"><span>笔记</span></a><a class="nav-item" title="便签" href="/notes/"><span>便签</span></a><a class="nav-item" title="社交" href="/links/"><span>社交</span></a></nav>
</div>
<div class="widgets">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" data-filter="/wiki/YDLDoc4/" placeholder="在 YDLDoc4 中搜索"></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div>


<widget class="widget-wrapper doc-tree post-list"><div class="widget-body fs14"><a class="link active" href="/wiki/YDLDoc4/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/#start"><span class="toc-text">短信通道</span><svg class="active-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M21 11.098v4.993c0 3.096 0 4.645-.734 5.321c-.35.323-.792.526-1.263.58c-.987.113-2.14-.907-4.445-2.946c-1.02-.901-1.529-1.352-2.118-1.47a2.225 2.225 0 0 0-.88 0c-.59.118-1.099.569-2.118 1.47c-2.305 2.039-3.458 3.059-4.445 2.945a2.238 2.238 0 0 1-1.263-.579C3 20.736 3 19.188 3 16.091v-4.994C3 6.81 3 4.666 4.318 3.333C5.636 2 7.758 2 12 2c4.243 0 6.364 0 7.682 1.332C21 4.665 21 6.81 21 11.098" opacity=".5"/><path fill="currentColor" d="M9 5.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5z"/></svg></a><a class="link" href="/wiki/YDLDoc4/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E5%B7%A5%E4%BD%9C%E6%B5%81/%E5%B7%A5%E4%BD%9C%E6%B5%81/"><span class="toc-text">工作流</span></a><a class="link" href="/wiki/YDLDoc4/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA/"><span class="toc-text">自动化构建</span></a><a class="link" href="/wiki/YDLDoc4/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/"><span class="toc-text">二奢交易</span></a></div></widget>

<widget class="widget-wrapper post-card"><div class="widget-header dis-select"><span class="name">更多：开发</span></div><div class="widget-body"><a class="item wiki" href="/wiki/YDLDoc1/javase/nio/nio/"><span class="title">元动力摘录 - JAVA阶段一</span><span class="excerpt">钟意关于YDLDoc的笔记</span></a><a class="item wiki" href="/wiki/YDLDoc3/ELK%E5%85%A5%E9%97%A8/elk%E5%85%A5%E9%97%A8/elk%E5%85%A5%E9%97%A8/"><span class="title">元动力摘录 - JAVA阶段三</span><span class="excerpt">钟意关于YDLDoc的笔记</span></a><a class="item wiki" href="/wiki/YDLDoc2/%E6%A1%86%E6%9E%B6/SpringBoot/SpringBoot/"><span class="title">元动力摘录 - JAVA阶段二</span><span class="excerpt">钟意关于YDLDoc的笔记</span></a><a class="item wiki" href="/wiki/YuDaoCloud/%E5%89%8D%E7%AB%AF%E6%89%8B%E5%86%8C%20Vue%202/Icon%20%E5%9B%BE%E6%A0%87/Icon%20%E5%9B%BE%E6%A0%87/"><span class="title">艿艿若依Cloud - 开发指南</span><span class="excerpt">关于艿艿若依Cloud的文档</span></a><a class="item wiki" href="/wiki/YuDaoBoot/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%89%8B%E5%86%8C/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%8E%A5%E5%85%A5/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%8E%A5%E5%85%A5/"><span class="title">艿艿若依Boot - 开发指南</span><span class="excerpt">关于艿艿若依Boot的文档</span></a><a class="item wiki" href="/wiki/Laf/start/start/"><span class="title">Laf - 开箱即用的 serverless</span><span class="excerpt">钟意关于Laf的笔记</span></a><a class="item wiki" href="/wiki/MySql/basics/usually/"><span class="title">MySql - 关系型数据库管理系统</span><span class="excerpt">钟意关于关系型数据库MySql的笔记</span></a><a class="item wiki" href="/wiki/SpringCloud/start/"><span class="title">SpringCloud - JAVA系分布式微服务架构</span><span class="excerpt">钟意关于SpringCloud的笔记</span></a></div></widget>

<widget class="widget-wrapper recent post-list"><div class="widget-header dis-select"><span class="name">最近更新</span></div><div class="widget-body fs14"><a class="item title" href="/wiki/forgejo/s3/"><span class="title"><strong>forgejo</strong><span class="dot"></span>Forgejo S3存储桶</span></a><a class="item title" href="/wiki/forgejo/cache/"><span class="title"><strong>forgejo</strong><span class="dot"></span>Forgejo Redis缓存</span></a><a class="item title" href="/wiki/forgejo/ssh/"><span class="title"><strong>forgejo</strong><span class="dot"></span>Forgejo SSH端口修改</span></a><a class="item title" href="/wiki/forgejo/start/"><span class="title"><strong>forgejo</strong><span class="dot"></span>Forgejo 容器部署</span></a><a class="item title" href="/notes/"><span class="title"><strong>便签</strong><span class="dot"></span>钟意的便签</span></a><a class="item title" href="/notes/develop/"><span class="title"><strong>开发速查</strong><span class="dot"></span>开发助手</span></a></div></widget>
</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" style="grid-column: span 3;height:32px;padding: 0;" href="https://space.bilibili.com/1664687779" target="_blank" rel="external nofollow noopener noreferrer"><img height="32px" src="https://upyun.thatcdn.cn/public/img/icon/bilibili-banner.jpg"/></a><a class="social" style="grid-column: span 3;height:32px;padding: 0;" href="https://muselink.cc/naive" target="_blank" rel="external nofollow noopener noreferrer"><img height="32px" src="https://upyun.thatcdn.cn/public/img/icon/wechat-banner.jpg"/></a><a class="social" style="grid-column: span 3;height:32px;padding: 0;" href="https://github.com/ThatCoders" target="_blank" rel="external nofollow noopener noreferrer"><img height="32px" src="https://upyun.thatcdn.cn/public/img/icon/github-banner.jpg"/></a><a class="social" href="javascript:ThemeChange('dark');" rel="noopener noreferrer"><img id="ThemeM" src="https://upyun.thatcdn.cn/public/img/icon/Moon.png"/></a><a class="social" href="javascript:ThemeChange('light');" rel="noopener noreferrer"><img id="ThemeL" src="https://upyun.thatcdn.cn/public/img/icon/Sun.png"/></a><a class="social" href="javascript:ThemeChange('auto');" rel="noopener noreferrer"><img id="ThemeAI" src="https://upyun.thatcdn.cn/public/img/icon/AI.png"/></a></div></footer>
</div></aside><div class="l_main" id="main">





<div class="article banner top">
    <div class="content">
      <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a>
<span class="sep"></span><a class="cap breadcrumb" id="menu" href="/wiki/">文档</a><span class="sep"></span><a class="cap breadcrumb" id="proj" href="/wiki/YDLDoc4/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/">YDLDoc4</a></div>
<div class="flex-row" id="post-meta"><span class="text created">更新于：<time datetime="2025-07-21T12:21:47.665Z">2025-07-21</time></span></div></div><div class="right"><div class="flex-row" id="post-meta" style="justify-content: flex-end;">
            <span class="text updated" id="busuanzi_value_page_pv"></span><span class="text updated"> 阅</span>
            <span class="sep updated"></span>
            <span class="text">12.8k 字</span>
            <span class="sep"></span>
            <span class="text">55 分</span>
        </div></div></div>
      
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>短信通道</span></h1>
        
      </div>
    </div>
    
    </div>
    </div><article class="md-text content"><div class="theme-hope-content"><h1 id="第1章-项目概述及管理端" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第1章-项目概述及管理端">#</a> 第1章 项目概述及管理端</h1><div class="hint-container tip"><p class="hint-container-title">提示</p><p>课程视频教程链接：<a href="https://www.bilibili.com/video/BV1bL4y1871t" rel="noopener noreferrer" target="_blank">https://www.bilibili.com/video/BV1bL4y1871t<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><h2 id="_1-项目概述" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-项目概述">#</a> 1. 项目概述</h2><h3 id="_1-1-背景介绍" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-1-背景介绍">#</a> 1.1 背景介绍</h3><p>随着企业业务扩张、应用成倍的增加、短信规模化使用，传统短信平台的接入方式和单一的信息发送功能，已经不能完全满足现代企业管理的需求，所以统一入口、减少对接成本、同时兼顾多种短信业务、简单易行的操作与维护、高稳定、高可靠的移动信息化应用成为短信平台发展趋势。</p><figure><img alt="image-20210916094348274" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210916094348274-a7627fe5.png" tabindex="0"/><figcaption>image-20210916094348274</figcaption></figure><ul><li>服务越来越多，每个服务都有可能发送短信，是否每个服务都需要对接一遍？</li><li>多应用对接短信，如何做到短信发送服务高效、稳定？</li><li>短信通道出现异常时，如何快速切换通道？</li><li>切换通道时，如何做到应用服务无感知？</li><li>如何统计各服务短信发送情况，以便进行后续营销分析？</li></ul><p>本项目（动力短信平台）的核心在于保证短信高效、准确的送达、简单易操作的对接方式。通过对服务的解耦、通讯方式的升级来提升系统的吞吐量。同时在多通道的加持下，通过智能动态的通道评级、选举、降级、热插拔，增强了系统的健壮性，摆脱对单一通道的依赖。并且提供多种对接方式，满足企业内部的各种需求。</p><p>动力短信平台的整体架构如下：</p><figure><img alt="image-20210916095249795" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210916095249795-9bf62f5d.png" tabindex="0"/><figcaption>image-20210916095249795</figcaption></figure><h3 id="_1-2-业务架构" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-2-业务架构">#</a> 1.2 业务架构</h3><figure><img alt="image-20210916100828128" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210916100828128-e2e1e21d.png" tabindex="0"/><figcaption>image-20210916100828128</figcaption></figure><h3 id="_1-3-技术架构" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-3-技术架构">#</a> 1.3 技术架构</h3><h4 id="_1-3-1-系统管理服务" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-3-1-系统管理服务">#</a> 1.3.1 系统管理服务</h4><figure><img alt="image-20210916104038523" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210916104038523-7ad154dc.png" tabindex="0"/><figcaption>image-20210916104038523</figcaption></figure><h4 id="_1-3-2-短信接收服务" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-3-2-短信接收服务">#</a> 1.3.2 短信接收服务</h4><figure><img alt="image-20210916104817659" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210916104817659-13994a17.png" tabindex="0"/><figcaption>image-20210916104817659</figcaption></figure><h4 id="_1-3-3-短信发送服务" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-3-3-短信发送服务">#</a> 1.3.3 短信发送服务</h4><figure><img alt="image-20210916105359377" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210916105359377-2a3183cd.png" tabindex="0"/><figcaption>image-20210916105359377</figcaption></figure><h3 id="_1-4-项目模块介绍" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-4-项目模块介绍">#</a> 1.4 项目模块介绍</h3><p>动力短信平台，项目整体工程结构和模块功能如下：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs text">ydl-sms-backend            # 动力短信平台父工程<br>    ├── ydl-sms-entity       # 短信平台实体<br>    ├── ydl-sms-manage       # 系统管理服务<br>    ├── ydl-sms-api          # 短信接收服务，应用系统调用接口、发送短信<br>    ├── ydl-sms-server       # 短信发送服务，调用短信通道、发送短信<br>    └── ydl-sms-sdk          # 短信SDK，应用系统引入、发送短信<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>动力短信服务有三个：后台管理服务，短信接收服务，短信发送服务：</p><table><thead><tr><th>应用</th><th>端口</th><th>说明</th><th>启动命令</th></tr></thead><tbody><tr><td>ydl-sms-manage</td><td>8770</td><td>后台管理服务</td><td>java -jar ydl-sms-manage.jar &amp;</td></tr><tr><td>ydl-sms-api</td><td>8771</td><td>短信接收服务</td><td>java -jar ydl-sms-api.jar &amp;</td></tr><tr><td>ydl-sms-server</td><td>8772</td><td>短信发送服务</td><td>java -jar ydl-sms-server.jar &amp;</td></tr></tbody></table><h2 id="_2-项目环境准备" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-项目环境准备">#</a> 2. 项目环境准备</h2><h3 id="_2-1-环境要求" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-1-环境要求">#</a> 2.1 环境要求</h3><ul><li><p>JDK ： 1.8 +</p></li><li><p>Maven： 3.3 + <a href="http://maven.apache.org/download.cgi" rel="noopener noreferrer" target="_blank">http://maven.apache.org/download.cgi<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p>Docker: 18 +</p><p>docker-compose: 1.23 +</p></li><li><p>Mysql： 5.7.0 + <a href="https://downloads.mysql.com/archives/community" rel="noopener noreferrer" target="_blank">https://downloads.mysql.com/archives/community<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p>Redis： 4.0 + <a href="https://redis.io/downloa" rel="noopener noreferrer" target="_blank">https://redis.io/downloa<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p>Nacos： 1.1.4 <a href="https://github.com/alibaba/nacos/releases" rel="noopener noreferrer" target="_blank">https://github.com/alibaba/nacos/releases<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p>Node： 11.3+（集成npm） <a href="https://nodejs.org/en/download" rel="noopener noreferrer" target="_blank">https://nodejs.org/en/download<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li></ul><h3 id="_2-2-redis集群" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-2-redis集群">#</a> 2.2 Redis集群</h3><p>Redis集群的哨兵模式是一种特殊的模式，首先Redis提供了哨兵的命令，哨兵是一个独立的进程，作为进程，它会独立运行。其原理是哨兵通过发送命令，等待Redis服务器响应，从而监控运行的多个Redis实例。 哨兵模式作用：</p><ul><li>通过发送命令，让Redis服务器返回监控其运行状态，包括主服务器和从服务器。</li><li>当哨兵监测到master宕机，会自动将slave切换成master，然后通过发布订阅模式通知其他的从服务器，修改配置文件，让它们切换主机。</li></ul><p>除了监控Redis服务之外，哨兵之间也会互相监控。本文采用一主、双从、三哨兵方式</p><figure><img alt="image-20210916120800855" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210916120800855-410069e3.png" tabindex="0"/><figcaption>image-20210916120800855</figcaption></figure><p><strong>部署方式为</strong>：docker compose：</p><p>安装、升级docker图文请看：<a href="https://mp.weixin.qq.com/s/F3kQvSMYSKbnyLaDIbVl1Q" rel="noopener noreferrer" target="_blank">https://mp.weixin.qq.com/s/F3kQvSMYSKbnyLaDIbVl1Q<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>第一步：创建redis docker-compose.yml配置文件 目录,并复制docs/dockerfile/redis/docker-compose.yml 到当前目录，配置文件可根据需要调整</p><div class="language-docker-compose.yml line-numbers-mode" data-ext="docker-compose.yml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs docker-compose.yml">version: &#x27;3.4&#x27;<br>services:<br> master:<br>  image: redis<br>  restart: always<br>  container_name: redis-master<br>  network_mode: &quot;host&quot;<br>  command: redis-server --port 16380 --requirepass 123456 --protected-mode no --daemonize no<br>  ports:<br>   - 16380:16380<br> slave1:<br>  image: redis<br>  restart: always<br>  container_name: redis-slave-1<br>  network_mode: &quot;host&quot;<br>  command: redis-server --slaveof 127.0.0.1 16380 --port 16381 --requirepass 123456 --masterauth 123456 --protected-mode no --daemonize no<br>  ports:<br>   - 16381:16381<br> slave2:<br>  image: redis<br>  restart: always<br>  container_name: redis-slave-2<br>  network_mode: &quot;host&quot; <br>  command: redis-server --slaveof 127.0.0.1 16380 --port 16382 --requirepass 123456 --masterauth 123456 --protected-mode no --daemonize no<br>  ports:<br>   - 16382:16382<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第二步：执行启动命令 在当前目录下执行启动命令</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">docker-compose -f docker-compose.yml up -d<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img alt="image-20210922111122880" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210922111122880-a79ca594.png" tabindex="0"/><figcaption>image-20210922111122880</figcaption></figure><p>第三步：创建sentinel docker-compose.yml配置文件 目录,并复制配置文件 复制 docs/dockerfile/sentinel/docker-compose.yml 到当前目录 复制 docs/dockerfile/sentinel/sentinel1.conf 到当前目录 复制 docs/dockerfile/sentinel/sentinel2.conf 到当前目录 复制 docs/dockerfile/sentinel/sentinel3.conf 到当前目录 docker-compose.yml</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs text">version: &#x27;3.4&#x27;<br>services:<br> sentinel1:<br>  image: redis<br>  restart: always<br>  container_name: redis-sentinel-1<br>  network_mode: &quot;host&quot;<br>  command: redis-sentinel /root/dockerfile/sentinel/sentinel1.conf<br>  volumes:<br>   - ./sentinel1.conf:/root/dockerfile/sentinel/sentinel1.conf<br> sentinel2:<br>  image: redis<br>  restart: always<br>  container_name: redis-sentinel-2<br>  network_mode: &quot;host&quot; <br>  command: redis-sentinel /root/dockerfile/sentinel/sentinel2.conf<br>  volumes:<br>   - ./sentinel2.conf:/root/dockerfile/sentinel/sentinel2.conf<br> sentinel3:<br>  image: redis<br>  restart: always<br>  container_name: redis-sentinel-3<br>  network_mode: &quot;host&quot; <br>  command: redis-sentinel /root/dockerfile/sentinel/sentinel3.conf<br>  volumes:<br>   - ./sentinel3.conf:/root/dockerfile/sentinel/sentinel3.conf<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>sentinel1.conf</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs text">port 26380<br>daemonize no<br>pidfile /var/run/redis-sentinel1.pid<br>dir /tmp<br>sentinel monitor mymaster 127.0.0.1 16380 2<br>sentinel auth-pass mymaster 123456<br>sentinel down-after-milliseconds mymaster 30000<br>sentinel parallel-syncs mymaster 1<br>sentinel failover-timeout mymaster 180000<br>sentinel deny-scripts-reconfig yes<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>sentinel2.conf</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs text">port 26381<br>daemonize no<br>pidfile /var/run/redis-sentinel2.pid<br>dir /tmp<br>sentinel monitor mymaster 127.0.0.1 16380 2<br>sentinel auth-pass mymaster 123456<br>sentinel down-after-milliseconds mymaster 30000<br>sentinel parallel-syncs mymaster 1<br>sentinel failover-timeout mymaster 180000<br>sentinel deny-scripts-reconfig yes<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>sentinel3.conf</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs text">port 26382<br>daemonize no<br>pidfile /var/run/redis-sentinel3.pid<br>dir /tmp<br>sentinel monitor mymaster 127.0.0.1 16380 2<br>sentinel auth-pass mymaster 123456<br>sentinel down-after-milliseconds mymaster 30000<br>sentinel parallel-syncs mymaster 1<br>sentinel failover-timeout mymaster 180000<br>sentinel deny-scripts-reconfig yes<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第四步：执行启动命令 在当前目录下执行启动命令</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">docker-compose -f docker-compose.yml up -d<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img alt="image-20210913180549154" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210913180549154-65b12f87.png" tabindex="0"/><figcaption>image-20210913180549154</figcaption></figure><h3 id="_2-3-后端工程导入" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-3-后端工程导入">#</a> 2.3 后端工程导入</h3><p>将 资料夹\资料\后端初始项目\jars 中的jar包install入本地仓库：</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">mvn install:install-file -Dfile=./ydl-tools-common.jar -DgroupId=com.ydl -DartifactId=ydl-tools-common -Dversion=1.0-SNAPSHOT -Dpackaging=jar<br><br>mvn install:install-file -Dfile=./ydl-tools-core.jar -DgroupId=com.ydl -DartifactId=ydl-tools-core -Dversion=1.0-SNAPSHOT -Dpackaging=jar<br><br>mvn install:install-file -Dfile=./ydl-tools-databases.jar -DgroupId=com.ydl -DartifactId=ydl-tools-databases -Dversion=1.0-SNAPSHOT -Dpackaging=jar<br><br>mvn install:install-file -Dfile=./ydl-tools-dozer.jar -DgroupId=com.ydl -DartifactId=ydl-tools-dozer -Dversion=1.0-SNAPSHOT -Dpackaging=jar<br><br>mvn install:install-file -Dfile=./ydl-tools-j2cache.jar -DgroupId=com.ydl -DartifactId=ydl-tools-j2cache -Dversion=1.0-SNAPSHOT -Dpackaging=jar<br><br>mvn install:install-file -Dfile=./ydl-tools-jwt.jar -DgroupId=com.ydl -DartifactId=ydl-tools-jwt -Dversion=1.0-SNAPSHOT -Dpackaging=jar<br><br>mvn install:install-file -Dfile=./ydl-tools-log.jar -DgroupId=com.ydl -DartifactId=ydl-tools-log -Dversion=1.0-SNAPSHOT -Dpackaging=jar<br><br>mvn install:install-file -Dfile=./ydl-tools-swagger2.jar -DgroupId=com.ydl -DartifactId=ydl-tools-swagger2 -Dversion=1.0-SNAPSHOT -Dpackaging=jar<br><br>mvn install:install-file -Dfile=./ydl-tools-user.jar -DgroupId=com.ydl -DartifactId=ydl-tools-user -Dversion=1.0-SNAPSHOT -Dpackaging=jar<br><br>mvn install:install-file -Dfile=./ydl-tools-validator.jar -DgroupId=com.ydl -DartifactId=ydl-tools-validator -Dversion=1.0-SNAPSHOT -Dpackaging=jar<br><br>mvn install:install-file -Dfile=./ydl-tools-xss.jar -DgroupId=com.ydl -DartifactId=ydl-tools-xss -Dversion=1.0-SNAPSHOT -Dpackaging=jar<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将资料中的初始工程导入开发工具，如下：</p><figure><img alt="image-20210914111704042" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210914111704042-878af5c7.png" tabindex="0"/><figcaption>image-20210914111704042</figcaption></figure><h3 id="_2-4-数据库" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-4-数据库">#</a> 2.4 数据库</h3><p>数据库脚本位于导入的初始工程<code>/docs/mysql/ydl-sms.sql</code>，创建ydl_sms数据库并执行ydl-sms.sql脚本文件完成建表操作。创建完成后可以看到如下表：</p><figure><img alt="image-20210914111857698" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210914111857698-46a16fe7.png" tabindex="0"/><figcaption>image-20210914111857698</figcaption></figure><h3 id="_2-5-前端工程" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-5-前端工程">#</a> 2.5 前端工程</h3><p>前端工程采用vue2 + ts + spa架构，前端工程在资料中已经提供，位置为：<code>/资料/前端工程</code></p><ol><li><p>前端代码结构和核心代码</p><figure><img alt="image-20210914114002904" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210914114002904-4e51013b.png" tabindex="0"/><figcaption>image-20210914114002904</figcaption></figure></li><li><p>编译、运行前端代码</p><div class="language-javascript line-numbers-mode" data-ext="js"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight javascript"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript">npm install<br>npm run serve<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><figure><img alt="image-20210914112925481" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210914112925481-3b82f420.png" tabindex="0"/><figcaption>image-20210914112925481</figcaption></figure><figure><img alt="image-20210914113139513" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210914113139513-1aa9d6f1.png" tabindex="0"/><figcaption>image-20210914113139513</figcaption></figure><p>登陆页面效果</p><figure><img alt="image-20210916201900615" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210916201900615-d4c8c1db.png" tabindex="0"/><figcaption>image-20210916201900615</figcaption></figure><p>进入效果</p><figure><img alt="image-20210916201911039" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210916201911039-7c876a07.png" tabindex="0"/><figcaption>image-20210916201911039</figcaption></figure><h2 id="_3-后台管理服务" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-后台管理服务">#</a> 3. 后台管理服务</h2><figure><img alt="image-20210916095249795" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210916095249795-9bf62f5d.png" tabindex="0"/><figcaption>image-20210916095249795</figcaption></figure><h3 id="_3-1-项目结构" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-1-项目结构">#</a> 3.1. 项目结构</h3><h4 id="_3-1-1-基础工程" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-1-1-基础工程">#</a> 3.1.1 基础工程</h4><p>基础工程为ydl-sms-entity工程，主要是一些实体类、DTO、工具类、Mapper接口等，作为基础模块，其他几个服务都会依赖此基础模块。</p><figure><img alt="image-20210916220116083" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210916220116083-f9647338.png" tabindex="0"/><figcaption>image-20210916220116083</figcaption></figure><p><strong>注意</strong>：dto entity vo 关系图</p><figure><img alt="image-20210916221225307" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210916221225307-6b199bf6.png" tabindex="0"/><figcaption>image-20210916221225307</figcaption></figure><h4 id="_3-1-2-管理端工程" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-1-2-管理端工程">#</a> 3.1.2 管理端工程</h4><p>ydl-sms-manage作为后台管理服务的maven工程，主要功能是对基础数据进行维护操作，例如签名管理、模板管理、通道管理、通道优先级配置、数据统计等。</p><figure><img alt="image-20210916220303128" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210916220303128-fc7c1102.png" tabindex="0"/><figcaption>image-20210916220303128</figcaption></figure><h3 id="_3-2-功能清单" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-2-功能清单">#</a> 3.2. 功能清单</h3><p>下图展示了后台管理服务实现的功能清单：</p><figure><img alt="image-20210916224738144" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210916224738144-fee7fde4.png" tabindex="0"/><figcaption>image-20210916224738144</figcaption></figure><h3 id="_3-3-数据模型与类" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-数据模型与类">#</a> 3.3. 数据模型与类</h3><table><thead><tr><th>序号</th><th>表名</th><th>类名</th><th>说明</th></tr></thead><tbody><tr><td>1</td><td>signature</td><td>SignatureEntity</td><td>短信签名</td></tr><tr><td>2</td><td>template</td><td>TemplateEntity</td><td>短信模板</td></tr><tr><td>3</td><td>config</td><td>ConfigEntity</td><td>短信通道配置</td></tr><tr><td>4</td><td>config_signature</td><td>ConfigSignatureEntity</td><td>通道与签名关系</td></tr><tr><td>5</td><td>config_template</td><td>ConfigTemplateEntity</td><td>通道与模板关系</td></tr><tr><td>6</td><td>platform</td><td>PlatformEntity</td><td>接入平台(应用管理)</td></tr><tr><td>7</td><td>receive_log</td><td>ReceiveLogEntity</td><td>短信接收日志</td></tr><tr><td>8</td><td>manual_process</td><td>ManualProcessEntity</td><td>人工处理任务</td></tr><tr><td>9</td><td>send_log</td><td>SendLogEntity</td><td>短信发送日志</td></tr><tr><td>10</td><td>black_list</td><td>BlackListEntity</td><td>黑名单</td></tr><tr><td>11</td><td>timing_push</td><td>TimingPushEntity</td><td>定时发送</td></tr></tbody></table><p>名词解释：</p><ul><li>短信签名：是指主叫用户在发送短信过程中，附加主叫用户的个性化签名，发送到被叫手机用户的业务。</li></ul><figure><img alt="image-20210916194042731" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210916194042731-a1d97f78.png" tabindex="0"/><figcaption>image-20210916194042731</figcaption></figure><ul><li>短信模板：即具体发送的短信内容，短信模版通常可以支持验证码、通知、推广三种短信类型。</li></ul><p>举例：尊敬的【变量a】先生，您尾号为【变量b】的卡，消费了【变量c】元。【农业银行】</p><ul><li>短信通道：指第三方短信平台，例如阿里云短信、乐信短信、梦网短信等。</li></ul><h3 id="_3-4-基础属性自动注入" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-4-基础属性自动注入">#</a> 3.4. 基础属性自动注入</h3><p><strong>功能</strong>：通过自定义注解和切面，在进行数据维护时实现实体中基础属性的自动赋值（创建者、创建时间、修改者、修改者）。</p><h4 id="_3-4-1-基础属性" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-4-1-基础属性">#</a> 3.4.1 基础属性</h4><p>基础实体类，业务实体类的基类：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydl.sms.entity.base;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiModelProperty;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 基础实体类，所有实体都需要继承</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseEntity</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-meta">@TableId</span><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;主键&quot;)</span><br>    <span class="hljs-keyword">private</span> String id;<br><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;创建时间&quot;)</span><br>    <span class="hljs-keyword">private</span> LocalDateTime createTime;<br><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;创建人&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">createUser</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;0&quot;</span>;<br><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;修改时间&quot;)</span><br>    <span class="hljs-keyword">private</span> LocalDateTime updateTime;<br><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;修改人&quot;)</span><br>    <span class="hljs-keyword">private</span> String updateUser;<br><br>    <span class="hljs-meta">@ApiModelProperty(value = &quot;逻辑删除：0删除&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer isDelete;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-4-2-自定义注解" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-4-2-自定义注解">#</a> 3.4.2 自定义注解</h4><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(ElementType.METHOD)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> DefaultParams &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-4-3-定义切面类" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-4-3-定义切面类">#</a> 3.4.3 定义切面类</h4><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 通过切面方式，自定义注解，实现实体基础数据的注入（创建者、创建时间、修改者、修改时间）</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultParamsAspect</span> &#123;<br>    <span class="hljs-meta">@SneakyThrows</span><br>    <span class="hljs-meta">@Before(&quot;@annotation(com.itheima.sms.annotation.DefaultParams)&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeEvent</span><span class="hljs-params">(JoinPoint point)</span> &#123;<br>        <span class="hljs-comment">//从threadlocal中获取用户id</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> BaseContextHandler.getUserId();<br>        <span class="hljs-keyword">if</span> (userId == <span class="hljs-literal">null</span>) &#123;<br>            userId = <span class="hljs-number">0L</span>;<br>        &#125;<br>        Object[] args = point.getArgs();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &amp;lt; args.length; i++) &#123;<br>            Class&amp;lt;?&amp;gt; classes = args[i].getClass();<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> getMethod(classes, <span class="hljs-string">&quot;getId&quot;</span>);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != method) &#123;<br>                id = method.invoke(args[i]);<br>            &#125;<br><br>            <span class="hljs-comment">//请求操作的对象的id为空时，为创建操作</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == id) &#123;<br>                method = getMethod(classes, <span class="hljs-string">&quot;setCreateUser&quot;</span>, String.class);<br>                <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != method) &#123;<br>                    method.invoke(args[i], userId.toString());<br>                &#125;<br>                method = getMethod(classes, <span class="hljs-string">&quot;setCreateTime&quot;</span>, LocalDateTime.class);<br>                <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != method) &#123;<br>                    method.invoke(args[i], LocalDateTime.now());<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-comment">//新建修改更新</span><br>            method = getMethod(classes, <span class="hljs-string">&quot;setUydlateUser&quot;</span>, String.class);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != method) &#123;<br>                method.invoke(args[i], userId.toString());<br>            &#125;<br>            method = getMethod(classes, <span class="hljs-string">&quot;setUydlateTime&quot;</span>, LocalDateTime.class);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != method) &#123;<br>                method.invoke(args[i], LocalDateTime.now());<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> Method <span class="hljs-title function_">getMethod</span><span class="hljs-params">(Class classes, String name, Class... types)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> classes.getMethod(name, types);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-4-4-使用注解" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-4-4-使用注解">#</a> 3.4.4 使用注解</h4><p>在Controller方法上添加注解，保存基础属性。</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping</span><br><span class="hljs-meta">@ApiOperation(&quot;保存&quot;)</span><br><span class="hljs-meta">@DefaultParams</span><br><span class="hljs-keyword">public</span> R <span class="hljs-title function_">save</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ObjectEntity entity)</span> &#123;<br>    <span class="hljs-comment">//具体实现逻辑...</span><br>    <span class="hljs-keyword">return</span> R.success();<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-5-redis发布订阅模式" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-5-redis发布订阅模式">#</a> 3.5. Redis发布订阅模式</h3><p>Redis 发布订阅 (pub/sub) 是一种消息通信模式：发送者 (pub) 发送消息，订阅者 (sub) 接收消息。Redis 客户端可以订阅任意数量的频道。</p><p>Redis的发布订阅模式本质和传统的MQ的发布订阅类似，但是相对于其它几款MQ产品来说，redis的使用更加便捷，也更加轻量化，不需要单独去搭建集成一套繁重的MQ框架。但缺点也很明显，redis发布的消息不会持久化，所以当某一台服务器出现问题的时候，这个消息会丢失，所以在考虑使用之前要慎重，当前的业务是否对数据一致性要求很高，如果要求很高，还是建议使用MQ产品。</p><p>在发布者订阅者模式下，发布者将消息发布到指定的 channel 里面， 凡是监听该 channel 的消费者都会收到同样的一份消息，这种模式类似于是收音机模式，即凡是收听某个频道的听众都会收到主持人发布的相同的消息内容。 此模式常用于群聊天、 群通知、群公告等场景。</p><p>发布订阅模式下的几个概念：</p><ul><li>Publisher： 发布者</li><li>Subscriber：订阅者</li><li>Channel： 频道</li></ul><p>下图展示了频道 channel1 ， 以及订阅这个频道的三个客户端 —— client1、 client2 和 client3 之间的关系：</p><figure><img alt="image-20210922171439646" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210922171439646-5d5f3cd6.png" tabindex="0"/><figcaption>image-20210922171439646</figcaption></figure><p>当有新消息通过 PUBLISH 命令发送给频道 channel1 时， 这个消息就会被发送给订阅它的三个客户端：</p><figure><img alt="image-20210922171712064" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210922171712064-3e8ebe3a.png" tabindex="0"/><figcaption>image-20210922171712064</figcaption></figure><h4 id="_3-5-1-案例演示" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-5-1-案例演示">#</a> 3.5.1 案例演示</h4><p>1.首先远程启动redis服务启动</p><p>2.启动4个客户端 redis-cli</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">redis-cli.exe -h 192.168.200.131 -p 16380 -a 123456<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>3.将其中三个客户端设置监听频道 test</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">subscribe ydlchannel<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img alt="image-20210922172222994" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210922172222994-5efc86a4.png" tabindex="0"/><figcaption>image-20210922172222994</figcaption></figure><p>4.将第四个客户端作为消息发布的客户端，向频道 ydlchannel发布消息</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">publish ydlchannel &#x27;im itlilaoshi&#x27;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>可以看到另外三个客户端都收到了消息</p><figure><img alt="image-20210922172441645" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210922172441645-d471fdfc.png" tabindex="0"/><figcaption>image-20210922172441645</figcaption></figure><h4 id="_3-5-2-代码案例" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-5-2-代码案例">#</a> 3.5.2 代码案例</h4><p>1、导入spring-boot-starter-data-redis依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework.boot<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-boot-starter-data-redis<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、编写消息监听器，作为消息的订阅者</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydl.sms.listener;<br><br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.connection.Message;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.connection.MessageListener;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自定义消息监听器，用于监听Redis频道中的消息</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MessageListener</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 监听方法</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pattern</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(Message message, <span class="hljs-type">byte</span>[] pattern)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;接收到消息：&quot;</span> + message);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3、编写订阅发布模式的容器配置</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydl.sms.config;<br><br><span class="hljs-keyword">import</span> com.ydl.sms.listener.MyListener;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.AutoConfigureAfter;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.listener.PatternTopic;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.listener.RedisMessageListenerContainer;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.listener.adapter.MessageListenerAdapter;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 订阅发布模式的容器配置</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@AutoConfigureAfter(&#123;MyListener.class&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SubscriberConfig</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> MyListener myListener;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建消息监听容器</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> redisConnectionFactory</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedisMessageListenerContainer <span class="hljs-title function_">getRedisMessageListenerContainer</span><span class="hljs-params">(RedisConnectionFactory redisConnectionFactory)</span> &#123;<br>        <span class="hljs-type">RedisMessageListenerContainer</span> <span class="hljs-variable">redisMessageListenerContainer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisMessageListenerContainer</span>();<br>        redisMessageListenerContainer.setConnectionFactory(redisConnectionFactory);<br><br>        <span class="hljs-comment">//可以添加多个监听订阅频道</span><br>        <span class="hljs-comment">//当前监听的是通道：MYTOPIC</span><br>        redisMessageListenerContainer.addMessageListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageListenerAdapter</span>(myListener), <span class="hljs-keyword">new</span> <span class="hljs-title class_">PatternTopic</span>(<span class="hljs-string">&quot;MYTOPIC&quot;</span>));<br><br>        <span class="hljs-keyword">return</span> redisMessageListenerContainer;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4、编写消息发布者</p><ul><li>通过redis客户端发送消息</li></ul><figure><img alt="image-20210922182117550" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210922182117550-f0162cfe.png" tabindex="0"/><figcaption>image-20210922182117550</figcaption></figure><ul><li>通过Java代码发送消息</li></ul><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydl.test;<br><br><span class="hljs-keyword">import</span> com.ydl.sms.SmsManageApplication;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;<br><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-meta">@SpringBootTest(classes = SmsManageApplication.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisTest</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-comment">//@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test1</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &amp;lt; <span class="hljs-number">10</span>; i++) &#123;<br>            redisTemplate.convertAndSend(<span class="hljs-string">&quot;MYTOPIC&quot;</span>,<span class="hljs-string">&quot;im itlilaoshi&quot;</span>);<br>        &#125;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-6-通道管理" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-6-通道管理">#</a> 3.6. 通道管理</h3><h4 id="_3-6-1-产品原型" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-6-1-产品原型">#</a> 3.6.1 产品原型</h4><figure><img alt="image-20210922182054655" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210922182054655-e855759f.png" tabindex="0"/><figcaption>image-20210922182054655</figcaption></figure><h4 id="_3-6-2-需求分析" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-6-2-需求分析">#</a> 3.6.2 需求分析</h4><ul><li>通道信息增、删、改、查（分页、详情）</li><li>通道排序：通过拖动对前端通道进行排序</li><li>关联通道与短信签名：一个通道可以有多个签名</li><li>关联通道与短信模板：一个通道可以有多个模板</li><li>通道优先级排序后通知短信发送服务，更新缓存中的通道优先级</li></ul><h4 id="_3-6-3-具体实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-6-3-具体实现">#</a> 3.6.3 具体实现</h4><p>管理端服务有一个场景使用了redis的发布订阅模式：短信通道的优先级发生变化（如人工设置）后，通过redis发布订阅模式通知短信发送服务，短信发送服务接收到消息后自动调整短信发送时使用的通道的优先级（短信发送服务缓存了短信通道的配置信息）。</p><p>基础代码都已经实现，此处只需要实现通道排序后通知短信发送服务的代码即可。也就是ConfigServiceImpl类的sendUpdateMessage方法。</p><p>短信发送服务业务逻辑说明：</p><p>1、为了保证短信发送服务的可用性，在短信发送服务启动时会自动生成当前服务实例的一个uuid作为服务标识保存到redis中，并且每隔3分钟上报服务信息证明服务状态正常</p><p>2、短信发送服务启动后会每隔10分钟检查redis中的服务上报信息，如果某个实例超过5分钟没有上报则认为此服务下线，就会从redis中将此服务实例信息删除</p><p>3、短信发送服务在启动时会从数据库中查询出可用通道列表并按照优先级排序，然后缓存到redis中</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//发送消息，通知短信发送服务更新缓存中的通道优先级</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendUpdateMessage</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//获得所有注册到redis中的短信发送服务实例</span><br>    <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> redisTemplate.opsForHash().entries(<span class="hljs-string">&quot;SERVER_ID_HASH&quot;</span>);<br>    log.info(<span class="hljs-string">&quot;全部服务：&#123;&#125;&quot;</span>, map);<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br><br>    <span class="hljs-keyword">for</span> (Object key : map.keySet()) &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">valueLong</span> <span class="hljs-operator">=</span> Long.parseLong(map.get(key).toString());<br><br>        <span class="hljs-comment">//五分钟内报告，说明短信发送服务状态正常</span><br>        <span class="hljs-keyword">if</span> (current - valueLong &amp;lt; (<span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">5</span>)) &#123;<br>            <span class="hljs-comment">//删除redis中缓存的可用通道，因为通道优先级发生变化，redis中缓存的可用通道需要重新加载</span><br>            redisTemplate.delete(<span class="hljs-string">&quot;listForConnect&quot;</span>);<br><br>            <span class="hljs-comment">//发布消息</span><br>            redisTemplate.convertAndSend(<span class="hljs-string">&quot;TOPIC_HIGH_SERVER&quot;</span>,<br>                                         ServerTopic<br>                                         .builder()<br>                                         .option(ServerTopic.INIT_CONNECT)<br>                                         .value(key.toString())<br>                                         .build()<br>                                         .toString()<br>                                        );<br>            log.info(<span class="hljs-string">&quot;发送消息通知短信发送服务重新构建通道&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="第2章-短信接收服务" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第2章-短信接收服务">#</a> 第2章 短信接收服务</h1><h2 id="_1-短信接收服务介绍" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-短信接收服务介绍">#</a> 1. 短信接收服务介绍</h2><p>短信接收服务的作用就是为应用提供访问接口，应用需要发送短信时只需要调用短信接收服务，由短信接收服务将信息保存到消息缓冲区（Mysql、Redis）。后续会由短信发送服务从消息缓冲区获取消息并发送短信。</p><p>动力短信短信平台整体架构：</p><figure><img alt="image-20210916095249795" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210916095249795-9bf62f5d.png" tabindex="0"/><figcaption>image-20210916095249795</figcaption></figure><p>动力短信短信平台业务架构：</p><figure><img alt="image-20210916100828128" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210916100828128-e2e1e21d.png" tabindex="0"/><figcaption>image-20210916100828128</figcaption></figure><p>通过上面的业务架构可以看到，短信接收服务（pd-sms-api）提供3种方式供业务系统调用：</p><ul><li>HTTP接口</li><li>TCP</li><li>SDK形式</li></ul><p>短信接收服务通过资质验证（可开关）、短信内容校验后将短信信息发送到对应中间件中（Redis、MySQL）。</p><p>短信发送方式分为两种类型：</p><p>1、定时发送短信：将短信内容存储到MySQL数据库中，由短信发送服务通过定时任务获取并发送 2、普通短信：将短信内容推送到Redis队列中，由短信发送服务异步接收并发送</p><h2 id="_2-redis消息队列" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-redis消息队列">#</a> 2. Redis消息队列</h2><h3 id="_2-1-redis队列介绍" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-1-redis队列介绍">#</a> 2.1 Redis队列介绍</h3><p>Redis支持五种数据类型：string（字符串），hash（哈希），list（列表），set（集合）及zset(sorted set：有序集合)。</p><p>Redis的list是简单的字符串列表，按照插入顺序排序。可以添加一个元素到列表的头部（左边）或者尾部（右边）。</p><p>使用Redis的list可以模拟消息队列，即使用<strong>rpush</strong>和<strong>lpush</strong>命令将数据插入队列（生产消息），使用<strong>lpop</strong>和<strong>rpop</strong>命令将数据弹出队列（消费消息）。</p><p>队列中的消息可以由不同的生产者写入，也可以由不同的消费者消费，但是一个消息一定是只能被消费一次。</p><p>redis所有命令，可从官网查看：<a href="http://redis.cn/commands.html#list" rel="noopener noreferrer" target="_blank">http://redis.cn/commands.html#list<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img alt="image-20210923092616090" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210923092616090-47c54f2f.png" tabindex="0"/><figcaption>image-20210923092616090</figcaption></figure><h3 id="_2-2-案例演示" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-2-案例演示">#</a> 2.2 案例演示</h3><p>发布消息：</p><div class="language-ruby line-numbers-mode" data-ext="rb"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight ruby"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ruby">root<span class="hljs-variable">@77889f10b0c8</span><span class="hljs-symbol">:/data</span><span class="hljs-comment"># redis-cli</span><br><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-symbol">:</span><span class="hljs-number">6379</span>&amp;gt; <span class="hljs-variable constant_">LPUSH</span> ydllist msg1<br>(integer) <span class="hljs-number">1</span><br><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-symbol">:</span><span class="hljs-number">6379</span>&amp;gt; <span class="hljs-variable constant_">LPUSH</span> ydllist msg2<br>(integer) <span class="hljs-number">2</span><br><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-symbol">:</span><span class="hljs-number">6379</span>&amp;gt; <span class="hljs-variable constant_">LPUSH</span> ydllist msg3<br>(integer) <span class="hljs-number">3</span><br><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-symbol">:</span><span class="hljs-number">6379</span>&amp;gt; <span class="hljs-variable constant_">LPUSH</span> ydllist msg4<br>(integer) <span class="hljs-number">4</span><br><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-symbol">:</span><span class="hljs-number">6379</span>&amp;gt; <span class="hljs-variable constant_">LPUSH</span> ydllist msg5<br>(integer) <span class="hljs-number">5</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看消息：</p><div class="language-ruby line-numbers-mode" data-ext="rb"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight ruby"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-symbol">:</span><span class="hljs-number">6379</span>&amp;gt; <span class="hljs-variable constant_">LRANGE</span> ydllist <span class="hljs-number">0</span> -<span class="hljs-number">1</span><br><span class="hljs-number">1</span>) <span class="hljs-string">&quot;msg5&quot;</span><br><span class="hljs-number">2</span>) <span class="hljs-string">&quot;msg4&quot;</span><br><span class="hljs-number">3</span>) <span class="hljs-string">&quot;msg3&quot;</span><br><span class="hljs-number">4</span>) <span class="hljs-string">&quot;msg2&quot;</span><br><span class="hljs-number">5</span>) <span class="hljs-string">&quot;msg1&quot;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>消费消息：</p><div class="language-ruby line-numbers-mode" data-ext="rb"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight ruby"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-symbol">:</span><span class="hljs-number">6379</span>&amp;gt; <span class="hljs-variable constant_">RPOP</span> ydllist<br><span class="hljs-string">&quot;msg1&quot;</span><br><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-symbol">:</span><span class="hljs-number">6379</span>&amp;gt; <span class="hljs-variable constant_">RPOP</span> ydllist<br><span class="hljs-string">&quot;msg2&quot;</span><br><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-symbol">:</span><span class="hljs-number">6379</span>&amp;gt; <span class="hljs-variable constant_">LRANGE</span> ydllist <span class="hljs-number">0</span> -<span class="hljs-number">1</span><br><span class="hljs-number">1</span>) <span class="hljs-string">&quot;msg5&quot;</span><br><span class="hljs-number">2</span>) <span class="hljs-string">&quot;msg4&quot;</span><br><span class="hljs-number">3</span>) <span class="hljs-string">&quot;msg3&quot;</span><br><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-symbol">:</span><span class="hljs-number">6379</span>&amp;gt; <span class="hljs-variable constant_">RPOP</span> ydllist<br><span class="hljs-string">&quot;msg3&quot;</span><br><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-symbol">:</span><span class="hljs-number">6379</span>&amp;gt; <span class="hljs-variable constant_">RPOP</span> ydllist<br><span class="hljs-string">&quot;msg4&quot;</span><br><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-symbol">:</span><span class="hljs-number">6379</span>&amp;gt; <span class="hljs-variable constant_">RPOP</span> ydllist<br><span class="hljs-string">&quot;msg5&quot;</span><br><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-symbol">:</span><span class="hljs-number">6379</span>&amp;gt; <span class="hljs-variable constant_">RPOP</span> ydllist<br>(<span class="hljs-literal">nil</span>)<br><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-symbol">:</span><span class="hljs-number">6379</span>&amp;gt; <span class="hljs-variable constant_">LRANGE</span> channel1 <span class="hljs-number">0</span> -<span class="hljs-number">1</span><br>(empty list <span class="hljs-keyword">or</span> set)<br><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-symbol">:</span><span class="hljs-number">6379</span>&amp;gt; <br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>RPOP命令不具有阻塞功能，如果需要阻塞功能可以使用BRPOP命令。</p><figure><img alt="image-20210923105449996" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210923105449996-c59b3a97.png" tabindex="0"/><figcaption>image-20210923105449996</figcaption></figure><h3 id="_2-3-代码案例" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-3-代码案例">#</a> 2.3 代码案例</h3><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydl.test;<br><br><span class="hljs-keyword">import</span> com.ydl.sms.SmsApiApplication;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-meta">@SpringBootTest(classes = SmsApiApplication.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisListTest</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    RedisTemplate redisTemplate;<br><br>    <span class="hljs-comment">//消息发送者</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testPush</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &amp;lt; <span class="hljs-number">10</span>; i++) &#123;<br>            redisTemplate.opsForList().leftPush(<span class="hljs-string">&quot;ydllist123&quot;</span>, <span class="hljs-string">&quot;msg&quot;</span>+i);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//消息消费者</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testPop</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &amp;lt; <span class="hljs-number">11</span>; i++) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> redisTemplate.opsForList().rightPop(<span class="hljs-string">&quot;ydllist123&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;取出的值是：&quot;</span>+value);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//消费者阻塞监听队列</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testPopBlock</span><span class="hljs-params">()</span>&#123;<br>       <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>           <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> redisTemplate.opsForList().rightPop(<span class="hljs-string">&quot;ydllist123&quot;</span>, <span class="hljs-number">10L</span>, TimeUnit.SECONDS);<br>           <span class="hljs-comment">//业务逻辑</span><br>           System.out.println(<span class="hljs-string">&quot;取出的值是：&quot;</span>+value);<br>       &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-短信接收服务" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-短信接收服务">#</a> 3. 短信接收服务</h2><h3 id="_3-1-需求分析-重点" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-1-需求分析-重点">#</a> 3.1 需求分析-重点</h3><p><strong>功能需求：</strong></p><ul><li>应用系统调用短信接收服务提供的接口，由短信接收服务将信息保存到消息缓冲区（Mysql、Redis）</li><li>调用方式：HTTP、TCP、SDK</li></ul><p><strong>处理流程：</strong></p><p>短信接收服务接收到应用系统请求后，会进行相关的校验处理，校验通过则将信息保存到消息缓存区，具体处理流程如下：</p><figure><img alt="image-20210923174235681" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210923174235681-3ea1eb65.png" tabindex="0"/><figcaption>image-20210923174235681</figcaption></figure><h3 id="_3-2-项目结构" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-2-项目结构">#</a> 3.2 项目结构</h3><figure><img alt="image-20210923100907654" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210923100907654-c30c191f.png" tabindex="0"/><figcaption>image-20210923100907654</figcaption></figure><h3 id="_3-3-数据模型与类-1" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-数据模型与类-1">#</a> 3.3 数据模型与类</h3><table><thead><tr><th>序号</th><th>表名</th><th>类名</th><th>说明</th></tr></thead><tbody><tr><td>1</td><td>signature</td><td>SignatureEntity</td><td>短信签名</td></tr><tr><td>2</td><td>template</td><td>TemplateEntity</td><td>短信模板</td></tr><tr><td>3</td><td>config</td><td>ConfigEntity</td><td>短信通道配置</td></tr><tr><td>4</td><td>config_signature</td><td>ConfigSignatureEntity</td><td>通道与签名关系</td></tr><tr><td>5</td><td>config_template</td><td>ConfigTemplateEntity</td><td>通道与模板关系</td></tr><tr><td>6</td><td>platform</td><td>PlatformEntity</td><td>接入平台(应用管理)</td></tr><tr><td>7</td><td>receive_log</td><td>ReceiveLogEntity</td><td>短信接收日志</td></tr><tr><td>8</td><td>black_list</td><td>BlackListEntity</td><td>黑名单</td></tr><tr><td>9</td><td>timing_push</td><td>TimingPushEntity</td><td>定时发送</td></tr></tbody></table><p>注意：此处只是列出和短信接收服务有关的数据模型和类。</p><h3 id="_3-4-消息存储" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-4-消息存储">#</a> 3.4 消息存储</h3><p>导入的初始工程中已经实现了大部分代码，主要逻辑为通过Controller提供HTTP接口服务接收应用系统请求，然后调用Service，在Service中进行一系列校验，如果校验通过则需要将消息保存到消息缓冲区。</p><p><strong>将消息保存到消息缓冲区的业务逻辑为：</strong></p><p>1、进行短信分类，分为实时发送短信和定时发送短信</p><p>2、如果是定时发送短信则将消息保存到Mysql数据库</p><p>3、如果是实时发送短信则将消息保存到Redis队列，判断短信模板类型，如果是验证码类型则将消息保存到高优先级队列TOPIC_HIGH_SMS，如果是其他类型则将消息保存到普通队列TOPIC_GENERAL_SMS</p><p>4、保存短信接收日志到Mysql数据库</p><p><strong>具体实现代码如下（SmsSendServiceImpl类的pushSmsMessage方法）：</strong></p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//缺啥补啥</span><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据短信模板分类 并分发</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> templateEntity</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> smsSendDTO</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> platformEntity</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pushSmsMessage</span><span class="hljs-params">(TemplateEntity templateEntity, SmsSendDTO smsSendDTO, PlatformEntity platformEntity)</span> &#123;<br>        <span class="hljs-comment">// TODO 短信接收服务：将短信信息保存到数据库或者Redis队列</span><br>        <span class="hljs-type">ReceiveLogEntity</span> <span class="hljs-variable">receiveLogEntity</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReceiveLogEntity</span>();<br>        receiveLogEntity.setApiLogId(UUID.randomUUID().toString());<br>        <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//1、进行短信分类，分为实时发送短信和定时发送短信</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">sendTime</span> <span class="hljs-operator">=</span> smsSendDTO.getSendTime();<br><br>            <span class="hljs-type">String</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> JSON.toJSONString(smsSendDTO);<br>            <span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(sendTime)) &#123;<br>                <span class="hljs-comment">//2、如果是定时发送短信则将消息保存到Mysql数据库</span><br>                <span class="hljs-type">TimingPushEntity</span> <span class="hljs-variable">timingPushEntity</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimingPushEntity</span>();<br>                timingPushEntity.setMobile(smsSendDTO.getMobile());<br>                timingPushEntity.setTemplate(smsSendDTO.getTemplate());<br>                timingPushEntity.setRequest(request);<br>                timingPushEntity.setSignature(smsSendDTO.getSignature());<br>                timingPushEntity.setTiming(sendTime);<br><br>                timingPushService.save(timingPushEntity);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//3、如果是实时发送短信则将消息保存到Redis队列，判断短信模板类型，如果是验证码类型则将消息保存到高优先级队列TOPIC_HIGH_SMS，如果是其他类型则将消息保存到普通队列TOPIC_GENERAL_SMS</span><br><br>                <span class="hljs-keyword">if</span> (templateEntity.getType() == TemplateType.VERIFICATION.getCode()) &#123;<br>                    <span class="hljs-comment">//您的验证码是$&#123;code&#125;</span><br>                    redisTemplate.opsForList().leftPush(<span class="hljs-string">&quot;TOPIC_HIGH_SMS&quot;</span>, request);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">//理财产品$&#123;product&#125;</span><br>                    redisTemplate.opsForList().leftPush(<span class="hljs-string">&quot;TOPIC_GENERAL_SMS&quot;</span>, request);<br>                &#125;<br>            &#125;<br>            receiveLogEntity.setStatus(<span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            receiveLogEntity.setStatus(<span class="hljs-number">0</span>);<br>            receiveLogEntity.setError(ExceptionUtils.getErrorStackTrace(e));<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-comment">//4、保存短信接收日志到Mysql数据库</span><br>            receiveLogEntity.setPlatformId(platformEntity.getId());<br>            receiveLogEntity.setPlatformName(platformEntity.getName());<br>            receiveLogEntity.setBusiness(smsSendDTO.getBatchCode());<br>            receiveLogEntity.setConfigIds(StringUtils.join(smsSendDTO.getConfigIds(), <span class="hljs-string">&quot;,&quot;</span>)); <span class="hljs-comment">//[1,2,3]---&amp;gt;1,2,3</span><br>            receiveLogEntity.setTemplate(smsSendDTO.getTemplate());<br>            receiveLogEntity.setSignature(smsSendDTO.getSignature());<br>            receiveLogEntity.setMobile(smsSendDTO.getMobile());<br>            receiveLogEntity.setRequest(JSON.toJSONString(smsSendDTO.getParams()));<br>            receiveLogEntity.setUseTime(System.currentTimeMillis() - start);<br><br>            receiveLogMapper.insert(receiveLogEntity);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试：</p><figure><img alt="image-20210924114955634" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210924114955634-fe15e5da.png" tabindex="0"/><figcaption>image-20210924114955634</figcaption></figure><h3 id="_3-5-tcp接口" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-5-tcp接口">#</a> 3.5 TCP接口</h3><p>基于Netty进行网络编程，为短信接收服务提供<strong>TCP接口</strong>，应用系统可以通过TCP调用此接口来和短信接收服务对接。</p><p>涉及到的类：</p><figure><img alt="image-20210924114505723" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210924114505723-89d34225.png" tabindex="0"/><figcaption>image-20210924114505723</figcaption></figure><ul><li><p>Netty服务启动类：用于启动Netty服务</p></li><li><p>通道初始化器：主要目的是为程序员提供一个简单的工具，用于在某个Channel注册到EventLoop后，对这个Channel执行一些初始化操作，例如可以添加用户自定义的服务端处理器</p></li><li><p>服务端处理器：具体执行处理逻辑，例如读取消息</p></li></ul><p>导入的初始工程中主体代码已经完成，只需要实现服务端处理器的具体处理逻辑即可（NettyServerHandler的channelRead0方法）：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//业务逻辑</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, String msg)</span> &#123;<br>        <span class="hljs-comment">// TODO 短信接收服务：接收应用系统的报文并解析，调用Service将消息保存到消息缓冲区</span><br>        <span class="hljs-comment">//就是和controller一样 调用service层即可</span><br>        String restMsg=<span class="hljs-string">&quot;success&quot;</span>;<br>        log.info(<span class="hljs-string">&quot;tcp接口接受到消息:&quot;</span>+msg);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//1sring msg--&amp;gt; SmsParamsDTO</span><br>            <span class="hljs-type">SmsParamsDTO</span> <span class="hljs-variable">smsParamsDTO</span> <span class="hljs-operator">=</span> parseMessage(msg);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span>==smsParamsDTO)&#123;<br>                log.info(<span class="hljs-string">&quot;报文解析失败！&quot;</span>);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-comment">//2调用service层即可</span><br>            SpringUtils.getBean(SmsSendService.class).send(smsParamsDTO);<br><br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            log.error(<span class="hljs-string">&quot;netty发送时，报错了！&quot;</span>,e);<br>            restMsg=e.getMessage();<br>        &#125;<br><br>        log.info(<span class="hljs-string">&quot;回推报文=============&quot;</span>+restMsg);<br>        ctx.writeAndFlush(restMsg+<span class="hljs-string">&quot;\n&quot;</span>); <span class="hljs-comment">//为什么要加\n 不加客户端接收不到消息</span><br>    &#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试：</p><p>打开telnet功能</p><p>公众号添加“IT李哥交朋友”，定期技术分享哦。</p><p>可以使用telnet作为Netty客户端来测试Netty服务，报文如下：</p><div class="language-json line-numbers-mode" data-ext="json"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight json"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;accessKeyId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;dcbd824751cf448fa0b569f1f07b9b32&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;encryption&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2f2e4da7fffd4391a9aaabd594f37db3&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;mobile&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;15718888888&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;params&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;79857&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;signature&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;DXQM_000000001&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;template&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;DXMB_000000001&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;sendTime&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;2021-12-25 12:00&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><h3 id="_3-6-sdk" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-6-sdk">#</a> 3.6 SDK</h3><h4 id="_3-6-1-说明" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-6-1-说明">#</a> 3.6.1 说明</h4><p>SDK 是 Software Development Kit 的缩写，即软件开发工具包。SDK被开发出来是为了减少程序员工作量的，比如公司开发出某种软件的某一功能，把它封装成SDK，提供给其他公司和个人使用。</p><p>本小节需要开发短信接收服务SDK，通过SDK可以使应用系统更加方便的调用短信接收服务。</p><p>通过SDK方式调用短信接收服务，本质上还是调用的短信接收服务提供的HTTP接口（Controller），只不过是调用的过程在SDK中进行了封装。</p><p>项目结构：</p><figure><img alt="image-20210924143027782" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210924143027782-346a3429.png" tabindex="0"/><figcaption>image-20210924143027782</figcaption></figure><h4 id="_3-6-2-实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-6-2-实现">#</a> 3.6.2 实现</h4><p>导入的初始工程中主体代码已经完成，只需要实现业务处理类的具体逻辑即可（SmsSendServiceImpl的send方法）：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 通过HttpClient发送post请求，请求短信接收服务HTTP接口</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> baseParamsDTO</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> url</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> R <span class="hljs-title function_">send</span><span class="hljs-params">(BaseParamsDTO baseParamsDTO, String url)</span> &#123;<br>        <span class="hljs-comment">//设置此平台的秘钥</span><br>        baseParamsDTO.setAccessKeyId(accessKeyId);<br><br>        <span class="hljs-comment">//电商 平台是否认证</span><br>        <span class="hljs-keyword">if</span> (auth) &#123;<br>            <span class="hljs-comment">//key secret 都要有</span><br>            <span class="hljs-keyword">if</span> (StringUtils.isBlank(accessKeyId) || StringUtils.isBlank(accessKeySecret)) &#123;<br>                <span class="hljs-keyword">return</span> R.fail(<span class="hljs-string">&quot;accessKeyId或accessKeySecret不能为空&quot;</span>);<br>            &#125;<br>        &#125;<br><br>        baseParamsDTO.setTimestamp(System.currentTimeMillis() + <span class="hljs-string">&quot;&quot;</span>);<br>        baseParamsDTO.setEncryption(SmsEncryptionUtils.encode(baseParamsDTO.getTimestamp(), baseParamsDTO.getAccessKeyId(), accessKeySecret));<br><br>        <span class="hljs-keyword">if</span> (StringUtils.isBlank(domain)) &#123;<br>            <span class="hljs-keyword">return</span> R.fail(<span class="hljs-string">&quot;domain不能为空&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//1 httpclien okhttp</span><br>        <span class="hljs-type">CloseableHttpClient</span> <span class="hljs-variable">httpClient</span> <span class="hljs-operator">=</span> HttpClients.createDefault();<br>        <span class="hljs-comment">//构造post请求</span><br>        <span class="hljs-type">HttpPost</span> <span class="hljs-variable">post</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpPost</span>(url);<br>        <span class="hljs-comment">//设置请求头</span><br>        post.setHeader(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/json; charset=UTF-8&quot;</span>);<br>        <span class="hljs-comment">//设置请求体</span><br>        <span class="hljs-type">StringEntity</span> <span class="hljs-variable">stringEntity</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringEntity</span>(JSON.toJSONString(baseParamsDTO), <span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        post.setEntity(stringEntity);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//发送post请求</span><br>            <span class="hljs-type">CloseableHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> httpClient.execute(post);<br>            <span class="hljs-type">HttpEntity</span> <span class="hljs-variable">responseEntity</span> <span class="hljs-operator">=</span> response.getEntity();<br><br>            <span class="hljs-comment">//解析响应码</span><br>            <span class="hljs-keyword">if</span> (response.getStatusLine().getStatusCode() == <span class="hljs-number">200</span>) &#123;<br>                <span class="hljs-comment">//发送成功</span><br>                log.info(<span class="hljs-string">&quot;httpRequest access success, StatusCode is:&#123;&#125;&quot;</span>, response.getStatusLine().getStatusCode());<br>                <span class="hljs-type">String</span> <span class="hljs-variable">responseEntityStr</span> <span class="hljs-operator">=</span> EntityUtils.toString(responseEntity);<br>                log.info(<span class="hljs-string">&quot;responseContent is :&quot;</span> + responseEntityStr);<br><br>                <span class="hljs-keyword">return</span> JSON.parseObject(responseEntityStr, R.class);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//发送失败</span><br>                log.error(<span class="hljs-string">&quot;httpRequest access fail ,StatusCode is:&#123;&#125;&quot;</span>, response.getStatusLine().getStatusCode());<br>                <span class="hljs-keyword">return</span> R.fail(<span class="hljs-string">&quot;status is &quot;</span> + response.getStatusLine().getStatusCode());<br>            &#125;<br><br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(<span class="hljs-string">&quot;error&quot;</span>, e);<br>            <span class="hljs-keyword">return</span> R.fail(e.getMessage());<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            post.releaseConnection();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>SDK开发完成后，为了方便其他应用使用，通常会将SDK打成jar包上传到远程maven仓库，在应用系统中直接通过maven坐标导入SDK即可使用。</p><p>如下是将SDK上传到Nexus后的效果：</p><figure><img alt="image-20210924221808372" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210924221808372-59eb0132.png" tabindex="0"/><figcaption>image-20210924221808372</figcaption></figure><p>如何搭建私服，详见公众号：IT李哥交朋友</p><h4 id="_3-6-3-测试" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-6-3-测试">#</a> 3.6.3 测试</h4><p>第一步：引入SDK的maven坐标</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>repositories<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>repository<span class="hljs-symbol">&amp;gt;</span><br>      <span class="hljs-symbol">&amp;lt;</span>id<span class="hljs-symbol">&amp;gt;</span>ydlrepo<span class="hljs-symbol">&amp;lt;</span>/id<span class="hljs-symbol">&amp;gt;</span><br>      <span class="hljs-symbol">&amp;lt;</span>url<span class="hljs-symbol">&amp;gt;</span>http://192.168.200.131:8081/repository/ydlrepo/<span class="hljs-symbol">&amp;lt;</span>/url<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/repository<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/repositories<span class="hljs-symbol">&amp;gt;</span><br><br><br><span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.ydl<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>ydl-sms-sdk<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>1.0.0<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第二步：编写配置文件</p><div class="language-yaml line-numbers-mode" data-ext="yml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight yaml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 服务端使用sdk配置信息</span><br><span class="hljs-attr">ydlclass:</span><br>  <span class="hljs-attr">sms:</span><br>    <span class="hljs-attr">auth:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">domain:</span> <span class="hljs-string">http://localhost:8771</span><br>    <span class="hljs-attr">accessKeyId:</span> <span class="hljs-string">dcbd824751cf448fa0b569f1f07b9b32</span><br>    <span class="hljs-attr">accessKeySecret:</span> <span class="hljs-string">2f2e4da7fffd4391a9aaabd594f37db3</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第三步：编写单元测试</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydl.test;<br><br><span class="hljs-keyword">import</span> com.itheima.sms.SmsManageApplication;<br><span class="hljs-keyword">import</span> com.itheima.sms.sms.dto.SmsParamsDTO;<br><span class="hljs-keyword">import</span> com.itheima.sms.sms.service.SmsSendService;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-meta">@SpringBootTest(classes = SmsManageApplication.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SdkTest</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SmsSendService smsSendService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 通过SDK方式调用短信接收服务</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSend</span><span class="hljs-params">()</span>&#123;<br>         <span class="hljs-type">SmsParamsDTO</span> <span class="hljs-variable">dto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SmsParamsDTO</span>();<br>        dto.setMobile(<span class="hljs-string">&quot;15718888888&quot;</span>);<br>        dto.setSignature(<span class="hljs-string">&quot;DXQM_000000001&quot;</span>);<br>        dto.setTemplate(<span class="hljs-string">&quot;DXMB_000000001&quot;</span>);<br>        Map&amp;lt;String, String&amp;gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&amp;lt;&amp;gt;();<br>        map.put(<span class="hljs-string">&quot;code&quot;</span>,<span class="hljs-string">&quot;79857&quot;</span>);<br>        dto.setParams(map);<br>        dto.setSendTime(<span class="hljs-string">&quot;2021-12-18 10:00&quot;</span>);<br>        dto.setTimestamp(System.currentTimeMillis() +<span class="hljs-string">&quot;&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> smsSendService.sendSms(dto);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="第3章-短信发送服务" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第3章-短信发送服务">#</a> 第3章 短信发送服务</h1><h2 id="_1-短信发送服务介绍" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-短信发送服务介绍">#</a> 1. 短信发送服务介绍</h2><p>短信发送服务的作用就是从消息缓冲区获取消息并和具体的短信通道(例如：阿里云短信、梦网短信、乐信短信等)对接来发送短信。</p><p>动力短信短信平台整体架构：</p><figure><img alt="image-20210924192730206" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210924192730206-3ec853e0.png" tabindex="0"/><figcaption>image-20210924192730206</figcaption></figure><ul><li>发送短信：实时发送、定时发送</li><li>通道降级：通道发送失败，选择下一通道发送短信</li><li>通道选举：同一通道多次发送失败，降级通道</li><li>服务注册：有且只有一台机器执行通道选举</li></ul><h2 id="_2-redis实现分布式锁" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-redis实现分布式锁">#</a> 2. Redis实现分布式锁</h2><p>对于简单的单体项目，即运行时程序在同一个Java虚拟机中，使用Java的锁机制（synchronized或者ReentrantLock）可以解决多线程并发问题。</p><p>可以运行<code>资料/redis-lock-demo</code>来重现线程并发问题。</p><p>测试过程：</p><p>第一步：启动redis-lock-demo服务</p><p>第二步：设置redis中库存stock值为100</p><figure><img alt="image-20210925110700603" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210925110700603-21e4920b.png" tabindex="0"/><figcaption>image-20210925110700603</figcaption></figure><p>第三步：使用apache jmeter进行压力测试</p><figure><img alt="image-20210925110733847" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210925110733847-2c796dcb.png" tabindex="0"/><figcaption>image-20210925110733847</figcaption></figure><figure><img alt="image-20210925110744160" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210925110744160-4fdcd282.png" tabindex="0"/><figcaption>image-20210925110744160</figcaption></figure><p><code>注：Apache JMeter是Apache组织开发的基于Java的压力测试工具。用于对软件做压力测试，它最初被设计用于Web应用测试，但后来扩展到其他测试领域。</code></p><p>可以发现对于单实例的应用来说，使用Java锁机制就可以解决线程并发问题。</p><p>但是在分布式环境中，程序是集群方式部署，如下图：</p><figure><img alt="image-20210925114905838" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210925114905838-f1702291.png" tabindex="0"/><figcaption>image-20210925114905838</figcaption></figure><p>可以通过启动两个服务实例来测试集群部署时线程并发问题，具体测试步骤如下：</p><p>第一步：分别启动两个redis-lock-demo服务实例，端口号分别为8001和8002</p><figure><img alt="image-20210925113940599" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210925113940599-a3eb3342.png" tabindex="0"/><figcaption>image-20210925113940599</figcaption></figure><p>第二步：配置Nginx负载均衡，通过Nginx将压力分发到两个实例上</p><div class="language-properties line-numbers-mode" data-ext="properties"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight properties"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">upstream</span> <span class="hljs-string">upstream_name&#123;</span><br>  <span class="hljs-attr">server</span> <span class="hljs-string">127.0.0.1:8001;</span><br>  <span class="hljs-attr">server</span> <span class="hljs-string">127.0.0.1:8002;</span><br><span class="hljs-attr">&#125;</span><br><br><span class="hljs-attr">server</span> <span class="hljs-string">&#123;</span><br>    <span class="hljs-attr">listen</span>       <span class="hljs-string">8080;</span><br>    <span class="hljs-attr">server_name</span>  <span class="hljs-string">localhost;</span><br><br>    <span class="hljs-attr">location</span> <span class="hljs-string">/ &#123;</span><br>        <span class="hljs-attr">proxy_pass</span> <span class="hljs-string">http://upstream_name;</span><br>        <span class="hljs-attr">proxy_set_header</span> <span class="hljs-string">Host $host;</span><br>        <span class="hljs-attr">proxy_set_header</span> <span class="hljs-string">X-Real-IP $remote_addr;</span><br>        <span class="hljs-attr">proxy_set_header</span> <span class="hljs-string">X-Forwarded-For $proxy_add_x_forwarded_for;</span><br>    <span class="hljs-attr">&#125;</span><br><span class="hljs-attr">&#125;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第三步：使用Apache jmeter进行压力测试</p><p>可以发现对于集群环境下的多个服务实例又产生了线程并发问题。</p><p>上面的集群部署方式依然会产生线程并发问题，因为synchronized、ReentrantLock只是jvm级别的加锁，没有办法控制其他jvm。也就是上面两个tomcat实例还是可以出现并发执行的情况。要解决分布式环境下的并发问题，则必须使用分布式锁。</p><p>分布式锁可以理解为：控制分布式系统有序的去对共享资源进行操作，通过互斥来保证数据的一致性。</p><p>分布式锁，是控制分布式系统之间同步访问共享资源的一种方式。如果不同的系统或是同一个系统的不同主机之间共享了一个或一组资源，那么访问这些资源的时候，往往需要互斥来防止彼此干扰来保证一致性，在这种情况下，便需要使用到分布式锁。</p><p>实现分布式锁的方式很多，例如：Redis、数据库、Zookeeper等。</p><p>本小节主要讲Redis实现分布式锁的方式。</p><h3 id="_2-1-setnx" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-1-setnx">#</a> 2.1 SETNX</h3><p>这种加锁的思路是，如果 key 不存在则为 key 设置 value，如果 key 已存在则 SETNX 命令不做任何操作</p><ul><li>客户端A请求服务器设置key的值，如果设置成功就表示加锁成功 mykey-&gt;myvalue</li><li>客户端B也去请求服务器设置key的值，如果返回失败，那么就代表加锁失败 mykey-&gt;myvalue</li><li>客户端A执行代码完成，删除锁</li><li>客户端B在等待一段时间后再去请求设置key的值，设置成功 mykey-&gt;myvalue</li><li>客户端B执行代码完成，删除锁</li></ul><p><strong>格式</strong>：</p><div class="language-ruby line-numbers-mode" data-ext="rb"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight ruby"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-comment">#尝试获取锁</span><br><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-symbol">:</span><span class="hljs-number">6379</span>&amp;gt; <span class="hljs-variable constant_">SETNX</span> key value<br><span class="hljs-comment">#设置锁过期时间</span><br><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-symbol">:</span><span class="hljs-number">6379</span>&amp;gt; <span class="hljs-variable constant_">EXPIRE</span> key seconds<br><span class="hljs-comment">#删除锁</span><br><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-symbol">:</span><span class="hljs-number">6379</span>&amp;gt; <span class="hljs-variable constant_">DEL</span> key<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为什么要设置key过期时间呢？</p><p>如果某个客户端获得锁后因为某些原因意外退出了，导致创建了锁但是没有来得及删除锁，那么这个锁将一直存在，后面所有的客户端都无法再获得锁，所以必须要设置过期时间。</p><h3 id="_2-2-set" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-2-set">#</a> 2.2 SET</h3><p>通过前面的expire命令来设置锁过期时间还存在一个问题，就是SETNX和EXPIRE两个命令不是原子性操作。在极端情况下可能会出现获取锁后还没来得及设置过期时间程序就挂掉了，这样就又出现了锁一直存在，后面所有的客户端都无法再获得锁的问题。</p><p>如何解决这个问题？答案是使用SET命令。</p><p>SET 命令从Redis 2.6.12 版本开始包含设置过期时间的功能，这样获取锁和设置过期时间就是一个原子操作了。</p><p><strong>格式</strong>：</p><div class="language-ruby line-numbers-mode" data-ext="rb"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight ruby"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-variable constant_">SET</span> key value [<span class="hljs-variable constant_">EX</span> seconds] [<span class="hljs-variable constant_">NX</span>]<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p><strong>示例</strong>：</p><div class="language-ruby line-numbers-mode" data-ext="rb"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight ruby"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-symbol">:</span><span class="hljs-number">6379</span>&amp;gt; <span class="hljs-variable constant_">SET</span> mykey myvalue <span class="hljs-variable constant_">EX</span> <span class="hljs-number">5</span> <span class="hljs-variable constant_">NX</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><ul><li>EX seconds ：将键的过期时间设置为 seconds 秒</li><li>NX ：只在key不存在时才对键进行设置操作</li></ul><h3 id="_2-3-代码实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-3-代码实现">#</a> 2.3 代码实现</h3><p>基于redis实现分布式锁：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br>   RedisLock redisLock;<br><br>   <span class="hljs-comment">//使用redis分布式锁，无阻塞</span><br>   <span class="hljs-meta">@GetMapping(&quot;/stock3&quot;)</span><br>   <span class="hljs-keyword">public</span> String <span class="hljs-title function_">stock3</span><span class="hljs-params">()</span> &#123;<br>       <span class="hljs-type">String</span> <span class="hljs-variable">mylock</span> <span class="hljs-operator">=</span> redisLock.tryLock(<span class="hljs-string">&quot;MYLOCK&quot;</span>, <span class="hljs-number">2000</span>);<br>       <span class="hljs-keyword">if</span>(mylock!=<span class="hljs-literal">null</span>)&#123;<br>           <span class="hljs-type">int</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> Integer.parseInt(stringRedisTemplate.opsForValue().get(<span class="hljs-string">&quot;stock&quot;</span>));<br>           <span class="hljs-keyword">if</span> (stock &amp;gt; <span class="hljs-number">0</span>) &#123;<br>               stock--;<br>               <span class="hljs-comment">//放回redis</span><br>               stringRedisTemplate.opsForValue().set(<span class="hljs-string">&quot;stock&quot;</span>, stock + <span class="hljs-string">&quot;&quot;</span>);<br>               System.out.println(<span class="hljs-string">&quot;减库存成功，剩余库存是：&quot;</span> + stock);<br>           &#125; <span class="hljs-keyword">else</span> &#123;<br>               System.out.println(<span class="hljs-string">&quot;库存不足了！&quot;</span>);<br>           &#125;<br><br>           redisLock.unlock(<span class="hljs-string">&quot;MYLOCK&quot;</span>,mylock);<br>       &#125;<br>       <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;OK&quot;</span>;<br>   &#125;<br><br>   <span class="hljs-comment">//使用redis分布式锁，有阻塞</span><br>   <span class="hljs-meta">@GetMapping(&quot;/stock4&quot;)</span><br>   <span class="hljs-keyword">public</span> String <span class="hljs-title function_">stock4</span><span class="hljs-params">()</span> &#123;<br>       <span class="hljs-type">String</span> <span class="hljs-variable">mylock</span> <span class="hljs-operator">=</span> redisLock.lock(<span class="hljs-string">&quot;MYLOCK&quot;</span>, <span class="hljs-number">2000</span>,<span class="hljs-number">1000</span>);<br>       <span class="hljs-keyword">if</span>(mylock!=<span class="hljs-literal">null</span>)&#123;<br>           <span class="hljs-type">int</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> Integer.parseInt(stringRedisTemplate.opsForValue().get(<span class="hljs-string">&quot;stock&quot;</span>));<br>           <span class="hljs-keyword">if</span> (stock &amp;gt; <span class="hljs-number">0</span>) &#123;<br>               stock--;<br>               <span class="hljs-comment">//放回redis</span><br>               stringRedisTemplate.opsForValue().set(<span class="hljs-string">&quot;stock&quot;</span>, stock + <span class="hljs-string">&quot;&quot;</span>);<br>               System.out.println(<span class="hljs-string">&quot;减库存成功，剩余库存是：&quot;</span> + stock);<br>           &#125; <span class="hljs-keyword">else</span> &#123;<br>               System.out.println(<span class="hljs-string">&quot;库存不足了！&quot;</span>);<br>           &#125;<br><br>           redisLock.unlock(<span class="hljs-string">&quot;MYLOCK&quot;</span>,mylock);<br>       &#125;<br>       <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;OK&quot;</span>;<br>   &#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-spring-task定时任务" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-spring-task定时任务">#</a> 3. Spring Task定时任务</h2><h3 id="_3-1-spring-task介绍" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-1-spring-task介绍">#</a> 3.1 Spring Task介绍</h3><p>在企业软件开发中经常会遇到定时任务处理的业务场景，例如银行系统每晚会定时执行对账业务，很多系统每晚都会定时执行数据备份等等。</p><p>定时任务的实现方案有很多，例如：Quartz、Spring Task、XXL job等。对于简单的应用场景可以使用Spring Task。Spring Task相关API在spring-context包中已经提供了，不需要额外导入其他jar包。</p><h3 id="_3-2-代码案例" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-2-代码案例">#</a> 3.2 代码案例</h3><p>在Spring Boot项目中使用Spring Task非常简单，只需要在Bean的方法上加入@Scheduled注解，并通过cron表达式指定触发的时间即可。</p><p>第一步：在启动类上加入@EnableScheduling注解</p><p>第二步：编写定时任务类</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.job;<br><br><span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.Scheduled;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoJob</span> &#123;<br><br><br>    <span class="hljs-meta">@Scheduled(cron = &quot;0/5 * * * * ?&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testJob</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;现在时间是&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-短信发送服务" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-短信发送服务">#</a> 4. 短信发送服务</h2><h3 id="_4-1-需求分析" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-1-需求分析">#</a> 4.1 需求分析</h3><p><strong>功能需求：</strong></p><ul><li>和具体的短信通道对接（例如：阿里云短信、梦网短信等），发送短信</li><li>短信定时发送</li><li>短信实时发送</li><li>服务注册，保证短信发送服务高可用</li><li>通道自动选举、降级</li></ul><p><strong>处理过程：</strong></p><figure><img alt="image-20210925174705923" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210925174705923-00994348.png" tabindex="0"/><figcaption>image-20210925174705923</figcaption></figure><h3 id="_4-2-项目结构" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-2-项目结构">#</a> 4.2 项目结构</h3><figure><img alt="image-20210925165514680" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210925165514680-59fef8a7.png" tabindex="0"/><figcaption>image-20210925165514680</figcaption></figure><h3 id="_4-3-核心代码" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-3-核心代码">#</a> 4.3 核心代码</h3><p>短信发送服务核心类：</p><ul><li>ServerRegister：服务注册器，用于将短信发送服务注册到Redis中，定时服务上报，定时服务检查</li><li>ConfigServiceImpl：通道配置器，用于查询可用通道（阿里短信、华为短信等），通道选举、降级</li><li>AbstractSmsService：短信发送器抽象父类，子类需要和具体的短信通道对接来完成发送短信的工作</li><li>SmsConnectLoader：通道实例加载器，根据通道配置，初始化每个通道的Bean对象</li><li>SmsFactory：短信发送工厂，获取具体的通道实例Bean对象（例如AliyunSmsService）来发送短信， 如果发送出现异常，触发通道选举和通道降级策略</li><li>SendTimingSmsImpl：定时短信业务处理器，具体负责定时短信的发送</li><li>SendSmsJob：短信发送定时任务，用于定时短信的发送，调用SendTimingSmsImpl发送定时短信</li><li>GeneralSmsListener、HighSmsListener：短信接收器，Redis队列的消费者，监听队列中的消息，如果有消息则调用SmsFactory发送实时短信</li><li>HighServerReceiver：通道消息监听器，通过Redis的发布订阅模式监听通道相关消息，调用SmsConnectLoader初始化通道和更新通道</li><li>SubscriberConfig：订阅发布模式的容器配置，创建消息监听容器，并将HighServerReceiver加入容器中</li></ul><h3 id="_4-4-功能实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-4-功能实现">#</a> 4.4 功能实现</h3><h4 id="_4-4-1-服务注册器" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-4-1-服务注册器">#</a> 4.4.1 服务注册器</h4><p>服务注册器对应的为ServerRegister类。</p><p>短信发送服务支持分布式集群部署，可以是多个实例，实例越多，发送短信的能力越强。但是对于通道选举、持久化通道等操作，只能有一个服务实例执行，其他服务实例通过redis的广播机制获得通道变化。</p><p>如果要实现这一功能，需要将所有短信发送服务实例注册到某个地方，当前实现是将所有服务实例注册到Redis中。并且为了能够监控每个服务实例运行状态，需要每个服务实例定时上报并且定时进行服务检查。</p><p><strong>业务逻辑：</strong></p><p>1、服务注册，项目启动时将当前服务实例id注册到redis</p><p>2、服务上报，每三分钟报告一次，并传入当前时间戳</p><p>3、服务检查，每十分钟检查一次服务列表，清空超过五分钟没有报告的服务</p><p><strong>代码实现：</strong></p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydl.sms.factory;<br><br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.CommandLineRunner;<br><span class="hljs-keyword">import</span> org.springframework.core.annotation.Order;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.Scheduled;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.UUID;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 服务注册器，将短信发送服务注册到Redis中，定时服务上报，定时服务检查</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Order(value = 100)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServerRegister</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CommandLineRunner</span> &#123;<br>    <span class="hljs-comment">//当前服务实例的唯一标识，可以使用UUID随机生成</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">SERVER_ID</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 项目启动时自动执行此方法，将当前服务实例注册到redis</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">(String... args)</span> &#123;<br>        <span class="hljs-comment">//TODO 服务注册器，项目启动时将当前服务id注册到Redis中，使用Redis的Hash结构，key为SERVER_ID_HASH，Hash结构的key为服务id，value为时间戳</span><br>        <span class="hljs-comment">// SERVER_ID_HASH   key  value</span><br>        SERVER_ID = UUID.randomUUID().toString(); <span class="hljs-comment">//当前实例key</span><br>        log.info(<span class="hljs-string">&quot;server实例启动，生成的id:&#123;&#125;&quot;</span>, SERVER_ID);<br>        redisTemplate.opsForHash().put(<span class="hljs-string">&quot;SERVER_ID_HASH&quot;</span>, SERVER_ID, System.currentTimeMillis());<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 定时服务报告</span><br><span class="hljs-comment">     * 报告服务信息证明服务存在 每三分钟报告一次，并传入当前时间戳</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Scheduled(cron = &quot;1 1/3 * * * ?&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serverReport</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//TODO 服务注册器，每三分钟报告一次，并传入当前时间戳</span><br><br>        log.info(<span class="hljs-string">&quot;服务定时上报。id:&#123;&#125;&quot;</span>,SERVER_ID);<br>        redisTemplate.opsForHash().put(<span class="hljs-string">&quot;SERVER_ID_HASH&quot;</span>, SERVER_ID, System.currentTimeMillis());<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 定时服务检查</span><br><span class="hljs-comment">     * 每十分钟检查一次服务列表，清空超过五分钟没有报告的服务</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Scheduled(cron = &quot;30 1/10 * * * ?&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkServer</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//TODO 服务注册器，定时检查redis,每隔10分钟查看，超过5分钟还没上报自己信息的服务，清除掉</span><br>        log.info(<span class="hljs-string">&quot;定时服务检查。id:&#123;&#125;&quot;</span>,SERVER_ID);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> redisTemplate.opsForHash().entries(<span class="hljs-string">&quot;SERVER_ID_HASH&quot;</span>);<br>        log.info(<span class="hljs-string">&quot;当前服务有：&quot;</span>+map);<br><br>        <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>        List removeKeys=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>(); <span class="hljs-comment">//该要删除的key</span><br>        <span class="hljs-comment">//jdk8 lambda表达式</span><br>        map.forEach((key,value)-&amp;gt;&#123;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">registrTime</span> <span class="hljs-operator">=</span> Long.parseLong(value.toString());<br>            <span class="hljs-keyword">if</span>(now-registrTime&amp;gt;(<span class="hljs-number">5</span>*<span class="hljs-number">60</span>*<span class="hljs-number">1000</span>))&#123;<br>                removeKeys.add(key);<br>            &#125;<br>        &#125;);<br><br>        log.info(<span class="hljs-string">&quot;该要删除的key有：&#123;&#125;&quot;</span>,removeKeys);<br>        removeKeys.forEach(key-&amp;gt;&#123;<br>            redisTemplate.opsForHash().delete(<span class="hljs-string">&quot;SERVER_ID_HASH&quot;</span>, key);<br>        &#125;);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以启动两个服务实例来测试服务注册、服务上报、服务检查是否能够正常执行。</p><h4 id="_4-4-2-通道实例加载器" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-4-2-通道实例加载器">#</a> 4.4.2 通道实例加载器</h4><p>通道实例加载器对应的为SmsConnectLoader类。</p><p>短信发送服务存在多个通道（例如阿里云短信、华为云短信等），这些通道是通过后台管理系统设置的，包括通道的名称、签名、模板、连接方式等信息。当短信发送服务启动时，或者后台管理系统设置通道时，将会初始化短信通道。</p><figure><img alt="image-20210925180125503" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210925180125503-14602673.png" tabindex="0"/><figcaption>image-20210925180125503</figcaption></figure><p>通道实例加载器的作用就是根据通道配置，初始化每个通道的Bean对象（例如AliyunSmsService、MengWangSmsService等）。</p><p>SmsConnectLoader类中只需要实现initConnect方法即可，其他方法已经提供好。</p><p><strong>业务逻辑：</strong></p><p>1、查询数据库获得通道列表</p><p>2、遍历通道列表，通过反射创建每个通道的Bean对象（例如AliyunSmsService、MengWangSmsService等）</p><p>3、将每个通道的Bean对象保存到CONNECT_LIST集合中</p><p><strong>具体代码如下：</strong></p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据通道配置，初始化每个通道的bean对象</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@SneakyThrows</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initConnect</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//TODO 根据通道配置，初始化每个通道的bean对象</span><br>        <span class="hljs-comment">//1、查询数据库获得通道列表</span><br>        List&amp;lt;ConfigEntity&amp;gt; configEntitiesList = configService.listForConnect();<br>        List constructorList=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>        <span class="hljs-comment">//2、遍历通道列表，通过反射创建每个通道的Bean对象（例如AliyunSmsService、MengWangSmsService等）</span><br>        configEntitiesList.forEach(configEntity-&amp;gt;&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                SmsConfig config=<span class="hljs-keyword">new</span> <span class="hljs-title class_">SmsConfig</span>();<br>                config.setId(configEntity.getId());<br>                config.setDomain(configEntity.getDomain());<br>                config.setName(configEntity.getName());<br>                config.setPlatform(configEntity.getPlatform().trim());<br>                config.setAccessKeyId(configEntity.getAccessKeyId().trim());<br>                config.setAccessKeySecret(configEntity.getAccessKeySecret().trim());<br>                <span class="hljs-keyword">if</span>(StringUtils.isNotBlank(configEntity.getOther()))&#123;<br>                    <span class="hljs-type">LinkedHashMap</span> <span class="hljs-variable">linkedHashMap</span> <span class="hljs-operator">=</span> JSON.parseObject(configEntity.getOther(), LinkedHashMap.class);<br>                    config.setOtherConfig(linkedHashMap);<br>                &#125;<br><br>                <span class="hljs-comment">//反射 创建Service</span><br>                <span class="hljs-comment">//全限定名 com.ydl.sms.sms.AliyunSmsService</span><br>                String className=<span class="hljs-string">&quot;com.ydl.sms.sms.&quot;</span>+config.getPlatform()+<span class="hljs-string">&quot;SmsService&quot;</span>;<br>                System.out.println(className);<br><br>                Class&amp;lt;?&amp;gt; aClass = Class.forName(className); <span class="hljs-comment">//加载类</span><br>                Constructor&amp;lt;?&amp;gt; constructor = aClass.getConstructor(SmsConfig.class);<span class="hljs-comment">//拿到具体的构造方法</span><br>                <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> constructor.newInstance(config); <span class="hljs-comment">//创建对象</span><br><br>                <span class="hljs-comment">//从容器中获取签名和模板的service</span><br>                <span class="hljs-type">SignatureService</span> <span class="hljs-variable">signatureService</span> <span class="hljs-operator">=</span> SpringUtils.getBean(SignatureService.class);<br>                <span class="hljs-type">TemplateService</span> <span class="hljs-variable">templateService</span> <span class="hljs-operator">=</span> SpringUtils.getBean(TemplateService.class);<br>                <span class="hljs-comment">//找到这两个service在父类中的属性</span><br>                <span class="hljs-type">Field</span> <span class="hljs-variable">signatureServiceField</span> <span class="hljs-operator">=</span> aClass.getSuperclass().getDeclaredField(<span class="hljs-string">&quot;signatureService&quot;</span>);<br>                <span class="hljs-type">Field</span> <span class="hljs-variable">templateServiceField</span> <span class="hljs-operator">=</span> aClass.getSuperclass().getDeclaredField(<span class="hljs-string">&quot;templateService&quot;</span>);<br>                <span class="hljs-comment">//打开访问权限</span><br>                signatureServiceField.setAccessible(<span class="hljs-literal">true</span>);<br>                templateServiceField.setAccessible(<span class="hljs-literal">true</span>);<br>                <span class="hljs-comment">//设置属性值了</span><br>                signatureServiceField.set(obj,signatureService);<br>                templateServiceField.set(obj,templateService);<br><br>                constructorList.add(obj);<br><br>                log.info(<span class="hljs-string">&quot;初始化通道成功：&#123;&#125;，&#123;&#125;&quot;</span>,config.getName(),config.getPlatform());<br>            &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>                log.warn(<span class="hljs-string">&quot;初始化通道异常：&#123;&#125;&quot;</span>,e.getMessage());<br>            &#125;<br><br>        &#125;);<br>        <span class="hljs-comment">//3、将每个通道的Bean对象保存到CONNECT_LIST集合中</span><br>        <span class="hljs-keyword">if</span>(!CONNECT_LIST.isEmpty())&#123;<br>            CONNECT_LIST.clear();<br>        &#125;<br>        CONNECT_LIST.addAll(constructorList);<br><br>        <span class="hljs-comment">//解锁逻辑</span><br>        <span class="hljs-keyword">if</span>(StringUtils.isNotBlank(BUILD_NEW_CONNECT_TOKEN))&#123;<br>            redisLock.unlock(<span class="hljs-string">&quot;buildNewConnect&quot;</span>, BUILD_NEW_CONNECT_TOKEN);<br>        &#125;<br><br>        log.info(<span class="hljs-string">&quot;通道初始化完成了。&#123;&#125;&quot;</span>,CONNECT_LIST);<br>    &#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-3-定时短信业务处理器" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-4-3-定时短信业务处理器">#</a> 4.4.3 定时短信业务处理器</h4><p>定时短信业务处理器对应的是SendTimingSmsImpl类，具体负责定时短信的发送。</p><p><strong>业务逻辑：</strong></p><p>1、查询数据库获取本次需要发送的定时短信</p><p>2、调用短信工厂发送短信</p><p>3、更新短信发送状态为“已处理”</p><p><strong>实现代码：</strong></p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydl.sms.job;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;<br><span class="hljs-keyword">import</span> com.ydl.sms.entity.TimingPushEntity;<br><span class="hljs-keyword">import</span> com.ydl.sms.factory.SmsFactory;<br><span class="hljs-keyword">import</span> com.ydl.sms.mapper.TimingPushMapper;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.Async;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 定时短信业务处理器</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SendTimingSmsImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SendTimingSms</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TimingPushMapper timingPushMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SmsFactory smsFactory;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 发送定时短信</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> timing</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Async</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(String timing)</span> &#123;<span class="hljs-comment">//timing格式：yyyy-MM-dd HH:mm  2021-12-25 18:00</span><br>        <span class="hljs-comment">//TODO 查询数据库获取本次需要发送的定时短信，调用短信工厂发送短信</span><br>        <span class="hljs-comment">//1、查询数据库获取本次需要发送的定时短信</span><br>        LambdaQueryWrapper&amp;lt;TimingPushEntity&amp;gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&amp;lt;&amp;gt;();<br>        wrapper.eq(TimingPushEntity::getStatus,<span class="hljs-number">0</span>);<br>        wrapper.eq(TimingPushEntity::getTiming,timing);<br>        wrapper.orderByAsc(TimingPushEntity::getCreateTime);<br>        List&amp;lt;TimingPushEntity&amp;gt; list = timingPushMapper.selectList(wrapper);<br><br>        log.info(<span class="hljs-string">&quot;这一批次要发的短信条数是：&#123;&#125;，&#123;&#125;&quot;</span>,timing,list.size());<br><br>        list.forEach(x-&amp;gt;&#123;<br>            <span class="hljs-comment">//2、调用短信工厂发送短信</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> x.getRequest();<br>            smsFactory.send(request);<br>            <span class="hljs-comment">//3、更新短信发送状态为“已处理”</span><br>            x.setStatus(<span class="hljs-number">1</span>);<br>            x.setUpdateTime(LocalDateTime.now());<br>            x.setUpdateUser(<span class="hljs-string">&quot;system&quot;</span>);<br>            timingPushMapper.updateById(x);<br>        &#125;);<br><br>        log.info(<span class="hljs-string">&quot;任务执行完毕&quot;</span>+timing);<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-4-短信发送定时任务" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-4-4-短信发送定时任务">#</a> 4.4.4 短信发送定时任务</h4><p>短信发送定时任务对应的是SendSmsJob类，用于定时短信的发送，调用SendTimingSmsImpl发送定时短信。</p><p><strong>业务逻辑：</strong></p><p>1、每分钟触发一次定时任务</p><p>2、为了防止短信重复发送，需要使用分布式锁</p><p>3、调用SendTimingSmsImpl发送定时短信</p><p><strong>代码实现：</strong></p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydl.sms.job;<br><br><span class="hljs-keyword">import</span> com.ydl.sms.config.RedisLock;<br><span class="hljs-keyword">import</span> com.ydl.utils.DateUtils;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.Scheduled;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 定时任务，用于发送定时短信</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SendSmsJob</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SendTimingSms sendTimingSms;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisLock redisLock;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 每分钟检查一次是否有定时短信需要发送</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> InterruptedException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-comment">//1、每分钟触发一次定时任务</span><br>    <span class="hljs-meta">@Scheduled(cron = &quot;10 0/1 * * * ?&quot;)</span>     <span class="hljs-comment">//每分钟的第10秒执行一次</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendTimingSms</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-comment">//TODO 定时任务，每分钟检查一次是否有定时短信需要发送</span><br>        <span class="hljs-comment">//1、每分钟触发一次定时任务</span><br>        <span class="hljs-comment">//2、为了防止短信重复发送，需要使用分布式锁</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redisLock.tryLock(<span class="hljs-string">&quot;SEND_TIMING_SMS&quot;</span>, <span class="hljs-number">30</span> * <span class="hljs-number">1000</span>);<br>        <span class="hljs-keyword">if</span>(StringUtils.isNotBlank(lock))&#123;<br>            <span class="hljs-comment">//3、调用SendTimingSmsImpl发送定时短信</span><br>            sendTimingSms.execute(DateUtils.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(),<span class="hljs-string">&quot;yyyy-MM-dd HH:mm&quot;</span>));<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-5-短信监听器" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-4-5-短信监听器">#</a> 4.4.5 短信监听器</h4><p>应用系统调用短信接收服务，短信接收服务将短信消息放入消息队列，实现短信的接收和发送的解耦，这种方案可以最大化提高短信接收服务性能，不会由于外部短信通道影响应用系统的响应，从而起到削峰填谷的效果。</p><p>本系统使用的Redis集群作为消息队列，在传输短信时，采用的是生产者消费者模式。</p><p>短信接收器对应的类为GeneralSmsListener和HighSmsListener，角色是Redis队列的消费者，监听队列中的消息，如果有消息则调用SmsFactory发送实时短信。</p><p><strong>业务逻辑：</strong></p><p>1、HighSmsListener监听TOPIC_HIGH_SMS队列，如果有消息则调用短信发送工厂SmsFactory发送实时短信</p><p>2、GeneralSmsListener监听TOPIC_GENERAL_SMS队列，如果有消息则调用短信发送工厂SmsFactory发送实时短信</p><p><strong>HighSmsListener具体实现：</strong></p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydl.sms.redismq;<br><br><span class="hljs-keyword">import</span> com.ydl.sms.factory.SmsFactory;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.ListOperations;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> javax.annotation.PostConstruct;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Redis队列-----消费者</span><br><span class="hljs-comment"> * 监听消息队列：TOPIC_HIGH_SMS，高优先级的短信，如验证码之类的短信</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HighSmsListener</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SmsFactory smsFactory;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">queueKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;TOPIC_HIGH_SMS&quot;</span>;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;spring.redis.queue.pop.timeout&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Long</span> <span class="hljs-variable">popTimeout</span> <span class="hljs-operator">=</span> <span class="hljs-number">8000L</span>;<br><br>    <span class="hljs-keyword">private</span> ListOperations listOps;<br><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        listOps = redisTemplate.opsForList();<br>        <span class="hljs-built_in">this</span>.start();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//TODO 监听TOPIC_HIGH_SMS队列，如果有消息则调用短信发送工厂发送实时短信</span><br>        <span class="hljs-comment">//监听    TOPIC_HIGH_SMS 发送</span><br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>            log.debug(<span class="hljs-string">&quot;队列&#123;&#125;正在监听中&quot;</span>,queueKey);<br>            <span class="hljs-comment">//SmsSendDTO --&amp;gt;string</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> (String) listOps.rightPop(queueKey, popTimeout, TimeUnit.MILLISECONDS);<br>            <span class="hljs-keyword">if</span>(StringUtils.isNotBlank(message))&#123;<br>                log.info(<span class="hljs-string">&quot;&#123;&#125;收到消息了：&#123;&#125;&quot;</span>,queueKey,message);<br>                <span class="hljs-comment">//发送</span><br>                smsFactory.send(message);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>GeneralSmsListener具体实现：</strong></p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydl.sms.redismq;<br><br><span class="hljs-keyword">import</span> com.ydl.sms.factory.SmsFactory;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.ListOperations;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> javax.annotation.PostConstruct;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Redis队列消费者，监听消息队列TOPIC_GENERAL_SMS，普通优先级的短信，如营销短信</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GeneralSmsListener</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SmsFactory smsFactory;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">queueKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;TOPIC_GENERAL_SMS&quot;</span>;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;spring.redis.queue.pop.timeout&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Long</span> <span class="hljs-variable">popTimeout</span> <span class="hljs-operator">=</span> <span class="hljs-number">8000L</span>;<br><br>    <span class="hljs-keyword">private</span> ListOperations listOps;<br><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        listOps = redisTemplate.opsForList();<br>        <span class="hljs-built_in">this</span>.start();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//TODO 监听TOPIC_GENERAL_SMS队列，如果有消息则调用短信发送工厂发送实时短信</span><br>        <span class="hljs-comment">//监听    TOPIC_GENERAL_SMS 发送</span><br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>            log.debug(<span class="hljs-string">&quot;队列&#123;&#125;正在监听中&quot;</span>,queueKey);<br>            <span class="hljs-comment">//SmsSendDTO --&amp;gt;string</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> (String) listOps.rightPop(queueKey, popTimeout, TimeUnit.MILLISECONDS);<br>            <span class="hljs-keyword">if</span>(StringUtils.isNotBlank(message))&#123;<br>                log.info(<span class="hljs-string">&quot;&#123;&#125;收到消息了：&#123;&#125;&quot;</span>,queueKey,message);<br>                <span class="hljs-comment">//发送</span><br>                smsFactory.send(message);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-6-通道消息监听器" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-4-6-通道消息监听器">#</a> 4.4.6 通道消息监听器</h4><p>通道消息监听器对应的类是HighServerReceiver，作用是通过Redis的发布订阅模式监听TOPIC_HIGH_SERVER频道中的消息，调用SmsConnectLoader初始化通道和更新通道。</p><p><strong>业务逻辑：</strong></p><p>1、通过Redis发布订阅模式监听TOPIC_HIGH_SERVER频道中的消息</p><p>2、如果消息为USE_NEW_CONNECT，表示通道更新，调用通道实例加载器SmsConnectLoader更新通道</p><p>3、如果消息为INIT_CONNECT，表示通道初始化，调用通道实例加载器SmsConnectLoader初始化通道</p><p><strong>实现代码：</strong></p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydl.sms.redismq;<br><br><span class="hljs-keyword">import</span> com.ydl.sms.factory.SmsConnectLoader;<br><span class="hljs-keyword">import</span> com.ydl.sms.model.ServerTopic;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.connection.Message;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.connection.MessageListener;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.RedisSerializer;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Redis发布订阅----订阅者，通过Redis的发布订阅模式监听TOPIC_HIGH_SERVER频道</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HighServerReceiver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MessageListener</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SmsConnectLoader smsConnectLoader;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 消息监听</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pattern</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(Message message, <span class="hljs-type">byte</span>[] pattern)</span> &#123;<br>        <span class="hljs-comment">//TODO 消息监听，根据消息内容调用smsConnectLoader进行通道初始化或者通道更新</span><br><br>        RedisSerializer&amp;lt;?&amp;gt; valueSerializer = redisTemplate.getDefaultSerializer();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">deserialize</span> <span class="hljs-operator">=</span> valueSerializer.deserialize(message.getBody()).toString();<br><br>        <span class="hljs-type">ServerTopic</span> <span class="hljs-variable">serverTopic</span> <span class="hljs-operator">=</span> ServerTopic.load(deserialize);<br><br>        <span class="hljs-keyword">switch</span> (serverTopic.getOption()) &#123;<br>            <span class="hljs-keyword">case</span> ServerTopic.USE_NEW_CONNECT:<br>                log.info(<span class="hljs-string">&quot;服务：&#123;&#125; 发起【通道更新】&quot;</span>, serverTopic.getValue());<br>                smsConnectLoader.changeNewConnect();<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> ServerTopic.INIT_CONNECT:<br>                log.info(<span class="hljs-string">&quot;服务：&#123;&#125; 发起【通道初始化】&quot;</span>, serverTopic.getValue());<br>                smsConnectLoader.initConnect();<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5对接阿里短信进行真实发送" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_5对接阿里短信进行真实发送">#</a> 5对接阿里短信进行真实发送！</h2><p>1申请阿里短信的签名 和 模板</p><figure><img alt="image-20210926040554940" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210926040554940-4c71e349.png" tabindex="0"/><figcaption>image-20210926040554940</figcaption></figure><p>2获取accessKey和secret</p><figure><img alt="image-20210926040656499" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210926040656499-ff340c30.png" tabindex="0"/><figcaption>image-20210926040656499</figcaption></figure><p>3参考文档经行代码编写</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs text">private void init() &#123;<br>        //初始化acsClient，暂不支持region化 &quot;cn-hangzhou&quot;<br>        //profile = DefaultProfile.getProfile(config.get(&quot;RegionId&quot;), config.getAccessKeyId(), config.getAccessKeySecret());<br>        aliconfig = new Config()<br>                // 您的AccessKey ID<br>                .setAccessKeyId(config.getAccessKeyId())<br>                // 您的AccessKey Secret<br>                .setAccessKeySecret( config.getAccessKeySecret());<br>        // 访问的域名<br>        aliconfig.endpoint = &quot;dysmsapi.aliyuncs.com&quot;;<br>    &#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs text">@Override<br>    protected String sendSms(String mobile, Map&amp;lt;String, String&amp;gt; params, String signature, String template) &#123;<br>        // 获取 签名内容 和模板id<br>        SignatureEntity signatureEntity = signatureService.getByCode(signature);<br>        String code = templateService.getConfigCodeByCode(config.getId(), template);<br>        try &#123;<br>            Client client = new Client(aliconfig);<br><br>            SendSmsRequest request=new SendSmsRequest();<br>            request.setPhoneNumbers(mobile);<br>            request.setTemplateCode(code);<br>            request.setTemplateParam(JSON.toJSONString(params));<br>            request.setSignName(signatureEntity.getContent());<br><br>            SendSmsResponse response = client.sendSms(request);<br>            JSONObject jsonObject = JSON.parseObject(String.valueOf(response.getBody()));<br>            if (response.getBody().getCode().equals(&quot;OK&quot;)) &#123;<br>                return response.getBody().toString();<br>            &#125; else &#123;<br>                return failResponse(jsonObject.getString(&quot;Message&quot;),response.getBody().getMessage());<br>            &#125;<br>        &#125; catch (Exception e) &#123;<br>            log.error(&quot;Aliyun 短信发送失败：&#123;&#125; ,&#123;&#125;&quot;, mobile, template, e);<br>            return failResponse(e.getMessage(), e.getMessage());<br>        &#125;<br>        //&quot;&#123;\&quot;Message\&quot;:\&quot;OK\&quot;,\&quot;RequestId\&quot;:\&quot;&quot; + UUID.randomUUID().toString().toUpperCase() + &quot;-@\&quot;,\&quot;BizId\&quot;:\&quot;&quot; + System.currentTimeMillis() + &quot;\&quot;,\&quot;Code\&quot;:\&quot;OK\&quot;&#125;&quot;;<br>    &#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4平台配置相应正确参数</p><figure><img alt="image-20210926040844298" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210926040844298-ea99a523.png" tabindex="0"/><figcaption>image-20210926040844298</figcaption></figure><figure><img alt="image-20210926040853475" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210926040853475-7995b0c6.png" tabindex="0"/><figcaption>image-20210926040853475</figcaption></figure><figure><img alt="image-20210926040905138" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210926040905138-5a424696.png" tabindex="0"/><figcaption>image-20210926040905138</figcaption></figure><p><img alt="image-20210926040915170" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210926040915170-3ead5d57.png"/><img alt="image-20210926040924104" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210926040924104-3d778718.png"/></p><figure><img alt="image-20210926040930674" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210926040930674-851d3f30.png" tabindex="0"/><figcaption>image-20210926040930674</figcaption></figure><p>5启动三个平台，和shop服务，进行发送</p><figure><img alt="image-20210926041010750" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210926041010750-2bf815e3.png" tabindex="0"/><figcaption>image-20210926041010750</figcaption></figure><p>6结果</p><figure><img alt="image-20210926041050855" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/image-20210926041050855-067ff263.png" tabindex="0"/><figcaption>image-20210926041050855</figcaption></figure></div></article>
<div class="article-footer">

</div>

<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"></div><div class="item" id="next"><div class="note">接下来阅读</div><a href="/wiki/YDLDoc4/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E5%B7%A5%E4%BD%9C%E6%B5%81/%E5%B7%A5%E4%BD%9C%E6%B5%81/">工作流</a></div></section></div>


  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>快来参与讨论吧~</p>

    </section>
    <section class='body cmt-body waline'>
      

<div id="waline_container" class="waline_thread"><svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg></div>

    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="text"><p style="text-align:center" >
本站由 <a style="font-weight: bold;" href="/author/ThatCoder/">钟意</a> 使用 <a style="font-weight: bold;" target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.33.1">Stellar 1.33.1</a> 主题创建。
<br>
由 <a style="font-weight: bold;" target="_blank" rel="noopener" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral">又拍云</a> 提供CDN加速/云存储服务
<br>
由 <a style="font-weight: bold;" target="_blank" rel="noopener" href="https://vercel.com/">vercel</a>、<a style="font-weight: bold;" target="_blank" rel="noopener" href="https://www.netlify.com/">netlify</a>、<a style="font-weight: bold;" target="_blank" rel="noopener" href="https://www.cloudflare.com/">cloudflare</a> 提供托管服务
<br>
<a href="https://beian.miit.gov.cn/" target="_blank">湘ICP备2023019799号-1</a>
<br>
<!--不蒜子计数器-->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!--添加一个访问量-->
<span>总访问 <span id="busuanzi_value_site_pv" style="font-weight: bold;"></span> 次 
<!--本页访问 <span id="busuanzi_value_page_pv" style="font-weight: bold;"></span> 次</span>-->
<div id="siteruntime"></div>
</p>
<script>
function siteTime(){
    window.setTimeout("siteTime()", 1000);
    var seconds = 1000
    var minutes = seconds * 60
    var hours = minutes * 60
    var days = hours * 24
    var years = days * 365
    var today = new Date()
    var todayYear = today.getFullYear()
    var todayMonth = today.getMonth()
    var todayDate = today.getDate()
    var todayHour = today.getHours()
    var todayMinute = today.getMinutes()
    var todaySecond = today.getSeconds()
    var t1 = Date.UTC(2020,4,30,08,00,00)
    var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond)
    var diff = t2-t1
    var diffYears = Math.floor(diff/years)
    var diffDays = Math.floor((diff/days)-diffYears*365)
    var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours)
    var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes)
    var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds)
    document.getElementById("siteruntime").innerHTML="<p style=\"text-align:center\">小破站已颠沛流离 "+diffYears+" 年 "+diffDays+" 天 "+diffHours+" 小时 "+diffMinutes+" 分钟 "+diffSeconds+" 秒</p>"
}
siteTime();
</script>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="auto"><div class="widget-header dis-select"><span class="name">本文目录</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#_1-%E9%A1%B9%E7%9B%AE%E6%A6%82%E8%BF%B0"><span class="toc-text"> 1. 项目概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_1-1-%E8%83%8C%E6%99%AF%E4%BB%8B%E7%BB%8D"><span class="toc-text"> 1.1 背景介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_1-2-%E4%B8%9A%E5%8A%A1%E6%9E%B6%E6%9E%84"><span class="toc-text"> 1.2 业务架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_1-3-%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84"><span class="toc-text"> 1.3 技术架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-3-1-%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1"><span class="toc-text"> 1.3.1 系统管理服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-3-2-%E7%9F%AD%E4%BF%A1%E6%8E%A5%E6%94%B6%E6%9C%8D%E5%8A%A1"><span class="toc-text"> 1.3.2 短信接收服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-3-3-%E7%9F%AD%E4%BF%A1%E5%8F%91%E9%80%81%E6%9C%8D%E5%8A%A1"><span class="toc-text"> 1.3.3 短信发送服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_1-4-%E9%A1%B9%E7%9B%AE%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D"><span class="toc-text"> 1.4 项目模块介绍</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_2-%E9%A1%B9%E7%9B%AE%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text"> 2. 项目环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-1-%E7%8E%AF%E5%A2%83%E8%A6%81%E6%B1%82"><span class="toc-text"> 2.1 环境要求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-2-redis%E9%9B%86%E7%BE%A4"><span class="toc-text"> 2.2 Redis集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-3-%E5%90%8E%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%AF%BC%E5%85%A5"><span class="toc-text"> 2.3 后端工程导入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-4-%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text"> 2.4 数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-5-%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B"><span class="toc-text"> 2.5 前端工程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_3-%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1"><span class="toc-text"> 3. 后台管理服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-1-%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="toc-text"> 3.1. 项目结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-1-1-%E5%9F%BA%E7%A1%80%E5%B7%A5%E7%A8%8B"><span class="toc-text"> 3.1.1 基础工程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-1-2-%E7%AE%A1%E7%90%86%E7%AB%AF%E5%B7%A5%E7%A8%8B"><span class="toc-text"> 3.1.2 管理端工程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-2-%E5%8A%9F%E8%83%BD%E6%B8%85%E5%8D%95"><span class="toc-text"> 3.2. 功能清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-3-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E4%B8%8E%E7%B1%BB"><span class="toc-text"> 3.3. 数据模型与类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-4-%E5%9F%BA%E7%A1%80%E5%B1%9E%E6%80%A7%E8%87%AA%E5%8A%A8%E6%B3%A8%E5%85%A5"><span class="toc-text"> 3.4. 基础属性自动注入</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-4-1-%E5%9F%BA%E7%A1%80%E5%B1%9E%E6%80%A7"><span class="toc-text"> 3.4.1 基础属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-4-2-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3"><span class="toc-text"> 3.4.2 自定义注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-4-3-%E5%AE%9A%E4%B9%89%E5%88%87%E9%9D%A2%E7%B1%BB"><span class="toc-text"> 3.4.3 定义切面类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-4-4-%E4%BD%BF%E7%94%A8%E6%B3%A8%E8%A7%A3"><span class="toc-text"> 3.4.4 使用注解</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-5-redis%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F"><span class="toc-text"> 3.5. Redis发布订阅模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-5-1-%E6%A1%88%E4%BE%8B%E6%BC%94%E7%A4%BA"><span class="toc-text"> 3.5.1 案例演示</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-5-2-%E4%BB%A3%E7%A0%81%E6%A1%88%E4%BE%8B"><span class="toc-text"> 3.5.2 代码案例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-6-%E9%80%9A%E9%81%93%E7%AE%A1%E7%90%86"><span class="toc-text"> 3.6. 通道管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-6-1-%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B"><span class="toc-text"> 3.6.1 产品原型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-6-2-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text"> 3.6.2 需求分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-6-3-%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 3.6.3 具体实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_1-%E7%9F%AD%E4%BF%A1%E6%8E%A5%E6%94%B6%E6%9C%8D%E5%8A%A1%E4%BB%8B%E7%BB%8D"><span class="toc-text"> 1. 短信接收服务介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_2-redis%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text"> 2. Redis消息队列</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-1-redis%E9%98%9F%E5%88%97%E4%BB%8B%E7%BB%8D"><span class="toc-text"> 2.1 Redis队列介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-2-%E6%A1%88%E4%BE%8B%E6%BC%94%E7%A4%BA"><span class="toc-text"> 2.2 案例演示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-3-%E4%BB%A3%E7%A0%81%E6%A1%88%E4%BE%8B"><span class="toc-text"> 2.3 代码案例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_3-%E7%9F%AD%E4%BF%A1%E6%8E%A5%E6%94%B6%E6%9C%8D%E5%8A%A1"><span class="toc-text"> 3. 短信接收服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-%E9%87%8D%E7%82%B9"><span class="toc-text"> 3.1 需求分析-重点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-2-%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="toc-text"> 3.2 项目结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-3-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E4%B8%8E%E7%B1%BB-1"><span class="toc-text"> 3.3 数据模型与类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-4-%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8"><span class="toc-text"> 3.4 消息存储</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-5-tcp%E6%8E%A5%E5%8F%A3"><span class="toc-text"> 3.5 TCP接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-6-sdk"><span class="toc-text"> 3.6 SDK</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-6-1-%E8%AF%B4%E6%98%8E"><span class="toc-text"> 3.6.1 说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-6-2-%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 3.6.2 实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-6-3-%E6%B5%8B%E8%AF%95"><span class="toc-text"> 3.6.3 测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_1-%E7%9F%AD%E4%BF%A1%E5%8F%91%E9%80%81%E6%9C%8D%E5%8A%A1%E4%BB%8B%E7%BB%8D"><span class="toc-text"> 1. 短信发送服务介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_2-redis%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-text"> 2. Redis实现分布式锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-1-setnx"><span class="toc-text"> 2.1 SETNX</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-2-set"><span class="toc-text"> 2.2 SET</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-3-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 2.3 代码实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_3-spring-task%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-text"> 3. Spring Task定时任务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-1-spring-task%E4%BB%8B%E7%BB%8D"><span class="toc-text"> 3.1 Spring Task介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-2-%E4%BB%A3%E7%A0%81%E6%A1%88%E4%BE%8B"><span class="toc-text"> 3.2 代码案例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_4-%E7%9F%AD%E4%BF%A1%E5%8F%91%E9%80%81%E6%9C%8D%E5%8A%A1"><span class="toc-text"> 4. 短信发送服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_4-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text"> 4.1 需求分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_4-2-%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="toc-text"> 4.2 项目结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_4-3-%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81"><span class="toc-text"> 4.3 核心代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_4-4-%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 4.4 功能实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_4-4-1-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%99%A8"><span class="toc-text"> 4.4.1 服务注册器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4-4-2-%E9%80%9A%E9%81%93%E5%AE%9E%E4%BE%8B%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-text"> 4.4.2 通道实例加载器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4-4-3-%E5%AE%9A%E6%97%B6%E7%9F%AD%E4%BF%A1%E4%B8%9A%E5%8A%A1%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-text"> 4.4.3 定时短信业务处理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4-4-4-%E7%9F%AD%E4%BF%A1%E5%8F%91%E9%80%81%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-text"> 4.4.4 短信发送定时任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4-4-5-%E7%9F%AD%E4%BF%A1%E7%9B%91%E5%90%AC%E5%99%A8"><span class="toc-text"> 4.4.5 短信监听器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4-4-6-%E9%80%9A%E9%81%93%E6%B6%88%E6%81%AF%E7%9B%91%E5%90%AC%E5%99%A8"><span class="toc-text"> 4.4.6 通道消息监听器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_5%E5%AF%B9%E6%8E%A5%E9%98%BF%E9%87%8C%E7%9F%AD%E4%BF%A1%E8%BF%9B%E8%A1%8C%E7%9C%9F%E5%AE%9E%E5%8F%91%E9%80%81"><span class="toc-text"> 5对接阿里短信进行真实发送！</span></a></li></ol></div><div class="widget-footer"><a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><!-- Icon from Solar by 480 Design - https://creativecommons.org/licenses/by/4.0/ --><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5"><path stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/><path d="M7 3.338A9.95 9.95 0 0 1 12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12c0-1.821.487-3.53 1.338-5"/></g></svg><span>回到顶部</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><!-- Icon from Solar by 480 Design - https://creativecommons.org/licenses/by/4.0/ --><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5" d="M8 10.5h8M8 14h5.5M17 3.338A9.95 9.95 0 0 0 12 2C6.477 2 2 6.477 2 12c0 1.6.376 3.112 1.043 4.453c.178.356.237.763.134 1.148l-.595 2.226a1.3 1.3 0 0 0 1.591 1.592l2.226-.596a1.63 1.63 0 0 1 1.149.133A9.96 9.96 0 0 0 12 22c5.523 0 10-4.477 10-10c0-1.821-.487-3.53-1.338-5"/></svg><span>参与讨论</span></a></div></widget>
</div></aside><div class='float-panel'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">


<script type="text/javascript">
  window.canonical = {"originalHost":"blog.thatcoder.cn","officialHosts":["localhost","en.blog.thatcoder.cn","hexo.thatcoder.cn","thatcoder.vercel.app","thatcoder.netlify.app","cn-coder.vercel.app","thatcoders.github.io","thatcoder.pages.dev","cncoder.pages.dev"],"encoded":"YmxvZy50aGF0Y29kZXIuY24="};
  window.canonical["param"] = {"permalink":"https://blog.thatcoder.cn/wiki/YDLDoc4/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93"};
  const ctx = {
    date_suffix: {
      just: `刚刚`,
      min: `分钟前`,
      hour: `小时前`,
      day: `天前`,
    },
    root : `/`,
    tag_plugins: {
      chat: Object.assign({"api":"https://siteinfo.listentothewind.cn/api/v1"}),
    }
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"post, page, docs","path":"/search.json","content":true,"skip_search":null,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
    loading: `https://api.iconify.design/eos-icons:three-dots-loading.svg?color=%231cd0fd`,
  };
  const deps = {
    jquery: `https://gcore.jsdelivr.net/npm/jquery@3.7/dist/jquery.min.js`,
    marked: `https://gcore.jsdelivr.net/npm/marked@13.0/lib/marked.umd.min.js`,
    lazyload: `/%5Bobject%20Object%5D`
  }
  

</script>

<script type="text/javascript">
  
  function RunItem() {
    this.list = []; // 存放回调函数
    this.start = () => {
      for (var i = 0; i < this.list.length; i++) {
        this.list[i].run();
      }
    };
    this.push = (fn, name, setRequestAnimationFrame = true) => {
      let myfn = fn
      if (setRequestAnimationFrame) {
        myfn = () => {
          utils.requestAnimationFrame(fn)
        }
      }
      var f = new Item(myfn, name);
      this.list.push(f);
    };
    this.remove = (name) => {
      for (let index = 0; index < this.list.length; index++) {
        const e = this.list[index];
        if (e.name == name) {
          this.list.splice(index, 1);
        }
      }
    }
    // 构造一个可以run的对象
    function Item(fn, name) {
      // 函数名称
      this.name = name || fn.name;
      // run方法
      this.run = () => {
        try {
          fn()
        } catch (error) {
          console.log(error);
        }
      };
    }
  }

  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')) {
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function () {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },

    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      const maxRetry = 3;
      let retryCount = 0;

      return new Promise((resolve, reject) => {
        const load = () => {
          utils.onLoading?.(el);

          let timedOut = false;
          const timeout = setTimeout(() => {
            timedOut = true;
            console.warn('[request] 超时:', url);

            if (++retryCount >= maxRetry) {
              utils.onLoadFailure?.(el);
              onFailure?.();
              reject('请求超时');
            } else {
              setTimeout(load, 1000);
            }
          }, 5000);

          fetch(url).then(resp => {
            if (timedOut) return;
            clearTimeout(timeout);

            if (!resp.ok) throw new Error('响应失败');
            return resp;
          }).then(data => {
            if (timedOut) return;
            utils.onLoadSuccess?.(el);
            callback(data);
            resolve(data);
          }).catch(err => {
            clearTimeout(timeout);
            console.warn('[request] 错误:', err);

            if (++retryCount >= maxRetry) {
              utils.onLoadFailure?.(el);
              onFailure?.();
              reject(err);
            } else {
              setTimeout(load, 1000);
            }
          });
        };

        load();
      });
    },
    requestWithoutLoading: (url, options = {}, maxRetry = 2, timeout = 5000) => {
      return new Promise((resolve, reject) => {
        let retryCount = 0;

        const tryRequest = () => {
          let timedOut = false;
          const timer = setTimeout(() => {
            timedOut = true;
            if (++retryCount > maxRetry) reject('timeout');
            else tryRequest();
          }, timeout);

          fetch(url, options)
            .then(resp => {
              clearTimeout(timer);
              if (!resp.ok) throw new Error('bad response');
              resolve(resp);
            })
            .catch(err => {
              clearTimeout(timer);
              if (++retryCount > maxRetry) reject(err);
              else setTimeout(tryRequest, 500);
            });
        };

        tryRequest();
      });
    },
    /********************** requestAnimationFrame ********************************/
    // 1、requestAnimationFrame 会把每一帧中的所有 DOM 操作集中起来，在一次重绘或回流中就完成，并且重绘或回流的时间间隔紧紧跟随浏览器的刷新频率，一般来说，这个频率为每秒60帧。
    // 2、在隐藏或不可见的元素中，requestAnimationFrame 将不会进行重绘或回流，这当然就意味着更少的的 cpu，gpu 和内存使用量。
    requestAnimationFrame: (fn) => {
      if (!window.requestAnimationFrame) {
        window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame;
      }
      window.requestAnimationFrame(fn)
    },
    dark: {},
  };

  // utils.dark.mode 当前模式 dark or light
  // utils.dark.toggle() 暗黑模式触发器
  // utils.dark.push(callBack[,"callBackName"]) 传入触发器回调函数
  utils.dark.method = {
    toggle: new RunItem(),
  };
  utils.dark = Object.assign(utils.dark, {
    push: utils.dark.method.toggle.push,
  });
</script>
<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>
<script type="text/javascript">
  (() => {
    const tagSwitchers = document.querySelectorAll('.tag-subtree.parent-tag > a > .tag-switcher-wrapper')
    for (const tagSwitcher of tagSwitchers) {
      tagSwitcher.addEventListener('click', (e) => {
        const parent = e.target.closest('.tag-subtree.parent-tag')
        parent.classList.toggle('expanded')
        e.preventDefault()
      })
    }

    // Get active tag from query string, then activate it.
    const urlParams = new URLSearchParams(window.location.search)
    const activeTag = urlParams.get('tag')
    if (activeTag) {
      let tag = document.querySelector(`.tag-subtree[data-tag="${activeTag}"]`)
      if (tag) {
        tag.querySelector('a').classList.add('active')
        
        while (tag) {
          tag.classList.add('expanded')
          tag = tag.parentElement.closest('.tag-subtree.parent-tag')
        }
      }
    }
  })()
</script>

<script async src="https://gcore.jsdelivr.net/npm/vanilla-lazyload@19.1/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
    callback_loaded: (el) => {
      el.classList.add('loaded');
      const wrapper = el.closest('.lazy-box');
      const icon = wrapper?.querySelector('.lazy-icon');
      if (icon) icon.remove();
    }
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });

  window.wrapLazyloadImages = (container) => {
    if (typeof container === 'string') {
      container = document.querySelector(container);
    }
    if (!container) return;
    
    const images = container.querySelectorAll('img');
    images.forEach((img) => {
      if (img.classList.contains('lazy')) return;

      const src = img.getAttribute('src');
      if (!src) return;

      const wrapper = document.createElement('div');
      wrapper.className = 'lazy-box';

      const newImg = img.cloneNode();
      newImg.removeAttribute('src');
      newImg.setAttribute('data-src', src);
      newImg.classList.add('lazy');

      const icon = document.createElement('div');
      icon.className = 'lazy-icon';
      if (def.loading) {
        icon.style.backgroundImage = `url("${def.loading}")`;
      }

      wrapper.appendChild(newImg);
      wrapper.appendChild(icon);

      img.replaceWith(wrapper);
    });

    // 通知 LazyLoad 更新
    if (window.lazyLoadInstance?.update) {
      window.lazyLoadInstance.update();
    }
  }
  
</script>

<!-- required -->
<script src="/js/main.js?v=1.33.1" defer></script>

<script type="text/javascript">
  const applyTheme = (theme) => {
    if (theme === 'auto') {
      document.documentElement.removeAttribute('data-theme')
    } else {
      document.documentElement.setAttribute('data-theme', theme)
    }

    // applyThemeToGiscus(theme)
  }

  // FIXME: 这会导致无法使用 preferred_color_scheme 以外的主题
  const applyThemeToGiscus = (theme) => {
    // theme = theme === 'auto' ? 'preferred_color_scheme' : theme
    const cmt = document.getElementById('giscus')
    if (cmt) {
      // This works before giscus load.
      cmt.setAttribute('data-theme', theme)
    }

    const iframe = document.querySelector('#comments > section.giscus > iframe')
    if (iframe) {
      // This works after giscus loaded.
      const src = iframe.src
      const newSrc = src.replace(/theme=[\w]+/, `theme=${theme}`)
      iframe.src = newSrc
    }
  }

  const switchTheme = () => {
    // light -> dark -> auto -> light -> ...
    const currentTheme = document.documentElement.getAttribute('data-theme')
    let newTheme;
    switch (currentTheme) {
      case 'light':
        newTheme = 'dark'
        break
      case 'dark':
        newTheme = 'auto'
        break
      default:
        newTheme = 'light'
    }
    applyTheme(newTheme)
    window.localStorage.setItem('Stellar.theme', newTheme)
    utils.dark.mode = newTheme === 'auto' ? (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light") : newTheme;
    utils.dark.method.toggle.start();

    const messages = {
      light: `切换到浅色模式`,
      dark: `切换到深色模式`,
      auto: `切换到跟随系统配色`,
    }
    hud?.toast?.(messages[newTheme])
  }

  (() => {
    // Apply user's preferred theme, if any.
    const theme = window.localStorage.getItem('Stellar.theme')
    if (theme !== null) {
      applyTheme(theme)
    } else {
      utils.dark.mode = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    }
    utils.dark.method.toggle.start();
  })()
</script>


<!-- optional -->

  <script type="module">
  import { init } from 'https://gcore.jsdelivr.net/npm/@waline/client@3.1/dist/waline.js';

  const el = document.getElementById('waline_container');
  util.viewportLazyload(el, load_waline, false);

  function load_waline(){
    if (!el) return;

    utils.css('https://gcore.jsdelivr.net/npm/@waline/client@3.1/dist/waline.css');
    utils.css('https://gcore.jsdelivr.net/npm/@waline/client@3.1/dist/waline-meta.css');

    const path = el.getAttribute('comment_id') ?? decodeURI(window.location.pathname);
    const waline = init(Object.assign({"js":"https://gcore.jsdelivr.net/npm/@waline/client@3.1/dist/waline.js","css":"https://gcore.jsdelivr.net/npm/@waline/client@3.1/dist/waline.css","meta_css":"https://gcore.jsdelivr.net/npm/@waline/client@3.1/dist/waline-meta.css","serverURL":"https://waline.thatapi.cn/","commentCount":true,"pageview":false,"search":false,"locale":{"placeholder":"  遇事不决, 可问春风..."},"emoji":["https://upyun.thatcdn.cn/public/web/emojis/bilibili","https://upyun.thatcdn.cn/public/web/emojis/qq","https://upyun.thatcdn.cn/public/web/emojis/tieba","https://upyun.thatcdn.cn/public/web/emojis/weibo"],"reaction":["https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_thumbsup.png","https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_cute.png","https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_sunglasses.png","https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_crazy.png","https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_trollface.png"],"meta":["nick","mail","link"],"imageUploader":{"fileName":"file","tokenName":"Authorization","api":"https://lsky.thatcoder.cn/api/v1/upload","token":"Bearer 6|x9vHGJGHAnjqbO0PGEE5vM7r9S9hdqFA9bmdESdm","resp":"data.links.url"}}, {
      el: '#waline_container',
      path: path,
      
        imageUploader: function(file) {
          const headers = new Headers();
          headers.set('Accept', 'application/json');
          
            headers.set('Authorization', 'Bearer 6|x9vHGJGHAnjqbO0PGEE5vM7r9S9hdqFA9bmdESdm')
          
          const formData = new FormData();
          formData.append('file', file);
          return fetch('https://lsky.thatcoder.cn/api/v1/upload',{
            method: 'POST',
            body: formData,
            headers: headers
            }).then((resp) => resp.json())
              .then((resp) => resp.data.links.url)
        },
      
    }));
  }
</script>




<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"rating":{"js":"/js/services/rating.js","api":"https://star-vote.xaox.cc/api/rating"},"vote":{"js":"/js/services/vote.js","api":"https://star-vote.xaox.cc/api/vote"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"friends_and_posts":{"js":"/js/services/friends_and_posts.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"},"voice":{"js":"/js/plugins/voice.js"},"video":{"js":"/js/plugins/video.js"},"download-file":{"js":"/js/plugins/download-file.js"},"twikoo":{"js":"/js/services/twikoo_latest_comment.js"},"waline":{"js":"/js/services/waline_latest_comment.js"},"artalk":{"js":"/js/services/artalk_latest_comment.js"},"giscus":{"js":"/js/services/giscus_latest_comment.js"},"contributors":{"edit_this_page":{"_posts/":null,"wiki/stellar/":"https://github.com/xaoxuu/hexo-theme-stellar-docs/blob/main/"},"js":"/js/services/contributors.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else if (id == 'voice') {
        ctx.voiceAudios = document.querySelectorAll('.voice>audio');
        if (ctx.voiceAudios?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            createVoiceDom(ctx.voiceAudios);
          });
        }
      } else if (id == 'video') {
        ctx.videos = document.querySelectorAll('.video>video');
        if (ctx.videos?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            videoEvents(ctx.videos);
          });
        }
      } else if (id == 'download-file') {
        ctx.files = document.querySelectorAll('.file');
        if (ctx.files?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            downloadFileEvent(ctx.files);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }

    // chat iphone time
    let phoneTimes = document.querySelectorAll('.chat .status-bar .time');

    if (phoneTimes.length > 0) {
      NowTime();
      var date = new Date();
      var sec = date.getSeconds();
      var firstAdjustInterval = setInterval(firstAdjustTime, 1000 * (60 - sec));
    }

    function firstAdjustTime() {
      NowTime();
      clearInterval(firstAdjustInterval);
      setInterval(NowTime, 1000 * 60);
    }

    function NowTime() {
      for (let i = 0; i < phoneTimes.length; ++i) {
        var timeSpan = phoneTimes[i];
        var date = new Date();
        var hour = date.getHours();
        var min = date.getMinutes();
        timeSpan.innerHTML = check(hour) + ":" + check(min);
      }
    };

    function check(val) {
      if (val < 10) {
        return ("0" + val);
      }
      return (val);
    }

    // chat quote
    const chat_quote_obverser = new IntersectionObserver((entries, observer) => {
      entries.filter((entry) => { return entry.isIntersecting }).sort((a, b) => a.intersectionRect.y !== b.intersectionRect.y ? a.intersectionRect.y - b.intersectionRect.y : a.intersectionRect.x - b.intersectionRect.x).forEach((entry, index) => {
          observer.unobserve(entry.target);
          setTimeout(() => {
            entry.target.classList.add('quote-blink');
            setTimeout(() => {
              entry.target.classList.remove('quote-blink');
            }, 1000);
          }, Math.max(100, 16) * (index + 1));
        });
    });

    var chatQuotes = document.querySelectorAll(".chat .talk .quote");
    chatQuotes.forEach((quote) => {
      quote.addEventListener('click', function () {
        var chatCellDom = document.getElementById("quote-" + quote.getAttribute("quotedCellTag"));
        if (chatCellDom) {
          var chatDiv = chatCellDom.parentElement;
          var mid = chatDiv.clientHeight / 2;
          var offsetTop = chatCellDom.offsetTop;
          if (offsetTop > mid - chatCellDom.clientHeight / 2) {
            chatDiv.scrollTo({
              top: chatCellDom.offsetTop - mid + chatCellDom.clientHeight / 2,
              behavior: "smooth"
            });
          } else {
            chatDiv.scrollTo({
              top: 0,
              behavior: "smooth"
            });
          }
          chat_quote_obverser.observe(chatCellDom);
        }
      });
    });
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://gcore.jsdelivr.net/npm/flying-pages@2/flying-pages.min.js"></script><script>
  ctx.fancybox = {
    selector: `.swiper-slide img, .md-text.content p>img, .md-text.content li img , .wl-content img, waline_container .vcontent img, .timeline .body .image img,  .timeline .gallery img`,
    css: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.min.css`,
    js: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.umd.min.js`
  };
  var selector = '[data-fancybox]:not(.error), .with-fancybox .atk-content img:not([atk-emoticon])';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const memos = document.getElementsByClassName('ds-memos');
    if (memos != undefined && memos.length > 0) {
      needFancybox = true;
    }
    const fancybox = document.getElementsByClassName('with-fancybox');
    if (fancybox != undefined && fancybox.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>




<!-- inject -->
<script type="text/javascript" src="/custom/js/ZYUtil.js"></script><script type="text/javascript" src="/custom/js/ZYDark.js"></script><script type="text/javascript" src="/custom/js/ZYCategory.js"></script><script type="text/javascript" src="/custom/js/ZYCode.js"></script><script type="text/javascript" src="/custom/js/timetmpl.js"></script>
</div></body></html>
