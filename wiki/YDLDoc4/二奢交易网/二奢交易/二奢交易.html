
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.28.1" theme-name="Stellar" theme-version="1.28.1">
  
  <meta name="generator" content="Hexo 7.1.1">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f9fafb">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  
  <title>YDLDoc4：二奢交易 - 那个码农</title>

  
    <meta name="description" content="# 第11章 订单提示课程视频教程链接：https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV12Y411x7zXopen in new window角色： 订单模块，后端开发工程师。# 课程内容完成订单结算页渲染完成用户下单实现完成库存变更实现# 1 订单结算页image-20211205120105277# 1.1 收件地址分析1展示 打开前台 order.htmlimage-20">
<meta property="og:type" content="website">
<meta property="og:title" content="二奢交易">
<meta property="og:url" content="https://blog.thatcoder.cn/wiki/YDLDoc4/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93.html">
<meta property="og:site_name" content="那个码农">
<meta property="og:description" content="# 第11章 订单提示课程视频教程链接：https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV12Y411x7zXopen in new window角色： 订单模块，后端开发工程师。# 课程内容完成订单结算页渲染完成用户下单实现完成库存变更实现# 1 订单结算页image-20211205120105277# 1.1 收件地址分析1展示 打开前台 order.htmlimage-20">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211205120105277-7d63c456.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211205115918039-116ade03.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211205120007359-1be8e26e.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211205121817519-09881489.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211205120105277-7d63c456.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206091251118-74887e4a.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206091646934-6c1ed852.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206091746759-f00abe96.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206114046064-3cc7aec8.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206121803107-65dbc923.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206121803107-65dbc923.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206143109177-1a498af3.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206143122426-df5ec577.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206152606093-8f79cdb1.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206152627024-ef696722.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206152646505-8b258555.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206152654362-19689c7c.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206152743660-153c1b1c.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206152848108-da521fd6.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206152906228-365a41ac.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206152831101-841c5709.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206152957078-0326cc88.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206153405594-e0f5b3d8.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206153523449-50edd4d3.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206153555752-139fc0c1.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206153608375-f541562e.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206153617157-5d8b78ff.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208154640726-4a32708f.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208155006738-ad786167.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208155238640-0eef8867.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208155459473-57c38c24.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208155810435-43b06256.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/9-20-09b36db7.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208164142661-dd6b05f3.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208164958537-41a40344.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/9-21-4def4d23.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/9-22-897f91db.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/9-23-1673d5cf.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/9-24-1513dc77.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/9-25-dd2eaa94.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/9-14-1a6e6c96.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208174923396-2412462d.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208180127771-6e94911f.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/9-16-7fb4fb35.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208221414338-a08cee39.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200304154454364-b860d95e.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209000033506-c324735a.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209000144424-e15a585c.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209000404624-d97345d0.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001159153-6bf084e1.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001206890-ab28a1d3.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001242965-52894bc4.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001233900-dc70a307.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001252770-1eb805bc.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001159153-6bf084e1.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001206890-ab28a1d3.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001328489-52ca7c07.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001403817-97cc1736.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001555985-643dfe75.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001721316-38d5d8e1.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001737111-f8df4cdb.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001813785-c968a192.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001946242-ef4fae3f.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209011831937-a99b3a5d.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209012241987-10f3aeca.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209012312800-ac75811f.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209012706482-2e5c4330.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209012742948-cad23f23.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209014056551-aab52bfa.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209021057873-d9d4537d.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209025157447-875bd352.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209031308844-2811c4fc.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209031315436-18d67ccf.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209031335319-40546e9b.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209031344811-26114b41.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209031259362-016343a5.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208174923396-2412462d.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208180127771-6e94911f.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208221414338-a08cee39.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209011831937-a99b3a5d.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/6rWmFZoS.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211215175333830-b1e5218d.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211215175246842-329dfb39.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221110506739-ccd04c86.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221114601627-e567585a.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221114628720-ea35e002.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221114637493-2fe67dc8.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221144256113-e80b69c9.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221150107575-b9d3c8e2.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221151905932-a25f40c9.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221152256881-6a50d8de.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221154450109-0d8fe381.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221162207178-7d37ab54.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221162214876-3626ccaa.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221200858087-5edd9c41.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221203416360-61d74041.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221204125489-5f8703f8.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/x4cl3YeZ.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221205320127-d3014723.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221205424476-a7e3fbf7.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221205450080-c69f4636.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221205221905-f5d79981.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221205221905-f5d79981.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221232224662-b901e7ea.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221232328432-ed3fc658.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221235105274-6db9cee5.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221235203111-b2b94980.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222001359665-5c78ed50.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/R1OAAAAA.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221235940049-37e099e7.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200305012941294-3c13dd66.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200305015926052-167e538f.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/wP4kBM5a.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200305020047787-0115833e.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200305015219298-084b4177.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222001437864-e80a71e6.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222003719250-574a7d55.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222003728955-4ad46170.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/10-5-adc33b76.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200305023436779-f59f618b.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200305023655720-57f7c2cb.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200305023810038-3d7f2413.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/GHQAAAAB.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200305024558360-e35417d3.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/AQ14qUdU.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/nhAAAAAE.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200305024852480-ea9a3885.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222005732519-a1963786.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200305025600949-da1a31f6.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222012152665-81c35747.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222012132026-ccd25173.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222012123305-a8281baf.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222012108075-e6e3776e.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200306075452263-a700224f.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200306075534030-6667d3b8.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/13-3-9801a07a.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200306075942810-3fedba8a.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222013147811-6fc7baa2.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200423120048804-8b52dc0a.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222014108729-e4521203.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221144256113-e80b69c9.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221203416360-61d74041.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221235105274-6db9cee5.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222013147811-6fc7baa2.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222014807522-f05b12ce.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227105923204-9990ae46.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227111258327-ccd7a72a.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227111214185-813f14aa.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227111247704-898b8747.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227113439128-8d798b5d.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227114511089-80618cbc.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227115532726-7aca5071.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227121318859-ad46fa80.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227170736337-59939cf9.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/4PQZVWqz.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227173827318-03d9a628.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227180923988-743ab9cb.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227184231554-8ffec52a.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227195336675-340959bb.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227200800397-029ab2a6.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227113439128-8d798b5d.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227173827318-03d9a628.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227184231554-8ffec52a.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227221818494-8ebee597.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227221948208-fc0ab4b4.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227222002467-e63d1cd6.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/1578267434606-d0a51b91.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228160425046-fa761d21.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228161100576-817ff531.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228162810677-a4fbb12f.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228171058257-0677530e.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228171813908-6e66583f.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227224705978-2b56d226.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228180524421-d1c0979e.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228180537463-722f9d9d.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228181401546-345566b4.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227224737382-409ca1b9.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228181433725-37340631.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228181441279-fab14fd1.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228181821971-e398a676.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228183316377-9385b4e4.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228183457892-72e70fbf.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228184523710-39f0d525.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228220700312-51c6c1f3.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227225123244-a6b4bd7b.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228221742713-c804fc90.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228233511074-5642d26d.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228233617374-a6178690.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228222758434-8465bb69.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228233649926-2b77aac3.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228223420084-224a7a1f.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228233710801-d1626944.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228223724484-7663f5b3.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228233749415-e772a6da.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228224140244-15daa036.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228224817607-0818abad.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228224907652-9b80f640.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/w7S6Sn35.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200310181130832-b7ad38fc.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228233810290-2e074c3a.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228233831720-d51ed71c.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228232748991-0450b613.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228235033816-c450b648.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/AAAAAElF.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228160425046-fa761d21.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228235345701-9bfef3d0.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102104824795-0202d8c0.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102115218841-29301bad.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102115503524-416a3769.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102121935545-f2a178a8.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102122324659-08477586.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102172807666-221fc969.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102174038302-d741825a.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102175146418-9c7a01b4.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102175205923-5f2f320e.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102180304161-ea2c6fb5.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102180334328-9edf9ec6.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102180355716-3b529d86.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102183240326-2c17e172.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102183257423-337a507e.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102183310057-583b8381.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102191752824-887214db.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103094738284-38962074.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103100123839-ca9d552f.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103100219129-96d23b1d.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/LV5VGiZT.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103101928814-908ea721.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103102444911-d2a2be49.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103102806192-aefb2901.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103111001121-b3235ca9.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103112122408-25328d6b.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103114529621-70063599.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103114547263-8affaa09.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103114754530-a5482486.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103153812440-ff015957.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103165242789-9ed396eb.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103165527365-ac106a3b.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103165641227-970bbdbf.png">
<meta property="og:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103170003264-851d4508.png">
<meta property="article:published_time" content="2023-12-16T19:23:33.194Z">
<meta property="article:modified_time" content="2023-12-16T19:23:33.194Z">
<meta property="article:author" content="钟意">
<meta property="article:tag" content="那个码农">
<meta property="article:tag" content="码农钟意">
<meta property="article:tag" content="钟意的博客">
<meta property="article:tag" content="钟意博客">
<meta property="article:tag" content="That Coder">
<meta property="article:tag" content="thatcoder">
<meta property="article:tag" content="源柒拾柒雅舍">
<meta property="article:tag" content="源WebGary">
<meta property="article:tag" content="giligili.work">
<meta property="article:tag" content="seclusion.work">
<meta property="article:tag" content="GalGame">
<meta property="article:tag" content="Hexo Stellar">
<meta property="article:tag" content="江西木村拓哉">
<meta property="article:tag" content="江西吴彦祖">
<meta property="article:tag" content="江西胡歌">
<meta property="article:tag" content="龙南木村拓哉">
<meta property="article:tag" content="龙南吴彦祖">
<meta property="article:tag" content="龙南胡歌">
<meta property="article:tag" content="九江职业技术学院">
<meta property="article:tag" content="南昌交通学院">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211205120105277-7d63c456.png">
  
  
  
  <meta name="keywords" content="那个码农,码农钟意,钟意的博客,钟意博客,That Coder,thatcoder,源柒拾柒雅舍,源WebGary,giligili.work,seclusion.work,GalGame,Hexo Stellar,江西木村拓哉,江西吴彦祖,江西胡歌,龙南木村拓哉,龙南吴彦祖,龙南胡歌,九江职业技术学院,南昌交通学院">

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="那个码农" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/main.css?v=1.28.1">

  
    <link rel="shortcut icon" href="https://upyun.thatcdn.cn/hexo/stellar/image/favicon.webp">
  

  
    
<link rel="stylesheet" href="/custom/css/ZYCode.css">

  

  <link rel="Shortcut Icon" href="/favicon.ico" type="image/x-icon" /><link rel="stylesheet" href="https://upyun.thatcdn.cn/public/font/lxgw/result.css" /><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.5.1/css/all.min.css"><link rel="stylesheet" href="/custom/css/ZYTimetmpl.css" /><meta itemprop="name" content="钟意博客"><meta itemprop="description" content="笔名钟意, 记录代码与生活."><meta itemprop="image" content="https://upyun.thatcdn.cn/hexo/stellar/image/shot.webp"><link rel="stylesheet" href="/custom/css/ZYGlobal.css"><link rel="stylesheet" href="/custom/css/ZYWaline.css"><link rel="stylesheet" href="/custom/css/ZYPage.css"><script type="text/javascript" src="/custom/js/header.js"></script><!-- Clarity tracking code for https://blog.thatcoder.cn/ -->
<script>    (function(c,l,a,r,i,t,y){        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i+"?ref=bwt";        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);    })(window, document, "clarity", "script", "fi1zg7i5q5");</script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-H6GM3XZWV7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-H6GM3XZWV7');
</script>
<!-- BaiDu-ZhanZhang
<meta name="baidu-site-verification" content="codeva-8tnFVr706d" />
<!-- BaiDu-Tongji -->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?233765a020502d5d6a92d4fe306d36c2";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</head>
<body>



<div class="l_body s:aa content tech " id="start" layout="wiki" ><aside class="l_left"><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><div class="icon"><img no-lazy class="icon" src="/custom/img/ydl.png" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></div><a class="title" href="/wiki/YDLDoc4/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93.html"><div class="main" ff="title">YDLDoc4</div><div class="sub normal cap">关于YDLDoc的笔记</div><div class="sub hover cap" style="opacity:0"> 不对之处请指出</div></a></div></header>

<div class="nav-area">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" data-filter="/wiki/YDLDoc4/" placeholder="在 YDLDoc4 中搜索"></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div>


<nav class="menu dis-select"><a class="nav-item" title="博客" href="/"><span>博客</span></a><a class="nav-item active" title="笔记" href="/wiki/"><span>笔记</span></a><a class="nav-item" title="便签" href="/notes/"><span>便签</span></a><a class="nav-item" title="社交" href="/links/"><span>社交</span></a></nav>
</div>
<div class="widgets">

<widget class="widget-wrapper post-list"><div class="widget-body fs14"><a class="link" href="/wiki/YDLDoc4/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93.html#start"><span class="toc-text">短信通道</span></a><a class="link" href="/wiki/YDLDoc4/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E5%B7%A5%E4%BD%9C%E6%B5%81/%E5%B7%A5%E4%BD%9C%E6%B5%81.html"><span class="toc-text">工作流</span></a><a class="link" href="/wiki/YDLDoc4/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA.html"><span class="toc-text">自动化构建</span></a><a class="link active" href="/wiki/YDLDoc4/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93.html"><span class="toc-text">二奢交易</span><svg class="active-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M21 11.098v4.993c0 3.096 0 4.645-.734 5.321c-.35.323-.792.526-1.263.58c-.987.113-2.14-.907-4.445-2.946c-1.02-.901-1.529-1.352-2.118-1.47a2.225 2.225 0 0 0-.88 0c-.59.118-1.099.569-2.118 1.47c-2.305 2.039-3.458 3.059-4.445 2.945a2.238 2.238 0 0 1-1.263-.579C3 20.736 3 19.188 3 16.091v-4.994C3 6.81 3 4.666 4.318 3.333C5.636 2 7.758 2 12 2c4.243 0 6.364 0 7.682 1.332C21 4.665 21 6.81 21 11.098" opacity=".5"/><path fill="currentColor" d="M9 5.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5z"/></svg></a></div></widget>

<widget class="widget-wrapper post-card"><div class="widget-header dis-select"><span class="name">更多：开发</span></div><div class="widget-body"><a class="item wiki" href="/wiki/YDLDoc1/javase/IO%E6%B5%81/IO%E6%B5%81.html"><span class="title">元动力摘录 - JAVA阶段一</span><span class="excerpt">钟意关于YDLDoc的笔记</span></a><a class="item wiki" href="/wiki/YDLDoc2/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/maven%E5%85%A5%E9%97%A8/maven%E5%85%A5%E9%97%A8.html"><span class="title">元动力摘录 - JAVA阶段二</span><span class="excerpt">钟意关于YDLDoc的笔记</span></a><a class="item wiki" href="/wiki/YDLDoc3/ELK%E5%85%A5%E9%97%A8/elk%E5%85%A5%E9%97%A8/elk%E5%85%A5%E9%97%A8.html"><span class="title">元动力摘录 - JAVA阶段三</span><span class="excerpt">钟意关于YDLDoc的笔记</span></a><a class="item wiki" href="/wiki/YuDaoCloud/%E5%89%8D%E7%AB%AF%E6%89%8B%E5%86%8C%20Vue%202/%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83/%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83.html"><span class="title">艿艿若依Cloud - 开发指南</span><span class="excerpt">关于艿艿若依Cloud的文档</span></a><a class="item wiki" href="/wiki/Laf/start/start.html"><span class="title">Laf - 开箱即用的 serverless</span><span class="excerpt">钟意关于Laf的笔记</span></a><a class="item wiki" href="/wiki/YuDaoBoot/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%89%8B%E5%86%8C/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%8E%A5%E5%85%A5/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%8E%A5%E5%85%A5.html"><span class="title">艿艿若依Boot - 开发指南</span><span class="excerpt">关于艿艿若依Boot的文档</span></a><a class="item wiki" href="/wiki/MySql/basics/select.html"><span class="title">MySql - 关系型数据库管理系统</span><span class="excerpt">钟意关于关系型数据库MySql的笔记</span></a><a class="item wiki" href="/wiki/SpringCloud/start.html"><span class="title">SpringCloud - JAVA系分布式微服务架构</span><span class="excerpt">钟意关于SpringCloud的笔记</span></a></div></widget>

<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">最近更新</span></div><div class="widget-body fs14"><a class="item title" href="/share/game/%E5%B0%8F%E5%B0%8F%E6%A2%A6%E9%AD%87.html"><span class="title"><strong>share</strong><span class="dot"></span>小小梦魇</span></a><a class="item title" href="/share/code/start-sky.html"><span class="title"><strong>share</strong><span class="dot"></span>Clash</span></a><a class="item title" href="/notes/"><span class="title"><strong>便签</strong><span class="dot"></span>钟意的便签</span></a><a class="item title" href="/notes/develop/"><span class="title"><strong>开发速查</strong><span class="dot"></span>开发助手</span></a><a class="item title" href="/notes/follow/stellar.html"><span class="title"><strong>便签</strong><span class="dot"></span>Stellar提交记录</span></a><a class="item title" href="/notes/develop/linux/ubuntu.html"><span class="title"><strong>开发速查</strong><span class="dot"></span>Ubuntu命令</span></a></div></widget>
</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" style="grid-column: span 3;height:32px;padding: 0;" href="https://space.bilibili.com/1664687779" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" height="32px" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/bilibili-banner.jpg"/></a><a class="social" style="grid-column: span 3;height:32px;padding: 0;" href="https://muselink.cc/naive" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" height="32px" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/wechat-banner.jpg"/></a><a class="social" style="grid-column: span 3;height:32px;padding: 0;" href="https://github.com/ThatCoders" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" height="32px" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/github-banner.jpg"/></a><a class="social" href="javascript:ThemeChange('dark');" rel="noopener noreferrer"><img class="lazy" id="ThemeM" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/Moon.png"/></a><a class="social" href="javascript:ThemeChange('light');" rel="noopener noreferrer"><img class="lazy" id="ThemeL" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/Sun.png"/></a><a class="social" href="javascript:ThemeChange('auto');" rel="noopener noreferrer"><img class="lazy" id="ThemeAI" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/AI.png"/></a></div></footer>
</div></aside><div class="l_main" id="main">





<div class="article banner top">
    <div class="content">
      <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a>
<span class="sep"></span><a class="cap breadcrumb" id="menu" href="/wiki">文档</a><span class="sep"></span><a class="cap breadcrumb" id="proj" href="/wiki/YDLDoc4/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93.html">YDLDoc4</a></div>
<div class="flex-row" id="post-meta"><span class="text created">更新于：<time datetime="2023-12-16T19:23:33.194Z">2023-12-17</time></span></div></div></div>
      
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>二奢交易</span></h1>
        
      </div>
    </div>
    
    </div>
    </div><article class="md-text content"><div class="theme-hope-content"><h1 id="第11章-订单" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第11章-订单">#</a> 第11章 订单</h1><div class="hint-container tip"><p class="hint-container-title">提示</p><p>课程视频教程链接：<a href="https://www.bilibili.com/video/BV12Y411x7zX" rel="noopener noreferrer" target="_blank">https://www.bilibili.com/video/BV12Y411x7zX<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><p><strong>角色</strong>： 订单模块，后端开发工程师。</p><h2 id="课程内容" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#课程内容">#</a> 课程内容</h2><ol><li><p>完成订单结算页渲染</p></li><li><p>完成用户下单实现</p></li><li><p>完成库存变更实现</p></li></ol><h2 id="_1-订单结算页" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-订单结算页">#</a> 1 订单结算页</h2><figure><img class="lazy" alt="image-20211205120105277" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211205120105277-7d63c456.png" tabindex="0"/><figcaption>image-20211205120105277</figcaption></figure><h3 id="_1-1-收件地址分析" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-1-收件地址分析">#</a> 1.1 收件地址分析</h3><p>1展示 打开前台 order.html</p><figure><img class="lazy" alt="image-20211205115918039" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211205115918039-116ade03.png" tabindex="0"/><figcaption>image-20211205115918039</figcaption></figure><p>收件地址分析 td_address表。表结构分析：</p><figure><img class="lazy" alt="image-20211205120007359" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211205120007359-1be8e26e.png" tabindex="0"/><figcaption>image-20211205120007359</figcaption></figure><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `tb_address` (<br>    `id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>    `username` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;用户名&#x27;</span>,<br>    `provinceid` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;省&#x27;</span>,<br>    `cityid` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;市&#x27;</span>,<br>    `areaid` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;县/区&#x27;</span>,<br>    `phone` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;电话&#x27;</span>,<br>    `address` <span class="hljs-type">varchar</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;详细地址&#x27;</span>,<br>    `contact` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;联系人&#x27;</span>,<br>    `is_default` <span class="hljs-type">varchar</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;是否是默认 1默认 0否&#x27;</span>,<br>    `alias` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;别名&#x27;</span>,<br>    <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">66</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们可以根据用户登录名去tb_address表中查询对应的数据。</p><h3 id="_1-2-实现用户收件地址查询" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-2-实现用户收件地址查询">#</a> 1.2 实现用户收件地址查询</h3><h4 id="_1-2-1-代码实现-ydles-service-user" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-2-1-代码实现-ydles-service-user">#</a> 1.2.1 代码实现 ydles-service-user</h4><p>1需改com.ydles.user.service.AddressService接口，添加根据用户名字查询用户收件地址信息，代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//根据username 查询</span><br><span class="hljs-keyword">public</span> List&amp;lt;Address&amp;gt; list(String username);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>2业务层接口实现类</p><p>修改com.ydles.user.service.impl.AddressServiceImpl类，添加根据用户查询用户收件地址信息实现方法，如下代码：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> List&amp;lt;Address&amp;gt; list(String username) &#123;<br>    Address address=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Address</span>();<br>    address.setUsername(username);<br><br>    List&amp;lt;Address&amp;gt; addressList = addressMapper.select(address);<br><br>    <span class="hljs-keyword">return</span> addressList;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3控制层</p><p>修改com.ydles.user.controller.AddressController，添加根据用户名查询用户收件信息方法，代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br>TokenDecode tokenDecode;<br><br><span class="hljs-comment">//根据username 查询 lsit&amp;lt;Address&amp;gt;</span><br><span class="hljs-meta">@GetMapping(&quot;/list&quot;)</span><br><span class="hljs-keyword">public</span> List&amp;lt;Address&amp;gt; list()&#123;<br>    <span class="hljs-comment">//当前登录人</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> tokenDecode.getUserInfo().get(<span class="hljs-string">&quot;username&quot;</span>);<br><br>    List&amp;lt;Address&amp;gt; addressList = addressService.list(username);<br><br>    <span class="hljs-keyword">return</span> addressList;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4创建TokenDecode</p><p>com.ydles.UserApplication中创建TokenDecode,代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> TokenDecode <span class="hljs-title function_">tokenDecode</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">TokenDecode</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试：通过网关访问，修改网关配置信息</p><div class="language-yaml line-numbers-mode" data-ext="yml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight yaml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">routes:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">ydles_goods_route</span><br>    <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://goods</span><br>    <span class="hljs-attr">predicates:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/album/**,/api/brand/**,/api/cache/**,/api/categoryBrand/**,/api/category/**,/api/para/**,/api/pref/**,/api/sku/**,/api/spec/**,/api/spu/**,/api/stockBack/**,/api/template/**</span><br>    <span class="hljs-attr">filters:</span><br>      <span class="hljs-comment">#- PrefixPath=/brand</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br>    <span class="hljs-comment">#用户微服务</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">ydles_user_route</span><br>    <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://user</span><br>    <span class="hljs-attr">predicates:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/user/**,/api/address/**,/api/areas/**,/api/cities/**,/api/provinces/**</span><br>    <span class="hljs-attr">filters:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br>    <span class="hljs-comment">#认证微服务</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">ydles_oauth_user</span><br>    <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://user-auth</span><br>    <span class="hljs-attr">predicates:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/oauth/**</span><br>    <span class="hljs-attr">filters:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br>  <span class="hljs-comment">#订单微服务</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">ydles_order_route</span><br>    <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://order</span><br>    <span class="hljs-attr">predicates:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/cart/**,/api/categoryReport/**,/api/orderConfig/**,/api/order/**,/api/orderItem/**,/api/orderLog/**,/api/preferential/**,/api/returnCause/**,/api/returnOrder/**,/api/returnOrderItem/**</span><br>    <span class="hljs-attr">filters:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br>  <span class="hljs-comment">#购物车订单渲染微服务</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">ydles_order_web_route</span><br>    <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://order-web</span><br>    <span class="hljs-attr">predicates:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/wcart/**,/api/worder/**</span><br>    <span class="hljs-attr">filters:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>先登录 Postman访问 <a href="http://localhost:8001/api/oauth/login" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/oauth/login<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>再请求数据 Postman访问 <a href="http://localhost:8001/api/address/list" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/address/list<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img class="lazy" alt="image-20211205121817519" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211205121817519-09881489.png" tabindex="0"/><figcaption>image-20211205121817519</figcaption></figure><h3 id="_1-3-页面模板渲染" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-3-页面模板渲染">#</a> 1.3 页面模板渲染</h3><figure><img class="lazy" alt="image-20211205120105277" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211205120105277-7d63c456.png" tabindex="0"/><figcaption>image-20211205120105277</figcaption></figure><p>购物车这块也使用的是模板渲染，用户先请求经过微服务网关，微服务网关转发到订单购物车模板渲染服务，模板渲染服务条用用户微服务和订单购物车微服务查询用户收件地址和购物车清单，然后到页面显示。</p><h4 id="_1-3-1-准备工作" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-3-1-准备工作">#</a> 1.3.1 准备工作</h4><p>(1)静态资源导入</p><p>将资料中的<code>order.html</code>拷贝到<code>ydles-web-order</code>工程的templates中。</p><figure><img class="lazy" alt="image-20211206091251118" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206091251118-74887e4a.png" tabindex="0"/><figcaption>image-20211206091251118</figcaption></figure><p>(2)页面跳转实现</p><p>在ydles-web-order中创建<code>com.ydles.order.controller.OrderController</code>实现页面跳转，代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/worder&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> &#123;<br>    <span class="hljs-meta">@RequestMapping(&quot;/ready/order&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">readyOrder</span><span class="hljs-params">(Model model)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;order&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(3)网关配置</p><p>修改ydles-gateway-web的application.yml文件，将订单的路由过滤地址添加上去，代码如下：</p><figure><img class="lazy" alt="image-20211206091646934" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206091646934-6c1ed852.png" tabindex="0"/><figcaption>image-20211206091646934</figcaption></figure><div class="language-yaml line-numbers-mode" data-ext="yml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight yaml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#购物车订单渲染微服务</span><br> <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">ydles_order_web_route</span><br>   <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://order-web</span><br>   <span class="hljs-attr">predicates:</span><br>     <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/wcart/**,/api/worder/**</span><br>   <span class="hljs-attr">filters:</span><br>     <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>同时不要忘了把该地址添加到登录过滤地址中，修改<code>com.ydles.filter.URLFilter</code>，在orderFilterPath里添加<code>/api/worder/**</code>过滤，代码如下：</p><figure><img class="lazy" alt="image-20211206091746759" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206091746759-f00abe96.png" tabindex="0"/><figcaption>image-20211206091746759</figcaption></figure><h4 id="_1-3-2-信息查询-重点" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-3-2-信息查询-重点">#</a> 1.3.2 信息查询-重点</h4><p>需求：</p><p>因为一会儿要调用ydles-service-user查询用户的收件地址信息，调用ydles-service-order查询购物车清单信息，所以我们需要创建Feign。购物车的Feign之前已经创建过了，所以只需要创建用户地址相关的即可。</p><p>(1)用户地址信息查询</p><p>在ydles-service-user-api中创建AddressFeign，代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name=&quot;user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AddressFeign</span> &#123;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 查询用户的收件地址信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(value = &quot;/list&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&amp;lt;List&amp;lt;Address&amp;gt;&amp;gt; list();<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(2) ydles_web_order项目启动类OrderWebApplication加入调用的feign包</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.ydles<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>ydles_service_user_api<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>1.0-SNAPSHOT<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaClient</span><br><span class="hljs-meta">@EnableFeignClients(basePackages = &#123;&quot;com.ydles.order.feign&quot;,&quot;com.ydles.user.feign&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderWebApplication</span> &#123;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(3)查询购物车和用户收件地址信息</p><p>修改ydles-web-order中的<code>com.ydles.order.controller.OrderController</code>的readyOrder方法，在该方法中，使用feign调用查询收件地址信息和用户购物车信息，代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/worder&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AddressFeign addressFeign;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CartFeign cartFeign;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/ready/order&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">readyOrder</span><span class="hljs-params">(Model model)</span> &#123;<br>         <span class="hljs-comment">//1收件人的地址信息</span><br>        List&amp;lt;Address&amp;gt; addressList = addressFeign.list().getData();<br>        model.addAttribute(<span class="hljs-string">&quot;address&quot;</span>,addressList);<br><br>        <span class="hljs-comment">//2购物车信息</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> cartFeign.list();<br>        List&amp;lt;OrderItem&amp;gt; orderItemList = (List&amp;lt;OrderItem&amp;gt;) map.get(<span class="hljs-string">&quot;orderItemList&quot;</span>);<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">totalMoney</span> <span class="hljs-operator">=</span> (Integer) map.get(<span class="hljs-string">&quot;totalMoney&quot;</span>);<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">totalNum</span> <span class="hljs-operator">=</span> (Integer) map.get(<span class="hljs-string">&quot;totalNum&quot;</span>);<br><br>        model.addAttribute(<span class="hljs-string">&quot;carts&quot;</span>,orderItemList);<br>        model.addAttribute(<span class="hljs-string">&quot;totalMoney&quot;</span>,totalMoney);<br>        model.addAttribute(<span class="hljs-string">&quot;totalNum&quot;</span>,totalNum);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;order&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(3)数据回显-了解</p><p>修改order.html，与静态原型中的order.html打开对比。</p><div class="language-html line-numbers-mode" data-ext="html"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight html"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-symbol">&amp;lt;</span>html xmlns:th=&quot;http://www.thymeleaf.org&quot;<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><div class="language-html line-numbers-mode" data-ext="html"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight html"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-symbol">&amp;lt;</span>div class=&quot;cart py-container&quot; id=&quot;app&quot;<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><div class="language-html line-numbers-mode" data-ext="html"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight html"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-symbol">&amp;lt;</span>div class=&quot;choose-address&quot; th:each=&quot;addr:$&#123;address&#125;&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>div class=&quot;con name &quot; th:@click=&quot;|chooseAddr(&#x27;$&#123;addr.contact&#125;&#x27;,&#x27;$&#123;addr.phone&#125;&#x27;,&#x27;$&#123;addr.address&#125;&#x27;)|&quot; th:classappend=&quot;$&#123;addr.isDefault&#125;==1?&#x27;selected&#x27;:&#x27;&#x27;&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>a href=&quot;javascript:;&quot; <span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>em th:text=&quot;$&#123;addr.contact&#125;&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/em<span class="hljs-symbol">&amp;gt;</span> <span class="hljs-symbol">&amp;lt;</span>span title=&quot;点击取消选择&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/a<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>div class=&quot;con address&quot;<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>span class=&quot;place&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>em th:text=&quot;$&#123;addr.address&#125;&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/em<span class="hljs-symbol">&amp;gt;</span> <span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>span class=&quot;phone&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>em th:text=&quot;$&#123;addr.phone&#125;&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/em<span class="hljs-symbol">&amp;gt;</span> <span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>span class=&quot;base&quot; th:if=&quot;$&#123;addr.isDefault&#125;==1&quot;<span class="hljs-symbol">&amp;gt;</span>默认地址<span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>div class=&quot;clearfix&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-html line-numbers-mode" data-ext="html"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight html"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-symbol">&amp;lt;</span>ul class=&quot;payType&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>li class=&quot;selected&quot; th:@click=&quot;|order.payType=1|&quot;<span class="hljs-symbol">&amp;gt;</span>在线支付<span class="hljs-symbol">&amp;lt;</span>span title=&quot;点击取消选择&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/li<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>li th:@click=&quot;|order.payType=0|&quot;<span class="hljs-symbol">&amp;gt;</span>货到付款<span class="hljs-symbol">&amp;lt;</span>span title=&quot;点击取消选择&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/li<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/ul<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-html line-numbers-mode" data-ext="html"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight html"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-symbol">&amp;lt;</span>ul class=&quot;yui3-g&quot; th:each=&quot;cart,cartsList:$&#123;carts&#125;&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>li class=&quot;yui3-u-1-9&quot;<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>span<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>img th:src=&quot;$&#123;cart.image&#125;&quot;/<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/li<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>li class=&quot;yui3-u-5-12&quot;<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>div class=&quot;desc&quot; th:text=&quot;$&#123;cart.name&#125;&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>div class=&quot;seven&quot;<span class="hljs-symbol">&amp;gt;</span>7天无理由退货<span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/li<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>li class=&quot;yui3-u-1-12&quot;<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>div class=&quot;price&quot; th:text=&quot;$&#123;cart.price&#125;&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/li<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>li class=&quot;yui3-u-1-12&quot;<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>div class=&quot;num&quot; th:text=&quot;$&#123;cart.num&#125;&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/li<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>li class=&quot;yui3-u-1-12&quot;<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>div class=&quot;num&quot; th:text=&quot;$&#123;cart.num&#125;*$&#123;cart.price&#125;&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/li<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>li class=&quot;yui3-u-1-12&quot;<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>div class=&quot;exit&quot;<span class="hljs-symbol">&amp;gt;</span>有货<span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/li<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/ul<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-html line-numbers-mode" data-ext="html"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight html"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-symbol">&amp;lt;</span>div class=&quot;fc-receiverInfo&quot;<span class="hljs-symbol">&amp;gt;</span><br>    寄送至:<br>    <span class="hljs-symbol">&amp;lt;</span>span id=&quot;receive-address&quot;<span class="hljs-symbol">&amp;gt;</span>&#123;&#123;order.receiveAddress&#125;&#125;<span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><br>    收货人：<span class="hljs-symbol">&amp;lt;</span>span id=&quot;receive-name&quot;<span class="hljs-symbol">&amp;gt;</span>&#123;&#123;order.receiveContact&#125;&#125;<span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>span id=&quot;receive-phone&quot;<span class="hljs-symbol">&amp;gt;</span>&#123;&#123;order.receiveMobile&#125;&#125;<span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-html line-numbers-mode" data-ext="html"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight html"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-symbol">&amp;lt;</span>div class=&quot;list&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>span<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>i class=&quot;number&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>em th:text=&quot;$&#123;totalNum&#125;&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/em<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/i<span class="hljs-symbol">&amp;gt;</span>件商品，商品总金额<span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>em class=&quot;allprice&quot;<span class="hljs-symbol">&amp;gt;</span>¥<span class="hljs-symbol">&amp;lt;</span>em th:text=&quot;$&#123;totalMoney&#125;&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/em<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/em<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-html line-numbers-mode" data-ext="html"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight html"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-symbol">&amp;lt;</span>div class=&quot;clearfix trade&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>div class=&quot;fc-price&quot;<span class="hljs-symbol">&amp;gt;</span>应付金额:　<span class="hljs-symbol">&amp;lt;</span>span class=&quot;final-price&quot;<span class="hljs-symbol">&amp;gt;</span>¥<span class="hljs-symbol">&amp;lt;</span>em th:text=&quot;$&#123;totalMoney&#125;&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/em<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-html line-numbers-mode" data-ext="html"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight html"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-symbol">&amp;lt;</span>script th:inline=&quot;javascript&quot;<span class="hljs-symbol">&amp;gt;</span><br>    var app = new Vue(&#123;<br>        el:&quot;#app&quot;,<br>        data:&#123;<br>            order:&#123;<br>                &#x27;receiveContact&#x27;: [[$&#123;deAddr.contact&#125;]],<br>                &#x27;receiveMobile&#x27;: [[$&#123;deAddr.phone&#125;]],<br>        &#x27;receiveAddress&#x27;: [[$&#123;deAddr.address&#125;]],<br>        &#x27;payType&#x27;:1<br>    &#125;<br>    &#125;,<br>        methods:&#123;<br>            chooseAddr: function (contact,mobile,address)&#123;<br>                app.$set(app.order,&#x27;receiveContact&#x27;,contact);<br>                app.$set(app.order,&#x27;receiveMobile&#x27;,mobile);<br>                app.$set(app.order,&#x27;receiveAddress&#x27;,address);<br>            &#125;<br>        &#125;<br>    &#125;)<br><span class="hljs-symbol">&amp;lt;</span>/script<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试：先登录，再访问</p><p><a href="http://localhost:8001/api/worder/ready/order" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/worder/ready/order<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img class="lazy" alt="image-20211206114046064" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206114046064-3cc7aec8.png" tabindex="0"/><figcaption>image-20211206114046064</figcaption></figure><h4 id="_1-3-3-记录选中收件人-了解" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-3-3-记录选中收件人-了解">#</a> 1.3.3 记录选中收件人-了解</h4><p><strong>收件人动态展示</strong></p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">73 &amp;lt;div class=&quot;cart py-container&quot; id=&quot;app&quot;&amp;gt;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><div class="language-html line-numbers-mode" data-ext="html"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight html"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-symbol">&amp;lt;</span>script th:inline=&quot;javascript&quot;<span class="hljs-symbol">&amp;gt;</span><br>    var app = new Vue(&#123;<br>        el:&quot;#app&quot;,<br>        data:&#123;<br>            order:&#123;&#x27;receiveContact&#x27;:[[$&#123;deAddr.contact&#125;]],&#x27;receiveMobile&#x27;:[[$&#123;deAddr.phone&#125;]],&#x27;receiveAddress&#x27;:[[$&#123;deAddr.address&#125;]],&#x27;payType&#x27;:1&#125;<br>    &#125;,<br>        methods:&#123;<br>            chooseAddr:function (contact,mobile,address) &#123;<br>                app.$set(app.order,&#x27;receiveContact&#x27;,contact);<br>                app.$set(app.order,&#x27;receiveMobile&#x27;,mobile);<br>                app.$set(app.order,&#x27;receiveAddress&#x27;,address);<br>            &#125;,<br>                add:function () &#123;<br>                    axios.post(&#x27;/api/worder/add&#x27;,this.order).then(function (response) &#123;<br>                        if (response.data.flag)&#123;<br>                            //添加订单成功<br>                            alert(&quot;添加订单成功&quot;);<br>                        &#125; else&#123;<br>                            alert(&quot;添加订单失败&quot;);<br>                        &#125;<br>                    &#125;)<br>                &#125;<br>        &#125;<br>    &#125;)<br><span class="hljs-symbol">&amp;lt;</span>/script<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-html line-numbers-mode" data-ext="html"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight html"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-symbol">&amp;lt;</span>div class=&quot;clearfix trade&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>div class=&quot;fc-price&quot;<span class="hljs-symbol">&amp;gt;</span>应付金额:　<span class="hljs-symbol">&amp;lt;</span>span class=&quot;price&quot;<span class="hljs-symbol">&amp;gt;</span>¥<span class="hljs-symbol">&amp;lt;</span>em th:text=&quot;$&#123;totalMoney&#125;&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/em<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>div class=&quot;fc-receiverInfo&quot;<span class="hljs-symbol">&amp;gt;</span><br>        寄送至:<br>        <span class="hljs-symbol">&amp;lt;</span>span id=&quot;receive-address&quot;<span class="hljs-symbol">&amp;gt;</span>&#123;&#123;order.receiveAddress&#125;&#125;<span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><br>        收货人：<span class="hljs-symbol">&amp;lt;</span>span id=&quot;receive-name&quot;<span class="hljs-symbol">&amp;gt;</span>&#123;&#123;order.receiveContact&#125;&#125;<span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>span id=&quot;receive-phone&quot;<span class="hljs-symbol">&amp;gt;</span>&#123;&#123;order.receiveMobile&#125;&#125;<span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>后端设置默认收件人</strong></p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//默认收件人信息</span><br><span class="hljs-keyword">for</span> (Address address : addressList) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;1&quot;</span>.equals(address.getIsDefault()))&#123;<br>        <span class="hljs-comment">//默认收件人</span><br>        model.addAttribute(<span class="hljs-string">&quot;deAddr&quot;</span>,address);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>前端：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">order:&#123;&#x27;receiveContact&#x27;:[[$&#123;deAddr.contact&#125;]],&#x27;receiveMobile&#x27;:[[$&#123;deAddr.phone&#125;]],&#x27;receiveAddress&#x27;:[[$&#123;deAddr.address&#125;]],&#x27;payType&#x27;:1&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p><strong>支付方式</strong></p><div class="language-html line-numbers-mode" data-ext="html"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight html"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-symbol">&amp;lt;</span>div class=&quot;step-cont&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>ul class=&quot;payType&quot;<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>li class=&quot;selected&quot; th:@click=&quot;|order.payType=1|&quot;<span class="hljs-symbol">&amp;gt;</span>在线支付<span class="hljs-symbol">&amp;lt;</span>span title=&quot;点击取消选择&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/li<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>li th:@click=&quot;|order.payType=0|&quot;<span class="hljs-symbol">&amp;gt;</span>货到付款<span class="hljs-symbol">&amp;lt;</span>span title=&quot;点击取消选择&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/li<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/ul<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>购物车跳转结算页面</strong></p><p>cart.html</p><div class="language-html line-numbers-mode" data-ext="html"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight html"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-symbol">&amp;lt;</span>a class=&quot;sum-btn&quot; href=&quot;/api/worder/ready/order&quot; target=&quot;_blank&quot;<span class="hljs-symbol">&amp;gt;</span>结算<span class="hljs-symbol">&amp;lt;</span>/a<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><h2 id="_2-下单-重点" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-下单-重点">#</a> 2 下单-重点</h2><h3 id="_2-1-业务分析" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-1-业务分析">#</a> 2.1 业务分析</h3><p>点击提交订单的时候，会立即创建订单数据，创建订单数据会将数据存入到2张表中，分别是订单表和订单明细表，此处还需要修改商品对应的库存数量。</p><figure><img class="lazy" alt="image-20211206121803107" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206121803107-65dbc923.png" tabindex="0"/><figcaption>image-20211206121803107</figcaption></figure><p>订单表结构如下：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `tb_order` (<br>    `id` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;订单id&#x27;</span>,<br>    `total_num` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;数量合计&#x27;</span>,<br>    `total_money` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;金额合计&#x27;</span>,<br>    `pre_money` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;优惠金额&#x27;</span>,<br>    `post_fee` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;邮费&#x27;</span>,<br>    `pay_money` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;实付金额&#x27;</span>,<br>    `pay_type` <span class="hljs-type">varchar</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;支付类型，1、在线支付、0 货到付款&#x27;</span>,<br>    `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;订单创建时间&#x27;</span>,<br>    `update_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;订单更新时间&#x27;</span>,<br>    `pay_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;付款时间&#x27;</span>,<br>    `consign_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;发货时间&#x27;</span>,<br>    `end_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;交易完成时间&#x27;</span>,<br>    `close_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;交易关闭时间&#x27;</span>,<br>    `shipping_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;物流名称&#x27;</span>,<br>    `shipping_code` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;物流单号&#x27;</span>,<br>    `username` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;用户名称&#x27;</span>,<br>    `buyer_message` <span class="hljs-type">varchar</span>(<span class="hljs-number">1000</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;买家留言&#x27;</span>,<br>    `buyer_rate` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;是否评价&#x27;</span>,<br>    `receiver_contact` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;收货人&#x27;</span>,<br>    `receiver_mobile` <span class="hljs-type">varchar</span>(<span class="hljs-number">12</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;收货人手机&#x27;</span>,<br>    `receiver_address` <span class="hljs-type">varchar</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;收货人地址&#x27;</span>,<br>    `source_type` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;订单来源：1:web，2：app，3：微信公众号，4：微信小程序  5 H5手机页面&#x27;</span>,<br>    `transaction_id` <span class="hljs-type">varchar</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;交易流水号&#x27;</span>,<br>    `order_status` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;订单状态,0:未完成,1:已完成，2：已退货&#x27;</span>,<br>    `pay_status` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;支付状态,0:未支付，1：已支付，2：支付失败&#x27;</span>,<br>    `consign_status` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;发货状态,0:未发货，1：已发货，2：已收货&#x27;</span>,<br>    `is_delete` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;是否删除&#x27;</span>,<br>    <span class="hljs-keyword">PRIMARY</span> KEY (`id`),<br>    KEY `create_time` (`create_time`),<br>    KEY `status` (`order_status`),<br>    KEY `payment_type` (`pay_type`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8_bin;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>订单明细表结构如下：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `tb_order_item` (<br>    `id` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;ID&#x27;</span>,<br>    `category_id1` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;1级分类&#x27;</span>,<br>    `category_id2` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;2级分类&#x27;</span>,<br>    `category_id3` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;3级分类&#x27;</span>,<br>    `spu_id` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;SPU_ID&#x27;</span>,<br>    `sku_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;SKU_ID&#x27;</span>,<br>    `order_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;订单ID&#x27;</span>,<br>    `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;商品名称&#x27;</span>,<br>    `price` <span class="hljs-type">int</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;单价&#x27;</span>,<br>    `num` <span class="hljs-type">int</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;数量&#x27;</span>,<br>    `money` <span class="hljs-type">int</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;总金额&#x27;</span>,<br>    `pay_money` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;实付金额&#x27;</span>,<br>    `image` <span class="hljs-type">varchar</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;图片地址&#x27;</span>,<br>    `weight` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;重量&#x27;</span>,<br>    `post_fee` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;运费&#x27;</span>,<br>    `is_return` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;是否退货,0:未退货，1：已退货&#x27;</span>,<br>    <span class="hljs-keyword">PRIMARY</span> KEY (`id`),<br>    KEY `item_id` (`sku_id`),<br>    KEY `order_id` (`order_id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8_bin;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-下单实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-2-下单实现">#</a> 2.2 下单实现</h3><p>下单的时候，先往tb_order表中增加数据，再往tb_order_item表中增加数据。</p><h4 id="_2-2-1-代码实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-2-1-代码实现">#</a> 2.2.1 代码实现</h4><p>这里先修改ydles-service-order微服务，实现下单操作，这里会生成订单号，我们首先需要在启动类中创建一个IdWorker对象。</p><p>在<code>com.ydles.OrderApplication</code>中创建IdWorker，代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> IdWorker <span class="hljs-title function_">idWorker</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IdWorker</span>(workerId, datacenterId);<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(1)业务层</p><p>实现逻辑：</p><p>1）获取所有购物车</p><p>2）统计计算：总金额，总支付金额，总数量</p><p>3）填充订单数据并保存</p><p>4）获取每一个购物项保存到orderItem</p><p>5）删除购物车中数据</p><p>修改订单微服务添加com.ydles.order.service.impl.OrderServiceImpl,代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 下单</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> order</span><br><span class="hljs-comment">     * 缺啥补啥</span><br><span class="hljs-comment">     */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">add</span><span class="hljs-params">(Order order)</span>&#123;<br>    <span class="hljs-comment">//1 获取 购物车信息</span><br>    <span class="hljs-type">Map</span> <span class="hljs-variable">cartMap</span> <span class="hljs-operator">=</span> cartService.list(order.getUsername());<br>    <span class="hljs-comment">//map.put(&quot;orderItemList&quot;,orderItemList);</span><br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">totalNum</span> <span class="hljs-operator">=</span> (Integer) cartMap.get(<span class="hljs-string">&quot;totalNum&quot;</span>);<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">totalMoney</span> <span class="hljs-operator">=</span> (Integer) cartMap.get(<span class="hljs-string">&quot;totalMoney&quot;</span>);<br><br>    <span class="hljs-comment">//2 order表里存数据</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> idWorker.nextId()+<span class="hljs-string">&quot;&quot;</span>;<br>    order.setId(orderId);<br>    order.setTotalNum(totalNum);<br>    order.setTotalMoney(totalMoney);<br>    <span class="hljs-comment">//作业：优惠金额 怎么算      本店满50-5 跨店 300-50</span><br>    <span class="hljs-comment">//作业：邮费金额 怎么算</span><br>    order.setPayMoney(totalMoney);<br>    order.setCreateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    order.setUpdateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    <span class="hljs-comment">//作业：买家留言</span><br>    order.setBuyerRate(<span class="hljs-string">&quot;0&quot;</span>);<br>    order.setSourceType(<span class="hljs-string">&quot;1&quot;</span>);<br>    order.setOrderStatus(<span class="hljs-string">&quot;0&quot;</span>);<br>    order.setPayStatus(<span class="hljs-string">&quot;0&quot;</span>);<br>    order.setConsignStatus(<span class="hljs-string">&quot;0&quot;</span>);<br>    order.setIsDelete(<span class="hljs-string">&quot;0&quot;</span>);<br><br>    orderMapper.insertSelective(order);<br><br>    <span class="hljs-comment">//3 orderItem表里存数据</span><br>    List&amp;lt;OrderItem&amp;gt; orderItemList = (List&amp;lt;OrderItem&amp;gt;) cartMap.get(<span class="hljs-string">&quot;orderItemList&quot;</span>);<br>    <span class="hljs-keyword">for</span> (OrderItem orderItem : orderItemList) &#123;<br>        orderItem.setOrderId(orderId);<br>        orderItem.setPostFee(<span class="hljs-number">0</span>);<br>        orderItem.setIsReturn(<span class="hljs-string">&quot;0&quot;</span>);<br>        orderItemMapper.insertSelective(orderItem);<br>    &#125;<br><br>    <span class="hljs-comment">//4 删除购物车信息</span><br>    stringRedisTemplate.delete(CART+order.getUsername());<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(2)控制层</p><p>修改ydles-service-order微服务，修改com.ydles.order.controller.OrderController类，代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br>TokenDecode tokenDecode;<br><br><span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 下单</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> order</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br><span class="hljs-meta">@PostMapping</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Order order)</span>&#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> tokenDecode.getUserInfo().get(<span class="hljs-string">&quot;username&quot;</span>);<br>    order.setUsername(username);<br><br>    orderService.add(order);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>(<span class="hljs-literal">true</span>,StatusCode.OK,<span class="hljs-string">&quot;添加成功&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-2-渲染服务对接" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-2-2-渲染服务对接">#</a> 2.2.2 渲染服务对接</h4><figure><img class="lazy" alt="image-20211206142024505" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206121803107-65dbc923.png" tabindex="0"/><figcaption>image-20211206142024505</figcaption></figure><p>我们需要在模板渲染端调用订单微服务实现下单操作,下单操作需要调用订单微服务，所以需要创建对应的Feign。</p><p>(1)Feign创建</p><p>修改ydles-service-order-api，添加OrderFeign，代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name = &quot;order&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderFeign</span> &#123;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/order&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Order order)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(2)下单调用</p><p>修改ydles-web-order的<code>com.ydles.order.controller.OrderController</code>添加下单方法，代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> OrderFeign orderFeign;<br><br><span class="hljs-meta">@PostMapping(&quot;/add&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Order order)</span>&#123;<br>    <span class="hljs-type">Result</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> orderFeign.add(order);<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(3)页面调用</p><p>order.html</p><div class="language-javascript line-numbers-mode" data-ext="js"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight javascript"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-attr">add</span>:<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/api/worder/add&#x27;</span>,<span class="hljs-variable language_">this</span>.<span class="hljs-property">order</span>).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) &#123;<br>        <span class="hljs-keyword">if</span> (response.<span class="hljs-property">data</span>.<span class="hljs-property">flag</span>)&#123;<br>            <span class="hljs-comment">//添加订单成功</span><br>            <span class="hljs-title function_">alert</span>(<span class="hljs-string">&quot;添加订单成功&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-title function_">alert</span>(<span class="hljs-string">&quot;添加订单失败&quot;</span>);<br>        &#125;<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-html line-numbers-mode" data-ext="html"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight html"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-symbol">&amp;lt;</span>a class=&quot;sui-btn btn-danger btn-xlarge&quot; href=&quot;javascript:void(0)&quot; @click=&quot;add()&quot;<span class="hljs-symbol">&amp;gt;</span>提交订单<span class="hljs-symbol">&amp;lt;</span>/a<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>点击提交订单调用</p><p>保存订单测试，表数据变化如下：</p><p>tb_order表数据：</p><figure><img class="lazy" alt="image-20211206143109177" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206143109177-1a498af3.png" tabindex="0"/><figcaption>image-20211206143109177</figcaption></figure><p>tb_order_item表数据：</p><figure><img class="lazy" alt="image-20211206143122426" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206143122426-df5ec577.png" tabindex="0"/><figcaption>image-20211206143122426</figcaption></figure><h3 id="_2-3-库存变更" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-3-库存变更">#</a> 2.3 库存变更</h3><h4 id="_2-3-1-业务分析" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-3-1-业务分析">#</a> 2.3.1 业务分析</h4><p>上面操作只实现了下单操作，但对应的库存还没跟着一起减少，我们在下单之后，应该调用商品微服务，将下单的商品库存减少，销量增加。每次订单微服务只需要将用户名传到商品微服务，商品微服务通过用户名到Redis中查询对应的购物车数据，然后执行库存减少，库存减少需要控制当前商品库存&gt;=销售数量。</p><p>如何控制库存数量&gt;=购买数量呢？其实可以通过SQL语句实现，每次减少数量之前，加个条件判断。</p><p><code>where num&gt;=#&#123;num&#125;</code>即可。</p><p>商品服务需要查询购物车数据，所以需要引入订单的api，在pom.xml中添加如下依赖：</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>!--order api 依赖--<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.ydles<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>ydles_service_order_api<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>1.0-SNAPSHOT<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-2-代码实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-3-2-代码实现">#</a> 2.3.2 代码实现</h4><p>要调用其他微服务，需要将头文件中的令牌数据携带到其他微服务中取，所以我们不能使用hystrix的多线程模式，修改ydles-service-order的applicatin.yml配置，代码如下：</p><div class="language-properties line-numbers-mode" data-ext="properties"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight properties"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment">#hystrix 配置</span><br><span class="hljs-attr">hystrix</span>:<span class="hljs-string"></span><br>  <span class="hljs-attr">command</span>:<span class="hljs-string"></span><br>    <span class="hljs-attr">default</span>:<span class="hljs-string"></span><br>      <span class="hljs-attr">execution</span>:<span class="hljs-string"></span><br>        <span class="hljs-attr">isolation</span>:<span class="hljs-string"></span><br>          <span class="hljs-attr">thread</span>:<span class="hljs-string"></span><br>            <span class="hljs-attr">timeoutInMilliseconds</span>: <span class="hljs-string">10000</span><br>          <span class="hljs-attr">strategy</span>: <span class="hljs-string">SEMAPHORE</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>每次还需要使用拦截器添加头文件信息，添加拦截器，代码如下：</p><p>(1)Dao层</p><p>修改ydles-service-goods微服务的<code>com.ydles.goods.dao.SkuMapper</code>接口，增加库存递减方法,代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 递减库存</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> orderItem</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Update(&quot;UPDATE tb_sku SET num=num-#&#123;num&#125;,sale_num=sale_num+#&#123;num&#125; WHERE id=#&#123;skuId&#125; AND num&amp;gt;=#&#123;num&#125;&quot;)</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">decrCount</span><span class="hljs-params">(OrderItem orderItem)</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(2)业务层</p><p>修改ydles-service-goods微服务的<code>com.ydles.goods.service.SkuService</code>接口，添加如下方法：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 库存递减</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">decrCount</span><span class="hljs-params">(String username)</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改ydles-service-goods微服务的<code>com.ydles.goods.service.impl.SkuServiceImpl</code>实现类，添加一个实现方法，代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 库存递减</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">decrCount</span><span class="hljs-params">(String username)</span> &#123;<br>    <span class="hljs-comment">//获取购物车数据</span><br>    List&amp;lt;OrderItem&amp;gt; orderItems = redisTemplate.boundHashOps(<span class="hljs-string">&quot;Cart_&quot;</span> + username).values();<br><br>    <span class="hljs-comment">//循环递减</span><br>    <span class="hljs-keyword">for</span> (OrderItem orderItem : orderItems) &#123;<br>        <span class="hljs-comment">//递减库存</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> skuMapper.decrCount(orderItem);<br>        <span class="hljs-keyword">if</span>(count&amp;lt;=<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;库存不足，递减失败！&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(3)控制层</p><p>修改ydles-service-goods的<code>com.ydles.goods.controller.SkuController</code>类，添加库存递减方法，代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 库存递减</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@PostMapping(value = &quot;/decr/count&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">decrCount</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;username&quot;)</span> String username)</span>&#123;<br>    <span class="hljs-comment">//库存递减</span><br>    skuService.decrCount(username);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>(<span class="hljs-literal">true</span>,StatusCode.OK,<span class="hljs-string">&quot;库存递减成功！&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(4)创建feign</p><p>同时在ydles-service-goods-api工程添加<code>com.ydles.goods.feign.SkuFeign</code>的实现，代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 库存递减</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@PostMapping(value = &quot;/decr/count&quot;)</span><br>Result <span class="hljs-title function_">decrCount</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = &quot;username&quot;)</span> String username)</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-3-调用库存递减" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-3-3-调用库存递减">#</a> 2.3.3 调用库存递减</h4><p>需求：</p><p>ydles_service_order服务调用 ydles_service_goods服务, ydles_web_order服务的Application启动类</p><p>都需要添加下面拦截器</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> FeignInterceptor <span class="hljs-title function_">feignInterceptor</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FeignInterceptor</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ydles_service_goods加入配置信息</p><div class="language-yaml line-numbers-mode" data-ext="yml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight yaml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">goods</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.128</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>调用库存递减</strong></p><p>修改ydles-service-order微服务的com.ydles.order.service.impl.OrderServiceImpl类的add方法，增加库存递减的调用。</p><p>先注入SkuFeign</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> SkuFeign skuFeign;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>再调用库存递减方法</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//库存减库存</span><br>skuFeign.decrCount(order.getUsername());<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>完整代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 增加</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> order</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">add</span><span class="hljs-params">(Order order)</span>&#123;<br>    <span class="hljs-comment">//查询出用户的所有购物车</span><br>    <span class="hljs-type">Map</span> <span class="hljs-variable">orderItemMap</span> <span class="hljs-operator">=</span> cartService.list(order.getUsername());<br><br>    <span class="hljs-comment">//统计计算</span><br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">totalMoney</span> <span class="hljs-operator">=</span> Integer.parseInt(String.valueOf(orderItemMap.get(<span class="hljs-string">&quot;totalPrice&quot;</span>)));<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> Integer.parseInt(String.valueOf(orderItemMap.get(<span class="hljs-string">&quot;totalNum&quot;</span>)));<br><br>    <span class="hljs-comment">//购买商品数量</span><br>    order.setTotalNum(num);<br>    <span class="hljs-comment">//购买金额</span><br>    order.setTotalMoney(totalMoney);<br>    <span class="hljs-comment">//支付金额</span><br>    order.setPayMoney(totalMoney);<br>    <span class="hljs-comment">//优惠金额</span><br>    order.setPreMoney(totalMoney);<br><br>    <span class="hljs-comment">//其他数据完善</span><br>    order.setCreateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    order.setUpdateTime(order.getCreateTime());<br>    order.setBuyerRate(<span class="hljs-string">&quot;0&quot;</span>);        <span class="hljs-comment">//0:未评价，1：已评价</span><br>    order.setSourceType(<span class="hljs-string">&quot;1&quot;</span>);       <span class="hljs-comment">//来源，1：WEB</span><br>    order.setOrderStatus(<span class="hljs-string">&quot;0&quot;</span>);      <span class="hljs-comment">//0:未完成,1:已完成，2：已退货</span><br>    order.setPayStatus(<span class="hljs-string">&quot;0&quot;</span>);        <span class="hljs-comment">//0:未支付，1：已支付，2：支付失败</span><br>    order.setConsignStatus(<span class="hljs-string">&quot;0&quot;</span>);    <span class="hljs-comment">//0:未发货，1：已发货，2：已收货</span><br>    order.setId(idWorker.nextId());<br>    <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> orderMapper.insertSelective(order);<br><br>    <span class="hljs-comment">//保存待支付订单到redis中</span><br>    redisTemplate.boundValueOps(Constants.ORDER_PAY + order.getUsername()).set(order);<br><br>    <span class="hljs-comment">//添加订单明细</span><br>    List&amp;lt;OrderItem&amp;gt; orderItemList = (List&amp;lt;OrderItem&amp;gt;)orderItemMap.get(<span class="hljs-string">&quot;orderItemList&quot;</span>);<br>    <span class="hljs-keyword">for</span> (OrderItem orderItem : orderItemList) &#123;<br>        orderItem.setId(idWorker.nextId());<br>        orderItem.setIsReturn(<span class="hljs-string">&quot;0&quot;</span>);<br>        orderItem.setOrderId(order.getId());<br>        orderItemMapper.insertSelective(orderItem);<br>    &#125;<br><br>    <span class="hljs-comment">//扣减库存</span><br>    skuFeign.decrCount(order.getUsername());<br><br>    <span class="hljs-comment">//清除Redis缓存购物车数据</span><br>    redisTemplate.delete(<span class="hljs-string">&quot;Cart_&quot;</span>+order.getUsername());<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="测试" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#测试">#</a> 测试</h4><p>1购物车添加商品</p><p><a href="http://localhost:8001/api/wcart/add?skuId=1450862568724758528&amp;num=5" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/wcart/add?skuId=1450862568724758528&amp;num=5<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img class="lazy" alt="image-20211206152606093" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206152606093-8f79cdb1.png" tabindex="0"/><figcaption>image-20211206152606093</figcaption></figure><p>2查看购物车</p><p><a href="http://localhost:8001/api/wcart/list" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/wcart/list<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img class="lazy" alt="image-20211206152627024" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206152627024-ef696722.png" tabindex="0"/><figcaption>image-20211206152627024</figcaption></figure><p>3点击结算</p><figure><img class="lazy" alt="image-20211206152646505" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206152646505-8b258555.png" tabindex="0"/><figcaption>image-20211206152646505</figcaption></figure><figure><img class="lazy" alt="image-20211206152654362" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206152654362-19689c7c.png" tabindex="0"/><figcaption>image-20211206152654362</figcaption></figure><p>4点击提交订单</p><figure><img class="lazy" alt="image-20211206152743660" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206152743660-153c1b1c.png" tabindex="0"/><figcaption>image-20211206152743660</figcaption></figure><p>tb_order 有数据</p><figure><img class="lazy" alt="image-20211206152848108" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206152848108-da521fd6.png" tabindex="0"/><figcaption>image-20211206152848108</figcaption></figure><p>tb_order_item也有数据</p><figure><img class="lazy" alt="image-20211206152906228" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206152906228-365a41ac.png" tabindex="0"/><figcaption>image-20211206152906228</figcaption></figure><p>tb_sku表查看库存和销量是否更改</p><figure><img class="lazy" alt="image-20211206152831101" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206152831101-841c5709.png" tabindex="0"/><figcaption>image-20211206152831101</figcaption></figure><p>库存减少前，查询数据库Sku数据如下：95库存，5销量 库存94，销量6</p><figure><img class="lazy" alt="image-20211206152957078" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206152957078-0326cc88.png" tabindex="0"/><figcaption>image-20211206152957078</figcaption></figure><h3 id="_2-4-增加积分-学员练习" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-4-增加积分-学员练习">#</a> 2.4 增加积分(学员练习)</h3><p>tb_user表</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">`points` int(11) DEFAULT NULL COMMENT &#x27;积分&#x27;,<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>需求：</p><p>在增加订单的时候，同时添加用户积分。与减库存道理相同。</p><p>(1)dao层</p><p>修改ydles-service-user微服务的<code>com.ydles.user.dao.UserMapper</code>接口，增加用户积分方法，代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 增加用户积分</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pint</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Update(&quot;UPDATE tb_user SET points=points+#&#123;point&#125; WHERE  username=#&#123;username&#125;&quot;)</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">addUserPoints</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;username&quot;)</span> String username, <span class="hljs-meta">@Param(&quot;point&quot;)</span> Integer pint)</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(2)业务层</p><p>修改ydles-service-user微服务的<code>com.ydles.user.service.UserService</code>接口，代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 添加用户积分</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pint</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">addUserPoints</span><span class="hljs-params">(String username,Integer pint)</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改ydles-service-user微服务的<code>com.ydles.user.service.impl.UserServiceImpl</code>，增加添加积分方法实现，代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 修改用户积分</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pint</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">addUserPoints</span><span class="hljs-params">(String username, Integer pint)</span> &#123;<br>    <span class="hljs-keyword">return</span> userMapper.addUserPoints(username,pint);<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(3)控制层</p><p>修改ydles-service-user微服务的<code>com.ydles.user.controller.UserController</code>，添加增加用户积分方法，代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> TokenDecode tokenDecode;<br><br><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 增加用户积分</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> points:要添加的积分</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(value = &quot;/points/add&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">addPoints</span><span class="hljs-params">(Integer points)</span>&#123;<br>    <span class="hljs-comment">//获取用户名</span><br>    Map&amp;lt;String, String&amp;gt; userMap = tokenDecode.getUserInfo();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> userMap.get(<span class="hljs-string">&quot;username&quot;</span>);<br><br>    <span class="hljs-comment">//添加积分</span><br>    userService.addUserPoints(username,points);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>(<span class="hljs-literal">true</span>,StatusCode.OK,<span class="hljs-string">&quot;添加积分成功！&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(4)Feign添加</p><p>修改ydles-service-user-api工程，修改<code>com.ydles.user.feign.UserFeign</code>，添加增加用户积分方法，代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 添加用户积分</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> points</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(value = &quot;/points/add&quot;)</span><br>Result <span class="hljs-title function_">addPoints</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = &quot;points&quot;)</span>Integer points)</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-2-增加积分调用" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-4-2-增加积分调用">#</a> 4.4.2 增加积分调用</h4><p>修改ydles-service-order，添加ydles-service-user-api的依赖，修改pom.xml,添加如下依赖：</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>!--user api 依赖--<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.ydles<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>ydles-service-user-api<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>1.0-SNAPSHOT<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在加订单的时候，同时添加用户积分，修改ydles-service-order微服务的<code>com.ydles.order.service.impl.OrderServiceImpl</code>下单方法，增加调用添加积分方法</p><p>修改ydles-service-order的启动类<code>com.ydles.OrderApplication</code>，添加feign的包路径</p><p>总结：</p><p>1订单结算页</p><figure><img class="lazy" alt="image-20211206153405594" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206153405594-e0f5b3d8.png" tabindex="0"/><figcaption>image-20211206153405594</figcaption></figure><figure><img class="lazy" alt="image-20211206153523449" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206153523449-50edd4d3.png" tabindex="0"/><figcaption>image-20211206153523449</figcaption></figure><figure><img class="lazy" alt="image-20211206153555752" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206153555752-139fc0c1.png" tabindex="0"/><figcaption>image-20211206153555752</figcaption></figure><p>2下单</p><figure><img class="lazy" alt="image-20211206153608375" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206153608375-f541562e.png" tabindex="0"/><figcaption>image-20211206153608375</figcaption></figure><figure><img class="lazy" alt="image-20211206153617157" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211206153617157-5d8b78ff.png" tabindex="0"/><figcaption>image-20211206153617157</figcaption></figure><h1 id="第12章-分布式事务解决方案" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第12章-分布式事务解决方案">#</a> 第12章 分布式事务解决方案</h1><p><strong>角色</strong>：架构师</p><h2 id="学习目标" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#学习目标">#</a> 学习目标：</h2><ul><li>能够说出cap定理</li><li>能够说出BASE定理</li><li>能够说出常见的分布式事务解决方案</li><li>能够说出seata框架如何在项目中实现分布式事务</li></ul><h2 id="_1-分布式事务解决方案" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-分布式事务解决方案">#</a> 1.分布式事务解决方案</h2><p>​ 刚才我们编写的扣减库存与保存订单是在两个服务中存在的，如果扣减库存后订单保存失败了是不会回滚的，这样就会造成数据不一致的情况，这其实就是我们所说的分布式事务的问题，接下来我们来学习分布式事务的解决方案。</p><h3 id="_1-1-本地事务与分布式事务" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-1-本地事务与分布式事务">#</a> 1.1 本地事务与分布式事务</h3><h4 id="_1-1-1-事务" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-1-1-事务">#</a> 1.1.1 事务</h4><p>数据库事务(简称：事务，Transaction)是指数据库执行过程中的一个逻辑单位，由一个有限的数据库操作序列构成。</p><p>事务拥有以下<strong>四个特性</strong>，习惯上被称为<strong>ACID</strong>特性：</p><p><strong>原子性(Atomicity)</strong>：事务作为一个整体被执行，包含在其中的对数据库的操作要么全部被执行，要么都不执行。</p><p><strong>一致性(Consistency)</strong>：事务应确保数据库的状态从一个一致状态转变为另一个一致状态。一致状态是指数据库中的数据应满足完整性约束。除此之外，一致性还有另外一层语义，就是事务的中间状态不能被观察到(这层语义也有说应该属于原子性)。</p><p><strong>隔离性(Isolation)</strong>：多个事务并发执行时，一个事务的执行不应影响其他事务的执行，如同只有这一个操作在被数据库所执行一样。</p><p><strong>持久性(Durability)</strong>：已被提交的事务对数据库的修改应该永久保存在数据库中。在事务结束时，此操作将不可逆转。</p><figure><img class="lazy" alt="image-20211208154640726" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208154640726-4a32708f.png" tabindex="0"/><figcaption>image-20211208154640726</figcaption></figure><p>作业：隔离级别 传播机制</p><h4 id="_1-1-2-本地事务" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-1-2-本地事务">#</a> 1.1.2 本地事务</h4><p>起初，事务仅限于对单一数据库资源的访问控制,架构服务化以后，事务的概念延伸到了服务中。倘若将一个单一的服务操作作为一个事务，那么整个服务操作只能涉及一个单一的数据库资源,这类基于单个服务单一数据库资源访问的事务，被称为本地事务(Local Transaction)。</p><p>解决方案：@Transactional</p><figure><img class="lazy" alt="image-20211208155006738" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208155006738-ad786167.png" tabindex="0"/><figcaption>image-20211208155006738</figcaption></figure><h4 id="_1-1-3-分布式事务" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-1-3-分布式事务">#</a> 1.1.3 分布式事务</h4><p>分布式事务指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的分布式系统的不同节点之上,且属于不同的应用，分布式事务需要保证这些操作要么全部成功，要么全部失败。本质上来说，分布式事务就是为了保证不同数据库的数据一致性。</p><p>最早的分布式事务应用架构很简单，不涉及服务间的访问调用，仅仅是服务内操作涉及到对多个数据库资源的访问。</p><figure><img class="lazy" alt="image-20211208155238640" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208155238640-0eef8867.png" tabindex="0"/><figcaption>image-20211208155238640</figcaption></figure><p>当一个服务操作访问不同的数据库资源，又希望对它们的访问具有事务特性时，就需要采用分布式事务来协调所有的事务参与者。</p><p>对于上面介绍的分布式事务应用架构，尽管一个服务操作会访问多个数据库资源，但是毕竟整个事务还是控制在单一服务的内部。如果一个服务操作需要调用另外一个服务，这时的事务就需要跨越多个服务了。在这种情况下，起始于某个服务的事务在调用另外一个服务的时候，需要以某种机制流转到另外一个服务，从而使被调用的服务访问的资源也自动加入到该事务当中来。下图反映了这样一个跨越多个服务的分布式事务：</p><figure><img class="lazy" alt="image-20211208155459473" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208155459473-57c38c24.png" tabindex="0"/><figcaption>image-20211208155459473</figcaption></figure><p>如果将上面这两种场景(一个服务可以调用多个数据库资源，也可以调用其他服务)结合在一起，对此进行延伸，整个分布式事务的参与者将会组成如下图所示的树形拓扑结构。在一个跨服务的分布式事务中，事务的发起者和提交均系同一个，它可以是整个调用的客户端，也可以是客户端最先调用的那个服务。</p><figure><img class="lazy" alt="image-20211208155810435" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208155810435-43b06256.png" tabindex="0"/><figcaption>image-20211208155810435</figcaption></figure><p>较之基于单一数据库资源访问的本地事务，分布式事务的应用架构更为复杂。在不同的分布式应用架构下，实现一个分布式事务要考虑的问题并不完全一样，比如对多资源的协调、事务的跨服务传播等，实现机制也是复杂多变。</p><p><strong>只要是涉及到多个微服务之间远程调用的话，那就回涉及到分布式事务。</strong></p><p>分布式事务的作用：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">保证每个事务的数据一致性。<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><h3 id="_1-2-分布式事务相关理论" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-2-分布式事务相关理论">#</a> 1.2 分布式事务相关理论</h3><h4 id="_1-2-1-cap定理-重点" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-2-1-cap定理-重点">#</a> 1.2.1 CAP定理-重点</h4><figure><img class="lazy" alt="" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/9-20-09b36db7.png" tabindex="0"/><figcaption></figcaption></figure><p>CAP定理是在 1998年加州大学的计算机科学家 Eric Brewer （埃里克.布鲁尔）提出，分布式系统有三个指标</p><ul><li>Consistency 强一致性</li><li>Availability 可用性</li><li>Partition tolerance 分区容错</li></ul><p>它们的第一个字母分别是 C、A、P。Eric Brewer 说，这三个指标不可能同时做到。这个结论就叫做 CAP 定理。</p><p><strong>因为：强一致性和可用性 互斥！</strong></p><figure><img class="lazy" alt="image-20211208164142661" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208164142661-dd6b05f3.png" tabindex="0"/><figcaption>image-20211208164142661</figcaption></figure><p><strong>真实情况</strong>：</p><p>1 ac 传统项目。ssm管理系统，一个程序，一个数据库。</p><p>2 cp 信息重要的场景。手机银行转账。转圈圈，在做数据同步，这段时间内，可用性是没有的。</p><p>3 ap 互联网。 放弃强一致性，慢慢数据同步。</p><figure><img class="lazy" alt="image-20211208164958537" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208164958537-41a40344.png" tabindex="0"/><figcaption>image-20211208164958537</figcaption></figure><h5 id="分区容错-partition-tolerance" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#分区容错-partition-tolerance">#</a> 分区容错 Partition tolerance</h5><p><strong>理解: 分布式系统集群中, 一个机器坏掉不应该影响其他机器</strong></p><p>大多数分布式系统都分布在多个子网络。每个子网络就叫做一个区（partition）。分区容错的意思是，区间通信可能失败。比如，一台服务器放在中国，另一台服务器放在美国，这就是两个区，它们之间可能无法通信。</p><figure><img class="lazy" alt="" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/9-21-4def4d23.png" tabindex="0"/><figcaption></figcaption></figure><p>上图中，G1 和 G2 是两台跨区的服务器。G1 向 G2 发送一条消息，G2 可能无法收到。系统设计的时候，必须考虑到这种情况。</p><p>一般来说，分区容错无法避免，因此可以认为 CAP 的 P 总是成立。CAP 定理告诉我们，剩下的 C 和 A 无法同时做到。</p><h5 id="可用性-availability" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#可用性-availability">#</a> 可用性 Availability</h5><p><strong>理解: 一个请求, 必须返回一个响应</strong></p><p><strong>Availability 中文叫做"可用性"，意思是只要收到用户的请求，服务器就必须给出回应。</strong></p><p>用户可以选择向 G1 或 G2 发起读操作。不管是哪台服务器，只要收到请求，就必须告诉用户，到底是 v0 还是 v1，否则就不满足可用性。</p><figure><img class="lazy" alt="" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/9-22-897f91db.png" tabindex="0"/><figcaption></figcaption></figure><h5 id="一致性-consistency" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#一致性-consistency">#</a> 一致性 Consistency</h5><p><strong>理解: 一定能读取到最新的数据</strong></p><p><strong>Consistency 中文叫做"一致性"。意思是，写操作之后的读操作，必须返回该值。</strong></p><p>举例来说，某条记录是 v0，用户向 G1 发起一个写操作，将其改为 v1。</p><figure><img class="lazy" alt="" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/9-23-1673d5cf.png" tabindex="0"/><figcaption></figcaption></figure><p>问题是，用户有可能向 G2 发起读操作，由于 G2 的值没有发生变化，因此返回的是 v0。G1 和 G2 读操作的结果不一致，这就不满足一致性了。</p><figure><img class="lazy" alt="" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/9-24-1513dc77.png" tabindex="0"/><figcaption></figcaption></figure><p>为了让 G2 也能变为 v1，就要在 G1 写操作的时候，让 G1 向 G2 发送一条消息，要求 G2 也改成 v1。</p><figure><img class="lazy" alt="" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/9-25-dd2eaa94.png" tabindex="0"/><figcaption></figcaption></figure><h5 id="一致性和可用性的矛盾" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#一致性和可用性的矛盾">#</a> 一致性和可用性的矛盾</h5><p>一致性(C)和可用性(A)，为什么不可能同时成立？答案很简单，因为可能通信失败（即出现分区容错）。</p><p>如果保证 G2 的一致性，那么 G1 必须在写操作时，锁定 G2 的读操作和写操作。只有数据同步后，才能重新开放读写。锁定期间，G2 不能读写，没有可用性(CP)。</p><p>如果保证 G2 的可用性，那么势必不能锁定 G2，所以一致性不成立(AP)。</p><p>综上所述，G2 无法同时做到一致性和可用性。系统设计时只能选择一个目标。如果追求一致性，那么无法保证所有节点的可用性；如果追求所有节点的可用性，那就没法做到一致性。</p><h4 id="_1-2-2-base理论" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-2-2-base理论">#</a> 1.2.2 BASE理论</h4><p>BASE：全称：Basically Available(基本可用)，Soft state（软状态）,和 Eventually consistent（最终一致性）三个短语的缩写，来自 ebay 的架构师提出。BASE 理论是对 CAP 中一致性和可用性权衡的结果，其来源于对大型互联网分布式实践的总结，是基于 CAP 定理逐步演化而来的。其核心思想是：</p><blockquote><p>既是无法做到强一致性（Strong consistency），但每个应用都可以根据自身的业务特点，采用适当的方式来使系统达到最终一致性（Eventual consistency）。</p></blockquote><h5 id="basically-available-基本可用" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#basically-available-基本可用">#</a> Basically Available(基本可用)</h5><p><strong>理解: 允许服务降级或者允许响应时间受到一定损失</strong></p><p>什么是基本可用呢？假设系统，出现了不可预知的故障，但还是能用，相比较正常的系统而言：</p><ol><li>响应时间上的损失：正常情况下的搜索引擎 0.5 秒即返回给用户结果，而<strong>基本可用</strong>的搜索引擎可以在 1 秒作用返回结果。</li><li>功能上的损失：在一个电商网站上，正常情况下，用户可以顺利完成每一笔订单，但是到了大促期间，为了保护购物系统的稳定性，部分消费者可能会被引导到一个降级页面。</li></ol><h5 id="soft-state-软状态" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#soft-state-软状态">#</a> Soft state（软状态）</h5><p><strong>理解: 允许同步数据的时候出现一定时间延迟</strong></p><p>什么是软状态呢？相对于原子性而言，要求多个节点的数据副本都是一致的，这是一种 “硬状态”。</p><p>软状态指的是：允许系统中的数据存在中间状态，并认为该状态不影响系统的整体可用性，即允许系统在多个不同节点的数据副本存在数据延时。</p><h5 id="eventually-consistent-最终一致性" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#eventually-consistent-最终一致性">#</a> Eventually consistent（最终一致性）</h5><p>**理解: 经过一段时间的同步数据之后，最终都能够达到一个一致的状态 **</p><p>系统能够保证在没有其他新的更新操作的情况下，数据最终一定能够达到一致的状态，因此所有客户端对系统的数据访问最终都能够获取到最新的值。</p><h3 id="_1-3-分布式事务解决方案-面试" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-3-分布式事务解决方案-面试">#</a> 1.3 分布式事务解决方案-面试</h3><p>1.XA两段提交(低效率)-2PC</p><p>2.TCC三段提交(3段,高效率[不推荐(补偿代码)])</p><p>3.本地消息表(MQ+Table)</p><p>4.事务消息(RocketMQ[alibaba])</p><p>5.Seata(alibaba)</p><p>6.RabbitMQ的ACK机制实现分布式事务(作业)</p><h4 id="_1-3-1-基于xa协议的两阶段提交-2pc" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-3-1-基于xa协议的两阶段提交-2pc">#</a> 1.3.1 基于XA协议的两阶段提交 2pc</h4><p>首先我们来简要看下分布式事务处理的XA规范 ：</p><figure><img class="lazy" alt="" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/9-14-1a6e6c96.png" tabindex="0"/><figcaption></figcaption></figure><p>可知XA规范中分布式事务有AP，RM，TM组成：</p><p>其中应用程序(Application Program ，简称AP)：AP定义事务边界（定义事务开始和结束）并访问事务边界内的资源。</p><p>资源管理器(Resource Manager，简称RM)：Rm管理计算机共享的资源，许多软件都可以去访问这些资源，资源包含比如<strong>数据库</strong>、文件系统、打印机服务器等。</p><p>事务管理器(Transaction Manager ，简称TM)：负责管理全局事务，分配事务唯一标识，监控事务的执行进度，并负责事务的提交、回滚、失败恢复等。</p><p><strong>二阶段协议:</strong></p><p><strong>第一阶段</strong>TM要求所有的RM准备提交对应的事务分支，询问RM是否有能力保证成功的提交事务分支，RM根据自己的情况，如果判断自己进行的工作可以被提交，那就对工作内容进行持久化，并给TM回执OK；否者给TM的回执NO。RM在发送了否定答复并回滚了已经的工作后，就可以丢弃这个事务分支信息了。</p><p><strong>第二阶段</strong>TM根据阶段1各个RM prepare的结果，决定是提交还是回滚事务。如果所有的RM都prepare成功，那么TM通知所有的RM进行提交；如果有RM prepare回执NO的话，则TM通知所有RM回滚自己的事务分支。</p><p>也就是TM与RM之间是通过两阶段提交协议进行交互的.</p><p><strong>优点：</strong> 尽量保证了数据的强一致，适合对数据强一致要求很高的关键领域。（其实也不能100%保证强一致）</p><p><strong>缺点：</strong> 实现复杂，牺牲了可用性，对性能影响较大，不适合高并发高性能场景。</p><p><strong>流程看我的图</strong>：</p><p>​ mysql</p><figure><img class="lazy" alt="image-20211208174923396" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208174923396-2412462d.png" tabindex="0"/><figcaption>image-20211208174923396</figcaption></figure><p>悲观锁 mysql行级锁 oracle表级锁</p><p>两阶段提交协议(Two Phase Commitment Protocol)中，涉及到两种角色</p><p>一个事务协调者（coordinator）：负责协调多个参与者进行事务投票及提交(回滚) 多个事务参与者（participants）：即本地事务执行者</p><p>总共处理步骤有两个 （1）<strong>投票阶段</strong>（voting phase）：协调者将通知事务参与者准备提交或取消事务，然后进入表决过程。参与者将告知协调者自己的决策：同意（事务参与者本地事务执行成功，但未提交）或取消（本地事务执行故障）； （2）<strong>提交阶段</strong>（commit phase）：收到参与者的通知后，协调者再向参与者发出通知，根据反馈情况决定各参与者是否要提交还是回滚；</p><h4 id="_1-3-2-tcc补偿机制" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-3-2-tcc补偿机制">#</a> 1.3.2 TCC补偿机制</h4><p>TCC 其实就是采用的补偿机制，其核心思想是：针对每个操作，都要注册一个与其对应的确认和补偿（撤销）操作。它分为三个阶段：</p><ul><li>Try 阶段主要是对业务系统做检测及资源预留</li><li>Confirm 阶段主要是对业务系统做确认提交，Try阶段执行成功并开始执行 Confirm阶段时，默认 Confirm阶段是不会出错的。即：只要Try成功，Confirm一定成功。</li><li>Cancel 阶段主要是在业务执行错误，需要回滚的状态下执行的业务取消，预留资源释放。</li></ul><p>例如： A要向 B 转账，思路大概是：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">我们有一个本地方法，里面依次调用 <br>1、首先在 Try 阶段，要先调用远程接口把 B和 A的钱给冻结起来。 <br>2、在 Confirm 阶段，执行远程调用的转账的操作，转账成功进行解冻。 <br>3、如果第2步执行成功，那么转账成功，如果第二步执行失败，则调用远程冻结接口对应的解冻方法 (Cancel)。 <br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>优点：</strong> 相比两阶段提交，可用性比较强</p><p><strong>缺点：</strong> 数据的一致性要差一些。TCC属于应用层的一种补偿方式，所以需要程序员在实现的时候多写很多补偿的代码，在一些场景中，一些业务流程可能用TCC不太好定义及处理。</p><p><strong>流程看我的图：</strong></p><figure><img class="lazy" alt="image-20211208180127771" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208180127771-6e94911f.png" tabindex="0"/><figcaption>image-20211208180127771</figcaption></figure><h4 id="_1-3-3-消息最终一致性-重点" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-3-3-消息最终一致性-重点">#</a> 1.3.3 消息最终一致性-重点</h4><p>消息最终一致性应该是业界使用最多的，其核心思想是将分布式事务拆分成本地事务进行处理，这种思路是来源于ebay。我们可以从下面的流程图中看出其中的一些细节：</p><figure><img class="lazy" alt="" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/9-16-7fb4fb35.png" tabindex="0"/><figcaption></figcaption></figure><p>基本思路就是：</p><p>消息生产方，需要额外建一个消息表，并记录消息发送状态。消息表和业务数据要在一个事务里提交，也就是说他们要在一个数据库里面。然后消息会经过MQ发送到消息的消费方。如果消息发送失败，会进行重试发送。</p><p>消息消费方，需要处理这个消息，并完成自己的业务逻辑。此时如果本地事务处理成功，表明已经处理成功了，如果处理失败，那么就会重试执行。如果是业务上面的失败，可以给生产方发送一个业务补偿消息，通知生产方进行回滚等操作。</p><p>生产方和消费方定时扫描本地消息表，把还没处理完成的消息或者失败的消息再发送一遍。如果有靠谱的自动对账补账逻辑，这种方案还是非常实用的。</p><p><strong>优点：</strong> 一种非常经典的实现，避免了分布式事务，实现了最终一致性。</p><p><strong>缺点：</strong> 消息表会耦合到业务系统中，如果没有封装好的解决方案，会有很多杂活需要处理。</p><p><strong>流程看我的图：</strong></p><p>需求：下单同时，减库存</p><p>参与者A 订单服务</p><figure><img class="lazy" alt="image-20211208221414338" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208221414338-a08cee39.png" tabindex="0"/><figcaption>image-20211208221414338</figcaption></figure><p>1、订单服务</p><p>1.1 订单表插入数据，订单消息表添加数据101。本地事务，可以控制住。</p><p>1.2 定时任务：扫描订单消息表---》mq发一条消息，订单信息</p><p>2、商品服务</p><p>2.1监听消息队列，收到消息订单详情。</p><p>2.2sku 减库存，接受到商品订单的消息表。本地事务，可以控制住。</p><p>2.3 定时任务：扫描接受到商品订单的消息表---》mq发一条消息，我已经减库存了</p><p>2.4 mq发一条消息 接受到商品订单的消息表 101 staus 2 已经发了消息了</p><p>3、订单服务</p><p>3.1监听消息队列（已经减库存了） 订单消息表 删除</p><p>​</p><h2 id="_2-分布式事务框架seata" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-分布式事务框架seata">#</a> 2. 分布式事务框架seata</h2><h3 id="_2-1-seata简介" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-1-seata简介">#</a> 2.1 seata简介</h3><p>​ Seata（原名Fescar） 是阿里18年开源的分布式事务的框架。Fescar的开源对分布式事务框架领域影响很大。作为开源大户，Fescar来自阿里的GTS，经历了好几次双十一的考验，一经开源便颇受关注。后来Fescar改名为Seata。 <a href="https://github.com/seata/seata" rel="noopener noreferrer" target="_blank">https://github.com/seata/seata<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><pre><code>Fescar虽然是二阶段提交协议的分布式事务，但是其解决了XA的一些缺点:
</code></pre><ul><li>单点问题:虽然目前Fescar(0.4.2)还是单server的，但是Fescar官方预计将会在0.5.x中推出HA-Cluster，到时候就可以解决单点问题。</li><li>同步阻塞:Fescar的二阶段，其再<strong>第一阶段的时候本地事务</strong>就已经提交释放资源了，不会像XA会再两个prepare和commit阶段资源都锁住，并且<strong>Fescar,commit是异步操作</strong>，也是提升性能的一大关键。</li><li>数据不一致:如果出现部分commit失败，那么fescar-server会根据当前的事务模式和分支事务的返回状态的结果来进行不同的重试策略。并且fescar的本地事务会在一阶段的时候进行提交，其实单看数据库来说在commit的时候数据库已经是一致的了。</li><li>只能用于单一数据库: Fescar提供了三种模式，<strong>AT和TCC和混合模式</strong>。在AT模式下事务资源可以是任何支持ACID的数据库，在TCC模式下事务资源没有限制，可以是缓存，可以是文件，可以是其他的等等。当然这两个模式也可以混用。</li></ul><p>同时Fescar也保留了接近0业务入侵的优点，只需要简单的配置Fescar的数据代理和加个注解，加一个Undolog表，就可以达到我们想要的目的。</p><h3 id="_2-2-实现原理" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-2-实现原理">#</a> 2.2 实现原理</h3><p>Fescar将一个本地事务做为一个分布式事务分支，所以若干个分布在不同微服务中的本地事务共同组成了一个全局事务，结构如下。</p><p>官帮助文档： <a href="https://seata.io/zh-cn/index.html" rel="noopener noreferrer" target="_blank">https://seata.io/zh-cn/index.html<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img class="lazy" alt="image-20200304154454364" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200304154454364-b860d95e.png" tabindex="0"/><figcaption>image-20200304154454364</figcaption></figure><p>TM：全局事务管理器，在标注开启fescar分布式事务的服务端开启，并将全局事务发送到TC事务控制端管理</p><p>TC：事务控制中心，控制全局事务的提交或者回滚。这个组件需要独立部署维护，目前只支持单机版本，后续迭代计划会有集群版本</p><p>RM：资源管理器，主要负责分支事务的上报，本地事务的管理</p><p>一段话简述其实现过程：服务起始方发起全局事务并注册到TC。在调用协同服务时，协同服务的事务分支事务会先完成阶段一的事务提交或回滚，并生成事务回滚的undo_log日志，同时注册当前协同服务到TC并上报其事务状态，归并到同一个业务的全局事务中。此时若没有问题继续下一个协同服务的调用，期间任何协同服务的分支事务回滚，都会通知到TC，TC在通知全局事务包含的所有已完成一阶段提交的分支事务回滚。如果所有分支事务都正常，最后回到全局事务发起方时，也会通知到TC，TC在通知全局事务包含的所有分支删除回滚日志。在这个过程中为了解决写隔离和度隔离的问题会涉及到TC管理的全局锁。</p><p>（增加订单(branchId=901)，减库存(branchId=109)） xid=101</p><h3 id="_2-3-fescar模式" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-3-fescar模式">#</a> 2.3 Fescar模式</h3><p>Fescar对分布式事务的实现提供了3种模式，AT模式和TCC模式、saga模式：</p><h4 id="_2-3-1-at模式" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-3-1-at模式">#</a> 2.3.1 AT模式</h4><p><strong>AT模式</strong>：主要关注多 DB 访问的数据一致性，实现起来比较简单，对业务的侵入较小，但性能没有TCC高，这种模式推荐大家使用。</p><p>AT模式部分代码如下：不需要关注执行状态，对业务代码侵入较小。</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 此代码为示例代码, 不需要演示, 主要看AT和TCC代码的区别使用</span><br><span class="hljs-comment">  */</span><br><span class="hljs-meta">@GlobalTransactional(timeoutMills = 300000, name = &quot;dubbo-demo-tx&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">purchase</span><span class="hljs-params">(String userId, String commodityCode, <span class="hljs-type">int</span> orderCount)</span> &#123;<br>    LOGGER.info(<span class="hljs-string">&quot;purchase begin ... xid: &quot;</span> + RootContext.getXID());<br>    storageService.deduct(commodityCode, orderCount);<br>    orderService.create(userId, commodityCode, orderCount);<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;AT 模式发生异常，回滚事务&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AT模式的核心是对业务无侵入，是一种改进后的两阶段提交，其设计思路如图：</p><p><strong>第一阶段：</strong></p><p>核心在于对业务sql进行解析，转换成undolog，两阶段提交往往对资源的锁定需要持续到第二阶段实际的提交或者回滚操作，而有了回滚日志之后，可以在第一阶段释放对资源的锁定，降低了锁范围，提高效率，即使第二阶段发生异常需要回滚，只需找对undolog中对应数据并反解析成sql来达到回滚目的。Seata通过代理数据源将业务sql的执行解析成undolog来与业务数据的更新同时入库，达到了对业务无侵入的效果。</p><p><strong>第二阶段：</strong></p><p>如果决议是全局提交，此时分支事务此时已经完成提交，不需要同步协调处理（只需要异步清理回滚日志），Phase2 可以非常快速地完成。</p><p>如果决议是全局回滚，RM 收到协调器发来的回滚请求，通过 XID 和 Branch ID 找到相应的回滚日志记录，<strong>通过回滚记录生成反向的更新 SQL 并执行</strong>，以完成分支的回滚。</p><h4 id="_2-3-3-tcc模式" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-3-3-tcc模式">#</a> 2.3.3 TCC模式</h4><p><strong>TCC模式</strong>：TCC补偿机制，对代码造成一定的侵入,实现难度较大，这种方式不推荐，不过TCC模式的特点是性能高。</p><p>TCC模式部分代码如下：可以看到执行事务回滚，都需要根据不同阶段执行的状态判断，侵入了业务代码。</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 此代码为示例代码, 不需要演示, 主要看AT和TCC代码的区别使用</span><br><span class="hljs-comment"> * 转账操作</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> from  扣钱账户</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> to  加钱账户</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> amount  转账金额</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@GlobalTransactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String from, <span class="hljs-keyword">final</span> String to, <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> amount)</span> &#123;<br>    <span class="hljs-comment">//扣钱参与者，一阶段执行</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> firstTccAction.prepareMinus(<span class="hljs-literal">null</span>, from, amount);<br><br>    <span class="hljs-keyword">if</span>(!ret)&#123;<br>        <span class="hljs-comment">//扣钱参与者，一阶段失败; 回滚本地事务和分布式事务</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;账号:[&quot;</span>+from+<span class="hljs-string">&quot;] 预扣款失败&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//加钱参与者，一阶段执行</span><br>    ret = secondTccAction.prepareAdd(<span class="hljs-literal">null</span>, to, amount);<br><br>    <span class="hljs-keyword">if</span>(!ret)&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;账号:[&quot;</span>+to+<span class="hljs-string">&quot;] 预收款失败&quot;</span>);<br>    &#125;<br><br>    System.out.println(String.format(<span class="hljs-string">&quot;transfer amount[%s] from [%s] to [%s] finish.&quot;</span>, String.valueOf(amount), from, to));<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-3-saga模式" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-3-3-saga模式">#</a> 2.3.3 Saga模式</h4><p>详见 <a href="https://seata.io/zh-cn/docs/dev/mode/saga-mode.html" rel="noopener noreferrer" target="_blank">https://seata.io/zh-cn/docs/dev/mode/saga-mode.html<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h2 id="_3-seata案例" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-seata案例">#</a> 3 Seata案例</h2><h3 id="_3-1准备工作" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-1准备工作">#</a> 3.1准备工作</h3><p>​ 1导入资料中的ydles_common_fescar。注意总父工程中加入模块</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">&amp;lt;module&amp;gt;ydles_common_fescar&amp;lt;/module&amp;gt;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>​ 2观察模块中的三个类。</p><p>​ <img class="lazy" alt="image-20211209000033506" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209000033506-c324735a.png"/></p><p>​ 3数据库ydles_order中的undo_log表为记录相关操作的表</p><figure><img class="lazy" alt="image-20211209000144424" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209000144424-e15a585c.png" tabindex="0"/><figcaption>image-20211209000144424</figcaption></figure><p>4资料中的fescar-server-0.4.2解压，bin目录中双击fescar-server.bat。<strong>注意</strong>：这是fescar的服务，并且放到一个短目录才能执行。</p><figure><img class="lazy" alt="image-20211209000404624" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209000404624-d97345d0.png" tabindex="0"/><figcaption>image-20211209000404624</figcaption></figure><h3 id="_3-2分布式事务错误演示" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-2分布式事务错误演示">#</a> 3.2分布式事务错误演示</h3><p>1order服务 com.ydles.order.service.impl 的 add方法中增加一个错误 本地事务控制注解增加@Transactional</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">//减库存<br> skuFeign.decrCount(order.getUsername());<br><br> int i=1/0;<br><br> // 5）删除购物车中数据<br> redisTemplate.delete(&quot;cart_&quot;+order.getUsername());<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2goods 服务 com.ydles.goods.service.impl decrCount减库存方法上增加本地事务控制注解@Transactional</p><p>3查看数据库 tb_order tb_order_item中没数据。</p><figure><img class="lazy" alt="image-20211209001159153" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001159153-6bf084e1.png" tabindex="0"/><figcaption>image-20211209001159153</figcaption></figure><figure><img class="lazy" alt="image-20211209001206890" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001206890-ab28a1d3.png" tabindex="0"/><figcaption>image-20211209001206890</figcaption></figure><p>tb_sku查看一条数据库存量 100</p><p>4登陆购物车并登陆 <a href="http://localhost:8001/api/wcart/list" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/wcart/list<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>5往购物车添加数据 <a href="http://localhost:8001/api/wcart/add?skuId=1450862568724758528&amp;num=5" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/wcart/add?skuId=1450862568724758528&amp;num=5<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>6购物车页面点击结算到订单页面</p><figure><img class="lazy" alt="image-20211209001242965" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001242965-52894bc4.png" tabindex="0"/><figcaption>image-20211209001242965</figcaption></figure><p>7点击提交订单</p><figure><img class="lazy" alt="image-20211209001233900" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001233900-dc70a307.png" tabindex="0"/><figcaption>image-20211209001233900</figcaption></figure><p>8代码中 order服务报错</p><figure><img class="lazy" alt="image-20211209001252770" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001252770-1eb805bc.png" tabindex="0"/><figcaption>image-20211209001252770</figcaption></figure><p>9观察数据库</p><p>tb_order tb_order_item没变</p><figure><img class="lazy" alt="image-20211209001159153" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001159153-6bf084e1.png" tabindex="0"/><figcaption>image-20211209001159153</figcaption></figure><figure><img class="lazy" alt="image-20211209001206890" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001206890-ab28a1d3.png" tabindex="0"/><figcaption>image-20211209001206890</figcaption></figure><p>tb_sku 1450862568724758528商品库存减少了5</p><figure><img class="lazy" alt="image-20211209001328489" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001328489-52ca7c07.png" tabindex="0"/><figcaption>image-20211209001328489</figcaption></figure><p>10 为什么</p><p>order goods服务是两个服务，即使加上@Transactional也是本地事务控制。</p><figure><img class="lazy" alt="image-20211209001403817" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001403817-97cc1736.png" tabindex="0"/><figcaption>image-20211209001403817</figcaption></figure><h3 id="_3-3-分布式事务正确演示" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-分布式事务正确演示">#</a> 3.3 分布式事务正确演示</h3><p>1 goods order 增加fescar依赖</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">&amp;lt;dependency&amp;gt;<br>    &amp;lt;groupId&amp;gt;com.ydles&amp;lt;/groupId&amp;gt;<br>    &amp;lt;artifactId&amp;gt;ydles_common_fescar&amp;lt;/artifactId&amp;gt;<br>    &amp;lt;version&amp;gt;1.0-SNAPSHOT&amp;lt;/version&amp;gt;<br>&amp;lt;/dependency&amp;gt;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2在订单微服务的OrderServiceImpl的add方法上增加@GlobalTransactional(name = "order_add")注解</p><figure><img class="lazy" alt="image-20211209001555985" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001555985-643dfe75.png" tabindex="0"/><figcaption>image-20211209001555985</figcaption></figure><p>我的购物车</p><figure><img class="lazy" alt="image-20211209001721316" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001721316-38d5d8e1.png" tabindex="0"/><figcaption>image-20211209001721316</figcaption></figure><p>到结算页</p><figure><img class="lazy" alt="image-20211209001737111" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001737111-f8df4cdb.png" tabindex="0"/><figcaption>image-20211209001737111</figcaption></figure><p>下单失败了</p><figure><img class="lazy" alt="image-20211209001813785" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001813785-c968a192.png" tabindex="0"/><figcaption>image-20211209001813785</figcaption></figure><p>3order 服务重启 观察 fescar控制台输出</p><p>4goods 服务重启 观察 fescar控制台输出</p><p>5重新提交订单 依然失败 但库存不扣减了</p><figure><img class="lazy" alt="image-20211209001946242" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209001946242-ef4fae3f.png" tabindex="0"/><figcaption>image-20211209001946242</figcaption></figure><h2 id="_4消息队列实现分布式事务-整个项目的重点" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4消息队列实现分布式事务-整个项目的重点">#</a> 4消息队列实现分布式事务---整个项目的重点</h2><h4 id="_1业务流程-重点" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1业务流程-重点">#</a> 1业务流程-重点</h4><p>需求：（一次下单---》用户积分增加一次） 事务</p><figure><img class="lazy" alt="image-20211209011831937" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209011831937-a99b3a5d.png" tabindex="0"/><figcaption>image-20211209011831937</figcaption></figure><p>1 order</p><p>​ 1.1 order task.本地事务控制。</p><p>​ 1.2 spring-task扫表 task-----》mq发消息</p><p>2user</p><p>​ 2.1监听消息 6</p><p>​ 2.2 8相当于锁 11释放锁</p><p>​ 2.3 mq（另一个队列） task 积分加上了</p><p>3order</p><p>​ 3.1监听消息 task_his 加上，后期查看，task 删除</p><h4 id="_2代码实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2代码实现">#</a> 2代码实现</h4><h5 id="_2-1准备" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-1准备">#</a> 2.1准备</h5><h6 id="_1order中添加两张表" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1order中添加两张表">#</a> 1order中添加两张表</h6><p>​ tb_task 任务表</p><p>​ <img class="lazy" alt="image-20211209012241987" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209012241987-10f3aeca.png"/></p><p>​ tb_task_his 历史任务表</p><p>​ <img class="lazy" alt="image-20211209012312800" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209012312800-ac75811f.png"/></p><h6 id="_2order-api中添加对应的实体类" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2order-api中添加对应的实体类">#</a> 2order-api中添加对应的实体类</h6><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydles.order.pojo;<br><br><span class="hljs-keyword">import</span> javax.persistence.Column;<br><span class="hljs-keyword">import</span> javax.persistence.Id;<br><span class="hljs-keyword">import</span> javax.persistence.Table;<br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-meta">@Table(name = &quot;tb_task&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Task</span> &#123;<br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-keyword">private</span> Long id;<br><br>    <span class="hljs-meta">@Column(name = &quot;create_time&quot;)</span><br>    <span class="hljs-keyword">private</span> Date createTime;<br><br>    <span class="hljs-meta">@Column(name = &quot;update_time&quot;)</span><br>    <span class="hljs-keyword">private</span> Date updateTime;<br><br>    <span class="hljs-meta">@Column(name = &quot;delete_time&quot;)</span><br>    <span class="hljs-keyword">private</span> Date deleteTime;<br><br>    <span class="hljs-meta">@Column(name = &quot;task_type&quot;)</span><br>    <span class="hljs-keyword">private</span> String taskType;<br><br>    <span class="hljs-meta">@Column(name = &quot;mq_exchange&quot;)</span><br>    <span class="hljs-keyword">private</span> String mqExchange;<br><br>    <span class="hljs-meta">@Column(name = &quot;mq_routingkey&quot;)</span><br>    <span class="hljs-keyword">private</span> String mqRoutingkey;<br><br>    <span class="hljs-meta">@Column(name = &quot;request_body&quot;)</span><br>    <span class="hljs-keyword">private</span> String requestBody;<br><br>    <span class="hljs-meta">@Column(name = &quot;status&quot;)</span><br>    <span class="hljs-keyword">private</span> String status;<br><br>    <span class="hljs-meta">@Column(name = &quot;errormsg&quot;)</span><br>    <span class="hljs-keyword">private</span> String errormsg;<br><br>    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Date <span class="hljs-title function_">getCreateTime</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> createTime;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCreateTime</span><span class="hljs-params">(Date createTime)</span> &#123;<br>        <span class="hljs-built_in">this</span>.createTime = createTime;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Date <span class="hljs-title function_">getUpdateTime</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> updateTime;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUpdateTime</span><span class="hljs-params">(Date updateTime)</span> &#123;<br>        <span class="hljs-built_in">this</span>.updateTime = updateTime;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Date <span class="hljs-title function_">getDeleteTime</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> deleteTime;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDeleteTime</span><span class="hljs-params">(Date deleteTime)</span> &#123;<br>        <span class="hljs-built_in">this</span>.deleteTime = deleteTime;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getTaskType</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> taskType;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setTaskType</span><span class="hljs-params">(String taskType)</span> &#123;<br>        <span class="hljs-built_in">this</span>.taskType = taskType;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMqExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> mqExchange;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMqExchange</span><span class="hljs-params">(String mqExchange)</span> &#123;<br>        <span class="hljs-built_in">this</span>.mqExchange = mqExchange;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMqRoutingkey</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> mqRoutingkey;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMqRoutingkey</span><span class="hljs-params">(String mqRoutingkey)</span> &#123;<br>        <span class="hljs-built_in">this</span>.mqRoutingkey = mqRoutingkey;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getRequestBody</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> requestBody;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setRequestBody</span><span class="hljs-params">(String requestBody)</span> &#123;<br>        <span class="hljs-built_in">this</span>.requestBody = requestBody;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getStatus</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> status;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStatus</span><span class="hljs-params">(String status)</span> &#123;<br>        <span class="hljs-built_in">this</span>.status = status;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getErrormsg</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> errormsg;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setErrormsg</span><span class="hljs-params">(String errormsg)</span> &#123;<br>        <span class="hljs-built_in">this</span>.errormsg = errormsg;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydles.order.pojo;<br><br><span class="hljs-keyword">import</span> javax.persistence.Column;<br><span class="hljs-keyword">import</span> javax.persistence.Id;<br><span class="hljs-keyword">import</span> javax.persistence.Table;<br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-meta">@Table(name = &quot;tb_task_his&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskHis</span> &#123;<br><br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-keyword">private</span> Long id;<br><br>    <span class="hljs-meta">@Column(name = &quot;create_time&quot;)</span><br>    <span class="hljs-keyword">private</span> Date createTime;<br><br>    <span class="hljs-meta">@Column(name = &quot;update_time&quot;)</span><br>    <span class="hljs-keyword">private</span> Date updateTime;<br><br>    <span class="hljs-meta">@Column(name = &quot;delete_time&quot;)</span><br>    <span class="hljs-keyword">private</span> Date deleteTime;<br><br>    <span class="hljs-meta">@Column(name = &quot;task_type&quot;)</span><br>    <span class="hljs-keyword">private</span> String taskType;<br><br>    <span class="hljs-meta">@Column(name = &quot;mq_exchange&quot;)</span><br>    <span class="hljs-keyword">private</span> String mqExchange;<br><br>    <span class="hljs-meta">@Column(name = &quot;mq_routingkey&quot;)</span><br>    <span class="hljs-keyword">private</span> String mqRoutingkey;<br><br>    <span class="hljs-meta">@Column(name = &quot;request_body&quot;)</span><br>    <span class="hljs-keyword">private</span> String requestBody;<br><br>    <span class="hljs-meta">@Column(name = &quot;status&quot;)</span><br>    <span class="hljs-keyword">private</span> String status;<br><br>    <span class="hljs-meta">@Column(name = &quot;errormsg&quot;)</span><br>    <span class="hljs-keyword">private</span> String errormsg;<br><br>    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Date <span class="hljs-title function_">getCreateTime</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> createTime;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCreateTime</span><span class="hljs-params">(Date createTime)</span> &#123;<br>        <span class="hljs-built_in">this</span>.createTime = createTime;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Date <span class="hljs-title function_">getUpdateTime</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> updateTime;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUpdateTime</span><span class="hljs-params">(Date updateTime)</span> &#123;<br>        <span class="hljs-built_in">this</span>.updateTime = updateTime;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Date <span class="hljs-title function_">getDeleteTime</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> deleteTime;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDeleteTime</span><span class="hljs-params">(Date deleteTime)</span> &#123;<br>        <span class="hljs-built_in">this</span>.deleteTime = deleteTime;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getTaskType</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> taskType;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setTaskType</span><span class="hljs-params">(String taskType)</span> &#123;<br>        <span class="hljs-built_in">this</span>.taskType = taskType;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMqExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> mqExchange;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMqExchange</span><span class="hljs-params">(String mqExchange)</span> &#123;<br>        <span class="hljs-built_in">this</span>.mqExchange = mqExchange;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMqRoutingkey</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> mqRoutingkey;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMqRoutingkey</span><span class="hljs-params">(String mqRoutingkey)</span> &#123;<br>        <span class="hljs-built_in">this</span>.mqRoutingkey = mqRoutingkey;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getRequestBody</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> requestBody;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setRequestBody</span><span class="hljs-params">(String requestBody)</span> &#123;<br>        <span class="hljs-built_in">this</span>.requestBody = requestBody;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getStatus</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> status;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStatus</span><span class="hljs-params">(String status)</span> &#123;<br>        <span class="hljs-built_in">this</span>.status = status;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getErrormsg</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> errormsg;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setErrormsg</span><span class="hljs-params">(String errormsg)</span> &#123;<br>        <span class="hljs-built_in">this</span>.errormsg = errormsg;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="_3-ydles-user新增积分日志表" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-ydles-user新增积分日志表">#</a> 3 ydles_user新增积分日志表</h6><figure><img class="lazy" alt="image-20211209012706482" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209012706482-2e5c4330.png" tabindex="0"/><figcaption>image-20211209012706482</figcaption></figure><figure><img class="lazy" alt="image-20211209012742948" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209012742948-cad23f23.png" tabindex="0"/><figcaption>image-20211209012742948</figcaption></figure><h6 id="_4-ydles-service-user-api添加实体类-pointlog" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-ydles-service-user-api添加实体类-pointlog">#</a> 4 ydles_service_user_api添加实体类 PointLog</h6><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydles.user.pojo;<br><br><span class="hljs-keyword">import</span> javax.persistence.Table;<br><br><span class="hljs-meta">@Table(name = &quot;tb_point_log&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PointLog</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String orderId;<br>    <span class="hljs-keyword">private</span> String userId;<br>    <span class="hljs-keyword">private</span> Integer point;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getOrderId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> orderId;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setOrderId</span><span class="hljs-params">(String orderId)</span> &#123;<br>        <span class="hljs-built_in">this</span>.orderId = orderId;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUserId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> userId;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUserId</span><span class="hljs-params">(String userId)</span> &#123;<br>        <span class="hljs-built_in">this</span>.userId = userId;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getPoint</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> point;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPoint</span><span class="hljs-params">(Integer point)</span> &#123;<br>        <span class="hljs-built_in">this</span>.point = point;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="_5rabbitmq" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_5rabbitmq">#</a> 5rabbitMQ</h6><p>1 order 服务 导包</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">&amp;lt;dependency&amp;gt;<br>    &amp;lt;groupId&amp;gt;org.springframework.amqp&amp;lt;/groupId&amp;gt;<br>    &amp;lt;artifactId&amp;gt;spring-rabbit&amp;lt;/artifactId&amp;gt;<br>&amp;lt;/dependency&amp;gt;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2config 下 rabbitMQ配置类</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydles.order.config;<br><br><span class="hljs-keyword">import</span> org.springframework.amqp.core.*;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabbitMQConfig</span> &#123;<br><br>    <span class="hljs-comment">//添加积分任务交换机</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">EX_BUYING_ADDPOINTUSER</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ex_buying_addpointuser&quot;</span>;<br><br>    <span class="hljs-comment">//添加积分消息队列</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CG_BUYING_ADDPOINT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;cg_buying_addpoint&quot;</span>;<br><br>    <span class="hljs-comment">//完成添加积分消息队列</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CG_BUYING_FINISHADDPOINT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;cg_buying_finishaddpoint&quot;</span>;<br><br>    <span class="hljs-comment">//添加积分路由key</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CG_BUYING_ADDPOINT_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;addpoint&quot;</span>;<br><br>    <span class="hljs-comment">//完成添加积分路由key</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CG_BUYING_FINISHADDPOINT_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;finishaddpoint&quot;</span>;<br><br>    <span class="hljs-comment">//声明交换机</span><br>    <span class="hljs-meta">@Bean(EX_BUYING_ADDPOINTUSER)</span><br>    <span class="hljs-keyword">public</span> Exchange <span class="hljs-title function_">EX_BUYING_ADDPOINTUSER</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> ExchangeBuilder.directExchange(EX_BUYING_ADDPOINTUSER).durable(<span class="hljs-literal">true</span>).build();<br>    &#125;<br><br>    <span class="hljs-comment">//声明队列</span><br>    <span class="hljs-meta">@Bean(CG_BUYING_ADDPOINT)</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">CG_BUYING_ADDPOINT</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">Queue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(CG_BUYING_ADDPOINT);<br>        <span class="hljs-keyword">return</span> queue;<br>    &#125;<br>    <span class="hljs-meta">@Bean(CG_BUYING_FINISHADDPOINT)</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">CG_BUYING_FINISHADDPOINT</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">Queue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(CG_BUYING_FINISHADDPOINT);<br>        <span class="hljs-keyword">return</span> queue;<br>    &#125;<br><br>    <span class="hljs-comment">//队列绑定交换机</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">BINDING_CG_BUYING_ADDPOINT</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(CG_BUYING_ADDPOINT)</span> Queue queue, <span class="hljs-meta">@Qualifier(EX_BUYING_ADDPOINTUSER)</span>Exchange exchange)</span>&#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(CG_BUYING_ADDPOINT_KEY).noargs();<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">BINDING_CG_BUYING_FINISHADDPOINT</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(CG_BUYING_FINISHADDPOINT)</span> Queue queue,<span class="hljs-meta">@Qualifier(EX_BUYING_ADDPOINTUSER)</span>Exchange exchange)</span>&#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(CG_BUYING_FINISHADDPOINT_KEY).noargs();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3配置文件 rabbitmq</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">rabbitmq:<br>  host: 192.168.200.128<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-2-订单服务逻辑" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-2-订单服务逻辑">#</a> 2.2 订单服务逻辑</h5><p>需求：</p><figure><img class="lazy" alt="image-20211209014056551" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209014056551-aab52bfa.png" tabindex="0"/><figcaption>image-20211209014056551</figcaption></figure><h6 id="_1dao层-增加mapper" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1dao层-增加mapper">#</a> 1dao层 增加mapper</h6><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">package com.ydles.order.dao;<br><br>import com.ydles.order.pojo.Task;<br>import tk.mybatis.mapper.common.Mapper;<br><br>public interface TaskMapper extends Mapper&amp;lt;Task&amp;gt; &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">package com.ydles.order.dao;<br><br>import com.ydles.order.pojo.TaskHis;<br>import tk.mybatis.mapper.common.Mapper;<br><br>public interface TaskHisMapper extends Mapper&amp;lt;TaskHis&amp;gt; &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="_2下单逻辑中增加任务" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2下单逻辑中增加任务">#</a> 2下单逻辑中增加任务</h6><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">@Autowired<br>TaskMapper taskMapper;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// int i=1/0;</span><br> <span class="hljs-comment">//添加任务数据</span><br> System.out.println(<span class="hljs-string">&quot;向订单数据库中的任务表去添加任务数据&quot;</span>);<br> <span class="hljs-type">Task</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>();<br> task.setCreateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br> task.setUpdateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br> task.setMqExchange(RabbitMQConfig.EX_BUYING_ADDPOINTUSER);<br> task.setMqRoutingkey(RabbitMQConfig.CG_BUYING_ADDPOINT_KEY);<br><br> <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br> map.put(<span class="hljs-string">&quot;username&quot;</span>,order.getUsername());<br> map.put(<span class="hljs-string">&quot;orderId&quot;</span>,orderId);<br> map.put(<span class="hljs-string">&quot;point&quot;</span>,order.getPayMoney());<br> task.setRequestBody(JSON.toJSONString(map));<br> taskMapper.insertSelective(task);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="_3定时任务-定时发送任务表信息到mq" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3定时任务-定时发送任务表信息到mq">#</a> 3定时任务，定时发送任务表信息到mq</h6><p>启动类增加</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">@EnableScheduling //开启定时任务<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>新建task包，加入定时任务类</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QueryPointTask</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TaskMapper taskMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br>    <span class="hljs-meta">@Scheduled(cron = &quot;0/2 * * * * ?&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">queryTask</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">//1. 获取小于系统当前时间的数据</span><br>        List&amp;lt;Task&amp;gt; taskList = taskMapper.findTaskLessThanCurrentTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        <span class="hljs-keyword">if</span> (taskList != <span class="hljs-literal">null</span> &amp;amp;&amp;amp; taskList.size()&amp;gt;<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-comment">//2.将任务发送到消息队列上</span><br>            <span class="hljs-keyword">for</span> (Task task : taskList) &#123;<br>                rabbitTemplate.convertAndSend(RabbitMQConfig.EX_BUYING_ADDPOINTUSER, RabbitMQConfig.CG_BUYING_ADDPOINT_KEY, JSON.toJSONString(task));<br>                System.out.println(<span class="hljs-string">&quot;订单服务向添加积分队列发送了一条消息&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>taskmapper中自定义查询小于当前时间的方法</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Select(&quot;select * from tb_task where update_time&amp;lt;#&#123;currentTime&#125;&quot;)</span><br><span class="hljs-meta">@Results(&#123;@Result(column = &quot;create_time&quot;,property = &quot;createTime&quot;),</span><br><span class="hljs-meta">        @Result(column = &quot;update_time&quot;,property = &quot;updateTime&quot;),</span><br><span class="hljs-meta">        @Result(column = &quot;delete_time&quot;,property = &quot;deleteTime&quot;),</span><br><span class="hljs-meta">        @Result(column = &quot;task_type&quot;,property = &quot;taskType&quot;),</span><br><span class="hljs-meta">        @Result(column = &quot;mq_exchange&quot;,property = &quot;mqExchange&quot;),</span><br><span class="hljs-meta">        @Result(column = &quot;mq_routingkey&quot;,property = &quot;mqRoutingkey&quot;),</span><br><span class="hljs-meta">        @Result(column = &quot;request_body&quot;,property = &quot;requestBody&quot;),</span><br><span class="hljs-meta">        @Result(column = &quot;status&quot;,property = &quot;status&quot;),</span><br><span class="hljs-meta">        @Result(column = &quot;errormsg&quot;,property = &quot;errormsg&quot;)&#125;)</span><br>List&amp;lt;Task&amp;gt; findTaskLessThanCurrentTime(Date currentTime);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-3-用户服务逻辑" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-3-用户服务逻辑">#</a> 2.3 用户服务逻辑</h5><p>需求：</p><figure><img class="lazy" alt="image-20211209021057873" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209021057873-d9d4537d.png" tabindex="0"/><figcaption>image-20211209021057873</figcaption></figure><h6 id="_1配置文件增加redis-rabbitmq配置" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1配置文件增加redis-rabbitmq配置">#</a> 1配置文件增加redis rabbitMQ配置</h6><div class="language-yaml line-numbers-mode" data-ext="yml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight yaml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">user</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://192.168.200.128:3306/ydles_user?useUnicode=true&amp;amp;characterEncoding=UTF-8&amp;amp;serverTimezone=UTC</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">main:</span><br>    <span class="hljs-attr">allow-bean-definition-overriding:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#当遇到同样名字的时候，是否允许覆盖注册</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.128</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.128</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="_2导入mq依赖" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2导入mq依赖">#</a> 2导入mq依赖</h6><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">&amp;lt;dependency&amp;gt;<br>    &amp;lt;groupId&amp;gt;org.springframework.amqp&amp;lt;/groupId&amp;gt;<br>    &amp;lt;artifactId&amp;gt;spring-rabbit&amp;lt;/artifactId&amp;gt;<br>&amp;lt;/dependency&amp;gt;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="_3mq配置类" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3mq配置类">#</a> 3mq配置类</h6><p>RabbitMQConfig ，从order服务copy</p><h6 id="_4添加依赖" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4添加依赖">#</a> 4添加依赖</h6><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">&amp;lt;dependency&amp;gt;<br>    &amp;lt;groupId&amp;gt;com.ydles&amp;lt;/groupId&amp;gt;<br>    &amp;lt;artifactId&amp;gt;ydles_service_order_api&amp;lt;/artifactId&amp;gt;<br>    &amp;lt;version&amp;gt;1.0-SNAPSHOT&amp;lt;/version&amp;gt;<br>&amp;lt;/dependency&amp;gt;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="_4监听mq队列" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4监听mq队列">#</a> 4监听mq队列</h6><p>com.ydles.user.listener创建AddPointListener</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydles.user.listener;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.ydles.order.pojo.Task;<br><span class="hljs-keyword">import</span> com.ydles.user.config.RabbitMQConfig;<br><span class="hljs-keyword">import</span> com.ydles.user.service.UserService;<br><span class="hljs-keyword">import</span> org.apache.commons.lang.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AddPointListener</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-meta">@RabbitListener(queues = RabbitMQConfig.CG_BUYING_ADDPOINT)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receiveAddPointMessage</span><span class="hljs-params">(String message)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;用户服务接收到了任务消息&quot;</span>);<br><br>        <span class="hljs-comment">//转换消息</span><br>        <span class="hljs-type">Task</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> JSON.parseObject(message, Task.class);<br>        <span class="hljs-keyword">if</span> (task == <span class="hljs-literal">null</span> || StringUtils.isEmpty(task.getRequestBody()))&#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//判断redis中当前的任务是否存在</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> redisTemplate.boundValueOps(task.getId()).get();<br>        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="_5更新积分方法实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_5更新积分方法实现">#</a> 5更新积分方法实现</h6><p>1userService 定义接口</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> <span class="hljs-title function_">updateUserPoint</span><span class="hljs-params">(Task task)</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>实现类</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">updateUserPoint</span><span class="hljs-params">(Task task)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;用户服务现在开始对任务进行处理&quot;</span>);<br>        <span class="hljs-comment">//1.从task中获取相关数据</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> JSON.parseObject(task.getRequestBody(), Map.class);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> map.get(<span class="hljs-string">&quot;username&quot;</span>).toString();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> map.get(<span class="hljs-string">&quot;orderId&quot;</span>).toString();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">point</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) map.get(<span class="hljs-string">&quot;point&quot;</span>);<br><br>        <span class="hljs-comment">//2.判断当前的任务是否操作过</span><br>        <span class="hljs-type">PointLog</span> <span class="hljs-variable">pointLog</span> <span class="hljs-operator">=</span> pointLogMapper.findPointLogByOrderId(orderId);<br>        <span class="hljs-keyword">if</span> (pointLog != <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//3.将任务存入到redis中</span><br>        redisTemplate.boundValueOps(task.getId()).set(<span class="hljs-string">&quot;exist&quot;</span>,<span class="hljs-number">30</span>, TimeUnit.SECONDS);<br><br>        <span class="hljs-comment">//4.修改用户积分</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> userMapper.updateUserPoint(username,point);<br>        <span class="hljs-keyword">if</span> (result&amp;lt;=<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//5.记录积分日志信息</span><br>        pointLog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PointLog</span>();<br>        pointLog.setUserId(username);<br>        pointLog.setOrderId(orderId);<br>        pointLog.setPoint(point);<br>        result = pointLogMapper.insertSelective(pointLog);<br>        <span class="hljs-keyword">if</span> (result &amp;lt;= <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//6.删除redis中的任务信息</span><br>        redisTemplate.delete(task.getId());<br>        System.out.println(<span class="hljs-string">&quot;用户服务完成了更改用户积分的操作&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2dao层新建mapper,查询当前任务是否操作过</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydles.user.dao;<br><br><span class="hljs-keyword">import</span> com.ydles.user.pojo.PointLog;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Param;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Select;<br><span class="hljs-keyword">import</span> tk.mybatis.mapper.common.Mapper;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PointLogMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Mapper</span>&amp;lt;PointLog&amp;gt; &#123;<br><br>    <span class="hljs-meta">@Select(&quot;select * from tb_point_log where order_id =#&#123;orderId&#125;&quot;)</span><br>    PointLog <span class="hljs-title function_">findPointLogByOrderId</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;orderId&quot;)</span> String orderId)</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3userMapper新增一个修改用户积分方法</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydles.user.dao;<br><br><span class="hljs-keyword">import</span> com.ydles.user.pojo.User;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Param;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Update;<br><span class="hljs-keyword">import</span> tk.mybatis.mapper.common.Mapper;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Mapper</span>&amp;lt;User&amp;gt; &#123;<br><br>    <span class="hljs-meta">@Update(&quot;update tb_user set points=points+#&#123;point&#125; where username=#&#123;username&#125;&quot;)</span><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">updateUserPoint</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;username&quot;)</span>String username, <span class="hljs-meta">@Param(&quot;point&quot;)</span> <span class="hljs-type">int</span> point)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4AddPointListener完善</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydles.user.listener;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.ydles.order.pojo.Task;<br><span class="hljs-keyword">import</span> com.ydles.user.config.RabbitMQConfig;<br><span class="hljs-keyword">import</span> com.ydles.user.service.UserService;<br><span class="hljs-keyword">import</span> org.apache.commons.lang.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AddPointListener</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-meta">@RabbitListener(queues = RabbitMQConfig.CG_BUYING_ADDPOINT)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receiveAddPointMessage</span><span class="hljs-params">(String message)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;用户服务接收到了任务消息&quot;</span>);<br><br>        <span class="hljs-comment">//1转换消息</span><br>        <span class="hljs-type">Task</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> JSON.parseObject(message, Task.class);<br>        <span class="hljs-keyword">if</span> (task == <span class="hljs-literal">null</span> || StringUtils.isEmpty(task.getRequestBody()))&#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//2判断redis中当前的任务是否存在</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> redisTemplate.boundValueOps(task.getId()).get();<br>        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//3更新用户积分</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> userService.updateUserPoint(task);<br>        <span class="hljs-keyword">if</span> (result == <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//4向订单服务返回通知消息</span><br>        rabbitTemplate.convertAndSend(RabbitMQConfig.EX_BUYING_ADDPOINTUSER,RabbitMQConfig.CG_BUYING_FINISHADDPOINT_KEY,JSON.toJSONString(task));<br>        System.out.println(<span class="hljs-string">&quot;用户服务向完成添加积分队列发送了一条消息&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-4订单服务收尾" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-4订单服务收尾">#</a> 2.4订单服务收尾</h5><p>需求：</p><figure><img class="lazy" alt="image-20211209025157447" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209025157447-875bd352.png" tabindex="0"/><figcaption>image-20211209025157447</figcaption></figure><p>建立监听类DelTaskListener</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydles.order.listener;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.ydles.order.config.RabbitMQConfig;<br><span class="hljs-keyword">import</span> com.ydles.order.pojo.Task;<br><span class="hljs-keyword">import</span> com.ydles.order.service.TaskService;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DelTaskListener</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TaskService taskService;<br><br>    <span class="hljs-meta">@RabbitListener(queues = RabbitMQConfig.CG_BUYING_FINISHADDPOINT)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receiveDelTaskMessage</span><span class="hljs-params">(String message)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;订单服务接收到了删除任务操作的消息&quot;</span>);<br><br>        <span class="hljs-type">Task</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> JSON.parseObject(message, Task.class);<br><br>        <span class="hljs-comment">//删除原有的任务数据,并向历史任务表中添加记录</span><br>        taskService.delTask(task);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建taskService写出删除任务的方法</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TaskService</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">delTask</span><span class="hljs-params">(Task task)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现taskService</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydles.order.service.impl;<br><br><span class="hljs-keyword">import</span> com.ydles.order.dao.TaskHisMapper;<br><span class="hljs-keyword">import</span> com.ydles.order.dao.TaskMapper;<br><span class="hljs-keyword">import</span> com.ydles.order.pojo.Task;<br><span class="hljs-keyword">import</span> com.ydles.order.pojo.TaskHis;<br><span class="hljs-keyword">import</span> com.ydles.order.service.TaskService;<br><span class="hljs-keyword">import</span> org.springframework.beans.BeanUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br><br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TaskService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TaskHisMapper taskHisMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TaskMapper taskMapper;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delTask</span><span class="hljs-params">(Task task)</span> &#123;<br><br>        <span class="hljs-comment">//1.记录删除时间</span><br>        task.setDeleteTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">taskId</span> <span class="hljs-operator">=</span> task.getId();<br>        task.setId(<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">//2bean拷贝</span><br>        <span class="hljs-type">TaskHis</span> <span class="hljs-variable">taskHis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TaskHis</span>();<br>        BeanUtils.copyProperties(task,taskHis);<br><br>        <span class="hljs-comment">//3记录历史任务数据</span><br>        taskHisMapper.insertSelective(taskHis);<br><br>        <span class="hljs-comment">//4删除原有任务数据</span><br>        <span class="hljs-comment">//taskMapper.deleteByPrimaryKey(id);</span><br>        task.setId(id);<br>        taskMapper.delete(task);<br>        System.out.println(<span class="hljs-string">&quot;订单服务完成了添加历史任务并删除原有任务的操作&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-5效果测试" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-5效果测试">#</a> 2.5效果测试</h5><p>order user服务以dubug打开。</p><p>从头到最后一步一步测试。关键点：</p><p>1order下单任务表中数据</p><figure><img class="lazy" alt="image-20211209031308844" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209031308844-2811c4fc.png" tabindex="0"/><figcaption>image-20211209031308844</figcaption></figure><p>2order 定时任务扫描表，发信息</p><figure><img class="lazy" alt="image-20211209031315436" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209031315436-18d67ccf.png" tabindex="0"/><figcaption>image-20211209031315436</figcaption></figure><p>3user收到信息，检查redis,修改积分</p><figure><img class="lazy" alt="image-20211209031335319" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209031335319-40546e9b.png" tabindex="0"/><figcaption>image-20211209031335319</figcaption></figure><figure><img class="lazy" alt="image-20211209031344811" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209031344811-26114b41.png" tabindex="0"/><figcaption>image-20211209031344811</figcaption></figure><p>4order收到成功消息</p><figure><img class="lazy" alt="image-20211209031259362" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209031259362-016343a5.png" tabindex="0"/><figcaption>image-20211209031259362</figcaption></figure><p>总结：</p><p>1分布式事务解决方案</p><p>事务：ACID 面试必问，隔离级别，传播行为</p><p>本地事务：@transactional</p><p>分布式事务</p><p>2解决方案</p><p>2.1xa 2pc mysql</p><figure><img class="lazy" alt="image-20211208174923396" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208174923396-2412462d.png" tabindex="0"/><figcaption>image-20211208174923396</figcaption></figure><p>2.2 tcc</p><figure><img class="lazy" alt="image-20211208180127771" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208180127771-6e94911f.png" tabindex="0"/><figcaption>image-20211208180127771</figcaption></figure><p>2.3 消息队列</p><figure><img class="lazy" alt="image-20211208221414338" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211208221414338-a08cee39.png" tabindex="0"/><figcaption>image-20211208221414338</figcaption></figure><p>3Seata</p><p>4下单 使用消息队列实现分布式事务</p><figure><img class="lazy" alt="image-20211209011831937" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211209011831937-a99b3a5d.png" tabindex="0"/><figcaption>image-20211209011831937</figcaption></figure><h1 id="第13章-微信扫码支付" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第13章-微信扫码支付">#</a> 第13章 微信扫码支付</h1><p><strong>角色</strong>： 支付相关模块的开发工程师，难。</p><h2 id="学习目标-1" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#学习目标-1">#</a> 学习目标：</h2><ul><li>能够根据微信支付的开发文档调用微信支付的api</li><li>完成统一下单生成微信支付二维码功能</li><li>完成支付回调的逻辑处理</li><li>完成推送支付通知功能</li></ul><h2 id="_1-微信支付快速入门" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-微信支付快速入门">#</a> 1. 微信支付快速入门</h2><figure><img class="lazy" alt="" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/6rWmFZoS.png" tabindex="0"/><figcaption></figcaption></figure><p>native 支付文档：<a href="https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=6_1" rel="noopener noreferrer" target="_blank">https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=6_1<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="_1-1-微信支付申请-了解" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-1-微信支付申请-了解">#</a> 1.1 微信支付申请（了解）</h3><p><strong>第一步：注册公众号（类型须为：服务号）</strong></p><p>请根据营业执照类型选择以下主体注册：<a href="http://kf.qq.com/faq/120911VrYVrA151009JB3i2Q.html" rel="noopener noreferrer" target="_blank">个体工商户<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>| <a href="http://kf.qq.com/faq/120911VrYVrA151013MfYvYV.html" rel="noopener noreferrer" target="_blank">企业/公司<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>| <a href="http://kf.qq.com/faq/161220eaAJjE161220IJn6zU.html" rel="noopener noreferrer" target="_blank">政府<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>| <a href="http://kf.qq.com/faq/161220IFBJFv161220YnqAbQ.html" rel="noopener noreferrer" target="_blank">媒体<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>| <a href="http://kf.qq.com/faq/120911VrYVrA151013nYFZ7Z.html" rel="noopener noreferrer" target="_blank">其他类型<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</p><p><strong>第二步：认证公众号</strong></p><p>公众号认证后才可申请微信支付，认证费：<strong>300元/次</strong>。</p><p><strong>第三步：提交资料申请微信支付</strong></p><p>登录公众平台，点击左侧菜单【微信支付】，开始填写资料等待审核，审核时间为1-5个工作日内。</p><p><strong>第四步：开户成功，登录商户平台进行验证</strong></p><p>资料审核通过后，请登录联系人邮箱查收商户号和密码，并登录商户平台填写财付通备付金打的小额资金数额，完成账户验证。</p><p><strong>第五步：在线签署协议</strong></p><p>本协议为线上电子协议，签署后方可进行交易及资金结算，签署完立即生效。</p><p>本课程已经提供好“元动力教育”的微信支付账号，学员无需申请。</p><p>完成上述步骤，你可以得到调用API用到的账号和密钥</p><p><strong>！！！！真实地测试，所以，我们写的接口，钱都会给我们元动力。钱一定设置成1分钱。</strong></p><p><strong>appid</strong>：微信公众账号或开放平台APP的唯一标识 wxababcd122d1618eb</p><p><strong>mch_id</strong>：商户号  1611671554</p><p><strong>key</strong>：商户密钥 ydlclass66666688888YDLCLASS66688</p><h3 id="_1-2-微信支付开发文档与sdk" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-2-微信支付开发文档与sdk">#</a> 1.2 微信支付开发文档与SDK</h3><p>在线微信支付开发文档：</p><p><a href="https://pay.weixin.qq.com/wiki/doc/api/index.html" rel="noopener noreferrer" target="_blank">https://pay.weixin.qq.com/wiki/doc/api/index.html<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_1" rel="noopener noreferrer" target="_blank">https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_1<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>微信支付接口调用的整体思路：</p><p>按API要求组装参数，以XML方式发送（POST）给微信支付接口（URL）,微信支付接口也是以XML方式给予响应。程序根据返回的结果（其中包括支付URL）生成二维码或判断订单状态。</p><p>我们解压从官网下载的sdk ,安装到本地仓库</p><p>com.github.wxpay.sdk.WXPay类下提供了对应的方法：</p><table><thead><tr><th>方法名</th><th>说明</th></tr></thead><tbody><tr><td>microPay</td><td>刷卡支付</td></tr><tr><td>unifiedOrder</td><td>统一下单</td></tr><tr><td>orderQuery</td><td>查询订单</td></tr><tr><td>reverse</td><td>撤销订单</td></tr><tr><td>closeOrder</td><td>关闭订单</td></tr><tr><td>refund</td><td>申请退款</td></tr><tr><td>refundQuery</td><td>查询退款</td></tr><tr><td>downloadBill</td><td>下载对账单</td></tr><tr><td>report</td><td>交易保障</td></tr><tr><td>shortUrl</td><td>转换短链接</td></tr><tr><td>authCodeToOpenid</td><td>授权码查询openid</td></tr></tbody></table><p><strong>测试工程</strong></p><p>1创建test_pay ,导入依赖。<strong>将我的仓库com.github.wxpay相关包发给学生。</strong></p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>dependencies<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.github.wxpay<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>wxpay-sdk<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>3.0.9<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>commons-logging<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>commons-logging<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>1.2<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/dependencies<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2创建配置类 <strong>注意</strong>：包名必须为com.github.wxpay.sdk</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.github.wxpay.sdk;<br><br><span class="hljs-keyword">import</span> java.io.InputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WXPayConfig</span> &#123;<br>    <span class="hljs-comment">//正式</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getAppID</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;wxababcd122d1618eb&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMchID</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;1611671554&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//测试</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getKey</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ydlclass66666688888YDLCLASS66688&quot;</span>;<br>    &#125;<br>    <span class="hljs-comment">//正式</span><br>    <span class="hljs-comment">//public String getKey() &#123;</span><br>    <span class="hljs-comment">//    return &quot;0c804332f41cbf77b014d7096ae900f6&quot;;</span><br>    <span class="hljs-comment">//&#125;</span><br><br>    <span class="hljs-keyword">public</span> InputStream <span class="hljs-title function_">getCertStream</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> IWXPayDomain <span class="hljs-title function_">getWXPayDomain</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IWXPayDomain</span>() &#123;<br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">report</span><span class="hljs-params">(String s, <span class="hljs-type">long</span> l, Exception e)</span> &#123;<br>            &#125;<br><br>            <span class="hljs-keyword">public</span> DomainInfo <span class="hljs-title function_">getDomain</span><span class="hljs-params">(WXPayConfig wxPayConfig)</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DomainInfo</span>(<span class="hljs-string">&quot;api.mch.weixin.qq.com&quot;</span>, <span class="hljs-literal">true</span>);<br>            &#125;<br>        &#125;;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3测试类 包名随意</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ydles.test;<br><br><span class="hljs-keyword">import</span> com.github.wxpay.sdk.MyConfig;<br><span class="hljs-keyword">import</span> com.github.wxpay.sdk.WXPay;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * creste by ydles.itcast</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PayTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        MyConfig myConfig=<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyConfig</span>();<br>        WXPay wxPay=<span class="hljs-keyword">new</span> <span class="hljs-title class_">WXPay</span>(myConfig);<br><br>        <span class="hljs-comment">//根据官方文档 必填值封装数据</span><br>        Map&amp;lt;String,String&amp;gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&amp;lt;&amp;gt;();<br>        map.put(<span class="hljs-string">&quot;body&quot;</span>, <span class="hljs-string">&quot;元动力二奢&quot;</span>);<br>        map.put(<span class="hljs-string">&quot;out_trade_no&quot;</span>, <span class="hljs-string">&quot;123654&quot;</span>);<br>        map.put(<span class="hljs-string">&quot;total_fee&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>);<br>        map.put(<span class="hljs-string">&quot;spbill_create_ip&quot;</span>, <span class="hljs-string">&quot;127.0.0.1&quot;</span>);<br>        map.put(<span class="hljs-string">&quot;notify_url&quot;</span>, <span class="hljs-string">&quot;http://www.baidu.com&quot;</span>);<br>        map.put(<span class="hljs-string">&quot;trade_type&quot;</span>, <span class="hljs-string">&quot;NATIVE&quot;</span>);<br><br>        Map&amp;lt;String, String&amp;gt; resultMap = wxPay.unifiedOrder(map);<br>        System.out.println(resultMap);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4得到</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">&#123;nonce_str=l1pTBT12JvPIN0lO, code_url=weixin://wxpay/bizpayurl?pr=PFNjrIXzz, appid=wxababcd122d1618eb, sign=FF218956CA8C00145F4BACBC0AA843012E2DE2498FAAD4809769EB367582340A, trade_type=NATIVE, return_msg=OK, result_code=SUCCESS, mch_id=1611671554, return_code=SUCCESS, prepay_id=wx15174918803690023343d15a9737140000&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p><strong>QRcode</strong></p><p>1打开资源文件夹 weixinpay.html</p><figure><img class="lazy" alt="image-20211215175333830" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211215175333830-b1e5218d.png" tabindex="0"/><figcaption>image-20211215175333830</figcaption></figure><p>支付图片为qrcode.js生成。修改源代码为本人生成的，即可微信扫描。</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">qrcode.makeCode(&quot;weixin://wxpay/bizpayurl?pr=PFNjrIXzz&quot;);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img class="lazy" alt="image-20211215175246842" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211215175246842-329dfb39.png" tabindex="0"/><figcaption>image-20211215175246842</figcaption></figure><h2 id="_2-微信支付二维码" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-微信支付二维码">#</a> 2. 微信支付二维码</h2><h3 id="_2-1-需求分析" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-1-需求分析">#</a> 2.1 需求分析</h3><p>用户在提交订单后，如果是选择支付方式为微信支付，那应该跳转到微信支付二维码页面，用户扫描二维码可以进行支付，金额与订单金额相同。</p><p><strong>流程：商品详情页-----》购物车-----》订单----》支付方式pay.html------》微信支付页weixinpay.html--------》支付成功</strong></p><figure><img class="lazy" alt="image-20211221110506739" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221110506739-ccd04c86.png" tabindex="0"/><figcaption>image-20211221110506739</figcaption></figure><h3 id="_2-2-实现思路" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-2-实现思路">#</a> 2.2 实现思路</h3><p>前端页面向后端传递订单号，后端根据订单号查询订单，检查是否为当前用户的未支付订单，如果是则根据订单号和金额生成支付url返给前端，前端得到支付url生成支付二维码。</p><h3 id="_2-3-代码实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-3-代码实现">#</a> 2.3 代码实现</h3><h4 id="_2-3-1-提交订单跳转支付页" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-3-1-提交订单跳转支付页">#</a> 2.3.1 提交订单跳转支付页</h4><p><strong>订单----》支付方式pay.html</strong></p><p>1更新ydles_service_order</p><p>OrderServiceImpl中add() ,设置返回值为订单Id</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">add</span><span class="hljs-params">(Order order)</span> <br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//最后返回</span><br><span class="hljs-keyword">return</span> order.getId();<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>OrderService</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">String <span class="hljs-title function_">add</span><span class="hljs-params">(Order order)</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>OrderController</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> orderService.add(order);<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>(<span class="hljs-literal">true</span>,StatusCode.OK,<span class="hljs-string">&quot;添加成功&quot;</span>,orderId);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>2修改web-order中提交订单页面，下单成功跳转至选择支付页面。</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (response.data.flag)&#123;<br>    <span class="hljs-comment">//添加订单成功</span><br>    alert(<span class="hljs-string">&quot;添加订单成功&quot;</span>);<br>    <span class="hljs-type">var</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> response.data.data;<br>    location.href=<span class="hljs-string">&quot;/api/worder/toPayPage?orderId=&quot;</span>+orderId;<br>&#125; <span class="hljs-keyword">else</span>&#123;<br>    alert(<span class="hljs-string">&quot;添加订单失败&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3在OrderController中新增方法，用于跳转支付页</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/toPayPage&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">toPayPage</span><span class="hljs-params">(String orderId,Model model)</span>&#123;<br>    <span class="hljs-comment">//获取到订单的相关信息</span><br>    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderFeign.findById(orderId).getData();<br>    model.addAttribute(<span class="hljs-string">&quot;orderId&quot;</span>,orderId);<br>    model.addAttribute(<span class="hljs-string">&quot;payMoney&quot;</span>,order.getPayMoney());<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;pay&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4order服务中已经有方法：orderController中 根据订单id查询订单信息 findById</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 根据ID查询数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br><span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">findById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span>&#123;<br>    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.findById(id);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>(<span class="hljs-literal">true</span>,StatusCode.OK,<span class="hljs-string">&quot;查询成功&quot;</span>,order);<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>把它暴露出去 OrderFeign</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name = &quot;order&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderFeign</span> &#123;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/order&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Order order)</span>;<br><br><br>    <span class="hljs-meta">@GetMapping(&quot;/order/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&amp;lt;Order&amp;gt; findById(<span class="hljs-meta">@PathVariable</span> String id);<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>5相关页面放至resources</p><p>6测试</p><p>登陆 <a href="http://localhost:8001/api/oauth/toLogin" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/oauth/toLogin<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>添加商品： <a href="http://localhost:8001/api/wcart/add?skuId=1450862568724758528&amp;num=5" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/wcart/add?skuId=1450862568724758528&amp;num=5<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>查看购物车： <a href="http://localhost:8001/api/wcart/list" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/wcart/list<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img class="lazy" alt="image-20211221114601627" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221114601627-e567585a.png" tabindex="0"/><figcaption>image-20211221114601627</figcaption></figure><p>点击结算</p><figure><img class="lazy" alt="image-20211221114628720" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221114628720-ea35e002.png" tabindex="0"/><figcaption>image-20211221114628720</figcaption></figure><p>点击提交订单，跳转至支付页面</p><figure><img class="lazy" alt="image-20211221114637493" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221114637493-2fe67dc8.png" tabindex="0"/><figcaption>image-20211221114637493</figcaption></figure><h4 id="_2-3-2-支付微服务权限集成" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-3-2-支付微服务权限集成">#</a> 2.3.2 支付微服务权限集成</h4><figure><img class="lazy" alt="image-20211221144256113" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221144256113-e80b69c9.png" tabindex="0"/><figcaption>image-20211221144256113</figcaption></figure><p>1service二级目录下，新建微服务ydles_service_pay</p><p>2依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>dependencies<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.ydles<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>ydles_common<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>1.0-SNAPSHOT<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.github.wxpay<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>wxpay-sdk<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>3.0.9<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework.boot<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-boot-starter<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>exclusions<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>exclusion<span class="hljs-symbol">&amp;gt;</span><br>                <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework.boot<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>                <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-boot-starter-logging<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>/exclusion<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>/exclusions<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework.boot<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-boot-starter-amqp<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/dependencies<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3配置文件 application.yml</p><div class="language-yaml line-numbers-mode" data-ext="yml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight yaml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9010</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">pay</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.128</span><br>  <span class="hljs-attr">main:</span><br>    <span class="hljs-attr">allow-bean-definition-overriding:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#当遇到同样名字的时候，是否允许覆盖注册</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:6868/eureka</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">wxpay:</span><br>  <span class="hljs-attr">notify_url:</span> <span class="hljs-string">http://itlils.cross.echosite.cn/wxpay/notify</span> <span class="hljs-comment">#回调地址</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4微信支付配置类，copy。注意包名</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.github.wxpay.sdk;<br><br><span class="hljs-keyword">import</span> java.io.InputStream;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Created</span> by IT李老师</span><br><span class="hljs-comment"> * 公主号 “IT李哥交朋友”</span><br><span class="hljs-comment"> * 个人微 itlils</span><br><span class="hljs-comment"> *  微信支付配置类，放着商户的相关信息</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WXPayConfig</span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    String <span class="hljs-title function_">getAppID</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;wxababcd122d1618eb&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    String <span class="hljs-title function_">getMchID</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;1611671554&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    String <span class="hljs-title function_">getKey</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ydlclass66666688888YDLCLASS66688&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    InputStream <span class="hljs-title function_">getCertStream</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    IWXPayDomain <span class="hljs-title function_">getWXPayDomain</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IWXPayDomain</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">report</span><span class="hljs-params">(String s, <span class="hljs-type">long</span> l, Exception e)</span> &#123;<br><br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> DomainInfo <span class="hljs-title function_">getDomain</span><span class="hljs-params">(WXPayConfig wxPayConfig)</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DomainInfo</span>(<span class="hljs-string">&quot;api.mch.weixin.qq.com&quot;</span>, <span class="hljs-literal">true</span>);<br>            &#125;<br>        &#125;;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>5启动类 com.ydles.pay下</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydles.pay;<br><span class="hljs-keyword">import</span> com.github.wxpay.sdk.MyConfig;<br><span class="hljs-keyword">import</span> com.github.wxpay.sdk.WXPay;<br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaClient</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PayApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(PayApplication.class,args);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> WXPay <span class="hljs-title function_">wxPay</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WXPay</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyConfig</span>());<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span>  <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-3-支付微服务-下单" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-3-3-支付微服务-下单">#</a> 2.3.3 支付微服务-下单</h4><p>ydles_service_pay服务</p><p>（1）创建com.ydles.pay.service包，包下创建接口WxPayService</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydles.pay.service;<br><br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Created</span> by IT李老师</span><br><span class="hljs-comment"> * 公主号 “IT李哥交朋友”</span><br><span class="hljs-comment"> * 个人微 itlils</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WxPayService</span> &#123;<br>    <span class="hljs-comment">//微信下单要二维码</span><br>    <span class="hljs-keyword">public</span> Map <span class="hljs-title function_">nativePay</span><span class="hljs-params">(String orderId,Integer money)</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）创建com.ydles.pay.service.impl 包 ,新增服务类WxPayServiceImpl 拓展：涉及钱的计算，注意用BigDecimal <a href="https://www.cnblogs.com/zhangyinhua/p/11545305.html" rel="noopener noreferrer" target="_blank">https://www.cnblogs.com/zhangyinhua/p/11545305.html<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Created</span> by IT李老师</span><br><span class="hljs-comment"> * 公主号 “IT李哥交朋友”</span><br><span class="hljs-comment"> * 个人微 itlils</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WxPayServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WxPayService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    WXPay wxPay;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Map <span class="hljs-title function_">nativePay</span><span class="hljs-params">(String orderId, Integer money)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//根据官方文档 请求接口</span><br>            Map&amp;lt;String, String&amp;gt; reqData=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&amp;lt;&amp;gt;();<br>            reqData.put(<span class="hljs-string">&quot;body&quot;</span>,<span class="hljs-string">&quot;动力二奢下单支付&quot;</span>);<br>            reqData.put(<span class="hljs-string">&quot;out_trade_no&quot;</span>, orderId);<br><br>            <span class="hljs-comment">//金钱计算 BigDecimal:金额和计算都用他的</span><br>            BigDecimal yuan=<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">&quot;0.01&quot;</span>);<br>            BigDecimal beishu=<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">100</span>);<br>            <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">fen</span> <span class="hljs-operator">=</span> yuan.multiply(beishu);<br>            fen=fen.setScale(<span class="hljs-number">0</span>,BigDecimal.ROUND_UP);<br>            reqData.put(<span class="hljs-string">&quot;total_fee&quot;</span>, String.valueOf(fen));<br><br>            reqData.put(<span class="hljs-string">&quot;spbill_create_ip&quot;</span>, <span class="hljs-string">&quot;192.168.1.1&quot;</span>);<br>            reqData.put(<span class="hljs-string">&quot;notify_url&quot;</span>, <span class="hljs-string">&quot;http://www.baidu.com&quot;</span>);<br>            reqData.put(<span class="hljs-string">&quot;trade_type&quot;</span>, <span class="hljs-string">&quot;NATIVE&quot;</span>);<br><br>            Map&amp;lt;String, String&amp;gt; resultMap = wxPay.unifiedOrder(reqData);<br>            System.out.println(resultMap);<br>            <span class="hljs-keyword">return</span> resultMap;<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（3）创建com.ydles.pay.controller包 ，新增WxPayController</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Created</span> by IT李老师</span><br><span class="hljs-comment"> * 公主号 “IT李哥交朋友”</span><br><span class="hljs-comment"> * 个人微 itlils</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/wxpay&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WxPayController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    WxPayService wxPayService;<br><br>    <span class="hljs-comment">//微信下单</span><br>    <span class="hljs-meta">@GetMapping(&quot;/nativePay&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&amp;lt;Map&amp;gt; nativePay(<span class="hljs-meta">@RequestParam(&quot;orderId&quot;)</span>String orderId,<span class="hljs-meta">@RequestParam(&quot;money&quot;)</span>Integer money)&#123;<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> wxPayService.nativePay(orderId, money);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>(<span class="hljs-literal">true</span>, StatusCode.OK,<span class="hljs-string">&quot;微信下单成功&quot;</span>,map);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试：<a href="http://localhost:9010/wxpay/nativePay?orderId=123321&amp;money=1" rel="noopener noreferrer" target="_blank">http://localhost:9010/wxpay/nativePay?orderId=123321&amp;money=1<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 订单号可能重复，大家换一下就好了。</p><figure><img class="lazy" alt="image-20211221150107575" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221150107575-b9d3c8e2.png" tabindex="0"/><figcaption>image-20211221150107575</figcaption></figure><h4 id="_2-3-3-支付渲染页面微服务" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-3-3-支付渲染页面微服务">#</a> 2.3.3 支付渲染页面微服务</h4><p><strong>支付方式pay.html------》微信支付页weixinpay.html</strong></p><p>页面需要调用我们的微服务，所以：</p><figure><img class="lazy" alt="image-20211221151905932" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221151905932-a25f40c9.png" tabindex="0"/><figcaption>image-20211221151905932</figcaption></figure><p>（1）新增ydles_service_pay_api模块 ，pom.xml中加入依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>dependencies<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.ydles<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>ydles_common<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>1.0-SNAPSHOT<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/dependencies<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>新增com.ydles.pay.feign包，包下创建接口</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name = &quot;pay&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PayFeign</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/wxpay/nativePay&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">nativePay</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;orderId&quot;)</span> String orderId, <span class="hljs-meta">@RequestParam(&quot;money&quot;)</span> Integer money)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）ydles_web_order的pom.xml加入依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.ydles<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>ydles_service_pay_api<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>1.0-SNAPSHOT<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动类增加扫包</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">@EnableFeignClients(basePackages = &#123;&quot;com.ydles.pay.feign&quot;,&quot;com.ydles.order.feign&quot;,&quot;com.ydles.user.feign&quot;&#125;)<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img class="lazy" alt="image-20211221152256881" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221152256881-6a50d8de.png" tabindex="0"/><figcaption>image-20211221152256881</figcaption></figure><p>ydles_web_order新增PayController</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/wxpay&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PayController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderFeign orderFeign;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> PayFeign payFeign;<br><br>    <span class="hljs-comment">//跳转到微信支付二维码页面</span><br>    <span class="hljs-meta">@GetMapping</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">wxPay</span><span class="hljs-params">(String orderId , Model model)</span>&#123;<br>        <span class="hljs-comment">//1.根据orderid查询订单,如果订单不存在,跳转到错误页面</span><br>        Result&amp;lt;Order&amp;gt; orderResult = orderFeign.findById(orderId);<br>        <span class="hljs-keyword">if</span> (orderResult.getData() == <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;fail&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//2.根据订单的支付状态进行判断,如果不是未支付的订单,跳转到错误页面</span><br>        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderResult.getData();<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-string">&quot;0&quot;</span>.equals(order.getPayStatus()))&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;fail&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//3.基于payFeign调用统计下单接口,并获取返回结果</span><br>        <span class="hljs-type">Result</span> <span class="hljs-variable">payResult</span> <span class="hljs-operator">=</span> payFeign.nativePay(orderId, order.getPayMoney());<br>        <span class="hljs-keyword">if</span> (payResult.getData() == <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;fail&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//4.封装结果数据</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">payMap</span> <span class="hljs-operator">=</span> (Map) payResult.getData();<br>        payMap.put(<span class="hljs-string">&quot;orderId&quot;</span>,orderId);<br>        payMap.put(<span class="hljs-string">&quot;payMoney&quot;</span>,order.getPayMoney());<br><br>        model.addAllAttributes(payMap);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;wxpay&quot;</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（4）将静态原型中wxpay.html拷贝到templates文件夹下作为模板，修改模板，部分代码如下：</p><p>二维码地址渲染</p><div class="language-html line-numbers-mode" data-ext="html"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight html"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">qrcode.makeCode([[$&#123;code_url&#125;]]);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>查看显示订单号与金额</p><div class="language-html line-numbers-mode" data-ext="html"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight html"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-symbol">&amp;lt;</span>h4 class=&quot;fl tit-txt&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>span class=&quot;success-icon&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>span  class=&quot;success-info&quot; th:text=&quot;|订单提交成功，请您及时付款！订单号：$&#123;orderId&#125;|&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/h4<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>span class=&quot;fr&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>em class=&quot;sui-lead&quot;<span class="hljs-symbol">&amp;gt;</span>应付金额：<span class="hljs-symbol">&amp;lt;</span>/em<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>em  class=&quot;orange money&quot; th:text=&quot;$&#123;#numbers.formatDecimal(payMoney/100.0,1,2)&#125;&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/em<span class="hljs-symbol">&amp;gt;</span>元<span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>pay.html</p><div class="language-html line-numbers-mode" data-ext="html"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight html"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-symbol">&amp;lt;</span>li<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>a th:href=&quot;|/api/wxpay?orderId=$&#123;orderId&#125;|&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>img src=&quot;/./image/_/pay3.jpg&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/a<span class="hljs-symbol">&amp;gt;</span> <span class="hljs-symbol">&amp;lt;</span>/li<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img class="lazy" alt="image-20211221154450109" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221154450109-0d8fe381.png" tabindex="0"/><figcaption>image-20211221154450109</figcaption></figure><p>ydles_gateway_web项目的application.yml文件加入</p><div class="language-yaml line-numbers-mode" data-ext="yml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight yaml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#购物车订单渲染微服务</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">ydles_order_web_route</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://order-web</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/wcart/**,/api/worder/**,/api/wxpay/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看ydles_gateway_web项目的UrlFilter.java中</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">orderFilterPath</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/api/wpay,/api/wpay/**,/api/worder/**,/api/user/**,</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p><strong>测试</strong></p><p>1重启gatewaty-web service-pay web-order</p><p>2添加商品： <a href="http://localhost:8001/api/wcart/add?skuId=1450862568724758528&amp;num=5" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/wcart/add?skuId=1450862568724758528&amp;num=5<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img class="lazy" alt="image-20211221162207178" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221162207178-7d37ab54.png" tabindex="0"/><figcaption>image-20211221162207178</figcaption></figure><p>3查看购物车： <a href="http://localhost:8001/api/wcart/list" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/wcart/list<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img class="lazy" alt="image-20211221162214876" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221162214876-3626ccaa.png" tabindex="0"/><figcaption>image-20211221162214876</figcaption></figure><p>4点击：结算---》提交订单--》选择微信支付--》跳到二维码页面--》扫描二维码，你将损失1分钱。</p><figure><img class="lazy" alt="image-20211221200858087" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221200858087-5edd9c41.png" tabindex="0"/><figcaption>image-20211221200858087</figcaption></figure><h2 id="_3-支付回调逻辑处理" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-支付回调逻辑处理">#</a> 3. 支付回调逻辑处理</h2><figure><img class="lazy" alt="image-20211221203416360" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221203416360-61d74041.png" tabindex="0"/><figcaption>image-20211221203416360</figcaption></figure><h3 id="_3-1-需求分析" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-1-需求分析">#</a> 3.1 需求分析</h3><p>在完成支付后，修改订单状态为已支付，并记录订单日志。</p><h3 id="_3-2-实现思路" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-2-实现思路">#</a> 3.2 实现思路</h3><p>（1）接受微信支付平台的回调信息（xml）</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>xml<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>appid<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[wx8397f8696b538317]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/appid<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>bank_type<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[CFT]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/bank_type<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>cash_fee<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[1]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/cash_fee<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>fee_type<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[CNY]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/fee_type<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>is_subscribe<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[N]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/is_subscribe<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>mch_id<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[1473426802]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/mch_id<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>nonce_str<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[c6bea293399a40e0a873df51e667f45a]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/nonce_str<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>openid<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[oNpSGwbtNBQROpN_dL8WUZG3wRkM]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/openid<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>out_trade_no<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[1553063775279]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/out_trade_no<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>result_code<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[SUCCESS]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/result_code<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>return_code<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[SUCCESS]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/return_code<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>sign<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[DD4E5DF5AF8D8D8061B0B8BF210127DE]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/sign<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>time_end<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[20190320143646]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/time_end<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>total_fee<span class="hljs-symbol">&amp;gt;</span>1<span class="hljs-symbol">&amp;lt;</span>/total_fee<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>trade_type<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[NATIVE]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/trade_type<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>transaction_id<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[4200000248201903206581106357]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/transaction_id<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/xml<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）收到通知后，调用查询接口查询订单。</p><p>（3）如果支付结果为成功，则调用修改订单状态和记录订单日志的方法。</p><h3 id="_3-3-代码实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-代码实现">#</a> 3.3 代码实现</h3><h4 id="_3-3-1-内网穿透工具" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-1-内网穿透工具">#</a> 3.3.1 内网穿透工具</h4><p>natapp <a href="https://natapp.cn/" rel="noopener noreferrer" target="_blank">https://natapp.cn/<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img class="lazy" alt="image-20211221204125489" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221204125489-5f8703f8.png" tabindex="0"/><figcaption>image-20211221204125489</figcaption></figure><h4 id="_3-3-2下载配置文件和客户端" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-2下载配置文件和客户端">#</a> 3.3.2下载配置文件和客户端</h4><p>如何使用：<a href="https://natapp.cn/article/natapp_newbie" rel="noopener noreferrer" target="_blank">https://natapp.cn/article/natapp_newbie<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>解压资料，将配置文件与程序平行放置。修改配置文件。</p><figure><img class="lazy" alt="image-20211221205259145" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/x4cl3YeZ.png" tabindex="0"/><figcaption>image-20211221205259145</figcaption></figure><figure><img class="lazy" alt="image-20211221205320127" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221205320127-d3014723.png" tabindex="0"/><figcaption>image-20211221205320127</figcaption></figure><h4 id="_3-3-3-启动" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-3-启动">#</a> <strong>3.3.3 启动</strong></h4><p>双击natapp.exe</p><figure><img class="lazy" alt="image-20211221205424476" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221205424476-a7e3fbf7.png" tabindex="0"/><figcaption>image-20211221205424476</figcaption></figure><p>外网地址默认映射本地的80端口 可以修改</p><figure><img class="lazy" alt="image-20211221205450080" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221205450080-c69f4636.png" tabindex="0"/><figcaption>image-20211221205450080</figcaption></figure><h4 id="_3-3-4-测试" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-4-测试">#</a> <strong>3.3.4 测试</strong></h4><p>1ydles_service_pay 微服务 WXPayController 增加一个测试方法</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/notify&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyLogic</span><span class="hljs-params">()</span> &#123;<br>    System.out.println(<span class="hljs-string">&quot;支付成功回调&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2重启ydles_service_pay</p><p>3访问 <a href="http://localhost:9010/wxpay/notify" rel="noopener noreferrer" target="_blank">http://localhost:9010/wxpay/notify<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 程序打印输出</p><figure><img class="lazy" alt="image-20211221205220246" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221205221905-f5d79981.png" tabindex="0"/><figcaption>image-20211221205220246</figcaption></figure><p>4访问 <a href="http://lizihao.cross.echosite.cn/wxpay/notify" rel="noopener noreferrer" target="_blank">http://lizihao.cross.echosite.cn/wxpay/notify<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 程序打印输出</p><figure><img class="lazy" alt="image-20211221205221905" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221205221905-f5d79981.png" tabindex="0"/><figcaption>image-20211221205221905</figcaption></figure><h4 id="_3-3-5-接收回调信息" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-5-接收回调信息">#</a> 3.3.5 接收回调信息</h4><p>1 修改支付微服务配置文件</p><div class="language-yaml line-numbers-mode" data-ext="yml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight yaml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">wxpay:</span><br>  <span class="hljs-attr">notify_url:</span> <span class="hljs-string">http://mp93g5.natappfree.cc/wxpay/notify</span> <span class="hljs-comment">#回调地址</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>2修改WxPayServiceImpl ，引入</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Value(&quot;$&#123;wxpay.notify_url&#125;&quot;)</span><br><span class="hljs-keyword">private</span> String notifyUrl;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>3修改WxPayServiceImpl 的nativePay方法</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">map.put(<span class="hljs-string">&quot;notify_url&quot;</span>,notifyUrl);<span class="hljs-comment">//回调地址</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>4测试：</p><p>4.1重启ydles_service_pay</p><p>4.2添加商品： <a href="http://localhost:8001/api/wcart/add?skuId=1450862568724758528&amp;num=5" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/wcart/add?skuId=1450862568724758528&amp;num=5<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>4.3查看购物车： <a href="http://localhost:8001/api/wcart/list" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/wcart/list<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img class="lazy" alt="image-20211221232224662" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221232224662-b901e7ea.png" tabindex="0"/><figcaption>image-20211221232224662</figcaption></figure><p>4.4点击：结算---》提交订单--》选择微信支付--》跳到二维码页面--》扫描二维码 查看可以回调多次</p><figure><img class="lazy" alt="image-20211221232328432" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221232328432-ed3fc658.png" tabindex="0"/><figcaption>image-20211221232328432</figcaption></figure><p>为什么多次回调？ <a href="https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_7&amp;index=8" rel="noopener noreferrer" target="_blank">https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_7&amp;index=8<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">注意：<br>1、同样的通知可能会多次发送给商户系统。商户系统必须能够正确处理重复的通知。<br>2、后台通知交互时，如果微信收到商户的应答不符合规范或超时，微信会判定本次通知失败，重新发送通知，直到成功为止（在通知一直不成功的情况下，微信总共会发起多次通知，通知频率为15s/15s/30s/3m/10m/20m/30m/30m/30m/60m/3h/3h/3h/6h/6h - 总计 24h4m），但微信不保证通知最终一定能成功。<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-3-6-处理回调通知-重点" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-6-处理回调通知-重点">#</a> 3.3.6 处理回调通知-重点</h4><p>1资源文件夹 ConvertUtils 放到 common工程的utils包下</p><p>2微信支付平台发送给回调地址的是二进制流，我们需要提取二进制流转换为字符串，这个字符串就是xml格式。</p><p>修改notify方法</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 回调</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RequestMapping(&quot;/notify&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">wxPayNotify</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    System.out.println(<span class="hljs-string">&quot;支付成功回调。。。。&quot;</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//1输入流转换为字符串</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">xml</span> <span class="hljs-operator">=</span> ConvertUtils.convertToString(request.getInputStream());<br>            System.out.println(xml);<br><br>        <span class="hljs-comment">//如果成功，给微信支付一个成功的响应</span><br>        <span class="hljs-comment">//响应数据设置</span><br>        <span class="hljs-comment">//2给微信一个结果通知</span><br>            response.setContentType(<span class="hljs-string">&quot;text/xml&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&amp;lt;xml&amp;gt;&amp;lt;return_code&amp;gt;&amp;lt;![CDATA[SUCCESS]]&amp;gt;&amp;lt;/return_code&amp;gt;&amp;lt;return_msg&amp;gt;&amp;lt;![CDATA[OK]]&amp;gt;&amp;lt;/return_msg&amp;gt;&amp;lt;/xml&amp;gt;&quot;</span>;<br>            response.getWriter().write(data);<br><br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>**注意：**1、同样的通知可能会多次发送给商户系统。商户系统必须能够正确处理重复的通知。2、后台通知交互时，如果微信收到商户的应答不符合规范或超时，微信会判定本次通知失败，重新发送通知，直到成功为止（在通知一直不成功的情况下，微信总共会发起10次通知，通知频率为15s/15s/30s/3m/10m/20m/30m/30m/30m/60m/3h/3h/3h/6h/6h - 总计 24h4m），但微信不保证通知最终一定能成功。</p><p>测试后，在控制台看到输出的消息</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs xml">访问到 notify接口了！<br><span class="hljs-symbol">&amp;lt;</span>xml<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>appid<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[wxababcd122d1618eb]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/appid<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>bank_type<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[OTHERS]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/bank_type<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>cash_fee<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[1]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/cash_fee<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>fee_type<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[CNY]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/fee_type<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>is_subscribe<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[Y]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/is_subscribe<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>mch_id<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[1611671554]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/mch_id<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>nonce_str<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[WNXFCMMCQSYiM09qrr4nwDH41iJnwuSs]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/nonce_str<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>openid<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[o9tV755anFQYm27bYNC1ALQ5Ovfs]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/openid<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>out_trade_no<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[1473316925973991424]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/out_trade_no<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>result_code<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[SUCCESS]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/result_code<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>return_code<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[SUCCESS]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/return_code<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>sign<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[E6A69A88C986B64411ACB2DA7E945EB48BF6391C06B0972DA6AEC80C00FC74F9]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/sign<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>time_end<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[20211221233851]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/time_end<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>total_fee<span class="hljs-symbol">&amp;gt;</span>1<span class="hljs-symbol">&amp;lt;</span>/total_fee<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>trade_type<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[NATIVE]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/trade_type<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>transaction_id<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>![CDATA[4200001414202112216382710751]]<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/transaction_id<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/xml<span class="hljs-symbol">&amp;gt;</span><br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们可以将此xml字符串，转换为map，提取其中的out_trade_no（订单号），根据订单号修改订单状态。</p><h4 id="_3-3-7-收到微信通知后的逻辑" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-7-收到微信通知后的逻辑">#</a> 3.3.7 收到微信通知后的逻辑</h4><p><strong>支付服务：查询订单验证通知</strong></p><figure><img class="lazy" alt="image-20211221235105274" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221235105274-6db9cee5.png" tabindex="0"/><figcaption>image-20211221235105274</figcaption></figure><p>微信方面查询订单如何做 <a href="https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_2" rel="noopener noreferrer" target="_blank">https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_2<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img class="lazy" alt="image-20211221235203111" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221235203111-b2b94980.png" tabindex="0"/><figcaption>image-20211221235203111</figcaption></figure><p>（1）WxPayService新增方法定义</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 查询订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> orderId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>Map <span class="hljs-title function_">queryOrder</span><span class="hljs-params">(String orderId)</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）WxPayServiceImpl实现方法</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Map <span class="hljs-title function_">queryOrder</span><span class="hljs-params">(String orderId)</span> &#123;<br>    <span class="hljs-keyword">try</span>&#123;<br>        Map&amp;lt;String ,String&amp;gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;out_trade_no&quot;</span>,orderId);<br>        Map&amp;lt;String, String&amp;gt; resultMap = wxPay.orderQuery(map);<br>        <span class="hljs-keyword">return</span> resultMap;<br>    &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>        e.printStackTrace();<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（3）修改notify方法</p><p>下单：</p><figure><img class="lazy" alt="image-20211222001359665" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222001359665-5c78ed50.png" tabindex="0"/><figcaption>image-20211222001359665</figcaption></figure><p>下单<strong>通知</strong>成功与否在哪儿？ <a href="https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_7&amp;index=8" rel="noopener noreferrer" target="_blank">https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_7&amp;index=8<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img class="lazy" alt="image-20200305014740028" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/R1OAAAAA.png" tabindex="0"/><figcaption>image-20200305014740028</figcaption></figure><p>我们的<strong>订单号</strong>在哪儿？ 在下单后微信回调的请求里。</p><figure><img class="lazy" alt="image-20211221235940049" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221235940049-37e099e7.png" tabindex="0"/><figcaption>image-20211221235940049</figcaption></figure><figure><img class="lazy" alt="image-20200305012941294" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200305012941294-3c13dd66.png" tabindex="0"/><figcaption>image-20200305012941294</figcaption></figure><p>=================================================================================================</p><p>查询：<a href="https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_2" rel="noopener noreferrer" target="_blank">https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_2<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><strong>查询结果</strong>如何？</p><figure><img class="lazy" alt="image-20200305015926052" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200305015926052-167e538f.png" tabindex="0"/><figcaption>image-20200305015926052</figcaption></figure><p>查询<strong>订单结果</strong>结果如何？</p><figure><img class="lazy" alt="image-20200305015403233" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/wP4kBM5a.png" tabindex="0"/><figcaption>image-20200305015403233</figcaption></figure><p>此次查询下单我们商品的订单号是什么？</p><figure><img class="lazy" alt="image-20200305020047787" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200305020047787-0115833e.png" tabindex="0"/><figcaption>image-20200305020047787</figcaption></figure><p>此次支付动作的id在哪儿？</p><figure><img class="lazy" alt="image-20200305015219298" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200305015219298-084b4177.png" tabindex="0"/><figcaption>image-20200305015219298</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/wxpay&quot;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WXPayController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> WXPayService wxPayService;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-comment">//下单</span><br>    <span class="hljs-meta">@GetMapping(&quot;/nativePay&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">nativePay</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;orderId&quot;)</span> String orderId, <span class="hljs-meta">@RequestParam(&quot;money&quot;)</span> Integer money)</span> &#123;<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> wxPayService.nativePay(orderId, money);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>(<span class="hljs-literal">true</span>, StatusCode.OK, <span class="hljs-string">&quot;&quot;</span>, resultMap);<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/notify&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyLogic</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;支付成功回调&quot;</span>);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//1输入流转换为字符串</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">xml</span> <span class="hljs-operator">=</span> ConvertUtils.convertToString(request.getInputStream());<br>            System.out.println(xml);<br><br>            <span class="hljs-comment">//3基于微信发送的通知内容,完成后续的业务逻辑处理</span><br>            Map&amp;lt;String, String&amp;gt; map = WXPayUtil.xmlToMap(xml);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;SUCCESS&quot;</span>.equals(map.get(<span class="hljs-string">&quot;result_code&quot;</span>))) &#123;<br><br>                <span class="hljs-comment">//查询订单</span><br>                <span class="hljs-type">Map</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> wxPayService.queryOrder(map.get(<span class="hljs-string">&quot;out_trade_no&quot;</span>));<br>                System.out.println(<span class="hljs-string">&quot;查询订单结果:&quot;</span> + result);<br><br>                <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;SUCCESS&quot;</span>.equals(result.get(<span class="hljs-string">&quot;result_code&quot;</span>))) &#123;<br><br>                    <span class="hljs-comment">//将订单的消息发送到mq&#x27;</span><br>                    <span class="hljs-type">Map</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>                    message.put(<span class="hljs-string">&quot;orderId&quot;</span>, result.get(<span class="hljs-string">&quot;out_trade_no&quot;</span>));<br>                    message.put(<span class="hljs-string">&quot;transactionId&quot;</span>, result.get(<span class="hljs-string">&quot;transaction_id&quot;</span>));<br><br>                    <span class="hljs-comment">//消息的发送</span><br>                    rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;&quot;</span>, RabbitMQConfig.ORDER_PAY, JSON.toJSONString(message));<br><br><br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">//输出错误原因</span><br>                    System.out.println(map.get(<span class="hljs-string">&quot;err_code_des&quot;</span>));<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//输出错误原因</span><br>                System.out.println(map.get(<span class="hljs-string">&quot;err_code_des&quot;</span>));<br>            &#125;<br><br>            <span class="hljs-comment">//2给微信一个结果通知</span><br>            response.setContentType(<span class="hljs-string">&quot;text/xml&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&amp;lt;xml&amp;gt;&amp;lt;return_code&amp;gt;&amp;lt;![CDATA[SUCCESS]]&amp;gt;&amp;lt;/return_code&amp;gt;&amp;lt;return_msg&amp;gt;&amp;lt;![CDATA[OK]]&amp;gt;&amp;lt;/return_msg&amp;gt;&amp;lt;/xml&amp;gt;&quot;</span>;<br>            response.getWriter().write(data);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>config包下增加rebbitMQ配置类。并检查依赖和配置文件。</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydles.pay.config;<br><br><span class="hljs-keyword">import</span> org.springframework.amqp.core.Queue;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabbitMQConfig</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String ORDER_PAY=<span class="hljs-string">&quot;order_pay&quot;</span>;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">queue</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(ORDER_PAY);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-3-8-订单服务修改订单状态" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-8-订单服务修改订单状态">#</a> 3.3.8 订单服务修改订单状态</h4><p>需求：</p><figure><img class="lazy" alt="image-20211222001437864" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222001437864-e80a71e6.png" tabindex="0"/><figcaption>image-20211222001437864</figcaption></figure><p>1rabbitMQ配置类，把支付服务定义的队列定义</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String ORDER_PAY=<span class="hljs-string">&quot;order_pay&quot;</span>;<br><br><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">queue</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(ORDER_PAY);<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2 com.ydles.order.listener包下创建OrderPayListener</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderPayListener</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderService orderService;<br><br>    <span class="hljs-meta">@RabbitListener(queues = RabbitMQConfig.ORDER_PAY)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receivePayMessage</span><span class="hljs-params">(String message)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;接收到了订单支付的消息:&quot;</span> + message);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> JSON.parseObject(message, Map.class);<br>        <span class="hljs-comment">//调用业务层,完成订单数据库的修改</span><br>        orderService.updatePayStatus((String) map.get(<span class="hljs-string">&quot;orderId&quot;</span>), (String) map.get(<span class="hljs-string">&quot;transactionId&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3OrderService接口新增方法定义</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 修改订单状态为已支付</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> orderId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> transactionId</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">updatePayStatus</span><span class="hljs-params">(String orderId,String transactionId)</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4OrderServiceImpl新增方法实现</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> OrderLogMapper orderLogMapper;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updatePayStatus</span><span class="hljs-params">(String orderId, String transactionId)</span> &#123;<br>    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectByPrimaryKey(orderId);<br>    <span class="hljs-keyword">if</span>(order!=<span class="hljs-literal">null</span>  &amp;amp;&amp;amp; <span class="hljs-string">&quot;0&quot;</span>.equals(order.getPayStatus()))&#123;  <span class="hljs-comment">//存在订单且状态为0</span><br>        order.setPayStatus(<span class="hljs-string">&quot;1&quot;</span>);<br>        order.setOrderStatus(<span class="hljs-string">&quot;1&quot;</span>);<br>        order.setUpdateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        order.setPayTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        order.setTransactionId(transactionId);<span class="hljs-comment">//微信返回的交易流水号</span><br>        orderMapper.updateByPrimaryKeySelective(order);<br>        <span class="hljs-comment">//记录订单变动日志</span><br>        OrderLog orderLog=<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderLog</span>();<br>        orderLog.setId( idWorker.nextId()+<span class="hljs-string">&quot;&quot;</span> );<br>        orderLog.setOperater(<span class="hljs-string">&quot;system&quot;</span>);<span class="hljs-comment">// 系统</span><br>        orderLog.setOperateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<span class="hljs-comment">//当前日期</span><br>        orderLog.setOrderStatus(<span class="hljs-string">&quot;1&quot;</span>);<br>        orderLog.setPayStatus(<span class="hljs-string">&quot;1&quot;</span>);<br>        orderLog.setRemarks(<span class="hljs-string">&quot;支付流水号&quot;</span>+transactionId);<br>        orderLog.setOrderId(order.getId());<br>        orderLogMapper.insertSelective(orderLog);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-3-9-整个流程测试" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-9-整个流程测试">#</a> 3.3.9 整个流程测试</h4><p>1重启ydles_service_pay ydles_service_order</p><p>2添加商品： <a href="http://localhost:8001/api/cart/addCart?skuId=100000006163&amp;num=10" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/cart/addCart?skuId=100000006163&amp;num=10<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>3查看购物车： <a href="http://localhost:8001/api/wcart/list" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/wcart/list<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>4点击：结算---》提交订单--》选择微信支付--》跳到二维码页面--》扫描二维码</p><p>4.1扫码支付之前，查看订单状态</p><p>4.1扫码支付之后，查看订单状态</p><figure><img class="lazy" alt="image-20211222003719250" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222003719250-574a7d55.png" tabindex="0"/><figcaption>image-20211222003719250</figcaption></figure><p>订单日志表，也有一条数据了</p><figure><img class="lazy" alt="image-20211222003728955" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222003728955-4ad46170.png" tabindex="0"/><figcaption>image-20211222003728955</figcaption></figure><h2 id="_4-推送支付通知" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-推送支付通知">#</a> 4. 推送支付通知</h2><h3 id="_4-1-需求分析" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-1-需求分析">#</a> 4.1 需求分析</h3><p>当用户完成扫码支付后，跳转到支付成功页面</p><h3 id="_4-2-服务端推送方案" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-2-服务端推送方案">#</a> 4.2 服务端推送方案</h3><p>需求：我们需要将支付的结果通知前端页面，其实就是我们通过所说的服务器端推送，主要有三种实现方案</p><p>（1）Ajax 短轮询 setInterval Ajax 轮询主要通过页面端的 JS 定时异步刷新任务来实现数据的加载</p><p>如果我们使用ajax短轮询方式，需要后端提供方法，通过调用微信支付接口实现根据订单号查询支付状态的方法（参见查询订单API） 。 前端每间隔三秒查询一次，如果后端返回支付成功则执行页面跳转。</p><p>缺点：这种方式实时效果较差，而且对服务端的压力也较大。</p><p>（2）长轮询</p><p>长轮询主要也是通过 Ajax 机制，但区别于传统的 Ajax 应用，长轮询的服务器端会在没有数据时阻塞请求直到有新的数据产生或者请求超时才返回，之后客户端再重新建立连接获取数据。</p><p>如果使用长轮询，也同样需要后端提供方法，通过调用微信支付接口实现根据订单号查询支付状态的方法，只不过循环是写在后端的。</p><p>缺点：长轮询服务端会长时间地占用资源，如果消息频繁发送的话会给服务端带来较大的压力。</p><p>（3）WebSocket 双向通信 WebSocket 是 HTML5 中一种新的通信协议，能够实现浏览器与服务器之间全双工通信。如果浏览器和服务端都支持 WebSocket 协议的话，该方式实现的消息推送无疑是最高效、简洁的。并且最新版本的 IE、Firefox、Chrome 等浏览器都已经支持 WebSocket 协议，Apache Tomcat 7.0.27 以后的版本也开始支持 WebSocket。</p><h3 id="_4-3-rabbitmq-web-stomp-插件" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-3-rabbitmq-web-stomp-插件">#</a> 4.3 RabbitMQ Web STOMP 插件</h3><p>借助于 RabbitMQ 的 Web STOMP 插件，实现浏览器与服务端的全双工通信。从本质上说，RabbitMQ 的 Web STOMP 插件也是利用 WebSocket 对 STOMP 协议进行了一次桥接，从而实现浏览器与服务端的双向通信。</p><figure><img class="lazy" alt="" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/10-5-adc33b76.png" tabindex="0"/><figcaption></figcaption></figure><h4 id="_4-3-1-stomp协议" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-3-1-stomp协议">#</a> 4.3.1 STOMP协议</h4><p><strong>STOMP即Simple (or Streaming) Text Orientated Messaging Protocol</strong>，<strong>简单(流)文本定向消息协议</strong>。前身是TTMP协议（一个简单的基于文本的协议），专为消息中间件设计。它提供了一个可互操作的连接格式，允许STOMP客户端与任意STOMP消息代理（Broker）进行交互。STOMP协议由于设计简单，易于开发客户端，因此在多种语言和多种平台上得到广泛地应用。</p><h4 id="_4-3-2-插件安装" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-3-2-插件安装">#</a> 4.3.2 插件安装</h4><p>1查询所有docker 容器</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">docker ps<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img class="lazy" alt="image-20200305023436779" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200305023436779-f59f618b.png" tabindex="0"/><figcaption>image-20200305023436779</figcaption></figure><p>2我们进入rabbitmq容器</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">docker exec -it 410a37e15588 /bin/bash<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img class="lazy" alt="image-20200305023655720" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200305023655720-57f7c2cb.png" tabindex="0"/><figcaption>image-20200305023655720</figcaption></figure><p>执行下面的命令开启stomp插件</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">rabbitmq-plugins <span class="hljs-built_in">enable</span> rabbitmq_web_stomp rabbitmq_web_stomp_examples<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img class="lazy" alt="image-20200305023810038" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200305023810038-3d7f2413.png" tabindex="0"/><figcaption>image-20200305023810038</figcaption></figure><p>退出容器</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">exit<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img class="lazy" alt="image-20200305023840612" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/GHQAAAAB.png" tabindex="0"/><figcaption>image-20200305023840612</figcaption></figure><p>将当前的容器提交为新的镜像</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker commit 410a37e15588 rabbitmq:stomp<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img class="lazy" alt="image-20200305024558360" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200305024558360-e35417d3.png" tabindex="0"/><figcaption>image-20200305024558360</figcaption></figure><p>停止当前的容器</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker stop 410a37e15588<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img class="lazy" alt="image-20200305024622094" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/AQ14qUdU.png" tabindex="0"/><figcaption>image-20200305024622094</figcaption></figure><p>删除当前的容器</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker <span class="hljs-built_in">rm</span> 410a37e15588<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img class="lazy" alt="image-20200305024639584" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/nhAAAAAE.png" tabindex="0"/><figcaption>image-20200305024639584</figcaption></figure><p>根据新的镜像重新创建容器</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -di --name=ydles_rabbitmq1 -p 5671:5617 -p 5672:5672 -p 4369:4369 -p 15671:15671 -p 15672:15672 -p 25672:25672 -p 15670:15670 -p 15674:15674 rabbitmq:stomp<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>设置容器开机自动启动</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker update --restart=always 54b0eea9edbb <span class="hljs-comment">#根据上面生成的容器号改变</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img class="lazy" alt="image-20200305024852480" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200305024852480-ea9a3885.png" tabindex="0"/><figcaption>image-20200305024852480</figcaption></figure><p>插件已经安转好了<a href="http://192.168.200.128:15670/" rel="noopener noreferrer" target="_blank">http://192.168.200.128:15670/<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img class="lazy" alt="image-20211222005732519" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222005732519-a1963786.png" tabindex="0"/><figcaption>image-20211222005732519</figcaption></figure><h4 id="_4-3-3-消息推送测试" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-3-3-消息推送测试">#</a> 4.3.3 消息推送测试</h4><p>1观察wxpay.html</p><div class="language-html line-numbers-mode" data-ext="html"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight html"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-symbol">&amp;lt;</span>script src=&quot;/js/plugins/qrcode.min.js&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/script<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>script src=&quot;/js/plugins/stomp.min.js&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/script<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>script type=&quot;text/javascript&quot; th:inline=&quot;javascript&quot;<span class="hljs-symbol">&amp;gt;</span><br>let qrcode = new QRCode(document.getElementById(&quot;qrcode&quot;), &#123;<br>    width : 240,<br>    height : 240<br>&#125;);<br>qrcode.makeCode(&quot;weixin://wxpay/bizpayurl?pr=XzofHwG&quot;);<br><br>let client = Stomp.client(&#x27;ws://192.168.200.128:15674/ws&#x27;);<br>let on_connect = function(x) &#123;<br>    id = client.subscribe(&quot;/exchange/paynotify&quot;, function(d) &#123;<br><br>    &#125;);<br>&#125;;<br>let on_error =  function() &#123;<br>    console.log(&#x27;error&#x27;);<br>&#125;;<br>client.connect(&#x27;guest&#x27;, &#x27;guest&#x27;, on_connect, on_error, &#x27;/&#x27;);<br><br><span class="hljs-symbol">&amp;lt;</span>/script<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>所以我们需要创建一个交换机paynotify</p><blockquote><p>destination 在 RabbitMQ Web STOM 中进行了相关的定义，根据使用场景的不同，主要有以下 4 种：</p><ul><li>1./exchange/&lt;exchangeName&gt;</li></ul><p>对于 SUBCRIBE frame，destination 一般为/exchange/ &lt;exchangeName&gt;/[/pattern] 的形式。该 destination 会创建一个唯一的、自动删除的、名为&lt;exchangeName&gt;的 queue，并根据 pattern 将该 queue 绑定到所给的 exchange，实现对该队列的消息订阅。 对于 SEND frame，destination 一般为/exchange/&lt;exchangeName&gt;/[/routingKey] 的形式。这种情况下消息就会被发送到定义的 exchange 中，并且指定了 routingKey。</p><ul><li><p>2./queue/ &lt;queueName&gt; 对于 SUBCRIBE frame，destination 会定义 &lt;queueName&gt;的共享 queue，并且实现对该队列的消息订阅。 对于 SEND frame，destination 只会在第一次发送消息的时候会定义 &lt;queueName&gt;的共享 queue。该消息会被发送到默认的 exchange 中，routingKey 即为 &lt;queueName&gt;。</p></li><li><p>3./amq/queue/&lt;queueName&gt; 这种情况下无论是 SUBCRIBE frame 还是 SEND frame 都不会产生 queue。但如果该 queue 不存在，SUBCRIBE frame 会报错。 对于 SUBCRIBE frame，destination 会实现对队列&lt;queueName&gt;的消息订阅。 对于 SEND frame，消息会通过默认的 exhcange 直接被发送到队列&lt;queueName&gt;中。</p></li><li><p>4./topic/&lt;topicName&gt; 对于 SUBCRIBE frame，destination 创建出自动删除的、非持久的 queue 并根据 routingkey 为&lt;topicName&gt;绑定到 amq.topic exchange 上，同时实现对该 queue 的订阅。 对于 SEND frame，消息会被发送到 amq.topic exchange 中，routingKey 为&lt;topicName&gt;。</p></li></ul></blockquote><p>2 <a href="http://192.168.200.128:15672/#/exchanges" rel="noopener noreferrer" target="_blank">http://192.168.200.128:15672/#/exchanges<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 新建交换机。名字：paynotify 。类型 ：fanout。</p><figure><img class="lazy" alt="image-20200305025600949" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200305025600949-da1a31f6.png" tabindex="0"/><figcaption>image-20200305025600949</figcaption></figure><p>3修改wxpay.html</p><div class="language-html line-numbers-mode" data-ext="html"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight html"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-symbol">&amp;lt;</span>script src=&quot;/js/plugins/qrcode.min.js&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/script<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>script src=&quot;/js/plugins/stomp.min.js&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/script<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>script type=&quot;text/javascript&quot; th:inline=&quot;javascript&quot;<span class="hljs-symbol">&amp;gt;</span><br>let qrcode = new QRCode(document.getElementById(&quot;qrcode&quot;), &#123;<br>    width : 240,<br>    height : 240<br>&#125;);<br>qrcode.makeCode(&quot;weixin://wxpay/bizpayurl?pr=XzofHwG&quot;); //自己的微信图片<br><br>let client = Stomp.client(&#x27;ws://192.168.200.128:15674/ws&#x27;);<br>let on_connect = function(x) &#123;<br>    id = client.subscribe(&quot;/exchange/paynotify&quot;, function(d) &#123;<br>         alert(d.body);<br>    &#125;);<br>&#125;;<br>let on_error =  function() &#123;<br>    console.log(&#x27;error&#x27;);<br>&#125;;<br>client.connect(&#x27;guest&#x27;, &#x27;guest&#x27;, on_connect, on_error, &#x27;/&#x27;);<br><span class="hljs-symbol">&amp;lt;</span>/script<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4将wxpay.html放到static中。因为对比静态页面文件夹，页面获取的是平级的js。打开页面，观察console。如果有错，将static打包，发给大家。</p><p>页面效果</p><figure><img class="lazy" alt="image-20211222012152665" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222012152665-81c35747.png" tabindex="0"/><figcaption>image-20211222012152665</figcaption></figure><p>5尝试发送一条消息</p><p>点击rabbitMQ队列交换机页面的paynotify</p><figure><img class="lazy" alt="image-20211222012132026" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222012132026-ccd25173.png" tabindex="0"/><figcaption>image-20211222012132026</figcaption></figure><p>点击发送消息</p><figure><img class="lazy" alt="image-20211222012123305" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222012123305-a8281baf.png" tabindex="0"/><figcaption>image-20211222012123305</figcaption></figure><p>效果</p><figure><img class="lazy" alt="image-20211222012108075" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222012108075-e6e3776e.png" tabindex="0"/><figcaption>image-20211222012108075</figcaption></figure><p>6新建用户</p><p>为了安全，我们在页面上不能用我们的rabbitmq的超级管理员用户guest，所以我们需要在rabbitmq中新建一个普通用户webguest（普通用户无法登录管理后台）</p><figure><img class="lazy" alt="image-20200306075452263" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200306075452263-a700224f.png" tabindex="0"/><figcaption>image-20200306075452263</figcaption></figure><p>设置虚拟目录权限，打开这个用户权限页：</p><figure><img class="lazy" alt="image-20200306075534030" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200306075534030-6667d3b8.png" tabindex="0"/><figcaption>image-20200306075534030</figcaption></figure><p>点击设置权限</p><figure><img class="lazy" alt="" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/13-3-9801a07a.png" tabindex="0"/><figcaption></figcaption></figure><p>页面用户名和密码修改</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">client.connect(&#x27;webguest&#x27;, &#x27;webguest&#x27;, on_connect, on_error, &#x27;/&#x27;);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>刷新页面，还可以看到连接信息即可。</p><figure><img class="lazy" alt="image-20200306075942810" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200306075942810-3fedba8a.png" tabindex="0"/><figcaption>image-20200306075942810</figcaption></figure><h3 id="_4-4-代码实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-4-代码实现">#</a> 4.4 代码实现</h3><p>实现思路：后端在收到回调通知后发送订单号给mq（paynotify交换器），前端通过stomp连接到mq订阅</p><figure><img class="lazy" alt="image-20211222013147811" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222013147811-6fc7baa2.png" tabindex="0"/><figcaption>image-20211222013147811</figcaption></figure><p>1 修改notifyLogic方法，在<code>"SUCCESS".equals(result.get("result_code"))</code> 后添加</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;SUCCESS&quot;</span>.equals(result.get(<span class="hljs-string">&quot;result_code&quot;</span>))) &#123;<br>    <span class="hljs-comment">//将订单的消息发送到mq&#x27;</span><br>    <span class="hljs-type">Map</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>    message.put(<span class="hljs-string">&quot;orderId&quot;</span>, result.get(<span class="hljs-string">&quot;out_trade_no&quot;</span>));<br>    message.put(<span class="hljs-string">&quot;transactionId&quot;</span>, result.get(<span class="hljs-string">&quot;transaction_id&quot;</span>));<br>    <span class="hljs-comment">//消息的发送</span><br>    rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;&quot;</span>, RabbitMQConfig.ORDER_PAY, JSON.toJSONString(message));<br><br>    <span class="hljs-comment">//完成双向通信</span><br>    rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;paynotify&quot;</span>,<span class="hljs-string">&quot;&quot;</span>, result.get(<span class="hljs-string">&quot;out_trade_no&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2 ydles_web_order的PayController中新增跳转支付成功接口</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//支付成功跳转</span><br><span class="hljs-meta">@GetMapping(&quot;/topaysuccess&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">topaysuccess</span><span class="hljs-params">(String payMoney, Model model)</span> &#123;<br>    model.addAttribute(<span class="hljs-string">&quot;payMoney&quot;</span>, payMoney);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;paysuccess&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img class="lazy" alt="image-20200423120048804" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200423120048804-8b52dc0a.png" tabindex="0"/><figcaption>image-20200423120048804</figcaption></figure><p>3 修改ydles_web_order项目的wxpay.html ，渲染js代码订单号和支付金额部分</p><div class="language-javascript line-numbers-mode" data-ext="js"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight javascript"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&amp;lt;script src=<span class="hljs-string">&quot;/js/plugins/qrcode.min.js&quot;</span>&amp;gt;&amp;lt;/script&amp;gt;<br>&amp;lt;script src=<span class="hljs-string">&quot;/js/plugins/stomp.min.js&quot;</span>&amp;gt;&amp;lt;/script&amp;gt;<br>&amp;lt;script type=<span class="hljs-string">&quot;text/javascript&quot;</span> <span class="hljs-attr">th</span>:inline=<span class="hljs-string">&quot;javascript&quot;</span>&amp;gt;<br>    <span class="hljs-keyword">let</span> qrcode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QRCode</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;qrcode&quot;</span>), &#123;<br>        <span class="hljs-attr">width</span>: <span class="hljs-number">240</span>,<br>        <span class="hljs-attr">height</span>: <span class="hljs-number">240</span><br>    &#125;);<br>    qrcode.<span class="hljs-title function_">makeCode</span>([[$&#123;code_url&#125;]]);<br><br><br>    <span class="hljs-keyword">let</span> client = <span class="hljs-title class_">Stomp</span>.<span class="hljs-title function_">client</span>(<span class="hljs-string">&#x27;ws://192.168.200.128:15674/ws&#x27;</span>);<br>    <span class="hljs-keyword">let</span> on_connect = <span class="hljs-keyword">function</span> (<span class="hljs-params">x</span>) &#123;<br>        id = client.<span class="hljs-title function_">subscribe</span>(<span class="hljs-string">&quot;/exchange/paynotify&quot;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) &#123;<br>            <span class="hljs-title function_">alert</span>(d.<span class="hljs-property">body</span>);<br>            <span class="hljs-keyword">let</span> orderId = [[$&#123;orderId&#125;]]<br>            <span class="hljs-keyword">if</span> (d.<span class="hljs-property">body</span> == orderId) &#123;<br>                <span class="hljs-comment">//跳转页面</span><br>                location.<span class="hljs-property">href</span> = <span class="hljs-string">&quot;/api/wxpay/toPaySuccess?payMoney=&quot;</span> + [[$&#123;payMoney&#125;]]<br>            &#125;<br>        &#125;);<br>    &#125;;<br>    <span class="hljs-keyword">let</span> on_error = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;error&#x27;</span>);<br>    &#125;;<br>    client.<span class="hljs-title function_">connect</span>(<span class="hljs-string">&#x27;webguest&#x27;</span>, <span class="hljs-string">&#x27;webguest&#x27;</span>, on_connect, on_error, <span class="hljs-string">&#x27;/&#x27;</span>);<br>&amp;lt;/script&amp;gt;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（3）将paysuccess.html拷贝到templates文件夹 。</p><h2 id="_5-测试访问路径" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_5-测试访问路径">#</a> 5. 测试访问路径</h2><p>1重启ydles_service_pay ydles_service_order</p><p>2添加商品： <a href="http://localhost:8001/api/cart/addCart?skuId=100000006163&amp;num=10" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/cart/addCart?skuId=100000006163&amp;num=10<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>3查看购物车： <a href="http://localhost:8001/api/wcart/list" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/wcart/list<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>4点击：结算---》提交订单--》选择微信支付--》跳到二维码页面--》扫描二维码</p><p>5 支付完成 回传订单数据</p><p>6确定后，跳转至支付成功页面</p><figure><img class="lazy" alt="image-20211222014108729" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222014108729-e4521203.png" tabindex="0"/><figcaption>image-20211222014108729</figcaption></figure><p>总结：</p><p>1了解微信支付怎么做</p><p>第三方接口平台对接：第三方官网文档一步一步做</p><p>2申请支付的二维码</p><figure><img class="lazy" alt="image-20211221144256113" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221144256113-e80b69c9.png" tabindex="0"/><figcaption>image-20211221144256113</figcaption></figure><p>3支付回推</p><figure><img class="lazy" alt="image-20211221203416360" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221203416360-61d74041.png" tabindex="0"/><figcaption>image-20211221203416360</figcaption></figure><p>natapp 内网穿透</p><figure><img class="lazy" alt="image-20211221235105274" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211221235105274-6db9cee5.png" tabindex="0"/><figcaption>image-20211221235105274</figcaption></figure><p>4用户回推 支付成功消息</p><figure><img class="lazy" alt="image-20211222013147811" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222013147811-6fc7baa2.png" tabindex="0"/><figcaption>image-20211222013147811</figcaption></figure><figure><img class="lazy" alt="image-20211222014807522" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211222014807522-f05b12ce.png" tabindex="0"/><figcaption>image-20211222014807522</figcaption></figure><h1 id="第14章-订单处理" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第14章-订单处理">#</a> 第14章 订单处理</h1><p><strong>角色</strong>:还是订单组，资深架构师。</p><h2 id="课程内容-1" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#课程内容-1">#</a> 课程内容：</h2><ul><li>通过rabbitmq的延迟消息完成超时订单处理</li><li>完成批量发货功能，了解第三方物流系统</li><li>完成自动收货功能</li></ul><h2 id="_1-超时未支付订单处理-重点" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-超时未支付订单处理-重点">#</a> 1. 超时未支付订单处理-重点</h2><h3 id="_1-1-需求分析" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-1-需求分析">#</a> 1.1 需求分析</h3><p>超过限定时间并未支付的订单，我们需要进行超时订单的处理：先调用微信支付api，查询该订单的支付状态。如果未支付调用关闭订单的api，并修改订单状态为已关闭，并回滚库存数。如果该订单已经支付，则做补偿操作（修改订单状态和记录）。</p><h3 id="_1-2-实现思路" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-2-实现思路">#</a> 1.2 实现思路</h3><p>如何获取超过限定时间的订单？我们可以使用<strong>延迟消息</strong>队列（死信队列）来实现。</p><p>所谓延迟消息队列，就是消息的生产者发送的消息并不会立刻被消费，而是在设定的时间之后才可以消费。</p><p>我们可以在订单创建时发送一个延迟消息，消息为订单号，系统会在限定时间之后取出这个消息，然后查询订单的支付状态，根据结果做出相应的处理。</p><h3 id="_1-3-rabbitmq延迟消息" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-3-rabbitmq延迟消息">#</a> 1.3 rabbitmq延迟消息</h3><p>使用RabbitMQ来实现延迟消息必须先了解RabbitMQ的两个概念：消息的<strong>TTL</strong>和<strong>死信Exchange</strong>，通过这两者的组合来实现上述需求。</p><h4 id="_1-3-1-消息的ttl-time-to-live" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-3-1-消息的ttl-time-to-live">#</a> 1.3.1 消息的TTL（Time To Live）</h4><p>消息的TTL就是消息的存活时间。RabbitMQ可以对队列和消息分别设置TTL。对队列设置就是队列没有消费者连着的保留时间，也可以对每一个单独的消息做单独的设置。超过了这个时间，我们认为这个消息就死了，称之为死信。</p><p>我们创建一个队列queue.temp，在Arguments 中添加x-message-ttl 为5000 （单位是毫秒），那每一个进入这个队列的消息在5秒后会消失。</p><figure><img class="lazy" alt="image-20211227105923204" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227105923204-9990ae46.png" tabindex="0"/><figcaption>image-20211227105923204</figcaption></figure><h4 id="_1-3-2-死信交换器-dead-letter-exchanges" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-3-2-死信交换器-dead-letter-exchanges">#</a> 1.3.2 死信交换器 Dead Letter Exchanges</h4><p><strong>面试：什么时候死信？</strong></p><p>一个消息在满足如下条件下，会进死信交换机，记住这里是交换机而不是队列，一个交换机可以对应很多队列。</p><p><strong>（1）</strong> 一个消息被Consumer拒收了，并且reject方法的参数里requeue是false。也就是说不会被再次放在队列里，被其他消费者使用。</p><p>**（2）**<strong>上面的消息的TTL到了，消息过期了</strong>。</p><p>**（3）**队列的长度限制满了。排在前面的消息会被丢弃或者扔到死信交换机上。</p><p>Dead Letter Exchange其实就是一种普通的exchange，和创建其他exchange没有两样。只是在某一个设置Dead Letter Exchange的队列中有消息过期了，会自动触发消息的转发，发送到Dead Letter Exchange中去。</p><figure><img class="lazy" alt="image-20211227111258327" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227111258327-ccd7a72a.png" tabindex="0"/><figcaption>image-20211227111258327</figcaption></figure><p>我们现在可以测试一下延迟队列。</p><p>（1）创建死信交换器 exchange.ordertimeout （<strong>fanout</strong>）</p><p>（2）创建队列queue.ordertimeout</p><p>（3）建立死信交换器 exchange.ordertimeout 与队列queue.ordertimeout 之间的绑定</p><p>（4）创建队列queue.ordercreate，Arguments添加</p><p>x-message-ttl=10000</p><p>x-dead-letter-exchange： exchange.ordertimeout</p><p>（5）测试：向queue.ordercreate队列添加消息，等待10秒后消息从queue.ordercreate队列消失，</p><figure><img class="lazy" alt="image-20211227111214185" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227111214185-813f14aa.png" tabindex="0"/><figcaption>image-20211227111214185</figcaption></figure><figure><img class="lazy" alt="image-20211227111247704" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227111247704-898b8747.png" tabindex="0"/><figcaption>image-20211227111247704</figcaption></figure><h3 id="_1-4-代码实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-4-代码实现">#</a> 1.4 代码实现</h3><figure><img class="lazy" alt="image-20211227113439128" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227113439128-8d798b5d.png" tabindex="0"/><figcaption>image-20211227113439128</figcaption></figure><h4 id="_1-4-1-微信支付-关闭订单" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-4-1-微信支付-关闭订单">#</a> 1.4.1 微信支付-关闭订单</h4><figure><img class="lazy" alt="image-20211227114511089" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227114511089-80618cbc.png" tabindex="0"/><figcaption>image-20211227114511089</figcaption></figure><p>（1）WxPayController新增方法</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 关闭微信订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> orderId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@PutMapping(&quot;/close/&#123;orderId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">closeOrder</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String orderId)</span>&#123;<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> wxPayService.closeOrder( orderId );<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>( <span class="hljs-literal">true</span>,StatusCode.OK,<span class="hljs-string">&quot;&quot;</span>,map );<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）ydles_service_pay的WxPayService新增方法定义</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 关闭订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> orderId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>Map <span class="hljs-title function_">closeOrder</span><span class="hljs-params">(String orderId)</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（3）ydles_service_pay的 WxPayServiceImpl实现该方法</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Map <span class="hljs-title function_">closeOrder</span><span class="hljs-params">(String orderId)</span> &#123;<br>    Map map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>(  );<br>    map.put( <span class="hljs-string">&quot;out_trade_no&quot;</span>,orderId );<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span>  wxPay.closeOrder( map );<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        e.printStackTrace();<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（4）ydles_service_pay_api的WxPayFeign新增方法</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 关闭微信订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> orderId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@PutMapping(&quot;/wxpay/close/&#123;orderId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">closeOrder</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;orderId&quot;)</span> String orderId)</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-4-2-微信支付-查询订单" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-4-2-微信支付-查询订单">#</a> 1.4.2 微信支付-查询订单</h4><p>（1）WxPayController新增方法</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 查询微信订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> orderId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(&quot;/query/&#123;orderId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryOrder</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String orderId)</span>&#123;<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> wxPayService.queryOrder( orderId );<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>( <span class="hljs-literal">true</span>,StatusCode.OK,<span class="hljs-string">&quot;&quot;</span>,map );<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）WxPayFeign新增方法</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 查询微信订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> orderId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(&quot;/wxpay/query/&#123;orderId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryOrder</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;orderId&quot;)</span> String orderId)</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>商品服务回滚库存</p><figure><img class="lazy" alt="image-20211227115532726" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227115532726-7aca5071.png" tabindex="0"/><figcaption>image-20211227115532726</figcaption></figure><p>（1）dao</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//回滚库存</span><br><span class="hljs-meta">@Update(&quot;update tb_sku set num=num+#&#123;num&#125;,sale_num=sale_num-#&#123;num&#125; where id=#&#123;skuId&#125;&quot;)</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">resumeStockNum</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;skuId&quot;)</span> String skuId, <span class="hljs-meta">@Param(&quot;num&quot;)</span> Integer num)</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）service</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//回滚库存</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">resumeStockNum</span><span class="hljs-params">(String skuId,Integer num)</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>（3）serivceImpl</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resumeStockNum</span><span class="hljs-params">(String skuId, Integer num)</span> &#123;<br>    skuMapper.resumeStockNum(skuId,num);<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(4)controller</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//回滚库存</span><br>    <span class="hljs-meta">@PutMapping(value = &quot;/resumeStockNum&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">resumeStockNum</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;skuId&quot;)</span> String skuId, <span class="hljs-meta">@RequestParam(&quot;num&quot;)</span>Integer num)</span>&#123;<br>        skuService.resumeStockNum(skuId,num);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>(<span class="hljs-literal">true</span>,StatusCode.OK,<span class="hljs-string">&quot;回滚库存成功！&quot;</span>);<br>    &#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(4)skuFeign</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PutMapping(value = &quot;/sku/resumeStockNum&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">resumeStockNum</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;skuId&quot;)</span> String skuId, <span class="hljs-meta">@RequestParam(&quot;num&quot;)</span>Integer num)</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-4-3-订单关闭逻辑" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-4-3-订单关闭逻辑">#</a> 1.4.3 订单关闭逻辑</h4><figure><img class="lazy" alt="image-20211227121318859" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227121318859-ad46fa80.png" tabindex="0"/><figcaption>image-20211227121318859</figcaption></figure><p>如果为未支付，查询微信订单</p><p>如果确认为未支付，调用关闭本地订单（ 修改订单表的订单状态、记录订单日志、恢复商品表库存）和微信订单的逻辑。</p><p>如果为已支付进行状态补偿。</p><p>（1）ydles_service_order新增依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.ydles<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>ydles_service_pay_api<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>1.0-SNAPSHOT<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）ydles_service_order的OrderService新增方法定义</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 关闭订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> orderId</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">closeOrder</span><span class="hljs-params">(String orderId)</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（3）OrderServiceImpl实现该方法</p><p>实现逻辑：</p><p>1）根据id查询订单信息，判断订单是否存在，订单支付状态是否为未支付</p><p>2）基于微信查询订单支付状态</p><p>2.1）如果为success，则修改订单状态</p><p>2.2）如果为未支付，则修改订单，新增日志，恢复库存，关闭订单</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br>PayFeign payFeign;<br><span class="hljs-comment">//关闭订单</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">closeOrder</span><span class="hljs-params">(String orderId)</span> &#123;<br>    System.out.println(<span class="hljs-string">&quot;关闭订单开启了:&quot;</span>+orderId);<br><br>    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectByPrimaryKey(orderId);<br>    <span class="hljs-keyword">if</span>(order==<span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;这笔订单不存在！&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(!order.getOrderStatus().equals(<span class="hljs-string">&quot;0&quot;</span>))&#123;<br>        System.out.println(<span class="hljs-string">&quot;这笔订单不用关闭&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    System.out.println(<span class="hljs-string">&quot;关闭订单逻辑通过校验：&quot;</span>+orderId);<br><br><br>    <span class="hljs-comment">//1支付服务 微信查询订单</span><br>    Map&amp;lt;String, String&amp;gt; wxQueryMap = payFeign.queryOrder(orderId).getData();<br><br>    <span class="hljs-comment">//2.1支付了 order表修改</span><br>    <span class="hljs-keyword">if</span>(wxQueryMap.get(<span class="hljs-string">&quot;trade_state&quot;</span>).equals(<span class="hljs-string">&quot;SUCCESS&quot;</span>))&#123;<br>        updatePayStatus(orderId,wxQueryMap.get(<span class="hljs-string">&quot;transaction_id&quot;</span>));<br>        System.out.println(<span class="hljs-string">&quot;已支付&quot;</span>+orderId);<br>    &#125;<br><br>    <span class="hljs-comment">//2.2未支付 关闭订单微信 内部回滚库存 订单状态关闭</span><br>    <span class="hljs-keyword">if</span>(wxQueryMap.get(<span class="hljs-string">&quot;trade_state&quot;</span>).equals(<span class="hljs-string">&quot;NOTPAY&quot;</span>))&#123;<br>        <span class="hljs-comment">//1关闭订单微信</span><br>        payFeign.closeOrder(orderId);<br><br>        <span class="hljs-comment">//2订单状态关闭</span><br>        System.out.println(<span class="hljs-string">&quot;本项目关闭订单了&quot;</span>);<br>        order.setOrderStatus(<span class="hljs-string">&quot;9&quot;</span>);<span class="hljs-comment">//订单状态 0下单 1支付 2发货 3收货 4退货 9关闭</span><br>        order.setCloseTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        orderMapper.updateByPrimaryKeySelective(order);<br><br>        <span class="hljs-comment">//orderLog表 新增数据</span><br>        <span class="hljs-type">OrderLog</span> <span class="hljs-variable">orderLog</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderLog</span>();<br>        orderLog.setId(idWorker.nextId()+<span class="hljs-string">&quot;&quot;</span>);<br>        orderLog.setOperater(<span class="hljs-string">&quot;system&quot;</span>);<br>        orderLog.setOperateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        orderLog.setOrderId(orderId);<br>        orderLog.setOrderStatus(<span class="hljs-string">&quot;9&quot;</span>);<br>        orderLog.setPayStatus(<span class="hljs-string">&quot;0&quot;</span>);<br>        orderLog.setConsignStatus(<span class="hljs-string">&quot;0&quot;</span>);<br>        orderLog.setRemarks(<span class="hljs-string">&quot;超时未支付！&quot;</span>);<br>        orderLogMapper.insertSelective(orderLog);<br><br><br>        <span class="hljs-comment">//3内部回滚库存</span><br><br>        <span class="hljs-comment">//查出来这笔订单的所有购物项</span><br>        OrderItem orderItem=<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>();<br>        orderItem.setOrderId(orderId);<br>        List&amp;lt;OrderItem&amp;gt; orderItemList = orderItemMapper.select(orderItem);<br><br>        <span class="hljs-keyword">for</span> (OrderItem orderItem1 : orderItemList) &#123;<br>            skuFeign.resumeStock(orderItem1.getSkuId(),orderItem1.getNum());<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-comment">//还有各种支付状态 都需要考虑。REFUND CLOSED USERPAYING</span><br><br><br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-4-4-延迟消息处理" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-4-4-延迟消息处理">#</a> 1.4.4 延迟消息处理</h4><figure><img class="lazy" alt="image-20211227170736337" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227170736337-59939cf9.png" tabindex="0"/><figcaption>image-20211227170736337</figcaption></figure><p>从消息队列queue.ordertimeout 中提取消息</p><p>（1）修改OrderServiceImpl的add方法，追加代码，实现mq发送</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">rabbitTemplate.convertAndSend( <span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;queue.ordercreate&quot;</span>, orderId);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>（2）ydles_service_order新建监听类</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderTimeoutListener</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderService orderService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 更新支付状态</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> orderId</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RabbitListener(queues = &quot;queue.ordertimeout&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">closeOrder</span><span class="hljs-params">(String orderId)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;接收到关闭订单消息：&quot;</span>+orderId);<br>        <span class="hljs-keyword">try</span> &#123;<br>            orderService.closeOrder( orderId );<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>测试关键点</strong>：</p><p>1 10秒后，能不能order服务接受消息</p><p>2 微信支付了，本地order没支付 ---》下单，回调接口写错。</p><p>3 没支付---------》二维码页面，等10秒。</p><figure><img class="lazy" alt="image-20211227172604859" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/4PQZVWqz.png" tabindex="0"/><figcaption>image-20211227172604859</figcaption></figure><h2 id="_2-订单批量发货" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-订单批量发货">#</a> 2. 订单批量发货</h2><p>角色：店主</p><h3 id="_2-1-批量发货业务逻辑" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-1-批量发货业务逻辑">#</a> 2.1 批量发货业务逻辑</h3><h4 id="_2-1-1-需求分析" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-1-1-需求分析">#</a> 2.1.1 需求分析</h4><p>实现批量发货的业务逻辑</p><figure><img class="lazy" alt="image-20211227173827318" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227173827318-03d9a628.png" tabindex="0"/><figcaption>image-20211227173827318</figcaption></figure><h4 id="_2-1-2-代码实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-1-2-代码实现">#</a> 2.1.2 代码实现</h4><p>（1）OrderController新增方法</p><div class="language-json line-numbers-mode" data-ext="json"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight json"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span><br>        orderId<span class="hljs-punctuation">:</span><span class="hljs-number">8345</span><span class="hljs-punctuation">,</span><br>        shipping_name<span class="hljs-punctuation">:</span>顺丰<span class="hljs-punctuation">,</span><br>        shipping_code<span class="hljs-punctuation">:</span><span class="hljs-number">123</span><span class="hljs-punctuation">,</span><br>        .......<br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">&#123;</span><br><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">&#123;</span><br><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 批量发货</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> orders  订单列表</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@PostMapping(&quot;/batchSend&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">batchSend</span><span class="hljs-params">( <span class="hljs-meta">@RequestBody</span> List&amp;lt;Order&amp;gt; orders)</span>&#123;<br>    orderService.batchSend( orders );<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>( <span class="hljs-literal">true</span>,StatusCode.OK,<span class="hljs-string">&quot;发货成功&quot;</span> );<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）OrderService新增方法定义</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 批量发货</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> orders</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">batchSend</span><span class="hljs-params">(List&amp;lt;Order&amp;gt; orders)</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（3）OrderServiceImpl实现该方法</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchSend</span><span class="hljs-params">(List&amp;lt;Order&amp;gt; orderList)</span> &#123;<br>    <span class="hljs-comment">//循环1 物流公司和物流单号 不能为空</span><br>    <span class="hljs-keyword">for</span> (Order order : orderList) &#123;<br>        <span class="hljs-keyword">if</span>(order.getId()==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;订单号为空！&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span>(order.getShippingName()==<span class="hljs-literal">null</span>||order.getShippingCode()==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;物流公司或单号为空！&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//循环2 查询订单状态 校验</span><br>    <span class="hljs-keyword">for</span> (Order order : orderList) &#123;<br>        <span class="hljs-type">Order</span> <span class="hljs-variable">queryOrder</span> <span class="hljs-operator">=</span> orderMapper.selectByPrimaryKey(order.getId());<br>        <span class="hljs-keyword">if</span>(!queryOrder.getOrderStatus().equals(<span class="hljs-string">&quot;1&quot;</span>)||!queryOrder.getConsignStatus().equals(<span class="hljs-string">&quot;0&quot;</span>))&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;订单状态不对，不能发货！&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//循环3 发货</span><br>    <span class="hljs-keyword">for</span> (Order order : orderList) &#123;<br>        order.setOrderStatus(<span class="hljs-string">&quot;2&quot;</span>);<br>        order.setConsignStatus(<span class="hljs-string">&quot;1&quot;</span>);<br>        order.setUpdateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        order.setConsignTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        orderMapper.updateByPrimaryKeySelective(order);<br><br>        <span class="hljs-comment">//orderLog表 新增数据</span><br>        <span class="hljs-type">OrderLog</span> <span class="hljs-variable">orderLog</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderLog</span>();<br>        orderLog.setId(idWorker.nextId()+<span class="hljs-string">&quot;&quot;</span>);<br>        orderLog.setOperater(<span class="hljs-string">&quot;店小二&quot;</span>);<br>        orderLog.setOperateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        orderLog.setOrderId(order.getId());<br>        orderLog.setOrderStatus(<span class="hljs-string">&quot;2&quot;</span>);<br>        orderLog.setPayStatus(<span class="hljs-string">&quot;1&quot;</span>);<br>        orderLog.setConsignStatus(<span class="hljs-string">&quot;1&quot;</span>);<br>        orderLog.setRemarks(<span class="hljs-string">&quot;批量发货&quot;</span>);<br>        orderLogMapper.insertSelective(orderLog);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-对接第三方物流-了解" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-2-对接第三方物流-了解">#</a> 2.2 对接第三方物流（了解）</h3><p>当我们在电商平台购买了商品后，一般会非常关心商品的物流轨迹。那这些信息是如何获取的呢？我们需要对接第三方的物流系统。比较常用的有菜鸟物流、快递鸟等。</p><p>我们这里推荐使用快递鸟 <a href="http://www.kdniao.com" rel="noopener noreferrer" target="_blank">http://www.kdniao.com<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>我们可以使用快递鸟提供的以下接口：</p><p>（1）预约取件API</p><p>预约取件API为用户提供了在线下单，预约快递员上门揽件的功能，为用户解决在线发货需求。</p><p>我们可以在实现批量发货功能后调用预约取件API</p><p>（2）即时查询API</p><p>物流查询API提供实时查询物流轨迹的服务，用户提供运单号和快递公司，即可查询当前时刻的最新物流轨迹。</p><p>用户可以在用户中心调用此API完成物流信息的查询，电商平台也可以调用此API完成运单的跟踪。</p><figure><img class="lazy" alt="image-20211227180923988" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227180923988-743ab9cb.png" tabindex="0"/><figcaption>image-20211227180923988</figcaption></figure><h2 id="_3-确认收货与自动收货" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-确认收货与自动收货">#</a> 3. 确认收货与自动收货</h2><h3 id="_3-1-确认收货" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-1-确认收货">#</a> 3.1 确认收货</h3><h4 id="_3-1-1-需求分析与实现思路" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-1-1-需求分析与实现思路">#</a> 3.1.1 需求分析与实现思路</h4><p>当物流公司将货物送到了用户收货地址之后，需要用户点击确认收货，当用户点击了确认收货之后，会修改订单状态为已完成</p><h4 id="_3-1-2-代码实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-1-2-代码实现">#</a> 3.1.2 代码实现</h4><p>（1）OrderController新增方法</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 确认收货 </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> orderId  订单号</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> operator 操作者</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@PutMapping(&quot;/take/&#123;orderId&#125;/operator/&#123;operator&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">take</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String orderId, <span class="hljs-meta">@PathVariable</span> String operator)</span>&#123;<br>    orderService.take( orderId,operator );<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>( <span class="hljs-literal">true</span>,StatusCode.OK,<span class="hljs-string">&quot;&quot;</span> );<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）OrderService新增方法定义</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 确认收货</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> orderId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> operator</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">confirmTask</span><span class="hljs-params">(String orderId,String operator)</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（3）OrderServiceImpl实现该方法</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">confirmTask</span><span class="hljs-params">(String orderId, String operator)</span> &#123;<br>    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectByPrimaryKey( orderId );<br>    <span class="hljs-keyword">if</span>(order==<span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>( <span class="hljs-string">&quot;订单不存在&quot;</span> );<br>    &#125;<br>    <span class="hljs-keyword">if</span>( !<span class="hljs-string">&quot;1&quot;</span>.equals( order.getConsignStatus() ))&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>( <span class="hljs-string">&quot;订单未发货&quot;</span> );<br>    &#125;<br>    order.setConsignStatus(<span class="hljs-string">&quot;2&quot;</span>); <span class="hljs-comment">//已送达</span><br>    order.setOrderStatus( <span class="hljs-string">&quot;3&quot;</span> );<span class="hljs-comment">//已完成</span><br>    order.setUpdateTime( <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>() );<br>    order.setEndTime( <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>() );<span class="hljs-comment">//交易结束</span><br>    orderMapper.updateByPrimaryKeySelective( order );<br>    <span class="hljs-comment">//记录订单变动日志</span><br>    OrderLog orderLog=<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderLog</span>();<br>    orderLog.setId( idWorker.nextId()+<span class="hljs-string">&quot;&quot;</span> );<br>    orderLog.setOperateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<span class="hljs-comment">//当前日期</span><br>    orderLog.setOperater( operator );<span class="hljs-comment">//系统？管理员？用户？</span><br>    orderLog.setOrderStatus(<span class="hljs-string">&quot;3&quot;</span>);<br>    orderLog.setOrderId(order.getId());<br>    orderLogMapper.insertSelective(orderLog);<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-自动收货处理" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-2-自动收货处理">#</a> 3.2 自动收货处理</h3><h4 id="_3-2-1-需求分析" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-2-1-需求分析">#</a> 3.2.1 需求分析</h4><p>如果用户在15天（可以在订单配置表中配置）没有确认收货，系统将自动收货。如何实现？我们这里采用定时任务springTask来实现。</p><figure><img class="lazy" alt="image-20211227184231554" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227184231554-8ffec52a.png" tabindex="0"/><figcaption>image-20211227184231554</figcaption></figure><p><strong>逻辑</strong>：每天凌晨2点，查询order,发货15天，自动收货。</p><p>​ 每天凌晨1点，删除生产环境，删除log。</p><p>技术：</p><p>spring---&gt;quartz</p><p>spring task 定时任务</p><p>xxl-job</p><h4 id="_3-2-2-cron表达式" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-2-2-cron表达式">#</a> 3.2.2 Cron表达式</h4><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">&quot;0 * * * * *&quot;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>Cron表达式是一个字符串，字符串分为七个部分，每一个域代表一个含义。</p><p>Cron表达式7个域格式为： 秒 分 小时 日 月 星期几 年</p><p>Cron表达式6个域格式为： 秒 分 小时 日 月 周</p><table><thead><tr><th>序号</th><th>说明</th><th>是否必填</th><th>允许填写的值</th><th>允许的通配符</th></tr></thead><tbody><tr><td>1</td><td>秒</td><td>是</td><td>0-59</td><td>, - * /</td></tr><tr><td>2</td><td>分</td><td>是</td><td>0-59</td><td>, - * /</td></tr><tr><td>3</td><td>小时</td><td>是</td><td>0-23</td><td>, - * /</td></tr><tr><td>4</td><td>日</td><td>是</td><td>1-31</td><td>, - * ? / L W</td></tr><tr><td>5</td><td>月</td><td>是</td><td>1-12或JAN-DEC</td><td>, - * /</td></tr><tr><td>6</td><td>星期几</td><td>是</td><td>1-7或SUN-SAT</td><td>, - * ? / L W</td></tr><tr><td>7</td><td>年</td><td>否</td><td>empty 或1970-2099</td><td>, - * /</td></tr></tbody></table><p>使用说明：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs text">通配符说明:<br>* 表示所有值. 例如:在分的字段上设置 &quot;*&quot;,表示每一分钟都会触发。<br><br>? 表示不指定值。使用的场景为不需要关心当前设置这个字段的值。<br><br>例如:要在每月的10号触发一个操作，但不关心是周几，所以需要周位置的那个字段设置为&quot;?&quot; 具体设置为 0 0 0 10 * ?<br><br>- 表示区间。例如 在小时上设置 &quot;10-12&quot;,表示 10,11,12点都会触发。<br><br>, 表示指定多个值，例如在周字段上设置 &quot;MON,WED,FRI&quot; 表示周一，周三和周五触发<br><br>/ 用于递增触发。如在秒上面设置&quot;5/15&quot; 表示从5秒开始，每增15秒触发(5,20,35,50)。 在月字段上设置&#x27;1/3&#x27;所示每月1号开始，每隔三天触发一次。<br><br>L 表示最后的意思。在日字段设置上，表示当月的最后一天(依据当前月份，如果是二月还会依据是否是润年[leap]), 在周字段上表示星期六，相当于&quot;7&quot;或&quot;SAT&quot;。如果在&quot;L&quot;前加上数字，则表示该数据的最后一个。例如在周字段上设置&quot;6L&quot;这样的格式,则表示“本月最后一个星期五&quot;<br><br>W 表示离指定日期的最近那个工作日(周一至周五). 例如在日字段上设置&quot;15W&quot;，表示离每月15号最近的那个工作日触发。如果15号正好是周六，则找最近的周五(14号)触发, 如果15号是周未，则找最近的下周一(16号)触发.如果15号正好在工作日(周一至周五)，则就在该天触发。如果指定格式为 &quot;1W&quot;,它则表示每月1号往后最近的工作日触发。如果1号正是周六，则将在3号下周一触发。(注，&quot;W&quot;前只能设置具体的数字,不允许区间&quot;-&quot;).<br><br># 序号(表示每月的第几个周几)，例如在周字段上设置&quot;6#3&quot;表示在每月的第三个周六.注意如果指定&quot;#5&quot;,正好第五周没有周六，则不会触发该配置(用在母亲节和父亲节再合适不过了) ；<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>常用表达式</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs text">0 0 10,14,16 * * ? 每天上午10点，下午2点，4点 <br>0 0/30 9-17 * * ? 朝九晚五工作时间内每半小时 <br>0 0 12 ? * WED 表示每个星期三中午12点 <br>&quot;0 0 12 * * ?&quot; 每天中午12点触发 <br>&quot;0 15 10 ? * *&quot; 每天上午10:15触发 <br>&quot;0 15 10 * * ?&quot; 每天上午10:15触发 <br>&quot;0 15 10 * * ? *&quot; 每天上午10:15触发 <br>&quot;0 15 10 * * ? 2005&quot; 2005年的每天上午10:15触发 <br>&quot;0 * 14 * * ?&quot; 在每天下午2点到下午2:59期间的每1分钟触发 <br>&quot;0 0/5 14 * * ?&quot; 在每天下午2点到下午2:55期间的每5分钟触发 <br>&quot;0 0/5 14,18 * * ?&quot; 在每天下午2点到2:55期间和下午6点到6:55期间的每5分钟触发 <br>&quot;0 0-5 14 * * ?&quot; 在每天下午2点到下午2:05期间的每1分钟触发 <br>&quot;0 10,44 14 ? 3 WED&quot; 每年三月的星期三的下午2:10和2:44触发 <br>&quot;0 15 10 ? * MON-FRI&quot; 周一至周五的上午10:15触发 <br>&quot;0 15 10 15 * ?&quot; 每月15日上午10:15触发 <br>&quot;0 15 10 L * ?&quot; 每月最后一日的上午10:15触发 <br>&quot;0 15 10 ? * 6L&quot; 每月的最后一个星期五上午10:15触发 <br>&quot;0 15 10 ? * 6L 2002-2005&quot; 2002年至2005年的每月的最后一个星期五上午10:15触发 <br>&quot;0 15 10 ? * 6#3&quot; 每月的第三个星期五上午10:15触发<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-2-3-代码实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-2-3-代码实现">#</a> 3.2.3 代码实现</h4><figure><img class="lazy" alt="image-20211227195336675" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227195336675-340959bb.png" tabindex="0"/><figcaption>image-20211227195336675</figcaption></figure><h5 id="_3-2-3-1-发送消息" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-2-3-1-发送消息">#</a> 3.2.3.1 发送消息</h5><p>（1）创建order_tack队列 。</p><p>（2）创建工程ydles_task，引入依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>dependencies<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework.boot<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-boot-starter<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework.amqp<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-rabbit<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/dependencies<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（3）创建配置文件 application.yml</p><div class="language-yaml line-numbers-mode" data-ext="yml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight yaml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9202</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">task</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.128</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（4）创建启动类 com.ydles.task</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableScheduling</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run( TaskApplication.class,args );<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>@EnableScheduling</code> 注解用于开启任务调度</p><p>（5）创建com.ydles.task包，包下创建类OrderTask</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderTask</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 订单自动收货</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Scheduled(cron = &quot;0 0 0 * * ?&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">autoTake</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(  ) );<br>        rabbitTemplate.convertAndSend( <span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;order_tack&quot;</span>,<span class="hljs-string">&quot;-&quot;</span> );<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-2-3-2-接收消息" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-2-3-2-接收消息">#</a> 3.2.3.2 接收消息</h5><figure><img class="lazy" alt="image-20211227200800397" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227200800397-029ab2a6.png" tabindex="0"/><figcaption>image-20211227200800397</figcaption></figure><p>（1）ydles_service_order工程，编写消息监听类</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderTackListener</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderService orderService;<br><br>    <span class="hljs-meta">@RabbitListener(queues = &quot;order_tack&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">autoTack</span><span class="hljs-params">(String message)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;收到自动确认收货消息&quot;</span>);<br>        orderService.autoTack(); <span class="hljs-comment">//自动确认收货</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）OrderService新增方法定义</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自动确认收货</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">autoTack</span><span class="hljs-params">()</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（3）OrderServiceImpl实现此方法</p><p>实现思路：</p><p>1）从订单配置表中获取订单自动确认期限</p><p>2）得到当前日期向前数（订单自动确认期限）天。作为过期时间节点</p><p>3）从订单表中获取过期订单（发货时间小于过期时间，且为未确认收货状态）</p><p>4）循环批量处理，执行确认收货</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br>OrderConfigMapper orderConfigMapper;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">autoTack</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//1 从配置表中获取15天值</span><br>    <span class="hljs-type">OrderConfig</span> <span class="hljs-variable">orderConfig</span> <span class="hljs-operator">=</span> orderConfigMapper.selectByPrimaryKey(<span class="hljs-string">&quot;1&quot;</span>);<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">takeTimeout</span> <span class="hljs-operator">=</span> orderConfig.getTakeTimeout();<span class="hljs-comment">//15</span><br><br>    <span class="hljs-comment">//2 推算拿几号之前发货的订单</span><br>    LocalDate now=LocalDate.now();<span class="hljs-comment">//当前</span><br>    <span class="hljs-type">LocalDate</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> now.plusDays(-takeTimeout);<br>    System.out.println(date);<br><br>    <span class="hljs-comment">//3 查询发货超过15天的订单</span><br>    Example example=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Example</span>(Order.class);<br>    Example.<span class="hljs-type">Criteria</span> <span class="hljs-variable">criteria</span> <span class="hljs-operator">=</span> example.createCriteria();<br>    criteria.andEqualTo(<span class="hljs-string">&quot;orderStatus&quot;</span>,<span class="hljs-string">&quot;2&quot;</span>);<br>    criteria.andLessThan(<span class="hljs-string">&quot;consignTime&quot;</span>, date);<br>    List&amp;lt;Order&amp;gt; orderList = orderMapper.selectByExample(example);<br><br>    <span class="hljs-comment">//4 循环 把这些订单 收货</span><br>    <span class="hljs-keyword">for</span> (Order order : orderList) &#123;<br>        take(order.getId(),<span class="hljs-string">&quot;system&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>总结：</p><p>1超时未支付订单处理</p><figure><img class="lazy" alt="image-20211227113439128" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227113439128-8d798b5d.png" tabindex="0"/><figcaption>image-20211227113439128</figcaption></figure><p>​ 2订单批量发货（店主）</p><figure><img class="lazy" alt="image-20211227173827318" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227173827318-03d9a628.png" tabindex="0"/><figcaption>image-20211227173827318</figcaption></figure><p>3确认收货与自动收货</p><p operator="">手动：/take/{orderId}/operator/</p><p>自动：</p><figure><img class="lazy" alt="image-20211227184231554" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227184231554-8ffec52a.png" tabindex="0"/><figcaption>image-20211227184231554</figcaption></figure><h1 id="第15章-秒杀前端" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第15章-秒杀前端">#</a> 第15章-秒杀前端</h1><p><strong>角色</strong>：独立模块 秒杀模块。<strong>架构师</strong>。</p><h2 id="课程内容-2" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#课程内容-2">#</a> 课程内容:</h2><ul><li><p>秒杀业务分析</p><div class="language-properties line-numbers-mode" data-ext="properties"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight properties"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">1.什么是秒杀</span><br><span class="hljs-attr">2.秒杀实现的流程-&amp;gt;架构分析流程-&amp;gt;重点</span><br><span class="hljs-attr">3.业务流程</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>秒杀商品压入Redis缓存</p><div class="language-properties line-numbers-mode" data-ext="properties"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight properties"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">秒杀商品存入到Redis来提升访问速度</span><br><span class="hljs-attr">1.秒杀列表数据</span><br><span class="hljs-attr">2.秒杀详情页数据</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>Spring定时任务了解-定时将秒杀商品存入到Redis中</p><div class="language-properties line-numbers-mode" data-ext="properties"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight properties"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">定时将秒杀商品存入到Redis缓存</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div></li><li><p>秒杀商品频道页实现-秒杀商品列表页</p></li><li><p>秒杀商品详情页实现</p></li></ul><h2 id="_1-秒杀业务分析" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-秒杀业务分析">#</a> 1 秒杀业务分析</h2><h4 id="_1-1-需求分析-1" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-1-需求分析-1">#</a> 1.1 需求分析</h4><p>所谓“秒杀”，就是网络卖家发布一些超低价格的商品，所有买家在同一时间网上抢购的一种销售方式。通俗一点讲就是网络商家为促销等目的组织的网上限时抢购活动。由于商品价格低廉，往往一上架就被抢购一空，有时只用一秒钟。</p><p>秒杀商品通常有<strong>两种限制</strong>：库存限制、时间限制。</p><p>需求：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">（1）秒杀频道首页列出秒杀商品<br>（4）点击立即抢购实现秒杀下单，下单时扣减库存。当库存为0或不在活动期范围内时无法秒杀。<br>（5）秒杀下单成功，直接跳转到支付页面（微信扫码），支付成功，跳转到成功页，填写收货地址、电话、收件人等信息，完成订单。<br>（6）当用户秒杀下单5分钟内未支付，取消预订单，调用微信支付的关闭订单接口，恢复库存。<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img class="lazy" alt="image-20211227221818494" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227221818494-8ebee597.png" tabindex="0"/><figcaption>image-20211227221818494</figcaption></figure><h4 id="_1-2-表结构说明" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-2-表结构说明">#</a> 1.2 表结构说明</h4><p><strong>秒杀商品信息表</strong></p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `tb_seckill_goods` (<br>  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `goods_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;spu ID&#x27;</span>,<br>  `item_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;sku ID&#x27;</span>,<br>  `title` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;标题&#x27;</span>,<br>  `small_pic` <span class="hljs-type">varchar</span>(<span class="hljs-number">150</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;商品图片&#x27;</span>,<br>  `price` <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;原价格&#x27;</span>,<br>  `cost_price` <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;秒杀价格&#x27;</span>,<br>  `seller_id` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;商家ID&#x27;</span>,<br>  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;添加日期&#x27;</span>,<br>  `check_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;审核日期&#x27;</span>,<br>  `status` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;审核状态，0未审核，1审核通过，2审核不通过&#x27;</span>,<br>  `start_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;开始时间&#x27;</span>,<br>  `end_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;结束时间&#x27;</span>,<br>  `num` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;秒杀商品数&#x27;</span>,<br>  `stock_count` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;剩余库存数&#x27;</span>,<br>  `introduction` <span class="hljs-type">varchar</span>(<span class="hljs-number">2000</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;描述&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">4</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img class="lazy" alt="image-20211227221948208" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227221948208-fc0ab4b4.png" tabindex="0"/><figcaption>image-20211227221948208</figcaption></figure><p><strong>秒杀订单表</strong></p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `tb_seckill_order` (<br>    `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;主键&#x27;</span>,<br>    `seckill_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;秒杀商品ID&#x27;</span>,<br>    `money` <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;支付金额&#x27;</span>,<br>    `user_id` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;用户&#x27;</span>,<br>    `seller_id` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;商家&#x27;</span>,<br>    `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;创建时间&#x27;</span>,<br>    `pay_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;支付时间&#x27;</span>,<br>    `status` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;状态，0未支付，1已支付&#x27;</span>,<br>    `receiver_address` <span class="hljs-type">varchar</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;收货人地址&#x27;</span>,<br>    `receiver_mobile` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;收货人电话&#x27;</span>,<br>    `receiver` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;收货人&#x27;</span>,<br>    `transaction_id` <span class="hljs-type">varchar</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;交易流水&#x27;</span>,<br>    <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img class="lazy" alt="image-20211227222002467" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227222002467-e63d1cd6.png" tabindex="0"/><figcaption>image-20211227222002467</figcaption></figure><h4 id="_1-3-秒杀需求分析-拓展内容" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-3-秒杀需求分析-拓展内容">#</a> 1.3 秒杀需求分析==拓展内容</h4><p>秒杀技术实现核心思想是运用缓存减少数据库瞬间的访问压力！读取商品详细信息时运用缓存，当用户点击抢购时减少缓存中的库存数量，当库存数为0时或活动期结束时，同步到数据库。 产生的秒杀预订单也不会立刻写到数据库中，而是先写到缓存，当用户付款成功后再写入数据库。</p><p>当然，上面实现的思路只是一种最简单的方式，并未考虑其中一些问题，例如并发状况容易产生的问题。我们看看下面这张思路更严谨的图：</p><figure><img class="lazy" alt="1578267434606" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/1578267434606-d0a51b91.png" tabindex="0"/><figcaption>1578267434606</figcaption></figure><h2 id="_2-秒杀商品存入缓存-重点" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-秒杀商品存入缓存-重点">#</a> 2 秒杀商品存入缓存-重点</h2><figure><img class="lazy" alt="image-20211228160425046" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228160425046-fa761d21.png" tabindex="0"/><figcaption>image-20211228160425046</figcaption></figure><p>秒杀商品由B端存入Mysql，设置定时任务，每隔一段时间就从Mysql中将符合条件的数据从Mysql中查询出来并存入缓存中，redis以Hash类型进行数据存储。</p><p>KEY的设计：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs text">seckill_goods_2021122812 map<br>                  id SecKillGoods<br>                  1 Prada包包<br>                  3  guccy包包<br>seckill_goods_2021122814 map<br>                  id SecKillGoods<br>                  2 lv包包<br>seckill_goods_2021122816 map          <br>seckill_goods_2021122818 map<br>seckill_goods_2021122820 map<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>我们这里秒杀商品列表和秒杀商品详情都是从Redis中取出来的，所以我们首先要将符合参与秒杀的商品定时查询出来，并将数据存入到Redis缓存中。</p></li><li><p>数据存储类型我们可以选择Hash类型。</p></li><li><p>秒杀分页列表这里可以通过获取redisTemplate.boundHashOps(key).values()获取结果数据。</p></li><li><p>秒杀商品详情，可以通过redisTemplate.boundHashOps(key).get(key)获取详情。</p></li></ul><h3 id="_2-1-秒杀服务搭建" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-1-秒杀服务搭建">#</a> 2.1 秒杀服务搭建</h3><p>我们将商品数据压入到Reids缓存，可以在秒杀工程的服务工程中完成，可以按照如下步骤实现：</p><div class="language-properties line-numbers-mode" data-ext="properties"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight properties"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">1.查询活动没结束的所有秒杀商品</span><br>  <span class="hljs-attr">1)状态必须为审核通过</span> <span class="hljs-string">status=1</span><br>    <span class="hljs-attr">2)商品库存个数&amp;gt;0</span><br>  <span class="hljs-attr">3)活动没有结束</span>  <span class="hljs-string">endTime&amp;gt;=now()</span><br>    <span class="hljs-attr">4)在Redis中没有该商品的缓存</span><br>    <span class="hljs-attr">5)执行查询获取对应的结果集</span><br><span class="hljs-attr">2.将活动没有结束的秒杀商品入库</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们首先搭建一个秒杀服务工程，然后按照上面步骤实现。</p><p>搭建ydles-service-seckill，作为秒杀工程的服务提供工程。</p><p>1）新建服务ydles_service_seckill</p><p>2）添加依赖信息，详情如下：</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>dependencies<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.ydles<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>ydles_common_db<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>1.0-SNAPSHOT<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework.cloud<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.ydles<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>ydles_service_order_api<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>1.0-SNAPSHOT<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.ydles<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>ydles_service_seckill_api<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>1.0-SNAPSHOT<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.ydles<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>ydles_service_goods_api<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>1.0-SNAPSHOT<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework.amqp<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-rabbit<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>!--oauth依赖--<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework.cloud<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-cloud-starter-oauth2<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/dependencies<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ydles_service_seckill_api创建</li></ul><p>依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>dependencies<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.ydles<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>ydles_common<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>1.0-SNAPSHOT<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/dependencies<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>添加包 com.ydles.seckill.feign com.ydles.seckill.pojo</p><p>pojo中将资料中的两个实体类放入，对应数据库的两张表</p><figure><img class="lazy" alt="image-20211228161100576" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228161100576-817ff531.png" tabindex="0"/><figcaption>image-20211228161100576</figcaption></figure><ol start="3"><li>回到ydles_service_seckill工程。添加启动类 com.ydles.seckill</li></ol><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaClient</span><br><span class="hljs-meta">@EnableFeignClients</span><br><span class="hljs-meta">@MapperScan(basePackages = &#123;&quot;com.ydles.seckill.dao&quot;&#125;)</span><br><span class="hljs-meta">@EnableScheduling</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SeckillApplication</span> &#123;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(SeckillApplication.class,args);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> IdWorker <span class="hljs-title function_">idWorker</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IdWorker</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//设置redistemplate的序列化</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedisTemplate&amp;lt;Object, Object&amp;gt; redisTemplate(RedisConnectionFactory redisConnectionFactory) &#123;<br>        <span class="hljs-comment">// 1.创建 redisTemplate 模版</span><br>        RedisTemplate&amp;lt;Object, Object&amp;gt; template = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&amp;lt;&amp;gt;();<br>        <span class="hljs-comment">// 2.关联 redisConnectionFactory</span><br>        template.setConnectionFactory(redisConnectionFactory);<br>        <span class="hljs-comment">// 3.创建 序列化类</span><br>        <span class="hljs-type">GenericToStringSerializer</span> <span class="hljs-variable">genericToStringSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericToStringSerializer</span>(Object.class);<br>        <span class="hljs-comment">// 6.序列化类，对象映射设置</span><br>        <span class="hljs-comment">// 7.设置 value 的转化格式和 key 的转化格式</span><br>        template.setValueSerializer(genericToStringSerializer);<br>        template.setKeySerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>());<br>        template.afterPropertiesSet();<br>        <span class="hljs-keyword">return</span> template;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>添加dao层的两个mapper</li></ol><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SeckillGoodsMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Mapper</span>&amp;lt;SeckillGoods&amp;gt; &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SeckillOrderMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Mapper</span>&amp;lt;SeckillOrder&amp;gt; &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>添加application.yml</li></ol><div class="language-yaml line-numbers-mode" data-ext="yml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight yaml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9016</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">jackson:</span><br>    <span class="hljs-attr">time-zone:</span> <span class="hljs-string">GMT+8</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">seckill</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://192.168.200.128:3306/ydles_seckill?useUnicode=true&amp;amp;characterEncoding=utf-8&amp;amp;useSSL=false&amp;amp;allowMultiQueries=true&amp;amp;serverTimezone=GMT%2b8</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">main:</span><br>    <span class="hljs-attr">allow-bean-definition-overriding:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#当遇到同样名字的时候，是否允许覆盖注册</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.128</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.128</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:6868/eureka</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">hystrix:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">default:</span>   <span class="hljs-comment">#配置全局的feign的调用超时时间  如果 有指定的服务配置 默认的配置不会生效</span><br>        <span class="hljs-attr">connectTimeout:</span> <span class="hljs-number">60000</span> <span class="hljs-comment"># 指定的是 消费者 连接服务提供者的连接超时时间 是否能连接  单位是毫秒</span><br>        <span class="hljs-attr">readTimeout:</span> <span class="hljs-number">20000</span>  <span class="hljs-comment"># 指定的是调用服务提供者的 服务 的超时时间（）  单位是毫秒</span><br><span class="hljs-comment">#hystrix 配置</span><br><span class="hljs-attr">hystrix:</span><br>  <span class="hljs-attr">command:</span><br>    <span class="hljs-attr">default:</span><br>      <span class="hljs-attr">execution:</span><br>        <span class="hljs-attr">timeout:</span><br>          <span class="hljs-comment">#如果enabled设置为false，则请求超时交给ribbon控制</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">isolation:</span><br>          <span class="hljs-attr">strategy:</span> <span class="hljs-string">SEMAPHORE</span><br>          <span class="hljs-attr">thread:</span><br>            <span class="hljs-comment"># 熔断器超时时间，默认：1000/毫秒</span><br>            <span class="hljs-attr">timeoutInMilliseconds:</span> <span class="hljs-number">20000</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="6"><li><p>添加公钥 copy认证服务的公钥</p></li><li><p>添加Oauth配置类 config包</p></li></ol><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableResourceServer</span><br><span class="hljs-comment">//开启方法上的PreAuthorize注解</span><br><span class="hljs-meta">@EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceServerConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ResourceServerConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-comment">//公钥</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PUBLIC_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;public.key&quot;</span>;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 定义JwtTokenStore</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> jwtAccessTokenConverter</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> TokenStore <span class="hljs-title function_">tokenStore</span><span class="hljs-params">(JwtAccessTokenConverter jwtAccessTokenConverter)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtTokenStore</span>(jwtAccessTokenConverter);<br>    &#125;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 定义JJwtAccessTokenConverter</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> JwtAccessTokenConverter <span class="hljs-title function_">jwtAccessTokenConverter</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">JwtAccessTokenConverter</span> <span class="hljs-variable">converter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtAccessTokenConverter</span>();<br>        converter.setVerifierKey(getPubKey());<br>        <span class="hljs-keyword">return</span> converter;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取非对称加密公钥 Key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 公钥 Key</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getPubKey</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(PUBLIC_KEY);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">InputStreamReader</span> <span class="hljs-variable">inputStreamReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(resource.getInputStream());<br>            <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">br</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(inputStreamReader);<br>            <span class="hljs-keyword">return</span> br.lines().collect(Collectors.joining(<span class="hljs-string">&quot;\n&quot;</span>));<br>        &#125; <span class="hljs-keyword">catch</span> (IOException ioe) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * Http安全配置，对每个到达系统的http请求链接进行校验</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> http</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//所有请求必须认证通过</span><br>        http.authorizeRequests()<br>                .anyRequest().<br>                authenticated();    <span class="hljs-comment">//其他地址需要认证授权</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="7"><li>更改网关路径过滤类，添加秒杀工程过滤信息</li></ol><figure><img class="lazy" alt="image-20211228162810677" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228162810677-a4fbb12f.png" tabindex="0"/><figcaption>image-20211228162810677</figcaption></figure><ol start="8"><li>更改网关配置文件，添加请求路由转发</li></ol><div class="language-yaml line-numbers-mode" data-ext="yml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight yaml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#秒杀微服务</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">ydles_seckill_route</span><br>  <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://seckill</span><br>  <span class="hljs-attr">predicates:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/seckill/**</span><br>  <span class="hljs-attr">filters:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-时间操作" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-2-时间操作">#</a> 2.2 时间操作</h3><h4 id="_2-2-1-秒杀商品时间段分析" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-2-1-秒杀商品时间段分析">#</a> 2.2.1 秒杀商品时间段分析</h4><figure><img class="lazy" alt="image-20211228171058257" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228171058257-0677530e.png" tabindex="0"/><figcaption>image-20211228171058257</figcaption></figure><p>根据产品原型图结合秒杀商品表设计可以得知，秒杀商品是存在开始时间与结束时间的，当前秒杀商品是按照秒杀时间段进行显示，如果当前时间在符合条件的时间段范围之内，则用户可以秒杀购买当前时间段之内的秒杀商品。</p><p>缓存数据加载思路：定义定时任务，每天凌晨会进行当天所有时间段秒杀商品预加载。并且在B端进行限制，添加秒杀商品的话，只能添加当前日期+1的时间限制，比如说：当前日期为8月5日，则添加秒杀商品时，开始时间必须为6日的某一个时间段，否则不能添加。</p><h4 id="_2-2-2-秒杀商品时间段计算" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-2-2-秒杀商品时间段计算">#</a> 2.2.2 秒杀商品时间段计算</h4><p>将<code>资源/DateUtil.java</code>添加到公共服务中。基于当前工具类可以进行时间段的计算。</p><p>在该工具类中，进行时间计算测试：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-comment">//定义存储结果的集合</span><br>    List&amp;lt;Date&amp;gt; dateList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&amp;lt;&amp;gt;();<br><br>    <span class="hljs-comment">//获取本日凌晨时间点</span><br>    <span class="hljs-type">Date</span> <span class="hljs-variable">currentData</span> <span class="hljs-operator">=</span> toDayStartHour(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br><br>    <span class="hljs-comment">//循环12次 （因为要获取每隔两个时间为一个时间段的值）</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&amp;lt;<span class="hljs-number">12</span>;i++)&#123;<br>        dateList.add(addDateHour(currentData,i*<span class="hljs-number">2</span>));<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (Date date : dateList) &#123;<br>        <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">simpleDateFormat</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">format</span> <span class="hljs-operator">=</span> simpleDateFormat.format(date);<br>        System.out.println(format);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试结果：</p><figure><img class="lazy" alt="image-20211228171813908" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228171813908-6e66583f.png" tabindex="0"/><figcaption>image-20211228171813908</figcaption></figure><h4 id="_2-2-3-当前业务整体流程分析" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-2-3-当前业务整体流程分析">#</a> 2.2.3 当前业务整体流程分析</h4><div class="language-properties line-numbers-mode" data-ext="properties"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight properties"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">1.定时任务：查询所有符合条件的秒杀商品</span><br>    <span class="hljs-attr">1)</span> <span class="hljs-string">获取时间段集合并循环遍历出每一个时间段</span><br>    <span class="hljs-attr">2)</span> <span class="hljs-string">获取每一个时间段名称,用于后续redis中key的设置</span><br>    <span class="hljs-attr">3)</span> <span class="hljs-string">状态必须为审核通过 status=1</span><br>    <span class="hljs-attr">4)</span> <span class="hljs-string">商品库存个数&amp;gt;0 </span><br>    <span class="hljs-attr">5)</span> <span class="hljs-string">秒杀商品开始时间&amp;gt;=当前时间段</span><br>    <span class="hljs-attr">6)</span> <span class="hljs-string">秒杀商品结束&amp;lt;当前时间段+2小时</span><br>    <span class="hljs-attr">7)</span> <span class="hljs-string">排除之前已经加载到Redis缓存中的商品数据</span><br>    <span class="hljs-attr">8)</span> <span class="hljs-string">执行查询获取对应的结果集</span><br><span class="hljs-attr">2.将秒杀商品存入缓存</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-代码实现-1" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-3-代码实现-1">#</a> 2.3 代码实现</h3><h4 id="_2-3-1-更改启动类-添加开启定时任务注解" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-3-1-更改启动类-添加开启定时任务注解">#</a> 2.3.1 更改启动类，添加开启定时任务注解</h4><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableScheduling</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><h4 id="_2-3-2-时间菜单分析" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-3-2-时间菜单分析">#</a> 2.3.2 时间菜单分析</h4><figure><img class="lazy" alt="image-20211227224705978" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227224705978-2b56d226.png" tabindex="0"/><figcaption>image-20211227224705978</figcaption></figure><p>我们将商品数据从数据库中查询出来，并存入Redis缓存，但页面每次显示的时候，只显示当前正在秒杀以及往后延时2个小时、4个小时、6个小时、8个小时的秒杀商品数据。我们要做的第一个事是计算出秒杀时间菜单，这个菜单是从后台获取的。</p><p>这个时间菜单的计算我们来分析下，可以先求出当前时间的凌晨，然后每2个小时后作为下一个抢购的开始时间，这样可以分出12个抢购时间段,如下：</p><div class="language-properties line-numbers-mode" data-ext="properties"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight properties"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">00</span>:<span class="hljs-string">00-02:00</span><br><span class="hljs-attr">02</span>:<span class="hljs-string">00-04:00</span><br><span class="hljs-attr">04</span>:<span class="hljs-string">00-06:00</span><br><span class="hljs-attr">06</span>:<span class="hljs-string">00-08:00</span><br><span class="hljs-attr">08</span>:<span class="hljs-string">00-10:00</span><br><span class="hljs-attr">10</span>:<span class="hljs-string">00-12:00</span><br><span class="hljs-attr">12</span>:<span class="hljs-string">00-14:00</span><br><span class="hljs-attr">14</span>:<span class="hljs-string">00-16:00</span><br><span class="hljs-attr">16</span>:<span class="hljs-string">00-18:00</span><br><span class="hljs-attr">18</span>:<span class="hljs-string">00-20:00</span><br><span class="hljs-attr">20</span>:<span class="hljs-string">00-22:00</span><br><span class="hljs-attr">22</span>:<span class="hljs-string">00-00:00</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>而现实的菜单只需要计算出当前时间在哪个时间段范围，该时间段范围就属于正在秒杀的时间段，而后面即将开始的秒杀时间段的计算也就出来了，可以在当前时间段基础之上+2小时、+4小时、+6小时、+8小时。</p><p>关于时间菜单的运算，在给出的DateUtil包里已经实现，代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 获取时间菜单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&amp;lt;Date&amp;gt; getDateMenus()&#123;<br>    <span class="hljs-comment">//定义一个List&amp;lt;Date&amp;gt;集合，存储所有时间段</span><br>    List&amp;lt;Date&amp;gt; dates = getDates(<span class="hljs-number">12</span>);<br>    <span class="hljs-comment">//判断当前时间属于哪个时间范围</span><br>    <span class="hljs-type">Date</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();<br>    <span class="hljs-keyword">for</span> (Date cdate : dates) &#123;<br>        <span class="hljs-comment">//开始时间&amp;lt;=当前时间&amp;lt;开始时间+2小时</span><br>        <span class="hljs-keyword">if</span>(cdate.getTime()&amp;lt;=now.getTime() &amp;amp;&amp;amp; now.getTime()&amp;lt;addDateHour(cdate,<span class="hljs-number">2</span>).getTime())&#123;<br>            now = cdate;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//当前需要显示的时间菜单</span><br>    List&amp;lt;Date&amp;gt; dateMenus = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&amp;lt;Date&amp;gt;();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &amp;lt;<span class="hljs-number">5</span> ; i++) &#123;<br>        dateMenus.add(addDateHour(now,i*<span class="hljs-number">2</span>));<br>    &#125;<br>    <span class="hljs-keyword">return</span> dateMenus;<br>&#125;<br><br><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 指定时间往后N个时间间隔</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> hours</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&amp;lt;Date&amp;gt; getDates(<span class="hljs-type">int</span> hours) &#123;<br>    List&amp;lt;Date&amp;gt; dates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&amp;lt;Date&amp;gt;();<br>    <span class="hljs-comment">//循环12次</span><br>    <span class="hljs-type">Date</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> toDayStartHour(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()); <span class="hljs-comment">//凌晨</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &amp;lt;hours ; i++) &#123;<br>        <span class="hljs-comment">//每次递增2小时,将每次递增的时间存入到List&amp;lt;Date&amp;gt;集合中</span><br>        dates.add(addDateHour(date,i*<span class="hljs-number">2</span>));<br>    &#125;<br>    <span class="hljs-keyword">return</span> dates;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-2-定义定时任务类" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-3-2-定义定时任务类">#</a> 2.3.2 定义定时任务类</h4><p>秒杀工程新建task包，并新建任务类SeckillGoodsPushTask</p><p>业务逻辑：</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 1.查询所有符合条件的秒杀商品</span><br><span class="hljs-comment">         *  1) 获取时间段集合并循环遍历出每一个时间段</span><br><span class="hljs-comment">         *  2) 获取每一个时间段名称,用于后续redis中key的设置</span><br><span class="hljs-comment">         *  3) 状态必须为审核通过 status=1</span><br><span class="hljs-comment">         *  4) 商品库存个数&amp;gt;0</span><br><span class="hljs-comment">         *  5) 秒杀商品开始时间&amp;gt;=当前时间段</span><br><span class="hljs-comment">         *  6) 秒杀商品结束&amp;lt;当前时间段+2小时</span><br><span class="hljs-comment">         *  7) 排除之前已经加载到Redis缓存中的商品数据</span><br><span class="hljs-comment">         *  8) 执行查询获取对应的结果集</span><br><span class="hljs-comment">         * 2.将秒杀商品存入缓存</span><br><span class="hljs-comment">         */</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>注意</strong>：用到很多工具类，了解功能即可</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 添加秒杀秒伤定时任务</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SeckillGoodsPushTask</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SeckillGoodsMapper seckillGoodsMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-comment">//redis key开头</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SECKILL_GOODS_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;seckill_goods_&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 定时将秒杀商品存入redis</span><br><span class="hljs-comment">     * 暂定为30秒一次，正常业务为每天凌晨触发</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Scheduled(cron = &quot;0/30 * * * * ?&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadSecKillGoodsToRedis</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 1.查询所有符合条件的秒杀商品</span><br><span class="hljs-comment">         *  1) 获取时间段集合并循环遍历出每一个时间段</span><br><span class="hljs-comment">         *  2) 获取每一个时间段名称,用于后续redis中key的设置</span><br><span class="hljs-comment">         *  3) 状态必须为审核通过 status=1</span><br><span class="hljs-comment">         *  4) 商品库存个数&amp;gt;0</span><br><span class="hljs-comment">         *  5) 秒杀商品开始时间&amp;gt;=当前时间段</span><br><span class="hljs-comment">         *  6) 秒杀商品结束&amp;lt;当前时间段+2小时</span><br><span class="hljs-comment">         *  7) 排除之前已经加载到Redis缓存中的商品数据</span><br><span class="hljs-comment">         *  8) 执行查询获取对应的结果集</span><br><span class="hljs-comment">         * 2.将秒杀商品存入缓存</span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-comment">//1) 获取时间段集合并循环遍历出每一个时间段</span><br>        List&amp;lt;Date&amp;gt; dateMenus = DateUtil.getDateMenus(); <span class="hljs-comment">// 5个</span><br><br>        <span class="hljs-keyword">for</span> (Date dateMenu : dateMenus) &#123;<br>            <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">simpleDateFormat</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);<br><br>            <span class="hljs-comment">// 2) 获取每一个时间段名称,用于后续redis中key的设置</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">redisExtName</span> <span class="hljs-operator">=</span> DateUtil.date2Str(dateMenu);<br><br>            <span class="hljs-type">Example</span> <span class="hljs-variable">example</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Example</span>(SeckillGoods.class);<br>            Example.<span class="hljs-type">Criteria</span> <span class="hljs-variable">criteria</span> <span class="hljs-operator">=</span> example.createCriteria();<br>            <span class="hljs-comment">// 3) 状态必须为审核通过 status=1</span><br>            criteria.andEqualTo(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>);<br>            <span class="hljs-comment">// 4) 商品库存个数&amp;gt;0 gt</span><br>            criteria.andGreaterThan(<span class="hljs-string">&quot;stockCount&quot;</span>, <span class="hljs-number">0</span>);<br>            <span class="hljs-comment">// 5) 秒杀商品开始时间&amp;gt;=当前时间段 gte</span><br>            criteria.andGreaterThanOrEqualTo(<span class="hljs-string">&quot;startTime&quot;</span>, simpleDateFormat.format(dateMenu));<br>            <span class="hljs-comment">// 6) 秒杀商品结束&amp;lt;当前时间段+2小时 lt</span><br>            criteria.andLessThan(<span class="hljs-string">&quot;endTime&quot;</span>, simpleDateFormat.format(DateUtil.addDateHour(dateMenu, <span class="hljs-number">2</span>)));<br><br>            <span class="hljs-comment">// 7) 排除之前已经加载到Redis缓存中的商品数据</span><br>            <span class="hljs-type">Set</span> <span class="hljs-variable">keys</span> <span class="hljs-operator">=</span> redisTemplate.boundHashOps(SECKILL_GOODS_KEY + redisExtName).keys();<span class="hljs-comment">//key field value</span><br>            <span class="hljs-keyword">if</span> (keys != <span class="hljs-literal">null</span> &amp;amp;&amp;amp; keys.size() &amp;gt; <span class="hljs-number">0</span>) &#123;<br>                criteria.andNotIn(<span class="hljs-string">&quot;id&quot;</span>, keys);<br>            &#125;<br><br>            <span class="hljs-comment">// 8) 执行查询获取对应的结果集</span><br>            List&amp;lt;SeckillGoods&amp;gt; seckillGoodsList = seckillGoodsMapper.selectByExample(example);<br><br>            <span class="hljs-comment">//2.将秒杀商品存入缓存</span><br>            <span class="hljs-keyword">for</span> (SeckillGoods seckillGoods : seckillGoodsList) &#123;<br>                redisTemplate.opsForHash().put(SECKILL_GOODS_KEY + redisExtName, seckillGoods.getId(), seckillGoods);<br>            &#125;<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>测试</strong>：</p><p>1修改一条数据，满足搜索条件</p><figure><img class="lazy" alt="image-20211228180524421" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228180524421-d1c0979e.png" tabindex="0"/><figcaption>image-20211228180524421</figcaption></figure><p>2结果查看redis</p><figure><img class="lazy" alt="image-20211228180537463" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228180537463-722f9d9d.png" tabindex="0"/><figcaption>image-20211228180537463</figcaption></figure><h2 id="_3-秒杀商品-首页-了解" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-秒杀商品-首页-了解">#</a> 3 秒杀商品-首页-了解</h2><figure><img class="lazy" alt="image-20211228181401546" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228181401546-345566b4.png" tabindex="0"/><figcaption>image-20211228181401546</figcaption></figure><p>秒杀商品首页会显示处于秒杀中以及未开始秒杀的商品。</p><h3 id="_3-1-秒杀首页实现分析" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-1-秒杀首页实现分析">#</a> 3.1 秒杀首页实现分析</h3><figure><img class="lazy" alt="image-20211227224737382" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227224737382-409ca1b9.png" tabindex="0"/><figcaption>image-20211227224737382</figcaption></figure><p>秒杀首页需要显示不同时间段的秒杀商品信息，然后当用户选择不同的时间段，查询该时间段下的秒杀商品，实现过程分为两大过程：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">1) 加载时间菜单<br>2）加载时间菜单下秒杀商品信息<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-1-1-加载时间菜单分析" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-1-1-加载时间菜单分析">#</a> 3.1.1 加载时间菜单分析</h4><figure><img class="lazy" alt="image-20211228181433725" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228181433725-37340631.png" tabindex="0"/><figcaption>image-20211228181433725</figcaption></figure><p>每2个小时就会切换一次抢购活动，所以商品发布的时候，我们将时间定格在2小时内抢购，每次发布商品的时候，商品抢购开始时间和结束时间是这2小时的边界。</p><p>每2小时会有一批商品参与抢购，所以我们可以将24小时切分为12个菜单，每个菜单都是个2小时的时间段，当前选中的时间菜单需要根据当前时间判断，判断当前时间属于哪个秒杀时间段，然后将该时间段作为选中的第1个时间菜单。</p><h4 id="_3-1-2-加载对应秒杀商品分析" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-1-2-加载对应秒杀商品分析">#</a> 3.1.2 加载对应秒杀商品分析</h4><figure><img class="lazy" alt="image-20211228181441279" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228181441279-fab14fd1.png" tabindex="0"/><figcaption>image-20211228181441279</figcaption></figure><p>进入首页时，到后台查询时间菜单信息，然后将第1个菜单的时间段作为key，在Redis中查询秒杀商品集合，并显示到页面，页面每次点击切换不同时间段菜单的时候，都将时间段传入到后台，后台根据时间段获取对应的秒杀商品集合。</p><h3 id="_3-2-秒杀渲染服务-渲染秒杀首页" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-2-秒杀渲染服务-渲染秒杀首页">#</a> 3.2 秒杀渲染服务 - 渲染秒杀首页</h3><h4 id="_3-2-1-新建秒杀渲染服务" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-2-1-新建秒杀渲染服务">#</a> 3.2.1 新建秒杀渲染服务</h4><p>1）创建工程ydles_web_seckill,用于秒杀页面渲染</p><ol start="2"><li>添加依赖</li></ol><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>dependencies<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.ydles<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>ydles_service_seckill_api<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>1.0-SNAPSHOT<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework.boot<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-boot-starter-thymeleaf<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/dependencies<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>添加启动类 <a href="http://com.ydles.seckill.web" rel="noopener noreferrer" target="_blank">com.ydles.seckill.web<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ol><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-meta">@EnableFeignClients(basePackages = &quot;com.ydles.seckill.feign&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecKillApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(WebSecKillApplication.class,args);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> FeignInterceptor <span class="hljs-title function_">feignInterceptor</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FeignInterceptor</span>();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 设置 redisTemplate 的序列化设置</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> redisConnectionFactory</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedisTemplate&amp;lt;Object, Object&amp;gt; redisTemplate(RedisConnectionFactory redisConnectionFactory) &#123;<br>        <span class="hljs-comment">// 1.创建 redisTemplate 模版</span><br>        RedisTemplate&amp;lt;Object, Object&amp;gt; template = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&amp;lt;&amp;gt;();<br>        <span class="hljs-comment">// 2.关联 redisConnectionFactory</span><br>        template.setConnectionFactory(redisConnectionFactory);<br>        <span class="hljs-comment">// 3.创建 序列化类</span><br>        <span class="hljs-type">GenericToStringSerializer</span> <span class="hljs-variable">genericToStringSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericToStringSerializer</span>(Object.class);<br>        <span class="hljs-comment">// 6.序列化类，对象映射设置</span><br>        <span class="hljs-comment">// 7.设置 value 的转化格式和 key 的转化格式</span><br>        template.setValueSerializer(genericToStringSerializer);<br>        template.setKeySerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>());<br>        template.afterPropertiesSet();<br>        <span class="hljs-keyword">return</span> template;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>添加application.yml</li></ol><div class="language-yaml line-numbers-mode" data-ext="yml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight yaml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9104</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:6868/eureka</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">hystrix:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">jackson:</span><br>    <span class="hljs-attr">time-zone:</span> <span class="hljs-string">GMT+8</span><br>  <span class="hljs-attr">thymeleaf:</span><br>    <span class="hljs-attr">cache:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">seckill-web</span><br>  <span class="hljs-attr">main:</span><br>    <span class="hljs-attr">allow-bean-definition-overriding:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.128</span><br><span class="hljs-comment">#hystrix 配置</span><br><span class="hljs-attr">hystrix:</span><br>  <span class="hljs-attr">command:</span><br>    <span class="hljs-attr">default:</span><br>      <span class="hljs-attr">execution:</span><br>        <span class="hljs-attr">timeout:</span><br>          <span class="hljs-comment">#如果enabled设置为false，则请求超时交给ribbon控制</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">isolation:</span><br>          <span class="hljs-attr">strategy:</span> <span class="hljs-string">SEMAPHORE</span><br>          <span class="hljs-attr">thread:</span><br>            <span class="hljs-attr">timeoutInMilliseconds:</span> <span class="hljs-number">60000</span><br><span class="hljs-comment">#请求处理的超时时间</span><br><span class="hljs-attr">ribbon:</span><br>  <span class="hljs-attr">ReadTimeout:</span> <span class="hljs-number">4000</span><br>  <span class="hljs-comment">#请求连接的超时时间</span><br>  <span class="hljs-attr">ConnectTimeout:</span> <span class="hljs-number">3000</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>添加静态化资源</li></ol><figure><img class="lazy" alt="image-20211228181821971" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228181821971-e398a676.png" tabindex="0"/><figcaption>image-20211228181821971</figcaption></figure><p>6）对接网关</p><div class="language-yaml line-numbers-mode" data-ext="yml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight yaml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#秒杀渲染微服务</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">ydles_seckill_web_route</span><br>     <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://seckill-web</span><br>     <span class="hljs-attr">predicates:</span><br>       <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/wseckillgoods/**</span><br>     <span class="hljs-attr">filters:</span><br>       <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-时间菜单实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-时间菜单实现">#</a> 3.3 时间菜单实现</h3><p>时间菜单显示，先运算出每2小时一个抢购，就需要实现12个菜单，可以先计算出每个时间的临界值，然后根据当前时间判断需要显示12个时间段菜单中的哪个菜单，再在该时间菜单的基础之上往后挪4个菜单，一直显示5个时间菜单。</p><h4 id="_3-3-1-时间菜单获取" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-1-时间菜单获取">#</a> 3.3.1 时间菜单获取</h4><p>ydles_web_seckill com.ydles.seckill.web.controller 新增控制类SecKillGoodsController</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/wseckillgoods&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecKillGoodsController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SecKillGoodsFeign secKillGoodsFeign;<br><br>    <span class="hljs-comment">//跳转秒杀首页</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/toIndex&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toIndex</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;seckill-index&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//获取秒杀时间段集合信息</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/timeMenus&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> List&amp;lt;String&amp;gt; dateMenus()&#123;<br><br>        <span class="hljs-comment">//获取当前时间段相关的信息集合</span><br>        List&amp;lt;Date&amp;gt; dateMenus = DateUtil.getDateMenus(); <span class="hljs-comment">//5个</span><br>        <span class="hljs-comment">//返回值</span><br>        List&amp;lt;String&amp;gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&amp;lt;&amp;gt;();<br><br>        <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">simpleDateFormat</span>  <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);<br>        <span class="hljs-comment">//格式化时间段</span><br>        <span class="hljs-keyword">for</span> (Date dateMenu : dateMenus) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">format</span> <span class="hljs-operator">=</span> simpleDateFormat.format(dateMenu);<br>            result.add(format);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span>  result;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-3-2-页面加载时间菜单" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-2-页面加载时间菜单">#</a> 3.3.2 页面加载时间菜单</h4><p>修改seckill-index.html</p><figure><img class="lazy" alt="image-20211228183316377" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228183316377-9385b4e4.png" tabindex="0"/><figcaption>image-20211228183316377</figcaption></figure><div class="language-javascript line-numbers-mode" data-ext="js"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight javascript"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;<br>    <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app&#x27;</span>,<br>    <span class="hljs-title function_">data</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> &#123;<br>            <span class="hljs-attr">goodslist</span>: [],<br>            <span class="hljs-attr">dateMenus</span>:[]<br>        &#125;<br>    &#125;,<br>    <span class="hljs-attr">methods</span>:&#123;<br>        <span class="hljs-attr">loadMenus</span>:<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>            axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/api/wseckillgoods/timeMenus&quot;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) &#123;<br>                app.<span class="hljs-property">dateMenus</span>=response.<span class="hljs-property">data</span>;<br><br>                <span class="hljs-comment">//查询当前时间段对应的秒杀商品</span><br>            &#125;)<br>        &#125;<br>    &#125;,<br>    <span class="hljs-attr">created</span>:<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadMenus</span>();<br>    &#125;<br>&#125;)<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1查看以下代码</p><div class="language-html line-numbers-mode" data-ext="html"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight html"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-symbol">&amp;lt;</span>div class=&quot;item-time active&quot;<br>     v-for=&quot;(item,index) in dateMenus&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>div class=&quot;time-clock&quot;<span class="hljs-symbol">&amp;gt;</span>&#123;&#123;item&#125;&#125;<span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>div class=&quot;time-state-on&quot;<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>span class=&quot;on-text&quot; v-if=&quot;index==0&quot;<span class="hljs-symbol">&amp;gt;</span>快抢中<span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>span class=&quot;on-over&quot; v-if=&quot;index==0&quot;<span class="hljs-symbol">&amp;gt;</span>距离结束：01:02:03<span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><br><br>        <span class="hljs-symbol">&amp;lt;</span>span class=&quot;on-text&quot; v-if=&quot;index<span class="hljs-symbol">&amp;gt;</span>0&quot;<span class="hljs-symbol">&amp;gt;</span>即将开始<span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>span class=&quot;on-over&quot; v-if=&quot;index<span class="hljs-symbol">&amp;gt;</span>0&quot;<span class="hljs-symbol">&amp;gt;</span>距离开始：03:02:01<span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2通过网关访问，需要将 moment.min.js 放入网关的静态资源中</p><figure><img class="lazy" alt="image-20211228183457892" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228183457892-72e70fbf.png" tabindex="0"/><figcaption>image-20211228183457892</figcaption></figure><p>3启动web-seckill 重启,访问 <a href="http://localhost:8001/api/wseckillgoods/toIndex" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/wseckillgoods/toIndex<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>效果如下：</p><figure><img class="lazy" alt="image-20211228184523710" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228184523710-39f0d525.png" tabindex="0"/><figcaption>image-20211228184523710</figcaption></figure><h4 id="_3-3-3-时间格式化" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-3-时间格式化">#</a> 3.3.3 时间格式化</h4><p>上面菜单循环输出后，会出现如上图效果，时间格式全部不对，我们需要引入一个moment.min.js来格式化时间。</p><p>1）引入moment.min.js</p><p>2）添加过滤器</p><div class="language-javascript line-numbers-mode" data-ext="js"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight javascript"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">//过滤器</span><br><span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-string">&quot;dateFilter&quot;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">date, formatPattern</span>)&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">moment</span>(date).<span class="hljs-title function_">format</span>(formatPattern || <span class="hljs-string">&quot;YYYY-MM-DD HH:mm:ss&quot;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>取值格式化</li></ol><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>div class=&quot;time-clock&quot;<span class="hljs-symbol">&amp;gt;</span>&#123;&#123;item | dateFilter(&#x27;HH:mm&#x27;)&#125;&#125;<span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>重启webseckill,重新访问：<a href="http://localhost:8001/api/wseckillgoods/toIndex" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/wseckillgoods/toIndex<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 。时间菜单效果如下</p><figure><img class="lazy" alt="image-20211228220700312" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228220700312-51c6c1f3.png" tabindex="0"/><figcaption>image-20211228220700312</figcaption></figure><h4 id="_3-3-4-选中实现-了解" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-4-选中实现-了解">#</a> 3.3.4 选中实现 -了解</h4><h5 id="_3-3-4-1-思路分析" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-4-1-思路分析">#</a> 3.3.4.1 思路分析</h5><figure><img class="lazy" alt="image-20211227225123244" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211227225123244-a6b4bd7b.png" tabindex="0"/><figcaption>image-20211227225123244</figcaption></figure><p>根据原型图，是让当前第一个时间菜单为选中状态，并且加载第一个菜单对应的数据。</p><p>我们可以先定义一个ctime=0，用来记录当前选中的菜单下标，因为默认第一个选中，第一个下标为0，所以初始值为0，每次点击对应菜单的时候，将被点击的菜单的下标值赋值给ctime,然后在每个菜单上判断，下标=ctime则让该菜单选中。</p><h5 id="_3-3-4-2-代码实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-4-2-代码实现">#</a> 3.3.4.2 代码实现</h5><p>1）定义ctime=0</p><div class="language-javascript line-numbers-mode" data-ext="js"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight javascript"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;<br>    <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app&#x27;</span>,<br>    <span class="hljs-title function_">data</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> &#123;<br>            <span class="hljs-attr">goodslist</span>: [],<br>            <span class="hljs-attr">dateMenus</span>:[],<br>            <span class="hljs-attr">ctime</span>:<span class="hljs-number">0</span>     <span class="hljs-comment">//当前时间菜单选中的下标</span><br>        &#125;<br>    &#125;<br>&#125;)<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2）页面样式控制：</p><div class="language-html line-numbers-mode" data-ext="html"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight html"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-symbol">&amp;lt;</span>div class=&quot;item-time &quot; v-for=&quot;(item,index) in dateMenus&quot; :class=&quot;[&#x27;item-time&#x27;,index==ctime?&#x27;active&#x27;:&#x27;&#x27;]&quot; @click=&quot;ctime=index;&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>div class=&quot;time-clock&quot;<span class="hljs-symbol">&amp;gt;</span>&#123;&#123;item | dateFilter(&#x27;HH:mm&#x27;)&#125;&#125;<span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>div class=&quot;time-state-on&quot;<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>span class=&quot;on-text&quot; v-if=&quot;index==0&quot;<span class="hljs-symbol">&amp;gt;</span>快抢中<span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>span class=&quot;on-over&quot; v-if=&quot;index==0&quot;<span class="hljs-symbol">&amp;gt;</span>距离结束：01:02:34<span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><br><br>        <span class="hljs-symbol">&amp;lt;</span>span class=&quot;on-text&quot; v-if=&quot;index<span class="hljs-symbol">&amp;gt;</span>0&quot;<span class="hljs-symbol">&amp;gt;</span>即将开始<span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>span class=&quot;on-over&quot; v-if=&quot;index<span class="hljs-symbol">&amp;gt;</span>0&quot;<span class="hljs-symbol">&amp;gt;</span>距离开始：01:02:34<span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启webseckill,重新访问：<a href="http://localhost:8001/api/wseckillgoods/toIndex" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/wseckillgoods/toIndex<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 。时间菜单效果如下</p><figure><img class="lazy" alt="image-20211228221742713" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228221742713-c804fc90.png" tabindex="0"/><figcaption>image-20211228221742713</figcaption></figure><h4 id="_3-3-5-倒计时实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-5-倒计时实现">#</a> 3.3.5 倒计时实现</h4><h5 id="_3-3-5-1-倒计时实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-5-1-倒计时实现">#</a> 3.3.5.1 倒计时实现</h5><h6 id="_3-3-5-1-1-基础数据显示" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-5-1-1-基础数据显示">#</a> 3.3.5.1.1 基础数据显示</h6><p>定义一个集合，用于存放五个时间段的倒计时时间差，集合中每一个角标都对应一个倒计时时间差，比如：集合角标为0，对应第一个倒计时时间差。集合角标为1，对应第二个倒计时时间差，依次类推。</p><figure><img class="lazy" alt="image-20211228233511074" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228233511074-5642d26d.png" tabindex="0"/><figcaption>image-20211228233511074</figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">alltimes:[5555555,66666666,77777777,888888888,9999999999]<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>2从该集合中获取内容，并更新倒计时时间</p><figure><img class="lazy" alt="image-20211228233617374" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228233617374-a6178690.png" tabindex="0"/><figcaption>image-20211228233617374</figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">&amp;lt;span class=&quot;on-over&quot; v-if=&quot;index==0&quot;&amp;gt;距离结束：&#123;&#123;alltimes[index]&#125;&#125;&amp;lt;/span&amp;gt;<br>&amp;lt;span class=&quot;on-over&quot; v-if=&quot;index&amp;gt;0&quot;&amp;gt;距离开始：&#123;&#123;alltimes[index]&#125;&#125;&amp;lt;/span&amp;gt;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>重启webseckill,重新访问：<a href="http://localhost:8001/api/wseckillgoods/toIndex" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/wseckillgoods/toIndex<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 。时间菜单效果如下</p><figure><img class="lazy" alt="image-20211228222758434" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228222758434-8465bb69.png" tabindex="0"/><figcaption>image-20211228222758434</figcaption></figure><h6 id="_3-3-5-1-2-每个时间差倒计时实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-5-1-2-每个时间差倒计时实现">#</a> 3.3.5.1.2 每个时间差倒计时实现</h6><p>周期执行函数用法如下：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">window.setInterval(function()&#123;//要做的事&#125;,1000);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>结束执行周期函数用法如下：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">window.clearInterval(timers);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>具体代码如下：</p><figure><img class="lazy" alt="image-20211228233649926" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228233649926-2b77aac3.png" tabindex="0"/><figcaption>image-20211228233649926</figcaption></figure><div class="language-javascript line-numbers-mode" data-ext="js"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight javascript"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">//时间差递减</span><br><span class="hljs-keyword">let</span> timers = <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&amp;lt;app.<span class="hljs-property">alltimes</span>.<span class="hljs-property">length</span>;i++)&#123;<br>        <span class="hljs-comment">//时间递减</span><br>        app.$set(app.<span class="hljs-property">alltimes</span>,i,app.<span class="hljs-property">alltimes</span>[i]-<span class="hljs-number">1000</span>);<br>        <span class="hljs-keyword">if</span>(app.<span class="hljs-property">alltimes</span>[i]&amp;lt;=<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-comment">//停止倒计时</span><br>            <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">clearInterval</span>(timers);<br>            <span class="hljs-comment">//当任意一个时间&amp;lt;=0的时候，需要重新刷新菜单，并刷新对应的数据</span><br>            app.<span class="hljs-title function_">loadMenus</span>();<br>        &#125;<br>    &#125;<br>&#125;,<span class="hljs-number">1000</span>);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启webseckill,重新访问：<a href="http://localhost:8001/api/wseckillgoods/toIndex" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/wseckillgoods/toIndex<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 。时间菜单效果如下可以发现每一个时间段的时间都在每秒递减。</p><figure><img class="lazy" alt="image-20211228223420084" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228223420084-224a7a1f.png" tabindex="0"/><figcaption>image-20211228223420084</figcaption></figure><h6 id="_3-3-5-1-3-倒计时时间格式化" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-5-1-3-倒计时时间格式化">#</a> 3.3.5.1.3 倒计时时间格式化</h6><p>将此工具引入页面js方法中，用于时间计算。注意和loadMenus方法平行</p><div class="language-javascript line-numbers-mode" data-ext="js"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight javascript"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">//将毫秒转换成时分秒</span><br><span class="hljs-attr">timedown</span>:<span class="hljs-keyword">function</span>(<span class="hljs-params">num</span>) &#123;<br>    <span class="hljs-keyword">var</span> oneSecond = <span class="hljs-number">1000</span>;<br>    <span class="hljs-keyword">var</span> oneMinute=oneSecond*<span class="hljs-number">60</span>;<br>    <span class="hljs-keyword">var</span> oneHour=oneMinute*<span class="hljs-number">60</span><br>    <span class="hljs-comment">//小时</span><br>    <span class="hljs-keyword">var</span> hours =<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(num/oneHour);<br>    <span class="hljs-comment">//分钟</span><br>    <span class="hljs-keyword">var</span> minutes=<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((num%oneHour)/oneMinute);<br>    <span class="hljs-comment">//秒</span><br>    <span class="hljs-keyword">var</span> seconds=<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((num%oneMinute)/oneSecond);<br>    <span class="hljs-comment">//拼接时间格式</span><br>    <span class="hljs-keyword">var</span> str = hours+<span class="hljs-string">&#x27;:&#x27;</span>+minutes+<span class="hljs-string">&#x27;:&#x27;</span>+seconds;<br>    <span class="hljs-keyword">return</span> str;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改时间差显示设置</p><figure><img class="lazy" alt="image-20211228233710801" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228233710801-d1626944.png" tabindex="0"/><figcaption>image-20211228233710801</figcaption></figure><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>div class=&quot;time-state-on&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>span class=&quot;on-text&quot; v-if=&quot;index==0&quot;<span class="hljs-symbol">&amp;gt;</span>快抢中<span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>span class=&quot;on-over&quot; v-if=&quot;index==0&quot;<span class="hljs-symbol">&amp;gt;</span>距离结束：&#123;&#123;timedown(alltimes[index])&#125;&#125;<span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><br><br>    <span class="hljs-symbol">&amp;lt;</span>span class=&quot;on-text&quot; v-if=&quot;index<span class="hljs-symbol">&amp;gt;</span>0&quot;<span class="hljs-symbol">&amp;gt;</span>即将开始<span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>span class=&quot;on-over&quot; v-if=&quot;index<span class="hljs-symbol">&amp;gt;</span>0&quot;<span class="hljs-symbol">&amp;gt;</span>距离开始：&#123;&#123;timedown(alltimes[index])&#125;&#125;<span class="hljs-symbol">&amp;lt;</span>/span<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重新访问进行测试。效果如下：</p><figure><img class="lazy" alt="image-20211228223724484" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228223724484-7663f5b3.png" tabindex="0"/><figcaption>image-20211228223724484</figcaption></figure><h6 id="_3-3-5-1-4-正确倒计时时间显示" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-3-5-1-4-正确倒计时时间显示">#</a> 3.3.5.1.4 正确倒计时时间显示</h6><p>现在页面中，对于倒计时时间集合内的数据，暂时写的为假数据，现在需要让集合内容的数据是经过计算得出的。第一个是距离结束时间倒计时，后面的4个都是距离开始倒计时，每个倒计时其实就是2个时差，计算方式如下：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">第1个时差：第2个抢购开始时间-当前时间，距离结束时间<br>第2个时差：第2个抢购开始时间-当前时间，距离开始时间<br>第3个时差：第3个抢购开始时间-当前时间，距离开始时间<br>第4个时差：第4个抢购开始时间-当前时间，距离开始时间<br>第5个时差：第5个抢购开始时间-当前时间，距离开始时间<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img class="lazy" alt="image-20211228233749415" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228233749415-e772a6da.png" tabindex="0"/><figcaption>image-20211228233749415</figcaption></figure><div class="language-javascript line-numbers-mode" data-ext="js"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight javascript"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-attr">loadMenus</span>:<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/wseckill/timeMenus&quot;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) &#123;<br>        app.<span class="hljs-property">dateMenus</span>=response.<span class="hljs-property">data</span>;<br><br>        <span class="hljs-comment">//查询当前时间段对应的秒杀商品</span><br><br><span class="hljs-number">353</span>-<span class="hljs-number">362</span> <span class="hljs-comment">//循环所有时间菜单</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&amp;lt;app.<span class="hljs-property">dateMenus</span>.<span class="hljs-property">length</span>;i++)&#123;<br>            <span class="hljs-comment">//运算每个时间菜单倒计时时间差</span><br>            <span class="hljs-keyword">if</span> (i==<span class="hljs-number">0</span>)&#123;<br>                <span class="hljs-comment">//距离结束时间</span><br>                <span class="hljs-keyword">var</span> x =i+<span class="hljs-number">1</span>;<br>                app.$set(app.<span class="hljs-property">alltimes</span>,i,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(app.<span class="hljs-property">dateMenus</span>[x]).<span class="hljs-title function_">getTime</span>()-<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>());<br>            &#125; <span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-comment">//距离开始时间</span><br>                app.$set(app.<span class="hljs-property">alltimes</span>,i,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(app.<span class="hljs-property">dateMenus</span>[i]).<span class="hljs-title function_">getTime</span>()-<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>());<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//时间差递减</span><br>        <span class="hljs-keyword">let</span> timers = <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&amp;lt;app.<span class="hljs-property">alltimes</span>.<span class="hljs-property">length</span>;i++)&#123;<br>                <span class="hljs-comment">//时间递减</span><br>                app.$set(app.<span class="hljs-property">alltimes</span>,i,app.<span class="hljs-property">alltimes</span>[i]-<span class="hljs-number">1000</span>);<br>            &#125;<br>        &#125;,<span class="hljs-number">1000</span>);<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>清空alltimes数据</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">alltimes:[]<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>重启webseckill,重新访问：<a href="http://localhost:8001/api/wseckillgoods/toIndex" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/wseckillgoods/toIndex<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 。</p><figure><img class="lazy" alt="image-20211228224140244" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228224140244-15daa036.png" tabindex="0"/><figcaption>image-20211228224140244</figcaption></figure><h3 id="_3-4-加载秒杀商品实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-4-加载秒杀商品实现">#</a> 3.4 加载秒杀商品实现</h3><figure><img class="lazy" alt="image-20211228224817607" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228224817607-0818abad.png" tabindex="0"/><figcaption>image-20211228224817607</figcaption></figure><p>当前已经完成了秒杀时间段菜单的显示，那么当用户在切换不同的时间段的时候，需要按照用户所选择的时间去显示相对应时间段下的秒杀商品。</p><h4 id="_3-4-1-秒杀服务-查询秒杀商品列表" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-4-1-秒杀服务-查询秒杀商品列表">#</a> 3.4.1 秒杀服务-查询秒杀商品列表</h4><figure><img class="lazy" alt="image-20211228224907652" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228224907652-9b80f640.png" tabindex="0"/><figcaption>image-20211228224907652</figcaption></figure><h5 id="_3-4-1-1-秒杀服务-service" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-4-1-1-秒杀服务-service">#</a> 3.4.1.1 秒杀服务- service</h5><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SecKillGoodsService</span> &#123;<br>     <span class="hljs-comment">//查询秒杀商品列表</span><br>    List&amp;lt;SeckillGoods&amp;gt; list(String time);<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现类</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecKillGoodsServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SecKillGoodsService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SECKILL_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;seckill_goods_&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询秒杀商品列表</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> time</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&amp;lt;SeckillGoods&amp;gt; list(String time) &#123;<br>        <span class="hljs-keyword">return</span> redisTemplate.boundHashOps(SECKILL_KEY+time).values();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-4-1-2-秒杀服务-controller" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-4-1-2-秒杀服务-controller">#</a> 3.4.1.2 秒杀服务-controller</h5><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/seckillgoods&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecKillController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SecKillGoodsService secKillGoodsService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询秒杀商品列表</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> time</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/list&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&amp;lt;List&amp;lt;SeckillGoods&amp;gt;&amp;gt; list(<span class="hljs-meta">@RequestParam(&quot;time&quot;)</span> String time)&#123;<br>        List&amp;lt;SeckillGoods&amp;gt; seckillGoodsList  = secKillGoodsService.list(time);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&amp;lt;List&amp;lt;SeckillGoods&amp;gt;&amp;gt;(<span class="hljs-literal">true</span>, StatusCode.OK,<span class="hljs-string">&quot;查询秒杀商品成功&quot;</span>,seckillGoodsList);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-4-1-3-杀服务api-feign接口定义" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-4-1-3-杀服务api-feign接口定义">#</a> 3.4.1.3 杀服务Api- feign接口定义</h5><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name=&quot;seckill&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SecKillFeign</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询秒杀商品列表</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> time</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/seckillgoods/list&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&amp;lt;List&amp;lt;SeckillGoods&amp;gt;&amp;gt; list(<span class="hljs-meta">@RequestParam(&quot;time&quot;)</span> String time);<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-4-1-4-查询秒杀商品放行-想想为什么" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-4-1-4-查询秒杀商品放行-想想为什么">#</a> 3.4.1.4 查询秒杀商品放行-想想为什么</h5><p>更改秒杀微服务的ResourceServerConfig类，对查询方法放行</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">//所有请求必须认证通过</span><br>    http.authorizeRequests()<br>        <span class="hljs-comment">//下边的路径放行</span><br>        .antMatchers(<br>        <span class="hljs-string">&quot;/seckillgoods/list/**&quot;</span>). <span class="hljs-comment">//配置地址放行</span><br>        permitAll()<br>        .anyRequest().<br>        authenticated();    <span class="hljs-comment">//其他地址需要认证授权</span><br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-4-2-秒杀渲染服务-查询秒杀商品列表" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-4-2-秒杀渲染服务-查询秒杀商品列表">#</a> 3.4.2 秒杀渲染服务-查询秒杀商品列表</h4><figure><img class="lazy" alt="image-20211228230009990" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/w7S6Sn35.png" tabindex="0"/><figcaption>image-20211228230009990</figcaption></figure><p>oauth2 :1 导包 2公钥 3配置类</p><p>调用feign：1导包 api 2EnableFeignClients 3feign拦截器</p><h5 id="_3-4-2-1-更新ydles-web-seckill的启动类" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-4-2-1-更新ydles-web-seckill的启动类">#</a> 3.4.2.1 更新ydles_web_seckill的启动类</h5><p>添加feign接口扫描</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableFeignClients(basePackages = &quot;com.ydles.seckill.feign&quot;)</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><h5 id="_3-4-2-2-更新ydles-web-seckill的seckillgoodscontroller" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-4-2-2-更新ydles-web-seckill的seckillgoodscontroller">#</a> 3.4.2.2 更新ydles_web_seckill的SecKillGoodsController</h5><p>注入secKillFeign，并添加获取秒杀商品列表方法实现</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取秒杀商品列表</span><br><span class="hljs-comment">     * 默认当前时间</span><br><span class="hljs-comment">     */</span><br><span class="hljs-meta">@RequestMapping(&quot;/list&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> Result&amp;lt;List&amp;lt;SeckillGoods&amp;gt;&amp;gt; list(String time)&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">timeStr</span> <span class="hljs-operator">=</span> DateUtil.formatStr(time);<br>        System.out.println(timeStr);<br>        <span class="hljs-keyword">return</span> secKillGoodsFeign.list(timeStr);<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-4-2-3-更新seckill-index-html。添加按照时间查询方法" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-4-2-3-更新seckill-index-html。添加按照时间查询方法">#</a> 3.4.2.3 更新secKill-index.html。添加按照时间查询方法</h5><figure><img class="lazy" alt="image-20200310181130832" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20200310181130832-b7ad38fc.png" tabindex="0"/><figcaption>image-20200310181130832</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//按照时间查询秒杀商品列表</span><br>searchList:function (time) &#123;<br>    axios.get(<span class="hljs-string">&#x27;/api/wseckillgoods/list?time=&#x27;</span>+time).then(function (response) &#123;<br>        <span class="hljs-keyword">if</span> (response.data.flag)&#123;<br>            app.goodslist = response.data.data;<br>        &#125;<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-4-2-4-更新seckill-index-html。-加载页面时-默认当前时间查询" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-4-2-4-更新seckill-index-html。-加载页面时-默认当前时间查询">#</a> 3.4.2.4 更新secKill-index.html。 加载页面时，默认当前时间查询</h5><figure><img class="lazy" alt="image-20211228233810290" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228233810290-2e074c3a.png" tabindex="0"/><figcaption>image-20211228233810290</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//查询当前时间段对应的秒杀商品</span><br>app.searchList(app.dateMenus[<span class="hljs-number">0</span>]);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-4-2-5-更新seckill-index-html。切换时间菜单-查询秒杀商品" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-4-2-5-更新seckill-index-html。切换时间菜单-查询秒杀商品">#</a> 3.4.2.5 更新secKill-index.html。切换时间菜单,查询秒杀商品</h5><figure><img class="lazy" alt="image-20211228233831720" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228233831720-d51ed71c.png" tabindex="0"/><figcaption>image-20211228233831720</figcaption></figure><div class="language-html line-numbers-mode" data-ext="html"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight html"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-symbol">&amp;lt;</span>div class=&quot;item-time &quot;<br>     v-for=&quot;(item,index) in dateMenus&quot;<br>     :class=&quot;[&#x27;item-time&#x27;,index==ctime?&#x27;active&#x27;:&#x27;&#x27;]&quot;<br>     @click=&quot;ctime=index;searchList(item)&quot;<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/div<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启秒杀和秒杀页面服务， <a href="http://localhost:8001/api/wseckillgoods/toIndex" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/wseckillgoods/toIndex<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img class="lazy" alt="image-20211228232748991" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228232748991-0450b613.png" tabindex="0"/><figcaption>image-20211228232748991</figcaption></figure><h3 id="_3-5-抢购按钮" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-5-抢购按钮">#</a> 3.5 抢购按钮</h3><p>因为当前业务设定为用户秒杀商品为sku，所以当用户点击立即抢购按钮的时候，则直接进行下单操作。</p><h4 id="_3-5-1-js定义" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-5-1-js定义">#</a> 3.5.1 js定义</h4><p>在秒杀首页添加下单方法</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//秒杀下单</span><br>add:function(id)&#123;<br>    app.msg =<span class="hljs-string">&#x27;正在下单&#x27;</span>;<br>    axios.get(<span class="hljs-string">&quot;/api/wseckillorder/add?time=&quot;</span>+moment(app.dateMenus[<span class="hljs-number">0</span>]).format(<span class="hljs-string">&quot;YYYYMMDDHH&quot;</span>)+<span class="hljs-string">&quot;&amp;amp;id=&quot;</span>+id).then(function (response) &#123;<br>        <span class="hljs-keyword">if</span> (response.data.flag)&#123;<br>            app.msg=<span class="hljs-string">&#x27;抢单成功，即将进入支付!&#x27;</span>;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            app.msg=<span class="hljs-string">&#x27;抢单失败&#x27;</span>;<br>        &#125;<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-5-2-调用下单方法" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-5-2-调用下单方法">#</a> 3.5.2 调用下单方法</h4><p>修改抢购按钮，添加事件</p><div class="language-html line-numbers-mode" data-ext="html"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight html"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-symbol">&amp;lt;</span>a class=&#x27;sui-btn btn-block btn-buy&#x27;  href=&#x27;javascript:void(0)&#x27; @click=&quot;add(item.id)&quot;<span class="hljs-symbol">&amp;gt;</span>立即抢购<span class="hljs-symbol">&amp;lt;</span>/a<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><h4 id="_3-5-3-秒杀web页面-新增controller" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-5-3-秒杀web页面-新增controller">#</a> 3.5.3 秒杀web页面 新增Controller</h4><p>SecKillOrderController</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/wseckillorder&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecKillOrderController</span> &#123;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/add&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;time&quot;)</span> String time, <span class="hljs-meta">@RequestParam(&quot;id&quot;)</span>Long id)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;进入秒杀订单逻辑了！&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>网关配置：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">#秒杀渲染微服务<br>- id: ydles_seckill_web_route<br>  uri: lb://seckill-web<br>  predicates:<br>    - Path=/api/wseckillgoods/**,/api/wseckillorder/**<br>  filters:<br>    - StripPrefix=1<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试：重启秒杀页面，网关服务， 访问<a href="http://localhost:8001/api/wseckillgoods/toIndex" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/wseckillgoods/toIndex<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ，点击立即抢购</p><figure><img class="lazy" alt="image-20211228235033816" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228235033816-c450b648.png" tabindex="0"/><figcaption>image-20211228235033816</figcaption></figure><p>后台打印：</p><figure><img class="lazy" alt="image-20211228235038565" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/AAAAAElF.png" tabindex="0"/><figcaption>image-20211228235038565</figcaption></figure><p>总结：</p><p>1秒杀业务</p><p>三高：</p><p>控制：时间段 数量</p><p>单独：数据库 微服务 页面</p><p>2秒杀商品 存入缓存</p><figure><img class="lazy" alt="image-20211228160425046" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228160425046-fa761d21.png" tabindex="0"/><figcaption>image-20211228160425046</figcaption></figure><p>3首页</p><figure><img class="lazy" alt="image-20211228235345701" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20211228235345701-9bfef3d0.png" tabindex="0"/><figcaption>image-20211228235345701</figcaption></figure><h1 id="第16章-秒杀后端" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第16章-秒杀后端">#</a> 第16章-秒杀后端</h1><p>角色：<strong>架构师</strong></p><p>测试：功能测试 压力测试 1万/s 20万/s</p><p>1实现秒杀<strong>异步</strong>下单,掌握如何保证生产者&amp;消费者消息不丢失</p><p>2实现防止恶意刷单</p><p>3实现防止相同商品重复秒杀</p><p>4实现秒杀下单接口隐藏</p><p>5实现下单接口限流</p><h2 id="_1-秒杀异步下单-重点-难点" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-秒杀异步下单-重点-难点">#</a> 1 秒杀异步下单-重点-难点</h2><p>用户在下单的时候，需要基于JWT令牌信息进行登陆人信息认证，确定当前订单是属于谁的。</p><p><strong>为什么要异步下单</strong>：针对秒杀的特殊业务场景，仅仅依靠对象缓存或者页面静态化等技术去解决服务端压力还是远远不够。对于数据库压力还是很大，所以需要异步下单，异步是最好的解决办法，但会带来一些额外的程序上的<strong>复杂性</strong>。</p><p><strong>流程：异步 service_seckill接收下单消息---》MQ ------》service_consume 完成剩余操作</strong></p><figure><img class="lazy" alt="image-20220102104824795" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102104824795-0202d8c0.png" tabindex="0"/><figcaption>image-20220102104824795</figcaption></figure><h3 id="_1-1-秒杀服务-下单实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-1-秒杀服务-下单实现">#</a> 1.1 秒杀服务-下单实现</h3><figure><img class="lazy" alt="image-20220102115218841" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102115218841-29301bad.png" tabindex="0"/><figcaption>image-20220102115218841</figcaption></figure><p><strong>1）将tokenDecode工具类从order工程放入秒杀服务并声明Bean, ydles_service_seckill服务</strong></p><figure><img class="lazy" alt="image-20220102115503524" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102115503524-416a3769.png" tabindex="0"/><figcaption>image-20220102115503524</figcaption></figure><p>启动类添加</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> TokenDecode <span class="hljs-title function_">tokenDecode</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TokenDecode</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2）新建下单controller并声明方法</strong></p><p>ydles_service_seckill服务</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@CrossOrigin</span><br><span class="hljs-meta">@RequestMapping(&quot;/seckillorder&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecKillOrderController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TokenDecode tokenDecode;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SecKillOrderService secKillOrderService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 秒杀下单</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> time 当前时间段</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id 秒杀商品id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/add&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;time&quot;)</span> String time, <span class="hljs-meta">@RequestParam(&quot;id&quot;)</span> Long id)</span>&#123;<br>        <span class="hljs-comment">//获取当前登陆人</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> tokenDecode.getUserInfo().get(<span class="hljs-string">&quot;username&quot;</span>);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> secKillOrderService.add(id,time,username);<br>        <span class="hljs-keyword">if</span> (result)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>(<span class="hljs-literal">true</span>, StatusCode.OK,<span class="hljs-string">&quot;下单成功&quot;</span>);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>(<span class="hljs-literal">false</span>,StatusCode.ERROR,<span class="hljs-string">&quot;下单失败&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3) 新建service接口</strong></p><p>ydles_service_seckill服务</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SecKillOrderService</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 秒杀下单</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id 商品id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> time 时间段</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> username 登陆人姓名</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">add</span><span class="hljs-params">(Long id, String time, String username)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img class="lazy" alt="image-20220102121935545" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102121935545-f2a178a8.png" tabindex="0"/><figcaption>image-20220102121935545</figcaption></figure><p><strong>4）更改预加载秒杀商品</strong></p><p>当预加载秒杀商品的时候，提前加载每一个商品的库存信息，后续减库存操作也会先<strong>预扣减缓存中的库存再异步扣减mysql数据</strong>。</p><p>预扣减库存会基于redis原子性操作实现</p><figure><img class="lazy" alt="image-20220102122324659" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102122324659-08477586.png" tabindex="0"/><figcaption>image-20220102122324659</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//秒杀商品库存头</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SECKILL_GOODS_STOCK_COUNT_KEY=<span class="hljs-string">&quot;seckill_goods_stock_count_&quot;</span>;<br><br><br><span class="hljs-comment">//加载秒杀商品的库存</span><br>redisTemplate.opsForValue().set(SECKILL_GOODS_STOCK_COUNT_KEY + seckillGoods.getId(), seckillGoods.getStockCount());<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>5）秒杀下单业务层实现</strong></p><p>业务逻辑：</p><p>获取秒杀商品数据与库存量数据，如果没有库存则抛出异常</p><p>预扣减库存，如果扣完库存量&lt;0，删除商品数据与库存数据</p><p>如果库存量&gt;=0，创建秒杀订单，并存入redis</p><p>基于mq异步方式完成与mysql数据同步（最终一致性）</p><p><strong>注意：库存数据从redis中取出，转换成String</strong></p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Created</span> by IT李老师</span><br><span class="hljs-comment"> * 公主号 “IT李哥交朋友”</span><br><span class="hljs-comment"> * 个人微 itlils</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecKillOrderServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SecKillOrderService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    RedisTemplate redisTemplate;<br>    <span class="hljs-meta">@Autowired</span><br>    IdWorker idWorker;<br>    <span class="hljs-comment">//redis 秒杀商品key开头</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SECKILL_GOODS_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;seckill_goods_&quot;</span>;<br>    <span class="hljs-comment">//秒杀商品库存key头</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SECKILL_GOODS_STOCK_COUNT_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;seckill_goods_stock_count_&quot;</span>;<br><br>    <span class="hljs-comment">//秒杀下单</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">add</span><span class="hljs-params">(Long id, String time, String username)</span> &#123;<br>        <span class="hljs-comment">//1redis获取商品的数据以及库存量，如果没有，抛出异常</span><br>        <span class="hljs-type">SeckillGoods</span> <span class="hljs-variable">seckillGoods</span> <span class="hljs-operator">=</span> (SeckillGoods) redisTemplate.boundHashOps(SECKILL_GOODS_KEY + time).get(id);<br>        <span class="hljs-keyword">if</span> (seckillGoods == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-comment">//redisTemplate用的是string序列化</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">redisStock</span> <span class="hljs-operator">=</span> (String) redisTemplate.boundValueOps(SECKILL_GOODS_STOCK_COUNT_KEY + id).get();<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(redisStock)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> Integer.parseInt(redisStock);<br>        <span class="hljs-keyword">if</span> (stock &amp;lt;= <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//2预扣减库存，如果扣成0，删除商品信息和库存信息</span><br>        <span class="hljs-comment">//Integer integer = (Integer) redisTemplate.opsForValue().get(SECKILL_GOODS_STOCK_COUNT_KEY + id);//100</span><br>        <span class="hljs-comment">//integer=integer-1;//99</span><br>        <span class="hljs-comment">//redisTemplate.boundValueOps(SECKILL_GOODS_STOCK_COUNT_KEY + id).set(integer);//99</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">decrement</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().decrement(SECKILL_GOODS_STOCK_COUNT_KEY + id);<br>        <span class="hljs-keyword">if</span>(decrement&amp;lt;=<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-comment">//如果扣成0，删除商品信息</span><br>            redisTemplate.boundHashOps(SECKILL_GOODS_KEY + time).delete(id);<br>            <span class="hljs-comment">//库存信息</span><br>            redisTemplate.delete(SECKILL_GOODS_STOCK_COUNT_KEY + id);<br>        &#125;<br><br>        <span class="hljs-comment">//3生成秒杀订单</span><br>        SeckillOrder seckillOrder=<span class="hljs-keyword">new</span> <span class="hljs-title class_">SeckillOrder</span>();<br>        seckillOrder.setId(idWorker.nextId());<br>        seckillOrder.setSeckillId(id);<br>        seckillOrder.setMoney(seckillGoods.getCostPrice());<br>        seckillOrder.setUserId(username);<br>        seckillOrder.setSeckillId(Long.parseLong(seckillGoods.getSellerId()));<br>        seckillOrder.setCreateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        seckillOrder.setStatus(<span class="hljs-string">&quot;0&quot;</span>);<br><br>        <span class="hljs-comment">//4订单数据往mq发</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-2-生产者保证消息不丢失-面试常问问题-重点" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-2-生产者保证消息不丢失-面试常问问题-重点">#</a> 1.2 生产者保证消息不丢失--面试常问问题-重点</h3><figure><img class="lazy" alt="image-20220102172807666" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102172807666-221fc969.png" tabindex="0"/><figcaption>image-20220102172807666</figcaption></figure><p>1rabbitMQ 工作流程。</p><p>生产者：tcp ---&gt;channel--&gt; exchang</p><p>消费者：tcp ------&gt;channal------&gt;queue 一个消费者监听<strong>一个</strong> <strong>队列</strong></p><p>绑定关系：交换机类型----绑定到队列----routingkey</p><p>2持久化</p><p>按照现有rabbitMQ的相关知识，生产者会发送消息到达消息服务器。但是在实际生产环境下，消息生产者发送的消息很有可能当到达了消息服务器之后，由于消息服务器的问题导致消息丢失，如宕机。因为消息服务器默认会将消息存储在内存中。一旦消息服务器宕机，则消息会产生丢失。因此要保证生产者的消息不丢失，要开始<strong>持久化策略</strong>。</p><div class="language-properties line-numbers-mode" data-ext="properties"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight properties"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">rabbitMQ持久化：</span><br>  <span class="hljs-attr">1.</span> <span class="hljs-string">交换机持久化</span><br>  <span class="hljs-attr">2.</span> <span class="hljs-string">队列持久化</span><br>  <span class="hljs-attr">3.</span> <span class="hljs-string">消息持久化</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3rabbitmq数据保护机制</p><p>但是如果仅仅只是开启这两部分的持久化，也很有可能造成消息丢失。因为消息服务器很有可能在持久化的过程中出现宕机。因此需要通过数据保护机制来保证消息一定会成功进行持久化，否则将一直进行消息发送。</p><div class="language-properties line-numbers-mode" data-ext="properties"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight properties"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">RabbitMQ数据保护机制</span><br>  <span class="hljs-attr">1</span> <span class="hljs-string">事务机制</span><br>    <span class="hljs-attr">事务机制采用类数据库的事务机制进行数据保护，当消息到达消息服务器，首先会开启一个事务，接着进行数据磁盘持久化，只有持久化成功才会进行事务提交，向消息生产者返回成功通知，消息生产者一旦接收成功通知则不会再发送此条消息。当出现异常，则返回失败通知.消息生产者一旦接收失败通知，则继续发送该条消息。</span><br>    <span class="hljs-attr">事务机制虽然能够保证数据安全，但是此机制采用的是同步机制，会产生系统间消息阻塞，影响整个系统的消息吞吐量。从而导致整个系统的性能下降，因此不建议使用。</span><br><br>  <span class="hljs-attr">2</span> <span class="hljs-string">confirm机制</span><br>    <span class="hljs-attr">confirm模式需要基于channel进行设置,</span> <span class="hljs-string">一旦某条消息被投递到队列之后,消息队列就会发送一个确认信息给生产者,如果队列与消息是可持久化的, 那么确认消息会等到消息成功写入到磁盘之后发出.</span><br>  <span class="hljs-attr">confirm的性能高,主要得益于它是异步的.生产者在将第一条消息发出之后等待确认消息的同时也可以继续发送后续的消息.当确认消息到达之后,就可以通过回调方法处理这条确认消息.</span> <span class="hljs-string">如果MQ服务宕机了,则会返回nack消息. 生产者同样在回调方法中进行后续处理。</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img class="lazy" alt="image-20220102174038302" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102174038302-d741825a.png" tabindex="0"/><figcaption>image-20220102174038302</figcaption></figure><p>拓展资料： <a href="https://www.cnblogs.com/vipstone/p/9350075.html" rel="noopener noreferrer" target="_blank">https://www.cnblogs.com/vipstone/p/9350075.html<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>4即使我们设计得这么完美，也不能保证数据100%全部发送、接受。</p><p>99.9999999% 机器运行成功率。 aws---&gt;paypal youtube</p><h4 id="_1-2-1-开启confirm机制" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-2-1-开启confirm机制">#</a> 1.2.1 开启confirm机制</h4><p><strong>ydles_service_seckill服务</strong></p><p><strong>1）更改秒杀服务配置文件</strong></p><div class="language-yaml line-numbers-mode" data-ext="yml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight yaml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.128</span><br>    <span class="hljs-attr">publisher-confirms:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#开启confirm机制</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2）开启队列持久化</strong> rabbit配置文件</p><p>rabbitMq使用：1导包 2配置文件 3配置类</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabbitMQConfig</span> &#123;<br><br>    <span class="hljs-comment">//秒杀商品订单消息</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SECKILL_ORDER_QUEUE=<span class="hljs-string">&quot;seckill_order&quot;</span>;<br><br>    <span class="hljs-comment">//声明队列，并开启持久化</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">queue</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 第一个参数：队列名称</span><br><span class="hljs-comment">         * 第二个参数：是否开启队列持久化</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(SECKILL_ORDER_QUEUE,<span class="hljs-literal">true</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3）消息持久化源码查看</strong></p><figure><img class="lazy" alt="image-20220102175146418" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102175146418-9c7a01b4.png" tabindex="0"/><figcaption>image-20220102175146418</figcaption></figure><figure><img class="lazy" alt="image-20220102175205923" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102175205923-5f2f320e.png" tabindex="0"/><figcaption>image-20220102175205923</figcaption></figure><figure><img class="lazy" alt="image-20220102180304161" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102180304161-ea2c6fb5.png" tabindex="0"/><figcaption>image-20220102180304161</figcaption></figure><figure><img class="lazy" alt="image-20220102180334328" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102180334328-9edf9ec6.png" tabindex="0"/><figcaption>image-20220102180334328</figcaption></figure><figure><img class="lazy" alt="image-20220102180355716" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102180355716-3b529d86.png" tabindex="0"/><figcaption>image-20220102180355716</figcaption></figure><p>的确，在消息convert转换的时候，设置属性是持久化的。</p><p>**4）增强rabbitTemplate ** config包下新建。重要：此类相当于我们手动完成confirm逻辑！</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Created</span> by IT李老师</span><br><span class="hljs-comment"> * 公主号 “IT李哥交朋友”</span><br><span class="hljs-comment"> * 个人微 itlils</span><br><span class="hljs-comment"> * 消息待发器</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfirmMessageSender</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RabbitTemplate</span>.ConfirmCallback&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    RabbitTemplate rabbitTemplate;<br>    <span class="hljs-meta">@Autowired</span><br>    RedisTemplate redisTemplate;<br><br>    <span class="hljs-comment">//redis 放的时候 开头的key</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String MESSAGE_CONFIRM_KEY=<span class="hljs-string">&quot;message_confirm_&quot;</span>;<br><br>    <span class="hljs-comment">//规定 有个构造器</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ConfirmMessageSender</span><span class="hljs-params">(RabbitTemplate rabbitTemplate)</span>&#123;<br>        <span class="hljs-comment">//本类和容器中的rabbitTemplate 建立联系</span><br>        <span class="hljs-built_in">this</span>.rabbitTemplate=rabbitTemplate;<br>        <span class="hljs-comment">//使用rabbitTemplate发的消息，必须有回调，回调给本类</span><br>        rabbitTemplate.setConfirmCallback(<span class="hljs-built_in">this</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//回调方法 exchange异步告知这条消息发送成功</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">confirm</span><span class="hljs-params">(CorrelationData correlationData, <span class="hljs-type">boolean</span> ack, String cause)</span> &#123;<br>        <span class="hljs-keyword">if</span>(ack)&#123;<br>            <span class="hljs-comment">//发送成功  删除掉存储空间的数据</span><br>            redisTemplate.delete(correlationData.getId());<br>            redisTemplate.delete(MESSAGE_CONFIRM_KEY+correlationData.getId());<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//发送失败  重发</span><br>            Map&amp;lt;String, String&amp;gt; map = redisTemplate.boundHashOps(MESSAGE_CONFIRM_KEY + correlationData.getId()).entries();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">exchange</span> <span class="hljs-operator">=</span> map.get(<span class="hljs-string">&quot;exchange&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">routingKey</span> <span class="hljs-operator">=</span> map.get(<span class="hljs-string">&quot;routingKey&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> map.get(<span class="hljs-string">&quot;message&quot;</span>);<br><br>            <span class="hljs-comment">//重发</span><br>            rabbitTemplate.convertAndSend(exchange,routingKey,message);<br>            <span class="hljs-comment">//预警 调用第三方接口：发短信，发邮件给到运维技术组长。log.warn</span><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//自定义发送的方法</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">send</span><span class="hljs-params">(String exchange,String routingKey,String message)</span>&#123;<br>        <span class="hljs-comment">//设置消息的唯一id</span><br>        CorrelationData correlationData=<span class="hljs-keyword">new</span> <span class="hljs-title class_">CorrelationData</span>(UUID.randomUUID().toString());<br>        <span class="hljs-comment">//运维快速的看哪个msg有问题了</span><br>        redisTemplate.boundValueOps(correlationData.getId()).set(message);<br><br>        <span class="hljs-comment">//保存发送的信息到 redis</span><br>        Map&amp;lt;String, String&amp;gt; map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&amp;lt;&amp;gt;();<br>        map.put(<span class="hljs-string">&quot;exchange&quot;</span>,exchange);<br>        map.put(<span class="hljs-string">&quot;routingKey&quot;</span>,routingKey);<br>        map.put(<span class="hljs-string">&quot;message&quot;</span>,message);<br>        redisTemplate.boundHashOps(MESSAGE_CONFIRM_KEY+correlationData.getId()).putAll(map);<br><br>        <span class="hljs-comment">//真正发送</span><br>        rabbitTemplate.convertAndSend(exchange,routingKey,message,correlationData);<br>    &#125;<br><br><br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-2-2发送消息" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-2-2发送消息">#</a> <strong>1.2.2发送消息</strong></h4><p>更改下单业务层实现</p><p>ydles_service_seckill服务SecKillOrderServiceImpl类</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> ConfirmMessageSender confirmMessageSender;      <br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//发送消息</span><br>confirmMessageSender.sendMessage(<span class="hljs-string">&quot;&quot;</span>, RabbitMQConfig.SECKILL_ORDER_KEY, JSON.toJSONString(seckillOrder));<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>测试：三个关键位置打断点：</p><p>1add方法</p><figure><img class="lazy" alt="image-20220102183240326" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102183240326-2c17e172.png" tabindex="0"/><figcaption>image-20220102183240326</figcaption></figure><p>2confirmSender 的send</p><figure><img class="lazy" alt="image-20220102183257423" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102183257423-337a507e.png" tabindex="0"/><figcaption>image-20220102183257423</figcaption></figure><p>3confirmSender 回调方法</p><figure><img class="lazy" alt="image-20220102183310057" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102183310057-583b8381.png" tabindex="0"/><figcaption>image-20220102183310057</figcaption></figure><p>4基于网关访问 修改网关路由</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">#秒杀微服务<br>- id: ydles_seckill_route<br>  uri: lb://seckill<br>  predicates:<br>    - Path=/api/seckill/**,/api/seckillorder/**<br>  filters:<br>    - StripPrefix=1<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>5重启网关、秒杀服务。</p><p>登陆： <a href="http://localhost:8001/api/oauth/toLogin" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/oauth/toLogin<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>根据时间 模拟秒杀： <a href="http://localhost:8001/api/seckillorder/add?time=2022-01-02%2018:00:00&amp;id=1" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/seckillorder/add?time=2022-01-02 18:00:00&amp;id=1<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="_1-3-秒杀下单服务-更新库存库" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-3-秒杀下单服务-更新库存库">#</a> 1.3 秒杀下单服务-更新库存库</h3><h4 id="_1-3-1-异步下单服务ydles-service-consume" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-3-1-异步下单服务ydles-service-consume">#</a> 1.3.1 异步下单服务ydles_service_consume</h4><p><strong>1）添加依赖</strong></p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>dependencies<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.ydles<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>ydles_common_db<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>1.0-SNAPSHOT<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework.cloud<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.ydles<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>ydles_service_order_api<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>1.0-SNAPSHOT<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.ydles<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>ydles_service_seckill_api<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>1.0-SNAPSHOT<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.ydles<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>ydles_service_goods_api<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>1.0-SNAPSHOT<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework.amqp<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-rabbit<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/dependencies<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2）新建application.yml</strong></p><div class="language-yaml line-numbers-mode" data-ext="yml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight yaml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9022</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">jackson:</span><br>    <span class="hljs-attr">time-zone:</span> <span class="hljs-string">GMT+8</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">sec-consume</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://192.168.200.128:3306/ydles_seckill?useUnicode=true&amp;amp;characterEncoding=utf-8&amp;amp;useSSL=false&amp;amp;allowMultiQueries=true&amp;amp;serverTimezone=GMT%2b8</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">main:</span><br>    <span class="hljs-attr">allow-bean-definition-overriding:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#当遇到同样名字的时候，是否允许覆盖注册</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.128</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.128</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:6868/eureka</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">hystrix:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">default:</span>   <span class="hljs-comment">#配置全局的feign的调用超时时间  如果 有指定的服务配置 默认的配置不会生效</span><br>        <span class="hljs-attr">connectTimeout:</span> <span class="hljs-number">60000</span> <span class="hljs-comment"># 指定的是 消费者 连接服务提供者的连接超时时间 是否能连接  单位是毫秒</span><br>        <span class="hljs-attr">readTimeout:</span> <span class="hljs-number">20000</span>  <span class="hljs-comment"># 指定的是调用服务提供者的 服务 的超时时间（）  单位是毫秒</span><br><span class="hljs-comment">#hystrix 配置</span><br><span class="hljs-attr">hystrix:</span><br>  <span class="hljs-attr">command:</span><br>    <span class="hljs-attr">default:</span><br>      <span class="hljs-attr">execution:</span><br>        <span class="hljs-attr">timeout:</span><br>          <span class="hljs-comment">#如果enabled设置为false，则请求超时交给ribbon控制</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">isolation:</span><br>          <span class="hljs-attr">strategy:</span> <span class="hljs-string">SEMAPHORE</span><br>          <span class="hljs-attr">thread:</span><br>            <span class="hljs-comment"># 熔断器超时时间，默认：1000/毫秒</span><br>            <span class="hljs-attr">timeoutInMilliseconds:</span> <span class="hljs-number">20000</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3）新建启动类</strong> com.ydles.consume</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-meta">@MapperScan(basePackages = &#123;&quot;com.ydles.consume.dao&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderConsumerApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(OrderConsumerApplication.class,args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-3-2-消费者手动ack下单实现-面试重点-认真听" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-3-2-消费者手动ack下单实现-面试重点-认真听">#</a> 1.3.2 消费者手动ACK下单实现--面试重点-认真听</h4><figure><img class="lazy" alt="image-20220102191752824" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220102191752824-887214db.png" tabindex="0"/><figcaption>image-20220102191752824</figcaption></figure><p>​ 按照现有RabbitMQ知识，可以得知当消息消费者成功接收到消息后，会进行消费并自动通知消息服务器将该条消息删除。此种方式的实现使用的是消费者自动应答机制。但是此种方式非常的不安全。</p><p>​ 在生产环境下，当消息消费者接收到消息，很有可能在处理消息的过程中出现意外情况从而导致消息丢失，因为如果使用自动应答机制是非常不安全。</p><p>​ 我们需要确保消费者当把消息成功处理完成之后，消息服务器才会将该条消息删除。此时要实现这种效果的话，就需要将<strong>自动应答转换为手动应答</strong>,只有在消息消费者将消息处理完，才会通知消息服务器将该条消息删除。</p><p><strong>1）更改配置文件</strong></p><div class="language-yaml line-numbers-mode" data-ext="yml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight yaml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.128</span><br>    <span class="hljs-attr">listener:</span><br>      <span class="hljs-attr">simple:</span><br>        <span class="hljs-attr">acknowledge-mode:</span> <span class="hljs-string">manual</span> <span class="hljs-comment">#手动</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>mq配置类</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabbitMQConfig</span> &#123;<br><br>    <span class="hljs-comment">//秒杀商品订单消息</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SECKILL_ORDER_QUEUE=<span class="hljs-string">&quot;seckill_order&quot;</span>;<br><br>    <span class="hljs-comment">//声明队列，并开启持久化</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">queue</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 第一个参数：队列名称</span><br><span class="hljs-comment">         * 第二个参数：是否开启队列持久化</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(SECKILL_ORDER_QUEUE,<span class="hljs-literal">true</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2）定义监听类</strong> <strong>回顾</strong>rabbitMQ与springboot整合时，形参Channel channel, Message message意义。</p><p>com.ydles.consumer.listener</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Created</span> by IT李老师</span><br><span class="hljs-comment"> * 公主号 “IT李哥交朋友”</span><br><span class="hljs-comment"> * 个人微 itlils</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecKillOrderListener</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    SeckillOrderService seckillOrderService;<br><br>    <span class="hljs-meta">@RabbitListener(queues = RabbitMQConfig.SECKILL_ORDER_QUEUE)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receiveMsg</span><span class="hljs-params">(Message message, Channel channel)</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">msgStr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(message.getBody());<br>        System.out.println(<span class="hljs-string">&quot;接受到了秒杀订单&quot;</span>+msgStr);<br>        <span class="hljs-comment">//1监听 order</span><br>        <span class="hljs-type">SeckillOrder</span> <span class="hljs-variable">seckillOrder</span> <span class="hljs-operator">=</span> JSON.parseObject(message.getBody(), SeckillOrder.class);<br>        <span class="hljs-comment">//2先做业务逻辑</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> seckillOrderService.createOrder(seckillOrder);<br><br>        <span class="hljs-keyword">if</span>(result&amp;gt;<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-comment">//2.1没问题    告诉mq收到消息了，可删</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                channel.basicAck(message.getMessageProperties().getDeliveryTag(),<span class="hljs-literal">false</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>                <span class="hljs-comment">//log.error</span><br>            &#125;<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//2.2有问题    告诉mq没收到消息，重回队列</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                channel.basicNack(message.getMessageProperties().getDeliveryTag(),<span class="hljs-literal">false</span>,<span class="hljs-literal">true</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>                <span class="hljs-comment">//log.error</span><br>            &#125;<br>        &#125;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3）定义业务层接口与实现类</p><figure><img class="lazy" alt="image-20220103094738284" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103094738284-38962074.png" tabindex="0"/><figcaption>image-20220103094738284</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SecKillOrderService</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(SeckillOrder seckillOrder)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecKillOrderServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SecKillOrderService</span>  &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SeckillGoodsMapper seckillGoodsMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SeckillOrderMapper seckillOrderMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 同步数据库，更改库存，添加订单</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> seckillOrder</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(SeckillOrder seckillOrder)</span> &#123;<br><br>        <span class="hljs-comment">//更改库存</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> seckillGoodsMapper.updateStockCountById(seckillOrder.getId());<br>        <span class="hljs-keyword">if</span> (result&amp;lt;=<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span> result;<br>        &#125;<br><br>        <span class="hljs-comment">//添加订单</span><br>        result = seckillOrderMapper.insertSelective(seckillOrder);<br>        <span class="hljs-keyword">if</span> (result&amp;lt;=<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span> result;<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4）dao层两个mapper从秒杀服务copy</p><p>5）启动类扫包</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@MapperScan(basePackages = &#123;&quot;com.ydles.consumer.dao&quot;&#125;)</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>6)完善 SeckillGoodsMapper</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SeckillGoodsMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Mapper</span>&amp;lt;SeckillGoods&amp;gt; &#123;<br>    <span class="hljs-meta">@Update(&quot;update tb_seckill_goods set stock_count=stock_count-1 where id=#&#123;id&#125; and stock_count&amp;gt;=1&quot;)</span><br>   <span class="hljs-type">int</span> <span class="hljs-title function_">updateStockCount</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;id&quot;)</span> Long id)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-properties line-numbers-mode" data-ext="properties"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight properties"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">数据库字段unsigned介绍</span><br>  <span class="hljs-attr">unsigned-----无符号，修饰int</span> <span class="hljs-string">、char</span><br><br><span class="hljs-attr">ALTER</span> <span class="hljs-string">TABLE tb_seckill_goods MODIFY COLUMN stock_count int(11) UNSIGNED DEFAULT NULL COMMENT &#x27;剩余库存数&#x27;;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-5-流量削峰" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-5-流量削峰">#</a> 1.5 流量削峰</h3><p>在秒杀这种高并发的场景下，每秒都有可能产生几万甚至十几万条消息，如果没有对消息处理量进行任何限制的话，很有可能因为过多的消息堆积从而导致消费者宕机的情况。因此官网建议对每一个消息消费者都设置处理消息总数（<strong>消息抓取总数</strong>）。</p><figure><img class="lazy" alt="image-20220103100123839" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103100123839-ca9d552f.png" tabindex="0"/><figcaption>image-20220103100123839</figcaption></figure><p>消息抓取总数的值，设置过大或者过小都不好，过小的话，会导致整个系统消息吞吐能力下降，造成性能浪费。过大的话，则很有可能导致消息过多，导致整个系统OOM(out of memory)内存溢出。因此官网建议每一个消费者将该值设置在<strong>100-300</strong>之间。</p><p>1）更新消费者。</p><p>ydles_service_consume服务SecKillOrderListener监听器</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 预抓取总数</span><br><span class="hljs-comment">  */</span><br><span class="hljs-keyword">try</span> &#123;<br>    channel.basicQos(<span class="hljs-number">300</span>);<br>&#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>    e.printStackTrace();<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-6-秒杀渲染服务-下单实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-6-秒杀渲染服务-下单实现">#</a> 1.6 秒杀渲染服务-下单实现</h3><figure><img class="lazy" alt="image-20220103100219129" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103100219129-96d23b1d.png" tabindex="0"/><figcaption>image-20220103100219129</figcaption></figure><p><strong>1）ydles_service_seckill_api服务定义feign接口</strong></p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name=&quot;seckill&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SecKillOrderFeign</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 秒杀下单</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> time 当前时间段</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id 秒杀商品id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/seckillorder/add&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;time&quot;)</span> String time, <span class="hljs-meta">@RequestParam(&quot;id&quot;)</span> Long id)</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2）ydles_web_seckill服务定义controller</strong></p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/wseckillorder&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecKillOrderController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SecKillOrderFeign secKillOrderFeign;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/add&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;time&quot;)</span> String time, <span class="hljs-meta">@RequestParam(&quot;id&quot;)</span>Long id)</span>&#123;<br>        <span class="hljs-comment">// System.out.println(&quot;进入秒杀订单逻辑了！&quot;);</span><br><br>        <span class="hljs-type">Result</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> secKillOrderFeign.add(time, id);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>测试：</strong> 重启相关服务，登陆，秒杀 <a href="http://localhost:8001/api/wseckillgoods/toIndex" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/wseckillgoods/toIndex<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>查看秒杀商品表和秒杀订单表数据变化。redis变化。</p><figure><img class="lazy" alt="image-20220103101942966" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/LV5VGiZT.png" tabindex="0"/><figcaption>image-20220103101942966</figcaption></figure><figure><img class="lazy" alt="image-20220103101928814" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103101928814-908ea721.png" tabindex="0"/><figcaption>image-20220103101928814</figcaption></figure><h3 id="_1-7秒杀商品真实数量获取" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-7秒杀商品真实数量获取">#</a> 1.7秒杀商品真实数量获取</h3><p>需求：</p><figure><img class="lazy" alt="image-20220103102444911" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103102444911-d2a2be49.png" tabindex="0"/><figcaption>image-20220103102444911</figcaption></figure><p>1从秒杀任务类中拿出 redis秒杀商品库存头</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//秒杀商品库存头</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SECKILL_GOODS_STOCK_COUNT_KEY=<span class="hljs-string">&quot;seckill_goods_stock_count_&quot;</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>2修改获取数据的业务方法 SecKillGoodsServiceImpl</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecKillGoodsServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SecKillGoodsService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SECKILL_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;seckill_goods_&quot;</span>;<br><br>    <span class="hljs-comment">//秒杀商品库存头</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SECKILL_GOODS_STOCK_COUNT_KEY=<span class="hljs-string">&quot;seckill_goods_stock_count_&quot;</span>;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询秒杀商品列表</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> time</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&amp;lt;SeckillGoods&amp;gt; list(String time) &#123;<br>        List&amp;lt;SeckillGoods&amp;gt; list = redisTemplate.boundHashOps(SECKILL_KEY + time).values();<br><br>        <span class="hljs-comment">//更新库存数据的来源</span><br>        <span class="hljs-keyword">for</span> (SeckillGoods seckillGoods : list) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (String) redisTemplate.opsForValue().get(SECKILL_GOODS_STOCK_COUNT_KEY+seckillGoods.getId());<br>            seckillGoods.setStockCount(Integer.parseInt(value));<br>        &#125;<br>        <span class="hljs-keyword">return</span> list;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>测试：</strong> 重启相关服务，登陆，秒杀 <a href="http://localhost:8001/api/wseckillgoods/toIndex" rel="noopener noreferrer" target="_blank">http://localhost:8001/api/wseckillgoods/toIndex<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img class="lazy" alt="image-20220103102806192" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103102806192-aefb2901.png" tabindex="0"/><figcaption>image-20220103102806192</figcaption></figure><h2 id="_2-防止恶意刷单解决" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-防止恶意刷单解决">#</a> 2 防止恶意刷单解决</h2><p>​ 在生产场景下，很有可能会存在某些用户恶意刷单的情况出现。这样的操作对于系统而言，会导致业务出错、脏数据、后端访问压力大等问题的出现。</p><p>​ 一般要解决这个问题的话，需要前端进行控制，同时后端也需要进行控制。后端实现可以通过Redis incrde 原子性递增来进行解决。</p><h3 id="_2-1-更新秒杀服务下单" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-1-更新秒杀服务下单">#</a> 2.1 更新秒杀服务下单</h3><figure><img class="lazy" alt="image-20220103111001121" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103111001121-b3235ca9.png" tabindex="0"/><figcaption>image-20220103111001121</figcaption></figure><p><strong>ydles_service_seckill服务的SecKillOrderServiceImpl类</strong></p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">add</span><span class="hljs-params">(Long id, String time, String username)</span> &#123;<br>    <span class="hljs-comment">//防止用户恶意刷单</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.preventRepeatCommit(username, id);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;fail&quot;</span>.equals(result))&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-防重方法实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-2-防重方法实现">#</a> 2.2 防重方法实现</h3><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 防止用户恶意刷单</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> username  用户名</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> id        秒杀商品id</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">  */</span><br><span class="hljs-keyword">private</span> String <span class="hljs-title function_">preventRepeatCommit</span><span class="hljs-params">(String username,Long id)</span>&#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">redis_key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;seckill_user_&quot;</span>+username+<span class="hljs-string">&quot;_id_&quot;</span>+id;<br><br>    <span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().increment(redis_key, <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">if</span> (count == <span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-comment">//代表当前用户是第一次访问.</span><br>        <span class="hljs-comment">//对当前的key设置一个五分钟的有效期</span><br>        redisTemplate.expire(redis_key,<span class="hljs-number">5</span>, TimeUnit.MINUTES);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (count&amp;gt;<span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;fail&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;fail&quot;</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-防止相同商品重复秒杀" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-防止相同商品重复秒杀">#</a> 3 防止相同商品重复秒杀</h2><p>需求：一个userID,只能买一个秒杀商品。</p><p>解决：秒杀订单表根据userName和秒杀商品Id控制。</p><figure><img class="lazy" alt="image-20220103112122408" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103112122408-25328d6b.png" tabindex="0"/><figcaption>image-20220103112122408</figcaption></figure><h3 id="_3-1-修改下单业务层实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-1-修改下单业务层实现">#</a> 3.1 修改下单业务层实现</h3><p><strong>ydles_service_seckill服务的SecKillOrderServiceImpl类</strong></p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//防止重复购买</span><br>SeckillOrder querySeckillOrder=seckillOrderMapper.getOrderInfoByUserNameAndGoodsId(username,id);<br><span class="hljs-keyword">if</span>(querySeckillOrder!=<span class="hljs-literal">null</span>)&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-dao层新增查询方法" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-2-dao层新增查询方法">#</a> 3.2 dao层新增查询方法</h3><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SeckillOrderMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Mapper</span>&amp;lt;SeckillOrder&amp;gt; &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询秒杀订单信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Select(&quot;select * from tb_seckill_order where user_id=#&#123;username&#125; and seckill_id=#&#123;id&#125;&quot;)</span><br>    SeckillOrder <span class="hljs-title function_">getSecKillOrderByUserNameAndGoodsId</span><span class="hljs-params">(String username, Long id)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-秒杀下单接口隐藏" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-秒杀下单接口隐藏">#</a> 4 秒杀下单接口隐藏</h2><p>背景：当前虽然可以确保用户只有在登录的情况下才可以进行秒杀下单，但是无法方法有一些恶意的用户在登录了之后，猜测秒杀下单的接口地址进行恶意刷单。所以需要对秒杀接口地址进行隐藏。</p><p>需求：在用户每一次点击抢购的时候，都首先去生成一个随机数并存入redis，接着用户携带着这个随机数去访问秒杀下单，下单接口首先会从redis中获取该随机数进行匹配，如果匹配成功，则进行后续下单操作，如果匹配不成功，则认定为非法访问。</p><p>这样可有防止黑客恶意大量调取后端的秒杀下单接口。</p><figure><img class="lazy" alt="image-20220103114529621" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103114529621-70063599.png" tabindex="0"/><figcaption>image-20220103114529621</figcaption></figure><h3 id="_4-1-将随机数工具类放入common工程中" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-1-将随机数工具类放入common工程中">#</a> 4.1 将随机数工具类放入common工程中</h3><figure><img class="lazy" alt="image-20220103114547263" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103114547263-8affaa09.png" tabindex="0"/><figcaption>image-20220103114547263</figcaption></figure><p>RandomUtil.java放入util包下</p><figure><img class="lazy" alt="image-20220103114754530" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103114754530-a5482486.png" tabindex="0"/><figcaption>image-20220103114754530</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RandomUtil</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getRandomString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> <span class="hljs-number">15</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;abcdefghijklmnopqrstuvwxyz0123456789&quot;</span>;<br>        <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();<br>        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &amp;lt; length; i++) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">number</span> <span class="hljs-operator">=</span> random.nextInt(base.length());<br>            sb.append(base.charAt(number));<br>        &#125;<br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">randomString</span> <span class="hljs-operator">=</span> RandomUtil.getRandomString();<br>        System.out.println(randomString);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-秒杀渲染服务定义随机数接口" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-2-秒杀渲染服务定义随机数接口">#</a> 4.2 秒杀渲染服务定义随机数接口</h3><p><strong>1ydles_web_seckill服务 util包下放入资料中的CookieUtil.java工具类</strong></p><p><strong>2ydles_web_seckill服务WSecKillOrderController类</strong></p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br>RedisTemplate redisTemplate;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 生成随机数作为接口令牌, 有效期10秒</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">  */</span><br><span class="hljs-meta">@GetMapping(&quot;/getToken&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getToken</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//获取随机字符串</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">randomString</span> <span class="hljs-operator">=</span> RandomUtil.getRandomString();<br>    <span class="hljs-comment">//获取jti</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">cookieValue</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.readCookie();<br>    <span class="hljs-comment">//短令牌作为key, 随机字符串作为value</span><br>    redisTemplate.opsForValue().set(<span class="hljs-string">&quot;randomcode_&quot;</span> + cookieValue, randomString, <span class="hljs-number">10</span>, TimeUnit.SECONDS);<br>    <span class="hljs-comment">//返回随机字符串</span><br>    <span class="hljs-keyword">return</span> randomString;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 读取cookie获取jti短令牌</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">private</span> String <span class="hljs-title function_">readCookie</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">jti</span> <span class="hljs-operator">=</span> CookieUtil.readCookie(request, <span class="hljs-string">&quot;uid&quot;</span>).get(<span class="hljs-string">&quot;uid&quot;</span>);<br>    <span class="hljs-keyword">return</span> jti;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-js修改" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-3-js修改">#</a> 4.3 js修改</h3><p>修改js下单方法</p><div class="language-javascript line-numbers-mode" data-ext="js"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight javascript"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">//秒杀下单</span><br><span class="hljs-attr">add</span>:<span class="hljs-keyword">function</span> (<span class="hljs-params">id</span>) &#123;<br>    axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/api/wseckillorder/getToken&quot;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) &#123;<br>        <span class="hljs-keyword">var</span> random =response.<span class="hljs-property">data</span>;<br>        axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/api/wseckillorder/add?time=&quot;</span>+<span class="hljs-title function_">moment</span>(app.<span class="hljs-property">dateMenus</span>[<span class="hljs-number">0</span>]).<span class="hljs-title function_">format</span>(<span class="hljs-string">&quot;YYYYMMDDHH&quot;</span>)+<span class="hljs-string">&quot;&amp;amp;id=&quot;</span>+id+<span class="hljs-string">&quot;&amp;amp;random=&quot;</span>+random).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) &#123;<br>            <span class="hljs-keyword">if</span> (response.<span class="hljs-property">data</span>.<span class="hljs-property">flag</span>)&#123;<br>                <span class="hljs-title function_">alert</span>(<span class="hljs-string">&quot;抢单成功,即将进入支付&quot;</span>);<br>            &#125; <span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-title function_">alert</span>(<span class="hljs-string">&quot;抢单失败&quot;</span>);<br>            &#125;<br>        &#125;)<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-秒杀渲染服务更改" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-4-秒杀渲染服务更改">#</a> 4.4 秒杀渲染服务更改</h3><figure><img class="lazy" alt="image-20220103153812440" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103153812440-ff015957.png" tabindex="0"/><figcaption>image-20220103153812440</figcaption></figure><p>修改秒杀渲染服务下单接口</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/wseckillorder&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WSecKillOrderController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SecKillOrderFeign secKillOrderFeign;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 秒杀下单</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> time</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/add&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;time&quot;)</span> String time, <span class="hljs-meta">@RequestParam(&quot;id&quot;)</span> Long id, String random)</span> &#123;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">cookieValue</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.readCookie();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">redisRandomCode</span> <span class="hljs-operator">=</span> (String) redisTemplate.opsForValue().get(<span class="hljs-string">&quot;randomcode_&quot;</span> + cookieValue);<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(redisRandomCode)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>(<span class="hljs-literal">false</span>, StatusCode.ERROR, <span class="hljs-string">&quot;下单失败&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!random.equals(redisRandomCode)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>(<span class="hljs-literal">false</span>, StatusCode.ERROR, <span class="hljs-string">&quot;下单失败&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-type">Result</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> secKillOrderFeign.add(time, id);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5秒杀下单接口限流-难点-不是重点" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_5秒杀下单接口限流-难点-不是重点">#</a> 5秒杀下单接口限流-难点-不是重点</h2><p>因为秒杀的特殊业务场景，生产场景下，还有可能要对秒杀下单接口进行访问流量控制，防止过多的请求进入到后端服务器。对于限流的实现方式，我们之前已经接触过通过<strong>nginx限流</strong>，<strong>网关限流</strong>。但是他们都是对一个大的服务进行访问限流，如果现在只是要对某一个服务中的<strong>接口方法进行限流</strong>呢？这里推荐使用google提供的<strong>guava工具包</strong>中的<strong>RateLimiter</strong>进行实现，其内部是基于令牌桶算法进行限流计算。</p><p>1限流 技术：guava</p><p>2自定义注解：@interface 基础的元注解信息</p><p>3aop 注解方式面向切面编程：前置增强、后置增强、环绕增强、最终增强</p><p>4springmvc 自带 HttpServletResponse response</p><p>5流 首先定义出来，最后关流</p><p><strong>ydles_web_seckill服务</strong>：</p><h3 id="_1添加依赖" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1添加依赖">#</a> 1添加依赖</h3><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.google.guava<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>guava<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>28.0-jre<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2自定义限流注解" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2自定义限流注解">#</a> 2自定义限流注解</h3><p>com.ydles.seckill.web.aspect</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Inherited</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Target(&#123;ElementType.FIELD,ElementType.METHOD,ElementType.TYPE&#125;)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span> <span class="hljs-comment">//不仅保存到class文件中,并且jvm加载class之后,该注解仍然存在</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> AccessLimit &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3自定义切面类" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3自定义切面类">#</a> 3自定义切面类</h3><p>com.ydles.seckill.web.aspect包下</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Created</span> by IT李老师</span><br><span class="hljs-comment"> * 公主号 “IT李哥交朋友”</span><br><span class="hljs-comment"> * 个人微 itlils</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Scope</span><br><span class="hljs-meta">@Aspect</span> <span class="hljs-comment">//标明切面类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccessLimitAop</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> HttpServletResponse response;<br>    <span class="hljs-comment">//设置令牌的生成速率</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">RateLimiter</span> <span class="hljs-variable">rateLimiter</span> <span class="hljs-operator">=</span> RateLimiter.create(<span class="hljs-number">2.0</span>); <span class="hljs-comment">//每秒生成两个令牌存入桶中</span><br><br>    <span class="hljs-meta">@Pointcut(&quot;@annotation(com.ydles.seckill.web.aspect.AccessLimit)&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">limit</span><span class="hljs-params">()</span>&#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Around(&quot;limit()&quot;)</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint proceedingJoinPoint)</span>&#123;<br>        <span class="hljs-comment">//限流逻辑</span><br>        <span class="hljs-comment">//拿令牌</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> rateLimiter.tryAcquire();<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span>(result)&#123;<br>            <span class="hljs-comment">//拿到令牌了</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">//切面往后走</span><br>                object = proceedingJoinPoint.proceed();<br>            &#125; <span class="hljs-keyword">catch</span> (Throwable throwable) &#123;<br>                throwable.printStackTrace();<br>            &#125;<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//拿不到令牌</span><br>            Result&amp;lt;Object&amp;gt; objectResult = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&amp;lt;&amp;gt;(<span class="hljs-literal">false</span>, StatusCode.ACCESSLIMIT, <span class="hljs-string">&quot;限流了，请售后再试&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> JSON.toJSONString(objectResult);<br>            <span class="hljs-comment">//将信息写回到用户的浏览器</span><br>            writeMsg(response,msg);<br>        &#125;<br>        <span class="hljs-keyword">return</span> object;<br>    &#125;<br><br>    <span class="hljs-comment">//给用户写回数据</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span>  <span class="hljs-title function_">writeMsg</span><span class="hljs-params">(HttpServletResponse response,String msg)</span>&#123;<br>        ServletOutputStream outputStream=<span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            response.setContentType(<span class="hljs-string">&quot;application/json;charset=utf-8&quot;</span>);<br>            outputStream = response.getOutputStream();<br>            outputStream.write(msg.getBytes(<span class="hljs-string">&quot;utf-8&quot;</span>));<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                outputStream.close();<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4使用自定义限流注解" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4使用自定义限流注解">#</a> 4使用自定义限流注解</h3><p>@AccessLimit放在下单方法上即可</p><figure><img class="lazy" alt="image-20220103165242789" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103165242789-9ed396eb.png" tabindex="0"/><figcaption>image-20220103165242789</figcaption></figure><p>总结：</p><p>1秒杀后台异步下单</p><figure><img class="lazy" alt="image-20220103165527365" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103165527365-ac106a3b.png" tabindex="0"/><figcaption>image-20220103165527365</figcaption></figure><p>mq 保证消息不丢</p><p>​ 1交换机 队列 消息 持久化</p><p>​ 2生产者：comfirm机制</p><figure><img class="lazy" alt="image-20220103165641227" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103165641227-970bbdbf.png" tabindex="0"/><figcaption>image-20220103165641227</figcaption></figure><p>​ 3消费者：手动ack</p><p>2防止恶意刷单</p><p>redis：key username_id 5min</p><p>3防止相同商品秒杀</p><p>数据库order查询 拒绝</p><p>4秒杀接口隐藏</p><figure><img class="lazy" alt="image-20220103170003264" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E9%A1%B9%E7%9B%AE%E9%98%B6%E6%AE%B5/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93%E7%BD%91/%E4%BA%8C%E5%A5%A2%E4%BA%A4%E6%98%93/image-20220103170003264-851d4508.png" tabindex="0"/><figcaption>image-20220103170003264</figcaption></figure><p>5秒杀 接口限流</p><p>自定义注解 aop</p></div>
<div class="article-footer fs14"></div>
</article>
<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">回顾上一篇</div><a href="/wiki/YDLDoc4/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA.html">自动化构建</a></div><div class="item" id="next"></div></section></div>


  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>快来参与讨论吧~</p>

    </section>
    <section class='body cmt-body waline'>
      

<div id="waline_container" class="waline_thread"><svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg></div>

    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="sitemap"><div class="sitemap-group"><span class="fs15">博客</span><a href="/">近期</a><a href="/categories/">分类</a><a href="/tags/">标签</a><a href="/archives/">归档</a></div><div class="sitemap-group"><span class="fs15">站点</span><a target="_blank" rel="noopener" href="https://status.thatcoder.cn/status/public/">公共服务</a><a target="_blank" rel="noopener" href="https://ai.thatcoder.cn/">ChatGPT</a><a target="_blank" rel="noopener" href="https://alist.thatcoder.cn/">文件资源</a><a target="_blank" rel="noopener" href="https://docs.thatapi.cn/">公共接口</a></div><div class="sitemap-group"><span class="fs15">社交</span><a href="/links/">友人帐</a><a href="/links/#comments">留言板</a><a href="/animes/">在追番</a><a href="/cinemas/">还追剧</a></div><div class="sitemap-group"><span class="fs15">更多</span><a href="/about/#tab_1-1/">本站动态</a><a target="_blank" rel="noopener" href="https://muselink.cc/naive">联系博主</a><a target="_blank" rel="noopener" href="https://github.com/ThatCoders">GitHub</a><a target="_blank" rel="noopener" href="https://gitee.com/thatcoder">Gitee</a></div></div><div class="text"><p style="text-align:center" >
本站由 <a style="font-weight: bold;" href="/author/ThatCoder/">钟意</a> 使用 <a style="font-weight: bold;" target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.28.1">Stellar 1.28.1</a> 主题创建。
<br>
由 <a style="font-weight: bold;" target="_blank" rel="noopener" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral">又拍云</a> 提供CDN加速/云存储服务
<br>
由 <a style="font-weight: bold;" target="_blank" rel="noopener" href="https://vercel.com/">vercel</a> 提供托管服务
<br>
<a href="https://beian.miit.gov.cn/" target="_blank">湘ICP备2023019799号-1</a>
<br>
<!--不蒜子计数器-->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!--添加一个访问量-->
<span>总访问 <span id="busuanzi_value_site_pv" style="font-weight: bold;"></span> 次 | 本页访问 <span id="busuanzi_value_page_pv" style="font-weight: bold;"></span> 次</span> 
<div id="siteruntime"></div>
</p>
<script>
function siteTime(){
    window.setTimeout("siteTime()", 1000);
    var seconds = 1000
    var minutes = seconds * 60
    var hours = minutes * 60
    var days = hours * 24
    var years = days * 365
    var today = new Date()
    var todayYear = today.getFullYear()
    var todayMonth = today.getMonth()
    var todayDate = today.getDate()
    var todayHour = today.getHours()
    var todayMinute = today.getMinutes()
    var todaySecond = today.getSeconds()
    var t1 = Date.UTC(2020,4,30,08,00,00)
    var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond)
    var diff = t2-t1
    var diffYears = Math.floor(diff/years)
    var diffDays = Math.floor((diff/days)-diffYears*365)
    var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours)
    var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes)
    var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds)
    document.getElementById("siteruntime").innerHTML="<p style=\"text-align:center\">小破站已颠沛流离 "+diffYears+" 年 "+diffDays+" 天 "+diffHours+" 小时 "+diffMinutes+" 分钟 "+diffSeconds+" 秒</p>"
}
siteTime();
</script>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="auto"><div class="widget-header dis-select"><span class="name">本文目录</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E5%86%85%E5%AE%B9"><span class="toc-text"> 课程内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_1-%E8%AE%A2%E5%8D%95%E7%BB%93%E7%AE%97%E9%A1%B5"><span class="toc-text"> 1 订单结算页</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_1-1-%E6%94%B6%E4%BB%B6%E5%9C%B0%E5%9D%80%E5%88%86%E6%9E%90"><span class="toc-text"> 1.1 收件地址分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_1-2-%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%94%B6%E4%BB%B6%E5%9C%B0%E5%9D%80%E6%9F%A5%E8%AF%A2"><span class="toc-text"> 1.2 实现用户收件地址查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-2-1-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-ydles-service-user"><span class="toc-text"> 1.2.1 代码实现 ydles-service-user</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_1-3-%E9%A1%B5%E9%9D%A2%E6%A8%A1%E6%9D%BF%E6%B8%B2%E6%9F%93"><span class="toc-text"> 1.3 页面模板渲染</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-3-1-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-text"> 1.3.1 准备工作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-3-2-%E4%BF%A1%E6%81%AF%E6%9F%A5%E8%AF%A2-%E9%87%8D%E7%82%B9"><span class="toc-text"> 1.3.2 信息查询-重点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-3-3-%E8%AE%B0%E5%BD%95%E9%80%89%E4%B8%AD%E6%94%B6%E4%BB%B6%E4%BA%BA-%E4%BA%86%E8%A7%A3"><span class="toc-text"> 1.3.3 记录选中收件人-了解</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_2-%E4%B8%8B%E5%8D%95-%E9%87%8D%E7%82%B9"><span class="toc-text"> 2 下单-重点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-1-%E4%B8%9A%E5%8A%A1%E5%88%86%E6%9E%90"><span class="toc-text"> 2.1 业务分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-2-%E4%B8%8B%E5%8D%95%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 2.2 下单实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-2-1-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 2.2.1 代码实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-2-2-%E6%B8%B2%E6%9F%93%E6%9C%8D%E5%8A%A1%E5%AF%B9%E6%8E%A5"><span class="toc-text"> 2.2.2 渲染服务对接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-3-%E5%BA%93%E5%AD%98%E5%8F%98%E6%9B%B4"><span class="toc-text"> 2.3 库存变更</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-3-1-%E4%B8%9A%E5%8A%A1%E5%88%86%E6%9E%90"><span class="toc-text"> 2.3.1 业务分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-3-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 2.3.2 代码实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-3-3-%E8%B0%83%E7%94%A8%E5%BA%93%E5%AD%98%E9%80%92%E5%87%8F"><span class="toc-text"> 2.3.3 调用库存递减</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-text"> 测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-4-%E5%A2%9E%E5%8A%A0%E7%A7%AF%E5%88%86-%E5%AD%A6%E5%91%98%E7%BB%83%E4%B9%A0"><span class="toc-text"> 2.4 增加积分(学员练习)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_4-4-2-%E5%A2%9E%E5%8A%A0%E7%A7%AF%E5%88%86%E8%B0%83%E7%94%A8"><span class="toc-text"> 4.4.2 增加积分调用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87"><span class="toc-text"> 学习目标：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_1-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text"> 1.分布式事务解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_1-1-%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-text"> 1.1 本地事务与分布式事务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-1-1-%E4%BA%8B%E5%8A%A1"><span class="toc-text"> 1.1.1 事务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-1-2-%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1"><span class="toc-text"> 1.1.2 本地事务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-1-3-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-text"> 1.1.3 分布式事务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_1-2-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9B%B8%E5%85%B3%E7%90%86%E8%AE%BA"><span class="toc-text"> 1.2 分布式事务相关理论</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-2-1-cap%E5%AE%9A%E7%90%86-%E9%87%8D%E7%82%B9"><span class="toc-text"> 1.2.1 CAP定理-重点</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E5%8C%BA%E5%AE%B9%E9%94%99-partition-tolerance"><span class="toc-text"> 分区容错 Partition tolerance</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%AF%E7%94%A8%E6%80%A7-availability"><span class="toc-text"> 可用性 Availability</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7-consistency"><span class="toc-text"> 一致性 Consistency</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7%E5%92%8C%E5%8F%AF%E7%94%A8%E6%80%A7%E7%9A%84%E7%9F%9B%E7%9B%BE"><span class="toc-text"> 一致性和可用性的矛盾</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-2-2-base%E7%90%86%E8%AE%BA"><span class="toc-text"> 1.2.2 BASE理论</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#basically-available-%E5%9F%BA%E6%9C%AC%E5%8F%AF%E7%94%A8"><span class="toc-text"> Basically Available(基本可用)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#soft-state-%E8%BD%AF%E7%8A%B6%E6%80%81"><span class="toc-text"> Soft state（软状态）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#eventually-consistent-%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-text"> Eventually consistent（最终一致性）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_1-3-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-%E9%9D%A2%E8%AF%95"><span class="toc-text"> 1.3 分布式事务解决方案-面试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-3-1-%E5%9F%BA%E4%BA%8Exa%E5%8D%8F%E8%AE%AE%E7%9A%84%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4-2pc"><span class="toc-text"> 1.3.1 基于XA协议的两阶段提交 2pc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-3-2-tcc%E8%A1%A5%E5%81%BF%E6%9C%BA%E5%88%B6"><span class="toc-text"> 1.3.2 TCC补偿机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-3-3-%E6%B6%88%E6%81%AF%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7-%E9%87%8D%E7%82%B9"><span class="toc-text"> 1.3.3 消息最终一致性-重点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_2-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%A1%86%E6%9E%B6seata"><span class="toc-text"> 2. 分布式事务框架seata</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-1-seata%E7%AE%80%E4%BB%8B"><span class="toc-text"> 2.1 seata简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-2-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text"> 2.2 实现原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-3-fescar%E6%A8%A1%E5%BC%8F"><span class="toc-text"> 2.3 Fescar模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-3-1-at%E6%A8%A1%E5%BC%8F"><span class="toc-text"> 2.3.1 AT模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-3-3-tcc%E6%A8%A1%E5%BC%8F"><span class="toc-text"> 2.3.3 TCC模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-3-3-saga%E6%A8%A1%E5%BC%8F"><span class="toc-text"> 2.3.3 Saga模式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_3-seata%E6%A1%88%E4%BE%8B"><span class="toc-text"> 3 Seata案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-1%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-text"> 3.1准备工作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-2%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E9%94%99%E8%AF%AF%E6%BC%94%E7%A4%BA"><span class="toc-text"> 3.2分布式事务错误演示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-3-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%AD%A3%E7%A1%AE%E6%BC%94%E7%A4%BA"><span class="toc-text"> 3.3 分布式事务正确演示</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_4%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-%E6%95%B4%E4%B8%AA%E9%A1%B9%E7%9B%AE%E7%9A%84%E9%87%8D%E7%82%B9"><span class="toc-text"> 4消息队列实现分布式事务---整个项目的重点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B-%E9%87%8D%E7%82%B9"><span class="toc-text"> 1业务流程-重点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 2代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#_2-1%E5%87%86%E5%A4%87"><span class="toc-text"> 2.1准备</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#_2-2-%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1%E9%80%BB%E8%BE%91"><span class="toc-text"> 2.2 订单服务逻辑</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#_2-3-%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1%E9%80%BB%E8%BE%91"><span class="toc-text"> 2.3 用户服务逻辑</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#_2-4%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1%E6%94%B6%E5%B0%BE"><span class="toc-text"> 2.4订单服务收尾</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#_2-5%E6%95%88%E6%9E%9C%E6%B5%8B%E8%AF%95"><span class="toc-text"> 2.5效果测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87-1"><span class="toc-text"> 学习目标：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_1-%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-text"> 1. 微信支付快速入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_1-1-%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E7%94%B3%E8%AF%B7-%E4%BA%86%E8%A7%A3"><span class="toc-text"> 1.1 微信支付申请（了解）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_1-2-%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3%E4%B8%8Esdk"><span class="toc-text"> 1.2 微信支付开发文档与SDK</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_2-%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E4%BA%8C%E7%BB%B4%E7%A0%81"><span class="toc-text"> 2. 微信支付二维码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text"> 2.1 需求分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-2-%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-text"> 2.2 实现思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-3-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 2.3 代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-3-1-%E6%8F%90%E4%BA%A4%E8%AE%A2%E5%8D%95%E8%B7%B3%E8%BD%AC%E6%94%AF%E4%BB%98%E9%A1%B5"><span class="toc-text"> 2.3.1 提交订单跳转支付页</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-3-2-%E6%94%AF%E4%BB%98%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9D%83%E9%99%90%E9%9B%86%E6%88%90"><span class="toc-text"> 2.3.2 支付微服务权限集成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-3-3-%E6%94%AF%E4%BB%98%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E4%B8%8B%E5%8D%95"><span class="toc-text"> 2.3.3 支付微服务-下单</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-3-3-%E6%94%AF%E4%BB%98%E6%B8%B2%E6%9F%93%E9%A1%B5%E9%9D%A2%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-text"> 2.3.3 支付渲染页面微服务</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_3-%E6%94%AF%E4%BB%98%E5%9B%9E%E8%B0%83%E9%80%BB%E8%BE%91%E5%A4%84%E7%90%86"><span class="toc-text"> 3. 支付回调逻辑处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text"> 3.1 需求分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-2-%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-text"> 3.2 实现思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-3-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 3.3 代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-3-1-%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E5%B7%A5%E5%85%B7"><span class="toc-text"> 3.3.1 内网穿透工具</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-3-2%E4%B8%8B%E8%BD%BD%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%92%8C%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-text"> 3.3.2下载配置文件和客户端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-3-3-%E5%90%AF%E5%8A%A8"><span class="toc-text"> 3.3.3 启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-3-4-%E6%B5%8B%E8%AF%95"><span class="toc-text"> 3.3.4 测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-3-5-%E6%8E%A5%E6%94%B6%E5%9B%9E%E8%B0%83%E4%BF%A1%E6%81%AF"><span class="toc-text"> 3.3.5 接收回调信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-3-6-%E5%A4%84%E7%90%86%E5%9B%9E%E8%B0%83%E9%80%9A%E7%9F%A5-%E9%87%8D%E7%82%B9"><span class="toc-text"> 3.3.6 处理回调通知-重点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-3-7-%E6%94%B6%E5%88%B0%E5%BE%AE%E4%BF%A1%E9%80%9A%E7%9F%A5%E5%90%8E%E7%9A%84%E9%80%BB%E8%BE%91"><span class="toc-text"> 3.3.7 收到微信通知后的逻辑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-3-8-%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1%E4%BF%AE%E6%94%B9%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81"><span class="toc-text"> 3.3.8 订单服务修改订单状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-3-9-%E6%95%B4%E4%B8%AA%E6%B5%81%E7%A8%8B%E6%B5%8B%E8%AF%95"><span class="toc-text"> 3.3.9 整个流程测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_4-%E6%8E%A8%E9%80%81%E6%94%AF%E4%BB%98%E9%80%9A%E7%9F%A5"><span class="toc-text"> 4. 推送支付通知</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_4-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text"> 4.1 需求分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_4-2-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8E%A8%E9%80%81%E6%96%B9%E6%A1%88"><span class="toc-text"> 4.2 服务端推送方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_4-3-rabbitmq-web-stomp-%E6%8F%92%E4%BB%B6"><span class="toc-text"> 4.3 RabbitMQ Web STOMP 插件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_4-3-1-stomp%E5%8D%8F%E8%AE%AE"><span class="toc-text"> 4.3.1 STOMP协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4-3-2-%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="toc-text"> 4.3.2 插件安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4-3-3-%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81%E6%B5%8B%E8%AF%95"><span class="toc-text"> 4.3.3 消息推送测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_4-4-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 4.4 代码实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_5-%E6%B5%8B%E8%AF%95%E8%AE%BF%E9%97%AE%E8%B7%AF%E5%BE%84"><span class="toc-text"> 5. 测试访问路径</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E5%86%85%E5%AE%B9-1"><span class="toc-text"> 课程内容：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_1-%E8%B6%85%E6%97%B6%E6%9C%AA%E6%94%AF%E4%BB%98%E8%AE%A2%E5%8D%95%E5%A4%84%E7%90%86-%E9%87%8D%E7%82%B9"><span class="toc-text"> 1. 超时未支付订单处理-重点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_1-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text"> 1.1 需求分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_1-2-%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-text"> 1.2 实现思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_1-3-rabbitmq%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF"><span class="toc-text"> 1.3 rabbitmq延迟消息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-3-1-%E6%B6%88%E6%81%AF%E7%9A%84ttl-time-to-live"><span class="toc-text"> 1.3.1 消息的TTL（Time To Live）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-3-2-%E6%AD%BB%E4%BF%A1%E4%BA%A4%E6%8D%A2%E5%99%A8-dead-letter-exchanges"><span class="toc-text"> 1.3.2 死信交换器 Dead Letter Exchanges</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_1-4-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 1.4 代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-4-1-%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98-%E5%85%B3%E9%97%AD%E8%AE%A2%E5%8D%95"><span class="toc-text"> 1.4.1 微信支付-关闭订单</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-4-2-%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98-%E6%9F%A5%E8%AF%A2%E8%AE%A2%E5%8D%95"><span class="toc-text"> 1.4.2 微信支付-查询订单</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-4-3-%E8%AE%A2%E5%8D%95%E5%85%B3%E9%97%AD%E9%80%BB%E8%BE%91"><span class="toc-text"> 1.4.3 订单关闭逻辑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-4-4-%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86"><span class="toc-text"> 1.4.4 延迟消息处理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_2-%E8%AE%A2%E5%8D%95%E6%89%B9%E9%87%8F%E5%8F%91%E8%B4%A7"><span class="toc-text"> 2. 订单批量发货</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-1-%E6%89%B9%E9%87%8F%E5%8F%91%E8%B4%A7%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91"><span class="toc-text"> 2.1 批量发货业务逻辑</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-1-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text"> 2.1.1 需求分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-1-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 2.1.2 代码实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-2-%E5%AF%B9%E6%8E%A5%E7%AC%AC%E4%B8%89%E6%96%B9%E7%89%A9%E6%B5%81-%E4%BA%86%E8%A7%A3"><span class="toc-text"> 2.2 对接第三方物流（了解）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_3-%E7%A1%AE%E8%AE%A4%E6%94%B6%E8%B4%A7%E4%B8%8E%E8%87%AA%E5%8A%A8%E6%94%B6%E8%B4%A7"><span class="toc-text"> 3. 确认收货与自动收货</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-1-%E7%A1%AE%E8%AE%A4%E6%94%B6%E8%B4%A7"><span class="toc-text"> 3.1 确认收货</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-1-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90%E4%B8%8E%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-text"> 3.1.1 需求分析与实现思路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-1-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 3.1.2 代码实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-2-%E8%87%AA%E5%8A%A8%E6%94%B6%E8%B4%A7%E5%A4%84%E7%90%86"><span class="toc-text"> 3.2 自动收货处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-2-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text"> 3.2.1 需求分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-2-2-cron%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-text"> 3.2.2 Cron表达式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-2-3-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 3.2.3 代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#_3-2-3-1-%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF"><span class="toc-text"> 3.2.3.1 发送消息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#_3-2-3-2-%E6%8E%A5%E6%94%B6%E6%B6%88%E6%81%AF"><span class="toc-text"> 3.2.3.2 接收消息</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E5%86%85%E5%AE%B9-2"><span class="toc-text"> 课程内容:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_1-%E7%A7%92%E6%9D%80%E4%B8%9A%E5%8A%A1%E5%88%86%E6%9E%90"><span class="toc-text"> 1 秒杀业务分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-1"><span class="toc-text"> 1.1 需求分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-2-%E8%A1%A8%E7%BB%93%E6%9E%84%E8%AF%B4%E6%98%8E"><span class="toc-text"> 1.2 表结构说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-3-%E7%A7%92%E6%9D%80%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-%E6%8B%93%E5%B1%95%E5%86%85%E5%AE%B9"><span class="toc-text"> 1.3 秒杀需求分析&#x3D;&#x3D;拓展内容</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_2-%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81%E5%AD%98%E5%85%A5%E7%BC%93%E5%AD%98-%E9%87%8D%E7%82%B9"><span class="toc-text"> 2 秒杀商品存入缓存-重点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-1-%E7%A7%92%E6%9D%80%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA"><span class="toc-text"> 2.1 秒杀服务搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-2-%E6%97%B6%E9%97%B4%E6%93%8D%E4%BD%9C"><span class="toc-text"> 2.2 时间操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-2-1-%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81%E6%97%B6%E9%97%B4%E6%AE%B5%E5%88%86%E6%9E%90"><span class="toc-text"> 2.2.1 秒杀商品时间段分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-2-2-%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81%E6%97%B6%E9%97%B4%E6%AE%B5%E8%AE%A1%E7%AE%97"><span class="toc-text"> 2.2.2 秒杀商品时间段计算</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-2-3-%E5%BD%93%E5%89%8D%E4%B8%9A%E5%8A%A1%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-text"> 2.2.3 当前业务整体流程分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-3-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-1"><span class="toc-text"> 2.3 代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-3-1-%E6%9B%B4%E6%94%B9%E5%90%AF%E5%8A%A8%E7%B1%BB-%E6%B7%BB%E5%8A%A0%E5%BC%80%E5%90%AF%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%B3%A8%E8%A7%A3"><span class="toc-text"> 2.3.1 更改启动类，添加开启定时任务注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-3-2-%E6%97%B6%E9%97%B4%E8%8F%9C%E5%8D%95%E5%88%86%E6%9E%90"><span class="toc-text"> 2.3.2 时间菜单分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-3-2-%E5%AE%9A%E4%B9%89%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%B1%BB"><span class="toc-text"> 2.3.2 定义定时任务类</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_3-%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81-%E9%A6%96%E9%A1%B5-%E4%BA%86%E8%A7%A3"><span class="toc-text"> 3 秒杀商品-首页-了解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-1-%E7%A7%92%E6%9D%80%E9%A6%96%E9%A1%B5%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90"><span class="toc-text"> 3.1 秒杀首页实现分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-1-1-%E5%8A%A0%E8%BD%BD%E6%97%B6%E9%97%B4%E8%8F%9C%E5%8D%95%E5%88%86%E6%9E%90"><span class="toc-text"> 3.1.1 加载时间菜单分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-1-2-%E5%8A%A0%E8%BD%BD%E5%AF%B9%E5%BA%94%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81%E5%88%86%E6%9E%90"><span class="toc-text"> 3.1.2 加载对应秒杀商品分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-2-%E7%A7%92%E6%9D%80%E6%B8%B2%E6%9F%93%E6%9C%8D%E5%8A%A1-%E6%B8%B2%E6%9F%93%E7%A7%92%E6%9D%80%E9%A6%96%E9%A1%B5"><span class="toc-text"> 3.2 秒杀渲染服务 - 渲染秒杀首页</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-2-1-%E6%96%B0%E5%BB%BA%E7%A7%92%E6%9D%80%E6%B8%B2%E6%9F%93%E6%9C%8D%E5%8A%A1"><span class="toc-text"> 3.2.1 新建秒杀渲染服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-3-%E6%97%B6%E9%97%B4%E8%8F%9C%E5%8D%95%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 3.3 时间菜单实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-3-1-%E6%97%B6%E9%97%B4%E8%8F%9C%E5%8D%95%E8%8E%B7%E5%8F%96"><span class="toc-text"> 3.3.1 时间菜单获取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-3-2-%E9%A1%B5%E9%9D%A2%E5%8A%A0%E8%BD%BD%E6%97%B6%E9%97%B4%E8%8F%9C%E5%8D%95"><span class="toc-text"> 3.3.2 页面加载时间菜单</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-3-3-%E6%97%B6%E9%97%B4%E6%A0%BC%E5%BC%8F%E5%8C%96"><span class="toc-text"> 3.3.3 时间格式化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-3-4-%E9%80%89%E4%B8%AD%E5%AE%9E%E7%8E%B0-%E4%BA%86%E8%A7%A3"><span class="toc-text"> 3.3.4 选中实现 -了解</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#_3-3-4-1-%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-text"> 3.3.4.1 思路分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#_3-3-4-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 3.3.4.2 代码实现</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-3-5-%E5%80%92%E8%AE%A1%E6%97%B6%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 3.3.5 倒计时实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#_3-3-5-1-%E5%80%92%E8%AE%A1%E6%97%B6%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 3.3.5.1 倒计时实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-4-%E5%8A%A0%E8%BD%BD%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 3.4 加载秒杀商品实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-4-1-%E7%A7%92%E6%9D%80%E6%9C%8D%E5%8A%A1-%E6%9F%A5%E8%AF%A2%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81%E5%88%97%E8%A1%A8"><span class="toc-text"> 3.4.1 秒杀服务-查询秒杀商品列表</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#_3-4-1-1-%E7%A7%92%E6%9D%80%E6%9C%8D%E5%8A%A1-service"><span class="toc-text"> 3.4.1.1 秒杀服务- service</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#_3-4-1-2-%E7%A7%92%E6%9D%80%E6%9C%8D%E5%8A%A1-controller"><span class="toc-text"> 3.4.1.2 秒杀服务-controller</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#_3-4-1-3-%E6%9D%80%E6%9C%8D%E5%8A%A1api-feign%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-text"> 3.4.1.3 杀服务Api- feign接口定义</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#_3-4-1-4-%E6%9F%A5%E8%AF%A2%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81%E6%94%BE%E8%A1%8C-%E6%83%B3%E6%83%B3%E4%B8%BA%E4%BB%80%E4%B9%88"><span class="toc-text"> 3.4.1.4 查询秒杀商品放行-想想为什么</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-4-2-%E7%A7%92%E6%9D%80%E6%B8%B2%E6%9F%93%E6%9C%8D%E5%8A%A1-%E6%9F%A5%E8%AF%A2%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81%E5%88%97%E8%A1%A8"><span class="toc-text"> 3.4.2 秒杀渲染服务-查询秒杀商品列表</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#_3-4-2-1-%E6%9B%B4%E6%96%B0ydles-web-seckill%E7%9A%84%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-text"> 3.4.2.1 更新ydles_web_seckill的启动类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#_3-4-2-2-%E6%9B%B4%E6%96%B0ydles-web-seckill%E7%9A%84seckillgoodscontroller"><span class="toc-text"> 3.4.2.2 更新ydles_web_seckill的SecKillGoodsController</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#_3-4-2-3-%E6%9B%B4%E6%96%B0seckill-index-html%E3%80%82%E6%B7%BB%E5%8A%A0%E6%8C%89%E7%85%A7%E6%97%B6%E9%97%B4%E6%9F%A5%E8%AF%A2%E6%96%B9%E6%B3%95"><span class="toc-text"> 3.4.2.3 更新secKill-index.html。添加按照时间查询方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#_3-4-2-4-%E6%9B%B4%E6%96%B0seckill-index-html%E3%80%82-%E5%8A%A0%E8%BD%BD%E9%A1%B5%E9%9D%A2%E6%97%B6-%E9%BB%98%E8%AE%A4%E5%BD%93%E5%89%8D%E6%97%B6%E9%97%B4%E6%9F%A5%E8%AF%A2"><span class="toc-text"> 3.4.2.4 更新secKill-index.html。 加载页面时，默认当前时间查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#_3-4-2-5-%E6%9B%B4%E6%96%B0seckill-index-html%E3%80%82%E5%88%87%E6%8D%A2%E6%97%B6%E9%97%B4%E8%8F%9C%E5%8D%95-%E6%9F%A5%E8%AF%A2%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81"><span class="toc-text"> 3.4.2.5 更新secKill-index.html。切换时间菜单,查询秒杀商品</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-5-%E6%8A%A2%E8%B4%AD%E6%8C%89%E9%92%AE"><span class="toc-text"> 3.5 抢购按钮</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-5-1-js%E5%AE%9A%E4%B9%89"><span class="toc-text"> 3.5.1 js定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-5-2-%E8%B0%83%E7%94%A8%E4%B8%8B%E5%8D%95%E6%96%B9%E6%B3%95"><span class="toc-text"> 3.5.2 调用下单方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-5-3-%E7%A7%92%E6%9D%80web%E9%A1%B5%E9%9D%A2-%E6%96%B0%E5%A2%9Econtroller"><span class="toc-text"> 3.5.3 秒杀web页面 新增Controller</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_1-%E7%A7%92%E6%9D%80%E5%BC%82%E6%AD%A5%E4%B8%8B%E5%8D%95-%E9%87%8D%E7%82%B9-%E9%9A%BE%E7%82%B9"><span class="toc-text"> 1 秒杀异步下单-重点-难点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_1-1-%E7%A7%92%E6%9D%80%E6%9C%8D%E5%8A%A1-%E4%B8%8B%E5%8D%95%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 1.1 秒杀服务-下单实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_1-2-%E7%94%9F%E4%BA%A7%E8%80%85%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E4%B8%8D%E4%B8%A2%E5%A4%B1-%E9%9D%A2%E8%AF%95%E5%B8%B8%E9%97%AE%E9%97%AE%E9%A2%98-%E9%87%8D%E7%82%B9"><span class="toc-text"> 1.2 生产者保证消息不丢失--面试常问问题-重点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-2-1-%E5%BC%80%E5%90%AFconfirm%E6%9C%BA%E5%88%B6"><span class="toc-text"> 1.2.1 开启confirm机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-2-2%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF"><span class="toc-text"> 1.2.2发送消息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_1-3-%E7%A7%92%E6%9D%80%E4%B8%8B%E5%8D%95%E6%9C%8D%E5%8A%A1-%E6%9B%B4%E6%96%B0%E5%BA%93%E5%AD%98%E5%BA%93"><span class="toc-text"> 1.3 秒杀下单服务-更新库存库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-3-1-%E5%BC%82%E6%AD%A5%E4%B8%8B%E5%8D%95%E6%9C%8D%E5%8A%A1ydles-service-consume"><span class="toc-text"> 1.3.1 异步下单服务ydles_service_consume</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-3-2-%E6%B6%88%E8%B4%B9%E8%80%85%E6%89%8B%E5%8A%A8ack%E4%B8%8B%E5%8D%95%E5%AE%9E%E7%8E%B0-%E9%9D%A2%E8%AF%95%E9%87%8D%E7%82%B9-%E8%AE%A4%E7%9C%9F%E5%90%AC"><span class="toc-text"> 1.3.2 消费者手动ACK下单实现--面试重点-认真听</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_1-5-%E6%B5%81%E9%87%8F%E5%89%8A%E5%B3%B0"><span class="toc-text"> 1.5 流量削峰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_1-6-%E7%A7%92%E6%9D%80%E6%B8%B2%E6%9F%93%E6%9C%8D%E5%8A%A1-%E4%B8%8B%E5%8D%95%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 1.6 秒杀渲染服务-下单实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_1-7%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81%E7%9C%9F%E5%AE%9E%E6%95%B0%E9%87%8F%E8%8E%B7%E5%8F%96"><span class="toc-text"> 1.7秒杀商品真实数量获取</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_2-%E9%98%B2%E6%AD%A2%E6%81%B6%E6%84%8F%E5%88%B7%E5%8D%95%E8%A7%A3%E5%86%B3"><span class="toc-text"> 2 防止恶意刷单解决</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-1-%E6%9B%B4%E6%96%B0%E7%A7%92%E6%9D%80%E6%9C%8D%E5%8A%A1%E4%B8%8B%E5%8D%95"><span class="toc-text"> 2.1 更新秒杀服务下单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2-2-%E9%98%B2%E9%87%8D%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 2.2 防重方法实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_3-%E9%98%B2%E6%AD%A2%E7%9B%B8%E5%90%8C%E5%95%86%E5%93%81%E9%87%8D%E5%A4%8D%E7%A7%92%E6%9D%80"><span class="toc-text"> 3 防止相同商品重复秒杀</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-1-%E4%BF%AE%E6%94%B9%E4%B8%8B%E5%8D%95%E4%B8%9A%E5%8A%A1%E5%B1%82%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 3.1 修改下单业务层实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-2-dao%E5%B1%82%E6%96%B0%E5%A2%9E%E6%9F%A5%E8%AF%A2%E6%96%B9%E6%B3%95"><span class="toc-text"> 3.2 dao层新增查询方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_4-%E7%A7%92%E6%9D%80%E4%B8%8B%E5%8D%95%E6%8E%A5%E5%8F%A3%E9%9A%90%E8%97%8F"><span class="toc-text"> 4 秒杀下单接口隐藏</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_4-1-%E5%B0%86%E9%9A%8F%E6%9C%BA%E6%95%B0%E5%B7%A5%E5%85%B7%E7%B1%BB%E6%94%BE%E5%85%A5common%E5%B7%A5%E7%A8%8B%E4%B8%AD"><span class="toc-text"> 4.1 将随机数工具类放入common工程中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_4-2-%E7%A7%92%E6%9D%80%E6%B8%B2%E6%9F%93%E6%9C%8D%E5%8A%A1%E5%AE%9A%E4%B9%89%E9%9A%8F%E6%9C%BA%E6%95%B0%E6%8E%A5%E5%8F%A3"><span class="toc-text"> 4.2 秒杀渲染服务定义随机数接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_4-3-js%E4%BF%AE%E6%94%B9"><span class="toc-text"> 4.3 js修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_4-4-%E7%A7%92%E6%9D%80%E6%B8%B2%E6%9F%93%E6%9C%8D%E5%8A%A1%E6%9B%B4%E6%94%B9"><span class="toc-text"> 4.4 秒杀渲染服务更改</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_5%E7%A7%92%E6%9D%80%E4%B8%8B%E5%8D%95%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81-%E9%9A%BE%E7%82%B9-%E4%B8%8D%E6%98%AF%E9%87%8D%E7%82%B9"><span class="toc-text"> 5秒杀下单接口限流-难点-不是重点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_1%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96"><span class="toc-text"> 1添加依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2%E8%87%AA%E5%AE%9A%E4%B9%89%E9%99%90%E6%B5%81%E6%B3%A8%E8%A7%A3"><span class="toc-text"> 2自定义限流注解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%87%E9%9D%A2%E7%B1%BB"><span class="toc-text"> 3自定义切面类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_4%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E9%99%90%E6%B5%81%E6%B3%A8%E8%A7%A3"><span class="toc-text"> 4使用自定义限流注解</span></a></li></ol></li></ol></div><div class="widget-footer">

<a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>回到顶部</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M10.46 1.25h3.08c1.603 0 2.86 0 3.864.095c1.023.098 1.861.3 2.6.752a5.75 5.75 0 0 1 1.899 1.899c.452.738.654 1.577.752 2.6c.095 1.004.095 2.261.095 3.865v1.067c0 1.141 0 2.036-.05 2.759c-.05.735-.153 1.347-.388 1.913a5.75 5.75 0 0 1-3.112 3.112c-.805.334-1.721.408-2.977.43a10.81 10.81 0 0 0-.929.036c-.198.022-.275.054-.32.08c-.047.028-.112.078-.224.232c-.121.166-.258.396-.476.764l-.542.916c-.773 1.307-2.69 1.307-3.464 0l-.542-.916a10.605 10.605 0 0 0-.476-.764c-.112-.154-.177-.204-.224-.232c-.045-.026-.122-.058-.32-.08c-.212-.023-.49-.03-.93-.037c-1.255-.021-2.171-.095-2.976-.429A5.75 5.75 0 0 1 1.688 16.2c-.235-.566-.338-1.178-.389-1.913c-.049-.723-.049-1.618-.049-2.76v-1.066c0-1.604 0-2.86.095-3.865c.098-1.023.3-1.862.752-2.6a5.75 5.75 0 0 1 1.899-1.899c.738-.452 1.577-.654 2.6-.752C7.6 1.25 8.857 1.25 10.461 1.25M6.739 2.839c-.914.087-1.495.253-1.959.537A4.25 4.25 0 0 0 3.376 4.78c-.284.464-.45 1.045-.537 1.96c-.088.924-.089 2.11-.089 3.761v1c0 1.175 0 2.019.046 2.685c.045.659.131 1.089.278 1.441a4.25 4.25 0 0 0 2.3 2.3c.515.214 1.173.294 2.429.316h.031c.398.007.747.013 1.037.045c.311.035.616.104.909.274c.29.17.5.395.682.645c.169.232.342.525.538.856l.559.944a.52.52 0 0 0 .882 0l.559-.944c.196-.331.37-.624.538-.856c.182-.25.392-.476.682-.645c.293-.17.598-.24.909-.274c.29-.032.639-.038 1.037-.045h.032c1.255-.022 1.913-.102 2.428-.316a4.25 4.25 0 0 0 2.3-2.3c.147-.352.233-.782.278-1.441c.046-.666.046-1.51.046-2.685v-1c0-1.651 0-2.837-.089-3.762c-.087-.914-.253-1.495-.537-1.959a4.25 4.25 0 0 0-1.403-1.403c-.464-.284-1.045-.45-1.96-.537c-.924-.088-2.11-.089-3.761-.089h-3c-1.651 0-2.837 0-3.762.089" clip-rule="evenodd"/><path fill="currentColor" d="M9 11a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0"/></svg><span>参与讨论</span></a></div></widget>
</div></aside><div class='float-panel blur'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">
<script type="text/javascript">
  const ctx = {
    date_suffix: {
      just: `刚刚`,
      min: `分钟前`,
      hour: `小时前`,
      day: `天前`,
    },
    root : `/`,
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"post, page, docs","path":"/search.json","content":true,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
  };
  const deps = {
    jquery: `https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js`,
    marked: `https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js`
  }
  

</script>

<script type="text/javascript">
  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },
    
    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      let retryTimes = 3;
      utils.onLoading(el);
      function req() {
        return new Promise((resolve, reject) => {
          let status = 0; // 0 等待 1 完成 2 超时
          let timer = setTimeout(() => {
            if (status === 0) {
              status = 2;
              timer = null;
              reject('请求超时');
              if (retryTimes == 0) {
                onFailure();
              }
            }
          }, 5000);
          fetch(url).then(function(response) {
            if (status !== 2) {
              clearTimeout(timer);
              resolve(response);
              timer = null;
              status = 1;
            }
            if (response.ok) {
              return response.json();
            }
            throw new Error('Network response was not ok.');
          }).then(function(data) {
            retryTimes = 0;
            utils.onLoadSuccess(el);
            callback(data);
          }).catch(function(error) {
            if (retryTimes > 0) {
              retryTimes -= 1;
              setTimeout(() => {
                req();
              }, 5000);
            } else {
              utils.onLoadFailure(el);
              onFailure();
            }
          });
        });
      }
      req();
    },
  };
</script>

<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>

<!-- required -->
<script src="/js/main.js?v=1.28.1" async></script>

<script type="text/javascript">
  const applyTheme = (theme) => {
    if (theme === 'auto') {
      document.documentElement.removeAttribute('data-theme')
    } else {
      document.documentElement.setAttribute('data-theme', theme)
    }

    applyThemeToGiscus(theme)
  }

  const applyThemeToGiscus = (theme) => {
    theme = theme === 'auto' ? 'preferred_color_scheme' : theme

    const cmt = document.getElementById('giscus')
    if (cmt) {
      // This works before giscus load.
      cmt.setAttribute('data-theme', theme)
    }

    const iframe = document.querySelector('#comments > section.giscus > iframe')
    if (iframe) {
      // This works after giscus loaded.
      const src = iframe.src
      const newSrc = src.replace(/theme=[\w]+/, `theme=${theme}`)
      iframe.src = newSrc
    }
  }

  const switchTheme = () => {
    // light -> dark -> auto -> light -> ...
    const currentTheme = document.documentElement.getAttribute('data-theme')
    let newTheme;
    switch (currentTheme) {
      case 'light':
        newTheme = 'dark'
        break
      case 'dark':
        newTheme = 'auto'
        break
      default:
        newTheme = 'light'
    }
    applyTheme(newTheme)
    window.localStorage.setItem('Stellar.theme', newTheme)

    const messages = {
      light: `切换到浅色模式`,
      dark: `切换到深色模式`,
      auto: `切换到跟随系统配色`,
    }
    hud?.toast?.(messages[newTheme])
  }

  (() => {
    // Apply user's preferred theme, if any.
    const theme = window.localStorage.getItem('Stellar.theme')
    if (theme !== null) {
      applyTheme(theme)
    }
  })()
</script>


<!-- optional -->

  <script type="module">
  import { init } from 'https://upyun.thatcdn.cn/public/web/waline/v3/client/dist/waline.js'

  function load_comment(){
    if(!document.getElementById("waline_container"))return;

    utils.css('https://upyun.thatcdn.cn/public/web/waline/v3/client/dist/waline.css');
    utils.css('https://gcore.jsdelivr.net/npm/@waline/client@3.1.3/dist/waline-meta.css');

    const el = document.getElementById("waline_container");
    var path = el.getAttribute('comment_id');
    if (!path) {
      path = decodeURI(window.location.pathname);
    }

    const waline = init(Object.assign({"js":"https://upyun.thatcdn.cn/public/web/waline/v3/client/dist/waline.js","css":"https://upyun.thatcdn.cn/public/web/waline/v3/client/dist/waline.css","meta_css":"https://gcore.jsdelivr.net/npm/@waline/client@3.1.3/dist/waline-meta.css","serverURL":"https://waline.thatapi.cn/","commentCount":true,"pageview":false,"custom":{"css":"/custom/css/ZYWaline.css"},"search":false,"locale":{"placeholder":"  遇事不决, 可问春风..."},"emoji":["https://upyun.thatcdn.cn/public/web/emojis/bilibili","https://upyun.thatcdn.cn/public/web/emojis/qq","https://upyun.thatcdn.cn/public/web/emojis/tieba","https://upyun.thatcdn.cn/public/web/emojis/weibo"],"reaction":["https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_cute.png","https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_chuckle.png","https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_sunglasses.png","https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_crazy.png","https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_pick_nose.png","https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_not_care.png","https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_trollface.png","https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_thumbsup.png"],"meta":["nick","mail","link"],"imageUploader":{"fileName":"file","tokenName":"Authorization","api":"https://lsky.thatcoder.cn/api/v1/upload","token":"Bearer 6|x9vHGJGHAnjqbO0PGEE5vM7r9S9hdqFA9bmdESdm","resp":"data.links.url"}}, {
      el: '#waline_container',
      path: path,
      
        imageUploader: function(file) {
          let headers = new Headers();
          headers.set('Accept', 'application/json');
          
            headers.set('Authorization', 'Bearer 6|x9vHGJGHAnjqbO0PGEE5vM7r9S9hdqFA9bmdESdm')
          
          let formData = new FormData();
          formData.append('file', file);
          return fetch('https://lsky.thatcoder.cn/api/v1/upload',{
            method: 'POST',
            body: formData,
            headers: headers
            }).then((resp) => resp.json())
              .then((resp) => resp.data.links.url)
        },
      
    }));

  }
  window.addEventListener('DOMContentLoaded', (event) => {
    load_comment();
  });

</script>




<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://cdn.bootcdn.net/ajax/libs/flying-pages/2.1.2/flying-pages.min.js"></script><script defer src="https://cdn.bootcdn.net/ajax/libs/vanilla-lazyload/17.8.4/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });
</script><script>
  ctx.fancybox = {
    selector: `.swiper-slide img, .md-text.content p>img, .md-text.content li img , .wl-content img, waline_container .vcontent img, .timeline .body .image img,  .timeline .gallery img`,
    css: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.min.css`,
    js: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.umd.min.js`
  };
  var selector = '[data-fancybox]:not(.error)';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const els = document.getElementsByClassName('ds-memos');
    if (els != undefined && els.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>




<!-- inject -->
<script type="text/javascript" src="/custom/js/ZYUtil.js"></script><script type="text/javascript" src="/custom/js/ZYDark.js"></script><script type="text/javascript" src="/custom/js/ZYCategory.js"></script><script type="text/javascript" src="/custom/js/ZYCode.js"></script><script type="text/javascript" src="/custom/js/timetmpl.js"></script>
</div></body></html>
