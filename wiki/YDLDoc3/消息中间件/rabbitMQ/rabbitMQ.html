
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.31.0" theme-name="Stellar" theme-version="1.31.0">
  <link rel="canonical" href="https://blog.thatcoder.cn/wiki/YDLDoc3/消息中间件/rabbitMQ/rabbitMQ">
  
  <meta name="generator" content="Hexo 7.3.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  <meta name="theme-color" content="#f9fafb">
  <title>YDLDoc3：rabbitMQ - 那个码农</title>

  
    <meta name="description" content="# RabbitMQ入门提示课程视频教程链接：https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1dt4y147CKopen in new window学习目标能够说出什么是消息中间件能够安装RabbitMQ能够编写RabbitMQ的入门程序能够说出RabbitMQ的5种模式特征-重点能够使用Spring整合RabbitMQ# 第一章 消息中间件概述-了解# 1、 什么是消息中间件">
<meta property="og:type" content="website">
<meta property="og:title" content="rabbitMQ">
<meta property="og:url" content="https://blog.thatcoder.cn/wiki/YDLDoc3/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/rabbitMQ">
<meta property="og:site_name" content="那个码农">
<meta property="og:description" content="# RabbitMQ入门提示课程视频教程链接：https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1dt4y147CKopen in new window学习目标能够说出什么是消息中间件能够安装RabbitMQ能够编写RabbitMQ的入门程序能够说出RabbitMQ的5种模式特征-重点能够使用Spring整合RabbitMQ# 第一章 消息中间件概述-了解# 1、 什么是消息中间件">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://upyun.thatcdn.cn/hexo/stellar/image/favicon.webp">
<meta property="article:published_time" content="2025-07-11T14:15:58.554Z">
<meta property="article:modified_time" content="2023-12-16T19:23:22.000Z">
<meta property="article:author" content="钟意">
<meta property="article:tag" content="那个码农">
<meta property="article:tag" content="码农钟意">
<meta property="article:tag" content="钟意的博客">
<meta property="article:tag" content="钟意博客">
<meta property="article:tag" content="That Coder">
<meta property="article:tag" content="thatcoder">
<meta property="article:tag" content="源柒拾柒雅舍">
<meta property="article:tag" content="源WebGary">
<meta property="article:tag" content="giligili.work">
<meta property="article:tag" content="seclusion.work">
<meta property="article:tag" content="GalGame">
<meta property="article:tag" content="Hexo Stellar">
<meta property="article:tag" content="江西木村拓哉">
<meta property="article:tag" content="江西吴彦祖">
<meta property="article:tag" content="江西胡歌">
<meta property="article:tag" content="龙南木村拓哉">
<meta property="article:tag" content="龙南吴彦祖">
<meta property="article:tag" content="龙南胡歌">
<meta property="article:tag" content="九江职业技术学院">
<meta property="article:tag" content="南昌交通学院">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://upyun.thatcdn.cn/hexo/stellar/image/favicon.webp">
  
  

  <meta name="keywords" content="那个码农,码农钟意,钟意的博客,钟意博客,That Coder,thatcoder,源柒拾柒雅舍,源WebGary,giligili.work,seclusion.work,GalGame,Hexo Stellar,江西木村拓哉,江西吴彦祖,江西胡歌,龙南木村拓哉,龙南吴彦祖,龙南胡歌,九江职业技术学院,南昌交通学院">

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="那个码农" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/main.css?v=1.31.0">


  
    <link rel="shortcut icon" href="https://upyun.thatcdn.cn/hexo/stellar/image/favicon.webp">
  

  
    
<link rel="stylesheet" href="/custom/css/ZYCode.css">

  

  <link rel="Shortcut Icon" href="/favicon.ico" type="image/x-icon" /><link rel='stylesheet' href='https://public.thatcdn.cn/font/old_song/result.css' /><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.5.1/css/all.min.css"><link rel="stylesheet" href="/custom/css/ZYTimetmpl.css" /><meta itemprop="name" content="钟意博客"><meta itemprop="description" content="笔名钟意, 记录代码与生活."><meta itemprop="image" content="https://upyun.thatcdn.cn/hexo/stellar/image/shot.webp"><link rel="stylesheet" href="/custom/css/ZYGlobal.css"><link rel="stylesheet" href="/custom/css/ZYWaline.css"><link rel="stylesheet" href="/custom/css/ZYPage.css"><script type="text/javascript" src="/custom/js/header.js"></script><!-- Clarity tracking code for https://blog.thatcoder.cn/ -->
<script>    (function(c,l,a,r,i,t,y){        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i+"?ref=bwt";        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);    })(window, document, "clarity", "script", "fi1zg7i5q5");</script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-H6GM3XZWV7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-H6GM3XZWV7');
</script>
<!-- BaiDu-ZhanZhang
<meta name="baidu-site-verification" content="codeva-8tnFVr706d" />
<!-- BaiDu-Tongji -->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?233765a020502d5d6a92d4fe306d36c2";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</head>
<body>



<div class="l_body s:aa content tech " id="start" layout="wiki" type="tech" ><aside class="l_left"><div class="sidebg"></div><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><div class="icon"><img no-lazy class="icon" src="/custom/img/ydl.png" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></div><a class="title" href="/wiki/YDLDoc3/kafka/kafka%E8%BF%9B%E9%98%B6/kafka%E8%BF%9B%E9%98%B6"><div class="main" ff="title">YDLDoc3</div><div class="sub normal cap">关于YDLDoc的笔记</div><div class="sub hover cap" style="opacity:0"> 不对之处请指出</div></a></div></header>

<div class="nav-area">

<nav class="menu dis-select"><a class="nav-item" title="博客" href="/"><span>博客</span></a><a class="nav-item active" title="笔记" href="/wiki/"><span>笔记</span></a><a class="nav-item" title="便签" href="/notes/"><span>便签</span></a><a class="nav-item" title="社交" href="/links/"><span>社交</span></a></nav>
</div>
<div class="widgets">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" data-filter="/wiki/YDLDoc3/" placeholder="在 YDLDoc3 中搜索"></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div>


<widget class="widget-wrapper post-list"><div class="widget-body fs14"><a class="link" href="/wiki/YDLDoc3/kafka/kafka%E8%BF%9B%E9%98%B6/kafka%E8%BF%9B%E9%98%B6#start"><span class="toc-text">kafka进阶</span></a><a class="link" href="/wiki/YDLDoc3/kafka/kafka%E5%85%A5%E9%97%A8/kafka%E5%85%A5%E9%97%A8"><span class="toc-text">kafka入门</span></a><a class="link" href="/wiki/YDLDoc3/ELK%E5%85%A5%E9%97%A8/elk%E5%85%A5%E9%97%A8/elk%E5%85%A5%E9%97%A8"><span class="toc-text">elk入门</span></a><a class="link" href="/wiki/YDLDoc3/ELK%E5%85%A5%E9%97%A8/elk%E8%BF%9B%E9%98%B6/elk%E8%BF%9B%E9%98%B6"><span class="toc-text">elk进阶</span></a><a class="link" href="/wiki/YDLDoc3/springcloud/SpringCloudAlibaba/SpringCloudAlibaba"><span class="toc-text">SpringCloudAlibaba</span></a><a class="link" href="/wiki/YDLDoc3/springcloud/SpringCloud/SpringCloud"><span class="toc-text">SpringCloud</span></a><a class="link" href="/wiki/YDLDoc3/%E4%B8%AD%E9%97%B4%E4%BB%B6/nginx%E5%85%A5%E9%97%A8/nginx%E5%85%A5%E9%97%A8"><span class="toc-text">nginx入门</span></a><a class="link" href="/wiki/YDLDoc3/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMQ/rocketMQ"><span class="toc-text">rocketMQ</span></a><a class="link active" href="/wiki/YDLDoc3/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/rabbitMQ"><span class="toc-text">rabbitMQ</span><svg class="active-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M21 11.098v4.993c0 3.096 0 4.645-.734 5.321c-.35.323-.792.526-1.263.58c-.987.113-2.14-.907-4.445-2.946c-1.02-.901-1.529-1.352-2.118-1.47a2.225 2.225 0 0 0-.88 0c-.59.118-1.099.569-2.118 1.47c-2.305 2.039-3.458 3.059-4.445 2.945a2.238 2.238 0 0 1-1.263-.579C3 20.736 3 19.188 3 16.091v-4.994C3 6.81 3 4.666 4.318 3.333C5.636 2 7.758 2 12 2c4.243 0 6.364 0 7.682 1.332C21 4.665 21 6.81 21 11.098" opacity=".5"/><path fill="currentColor" d="M9 5.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5z"/></svg></a></div></widget>

<widget class="widget-wrapper post-card"><div class="widget-header dis-select"><span class="name">更多：开发</span></div><div class="widget-body"><a class="item wiki" href="/wiki/YDLDoc1/javase/java%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/java%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="title">元动力摘录 - JAVA阶段一</span><span class="excerpt">钟意关于YDLDoc的笔记</span></a><a class="item wiki" href="/wiki/YDLDoc2/%E6%A1%86%E6%9E%B6/SpringBoot/SpringBoot"><span class="title">元动力摘录 - JAVA阶段二</span><span class="excerpt">钟意关于YDLDoc的笔记</span></a><a class="item wiki" href="/wiki/YDLDoc4/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E5%B7%A5%E4%BD%9C%E6%B5%81/%E5%B7%A5%E4%BD%9C%E6%B5%81"><span class="title">元动力摘录 - JAVA项目阶段</span><span class="excerpt">钟意关于YDLDoc的笔记</span></a><a class="item wiki" href="/wiki/YuDaoBoot/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%89%8B%E5%86%8C/%E5%85%AC%E4%BC%97%E5%8F%B7%E5%9B%BE%E6%96%87/%E5%85%AC%E4%BC%97%E5%8F%B7%E5%9B%BE%E6%96%87"><span class="title">艿艿若依Boot - 开发指南</span><span class="excerpt">关于艿艿若依Boot的文档</span></a><a class="item wiki" href="/wiki/YuDaoCloud/%E5%89%8D%E7%AB%AF%E6%89%8B%E5%86%8C%20Vue%202/Icon%20%E5%9B%BE%E6%A0%87/Icon%20%E5%9B%BE%E6%A0%87"><span class="title">艿艿若依Cloud - 开发指南</span><span class="excerpt">关于艿艿若依Cloud的文档</span></a><a class="item wiki" href="/wiki/Laf/start/start"><span class="title">Laf - 开箱即用的 serverless</span><span class="excerpt">钟意关于Laf的笔记</span></a><a class="item wiki" href="/wiki/SpringCloud/start"><span class="title">SpringCloud - JAVA系分布式微服务架构</span><span class="excerpt">钟意关于SpringCloud的笔记</span></a><a class="item wiki" href="/wiki/MySql/basics/usually"><span class="title">MySql - 关系型数据库管理系统</span><span class="excerpt">钟意关于关系型数据库MySql的笔记</span></a></div></widget>

<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">最近更新</span></div><div class="widget-body fs14"><a class="item title" href="/wiki/LoadBalance/deploy/config"><span class="title"><strong>LoadBalance</strong><span class="dot"></span>部署前置</span></a><a class="item title" href="/wiki/LoadBalance/multiple/proxy"><span class="title"><strong>LoadBalance</strong><span class="dot"></span>负载均衡</span></a><a class="item title" href="/wiki/LoadBalance/multiple/multiple"><span class="title"><strong>LoadBalance</strong><span class="dot"></span>多平台部署前置</span></a><a class="item title" href="/wiki/LoadBalance/multiple/panel"><span class="title"><strong>LoadBalance</strong><span class="dot"></span>服务器面板</span></a><a class="item title" href="/wiki/LoadBalance/deploy/cloudflare"><span class="title"><strong>LoadBalance</strong><span class="dot"></span>Cloudflare 部署</span></a><a class="item title" href="/wiki/LoadBalance/deploy/netlify"><span class="title"><strong>LoadBalance</strong><span class="dot"></span>Netlify 部署</span></a></div></widget>
</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" style="grid-column: span 3;height:32px;padding: 0;" href="https://space.bilibili.com/1664687779" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" height="32px" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/bilibili-banner.jpg"/></a><a class="social" style="grid-column: span 3;height:32px;padding: 0;" href="https://muselink.cc/naive" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" height="32px" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/wechat-banner.jpg"/></a><a class="social" style="grid-column: span 3;height:32px;padding: 0;" href="https://github.com/ThatCoders" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" height="32px" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/github-banner.jpg"/></a><a class="social" href="javascript:ThemeChange('dark');" rel="noopener noreferrer"><img class="lazy" id="ThemeM" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/Moon.png"/></a><a class="social" href="javascript:ThemeChange('light');" rel="noopener noreferrer"><img class="lazy" id="ThemeL" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/Sun.png"/></a><a class="social" href="javascript:ThemeChange('auto');" rel="noopener noreferrer"><img class="lazy" id="ThemeAI" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/AI.png"/></a></div></footer>
</div></aside><div class="l_main" id="main">





<div class="article banner top">
    <div class="content">
      <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a>
<span class="sep"></span><a class="cap breadcrumb" id="menu" href="/wiki">文档</a><span class="sep"></span><a class="cap breadcrumb" id="proj" href="/wiki/YDLDoc3/kafka/kafka%E8%BF%9B%E9%98%B6/kafka%E8%BF%9B%E9%98%B6">YDLDoc3</a></div>
<div class="flex-row" id="post-meta"><span class="text created">更新于：<time datetime="2023-12-16T19:23:22.000Z">2023-12-17</time></span></div></div></div>
      
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>rabbitMQ</span></h1>
        
      </div>
    </div>
    
    </div>
    </div><article class="md-text content"><div class="theme-hope-content"><h1 id="rabbitmq入门" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#rabbitmq入门">#</a> RabbitMQ入门</h1><div class="hint-container tip"><p class="hint-container-title">提示</p><p>课程视频教程链接：<a href="https://www.bilibili.com/video/BV1dt4y147CK" rel="noopener noreferrer" target="_blank">https://www.bilibili.com/video/BV1dt4y147CK<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><p>学习目标</p><ul><li>能够说出什么是消息中间件</li><li>能够安装RabbitMQ</li><li>能够编写RabbitMQ的入门程序</li><li>能够说出RabbitMQ的5种模式特征-重点</li><li>能够使用Spring整合RabbitMQ</li></ul><h2 id="第一章-消息中间件概述-了解" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第一章-消息中间件概述-了解">#</a> 第一章 消息中间件概述-了解</h2><h3 id="_1、-什么是消息中间件" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、-什么是消息中间件">#</a> 1、 什么是消息中间件</h3><h4 id="_1-mq是什么" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-mq是什么">#</a> （1）MQ是什么</h4><p>MQ全称为Message Queue，消息队列是应用程序和应用程序之间的通信方法。</p><p>先进先出</p><p>原先：ip:port/order/add?goodsId=1</p><figure><img class="lazy" alt="image-20220408204615842" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220408204615842-2ec9d620.png" tabindex="0"/><figcaption>image-20220408204615842</figcaption></figure><p>现在：异步调用</p><figure><img class="lazy" alt="image-20220408205148101" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220408205148101-2172857b.png" tabindex="0"/><figcaption>image-20220408205148101</figcaption></figure><h4 id="_2-为什么使用mq-面试" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-为什么使用mq-面试">#</a> （2）为什么使用MQ--面试</h4><p>在项目中，可将一些无需即时返回且耗时的操作提取出来，进行<strong>异步处理</strong>，而这种异步处理的方式大大的节省了服务器的请求响应时间，从而<strong>提高</strong>了<strong>系统</strong>的<strong>吞吐量</strong>。</p><p>现在，应用开发和部署---微服务。</p><h4 id="_3-mq优势" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-mq优势">#</a> <strong>（3）MQ优势</strong></h4><h5 id="a、应用解耦" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#a、应用解耦">#</a> a、<strong>应用解耦</strong></h5><p>MQ相当于一个中介，生产方通过MQ与消费方交互，它将应用程序进行解耦合。</p><figure><img class="lazy" alt="image-20220408210051290" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220408210051290-27a1c5bb.png" tabindex="0"/><figcaption>image-20220408210051290</figcaption></figure><h5 id="b、异步提速" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#b、异步提速">#</a> b、<strong>异步提速</strong></h5><p>将不需要同步处理的并且耗时长的操作由消息队列通知消息接收方进行异步处理。提高了应用程序的响应时间。</p><figure><img class="lazy" alt="image-20220408210805836" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220408210805836-3b12b167.png" tabindex="0"/><figcaption>image-20220408210805836</figcaption></figure><p>order_table status 0 已下单 status 1 支付成功 status 2 已通知商家发货 status 3 商家发货 status 4 已经收货</p><h5 id="c、削峰填谷" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#c、削峰填谷">#</a> c、<strong>削峰填谷</strong></h5><p>如订单系统，在下单的时候就会往数据库写数据。但是数据库只能支撑每秒1000左右的并发写入，并发量再高就容易宕机。低峰期的时候并发也就100多个，但是在高峰期时候，并发量会突然激增到5000以上，这个时候数据库肯定卡死了。</p><p>消息被MQ保存起来了，然后系统就可以按照自己的消费能力来消费，比如每秒1000个数据，这样慢慢写入数据库，这样就不会卡死数据库了。</p><figure><img class="lazy" alt="image-20220408211341420" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220408211341420-1d296a5c.png" tabindex="0"/><figcaption>image-20220408211341420</figcaption></figure><p>但是使用了MQ之后，限制消费消息的速度为1000，但是这样一来，高峰期产生的数据势必会被积压在MQ中，高峰就被“削”掉了。但是因为消息积压，在高峰期过后的一段时间内，消费消息的速度还是会维持在1000QPS，直到消费完积压的消息,这就叫做“填谷”</p><figure><img class="lazy" alt="" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/03-8859b83b.png" tabindex="0"/><figcaption></figcaption></figure><h4 id="_4-mq劣势" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-mq劣势">#</a> （4）<strong>MQ劣势</strong></h4><ul><li><strong>系统可用性降低</strong></li></ul><p>系统引入的外部依赖越多，系统稳定性越差。一旦 MQ 宕机，就会对业务造成影响。如何保证MQ的高可用？</p><ul><li><strong>系统复杂度提高</strong></li></ul><p>MQ 的加入大大增加了系统的复杂度，以前系统间是同步的远程调用，现在是通过 MQ 进行异步调用。如何</p><p>保证消息没有被重复消费？怎么处理消息丢失情况？那么保证消息传递的顺序性？</p><ul><li><strong>一致性问题</strong></li></ul><p>A 系统处理完业务，通过 MQ 给B、C、D三个系统发消息数据，如果 B 系统、C 系统处理成功，D 系统处理</p><p>失败。如何保证消息数据处理的一致性。</p><p>最终一致性。</p><h4 id="_5-什么时候用mq" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_5-什么时候用mq">#</a> （5）什么时候用MQ</h4><p>① 生产者不需要从消费者处获得反馈。引入消息队列之前的直接调用，其接口的返回值应该为空，这才让明 明下层的动作还没做，上层却当成动作做完了继续往后走，即所谓异步成为了可能。</p><p>② 容许短暂的不一致性。</p><p>③ 确实是用了有效果。即解耦、提速、削峰这些方面的收益，超过加入MQ，管理MQ这些成本、</p><h3 id="_2、amqp-和-jms" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、amqp-和-jms">#</a> 2、AMQP 和 JMS</h3><p>MQ是消息通信的模型；实现MQ的大致有两种主流方式：AMQP、JMS。</p><h4 id="_1-amqp" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-amqp">#</a> （1）AMQP</h4><p>AMQP是一种协议，更准确的说是一种binary wire-level protocol（链接协议）。这是其和JMS的本质差别，AMQP不从API层进行限定，而是直接定义网络交换的数据格式。</p><h4 id="_2-jms" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-jms">#</a> （2）JMS</h4><p>JMS即Java消息服务（JavaMessage Service）应用程序接口，是一个Java平台中关于面向消息中间件（MOM）的API，用于在两个应用程序之间，或分布式系统中发送消息，进行异步通信。</p><h4 id="_3-amqp-与-jms-区别" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-amqp-与-jms-区别">#</a> （3）AMQP 与 JMS 区别</h4><ul><li>JMS是定义了统一的接口，来对消息操作进行统一；AMQP是通过规定协议来统一数据交互的格式</li><li>JMS限定了必须使用Java语言；AMQP只是协议，不规定实现方式，因此是跨语言的。</li><li>JMS规定了两种消息模式；而AMQP的消息模式更加丰富。</li></ul><h3 id="_3、消息队列产品" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、消息队列产品">#</a> 3、消息队列产品</h3><p>市场上常见的消息队列有如下：</p><ul><li>ActiveMQ：基于JMS</li><li>ZeroMQ：基于C语言开发</li><li>RabbitMQ：基于AMQP协议，erlang语言开发，稳定性好</li><li>RocketMQ：基于JMS，阿里巴巴产品</li><li>Kafka：类似MQ的产品；分布式消息系统，高吞吐量</li></ul><figure><img class="lazy" alt="image-20200320111345727" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20200320111345727-041941a7.png" tabindex="0"/><figcaption>image-20200320111345727</figcaption></figure><h3 id="_4、-rabbitmq" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4、-rabbitmq">#</a> 4、 RabbitMQ</h3><h4 id="_1-rabbitmq特点" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-rabbitmq特点">#</a> （1）RabbitMQ<strong>特点</strong>：</h4><ul><li>1、使用简单，功能强大。</li><li>2、基于<strong>AMQP</strong>协议。 跨语言 c node.js-&gt;mq-&gt;java python</li><li>3、社区活跃，文档完善。</li><li>4、高并发性能好，这主要得益于<strong>Erlang</strong>语言。 c 底层语言，性能强。java 好开发。构建一个web。</li><li>5、Spring Boot默认已集成RabbitMQ</li></ul><h4 id="_2-其它相关术语" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-其它相关术语">#</a> （2）其它相关术语</h4><p>AMQP：</p><figure><img class="lazy" alt="image-20200320174327969" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20200320174327969-9152399e.png" tabindex="0"/><figcaption>image-20200320174327969</figcaption></figure><p>JMS ：</p><figure><img class="lazy" alt="image-20200320174346261" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20200320174346261-ff48f62e.png" tabindex="0"/><figcaption>image-20200320174346261</figcaption></figure><p>总结：</p><p>JMS是java提供的一套消息服务API标准，其目的是为所有的java应用程序提供统一的消息通信的标准，类似java的jdbc，只要遵循jms标准的应用程序之间都可以进行消息通信。</p><p>它和AMQP有什么 不同，jms是java语言专属的消息服务标准，它是在api层定义标准，并且只能用于java应用；而AMQP是在协议层定义的标准，是跨语言的 。</p><h4 id="_3-工作模式" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-工作模式">#</a> （3）工作模式</h4><p>RabbitMQ提供了6种模式：简单模式，work模式，Publish/Subscribe发布与订阅模式，<strong>Routing</strong>路由模式，<strong>Topics</strong>主题模式，RPC远程调用模式（远程调用，不太算MQ；暂不作介绍）；</p><p>官网对应模式介绍：<a href="https://www.rabbitmq.com/getstarted.html" rel="noopener noreferrer" target="_blank">https://www.rabbitmq.com/getstarted.html<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img class="lazy" alt="1555988678324" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1555988678324-a0be1434.png" tabindex="0"/><figcaption>1555988678324</figcaption></figure><h2 id="第二章-rabbitmq工作原理-重点" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第二章-rabbitmq工作原理-重点">#</a> 第二章 RabbitMQ工作原理--重点！</h2><p><strong>重点看这张图</strong>：</p><figure><img class="lazy" alt="image-20200320180217097" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20200320180217097-f868c655.png" tabindex="0"/><figcaption>image-20200320180217097</figcaption></figure><p>http 三次握手 四次挥手 一个长连接</p><p><strong>一个消费者监听“一个”“队列”</strong></p><ul><li>Broker：消息队列服务进程，此进程包括两个部分：Exchange和Queue。</li><li>Exchange：消息队列交换机，按一定的规则将消息路由转发到某个队列，对消息进行过虑。</li><li>Queue：消息队列，存储消息的队列，消息到达队列并转发给指定的消费方。</li><li>Producer：消息生产者，即生产方客户端，生产方客户端将消息发送到MQ。</li><li>Consumer：消息消费者，即消费方客户端，接收MQ转发的消息。</li></ul><p>消息发布接收流程：</p><p>-----发送消息-----</p><p>1、生产者和Broker建立TCP连接。</p><p>2、生产者和Broker建立通道。</p><p>3、生产者通过通道消息发送给Broker，由Exchange将消息进行转发。</p><p>4、Exchange将消息转发到指定的Queue（队列）</p><p>----接收消息-----</p><p>1、消费者和Broker建立TCP连接</p><p>2、消费者和Broker建立通道</p><p>3、消费者监听指定的Queue（队列）</p><p>4、当有消息到达Queue时Broker默认将消息推送给消费者。</p><p>5、消费者接收到消息。</p><h3 id="_1、相关概念介绍" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、相关概念介绍">#</a> 1、相关概念介绍</h3><p>AMQP 一个提供统一消息服务的应用层标准高级消息队列协议，是应用层协议的一个开放标准，为面向消息的中间件设计。</p><p>AMQP是一个二进制协议，拥有一些现代化特点：多信道、协商式，异步，安全，扩平台，中立，高效。</p><p>RabbitMQ是AMQP协议的Erlang的实现。</p><table><thead><tr><th>概念</th><th>说明</th></tr></thead><tbody><tr><td>连接Connection</td><td>一个网络连接，比如TCP/IP套接字连接。</td></tr><tr><td>会话Session</td><td>端点之间的命名对话。在一个会话上下文中，保证“恰好传递一次”。</td></tr><tr><td>信道Channel</td><td>多路复用连接中的一条独立的双向数据流通道。为会话提供物理传输介质。</td></tr><tr><td>客户端Client</td><td>AMQP连接或者会话的发起者。AMQP是非对称的，客户端生产和消费消息，服务器存储和路由这些消息。</td></tr><tr><td>服务节点Broker</td><td>消息中间件的服务节点；一般情况下可以将一个RabbitMQ Broker看作一台RabbitMQ 服务器。</td></tr><tr><td>端点</td><td>AMQP对话的任意一方。一个AMQP连接包括两个端点（一个是客户端，一个是服务器）。</td></tr><tr><td>消费者Consumer</td><td>一个从消息队列里请求消息的客户端程序。</td></tr><tr><td>生产者Producer</td><td>一个向交换机发布消息的客户端应用程序。</td></tr></tbody></table><h3 id="_2、rabbitmq运转流程" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、rabbitmq运转流程">#</a> 2、RabbitMQ运转流程</h3><p>在入门案例中：</p><ul><li>生产者发送消息 <ol><li>生产者创建连接（Connection），开启一个信道（Channel），连接到RabbitMQ Broker；</li><li>声明队列并设置属性；如是否排它，是否持久化，是否自动删除；</li><li>将路由键（空字符串）与队列绑定起来；</li><li>发送消息至RabbitMQ Broker；</li><li>关闭信道；</li><li>关闭连接；</li></ol></li><li>消费者接收消息 <ol><li>消费者创建连接（Connection），开启一个信道（Channel），连接到RabbitMQ Broker</li><li>向Broker 请求消费相应队列中的消息，设置相应的回调函数；</li><li>等待Broker回应闭关投递响应队列中的消息，消费者接收消息；</li><li>确认（ack，自动确认）接收到的消息；</li><li>RabbitMQ从队列中删除相应已经被确认的消息；</li><li>关闭信道；</li><li>关闭连接；</li></ol></li></ul><figure><img class="lazy" alt="1565105223969" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1565105223969-aa63c797.png" tabindex="0"/><figcaption>1565105223969</figcaption></figure><h3 id="_3、生产者流转过程说明" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、生产者流转过程说明">#</a> 3、生产者流转过程说明</h3><ol><li>客户端与代理服务器Broker建立连接。会调用newConnection() 方法,这个方法会进一步封装Protocol Header 0-9-1 的报文头发送给Broker ，以此通知Broker 本次交互采用的是AMQPO-9-1 协议，紧接着Broker 返回Connection.Start 来建立连接，在连接的过程中涉及Connection.Start/.Start-OK 、Connection.Tune/.Tune-Ok ，Connection.Open/ .Open-Ok 这6 个命令的交互。</li><li>客户端调用connection.createChannel方法。此方法开启信道，其包装的channel.open命令发送给Broker,等待channel.basicPublish方法，对应的AMQP命令为Basic.Publish,这个命令包含了content Header 和content Body()。content Header 包含了消息体的属性，例如:投递模式，优先级等，content Body 包含了消息体本身。</li><li>客户端发送完消息需要关闭资源时，涉及到Channel.Close和Channl.Close-Ok 与Connetion.Close和Connection.Close-Ok的命令交互。</li></ol><p>![生产者流转过程图](./img/生产者流转过程图.bmp</p><h3 id="_4、消费者流转过程说明" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4、消费者流转过程说明">#</a> 4、消费者流转过程说明</h3><ol><li><p>消费者客户端与代理服务器Broker建立连接。会调用newConnection() 方法,这个方法会进一步封装Protocol Header 0-9-1 的报文头发送给Broker ，以此通知Broker 本次交互采用的是AMQPO-9-1 协议，紧接着Broker 返回Connection.Start 来建立连接，在连接的过程中涉及Connection.Start/.Start-OK 、Connection.Tune/.Tune-Ok ，Connection.Open/ .Open-Ok 这6 个命令的交互。</p></li><li><p>消费者客户端调用connection.createChannel方法。和生产者客户端一样，协议涉及Channel . Open/Open-Ok命令。</p></li><li><p>在真正消费之前，消费者客户端需要向Broker 发送Basic.Consume 命令(即调用channel.basicConsume 方法〉将Channel 置为接收模式，之后Broker 回执Basic . Consume - Ok 以告诉消费者客户端准备好消费消息。</p></li><li><p>Broker 向消费者客户端推送(Push) 消息，即Basic.Deliver 命令，这个命令和Basic.Publish 命令一样会携带Content Header 和Content Body。</p></li><li><p>消费者接收到消息并正确消费之后，向Broker 发送确认，即Basic.Ack 命令。</p></li><li><p>客户端发送完消息需要关闭资源时，涉及到Channel.Close和Channl.Close-Ok 与Connetion.Close和Connection.Close-Ok的命令交互。</p><figure><img class="lazy" alt="消费者流转过程图" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20221124210458935-d4f288f6.png" tabindex="0"/><figcaption>消费者流转过程图</figcaption></figure></li></ol><h2 id="第三章-安装及配置rabbitmq" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第三章-安装及配置rabbitmq">#</a> 第三章 安装及配置RabbitMQ</h2><h3 id="_1、下载安装" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、下载安装">#</a> 1、下载安装</h3><p>​ RabbitMQ由Erlang语言开发，Erlang语言用于并发及分布式系统的开发，在电信领域应用广泛，OTP（Open Telecom Platform）作为Erlang语言的一部分，包含了很多基于Erlang开发的中间件及工具库，安装RabbitMQ需要安装Erlang/OTP，并保持版本匹配，如下图：</p><p>RabbitMQ的下载地址：<a href="http://www.rabbitmq.com/download.html" rel="noopener noreferrer" target="_blank">http://www.rabbitmq.com/download.html<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img class="lazy" alt="image-20220408215304890" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220408215304890-e1f46c2f.png" tabindex="0"/><figcaption>image-20220408215304890</figcaption></figure><p>本项目使用Erlang/OTP 20.3版本和RabbitMQ3.7.3版本。</p><h3 id="_2、下载erlang" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、下载erlang">#</a> 2、下载erlang</h3><p>安装软件：路径不要有中文和空格。<strong>管理员</strong></p><p>1地址如下：</p><p><a href="https://www.erlang.org/downloads" rel="noopener noreferrer" target="_blank">https://www.erlang.org/downloads<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>或去老师提供的软件包中找到 otp_win64_20.3.exe，以<strong>管理员</strong>方式运行此文件，安装。</p><p>2erlang安装完成需要配置erlang环境变量：</p><p>​ ERLANG_HOME=D:\soft\erl9.3</p><p>​ 在path中添加%ERLANG_HOME%\bin</p><h3 id="_3、安装rabbitmq" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、安装rabbitmq">#</a> 3、安装RabbitMQ</h3><p><a href="https://github.com/rabbitmq/rabbitmq-server/releases/tag/v3.7.3" rel="noopener noreferrer" target="_blank">https://github.com/rabbitmq/rabbitmq-server/releases/tag/v3.7.3<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>或去老师提供的软件包中找到 rabbitmq-server-3.7.3.exe，以<strong>管理员</strong>方式运行此文件，安装。</p><figure><img class="lazy" alt="image-20220408220632620" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220408220632620-dcd30a93.png" tabindex="0"/><figcaption>image-20220408220632620</figcaption></figure><h3 id="_4、启动" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4、启动">#</a> 4、启动</h3><p>安装成功后会自动创建RabbitMQ服务并且启动。</p><p>（1）从开始菜单启动RabbitMQ</p><p>完成在开始菜单找到RabbitMQ的菜单：</p><figure><img class="lazy" alt="image-20200320174855134" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20200320174855134-7aa6274f.png" tabindex="0"/><figcaption>image-20200320174855134</figcaption></figure><p>RabbitMQ Service-install :安装服务</p><p>RabbitMQ Service-remove 删除服务</p><p>RabbitMQ Service-start 启动</p><p>RabbitMQ Service-stop 启动</p><p>（2）如果没有开始菜单则进入安装目录下sbin目录手动启动：</p><figure><img class="lazy" alt="image-20200320174919367" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20200320174919367-09c74d6b.png" tabindex="0"/><figcaption>image-20200320174919367</figcaption></figure><p>（3）安装并运行服务</p><p>rabbitmq-service.bat install 安装服务</p><p>rabbitmq-service.bat stop 停止服务</p><p>rabbitmq-service.bat start 启动服务</p><p>（4）安装管理插件</p><p>安装rabbitMQ的管理插件，方便在浏览器端管理RabbitMQ</p><p>在sbin目录下，<strong>管理员身份</strong>运行cmd</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">rabbitmq-plugins.bat enable rabbitmq_management<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><h3 id="_5、启动成功-登录rabbitmq" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_5、启动成功-登录rabbitmq">#</a> 5、启动成功 登录RabbitMQ</h3><p>进入浏览器，输入：<a href="http://localhost:15672" rel="noopener noreferrer" target="_blank">http://localhost:15672<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img class="lazy" alt="image-20200320175052306" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20200320175052306-a9c088c5.png" tabindex="0"/><figcaption>image-20200320175052306</figcaption></figure><p>初始账号和密码：guest/guest</p><figure><img class="lazy" alt="image-20220408221008693" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220408221008693-bd953c3f.png" tabindex="0"/><figcaption>image-20220408221008693</figcaption></figure><h3 id="_6、注意事项" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_6、注意事项">#</a> 6、注意事项</h3><p>1、安装erlang和rabbitMQ以管理员身份运行。</p><p>2、当卸载重新安装时会出现RabbitMQ服务注册失败，此时需要进入注册表清理erlang</p><p>搜索RabbitMQ、ErlSrv，将对应的项全部删除。</p><h3 id="_7、查看管理控制台" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_7、查看管理控制台">#</a> 7、查看管理控制台</h3><figure><img class="lazy" alt="image-20200320175339750" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20200320175339750-e00ee8bc.png" tabindex="0"/><figcaption>image-20200320175339750</figcaption></figure><p>尝试新增用户、新增虚拟机。</p><h2 id="第四章-rabbitmq入门" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第四章-rabbitmq入门">#</a> 第四章 RabbitMQ入门</h2><p><strong>简单模式</strong></p><figure><img class="lazy" alt="image-20200320180411894" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20200320180411894-5ac5a8b3.png" tabindex="0"/><figcaption>image-20200320180411894</figcaption></figure><h3 id="_1、搭建示例工程" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、搭建示例工程">#</a> 1、搭建示例工程</h3><h4 id="_1-创建工程" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-创建工程">#</a> （1）创建工程</h4><figure><img class="lazy" alt="image-20220408221608751" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220408221608751-f881d76e.png" tabindex="0"/><figcaption>image-20220408221608751</figcaption></figure><p>rabbitmqtest父工程下，新建两个模块：producer和consumer</p><figure><img class="lazy" alt="image-20220408221703947" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220408221703947-3fefbc02.png" tabindex="0"/><figcaption>image-20220408221703947</figcaption></figure><h4 id="_2-添加依赖" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-添加依赖">#</a> （2）添加依赖</h4><p>往rabbitmqtest的pom.xml文件中添加如下依赖：</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>dependencies<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.rabbitmq<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>amqp-client<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>5.6.0<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/dependencies<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2、-编写生产者" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、-编写生产者">#</a> 2、 编写生产者</h3><p>producer工程中，编写消息生产者com.ydlclass.rabbitmq.simple.Producer</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydlclass.rabbitmq.simple;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.AMQP;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.ConnectionFactory;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Created</span> by IT李老师</span><br><span class="hljs-comment"> * 公主号 “元动力课堂”</span><br><span class="hljs-comment"> * 个人微 itlils</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Producer</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//1创建连接工厂</span><br>        ConnectionFactory connectionFactory=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();<br>        <span class="hljs-comment">//连接的ip</span><br>        connectionFactory.setHost(<span class="hljs-string">&quot;localhost&quot;</span>);<br>        <span class="hljs-comment">//连接的端口</span><br>        connectionFactory.setPort(<span class="hljs-number">5672</span>);<br>        <span class="hljs-comment">//设置虚拟主机</span><br>        connectionFactory.setVirtualHost(<span class="hljs-string">&quot;/&quot;</span>);<br>        <span class="hljs-comment">//设置用户名</span><br>        connectionFactory.setUsername(<span class="hljs-string">&quot;itlils&quot;</span>);<br>        <span class="hljs-comment">//设置密码</span><br>        connectionFactory.setPassword(<span class="hljs-string">&quot;itlils&quot;</span>);<br><br>        <span class="hljs-comment">//2创建长连接</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> connectionFactory.newConnection();<br>        <span class="hljs-comment">//3创建channel</span><br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br>        <span class="hljs-comment">//声明队列</span><br>        <span class="hljs-comment">//String queue,  队列名</span><br>        <span class="hljs-comment">// boolean durable, 持久化</span><br>        <span class="hljs-comment">// boolean exclusive, 排他的</span><br>        <span class="hljs-comment">// boolean autoDelete, 自动删除</span><br>        <span class="hljs-comment">// Map&amp;lt;String, Object&amp;gt; arguments 属性</span><br>        channel.queueDeclare(<span class="hljs-string">&quot;ydlqueue&quot;</span>,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">//4发消息</span><br>        <span class="hljs-comment">// String exchange,  交换机</span><br>        <span class="hljs-comment">// String routingKey, 路由键</span><br>        <span class="hljs-comment">// AMQP.BasicProperties props, 属性</span><br>        <span class="hljs-comment">// byte[] body 消息      string byte[] char[]如何相互转换的？</span><br>        String msg=<span class="hljs-string">&quot;hello rabbitmq!&quot;</span>;<br>        channel.basicPublish(<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;ydlqueue&quot;</span>,<span class="hljs-literal">null</span>,msg.getBytes());<br><br>        <span class="hljs-comment">//5关闭连接  资源关闭的顺序，先关后出来的资源，最后关，第一个资源</span><br>        channel.close();<br>        connection.close();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在执行上述的消息发送之后；可以登录rabbitMQ的管理控制台，可以发现队列和其消息：</p><figure><img class="lazy" alt="image-20220408223540630" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220408223540630-119923ff.png" tabindex="0"/><figcaption>image-20220408223540630</figcaption></figure><p>查看消息</p><figure><img class="lazy" alt="image-20220408223601408" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220408223601408-a29a49a6.png" tabindex="0"/><figcaption>image-20220408223601408</figcaption></figure><p><strong>注意</strong>：关闭连接</p><h3 id="_3、-编写消费者" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、-编写消费者">#</a> 3、 编写消费者</h3><p>consumer工程，编写消息的消费者com.ydlclass.rabbitmq.simple.Consumer</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydlclass.rabbitmq.simple;<br><br><span class="hljs-keyword">import</span> com.ydlclass.rabbitmq.util.ConnectionUtil;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Consumer</span> &#123;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">QUEUE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;simple_queue&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//1创建连接工厂</span><br>        <span class="hljs-type">ConnectionFactory</span> <span class="hljs-variable">connectionFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();<br>        <span class="hljs-comment">//主机地址;默认为 localhost</span><br>        connectionFactory.setHost(<span class="hljs-string">&quot;localhost&quot;</span>);<br>        <span class="hljs-comment">//连接端口;默认为 5672</span><br>        connectionFactory.setPort(<span class="hljs-number">5672</span>);<br>        <span class="hljs-comment">//虚拟主机名称;默认为 /</span><br>        connectionFactory.setVirtualHost(<span class="hljs-string">&quot;/&quot;</span>);<br>        <span class="hljs-comment">//连接用户名；默认为guest</span><br>        connectionFactory.setUsername(<span class="hljs-string">&quot;itlils&quot;</span>);<br>        <span class="hljs-comment">//连接密码；默认为guest</span><br>        connectionFactory.setPassword(<span class="hljs-string">&quot;itlils&quot;</span>);<br><br>        <span class="hljs-comment">//2创建连接</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> connectionFactory.newConnection();<br><br>        <span class="hljs-comment">//3创建频道</span><br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br><br>        <span class="hljs-comment">//6声明（创建）队列</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：是否定义持久化队列</span><br><span class="hljs-comment">         * 参数3：是否独占本次连接</span><br><span class="hljs-comment">         * 参数4：是否在不使用的时候自动删除队列</span><br><span class="hljs-comment">         * 参数5：队列其它参数</span><br><span class="hljs-comment">         */</span><br>        channel.queueDeclare(QUEUE_NAME, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">//5创建消费者；并设置消息处理</span><br>        <span class="hljs-type">DefaultConsumer</span> <span class="hljs-variable">consumer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConsumer</span>(channel)&#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * consumerTag 消息者标签，在channel.basicConsume时候可以指定</span><br><span class="hljs-comment">             * envelope 消息包的内容，可从中获取消息id，消息routingkey，交换机，消息和重传标志(收到消息失败后是否需要重新发送)</span><br><span class="hljs-comment">             * properties 属性信息</span><br><span class="hljs-comment">             * body 消息</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-type">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                <span class="hljs-comment">//消费者标签</span><br>                System.out.println(<span class="hljs-string">&quot;消费者标签为：&quot;</span> + consumerTag);<br>                <span class="hljs-comment">//路由key</span><br>                System.out.println(<span class="hljs-string">&quot;路由key为：&quot;</span> + envelope.getRoutingKey());<br>                <span class="hljs-comment">//交换机</span><br>                System.out.println(<span class="hljs-string">&quot;交换机为：&quot;</span> + envelope.getExchange());<br>                <span class="hljs-comment">//消息id</span><br>                System.out.println(<span class="hljs-string">&quot;消息id为：&quot;</span> + envelope.getDeliveryTag());<br>                <span class="hljs-comment">//收到的消息</span><br>                System.out.println(<span class="hljs-string">&quot;接收到的消息为：&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body, <span class="hljs-string">&quot;utf-8&quot;</span>));<br>            &#125;<br>        &#125;;<br>        <span class="hljs-comment">//4监听消息</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：是否自动确认，设置为true为表示消息接收到自动向mq回复接收到了，mq接收到回复会删除消息，设置为false则需要手动确认</span><br><span class="hljs-comment">         * 参数3：消息接收到后回调</span><br><span class="hljs-comment">         */</span><br>        channel.basicConsume(QUEUE_NAME, <span class="hljs-literal">true</span>, consumer);<br><br>        <span class="hljs-comment">//不关闭资源，应该一直监听消息</span><br>        <span class="hljs-comment">//channel.close();</span><br>        <span class="hljs-comment">//connection.close();</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>有能力的同学</strong>，抽取创建connection的工具类com.ydlclass.rabbitmq.util.ConnectionUtil；</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydlclass.rabbitmq.util;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.ConnectionFactory;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionUtil</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//创建连接工厂</span><br>        <span class="hljs-type">ConnectionFactory</span> <span class="hljs-variable">connectionFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();<br>        <span class="hljs-comment">//主机地址;默认为 localhost</span><br>        connectionFactory.setHost(<span class="hljs-string">&quot;localhost&quot;</span>);<br>        <span class="hljs-comment">//连接端口;默认为 5672</span><br>        connectionFactory.setPort(<span class="hljs-number">5672</span>);<br>        <span class="hljs-comment">//虚拟主机名称;默认为 /</span><br>        connectionFactory.setVirtualHost(<span class="hljs-string">&quot;/&quot;</span>);<br>        <span class="hljs-comment">//连接用户名；默认为guest</span><br>        connectionFactory.setUsername(<span class="hljs-string">&quot;itlils&quot;</span>);<br>        <span class="hljs-comment">//连接密码；默认为guest</span><br>        connectionFactory.setPassword(<span class="hljs-string">&quot;itlils&quot;</span>);<br><br>        <span class="hljs-comment">//创建连接</span><br>        <span class="hljs-keyword">return</span> connectionFactory.newConnection();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4、小结" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4、小结">#</a> 4、小结</h3><p>上述的入门案例中中其实使用的是如下的简单模式：</p><figure><img class="lazy" alt="1555991074575" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1555991074575-378c6df5.png" tabindex="0"/><figcaption>1555991074575</figcaption></figure><p>在上图的模型中，有以下概念：</p><ul><li>P：生产者，也就是要发送消息的程序</li><li>C：消费者：消息的接受者，会一直等待消息到来。</li><li>queue：消息队列，图中红色部分。类似一个邮箱，可以缓存消息；生产者向其中投递消息，消费者从其中取出消息。</li></ul><h2 id="第五章-rabbitmq工作模式-重点" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第五章-rabbitmq工作模式-重点">#</a> 第五章 RabbitMQ工作模式--重点</h2><h3 id="_1、work-queues工作队列模式-包工头" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、work-queues工作队列模式-包工头">#</a> 1、Work queues工作队列模式（包工头）</h3><h4 id="_1-模式说明" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-模式说明">#</a> （1） 模式说明</h4><figure><img class="lazy" alt="1556009144848" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1556009144848-97988634.png" tabindex="0"/><figcaption>1556009144848</figcaption></figure><p><code>Work Queues</code>与入门程序的<code>简单模式</code>相比，多了一个或一些消费端，多个消费端共同消费同一个队列中的消息。</p><p><strong>应用场景</strong>：对于 任务过重或任务较多情况使用工作队列可以提高任务处理的速度。</p><h4 id="_2-代码" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-代码">#</a> （2）代码</h4><p>复制生产者消费者各一份</p><figure><img class="lazy" alt="image-20220411210359456" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220411210359456-c4ca6df9.png" tabindex="0"/><figcaption>image-20220411210359456</figcaption></figure><h5 id="a、生产者-修改队列名" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#a、生产者-修改队列名">#</a> a、生产者 修改队列名</h5><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">QUEUE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;workqueue&quot;</span>;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &amp;lt; <span class="hljs-number">10</span>; i++) &#123;<br>            String msg=<span class="hljs-string">&quot;hello rabbitmq!workqueue&quot;</span>+i;<br>            channel.basicPublish(<span class="hljs-string">&quot;&quot;</span>,QUEUE,<span class="hljs-literal">null</span>,msg.getBytes());<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="b、消费者1-监听同一个队列" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#b、消费者1-监听同一个队列">#</a> b、消费者1 监听同一个队列</h5><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">QUEUE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;workqueue&quot;</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><h5 id="c、消费者2-消费者再起一份" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#c、消费者2-消费者再起一份">#</a> c、消费者2 消费者再起一份</h5><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">QUEUE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;workqueue&quot;</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><h3 id="_3-测试" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-测试">#</a> （3）测试</h3><p>生产者，多运行几次，观察连个消费者</p><p>设置，消费者能启多份：</p><figure><img class="lazy" alt="image-20220411210105591" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220411210105591-b88f5e92.png" tabindex="0"/><figcaption>image-20220411210105591</figcaption></figure><p>在一个队列中如果有多个消费者，那么消费者之间对于同一个队列消息的关系是<strong>竞争</strong>的关系。</p><p>第一个消费者</p><figure><img class="lazy" alt="image-20220411210449520" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220411210449520-b8782f8d.png" tabindex="0"/><figcaption>image-20220411210449520</figcaption></figure><p>第二个消费者:</p><figure><img class="lazy" alt="image-20220411210501744" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220411210501744-c194803f.png" tabindex="0"/><figcaption>image-20220411210501744</figcaption></figure><h3 id="_2、publish-subscribe-订阅发布模式类型-微博" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、publish-subscribe-订阅发布模式类型-微博">#</a> 2、publish/subscribe 订阅发布模式类型（微博）</h3><p>atm取100元，短信，邮件。</p><p>订阅模式示例图：</p><figure><img class="lazy" alt="1556014499573" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1556014499573-697c4d0b.png" tabindex="0"/><figcaption>1556014499573</figcaption></figure><p>前面2个案例中，只有3个角色：</p><ul><li>P：生产者，也就是要发送消息的程序</li><li>C：消费者：消息的接受者，会一直等待消息到来。</li><li>queue：消息队列，图中红色部分</li></ul><p>而在订阅模型中，多了一个exchange角色，而且过程略有变化：</p><ul><li>P：生产者，也就是要发送消息的程序，但是不再发送到队列中，而是发给X（交换机）</li><li>C：消费者，消息的接受者，会一直等待消息到来。</li><li>Queue：消息队列，接收消息、缓存消息。</li><li>Exchange：交换机，图中的X。一方面，接收生产者发送的消息。另一方面，知道如何处理消息，例如递交给某个特别队列、递交给所有队列、或是将消息丢弃。到底如何操作，取决于Exchange的类型。Exchange有常见以下3种类型： <ul><li>Fanout：广播，将消息交给所有绑定到交换机的队列</li><li>Direct：定向，把消息交给符合指定routing key 的队列</li><li>Topic：通配符，把消息交给符合routing pattern（路由模式） 的队列</li></ul></li></ul><p><strong>Exchange（交换机）只负责转发消息，不具备存储消息的能力</strong>，因此如果没有任何队列与Exchange绑定，或者没有符合路由规则的队列，那么消息会丢失！</p><h3 id="_3、-publish-subscribe发布与订阅模式-微博" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、-publish-subscribe发布与订阅模式-微博">#</a> 3、 Publish/Subscribe发布与订阅模式（微博）</h3><h4 id="_1-模式说明-1" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-模式说明-1">#</a> （ 1）模式说明</h4><figure><img class="lazy" alt="1556010329032" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1556010329032-ed5e1d7d.png" tabindex="0"/><figcaption>1556010329032</figcaption></figure><p>发布订阅模式： 1、每个消费者监听自己的队列。 2、生产者将消息发给broker，由交换机将消息转发到绑定此交换机的每个队列，每个绑定交换机的队列都将接收 到消息</p><h4 id="_2-代码-1" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-代码-1">#</a> （2）代码</h4><h5 id="a、生产者" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#a、生产者">#</a> a、生产者</h5><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydlclass.rabbitmq.simple;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.ConnectionFactory;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * creste by ydlclass.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Producer_pubsub</span> &#123;<br>    <span class="hljs-comment">//交换机名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FANOUT_EXCHAGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;fanout_exchange&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FANOUT_QUEUE_1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;fanout_queue_1&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FANOUT_QUEUE_2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;fanout_queue_2&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">//1创建连接工厂</span><br>        <span class="hljs-type">ConnectionFactory</span> <span class="hljs-variable">connectionFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();<br>        <span class="hljs-comment">//主机地址;默认为 localhost</span><br>        connectionFactory.setHost(<span class="hljs-string">&quot;localhost&quot;</span>);<br>        <span class="hljs-comment">//连接端口;默认为 5672</span><br>        connectionFactory.setPort(<span class="hljs-number">5672</span>);<br>        <span class="hljs-comment">//虚拟主机名称;默认为 /</span><br>        connectionFactory.setVirtualHost(<span class="hljs-string">&quot;/&quot;</span>);<br>        <span class="hljs-comment">//连接用户名；默认为guest</span><br>        connectionFactory.setUsername(<span class="hljs-string">&quot;itlils&quot;</span>);<br>        <span class="hljs-comment">//连接密码；默认为guest</span><br>        connectionFactory.setPassword(<span class="hljs-string">&quot;itlils&quot;</span>);<br><br>        <span class="hljs-comment">//2创建连接</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> connectionFactory.newConnection();<br><br>        <span class="hljs-comment">//3创建频道</span><br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 声明交换机</span><br><span class="hljs-comment">         * 参数1：交换机名称</span><br><span class="hljs-comment">         * 参数2：交换机类型，fanout、topic、direct、headers</span><br><span class="hljs-comment">         * 参数3：是否定义持久化</span><br><span class="hljs-comment">         * 参数4：是否在不使用的时候自动删除</span><br><span class="hljs-comment">         */</span><br>        channel.exchangeDeclare(FANOUT_EXCHAGE, BuiltinExchangeType.FANOUT,<span class="hljs-literal">true</span>,<span class="hljs-literal">true</span>,<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">// 声明（创建）队列</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：是否定义持久化队列</span><br><span class="hljs-comment">         * 参数3：是否独占本次连接</span><br><span class="hljs-comment">         * 参数4：是否在不使用的时候自动删除队列</span><br><span class="hljs-comment">         * 参数5：队列其它参数</span><br><span class="hljs-comment">         */</span><br>        channel.queueDeclare(FANOUT_QUEUE_1, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br>        channel.queueDeclare(FANOUT_QUEUE_2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">//队列绑定交换机</span><br>        channel.queueBind(FANOUT_QUEUE_1, FANOUT_EXCHAGE, <span class="hljs-string">&quot;&quot;</span>);<br>        channel.queueBind(FANOUT_QUEUE_2, FANOUT_EXCHAGE, <span class="hljs-string">&quot;&quot;</span>);<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &amp;lt;= <span class="hljs-number">10</span>; i++) &#123;<br>            <span class="hljs-comment">// 发送信息</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;你好；小兔子！发布订阅模式--&quot;</span> + i;<br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * 参数1：交换机名称，如果没有指定则使用默认Default Exchage</span><br><span class="hljs-comment">             * 参数2：路由key,简单模式可以传递队列名称</span><br><span class="hljs-comment">             * 参数3：消息其它属性</span><br><span class="hljs-comment">             * 参数4：消息内容</span><br><span class="hljs-comment">             */</span><br>            channel.basicPublish(FANOUT_EXCHAGE, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-literal">null</span>, message.getBytes());<br>            System.out.println(<span class="hljs-string">&quot;已发送消息：&quot;</span> + message);<br>        &#125;<br><br>        <span class="hljs-comment">// 关闭资源</span><br>        channel.close();<br>        connection.close();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="b、消费者1" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#b、消费者1">#</a> b、消费者1</h5><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydlclass.rabbitmq.publish;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Created</span> by IT李老师</span><br><span class="hljs-comment"> * 公主号 “元动力课堂”</span><br><span class="hljs-comment"> * 个人微 itlils</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Consumer1</span> &#123;<br>    <span class="hljs-comment">//交换机名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FANOUT_EXCHAGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;fanout_exchange&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FANOUT_QUEUE_1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;fanout_queue_1&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FANOUT_QUEUE_2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;fanout_queue_2&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//1创建连接工厂</span><br>        ConnectionFactory connectionFactory=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();<br>        <span class="hljs-comment">//连接的ip</span><br>        connectionFactory.setHost(<span class="hljs-string">&quot;localhost&quot;</span>);<br>        <span class="hljs-comment">//连接的端口</span><br>        connectionFactory.setPort(<span class="hljs-number">5672</span>);<br>        <span class="hljs-comment">//设置虚拟主机</span><br>        connectionFactory.setVirtualHost(<span class="hljs-string">&quot;/&quot;</span>);<br>        <span class="hljs-comment">//设置用户名</span><br>        connectionFactory.setUsername(<span class="hljs-string">&quot;itlils&quot;</span>);<br>        <span class="hljs-comment">//设置密码</span><br>        connectionFactory.setPassword(<span class="hljs-string">&quot;itlils&quot;</span>);<br><br>        <span class="hljs-comment">//2创建长连接</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> connectionFactory.newConnection();<br>        <span class="hljs-comment">//3创建channel</span><br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br><br>        <span class="hljs-comment">//声明队列</span><br>        <span class="hljs-comment">//String queue,  队列名</span><br>        <span class="hljs-comment">// boolean durable, 持久化</span><br>        <span class="hljs-comment">// boolean exclusive, 排他的</span><br>        <span class="hljs-comment">// boolean autoDelete, 自动删除</span><br>        <span class="hljs-comment">// Map&amp;lt;String, Object&amp;gt; arguments 属性</span><br>        channel.queueDeclare(FANOUT_QUEUE_1,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br>        channel.queueDeclare(FANOUT_QUEUE_2,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">// 声明交换机</span><br>        <span class="hljs-comment">// String exchange,  交换机名称</span><br>        <span class="hljs-comment">// BuiltinExchangeType type, 交换机类型</span><br>        <span class="hljs-comment">// boolean durable,  持久化</span><br>        <span class="hljs-comment">// boolean autoDelete, 自动删除</span><br>        <span class="hljs-comment">// Map&amp;lt;String, Object&amp;gt; arguments 属性</span><br>        channel.exchangeDeclare(FANOUT_EXCHAGE, BuiltinExchangeType.FANOUT,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">//队列绑定交换机</span><br>        <span class="hljs-comment">// String queue, 队列名称</span><br>        <span class="hljs-comment">// String exchange, 交换机名称</span><br>        <span class="hljs-comment">// String routingKey 路由键</span><br>        channel.queueBind(FANOUT_QUEUE_1,FANOUT_EXCHAGE,<span class="hljs-string">&quot;&quot;</span>);<br>        channel.queueBind(FANOUT_QUEUE_2,FANOUT_EXCHAGE,<span class="hljs-string">&quot;&quot;</span>);<br><br><br>        <span class="hljs-comment">//4监听某个队列</span><br>        <span class="hljs-comment">// String queue, 监听的队列名</span><br>        <span class="hljs-comment">// boolean autoAck, 是否自动应答</span><br>        <span class="hljs-comment">// Consumer callback 回调函数，收到消息，我要干啥</span><br>        com.rabbitmq.client.Consumer consumer=<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConsumer</span>(channel)&#123;<br>            <span class="hljs-comment">// 回调函数，收到消息，我要干啥</span><br>            <span class="hljs-comment">//  String consumerTag, 消费者标签</span><br>            <span class="hljs-comment">// Envelope envelope, 信封 保存很多信息</span><br>            <span class="hljs-comment">// AMQP.BasicProperties properties, 属性</span><br>            <span class="hljs-comment">// byte[] body  消息字节数组</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-type">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                <span class="hljs-comment">//业务逻辑</span><br><br>                <span class="hljs-comment">//现在的业务逻辑就是打印</span><br><span class="hljs-comment">//                System.out.println(&quot;consumerTag:&quot;+consumerTag);</span><br><span class="hljs-comment">//                System.out.println(&quot;Exchange:&quot;+envelope.getExchange());</span><br><span class="hljs-comment">//                System.out.println(&quot;RoutingKey:&quot;+envelope.getRoutingKey());</span><br><span class="hljs-comment">//                System.out.println(&quot;DeliveryTag:&quot;+envelope.getDeliveryTag()); //消息id</span><br><br>                System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));<br>            &#125;<br>        &#125;;<br>        channel.basicConsume(FANOUT_QUEUE_1,<span class="hljs-literal">true</span>,consumer);<br><br>        <span class="hljs-comment">//5 千万别关闭连接，要不然queue有了消息 推不过来了</span><br><span class="hljs-comment">//        channel.close();</span><br><span class="hljs-comment">//        connection.close();</span><br><br><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="c、消费者2" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#c、消费者2">#</a> c、消费者2</h5><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydlclass.rabbitmq.publish;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Created</span> by IT李老师</span><br><span class="hljs-comment"> * 公主号 “元动力课堂”</span><br><span class="hljs-comment"> * 个人微 itlils</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Consumer2</span> &#123;<br>    <span class="hljs-comment">//交换机名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FANOUT_EXCHAGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;fanout_exchange&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FANOUT_QUEUE_1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;fanout_queue_1&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FANOUT_QUEUE_2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;fanout_queue_2&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//1创建连接工厂</span><br>        ConnectionFactory connectionFactory=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();<br>        <span class="hljs-comment">//连接的ip</span><br>        connectionFactory.setHost(<span class="hljs-string">&quot;localhost&quot;</span>);<br>        <span class="hljs-comment">//连接的端口</span><br>        connectionFactory.setPort(<span class="hljs-number">5672</span>);<br>        <span class="hljs-comment">//设置虚拟主机</span><br>        connectionFactory.setVirtualHost(<span class="hljs-string">&quot;/&quot;</span>);<br>        <span class="hljs-comment">//设置用户名</span><br>        connectionFactory.setUsername(<span class="hljs-string">&quot;itlils&quot;</span>);<br>        <span class="hljs-comment">//设置密码</span><br>        connectionFactory.setPassword(<span class="hljs-string">&quot;itlils&quot;</span>);<br><br>        <span class="hljs-comment">//2创建长连接</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> connectionFactory.newConnection();<br>        <span class="hljs-comment">//3创建channel</span><br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br><br>        <span class="hljs-comment">//声明队列</span><br>        <span class="hljs-comment">//String queue,  队列名</span><br>        <span class="hljs-comment">// boolean durable, 持久化</span><br>        <span class="hljs-comment">// boolean exclusive, 排他的</span><br>        <span class="hljs-comment">// boolean autoDelete, 自动删除</span><br>        <span class="hljs-comment">// Map&amp;lt;String, Object&amp;gt; arguments 属性</span><br>        channel.queueDeclare(FANOUT_QUEUE_1,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br>        channel.queueDeclare(FANOUT_QUEUE_2,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">// 声明交换机</span><br>        <span class="hljs-comment">// String exchange,  交换机名称</span><br>        <span class="hljs-comment">// BuiltinExchangeType type, 交换机类型</span><br>        <span class="hljs-comment">// boolean durable,  持久化</span><br>        <span class="hljs-comment">// boolean autoDelete, 自动删除</span><br>        <span class="hljs-comment">// Map&amp;lt;String, Object&amp;gt; arguments 属性</span><br>        channel.exchangeDeclare(FANOUT_EXCHAGE, BuiltinExchangeType.FANOUT,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">//队列绑定交换机</span><br>        <span class="hljs-comment">// String queue, 队列名称</span><br>        <span class="hljs-comment">// String exchange, 交换机名称</span><br>        <span class="hljs-comment">// String routingKey 路由键</span><br>        channel.queueBind(FANOUT_QUEUE_1,FANOUT_EXCHAGE,<span class="hljs-string">&quot;&quot;</span>);<br>        channel.queueBind(FANOUT_QUEUE_2,FANOUT_EXCHAGE,<span class="hljs-string">&quot;&quot;</span>);<br><br><br>        <span class="hljs-comment">//4监听某个队列</span><br>        <span class="hljs-comment">// String queue, 监听的队列名</span><br>        <span class="hljs-comment">// boolean autoAck, 是否自动应答</span><br>        <span class="hljs-comment">// Consumer callback 回调函数，收到消息，我要干啥</span><br>        Consumer consumer=<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConsumer</span>(channel)&#123;<br>            <span class="hljs-comment">// 回调函数，收到消息，我要干啥</span><br>            <span class="hljs-comment">//  String consumerTag, 消费者标签</span><br>            <span class="hljs-comment">// Envelope envelope, 信封 保存很多信息</span><br>            <span class="hljs-comment">// AMQP.BasicProperties properties, 属性</span><br>            <span class="hljs-comment">// byte[] body  消息字节数组</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-type">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                <span class="hljs-comment">//业务逻辑</span><br><br>                <span class="hljs-comment">//现在的业务逻辑就是打印</span><br><span class="hljs-comment">//                System.out.println(&quot;consumerTag:&quot;+consumerTag);</span><br><span class="hljs-comment">//                System.out.println(&quot;Exchange:&quot;+envelope.getExchange());</span><br><span class="hljs-comment">//                System.out.println(&quot;RoutingKey:&quot;+envelope.getRoutingKey());</span><br><span class="hljs-comment">//                System.out.println(&quot;DeliveryTag:&quot;+envelope.getDeliveryTag()); //消息id</span><br><br>                System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));<br>            &#125;<br>        &#125;;<br>        channel.basicConsume(FANOUT_QUEUE_2,<span class="hljs-literal">true</span>,consumer);<br><br>        <span class="hljs-comment">//5 千万别关闭连接，要不然queue有了消息 推不过来了</span><br><span class="hljs-comment">//        channel.close();</span><br><span class="hljs-comment">//        connection.close();</span><br><br><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-测试-1" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-测试-1">#</a> （3） 测试</h4><p>启动所有消费者，然后使用生产者发送消息；在每个消费者对应的控制台可以查看到生产者发送的所有消息；到达<strong>广播</strong>的效果。</p><p>在执行完测试代码后，其实到RabbitMQ的管理后台找到<code>Exchanges</code>选项卡，点击 <code>fanout_exchange</code> 的交换机，可以查看到如下的绑定：</p><figure><img class="lazy" alt="image-20220411212807072" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220411212807072-d93ba322.png" tabindex="0"/><figcaption>image-20220411212807072</figcaption></figure><p>测试发送一条消息：</p><p>两个消费者都接受到同样的消息</p><figure><img class="lazy" alt="image-20220411212727005" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220411212727005-4caee19c.png" tabindex="0"/><figcaption>image-20220411212727005</figcaption></figure><figure><img class="lazy" alt="image-20220411212734150" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220411212734150-3bcc1d8a.png" tabindex="0"/><figcaption>image-20220411212734150</figcaption></figure><h4 id="_4-小结" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-小结">#</a> （4）小结</h4><p>交换机需要与队列进行绑定，绑定之后；一个消息可以被多个消费者都收到。</p><p><strong>发布订阅模式与工作队列模式的区别</strong></p><p>1、工作队列模式不用定义交换机，而发布/订阅模式需要定义交换机。</p><p>2、发布/订阅模式的生产方是面向交换机发送消息，工作队列模式的生产方是面向队列发送消息(底层使用默认交换机)。</p><p>3、发布/订阅模式需要设置队列和交换机的绑定，工作队列模式不需要设置，实际上工作队列模式会将队列绑 定到默认的交换机 。</p><h3 id="_4、routing路由模式-分布式日志收集系统" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4、routing路由模式-分布式日志收集系统">#</a> 4、Routing路由模式（分布式日志收集系统）</h3><h4 id="_1-模式说明-2" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-模式说明-2">#</a> （1）模式说明</h4><p>路由模式特点：</p><ul><li>队列与交换机的绑定，不能是任意绑定了，而是要指定一个<code>RoutingKey</code>（路由key）</li><li>消息的发送方在 向 Exchange发送消息时，也必须指定消息的 <code>RoutingKey</code>。</li><li>Exchange不再把消息交给每一个绑定的队列，而是根据消息的<code>Routing Key</code>进行判断，只有队列的<code>Routingkey</code>与消息的 <code>Routing key</code>完全一致，才会接收到消息</li></ul><figure><img class="lazy" alt="1556029284397" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1556029284397-4b3125ba.png" tabindex="0"/><figcaption>1556029284397</figcaption></figure><p>图解：</p><ul><li>P：生产者，向Exchange发送消息，发送消息时，会指定一个routing key。</li><li>X：Exchange（交换机），接收生产者的消息，然后把消息递交给 与routing key完全匹配的队列</li><li>C1：消费者，其所在队列指定了需要routing key 为 error 的消息</li><li>C2：消费者，其所在队列指定了需要routing key 为 info、error、warning 的消息</li></ul><h4 id="_2-代码-2" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-代码-2">#</a> （2）代码</h4><p>在编码上与 <code>Publish/Subscribe发布与订阅模式</code> 的区别是交换机的类型为：Direct，还有队列绑定交换机的时候需要指定routing key。</p><h5 id="a、生产者-1" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#a、生产者-1">#</a> a、生产者</h5><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydlclass.rabbitmq.routing;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.ConnectionFactory;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Created</span> by IT李老师</span><br><span class="hljs-comment"> * 公主号 “元动力课堂”</span><br><span class="hljs-comment"> * 个人微 itlils</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Producer</span> &#123;<br><br>    <span class="hljs-comment">//交换机名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DIRECT_EXCHAGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;direct_exchange&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DIRECT_QUEUE_1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;direct_queue_1&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DIRECT_QUEUE_2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;direct_queue_2&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//1创建连接工厂</span><br>        ConnectionFactory connectionFactory=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();<br>        <span class="hljs-comment">//连接的ip</span><br>        connectionFactory.setHost(<span class="hljs-string">&quot;localhost&quot;</span>);<br>        <span class="hljs-comment">//连接的端口</span><br>        connectionFactory.setPort(<span class="hljs-number">5672</span>);<br>        <span class="hljs-comment">//设置虚拟主机</span><br>        connectionFactory.setVirtualHost(<span class="hljs-string">&quot;/&quot;</span>);<br>        <span class="hljs-comment">//设置用户名</span><br>        connectionFactory.setUsername(<span class="hljs-string">&quot;itlils&quot;</span>);<br>        <span class="hljs-comment">//设置密码</span><br>        connectionFactory.setPassword(<span class="hljs-string">&quot;itlils&quot;</span>);<br><br>        <span class="hljs-comment">//2创建长连接</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> connectionFactory.newConnection();<br>        <span class="hljs-comment">//3创建channel</span><br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br>        <span class="hljs-comment">//声明队列</span><br>        <span class="hljs-comment">//String queue,  队列名</span><br>        <span class="hljs-comment">// boolean durable, 持久化</span><br>        <span class="hljs-comment">// boolean exclusive, 排他的</span><br>        <span class="hljs-comment">// boolean autoDelete, 自动删除</span><br>        <span class="hljs-comment">// Map&amp;lt;String, Object&amp;gt; arguments 属性</span><br>        channel.queueDeclare(DIRECT_QUEUE_1,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br>        channel.queueDeclare(DIRECT_QUEUE_2,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">// 声明交换机</span><br>        <span class="hljs-comment">// String exchange,  交换机名称</span><br>        <span class="hljs-comment">// BuiltinExchangeType type, 交换机类型</span><br>        <span class="hljs-comment">// boolean durable,  持久化</span><br>        <span class="hljs-comment">// boolean autoDelete, 自动删除</span><br>        <span class="hljs-comment">// Map&amp;lt;String, Object&amp;gt; arguments 属性</span><br>        channel.exchangeDeclare(DIRECT_EXCHAGE, BuiltinExchangeType.DIRECT,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">//队列绑定交换机</span><br>        <span class="hljs-comment">// String queue, 队列名称</span><br>        <span class="hljs-comment">// String exchange, 交换机名称</span><br>        <span class="hljs-comment">// String routingKey 路由键</span><br>        channel.queueBind(DIRECT_QUEUE_1,DIRECT_EXCHAGE,<span class="hljs-string">&quot;error&quot;</span>);<br>        channel.queueBind(DIRECT_QUEUE_2,DIRECT_EXCHAGE,<span class="hljs-string">&quot;info&quot;</span>);<br>        channel.queueBind(DIRECT_QUEUE_2,DIRECT_EXCHAGE,<span class="hljs-string">&quot;error&quot;</span>);<br>        channel.queueBind(DIRECT_QUEUE_2,DIRECT_EXCHAGE,<span class="hljs-string">&quot;warning&quot;</span>);<br><br>        <span class="hljs-comment">//4发消息</span><br>        <span class="hljs-comment">// String exchange,  交换机</span><br>        <span class="hljs-comment">// String routingKey, 路由键</span><br>        <span class="hljs-comment">// AMQP.BasicProperties props, 属性</span><br>        <span class="hljs-comment">// byte[] body 消息      string byte[] char[]如何相互转换的？</span><br>        String msg=<span class="hljs-string">&quot;hello rabbitmq!routing error&quot;</span>;<br>        channel.basicPublish(DIRECT_EXCHAGE,<span class="hljs-string">&quot;error&quot;</span>,<span class="hljs-literal">null</span>,msg.getBytes());<br><br>        String msg1=<span class="hljs-string">&quot;hello rabbitmq!routing info&quot;</span>;<br>        channel.basicPublish(DIRECT_EXCHAGE,<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-literal">null</span>,msg1.getBytes());<br><br>        String msg2=<span class="hljs-string">&quot;hello rabbitmq!routing warning&quot;</span>;<br>        channel.basicPublish(DIRECT_EXCHAGE,<span class="hljs-string">&quot;warning&quot;</span>,<span class="hljs-literal">null</span>,msg2.getBytes());<br><br>        <span class="hljs-comment">//5关闭连接  资源关闭的顺序，先关后出来的资源，最后关，第一个资源</span><br>        channel.close();<br>        connection.close();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="b、消费者1-1" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#b、消费者1-1">#</a> b、消费者1</h5><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydlclass.rabbitmq.routing;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Created</span> by IT李老师</span><br><span class="hljs-comment"> * 公主号 “元动力课堂”</span><br><span class="hljs-comment"> * 个人微 itlils</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Consumer1</span> &#123;<br>    <span class="hljs-comment">//交换机名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DIRECT_EXCHAGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;direct_exchange&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DIRECT_QUEUE_1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;direct_queue_1&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DIRECT_QUEUE_2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;direct_queue_2&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//1创建连接工厂</span><br>        ConnectionFactory connectionFactory=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();<br>        <span class="hljs-comment">//连接的ip</span><br>        connectionFactory.setHost(<span class="hljs-string">&quot;localhost&quot;</span>);<br>        <span class="hljs-comment">//连接的端口</span><br>        connectionFactory.setPort(<span class="hljs-number">5672</span>);<br>        <span class="hljs-comment">//设置虚拟主机</span><br>        connectionFactory.setVirtualHost(<span class="hljs-string">&quot;/&quot;</span>);<br>        <span class="hljs-comment">//设置用户名</span><br>        connectionFactory.setUsername(<span class="hljs-string">&quot;itlils&quot;</span>);<br>        <span class="hljs-comment">//设置密码</span><br>        connectionFactory.setPassword(<span class="hljs-string">&quot;itlils&quot;</span>);<br><br>        <span class="hljs-comment">//2创建长连接</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> connectionFactory.newConnection();<br>        <span class="hljs-comment">//3创建channel</span><br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br><br>        <span class="hljs-comment">//声明队列</span><br>        <span class="hljs-comment">//String queue,  队列名</span><br>        <span class="hljs-comment">// boolean durable, 持久化</span><br>        <span class="hljs-comment">// boolean exclusive, 排他的</span><br>        <span class="hljs-comment">// boolean autoDelete, 自动删除</span><br>        <span class="hljs-comment">// Map&amp;lt;String, Object&amp;gt; arguments 属性</span><br>        channel.queueDeclare(DIRECT_QUEUE_1,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br>        channel.queueDeclare(DIRECT_QUEUE_2,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">// 声明交换机</span><br>        <span class="hljs-comment">// String exchange,  交换机名称</span><br>        <span class="hljs-comment">// BuiltinExchangeType type, 交换机类型</span><br>        <span class="hljs-comment">// boolean durable,  持久化</span><br>        <span class="hljs-comment">// boolean autoDelete, 自动删除</span><br>        <span class="hljs-comment">// Map&amp;lt;String, Object&amp;gt; arguments 属性</span><br>        channel.exchangeDeclare(DIRECT_EXCHAGE, BuiltinExchangeType.DIRECT,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">//队列绑定交换机</span><br>        <span class="hljs-comment">// String queue, 队列名称</span><br>        <span class="hljs-comment">// String exchange, 交换机名称</span><br>        <span class="hljs-comment">// String routingKey 路由键</span><br>        channel.queueBind(DIRECT_QUEUE_1,DIRECT_EXCHAGE,<span class="hljs-string">&quot;error&quot;</span>);<br>        channel.queueBind(DIRECT_QUEUE_2,DIRECT_EXCHAGE,<span class="hljs-string">&quot;info&quot;</span>);<br>        channel.queueBind(DIRECT_QUEUE_2,DIRECT_EXCHAGE,<span class="hljs-string">&quot;error&quot;</span>);<br>        channel.queueBind(DIRECT_QUEUE_2,DIRECT_EXCHAGE,<span class="hljs-string">&quot;warning&quot;</span>);<br><br><br>        <span class="hljs-comment">//4监听某个队列</span><br>        <span class="hljs-comment">// String queue, 监听的队列名</span><br>        <span class="hljs-comment">// boolean autoAck, 是否自动应答</span><br>        <span class="hljs-comment">// Consumer callback 回调函数，收到消息，我要干啥</span><br>        com.rabbitmq.client.Consumer consumer=<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConsumer</span>(channel)&#123;<br>            <span class="hljs-comment">// 回调函数，收到消息，我要干啥</span><br>            <span class="hljs-comment">//  String consumerTag, 消费者标签</span><br>            <span class="hljs-comment">// Envelope envelope, 信封 保存很多信息</span><br>            <span class="hljs-comment">// AMQP.BasicProperties properties, 属性</span><br>            <span class="hljs-comment">// byte[] body  消息字节数组</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-type">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                <span class="hljs-comment">//业务逻辑</span><br><br>                <span class="hljs-comment">//现在的业务逻辑就是打印</span><br><span class="hljs-comment">//                System.out.println(&quot;consumerTag:&quot;+consumerTag);</span><br><span class="hljs-comment">//                System.out.println(&quot;Exchange:&quot;+envelope.getExchange());</span><br><span class="hljs-comment">//                System.out.println(&quot;RoutingKey:&quot;+envelope.getRoutingKey());</span><br><span class="hljs-comment">//                System.out.println(&quot;DeliveryTag:&quot;+envelope.getDeliveryTag()); //消息id</span><br><br>                System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));<br>            &#125;<br>        &#125;;<br>        channel.basicConsume(DIRECT_QUEUE_1,<span class="hljs-literal">true</span>,consumer);<br><br>        <span class="hljs-comment">//5 千万别关闭连接，要不然queue有了消息 推不过来了</span><br><span class="hljs-comment">//        channel.close();</span><br><span class="hljs-comment">//        connection.close();</span><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="c、消费者2-1" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#c、消费者2-1">#</a> c、消费者2</h5><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydlclass.rabbitmq.routing;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Created</span> by IT李老师</span><br><span class="hljs-comment"> * 公主号 “元动力课堂”</span><br><span class="hljs-comment"> * 个人微 itlils</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Consumer2</span> &#123;<br>    <span class="hljs-comment">//交换机名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DIRECT_EXCHAGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;direct_exchange&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DIRECT_QUEUE_1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;direct_queue_1&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DIRECT_QUEUE_2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;direct_queue_2&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//1创建连接工厂</span><br>        ConnectionFactory connectionFactory=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();<br>        <span class="hljs-comment">//连接的ip</span><br>        connectionFactory.setHost(<span class="hljs-string">&quot;localhost&quot;</span>);<br>        <span class="hljs-comment">//连接的端口</span><br>        connectionFactory.setPort(<span class="hljs-number">5672</span>);<br>        <span class="hljs-comment">//设置虚拟主机</span><br>        connectionFactory.setVirtualHost(<span class="hljs-string">&quot;/&quot;</span>);<br>        <span class="hljs-comment">//设置用户名</span><br>        connectionFactory.setUsername(<span class="hljs-string">&quot;itlils&quot;</span>);<br>        <span class="hljs-comment">//设置密码</span><br>        connectionFactory.setPassword(<span class="hljs-string">&quot;itlils&quot;</span>);<br><br>        <span class="hljs-comment">//2创建长连接</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> connectionFactory.newConnection();<br>        <span class="hljs-comment">//3创建channel</span><br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br><br>        <span class="hljs-comment">//声明队列</span><br>        <span class="hljs-comment">//String queue,  队列名</span><br>        <span class="hljs-comment">// boolean durable, 持久化</span><br>        <span class="hljs-comment">// boolean exclusive, 排他的</span><br>        <span class="hljs-comment">// boolean autoDelete, 自动删除</span><br>        <span class="hljs-comment">// Map&amp;lt;String, Object&amp;gt; arguments 属性</span><br>        channel.queueDeclare(DIRECT_QUEUE_1,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br>        channel.queueDeclare(DIRECT_QUEUE_2,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">// 声明交换机</span><br>        <span class="hljs-comment">// String exchange,  交换机名称</span><br>        <span class="hljs-comment">// BuiltinExchangeType type, 交换机类型</span><br>        <span class="hljs-comment">// boolean durable,  持久化</span><br>        <span class="hljs-comment">// boolean autoDelete, 自动删除</span><br>        <span class="hljs-comment">// Map&amp;lt;String, Object&amp;gt; arguments 属性</span><br>        channel.exchangeDeclare(DIRECT_EXCHAGE, BuiltinExchangeType.DIRECT,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">//队列绑定交换机</span><br>        <span class="hljs-comment">// String queue, 队列名称</span><br>        <span class="hljs-comment">// String exchange, 交换机名称</span><br>        <span class="hljs-comment">// String routingKey 路由键</span><br>        channel.queueBind(DIRECT_QUEUE_1,DIRECT_EXCHAGE,<span class="hljs-string">&quot;error&quot;</span>);<br>        channel.queueBind(DIRECT_QUEUE_2,DIRECT_EXCHAGE,<span class="hljs-string">&quot;info&quot;</span>);<br>        channel.queueBind(DIRECT_QUEUE_2,DIRECT_EXCHAGE,<span class="hljs-string">&quot;error&quot;</span>);<br>        channel.queueBind(DIRECT_QUEUE_2,DIRECT_EXCHAGE,<span class="hljs-string">&quot;warning&quot;</span>);<br><br><br>        <span class="hljs-comment">//4监听某个队列</span><br>        <span class="hljs-comment">// String queue, 监听的队列名</span><br>        <span class="hljs-comment">// boolean autoAck, 是否自动应答</span><br>        <span class="hljs-comment">// Consumer callback 回调函数，收到消息，我要干啥</span><br>        Consumer consumer=<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConsumer</span>(channel)&#123;<br>            <span class="hljs-comment">// 回调函数，收到消息，我要干啥</span><br>            <span class="hljs-comment">//  String consumerTag, 消费者标签</span><br>            <span class="hljs-comment">// Envelope envelope, 信封 保存很多信息</span><br>            <span class="hljs-comment">// AMQP.BasicProperties properties, 属性</span><br>            <span class="hljs-comment">// byte[] body  消息字节数组</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-type">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                <span class="hljs-comment">//业务逻辑</span><br><br>                <span class="hljs-comment">//现在的业务逻辑就是打印</span><br><span class="hljs-comment">//                System.out.println(&quot;consumerTag:&quot;+consumerTag);</span><br><span class="hljs-comment">//                System.out.println(&quot;Exchange:&quot;+envelope.getExchange());</span><br><span class="hljs-comment">//                System.out.println(&quot;RoutingKey:&quot;+envelope.getRoutingKey());</span><br><span class="hljs-comment">//                System.out.println(&quot;DeliveryTag:&quot;+envelope.getDeliveryTag()); //消息id</span><br><br>                System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));<br>            &#125;<br>        &#125;;<br>        channel.basicConsume(DIRECT_QUEUE_2,<span class="hljs-literal">true</span>,consumer);<br><br>        <span class="hljs-comment">//5 千万别关闭连接，要不然queue有了消息 推不过来了</span><br><span class="hljs-comment">//        channel.close();</span><br><span class="hljs-comment">//        connection.close();</span><br><br><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-测试-2" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-测试-2">#</a> （3）测试</h4><p>启动所有消费者，然后使用生产者发送消息；在消费者对应的控制台可以查看到生产者发送对应routing key对应队列的消息；到达<strong>按照需要接收</strong>的效果。</p><p>在执行完测试代码后，其实到RabbitMQ的管理后台找到<code>Exchanges</code>选项卡，点击 <code>direct_exchange</code> 的交换机，可以查看到如下的绑定：</p><figure><img class="lazy" alt="image-20220411214231000" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220411214231000-1e1170ad.png" tabindex="0"/><figcaption>image-20220411214231000</figcaption></figure><p>测试：</p><p>第一个消费者受到一条消息</p><figure><img class="lazy" alt="image-20220411214259476" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220411214259476-edf4f109.png" tabindex="0"/><figcaption>image-20220411214259476</figcaption></figure><p>第二个消费者受到三条消息</p><figure><img class="lazy" alt="image-20220411214316485" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220411214316485-00473d19.png" tabindex="0"/><figcaption>image-20220411214316485</figcaption></figure><h4 id="_4-小结-1" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-小结-1">#</a> （4）小结</h4><p>Routing模式要求队列在绑定交换机时要指定routing key，消息会转发到符合routing key的队列。</p><h3 id="_5、-topics通配符模式" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_5、-topics通配符模式">#</a> 5、 Topics通配符模式</h3><h4 id="_1-模式说明-3" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-模式说明-3">#</a> （1） 模式说明</h4><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">ydlclass.taiyuan.caiwubu.info &quot;本月工资大家涨两千！&quot;<br>ydlclass.taiyuan.renshi.error &quot;李老师携款潜逃！&quot;<br>ydlclass.beijing.caiwubu.error &quot;因为李老师逃了，全国所有校区降薪两千。不行就毕业！&quot;<br>ydlclass.lasa.caiwubu.info &quot;lasa校区成立了！&quot;<br>ydlclass.taiyuan.shitangbu.info &quot;太原校区学生吃饭免费！&quot;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Topic</code>类型与<code>Direct</code>相比，都是可以根据<code>RoutingKey</code>把消息路由到不同的队列。只不过<code>Topic</code>类型<code>Exchange</code>可以让队列在绑定<code>Routing key</code> 的时候<strong>使用通配符</strong>！</p><p><code>Routingkey</code> 一般都是有一个或多个单词组成，多个单词之间以”.”分割，例如： <code>item.insert</code></p><p>通配符规则：</p><p><code>#</code>：匹配一个或多个词</p><p><code>*</code>：匹配不多不少恰好1个词</p><p>举例：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">我是太原校区校长 ydlclass.taiyuan.*.*<br>itlils 我是总部财务主管 ydlclass.*.caiwubu.*<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img class="lazy" alt="1556031362048" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1556031362048-af6b62f6.png" tabindex="0"/><figcaption>1556031362048</figcaption></figure><figure><img class="lazy" alt="1556031519931" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1556031519931-5f4865a5.png" tabindex="0"/><figcaption>1556031519931</figcaption></figure><p>图解：</p><ul><li>红色Queue：绑定的是<code>usa.#</code> ，因此凡是以 <code>usa.</code>开头的<code>routing key</code> 都会被匹配到</li><li>黄色Queue：绑定的是<code>#.news</code> ，因此凡是以 <code>.news</code>结尾的 <code>routing key</code> 都会被匹配</li></ul><h4 id="_2-代码-3" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-代码-3">#</a> （2） 代码</h4><h5 id="a、生产者-2" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#a、生产者-2">#</a> a、生产者</h5><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydlclass.rabbitmq.topic;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.ConnectionFactory;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Created</span> by IT李老师</span><br><span class="hljs-comment"> * 公主号 “元动力课堂”</span><br><span class="hljs-comment"> * 个人微 itlils</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Producer</span> &#123;<br><br>    <span class="hljs-comment">//交换机名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC_EXCHAGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;topic_exchange&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC_QUEUE_1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;topic_queue_1&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC_QUEUE_2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;topic_queue_2&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//1创建连接工厂</span><br>        ConnectionFactory connectionFactory=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();<br>        <span class="hljs-comment">//连接的ip</span><br>        connectionFactory.setHost(<span class="hljs-string">&quot;localhost&quot;</span>);<br>        <span class="hljs-comment">//连接的端口</span><br>        connectionFactory.setPort(<span class="hljs-number">5672</span>);<br>        <span class="hljs-comment">//设置虚拟主机</span><br>        connectionFactory.setVirtualHost(<span class="hljs-string">&quot;/&quot;</span>);<br>        <span class="hljs-comment">//设置用户名</span><br>        connectionFactory.setUsername(<span class="hljs-string">&quot;itlils&quot;</span>);<br>        <span class="hljs-comment">//设置密码</span><br>        connectionFactory.setPassword(<span class="hljs-string">&quot;itlils&quot;</span>);<br><br>        <span class="hljs-comment">//2创建长连接</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> connectionFactory.newConnection();<br>        <span class="hljs-comment">//3创建channel</span><br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br>        <span class="hljs-comment">//声明队列</span><br>        <span class="hljs-comment">//String queue,  队列名</span><br>        <span class="hljs-comment">// boolean durable, 持久化</span><br>        <span class="hljs-comment">// boolean exclusive, 排他的</span><br>        <span class="hljs-comment">// boolean autoDelete, 自动删除</span><br>        <span class="hljs-comment">// Map&amp;lt;String, Object&amp;gt; arguments 属性</span><br>        channel.queueDeclare(TOPIC_QUEUE_1,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br>        channel.queueDeclare(TOPIC_QUEUE_2,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">// 声明交换机</span><br>        <span class="hljs-comment">// String exchange,  交换机名称</span><br>        <span class="hljs-comment">// BuiltinExchangeType type, 交换机类型</span><br>        <span class="hljs-comment">// boolean durable,  持久化</span><br>        <span class="hljs-comment">// boolean autoDelete, 自动删除</span><br>        <span class="hljs-comment">// Map&amp;lt;String, Object&amp;gt; arguments 属性</span><br>        channel.exchangeDeclare(TOPIC_EXCHAGE, BuiltinExchangeType.TOPIC,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">//队列绑定交换机</span><br>        <span class="hljs-comment">// String queue, 队列名称</span><br>        <span class="hljs-comment">// String exchange, 交换机名称</span><br>        <span class="hljs-comment">// String routingKey 路由键</span><br>        channel.queueBind(TOPIC_QUEUE_1,TOPIC_EXCHAGE,<span class="hljs-string">&quot;ydlclass.taiyuan.*.*&quot;</span>); <span class="hljs-comment">//我是太原校区校长的队列</span><br>        channel.queueBind(TOPIC_QUEUE_2,TOPIC_EXCHAGE,<span class="hljs-string">&quot;ydlclass.*.caiwubu.*&quot;</span>);<span class="hljs-comment">//我是总部财务主管的队列</span><br><br>        <span class="hljs-comment">//4发消息</span><br>        <span class="hljs-comment">// String exchange,  交换机</span><br>        <span class="hljs-comment">// String routingKey, 路由键</span><br>        <span class="hljs-comment">// AMQP.BasicProperties props, 属性</span><br>        <span class="hljs-comment">// byte[] body 消息      string byte[] char[]如何相互转换的？</span><br>        String msg1=<span class="hljs-string">&quot;hello rabbitmq!topic  本月工资大家涨两千！&quot;</span>;<br>        channel.basicPublish(TOPIC_EXCHAGE,<span class="hljs-string">&quot;ydlclass.taiyuan.caiwubu.info&quot;</span>,<span class="hljs-literal">null</span>,msg1.getBytes());<br><br>        String msg2=<span class="hljs-string">&quot;hello rabbitmq!topic 李老师携款潜逃！&quot;</span>;<br>        channel.basicPublish(TOPIC_EXCHAGE,<span class="hljs-string">&quot;ydlclass.taiyuan.renshi.error&quot;</span>,<span class="hljs-literal">null</span>,msg2.getBytes());<br><br>        String msg3=<span class="hljs-string">&quot;hello rabbitmq!topic  因为李老师逃了，全国所有校区降薪两千。不行就毕业！&quot;</span>;<br>        channel.basicPublish(TOPIC_EXCHAGE,<span class="hljs-string">&quot;ydlclass.beijing.caiwubu.error&quot;</span>,<span class="hljs-literal">null</span>,msg3.getBytes());<br><br>        <span class="hljs-comment">//5关闭连接  资源关闭的顺序，先关后出来的资源，最后关，第一个资源</span><br>        channel.close();<br>        connection.close();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="b、消费者1-2" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#b、消费者1-2">#</a> b、消费者1</h5><p>接收两种类型的消息：更新商品和删除商品</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydlclass.rabbitmq.topic;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Created</span> by IT李老师</span><br><span class="hljs-comment"> * 公主号 “元动力课堂”</span><br><span class="hljs-comment"> * 个人微 itlils</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Consumer1</span> &#123;<br>    <span class="hljs-comment">//交换机名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC_EXCHAGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;topic_exchange&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC_QUEUE_1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;topic_queue_1&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC_QUEUE_2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;topic_queue_2&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//1创建连接工厂</span><br>        ConnectionFactory connectionFactory=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();<br>        <span class="hljs-comment">//连接的ip</span><br>        connectionFactory.setHost(<span class="hljs-string">&quot;localhost&quot;</span>);<br>        <span class="hljs-comment">//连接的端口</span><br>        connectionFactory.setPort(<span class="hljs-number">5672</span>);<br>        <span class="hljs-comment">//设置虚拟主机</span><br>        connectionFactory.setVirtualHost(<span class="hljs-string">&quot;/&quot;</span>);<br>        <span class="hljs-comment">//设置用户名</span><br>        connectionFactory.setUsername(<span class="hljs-string">&quot;itlils&quot;</span>);<br>        <span class="hljs-comment">//设置密码</span><br>        connectionFactory.setPassword(<span class="hljs-string">&quot;itlils&quot;</span>);<br><br>        <span class="hljs-comment">//2创建长连接</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> connectionFactory.newConnection();<br>        <span class="hljs-comment">//3创建channel</span><br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br><br>        <span class="hljs-comment">//声明队列</span><br>        <span class="hljs-comment">//String queue,  队列名</span><br>        <span class="hljs-comment">// boolean durable, 持久化</span><br>        <span class="hljs-comment">// boolean exclusive, 排他的</span><br>        <span class="hljs-comment">// boolean autoDelete, 自动删除</span><br>        <span class="hljs-comment">// Map&amp;lt;String, Object&amp;gt; arguments 属性</span><br>        channel.queueDeclare(TOPIC_QUEUE_1,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br>        channel.queueDeclare(TOPIC_QUEUE_2,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">// 声明交换机</span><br>        <span class="hljs-comment">// String exchange,  交换机名称</span><br>        <span class="hljs-comment">// BuiltinExchangeType type, 交换机类型</span><br>        <span class="hljs-comment">// boolean durable,  持久化</span><br>        <span class="hljs-comment">// boolean autoDelete, 自动删除</span><br>        <span class="hljs-comment">// Map&amp;lt;String, Object&amp;gt; arguments 属性</span><br>        channel.exchangeDeclare(TOPIC_EXCHAGE, BuiltinExchangeType.TOPIC,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">//队列绑定交换机</span><br>        <span class="hljs-comment">// String queue, 队列名称</span><br>        <span class="hljs-comment">// String exchange, 交换机名称</span><br>        <span class="hljs-comment">// String routingKey 路由键</span><br>        channel.queueBind(TOPIC_QUEUE_1,TOPIC_EXCHAGE,<span class="hljs-string">&quot;ydlclass.taiyuan.*.*&quot;</span>); <span class="hljs-comment">//我是太原校区校长的队列</span><br>        channel.queueBind(TOPIC_QUEUE_2,TOPIC_EXCHAGE,<span class="hljs-string">&quot;ydlclass.*.caiwubu.*&quot;</span>);<span class="hljs-comment">//我是总部财务主管的队列</span><br><br><br>        <span class="hljs-comment">//4监听某个队列</span><br>        <span class="hljs-comment">// String queue, 监听的队列名</span><br>        <span class="hljs-comment">// boolean autoAck, 是否自动应答</span><br>        <span class="hljs-comment">// Consumer callback 回调函数，收到消息，我要干啥</span><br>        Consumer consumer=<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConsumer</span>(channel)&#123;<br>            <span class="hljs-comment">// 回调函数，收到消息，我要干啥</span><br>            <span class="hljs-comment">//  String consumerTag, 消费者标签</span><br>            <span class="hljs-comment">// Envelope envelope, 信封 保存很多信息</span><br>            <span class="hljs-comment">// AMQP.BasicProperties properties, 属性</span><br>            <span class="hljs-comment">// byte[] body  消息字节数组</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-type">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                <span class="hljs-comment">//业务逻辑</span><br><br>                <span class="hljs-comment">//现在的业务逻辑就是打印</span><br><span class="hljs-comment">//                System.out.println(&quot;consumerTag:&quot;+consumerTag);</span><br><span class="hljs-comment">//                System.out.println(&quot;Exchange:&quot;+envelope.getExchange());</span><br><span class="hljs-comment">//                System.out.println(&quot;RoutingKey:&quot;+envelope.getRoutingKey());</span><br><span class="hljs-comment">//                System.out.println(&quot;DeliveryTag:&quot;+envelope.getDeliveryTag()); //消息id</span><br><br>                System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));<br>            &#125;<br>        &#125;;<br>        channel.basicConsume(TOPIC_QUEUE_1,<span class="hljs-literal">true</span>,consumer);<br><br>        <span class="hljs-comment">//5 千万别关闭连接，要不然queue有了消息 推不过来了</span><br><span class="hljs-comment">//        channel.close();</span><br><span class="hljs-comment">//        connection.close();</span><br><br><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="c、消费者2-2" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#c、消费者2-2">#</a> c、消费者2</h5><p>接收所有类型的消息：新增商品，更新商品和删除商品。</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydlclass.rabbitmq.topic;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Created</span> by IT李老师</span><br><span class="hljs-comment"> * 公主号 “元动力课堂”</span><br><span class="hljs-comment"> * 个人微 itlils</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Consumer2</span> &#123;<br>    <span class="hljs-comment">//交换机名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC_EXCHAGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;topic_exchange&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC_QUEUE_1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;topic_queue_1&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC_QUEUE_2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;topic_queue_2&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//1创建连接工厂</span><br>        ConnectionFactory connectionFactory=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();<br>        <span class="hljs-comment">//连接的ip</span><br>        connectionFactory.setHost(<span class="hljs-string">&quot;localhost&quot;</span>);<br>        <span class="hljs-comment">//连接的端口</span><br>        connectionFactory.setPort(<span class="hljs-number">5672</span>);<br>        <span class="hljs-comment">//设置虚拟主机</span><br>        connectionFactory.setVirtualHost(<span class="hljs-string">&quot;/&quot;</span>);<br>        <span class="hljs-comment">//设置用户名</span><br>        connectionFactory.setUsername(<span class="hljs-string">&quot;itlils&quot;</span>);<br>        <span class="hljs-comment">//设置密码</span><br>        connectionFactory.setPassword(<span class="hljs-string">&quot;itlils&quot;</span>);<br><br>        <span class="hljs-comment">//2创建长连接</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> connectionFactory.newConnection();<br>        <span class="hljs-comment">//3创建channel</span><br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br><br>        <span class="hljs-comment">//声明队列</span><br>        <span class="hljs-comment">//String queue,  队列名</span><br>        <span class="hljs-comment">// boolean durable, 持久化</span><br>        <span class="hljs-comment">// boolean exclusive, 排他的</span><br>        <span class="hljs-comment">// boolean autoDelete, 自动删除</span><br>        <span class="hljs-comment">// Map&amp;lt;String, Object&amp;gt; arguments 属性</span><br>        channel.queueDeclare(TOPIC_QUEUE_1,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br>        channel.queueDeclare(TOPIC_QUEUE_2,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">// 声明交换机</span><br>        <span class="hljs-comment">// String exchange,  交换机名称</span><br>        <span class="hljs-comment">// BuiltinExchangeType type, 交换机类型</span><br>        <span class="hljs-comment">// boolean durable,  持久化</span><br>        <span class="hljs-comment">// boolean autoDelete, 自动删除</span><br>        <span class="hljs-comment">// Map&amp;lt;String, Object&amp;gt; arguments 属性</span><br>        channel.exchangeDeclare(TOPIC_EXCHAGE, BuiltinExchangeType.TOPIC,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">//队列绑定交换机</span><br>        <span class="hljs-comment">// String queue, 队列名称</span><br>        <span class="hljs-comment">// String exchange, 交换机名称</span><br>        <span class="hljs-comment">// String routingKey 路由键</span><br>        channel.queueBind(TOPIC_QUEUE_1,TOPIC_EXCHAGE,<span class="hljs-string">&quot;ydlclass.taiyuan.*.*&quot;</span>); <span class="hljs-comment">//我是太原校区校长的队列</span><br>        channel.queueBind(TOPIC_QUEUE_2,TOPIC_EXCHAGE,<span class="hljs-string">&quot;ydlclass.*.caiwubu.*&quot;</span>);<span class="hljs-comment">//我是总部财务主管的队列</span><br><br><br>        <span class="hljs-comment">//4监听某个队列</span><br>        <span class="hljs-comment">// String queue, 监听的队列名</span><br>        <span class="hljs-comment">// boolean autoAck, 是否自动应答</span><br>        <span class="hljs-comment">// Consumer callback 回调函数，收到消息，我要干啥</span><br>        Consumer consumer=<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConsumer</span>(channel)&#123;<br>            <span class="hljs-comment">// 回调函数，收到消息，我要干啥</span><br>            <span class="hljs-comment">//  String consumerTag, 消费者标签</span><br>            <span class="hljs-comment">// Envelope envelope, 信封 保存很多信息</span><br>            <span class="hljs-comment">// AMQP.BasicProperties properties, 属性</span><br>            <span class="hljs-comment">// byte[] body  消息字节数组</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-type">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                <span class="hljs-comment">//业务逻辑</span><br><br>                <span class="hljs-comment">//现在的业务逻辑就是打印</span><br><span class="hljs-comment">//                System.out.println(&quot;consumerTag:&quot;+consumerTag);</span><br><span class="hljs-comment">//                System.out.println(&quot;Exchange:&quot;+envelope.getExchange());</span><br><span class="hljs-comment">//                System.out.println(&quot;RoutingKey:&quot;+envelope.getRoutingKey());</span><br><span class="hljs-comment">//                System.out.println(&quot;DeliveryTag:&quot;+envelope.getDeliveryTag()); //消息id</span><br><br>                System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));<br>            &#125;<br>        &#125;;<br>        channel.basicConsume(TOPIC_QUEUE_2,<span class="hljs-literal">true</span>,consumer);<br><br>        <span class="hljs-comment">//5 千万别关闭连接，要不然queue有了消息 推不过来了</span><br><span class="hljs-comment">//        channel.close();</span><br><span class="hljs-comment">//        connection.close();</span><br><br><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-测试-3" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-测试-3">#</a> （3）测试</h4><p>启动所有消费者，然后使用生产者发送消息；在消费者对应的控制台可以查看到生产者发送对应routing key对应队列的消息；到达<strong>按照需要接收</strong>的效果；并且这些routing key可以使用通配符。</p><p>在执行完测试代码后，其实到RabbitMQ的管理后台找到<code>Exchanges</code>选项卡，点击 <code>topic_exchange</code> 的交换机，可以查看到如下的绑定：</p><figure><img class="lazy" alt="image-20220411220413658" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220411220413658-af621fe7.png" tabindex="0"/><figcaption>image-20220411220413658</figcaption></figure><p>测试：</p><p>消费者1 接受2条消息</p><figure><img class="lazy" alt="image-20220411220433328" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220411220433328-8c0bb510.png" tabindex="0"/><figcaption>image-20220411220433328</figcaption></figure><p>消费者2 接受2条消息</p><figure><img class="lazy" alt="image-20220411220453524" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220411220453524-41faca02.png" tabindex="0"/><figcaption>image-20220411220453524</figcaption></figure><h4 id="_4-小结-2" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-小结-2">#</a> （4）小结</h4><p>Topic主题模式可以实现 <code>Publish/Subscribe发布与订阅模式</code> 和 <code> Routing路由模式</code> 的功能；只是Topic在配置routing key 的时候可以使用通配符，显得更加灵活。</p><h3 id="_6、-模式总结" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_6、-模式总结">#</a> 6、 模式总结</h3><p>RabbitMQ工作模式：</p><h4 id="_1-简单模式-helloworld" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-简单模式-helloworld">#</a> <strong>（1）简单模式 HelloWorld</strong></h4><p>一个生产者、一个消费者，不需要设置交换机（使用默认的交换机）。</p><h4 id="_2-工作队列模式-work-queue" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-工作队列模式-work-queue">#</a> <strong>（2）工作队列模式 Work Queue</strong></h4><p>一个生产者、多个消费者（竞争关系），不需要设置交换机（使用默认的交换机）。</p><h4 id="_3-发布订阅模式-publish-subscribe" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-发布订阅模式-publish-subscribe">#</a> <strong>（3）发布订阅模式 Publish/subscribe</strong></h4><p>需要设置类型为fanout的交换机，并且交换机和队列进行绑定，当发送消息到交换机后，交换机会将消息发送到绑定的队列。</p><h4 id="_4-路由模式-routing" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-路由模式-routing">#</a> <strong>（4）路由模式 Routing</strong></h4><p>需要设置类型为direct的交换机，交换机和队列进行绑定，并且指定routing key，当发送消息到交换机后，交换机会根据routing key将消息发送到对应的队列。</p><h4 id="_5-通配符模式-topic" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_5-通配符模式-topic">#</a> <strong>（5）通配符模式 Topic</strong></h4><p>需要设置类型为topic的交换机，交换机和队列进行绑定，并且指定通配符方式的routing key，当发送消息到交换机后，交换机会根据routing key将消息发送到对应的队列。</p><h2 id="第六章-spring-整合rabbitmq-了解" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第六章-spring-整合rabbitmq-了解">#</a> 第六章 Spring 整合RabbitMQ-了解</h2><h3 id="_1、搭建生产者工程" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、搭建生产者工程">#</a> 1、搭建生产者工程</h3><h4 id="_1-创建工程-1" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-创建工程-1">#</a> （1）创建工程</h4><p>spring-rabbitmq-producer</p><figure><img class="lazy" alt="image-20200320222056543" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20200320222056543-22a9b177.png" tabindex="0"/><figcaption>image-20200320222056543</figcaption></figure><h4 id="_2-添加依赖-1" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-添加依赖-1">#</a> （2）添加依赖</h4><p>修改pom.xml文件内容为如下：</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;<br>         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;<br>         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>modelVersion<span class="hljs-symbol">&amp;gt;</span>4.0.0<span class="hljs-symbol">&amp;lt;</span>/modelVersion<span class="hljs-symbol">&amp;gt;</span><br><br>    <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.ydlclass<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-rabbitmq-producer<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>1.0-SNAPSHOT<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br><br>    <span class="hljs-symbol">&amp;lt;</span>dependencies<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-context<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>5.1.7.RELEASE<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br><br>        <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework.amqp<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-rabbit<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>2.1.8.RELEASE<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br><br>        <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>junit<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>junit<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>4.12<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br><br>        <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-test<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>5.1.7.RELEASE<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependencies<span class="hljs-symbol">&amp;gt;</span><br><br>        <span class="hljs-symbol">&amp;lt;</span>build<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>plugins<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>plugin<span class="hljs-symbol">&amp;gt;</span><br>                <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.apache.maven.plugins<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>                <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>maven-compiler-plugin<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>                <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>3.8.0<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>                <span class="hljs-symbol">&amp;lt;</span>configuration<span class="hljs-symbol">&amp;gt;</span><br>                    <span class="hljs-symbol">&amp;lt;</span>source<span class="hljs-symbol">&amp;gt;</span>1.8<span class="hljs-symbol">&amp;lt;</span>/source<span class="hljs-symbol">&amp;gt;</span><br>                    <span class="hljs-symbol">&amp;lt;</span>target<span class="hljs-symbol">&amp;gt;</span>1.8<span class="hljs-symbol">&amp;lt;</span>/target<span class="hljs-symbol">&amp;gt;</span><br>                <span class="hljs-symbol">&amp;lt;</span>/configuration<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>/plugin<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>/plugins<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/build<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/project<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-配置整合" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-配置整合">#</a> （3） 配置整合</h4><ol><li>创建<code>resources\rabbitmq.properties</code>连接参数等配置文件；</li></ol><div class="language-properties line-numbers-mode" data-ext="properties"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight properties"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">rabbitmq.host</span>=<span class="hljs-string">localhost</span><br><span class="hljs-attr">rabbitmq.port</span>=<span class="hljs-string">5672</span><br><span class="hljs-attr">rabbitmq.username</span>=<span class="hljs-string">itlils</span><br><span class="hljs-attr">rabbitmq.password</span>=<span class="hljs-string">itlils</span><br><span class="hljs-attr">rabbitmq.virtual-host</span>=<span class="hljs-string">/</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>创建 <code>resources\spring-rabbitmq.xml</code> 整合配置文件；</li></ol><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;<br>       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;<br>       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;<br>       xmlns:rabbit=&quot;http://www.springframework.org/schema/rabbit&quot;<br>       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans<br>       http://www.springframework.org/schema/beans/spring-beans.xsd<br>       http://www.springframework.org/schema/context<br>       https://www.springframework.org/schema/context/spring-context.xsd<br>       http://www.springframework.org/schema/rabbit<br>       http://www.springframework.org/schema/rabbit/spring-rabbit.xsd&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>!--加载配置文件--<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>context:property-placeholder location=&quot;classpath:rabbitmq.properties&quot;/<span class="hljs-symbol">&amp;gt;</span><br><br>    <span class="hljs-symbol">&amp;lt;</span>!-- 定义rabbitmq connectionFactory --<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:connection-factory id=&quot;connectionFactory&quot;<br>                               host=&quot;$&#123;rabbitmq.host&#125;&quot;<br>                               port=&quot;$&#123;rabbitmq.port&#125;&quot;<br>                               username=&quot;$&#123;rabbitmq.username&#125;&quot;<br>                               password=&quot;$&#123;rabbitmq.password&#125;&quot;<br>                               virtual-host=&quot;$&#123;rabbitmq.virtual-host&#125;&quot;/<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>!--定义管理交换机、队列--<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:admin connection-factory=&quot;connectionFactory&quot;/<span class="hljs-symbol">&amp;gt;</span><br><br>    <span class="hljs-symbol">&amp;lt;</span>!--定义持久化队列，不存在则自动创建；不绑定到交换机则绑定到默认交换机<br>    默认交换机类型为direct，名字为：&quot;&quot;，路由键为队列的名称<br>    --<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:queue id=&quot;ydlqueue&quot; name=&quot;ydlqueue&quot; auto-declare=&quot;true&quot;/<span class="hljs-symbol">&amp;gt;</span><br><br>    <span class="hljs-symbol">&amp;lt;</span>!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~广播；所有队列都能收到消息~~~~~~~~~~~~~~~~~~~~~~~~~~~~ --<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>!--定义广播交换机中的持久化队列，不存在则自动创建--<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:queue id=&quot;spring_fanout_queue_1&quot; name=&quot;spring_fanout_queue_1&quot; auto-declare=&quot;true&quot; auto-delete=&quot;false&quot; durable=&quot;true&quot;/<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>!--定义广播交换机中的持久化队列，不存在则自动创建--<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:queue id=&quot;spring_fanout_queue_2&quot; name=&quot;spring_fanout_queue_2&quot; auto-declare=&quot;true&quot;/<span class="hljs-symbol">&amp;gt;</span><br><br>    <span class="hljs-symbol">&amp;lt;</span>!--定义广播类型交换机；并绑定上述两个队列--<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:fanout-exchange id=&quot;spring_fanout_exchange&quot; name=&quot;spring_fanout_exchange&quot; auto-declare=&quot;true&quot;<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>rabbit:bindings<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>rabbit:binding queue=&quot;spring_fanout_queue_1&quot;/<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>rabbit:binding queue=&quot;spring_fanout_queue_2&quot;/<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>/rabbit:bindings<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/rabbit:fanout-exchange<span class="hljs-symbol">&amp;gt;</span><br><br>    <span class="hljs-symbol">&amp;lt;</span>!-- routing 模式--<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:queue id=&quot;spring_direct_queue_1&quot; name=&quot;spring_direct_queue_1&quot; auto-declare=&quot;true&quot;/<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:queue id=&quot;spring_direct_queue_2&quot; name=&quot;spring_direct_queue_2&quot; auto-declare=&quot;true&quot;/<span class="hljs-symbol">&amp;gt;</span><br><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:direct-exchange id=&quot;spring_direct_exchange&quot; name=&quot;spring_direct_exchange&quot; auto-declare=&quot;true&quot;<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>rabbit:bindings<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>rabbit:binding queue=&quot;spring_direct_queue_1&quot; key=&quot;error&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/rabbit:binding<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>rabbit:binding queue=&quot;spring_direct_queue_2&quot; key=&quot;info&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/rabbit:binding<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>rabbit:binding queue=&quot;spring_direct_queue_2&quot; key=&quot;error&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/rabbit:binding<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>rabbit:binding queue=&quot;spring_direct_queue_2&quot; key=&quot;warning&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/rabbit:binding<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>/rabbit:bindings<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/rabbit:direct-exchange<span class="hljs-symbol">&amp;gt;</span><br><br><br>    <span class="hljs-symbol">&amp;lt;</span>!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~通配符；*匹配一个单词，#匹配多个单词 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~ --<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:queue id=&quot;spring_topic_queue_1&quot; name=&quot;spring_topic_queue_1&quot; auto-declare=&quot;true&quot;/<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:queue id=&quot;spring_topic_queue_2&quot; name=&quot;spring_topic_queue_2&quot; auto-declare=&quot;true&quot;/<span class="hljs-symbol">&amp;gt;</span><br><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:topic-exchange id=&quot;spring_topic_exchange&quot; name=&quot;spring_topic_exchange&quot;<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>rabbit:bindings<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>rabbit:binding queue=&quot;spring_topic_queue_1&quot; pattern=&quot;ydlclass.taiyuan.*.*&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/rabbit:binding<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>rabbit:binding queue=&quot;spring_topic_queue_2&quot; pattern=&quot;ydlclass.*.caiwubu.*&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/rabbit:binding<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>/rabbit:bindings<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/rabbit:topic-exchange<span class="hljs-symbol">&amp;gt;</span><br><br>    <span class="hljs-symbol">&amp;lt;</span>!--定义rabbitTemplate对象操作可以在代码中方便发送消息--<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:template id=&quot;rabbitTemplate&quot; connection-factory=&quot;connectionFactory&quot;/<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/beans<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>注意</strong>：</p><p>xxxtemplate作用就是帮我们和第三方组件键连接，断链接。我们只需要关注核心业务逻辑即可。</p><h4 id="_4-发送消息" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-发送消息">#</a> （4）发送消息</h4><figure><img class="lazy" alt="image-20220413210312813" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220413210312813-86100d12.png" tabindex="0"/><figcaption>image-20220413210312813</figcaption></figure><p>创建测试文件 test\java\com\ydlclass\rabbitmq\ProducerTest.java</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydlclass.rabbitmq;<br><br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.test.context.ContextConfiguration;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringJUnit4ClassRunner;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Created</span> by IT李老师</span><br><span class="hljs-comment"> * 公主号 “元动力课堂”</span><br><span class="hljs-comment"> * 个人微 itlils</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RunWith(SpringJUnit4ClassRunner.class)</span><br><span class="hljs-meta">@ContextConfiguration(locations = &quot;classpath:spring-rabbitmq.xml&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProducerTest</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-comment">//简单模式发送</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">helloTest</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">// String exchange,  交换机</span><br>        <span class="hljs-comment">// String routingKey,  路由键</span><br>        <span class="hljs-comment">// Object message     Object消息体 User car lunchuan</span><br>        String msg=<span class="hljs-string">&quot;hello rabbitmq!&quot;</span>;<br>        rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;ydlqueue&quot;</span>,msg);<br>    &#125;<br><br>    <span class="hljs-comment">//测试发布订阅模式</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">publishTest</span><span class="hljs-params">()</span>&#123;<br>        String msg=<span class="hljs-string">&quot;hello rabbitmq! publish&quot;</span>;<br>        rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;spring_fanout_exchange&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,msg);<br>    &#125;<br><br>    <span class="hljs-comment">//测试routing模式</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">routingTest</span><span class="hljs-params">()</span>&#123;<br>        String msg=<span class="hljs-string">&quot;hello rabbitmq!routing error&quot;</span>;<br>        rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;spring_direct_exchange&quot;</span>,<span class="hljs-string">&quot;error&quot;</span>,msg);<br><br>        String msg1=<span class="hljs-string">&quot;hello rabbitmq!routing info&quot;</span>;<br>        rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;spring_direct_exchange&quot;</span>,<span class="hljs-string">&quot;info&quot;</span>,msg1);<br><br>        String msg2=<span class="hljs-string">&quot;hello rabbitmq!routing warning&quot;</span>;<br>        rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;spring_direct_exchange&quot;</span>,<span class="hljs-string">&quot;warning&quot;</span>,msg2);<br>    &#125;<br><br>    <span class="hljs-comment">//测试topic模式</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">topicTest</span><span class="hljs-params">()</span>&#123;<br>        String msg1=<span class="hljs-string">&quot;hello rabbitmq!topic  本月工资大家涨两千！&quot;</span>;<br>        rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;spring_topic_exchange&quot;</span>,<span class="hljs-string">&quot;ydlclass.taiyuan.caiwubu.info&quot;</span>,msg1);<br><br>        String msg2=<span class="hljs-string">&quot;hello rabbitmq!topic 李老师携款潜逃！&quot;</span>;<br>        rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;spring_topic_exchange&quot;</span>,<span class="hljs-string">&quot;ydlclass.taiyuan.renshi.error&quot;</span>,msg2);<br><br>        String msg3=<span class="hljs-string">&quot;hello rabbitmq!topic  因为李老师逃了，全国所有校区降薪两千。不行就毕业！&quot;</span>;<br>        rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;spring_topic_exchange&quot;</span>,<span class="hljs-string">&quot;ydlclass.beijing.caiwubu.error&quot;</span>,msg3);<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>发布订阅：</p><p>发送者</p><figure><img class="lazy" alt="image-20220413211130569" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220413211130569-cbb13308.png" tabindex="0"/><figcaption>image-20220413211130569</figcaption></figure><p>队列：两个队列都有一条消息</p><figure><img class="lazy" alt="image-20220413211231511" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220413211231511-7448120c.png" tabindex="0"/><figcaption>image-20220413211231511</figcaption></figure><p>路由模式：</p><figure><img class="lazy" alt="image-20220413212246642" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220413212246642-12850ddb.png" tabindex="0"/><figcaption>image-20220413212246642</figcaption></figure><p>队列1只有1条消息</p><figure><img class="lazy" alt="image-20220413212324693" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220413212324693-ee3bfce9.png" tabindex="0"/><figcaption>image-20220413212324693</figcaption></figure><p>队列2有3条消息</p><figure><img class="lazy" alt="image-20220413212349991" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220413212349991-7afe9e22.png" tabindex="0"/><figcaption>image-20220413212349991</figcaption></figure><p>topic模式：</p><figure><img class="lazy" alt="image-20220413213316120" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220413213316120-9a5638cf.png" tabindex="0"/><figcaption>image-20220413213316120</figcaption></figure><p>队列1 2条消息</p><figure><img class="lazy" alt="image-20220413213334943" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220413213334943-f6c4e0da.png" tabindex="0"/><figcaption>image-20220413213334943</figcaption></figure><p>队列2 2条消息</p><figure><img class="lazy" alt="image-20220413213345957" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220413213345957-8a6ac58c.png" tabindex="0"/><figcaption>image-20220413213345957</figcaption></figure><h3 id="_2、搭建消费者工程" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、搭建消费者工程">#</a> 2、搭建消费者工程</h3><h4 id="_1-创建工程-2" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-创建工程-2">#</a> （1）创建工程</h4><p>spring-rabbitmq-consumer</p><figure><img class="lazy" alt="image-20220413215506816" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220413215506816-413652ef.png" tabindex="0"/><figcaption>image-20220413215506816</figcaption></figure><h4 id="_2-添加依赖-2" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-添加依赖-2">#</a> （2）添加依赖</h4><p>修改pom.xml文件内容为如下：</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;<br>         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;<br>         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>modelVersion<span class="hljs-symbol">&amp;gt;</span>4.0.0<span class="hljs-symbol">&amp;lt;</span>/modelVersion<span class="hljs-symbol">&amp;gt;</span><br><br>    <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.ydlclass<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-rabbitmq-consumer<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>1.0-SNAPSHOT<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependencies<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-context<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>5.1.7.RELEASE<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br><br>        <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework.amqp<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-rabbit<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>2.1.8.RELEASE<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br><br>        <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>junit<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>junit<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>4.12<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br><br>        <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-test<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>5.1.7.RELEASE<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependencies<span class="hljs-symbol">&amp;gt;</span><br><br>    <span class="hljs-symbol">&amp;lt;</span>build<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>plugins<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>plugin<span class="hljs-symbol">&amp;gt;</span><br>                <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.apache.maven.plugins<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>                <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>maven-compiler-plugin<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>                <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>3.8.0<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>                <span class="hljs-symbol">&amp;lt;</span>configuration<span class="hljs-symbol">&amp;gt;</span><br>                    <span class="hljs-symbol">&amp;lt;</span>source<span class="hljs-symbol">&amp;gt;</span>1.8<span class="hljs-symbol">&amp;lt;</span>/source<span class="hljs-symbol">&amp;gt;</span><br>                    <span class="hljs-symbol">&amp;lt;</span>target<span class="hljs-symbol">&amp;gt;</span>1.8<span class="hljs-symbol">&amp;lt;</span>/target<span class="hljs-symbol">&amp;gt;</span><br>                <span class="hljs-symbol">&amp;lt;</span>/configuration<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>/plugin<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>/plugins<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/build<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/project<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-配置整合-1" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-配置整合-1">#</a> （3） 配置整合</h4><ol><li>创建<code>resources\rabbitmq.properties</code>连接参数等配置文件；</li></ol><div class="language-properties line-numbers-mode" data-ext="properties"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight properties"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">rabbitmq.host</span>=<span class="hljs-string">localhost</span><br><span class="hljs-attr">rabbitmq.port</span>=<span class="hljs-string">5672</span><br><span class="hljs-attr">rabbitmq.username</span>=<span class="hljs-string">itlils</span><br><span class="hljs-attr">rabbitmq.password</span>=<span class="hljs-string">itlils</span><br><span class="hljs-attr">rabbitmq.virtual-host</span>=<span class="hljs-string">/</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>创建 resources\spring-rabbitmq.xml` 整合配置文件；</li></ol><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;<br>       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;<br>       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;<br>       xmlns:rabbit=&quot;http://www.springframework.org/schema/rabbit&quot;<br>       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans<br>       http://www.springframework.org/schema/beans/spring-beans.xsd<br>       http://www.springframework.org/schema/context<br>       https://www.springframework.org/schema/context/spring-context.xsd<br>       http://www.springframework.org/schema/rabbit<br>       http://www.springframework.org/schema/rabbit/spring-rabbit.xsd&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>!--加载配置文件--<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>context:property-placeholder location=&quot;classpath:rabbitmq.properties&quot;/<span class="hljs-symbol">&amp;gt;</span><br><br>    <span class="hljs-symbol">&amp;lt;</span>!-- 定义rabbitmq connectionFactory --<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:connection-factory id=&quot;connectionFactory&quot;<br>                               host=&quot;$&#123;rabbitmq.host&#125;&quot;<br>                               port=&quot;$&#123;rabbitmq.port&#125;&quot;<br>                               username=&quot;$&#123;rabbitmq.username&#125;&quot;<br>                               password=&quot;$&#123;rabbitmq.password&#125;&quot;<br>                               virtual-host=&quot;$&#123;rabbitmq.virtual-host&#125;&quot;/<span class="hljs-symbol">&amp;gt;</span><br><br>    <span class="hljs-symbol">&amp;lt;</span>bean id=&quot;springQueueListener&quot; class=&quot;com.ydlclass.rabbitmq.listener.SpringQueueListener&quot;/<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>!--    <span class="hljs-symbol">&amp;lt;</span>bean id=&quot;fanoutListener1&quot; class=&quot;com.ydlclass.rabbitmq.listener.FanoutListener1&quot;/<span class="hljs-symbol">&amp;gt;</span>--<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>!--    <span class="hljs-symbol">&amp;lt;</span>bean id=&quot;fanoutListener2&quot; class=&quot;com.ydlclass.rabbitmq.listener.FanoutListener2&quot;/<span class="hljs-symbol">&amp;gt;</span>--<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>!--    <span class="hljs-symbol">&amp;lt;</span>bean id=&quot;topicListenerStar&quot; class=&quot;com.ydlclass.rabbitmq.listener.TopicListenerStar&quot;/<span class="hljs-symbol">&amp;gt;</span>--<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>!--    <span class="hljs-symbol">&amp;lt;</span>bean id=&quot;topicListenerWell&quot; class=&quot;com.ydlclass.rabbitmq.listener.TopicListenerWell&quot;/<span class="hljs-symbol">&amp;gt;</span>--<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>!--    <span class="hljs-symbol">&amp;lt;</span>bean id=&quot;topicListenerWell2&quot; class=&quot;com.ydlclass.rabbitmq.listener.TopicListenerWell2&quot;/<span class="hljs-symbol">&amp;gt;</span>--<span class="hljs-symbol">&amp;gt;</span><br><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:listener-container connection-factory=&quot;connectionFactory&quot; auto-declare=&quot;true&quot;<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>rabbit:listener ref=&quot;springQueueListener&quot; queue-names=&quot;ydlqueue&quot;/<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>!--        <span class="hljs-symbol">&amp;lt;</span>rabbit:listener ref=&quot;fanoutListener1&quot; queue-names=&quot;spring_fanout_queue_1&quot;/<span class="hljs-symbol">&amp;gt;</span>--<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>!--        <span class="hljs-symbol">&amp;lt;</span>rabbit:listener ref=&quot;fanoutListener2&quot; queue-names=&quot;spring_fanout_queue_2&quot;/<span class="hljs-symbol">&amp;gt;</span>--<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>!--        <span class="hljs-symbol">&amp;lt;</span>rabbit:listener ref=&quot;topicListenerStar&quot; queue-names=&quot;spring_topic_queue_star&quot;/<span class="hljs-symbol">&amp;gt;</span>--<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>!--        <span class="hljs-symbol">&amp;lt;</span>rabbit:listener ref=&quot;topicListenerWell&quot; queue-names=&quot;spring_topic_queue_well&quot;/<span class="hljs-symbol">&amp;gt;</span>--<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>!--        <span class="hljs-symbol">&amp;lt;</span>rabbit:listener ref=&quot;topicListenerWell2&quot; queue-names=&quot;spring_topic_queue_well2&quot;/<span class="hljs-symbol">&amp;gt;</span>--<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/rabbit:listener-container<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/beans<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-消息监听器" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-消息监听器">#</a> （4） 消息监听器</h4><h5 id="a、队列监听器" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#a、队列监听器">#</a> a、队列监听器</h5><p>创建 <code>spring-rabbitmq-consumer\src\main\java\com\ydlclass\rabbitmq\listener\SpringQueueListener.java</code></p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydlclass.rabbitmq.listener;<br><br><span class="hljs-keyword">import</span> org.springframework.amqp.core.Message;<br><span class="hljs-keyword">import</span> org.springframework.amqp.core.MessageListener;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Created</span> by IT李老师</span><br><span class="hljs-comment"> * 公主号 “元动力课堂”</span><br><span class="hljs-comment"> * 个人微 itlils</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">//缺啥补啥 干就完事</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringQueueListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MessageListener</span> &#123;<br>    <span class="hljs-comment">//有了消息 做什么</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(Message message)</span> &#123;<br>        <span class="hljs-comment">//业务逻辑</span><br>        <span class="hljs-type">byte</span>[] body = message.getBody();<br>        System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为了让spring容器一直运行，我们需要在测试类中，启动spring容器：com.ydlclass.rabbimq</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydlclass.rabbitmq;<br><br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.test.context.ContextConfiguration;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringJUnit4ClassRunner;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Created</span> by IT李老师</span><br><span class="hljs-comment"> * 公主号 “元动力课堂”</span><br><span class="hljs-comment"> * 个人微 itlils</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RunWith(SpringJUnit4ClassRunner.class)</span><br><span class="hljs-meta">@ContextConfiguration(locations = &quot;classpath:spring-rabbitmq.xml&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsumerTest</span> &#123;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">consumerTest</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br><br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="b、广播监听器1" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#b、广播监听器1">#</a> b、广播监听器1</h5><p>创建 <code>spring-rabbitmq-consumer\src\main\java\com\ydlclass\rabbitmq\listener\FanoutListener1.java</code></p><h5 id="c、广播监听器2" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#c、广播监听器2">#</a> c、广播监听器2</h5><p>创建 <code>spring-rabbitmq-consumer\src\main\java\com\ydlclass\rabbitmq\listener\FanoutListener2.java</code></p><h5 id="d、星号通配符监听器" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#d、星号通配符监听器">#</a> d、星号通配符监听器</h5><p>创建 <code>spring-rabbitmq-consumer\src\main\java\com\ydlclass\rabbitmq\listener\TopicListenerStar.java</code></p><h5 id="e、井号通配符监听器" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#e、井号通配符监听器">#</a> e、井号通配符监听器</h5><p>创建 <code>spring-rabbitmq-consumer\src\main\java\com\ydlclass\rabbitmq\listener\TopicListenerWell.java</code></p><h5 id="f、井号通配符监听器2" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#f、井号通配符监听器2">#</a> f、井号通配符监听器2</h5><p>创建 <code>spring-rabbitmq-consumer\src\main\java\com\ydlclass\rabbitmq\listener\TopicListenerWell2.java</code></p><p>测试：</p><figure><img class="lazy" alt="image-20220413215534196" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220413215534196-0ac570bd.png" tabindex="0"/><figcaption>image-20220413215534196</figcaption></figure><h2 id="第七章-spring-boot整合rabbitmq" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第七章-spring-boot整合rabbitmq">#</a> 第七章 Spring Boot整合RabbitMQ</h2><h3 id="_1、-简介" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、-简介">#</a> 1、 简介</h3><p>在Spring项目中，可以使用Spring-Rabbit去操作RabbitMQ <a href="https://github.com/spring-projects/spring-amqp" rel="noopener noreferrer" target="_blank">https://github.com/spring-projects/spring-amqp<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>尤其是在spring boot项目中只需要引入对应的amqp启动器依赖即可，方便的使用RabbitTemplate发送消息，使用注解接收消息。</p><p><em>一般在开发过程中</em>：</p><p><strong>生产者工程：</strong></p><ol><li><p>application.yml文件配置RabbitMQ相关信息；</p></li><li><p>在生产者工程中编写配置类，用于创建交换机和队列，并进行绑定</p></li><li><p>注入RabbitTemplate对象，通过RabbitTemplate对象发送消息到交换机</p></li></ol><p><strong>消费者工程：</strong></p><ol><li><p>application.yml文件配置RabbitMQ相关信息</p></li><li><p>创建消息处理类，用于接收队列中的消息并进行处理</p></li></ol><h3 id="_2、搭建生产者工程" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、搭建生产者工程">#</a> 2、搭建生产者工程</h3><h4 id="_1-创建工程-3" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-创建工程-3">#</a> （1） 创建工程</h4><p>创建生产者工程springboot-rabbitmq-producer</p><figure><img class="lazy" alt="image-20220413222931239" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220413222931239-b56a680b.png" tabindex="0"/><figcaption>image-20220413222931239</figcaption></figure><h4 id="_2-添加依赖-3" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-添加依赖-3">#</a> （2） 添加依赖</h4><p>修改pom.xml文件内容为如下：</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;<br>         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;<br>         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>modelVersion<span class="hljs-symbol">&amp;gt;</span>4.0.0<span class="hljs-symbol">&amp;lt;</span>/modelVersion<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>parent<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework.boot<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-boot-starter-parent<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>2.1.4.RELEASE<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/parent<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.ydlclass<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>springboot-rabbitmq-producer<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>1.0-SNAPSHOT<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br><br>    <span class="hljs-symbol">&amp;lt;</span>dependencies<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework.boot<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-boot-starter-amqp<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework.boot<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-boot-starter-test<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependencies<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/project<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-启动类" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-启动类">#</a> （3） 启动类</h4><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydlclass.rabbitmq;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Created</span> by IT李老师</span><br><span class="hljs-comment"> * 公主号 “元动力课堂”</span><br><span class="hljs-comment"> * 个人微 itlils</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProducerApp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(ProducerApp.class,args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-配置rabbitmq" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-配置rabbitmq">#</a> （4）配置RabbitMQ</h4><h5 id="a、配置文件" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#a、配置文件">#</a> a、配置文件</h5><p>创建application.yml，内容如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight yaml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">virtual-host:</span> <span class="hljs-string">/</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">itlils</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">itlils</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="b、绑定交换机和队列" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#b、绑定交换机和队列">#</a> b、绑定交换机和队列</h5><p>创建RabbitMQ队列与交换机绑定的配置类com.ydlclass.rabbitmq.config.RabbitMQConfig</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydlclass.rabbitmq.config;<br><br><span class="hljs-keyword">import</span> org.springframework.amqp.core.*;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Created</span> by IT李老师</span><br><span class="hljs-comment"> * 公主号 “元动力课堂”</span><br><span class="hljs-comment"> * 个人微 itlils</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabbitConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean(&quot;boot_hello_queue&quot;)</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">queue</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">//String queue,  队列名</span><br>        <span class="hljs-comment">// boolean durable, 持久化</span><br>        <span class="hljs-comment">// boolean exclusive, 排他的</span><br>        <span class="hljs-comment">// boolean autoDelete, 自动删除</span><br>        <span class="hljs-comment">// Map&amp;lt;String, Object&amp;gt; arguments 属性</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(<span class="hljs-string">&quot;boot_hello_queue&quot;</span>,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//发布订阅模式</span><br>    <span class="hljs-comment">//交换机名称</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FANOUT_EXCHAGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;boot_fanout_exchange&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FANOUT_QUEUE_1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;boot_fanout_queue_1&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FANOUT_QUEUE_2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;boot_fanout_queue_2&quot;</span>;<br><br>    <span class="hljs-meta">@Bean(FANOUT_QUEUE_1)</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">FANOUT_QUEUE_1</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(FANOUT_QUEUE_1,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br>    &#125;<br>    <span class="hljs-meta">@Bean(FANOUT_QUEUE_2)</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">FANOUT_QUEUE_2</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(FANOUT_QUEUE_2,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);<br>    &#125;<br>    <span class="hljs-meta">@Bean(FANOUT_EXCHAGE)</span><br>    <span class="hljs-keyword">public</span> Exchange <span class="hljs-title function_">FANOUT_EXCHAGE</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> ExchangeBuilder.fanoutExchange(FANOUT_EXCHAGE).durable(<span class="hljs-literal">true</span>).build();<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">FANOUT_QUEUE_1_FANOUT_EXCHAGE</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(FANOUT_QUEUE_1)</span> Queue queue,</span><br><span class="hljs-params">                                                 <span class="hljs-meta">@Qualifier(FANOUT_EXCHAGE)</span> Exchange exchange)</span>&#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="hljs-string">&quot;&quot;</span>).noargs();<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">FANOUT_QUEUE_2_FANOUT_EXCHAGE</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(FANOUT_QUEUE_2)</span> Queue queue,</span><br><span class="hljs-params">                                                 <span class="hljs-meta">@Qualifier(FANOUT_EXCHAGE)</span> Exchange exchange)</span>&#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="hljs-string">&quot;&quot;</span>).noargs();<br>    &#125;<br><br>    <span class="hljs-comment">//作业</span><br>    <span class="hljs-comment">//routing模式</span><br><br>    <span class="hljs-comment">//topic模式</span><br><br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试类</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs text">package com.ydlclass.rabbitmq;<br><br>import com.ydlclass.rabbitmq.config.RabbitConfig;<br>import org.junit.Test;<br>import org.junit.runner.RunWith;<br>import org.springframework.amqp.rabbit.core.RabbitTemplate;<br>import org.springframework.beans.factory.annotation.Autowired;<br>import org.springframework.boot.test.context.SpringBootTest;<br>import org.springframework.test.context.junit4.SpringRunner;<br><br>/**<br> * @Created by IT李老师<br> * 公主号 “元动力课堂”<br> * 个人微 itlils<br> */<br>@RunWith(SpringRunner.class)<br>@SpringBootTest(classes = ProducerApp.class)<br>public class ProducerTest &#123;<br><br>    @Autowired<br>    RabbitTemplate rabbitTemplate;<br><br>    @Test<br>    public void helloTest()&#123;<br>        String msg=&quot;hello rabbitmq!&quot;;<br>        rabbitTemplate.convertAndSend(&quot;&quot;,&quot;boot_hello_queue&quot;,msg);<br>    &#125;<br><br>    @Test<br>    public void publishTest()&#123;<br>        String msg=&quot;hello rabbitmq!publishTest&quot;;<br>        rabbitTemplate.convertAndSend(RabbitConfig.FANOUT_EXCHAGE,&quot;&quot;,msg);<br>    &#125;<br><br>    //作业 routing<br>    //topic<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>简单模式：</p><figure><img class="lazy" alt="image-20220413221046286" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220413221046286-35eb38b7.png" tabindex="0"/><figcaption>image-20220413221046286</figcaption></figure><p>发布订阅：</p><figure><img class="lazy" alt="image-20220413222539201" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220413222539201-769338b4.png" tabindex="0"/><figcaption>image-20220413222539201</figcaption></figure><p>每个队列都有一条消息了</p><figure><img class="lazy" alt="image-20220413222558184" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220413222558184-c6db4b62.png" tabindex="0"/><figcaption>image-20220413222558184</figcaption></figure><p>​ <img class="lazy" alt="image-20220413222609681" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220413222609681-d010ab71.png"/></p><h3 id="_3、搭建消费者工程" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、搭建消费者工程">#</a> 3、搭建消费者工程</h3><h4 id="_1-创建工程-4" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-创建工程-4">#</a> （1） 创建工程</h4><p>创建消费者工程springboot-rabbitmq-consumer</p><figure><img class="lazy" alt="image-20220413233208158" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220413233208158-458a7865.png" tabindex="0"/><figcaption>image-20220413233208158</figcaption></figure><h4 id="_2-添加依赖-4" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-添加依赖-4">#</a> （2） 添加依赖</h4><p>修改pom.xml文件内容为如下：</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;<br>         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;<br>         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>modelVersion<span class="hljs-symbol">&amp;gt;</span>4.0.0<span class="hljs-symbol">&amp;lt;</span>/modelVersion<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>parent<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework.boot<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-boot-starter-parent<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>2.1.4.RELEASE<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/parent<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>com.ydlclass<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>springboot-rabbitmq-consumer<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>1.0-SNAPSHOT<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br><br>    <span class="hljs-symbol">&amp;lt;</span>dependencies<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework.boot<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-boot-starter-amqp<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependencies<span class="hljs-symbol">&amp;gt;</span><br><br><span class="hljs-symbol">&amp;lt;</span>/project<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-启动类-1" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-启动类-1">#</a> （3） 启动类</h4><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydlclass.rabbitmq;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Created</span> by IT李老师</span><br><span class="hljs-comment"> * 公主号 “元动力课堂”</span><br><span class="hljs-comment"> * 个人微 itlils</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsumerApp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(ConsumerApp.class,args);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-配置rabbitmq-1" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-配置rabbitmq-1">#</a> （4） 配置RabbitMQ</h4><p>创建application.yml，内容如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight yaml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">virtual-host:</span> <span class="hljs-string">/</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">itlils</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">itlils</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-消息监听处理类" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_5-消息监听处理类">#</a> （5） 消息监听处理类</h4><p>编写消息监听器com.ydlclass.rabbitmq.listener.MyListener</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydlclass.rabbitmq.listener;<br><br><span class="hljs-keyword">import</span> com.ydlclass.rabbitmq.config.RabbitConfig;<br><span class="hljs-keyword">import</span> org.springframework.amqp.core.Message;<br><span class="hljs-keyword">import</span> org.springframework.amqp.core.MessageProperties;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Created</span> by IT李老师</span><br><span class="hljs-comment"> * 公主号 “元动力课堂”</span><br><span class="hljs-comment"> * 个人微 itlils</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyListener</span> &#123;<br><br>    <span class="hljs-meta">@RabbitListener(queues = RabbitConfig.FANOUT_QUEUE_1)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receiveMsg</span><span class="hljs-params">(Message message)</span>&#123;<br>        <span class="hljs-comment">//业务逻辑</span><br>        <span class="hljs-type">byte</span>[] body = message.getBody();<br>        System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));<br><br>        <span class="hljs-type">MessageProperties</span> <span class="hljs-variable">messageProperties</span> <span class="hljs-operator">=</span> message.getMessageProperties(); <span class="hljs-comment">//参数</span><br>        System.out.println(messageProperties.getMessageId());<br>        System.out.println(messageProperties.getDeliveryTag());<br>        System.out.println(messageProperties.getReceivedRoutingKey());<br>        System.out.println(messageProperties.getConsumerTag());<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4、-测试" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4、-测试">#</a> 4、 测试</h3><p>先运行上述测试程序（交换机和队列才能先被声明和绑定），然后启动消费者；在消费者工程springboot-rabbitmq-consumer中控制台查看是否接收到对应消息。</p><p>另外；也可以在RabbitMQ的管理控制台中查看到交换机与队列的绑定。</p><h1 id="rabbitmq高级-学习目标" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#rabbitmq高级-学习目标">#</a> RabbitMQ高级 学习目标</h1><ul><li><p>掌握RabbitMQ 高级特性</p></li><li><p>理解RabbitMQ 应用问题</p></li><li><p>能够搭建RabbitMQ 集群</p><figure><img class="lazy" alt="image-20200320230112442" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20200320230112442-9919b2e6.png" tabindex="0"/><figcaption>image-20200320230112442</figcaption></figure></li></ul><h2 id="第一章-rabbitmq-高级特性" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第一章-rabbitmq-高级特性">#</a> 第一章 RabbitMQ 高级特性</h2><figure><img class="lazy" alt="image-20200616093631383" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20200320180217097-f868c655.png" tabindex="0"/><figcaption>image-20200616093631383</figcaption></figure><h3 id="_1、消息可靠性投递" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、消息可靠性投递">#</a> 1、消息可靠性投递</h3><p>在使用 RabbitMQ 的时候，作为消息发送方希望杜绝任何消息丢失或者投递失败场景。RabbitMQ 为我们提供了两种方式用来控制消息的投递可靠性模式。</p><ul><li><p>confirm <strong>确认模式</strong></p></li><li><p>return <strong>退回模式</strong></p></li></ul><p>rabbitmq 整个消息投递的路径为：</p><p>​ <strong>producer ---&gt; rabbitmq broker ---&gt; exchange ---&gt; queue ---&gt; consumer</strong></p><ul><li><p>消息从 producer 到 exchange 则会返回一个 confirmCallback 。</p></li><li><p>消息从 exchange 到 queue 投递失败则会返回一个 returnCallback 。</p></li></ul><p>我们将利用这两个 callback 控制消息的可靠性投递</p><h4 id="_1-confirm确认模式代码实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-confirm确认模式代码实现">#</a> （1）confirm确认模式代码实现</h4><ol><li><p>创建maven工程，消息的生产者工程，项目模块名称：rabbitmq-producer-spring</p></li><li><p>添加依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>dependencies<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-context<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>5.1.7.RELEASE<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework.amqp<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-rabbit<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>2.1.8.RELEASE<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>junit<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>junit<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>4.12<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-test<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>5.1.7.RELEASE<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/dependencies<span class="hljs-symbol">&amp;gt;</span><br><br><span class="hljs-symbol">&amp;lt;</span>build<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>plugins<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>plugin<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.apache.maven.plugins<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>maven-compiler-plugin<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>3.8.0<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>configuration<span class="hljs-symbol">&amp;gt;</span><br>                <span class="hljs-symbol">&amp;lt;</span>source<span class="hljs-symbol">&amp;gt;</span>1.8<span class="hljs-symbol">&amp;lt;</span>/source<span class="hljs-symbol">&amp;gt;</span><br>                <span class="hljs-symbol">&amp;lt;</span>target<span class="hljs-symbol">&amp;gt;</span>1.8<span class="hljs-symbol">&amp;lt;</span>/target<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>/configuration<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>/plugin<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/plugins<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/build<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>在 resources 目录下创建 rabbitmq.properties 配置文件，添加连接RabbitMQ相关信息</p><div class="language-properties line-numbers-mode" data-ext="properties"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight properties"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">rabbitmq.host</span>=<span class="hljs-string">localhost</span><br><span class="hljs-attr">rabbitmq.port</span>=<span class="hljs-string">5672</span><br><span class="hljs-attr">rabbitmq.username</span>=<span class="hljs-string">guest</span><br><span class="hljs-attr">rabbitmq.password</span>=<span class="hljs-string">guest</span><br><span class="hljs-attr">rabbitmq.virtual-host</span>=<span class="hljs-string">/</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>在 resources 目录下创建 spring-rabbitmq-producer.xml 配置文件，添加以下配置</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;<br>       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;<br>       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;<br>       xmlns:rabbit=&quot;http://www.springframework.org/schema/rabbit&quot;<br>       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans<br>                 http://www.springframework.org/schema/beans/spring-beans.xsd<br>                 http://www.springframework.org/schema/context<br>                 https://www.springframework.org/schema/context/spring-context.xsd<br>                 http://www.springframework.org/schema/rabbit<br>                 http://www.springframework.org/schema/rabbit/spring-rabbit.xsd&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>!--加载配置文件--<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>context:property-placeholder location=&quot;classpath:rabbitmq.properties&quot;/<span class="hljs-symbol">&amp;gt;</span><br><br>    <span class="hljs-symbol">&amp;lt;</span>!-- 定义rabbitmq connectionFactory  1. 设置  publisher-confirms=&quot;true&quot; --<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:connection-factory id=&quot;connectionFactory&quot; host=&quot;$&#123;rabbitmq.host&#125;&quot;<br>                               port=&quot;$&#123;rabbitmq.port&#125;&quot;<br>                               username=&quot;$&#123;rabbitmq.username&#125;&quot;<br>                               password=&quot;$&#123;rabbitmq.password&#125;&quot;<br>                               virtual-host=&quot;$&#123;rabbitmq.virtual-host&#125;&quot;<br><br>                               publisher-confirms=&quot;true&quot;<br>                               /<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>!--定义管理交换机、队列--<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:admin connection-factory=&quot;connectionFactory&quot;/<span class="hljs-symbol">&amp;gt;</span><br><br>    <span class="hljs-symbol">&amp;lt;</span>!--定义rabbitTemplate对象操作可以在代码中方便发送消息--<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:template id=&quot;rabbitTemplate&quot; connection-factory=&quot;connectionFactory&quot;/<span class="hljs-symbol">&amp;gt;</span><br><br>    <span class="hljs-symbol">&amp;lt;</span>!--2. 消息可靠性投递（生产端）--<span class="hljs-symbol">&amp;gt;</span><br>   <span class="hljs-symbol">&amp;lt;</span>rabbit:queue id=&quot;test_queue_confirm&quot; name=&quot;test_queue_confirm&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/rabbit:queue<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:direct-exchange name=&quot;test_exchange_confirm&quot;<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>rabbit:bindings<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>rabbit:binding queue=&quot;test_queue_confirm&quot; key=&quot;confirm&quot;<span class="hljs-symbol">&amp;gt;</span>                           <span class="hljs-symbol">&amp;lt;</span>/rabbit:binding<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>/rabbit:bindings<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/rabbit:direct-exchange<span class="hljs-symbol">&amp;gt;</span><br><br><span class="hljs-symbol">&amp;lt;</span>/beans<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>编写测试代码 com.ydlclass.producer</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RunWith(SpringJUnit4ClassRunner.class)</span><br><span class="hljs-meta">@ContextConfiguration(locations = &quot;classpath:spring-rabbitmq-producer.xml&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProducerTest</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 确认模式：</span><br><span class="hljs-comment">     * 步骤：</span><br><span class="hljs-comment">     * 1. 确认模式开启：ConnectionFactory中开启publisher-confirms=&quot;true&quot;</span><br><span class="hljs-comment">     * 2. 在rabbitTemplate定义ConfirmCallBack回调函数</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testConfirm</span><span class="hljs-params">()</span> &#123;<br><br>        <span class="hljs-comment">//2. 定义回调 **</span><br>        rabbitTemplate.setConfirmCallback(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RabbitTemplate</span>.ConfirmCallback() &#123;<br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             *</span><br><span class="hljs-comment">             * <span class="hljs-doctag">@param</span> correlationData 相关配置信息</span><br><span class="hljs-comment">             * <span class="hljs-doctag">@param</span> ack   exchange交换机 是否成功收到了消息。true 成功，false代表失败</span><br><span class="hljs-comment">             * <span class="hljs-doctag">@param</span> cause 失败原因</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">confirm</span><span class="hljs-params">(CorrelationData correlationData, <span class="hljs-type">boolean</span> ack, String cause)</span> &#123;<br>                System.out.println(<span class="hljs-string">&quot;confirm方法被执行了....&quot;</span>);<br><br>                <span class="hljs-keyword">if</span> (ack) &#123;<br>                    <span class="hljs-comment">//接收成功</span><br>                    System.out.println(<span class="hljs-string">&quot;接收成功消息&quot;</span> + cause);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">//接收失败</span><br>                    System.out.println(<span class="hljs-string">&quot;接收失败消息&quot;</span> + cause);<br>                    <span class="hljs-comment">//做一些处理，让消息再次发送。</span><br>                &#125;<br>            &#125;<br>        &#125;);<br><br>        <span class="hljs-comment">//3. 发送消息</span><br>        rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;test_exchange_confirm111&quot;</span>, <span class="hljs-string">&quot;confirm&quot;</span>, <span class="hljs-string">&quot;message confirm....&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>测试结果</p><p>成功：</p><figure><img class="lazy" alt="image-20220714120818639" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220714120818639-d5d2bd3b.png" tabindex="0"/><figcaption>image-20220714120818639</figcaption></figure><p>失败：</p><figure><img class="lazy" alt="image-20220714120929607" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220714120929607-e9b31074.png" tabindex="0"/><figcaption>image-20220714120929607</figcaption></figure></li></ol><h4 id="_2-return退回模式代码实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-return退回模式代码实现">#</a> （2） return退回模式代码实现</h4><p>回退模式： 当消息发送给Exchange后，Exchange路由到Queue失败是 才会执行 ReturnCallBack，具体实现如下：</p><ol><li><p>在 spring-rabbitmq-producer.xml 配置文件，在 <strong>rabbit:connection-factory</strong>节点 添加配置：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">publisher-returns=&quot;true&quot;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div></li><li><p>编写测试方法</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 步骤：</span><br><span class="hljs-comment"> * 1. 开启回退模式:publisher-returns=&quot;true&quot;</span><br><span class="hljs-comment"> * 2. 设置ReturnCallBack</span><br><span class="hljs-comment"> * 3. 设置Exchange处理消息的模式：</span><br><span class="hljs-comment"> *  1. 如果消息没有路由到Queue，则丢弃消息（默认）</span><br><span class="hljs-comment"> *  2. 如果消息没有路由到Queue，返回给消息发送方ReturnCallBack</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testReturn</span><span class="hljs-params">()</span> &#123;<br><br>    <span class="hljs-comment">//设置交换机处理失败消息的模式</span><br>    rabbitTemplate.setMandatory(<span class="hljs-literal">true</span>);<br><br>    <span class="hljs-comment">//2.设置ReturnCallBack</span><br>    rabbitTemplate.setReturnCallback(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RabbitTemplate</span>.ReturnCallback() &#123;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> message   消息对象</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> replyCode 错误码</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> replyText 错误信息</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> exchange  交换机</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> routingKey 路由键</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">returnedMessage</span><span class="hljs-params">(Message message, <span class="hljs-type">int</span> replyCode, String replyText, String exchange, String routingKey)</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;return 执行了....&quot;</span>);<br><br>            System.out.println(message);<br>            System.out.println(replyCode);<br>            System.out.println(replyText);<br>            System.out.println(exchange);<br>            System.out.println(routingKey);<br><br>            <span class="hljs-comment">//处理</span><br>        &#125;<br>    &#125;);<br><br><br>    <span class="hljs-comment">//3. 发送消息   </span><br>    rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;test_exchange_confirm&quot;</span>, <span class="hljs-string">&quot;confirm&quot;</span>, <span class="hljs-string">&quot;message confirm....&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>设置 routingKey 为一个不符合规则的key，观察控制台打印结果。</p><p>成功：</p><figure><img class="lazy" alt="image-20220714133207266" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220714133207266-a43b3bda.png" tabindex="0"/><figcaption>image-20220714133207266</figcaption></figure><p>失败：</p><figure><img class="lazy" alt="image-20220714133352530" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220714133352530-c340e440.png" tabindex="0"/><figcaption>image-20220714133352530</figcaption></figure></li></ol><h4 id="_3-小结" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-小结">#</a> （3）小结</h4><p>对于确认模式：</p><ul><li><p>设置ConnectionFactory的publisher-confirms="true" 开启 确认模式。</p></li><li><p>使用rabbitTemplate.setConfirmCallback设置回调函数。当消息发送到exchange后回调confirm方法。在方法中判断ack，如果为true，则发送成功，如果为false，则发送失败，需要处理。</p></li></ul><p>对于退回模式</p><ul><li><p>设置ConnectionFactory的publisher-returns="true" 开启 退回模式。</p></li><li><p>使用rabbitTemplate.setReturnCallback设置退回函数，当消息从exchange路由到queue失败后，如果设置了rabbitTemplate.setMandatory(true)参数，则会将消息退回给producer。并执行回调函数returnedMessage。</p></li></ul><blockquote><p>在RabbitMQ中也提供了事务机制，但是性能较差，此处不做讲解。</p><p>使用channel列方法，完成事务控制：</p><p>txSelect(), 用于将当前channel设置成transaction模式</p><p>txCommit()，用于提交事务</p><p>txRollback(),用于回滚事务</p></blockquote><h3 id="_2、consumer-ack" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、consumer-ack">#</a> 2、Consumer ACK</h3><p>ack指 <strong>Acknowledge</strong>，确认。 表示消费端收到消息后的确认方式。</p><p>有三种确认方式：</p><p>• 自动确认：acknowledge="<strong>none</strong>"</p><p>• 手动确认：acknowledge="<strong>manual</strong>"</p><p>• 根据异常情况确认：acknowledge="<strong>auto</strong>"，（这种方式使用麻烦，不作讲解）</p><p>其中自动确认是指，当消息一旦被Consumer接收到，则自动确认收到，并将相应 message 从 RabbitMQ 的消息缓存中移除。但是在实际业务处理中，很可能消息接收到，业务处理出现异常，那么该消息就会丢失。</p><p>如果设置了手动确认方式，则需要在业务处理成功后，调用channel.basicAck()，手动签收，如果出现异常，则调用channel.basicNack()方法，让其自动重新发送消息。</p><h4 id="_1-代码实现" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-代码实现">#</a> （1）代码实现</h4><ol><li><p>创建maven工程，消息的消费者工程，项目模块名称：rabbitmq-consumer-spring</p></li><li><p>添加依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>dependencies<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-context<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>5.1.7.RELEASE<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework.amqp<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-rabbit<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>2.1.8.RELEASE<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>junit<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>junit<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>4.12<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>dependency<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.springframework<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>spring-test<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>5.1.7.RELEASE<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/dependency<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/dependencies<span class="hljs-symbol">&amp;gt;</span><br><br><span class="hljs-symbol">&amp;lt;</span>build<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>plugins<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>plugin<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>groupId<span class="hljs-symbol">&amp;gt;</span>org.apache.maven.plugins<span class="hljs-symbol">&amp;lt;</span>/groupId<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>artifactId<span class="hljs-symbol">&amp;gt;</span>maven-compiler-plugin<span class="hljs-symbol">&amp;lt;</span>/artifactId<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>version<span class="hljs-symbol">&amp;gt;</span>3.8.0<span class="hljs-symbol">&amp;lt;</span>/version<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>configuration<span class="hljs-symbol">&amp;gt;</span><br>                <span class="hljs-symbol">&amp;lt;</span>source<span class="hljs-symbol">&amp;gt;</span>1.8<span class="hljs-symbol">&amp;lt;</span>/source<span class="hljs-symbol">&amp;gt;</span><br>                <span class="hljs-symbol">&amp;lt;</span>target<span class="hljs-symbol">&amp;gt;</span>1.8<span class="hljs-symbol">&amp;lt;</span>/target<span class="hljs-symbol">&amp;gt;</span><br>            <span class="hljs-symbol">&amp;lt;</span>/configuration<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>/plugin<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/plugins<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/build<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>在 resources 目录下创建 rabbitmq.properties 配置文件，添加链接RabbitMQ相关信息</p><div class="language-properties line-numbers-mode" data-ext="properties"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight properties"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">rabbitmq.host</span>=<span class="hljs-string">localhost</span><br><span class="hljs-attr">rabbitmq.port</span>=<span class="hljs-string">5672</span><br><span class="hljs-attr">rabbitmq.username</span>=<span class="hljs-string">guest</span><br><span class="hljs-attr">rabbitmq.password</span>=<span class="hljs-string">guest</span><br><span class="hljs-attr">rabbitmq.virtual-host</span>=<span class="hljs-string">/</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>在 resources 目录下创建 spring-rabbitmq-consumer.xml 配置文件，添加以下配置</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;<br>       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;<br>       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;<br>       xmlns:rabbit=&quot;http://www.springframework.org/schema/rabbit&quot;<br>       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans<br>             http://www.springframework.org/schema/beans/spring-beans.xsd<br>             http://www.springframework.org/schema/context<br>             https://www.springframework.org/schema/context/spring-context.xsd<br>             http://www.springframework.org/schema/rabbit<br>             http://www.springframework.org/schema/rabbit/spring-rabbit.xsd&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>!--加载配置文件--<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>context:property-placeholder location=&quot;classpath:rabbitmq.properties&quot;/<span class="hljs-symbol">&amp;gt;</span><br><br>    <span class="hljs-symbol">&amp;lt;</span>!-- 定义rabbitmq connectionFactory --<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:connection-factory id=&quot;connectionFactory&quot; host=&quot;$&#123;rabbitmq.host&#125;&quot;<br>                               port=&quot;$&#123;rabbitmq.port&#125;&quot;<br>                               username=&quot;$&#123;rabbitmq.username&#125;&quot;<br>                               password=&quot;$&#123;rabbitmq.password&#125;&quot;<br>                               virtual-host=&quot;$&#123;rabbitmq.virtual-host&#125;&quot;/<span class="hljs-symbol">&amp;gt;</span><br><br><br>    <span class="hljs-symbol">&amp;lt;</span>context:component-scan base-package=&quot;com.ydlclass.listener&quot; /<span class="hljs-symbol">&amp;gt;</span><br><br>    <span class="hljs-symbol">&amp;lt;</span>!--定义监听器容器  添加  acknowledge=&quot;manual&quot; 手动--<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:listener-container connection-factory=&quot;connectionFactory&quot; acknowledge=&quot;manual&quot;<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>rabbit:listener ref=&quot;ackListener&quot; queue-names=&quot;test_queue_confirm&quot;/<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/rabbit:listener-container<span class="hljs-symbol">&amp;gt;</span><br><br><span class="hljs-symbol">&amp;lt;</span>/beans<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>编写ackListener 监听类实现ChannelAwareMessageListener接口</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydlclass.listener;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> org.springframework.amqp.core.Message;<br><span class="hljs-keyword">import</span> org.springframework.amqp.core.MessageListener;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.listener.api.ChannelAwareMessageListener;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Consumer ACK机制：</span><br><span class="hljs-comment"> *  1. 设置手动签收。acknowledge=&quot;manual&quot;</span><br><span class="hljs-comment"> *  2. 让监听器类实现ChannelAwareMessageListener接口</span><br><span class="hljs-comment"> *  3. 如果消息成功处理，则调用channel的 basicAck()签收</span><br><span class="hljs-comment"> *  4. 如果消息处理失败，则调用channel的basicNack()拒绝签收，broker重新发送给consumer</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AckListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ChannelAwareMessageListener</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(Message message, Channel channel)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">deliveryTag</span> <span class="hljs-operator">=</span> message.getMessageProperties().getDeliveryTag();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//1.接收转换消息</span><br>            System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(message.getBody()));<br><br>            <span class="hljs-comment">//2. 处理业务逻辑</span><br>            System.out.println(<span class="hljs-string">&quot;处理业务逻辑...&quot;</span>);<br>            <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>/<span class="hljs-number">0</span>;<span class="hljs-comment">//出现错误</span><br>            <span class="hljs-comment">//3. 手动签收</span><br>            channel.basicAck(deliveryTag,<span class="hljs-literal">true</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-comment">//e.printStackTrace();</span><br><br>            <span class="hljs-comment">//4.拒绝签收</span><br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">            第三个参数：requeue：重回队列。如果设置为true，则消息重新回到queue，broker会重新发送该消息给消费端</span><br><span class="hljs-comment">             */</span><br>            channel.basicNack(deliveryTag,<span class="hljs-literal">true</span>,<span class="hljs-literal">true</span>);<br>            <span class="hljs-comment">// 了解</span><br>            <span class="hljs-comment">//channel.basicReject(deliveryTag,true);</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>编写测试类，启动容器监听MQ队列 com.ydlclass.rabbimq</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RunWith(SpringJUnit4ClassRunner.class)</span><br><span class="hljs-meta">@ContextConfiguration(locations = &quot;classpath:spring-rabbitmq-consumer.xml&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsumerTest</span> &#123;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><figure><img class="lazy" alt="image-20220714135710130" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220714135710130-04d1062b.png" tabindex="0"/><figcaption>image-20220714135710130</figcaption></figure><h4 id="_2-小结" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-小结">#</a> （2）小结</h4><ul><li><p>在rabbit:listener-container标签中设置acknowledge属性，设置ack方式 none：自动确认，manual：手动确认</p></li><li><p>如果在消费端没有出现异常，则调用channel.basicAck(deliveryTag,false);方法确认签收消息</p></li><li><p>如果出现异常，则在catch中调用 basicNack或 basicReject，拒绝消息，让MQ重新发送消息。</p></li></ul><blockquote><p>如何保证消息的高可靠性传输？</p><p>1.持久化</p><p>• exchange要持久化</p><p>• queue要持久化</p><p>• message要持久化</p><p>2.生产方确认Confirm</p><p>3.消费方确认Ack</p><p>4.Broker高可用</p></blockquote><h3 id="_3、消费端限流" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、消费端限流">#</a> 3、消费端限流</h3><figure><img class="lazy" alt="1569164559749" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1569164559749-062868bd.png" tabindex="0"/><figcaption>1569164559749</figcaption></figure><p>如上图所示：如果在A系统中需要维护相关的业务功能，可能需要将A系统的服务停止，那么这个时候消息的生产者还是一直会向MQ中发送待处理的消息，消费者此时服务已经关闭，导致大量的消息都会在MQ中累积。如果当A系统成功启动后，默认情况下消息的消费者会一次性将MQ中累积的大量的消息全部拉取到自己的服务，导致服务在短时间内会处理大量的业务，可能会导致系统服务的崩溃。 所以消费端限流是非常有必要的。</p><p>可以通过MQ中的 listener-container 配置属性 perfetch = 1,表示消费端每次从mq拉去一条消息来消费，直到手动确认消费完毕后，才会继续拉去下一条消息。</p><h4 id="_1-代码实现-1" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-代码实现-1">#</a> （1）代码实现</h4><ol><li><p>编写 QosListener 监听类，保证当前的监听类消息处理机制是 ACK 为手动方式</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QosListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ChannelAwareMessageListener</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(Message message, Channel channel)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>        <span class="hljs-comment">//1.获取消息</span><br>        System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(message.getBody()));<br>        <span class="hljs-comment">//2. 处理业务逻辑</span><br>        <span class="hljs-comment">//3. 签收</span><br>        channel.basicAck(message.getMessageProperties().getDeliveryTag(),<span class="hljs-literal">true</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>在配置文件的 listener-container 配置属性中添加配置</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>rabbit:listener-container connection-factory=&quot;connectionFactory&quot; acknowledge=&quot;manual&quot; prefetch=&quot;1&quot; <span class="hljs-symbol">&amp;gt;</span><br><br><span class="hljs-symbol">&amp;lt;</span>rabbit:listener ref=&quot;qosListener&quot; queue-names=&quot;test_queue_confirm&quot;/<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>配置说明：</p><p>perfetch = 1,表示消费端每次从mq拉去一条消息来消费，直到手动确认消费完毕后，才会继续拉去下一条消息。</p></blockquote></li></ol><p>3.生产者，连发10条消息.</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">@Test<br>public void testSend() &#123;<br>    for (int i = 0; i &amp;lt; 10; i++) &#123;<br>        //发送消息<br>        rabbitTemplate.convertAndSend(&quot;test_exchange_confirm&quot;, &quot;confirm&quot;, &quot;message confirm....&quot;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-小结-1" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-小结-1">#</a> （2）小结</h4><ul><li><p>在<a href="rabbit:listener-container">rabbit:listener-container</a> 中配置 prefetch属性设置消费端一次拉取多少消息</p></li><li><p>消费端的确认模式一定为手动确认。acknowledge="manual"</p></li></ul><h3 id="_4、ttl" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4、ttl">#</a> 4、TTL</h3><p>设置队列参数、交换机参数、发消息都可以用页面。</p><p>也能用代码。</p><p>TTL 全称 Time To Live（存活时间/过期时间）。当消息到达存活时间后，还没有被消费，会被自动清除。</p><p>RabbitMQ可以对消息设置过期时间，也可以对整个队列（Queue）设置过期时间。</p><figure><img class="lazy" alt="1569166173852" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1569166173852-583364b2.png" tabindex="0"/><figcaption>1569166173852</figcaption></figure><p>可以在RabbitMQ管理控制台设置过期时间，此处不做重点讲解。</p><p><strong>一起做一下</strong>：</p><p>创建队列 test_queue_ttl 设置ttl为10秒</p><figure><img class="lazy" alt="image-20200321000505022" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20200321000505022-3d21d748.png" tabindex="0"/><figcaption>image-20200321000505022</figcaption></figure><p>创建交换机test_exchange_ttl 绑定 队列</p><figure><img class="lazy" alt="image-20200321000710192" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20200321000710192-0dad458c.png" tabindex="0"/><figcaption>image-20200321000710192</figcaption></figure><figure><img class="lazy" alt="image-20220714141856963" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220714141856963-34e53d20.png" tabindex="0"/><figcaption>image-20220714141856963</figcaption></figure><p>向交换机发一个消息</p><figure><img class="lazy" alt="image-20220714142043712" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220714142043712-98552c4c.png" tabindex="0"/><figcaption>image-20220714142043712</figcaption></figure><p>查看队列消息，过10秒删除</p><figure><img class="lazy" alt="image-20220714142021614" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220714142021614-3081f2f6.png" tabindex="0"/><figcaption>image-20220714142021614</figcaption></figure><h4 id="_1-代码实现-2" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-代码实现-2">#</a> （1）代码实现</h4><h5 id="a、设置队列的过期时间" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#a、设置队列的过期时间">#</a> a、设置队列的过期时间</h5><ol><li><p>在消息的生产方中，在 spring-rabbitmq-producer.xml 配置文件中，添加如下配置：</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>!--ttl--<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>rabbit:queue name=&quot;test_queue_ttl&quot; id=&quot;test_queue_ttl&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>!--设置queue的参数--<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:queue-arguments<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>!--x-message-ttl指队列的过期时间--<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>entry key=&quot;x-message-ttl&quot; value=&quot;10000&quot; value-type=&quot;java.lang.Integer&quot;/<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/rabbit:queue-arguments<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/rabbit:queue<span class="hljs-symbol">&amp;gt;</span><br><br><span class="hljs-symbol">&amp;lt;</span>rabbit:topic-exchange name=&quot;test_exchange_ttl&quot; <span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:bindings<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>rabbit:binding pattern=&quot;ydl.#&quot; queue=&quot;test_queue_ttl&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/rabbit:binding<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/rabbit:bindings<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/rabbit:topic-exchange<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>编写发送消息测试方法</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ttlTest</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &amp;lt; <span class="hljs-number">10</span>; i++) &#123;<br>        rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;test_exchange_ttl&quot;</span>,<span class="hljs-string">&quot;ydl.itlils&quot;</span>,<span class="hljs-string">&quot;hello ttl&quot;</span>+i);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试结果：当消息发送成功后，过10s后在RabbitMQ的管理控制台会看到消息会自动删除。</p></li></ol><figure><img class="lazy" alt="image-20220714142521691" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220714142521691-9ddf683b.png" tabindex="0"/><figcaption>image-20220714142521691</figcaption></figure><h5 id="b、设置单个消息的过期时间" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#b、设置单个消息的过期时间">#</a> b、设置单个消息的过期时间</h5><p>编写代码测试，并且设置队列的过期时间为10s， 单个消息的过期时间为5s</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testTtl2</span><span class="hljs-params">()</span> &#123;<br><br>    <span class="hljs-comment">// 消息后处理对象，设置一些消息的参数信息</span><br>    <span class="hljs-type">MessagePostProcessor</span> <span class="hljs-variable">messagePostProcessor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessagePostProcessor</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Message <span class="hljs-title function_">postProcessMessage</span><span class="hljs-params">(Message message)</span> <span class="hljs-keyword">throws</span> AmqpException &#123;<br>            <span class="hljs-comment">//1.设置message的信息</span><br>            message.getMessageProperties().setExpiration(<span class="hljs-string">&quot;5000&quot;</span>);<span class="hljs-comment">//消息的过期时间</span><br>            <span class="hljs-comment">//2.返回该消息</span><br>            <span class="hljs-keyword">return</span> message;<br>        &#125;<br>    &#125;;<br><br>    <span class="hljs-comment">//消息单独过期</span><br>    rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;test_exchange_ttl&quot;</span>,<br>            <span class="hljs-string">&quot;ttl.hehe&quot;</span>, <span class="hljs-string">&quot;message ttl....&quot;</span>,messagePostProcessor);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &amp;lt; <span class="hljs-number">10</span>; i++) &#123;<br>        <span class="hljs-keyword">if</span>(i == <span class="hljs-number">5</span>)&#123;<br>            <span class="hljs-comment">//消息单独过期</span><br>            rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;test_exchange_ttl&quot;</span>, <span class="hljs-string">&quot;ttl.hehe&quot;</span>, <span class="hljs-string">&quot;message ttl....&quot;</span>,messagePostProcessor);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-comment">//不过期的消息</span><br>            rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;test_exchange_ttl&quot;</span>, <span class="hljs-string">&quot;ttl.hehe&quot;</span>, <span class="hljs-string">&quot;message ttl....&quot;</span>);<br><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>如果设置了消息的过期时间，也设置了队列的过期时间，它以时间短的为准。</p><ul><li>队列过期后，会将队列所有消息全部移除。</li><li>消息过期后，只有消息在队列顶端，才会判断其是否过期(移除掉)</li></ul></blockquote><p>5s</p><figure><img class="lazy" alt="image-20220714143016960" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220714143016960-7b954414.png" tabindex="0"/><figcaption>image-20220714143016960</figcaption></figure><p>20s</p><figure><img class="lazy" alt="image-20220714143257013" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220714143257013-53b83dc2.png" tabindex="0"/><figcaption>image-20220714143257013</figcaption></figure><p>5 10 5 10</p><figure><img class="lazy" alt="image-20220714143611629" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220714143611629-d8ef4d4d.png" tabindex="0"/><figcaption>image-20220714143611629</figcaption></figure><h4 id="_2-小结-2" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-小结-2">#</a> （2）小结</h4><ul><li><p>设置队列过期时间使用参数：x-message-ttl，单位：ms(毫秒)，会对整个队列消息统一过期。</p></li><li><p>设置消息过期时间使用参数：expiration。单位：ms(毫秒)，当该消息在队列头部时（消费时），会单独判断这一消息是否过期。</p></li><li><p>如果两者都进行了设置，以时间短的为准。</p></li></ul><h3 id="_5、死信队列" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_5、死信队列">#</a> 5、死信队列</h3><p>死信队列，英文缩写：DLX 。Dead Letter Exchange（死信交换机），当消息成为Dead message后，可以被重新发送到另一个交换机，这个交换机就是DLX。</p><figure><img class="lazy" alt="1569167524589" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1569167524589-e80fd907.png" tabindex="0"/><figcaption>1569167524589</figcaption></figure><p><strong>消息成为死信的三种情况：</strong></p><ol><li><p>队列消息长度到达限制；</p></li><li><p>消费者拒接消费消息，basicNack/basicReject,并且不把消息重新放入原目标队列,requeue=false；</p></li><li><p>原队列存在消息过期设置，消息到达超时时间未被消费；</p></li></ol><p><strong>队列绑定死信交换机：</strong></p><p>给队列设置参数： x-dead-letter-exchange 和 x-dead-letter-routing-key</p><figure><img class="lazy" alt="1569167616750" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1569167616750-2d418fa9.png" tabindex="0"/><figcaption>1569167616750</figcaption></figure><h4 id="_1-代码实现-3" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-代码实现-3">#</a> （1）代码实现</h4><ol><li><p>在消息的生产方中，在 spring-rabbitmq-producer.xml 配置文件中，添加如下配置：</p><ul><li><p>声明正常的队列(test_queue_dlx)和交换机(test_exchange_dlx)</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>rabbit:queue name=&quot;test_queue_dlx&quot; id=&quot;test_queue_dlx&quot;<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/rabbit:queue<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>rabbit:topic-exchange name=&quot;test_exchange_dlx&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:bindings<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>rabbit:binding pattern=&quot;test.dlx.#&quot; queue=&quot;test_queue_dlx&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/rabbit:binding<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/rabbit:bindings<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/rabbit:topic-exchange<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>声明死信队列(queue_dlx)和死信交换机(exchange_dlx)</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>rabbit:queue name=&quot;queue_dlx&quot; id=&quot;queue_dlx&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/rabbit:queue<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>rabbit:topic-exchange name=&quot;exchange_dlx&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:bindings<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>rabbit:binding pattern=&quot;dlx.#&quot; queue=&quot;queue_dlx&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/rabbit:binding<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/rabbit:bindings<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/rabbit:topic-exchange<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>正常队列绑定死信交换机，并设置相关参数信息</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>rabbit:queue name=&quot;test_queue_dlx&quot; id=&quot;test_queue_dlx&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>!--3. 正常队列绑定死信交换机--<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:queue-arguments<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>!--3.1 x-dead-letter-exchange：死信交换机名称--<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>entry key=&quot;x-dead-letter-exchange&quot; value=&quot;exchange_dlx&quot; /<span class="hljs-symbol">&amp;gt;</span><br><br>        <span class="hljs-symbol">&amp;lt;</span>!--3.2 x-dead-letter-routing-key：发送给死信交换机的routingkey--<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>entry key=&quot;x-dead-letter-routing-key&quot; value=&quot;dlx.hehe&quot; /<span class="hljs-symbol">&amp;gt;</span><br><br>        <span class="hljs-symbol">&amp;lt;</span>!--4.1 设置队列的过期时间 ttl--<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>entry key=&quot;x-message-ttl&quot; value=&quot;10000&quot; value-type=&quot;java.lang.Integer&quot; /<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>!--4.2 设置队列的长度限制 max-length --<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>entry key=&quot;x-max-length&quot; value=&quot;10&quot; value-type=&quot;java.lang.Integer&quot; /<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/rabbit:queue-arguments<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/rabbit:queue<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>rabbit:topic-exchange name=&quot;test_exchange_dlx&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:bindings<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>rabbit:binding pattern=&quot;test.dlx.#&quot; queue=&quot;test_queue_dlx&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/rabbit:binding<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/rabbit:bindings<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/rabbit:topic-exchange<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li><p>编写测试方法</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 发送测试死信消息：</span><br><span class="hljs-comment"> *  1. 过期时间</span><br><span class="hljs-comment"> *  2. 长度限制</span><br><span class="hljs-comment"> *  3. 消息拒收</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDlx</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">//1. 测试过期时间，死信消息</span><br>    rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;test_exchange_dlx&quot;</span>,<br>                                  <span class="hljs-string">&quot;test.dlx.haha&quot;</span>,<span class="hljs-string">&quot;我是一条消息，我会死吗？&quot;</span>);<br><br>    <span class="hljs-comment">//2. 测试长度限制后，消息死信</span><br>   <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &amp;lt; <span class="hljs-number">20</span>; i++) &#123;<br>        rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;test_exchange_dlx&quot;</span>,<br>                                      <span class="hljs-string">&quot;test.dlx.haha&quot;</span>,<span class="hljs-string">&quot;我是一条消息，我会死吗？&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//3. 测试消息拒收</span><br>    rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;test_exchange_dlx&quot;</span>,<br>                                  <span class="hljs-string">&quot;test.dlx.haha&quot;</span>,<span class="hljs-string">&quot;我是一条消息，我会死吗？&quot;</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><p>3消息拒绝接受消费者增加监听</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydlclass.listener;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * creste by ydlclass.itcast</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> org.springframework.amqp.core.Message;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.listener.api.ChannelAwareMessageListener;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Consumer ACK机制：</span><br><span class="hljs-comment"> *  1. 设置手动签收。acknowledge=&quot;manual&quot;</span><br><span class="hljs-comment"> *  2. 让监听器类实现ChannelAwareMessageListener接口</span><br><span class="hljs-comment"> *  3. 如果消息成功处理，则调用channel的 basicAck()签收</span><br><span class="hljs-comment"> *  4. 如果消息处理失败，则调用channel的basicNack()拒绝签收，broker重新发送给consumer</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DlxListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ChannelAwareMessageListener</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(Message message, Channel channel)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">deliveryTag</span> <span class="hljs-operator">=</span> message.getMessageProperties().getDeliveryTag();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//1.接收转换消息</span><br>            System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(message.getBody()));<br><br>            <span class="hljs-comment">//2. 处理业务逻辑</span><br>            System.out.println(<span class="hljs-string">&quot;处理业务逻辑...&quot;</span>);<br>            <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>/<span class="hljs-number">0</span>;<span class="hljs-comment">//出现错误</span><br>            <span class="hljs-comment">//3. 手动签收</span><br>            channel.basicAck(deliveryTag,<span class="hljs-literal">true</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-comment">//e.printStackTrace();</span><br>            System.out.println(<span class="hljs-string">&quot;拒绝接受&quot;</span>);<br>            <span class="hljs-comment">//4.拒绝签收</span><br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">            第三个参数：requeue：重回队列。如果设置为true，则消息重新回到queue，broker会重新发送该消息给消费端</span><br><span class="hljs-comment">             */</span><br>            channel.basicNack(deliveryTag,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>);<br>            <span class="hljs-comment">// 了解</span><br>            <span class="hljs-comment">//channel.basicReject(deliveryTag,true);</span><br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置文件</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>rabbit:listener ref=&quot;dlxListener&quot; queue-names=&quot;test_queue_dlx&quot;/<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><h4 id="_2-小结-3" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-小结-3">#</a> （2）小结</h4><ol><li><p>死信交换机和死信队列和普通的没有区别</p></li><li><p>当消息成为死信后，如果该队列绑定了死信交换机，则消息会被死信交换机重新路由到死信队列</p></li><li><p>消息成为死信的三种情况：</p><ul><li><p>队列消息长度到达限制；</p></li><li><p>消费者拒接消费消息，并且不重回队列；</p></li><li><p>原队列存在消息过期设置，消息到达超时时间未被消费；</p></li></ul></li></ol><h3 id="_6、延迟队列-重点" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_6、延迟队列-重点">#</a> 6、延迟队列-重点</h3><p>延迟队列，即消息进入队列后不会立即被消费，只有到达指定时间后，才会被消费。</p><p>提出需求：</p><ol><li><p>下单后，30分钟未支付，取消订单，回滚库存。</p></li><li><p>新用户注册成功7天后，发送短信问候。</p></li></ol><p>实现方式：</p><ol><li><p>定时器（不优雅！）</p></li><li><p>延迟队列</p></li></ol><figure><img class="lazy" alt="1569168202661" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1569168202661-0a8e43b4.png" tabindex="0"/><figcaption>1569168202661</figcaption></figure><p>注意：在RabbitMQ中并未提供延迟队列功能。</p><p>但是可以使用：<strong>TTL+死信队列</strong> 组合实现延迟队列的效果。</p><figure><img class="lazy" alt="1569168255196" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1569168255196-259b14b4.png" tabindex="0"/><figcaption>1569168255196</figcaption></figure><h4 id="_1-代码实现-4" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-代码实现-4">#</a> （1）代码实现</h4><ol><li><p>在消息的生产方中，在 spring-rabbitmq-producer.xml 配置文件中，添加如下配置：</p><div class="language-xml line-numbers-mode" data-ext="xml"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight xml"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-symbol">&amp;lt;</span>!-- 1. 定义正常交换机（order_exchange）和队列(order_queue)--<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>rabbit:queue id=&quot;order_queue&quot; name=&quot;order_queue&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>!-- 3. 绑定，设置正常队列过期时间为30分钟--<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:queue-arguments<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>entry key=&quot;x-dead-letter-exchange&quot; value=&quot;order_exchange_dlx&quot; /<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>entry key=&quot;x-dead-letter-routing-key&quot; value=&quot;dlx.order.cancel&quot; /<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>entry key=&quot;x-message-ttl&quot; value=&quot;10000&quot; value-type=&quot;java.lang.Integer&quot; /<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/rabbit:queue-arguments<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/rabbit:queue<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>rabbit:topic-exchange name=&quot;order_exchange&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:bindings<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>rabbit:binding pattern=&quot;order.#&quot; queue=&quot;order_queue&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/rabbit:binding<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/rabbit:bindings<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/rabbit:topic-exchange<span class="hljs-symbol">&amp;gt;</span><br><br><span class="hljs-symbol">&amp;lt;</span>!--  2. 定义死信交换机（order_exchange_dlx）和队列(order_queue_dlx)--<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>rabbit:queue id=&quot;order_queue_dlx&quot; name=&quot;order_queue_dlx&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/rabbit:queue<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>rabbit:topic-exchange name=&quot;order_exchange_dlx&quot;<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>rabbit:bindings<span class="hljs-symbol">&amp;gt;</span><br>        <span class="hljs-symbol">&amp;lt;</span>rabbit:binding pattern=&quot;dlx.order.#&quot; queue=&quot;order_queue_dlx&quot;<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>/rabbit:binding<span class="hljs-symbol">&amp;gt;</span><br>    <span class="hljs-symbol">&amp;lt;</span>/rabbit:bindings<span class="hljs-symbol">&amp;gt;</span><br><span class="hljs-symbol">&amp;lt;</span>/rabbit:topic-exchange<span class="hljs-symbol">&amp;gt;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>编写测试方法</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDelay</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-comment">//1.发送订单消息。 将来是在订单系统中，下单成功后，发送消息</span><br>    rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;order_exchange&quot;</span>,<br>                                  <span class="hljs-string">&quot;order.msg&quot;</span>,<span class="hljs-string">&quot;订单信息：id=1,time=2022年&quot;</span>);<br><br>    <span class="hljs-comment">//2.打印倒计时10秒</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>; i &amp;gt; <span class="hljs-number">0</span> ; i--) &#123;<br>        System.out.println(i+<span class="hljs-string">&quot;...&quot;</span>);<br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><p>3消费者</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydlclass.listener;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * creste by ydlclass.itcast</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> org.springframework.amqp.core.Message;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.listener.api.ChannelAwareMessageListener;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Consumer ACK机制：</span><br><span class="hljs-comment"> *  1. 设置手动签收。acknowledge=&quot;manual&quot;</span><br><span class="hljs-comment"> *  2. 让监听器类实现ChannelAwareMessageListener接口</span><br><span class="hljs-comment"> *  3. 如果消息成功处理，则调用channel的 basicAck()签收</span><br><span class="hljs-comment"> *  4. 如果消息处理失败，则调用channel的basicNack()拒绝签收，broker重新发送给consumer</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ChannelAwareMessageListener</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(Message message, Channel channel)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">deliveryTag</span> <span class="hljs-operator">=</span> message.getMessageProperties().getDeliveryTag();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//1.接收转换消息</span><br>            System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(message.getBody()));<br><br>            <span class="hljs-comment">//2. 处理业务逻辑</span><br>            System.out.println(<span class="hljs-string">&quot;处理业务逻辑...&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;查询数据库。。。&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;查看支付状态。。。&quot;</span>);<br><br>            <span class="hljs-comment">//3. 手动签收</span><br>            channel.basicAck(deliveryTag,<span class="hljs-literal">true</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-comment">//e.printStackTrace();</span><br>            System.out.println(<span class="hljs-string">&quot;拒绝接受&quot;</span>);<br>            <span class="hljs-comment">//4.拒绝签收</span><br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">            第三个参数：requeue：重回队列。如果设置为true，则消息重新回到queue，broker会重新发送该消息给消费端</span><br><span class="hljs-comment">             */</span><br>            channel.basicNack(deliveryTag,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>);<br>            <span class="hljs-comment">// 了解</span><br>            <span class="hljs-comment">//channel.basicReject(deliveryTag,true);</span><br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置文件</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">&amp;lt;rabbit:listener ref=&quot;orderListener&quot; queue-names=&quot;order_queue_dlx&quot;/&amp;gt;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><h4 id="_2-小结-4" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-小结-4">#</a> （2） 小结</h4><ol><li><p>延迟队列 指消息进入队列后，可以被延迟一定时间，再进行消费。</p></li><li><p>RabbitMQ没有提供延迟队列功能，但是可以使用 ： <strong>TTL + DLX</strong> 来实现延迟队列效果。</p></li></ol><h3 id="_7、日志与监控-了解" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_7、日志与监控-了解">#</a> 7、日志与监控-了解</h3><h4 id="_1-rabbitmq日志" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-rabbitmq日志">#</a> （1）RabbitMQ日志</h4><p>RabbitMQ默认日志存放路径：</p><p>​ Linux 下/var /log/rabbitmq/rabbit@xxx.log</p><p>​ windows下C:\Users\Administrator\AppData\Roaming\RabbitMQ\log</p><p>RabbitMQ 日志所在的目录：</p><figure><img class="lazy" alt="1569168718549" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1569168718549-49512116.png" tabindex="0"/><figcaption>1569168718549</figcaption></figure><p>RabbitMQ日志详细信息：</p><p>日志包含了RabbitMQ的版本号、Erlang的版本号、RabbitMQ服务节点名称、cookie的hash值、RabbitMQ配置文件地址、内存限制、磁盘限制、默认账户guest的创建以及权限配置等等。</p><figure><img class="lazy" alt="image-20220714151931414" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220714151931414-b29a5e65.png" tabindex="0"/><figcaption>image-20220714151931414</figcaption></figure><h4 id="_2-web管控台监控" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-web管控台监控">#</a> （2）web管控台监控</h4><p><strong>注意windows下</strong>：进入sbin目录，命令后加“.bat”。如rabbitmqctl.bat</p><p>直接访问当前的IP:15672，输入用户名和密码（默认是 guest），就可以查看RabbitMQ的管理控制台。当然也可通过命令的形式来查看。如下：</p><ul><li><p>查看队列：rabbitmqctl list_queues</p><p>对应管理控制台的页面如下：</p><figure><img class="lazy" alt="image-20220714152127778" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/image-20220714152127778-fc84dbcc.png" tabindex="0"/><figcaption>image-20220714152127778</figcaption></figure></li><li><p>查看用户： rabbitmqctl list_users</p></li><li><p>查看连接：rabbitmqctl list_connections</p></li></ul><blockquote><p>其它相关命令（了解）：</p><p>查看exchanges：rabbitmqctl list_exchanges</p><p>查看消费者信息：rabbitmqctl list_consumers</p><p>查看环境变量：rabbitmqctl environment</p><p>查看未被确认的队列：rabbitmqctl list_queues name messages_unacknowledged</p><p>查看单个队列的内存使用：rabbitmqctl list_queues name memory</p><p>查看准备就绪的队列：rabbitmqctl list_queues name messages_ready</p></blockquote><h3 id="_8、消息追踪-了解" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_8、消息追踪-了解">#</a> 8、消息追踪-了解</h3><p>在使用任何消息中间件的过程中，难免会出现某条消息异常丢失的情况。对于RabbitMQ而言，可能是因为生产者或消费者与RabbitMQ断开了连接，而它们与RabbitMQ又采用了不同的确认机制；也有可能是因为交换器与队列之间不同的转发策略；甚至是交换器并没有与任何队列进行绑定，生产者又不感知或者没有采取相应的措施；另外RabbitMQ本身的集群策略也可能导致消息的丢失。这个时候就需要有一个较好的机制跟踪记录消息的投递过程，以此协助开发和运维人员进行问题的定位。</p><p>在RabbitMQ中可以使用Firehose和rabbitmq_tracing插件功能来实现消息追踪。</p><h4 id="_1-消息追踪-firehose" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-消息追踪-firehose">#</a> （1）消息追踪-Firehose</h4><p>firehose的机制是将生产者投递给rabbitmq的消息，rabbitmq投递给消费者的消息按照指定的格式发送到默认的exchange上。这个默认的exchange的名称为 <strong>amq.rabbitmq.trace</strong>，它是一个<strong>topic</strong>类型的<strong>exchange</strong>。发送到这个exchange上的消息的routing key为 publish.exchangename 和 deliver.queuename。其中exchangename和queuename为实际exchange和queue的名称，分别对应生产者投递到exchange的消息，和消费者从queue上获取的消息。</p><figure><img class="lazy" alt="1569201204959" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1569201204959-dde46343.png" tabindex="0"/><figcaption>1569201204959</figcaption></figure><p><strong>注意：打开 trace 会影响消息写入功能，适当打开后请关闭。</strong></p><p>rabbitmqctl trace_on：开启Firehose命令</p><p><strong>消息追踪验证：</strong></p><ol><li><p>创建一个队列 <strong>test_trace</strong>，并将当前的队列绑定到 <strong>amq.rabbitmq.trace</strong> 交换机上，设置RoutingKey为：<strong>#</strong></p><figure><img class="lazy" alt="1569201672175" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1569201672175-736f2200.png" tabindex="0"/><figcaption>1569201672175</figcaption></figure></li><li><p>未开启消息追踪之前，我们发送一个消息</p><figure><img class="lazy" alt="1569201776723" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1569201776723-7acd3ef5.png" tabindex="0"/><figcaption>1569201776723</figcaption></figure><p>当前消息发送成功后，在控制台我们可以看到当前消息的具体信息</p></li><li><p>设置<strong>开启消息追踪</strong>，在发送一条消息</p><figure><img class="lazy" alt="1569201317013" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1569201317013-397a5f8c.png" tabindex="0"/><figcaption>1569201317013</figcaption></figure><p>完整的消息内容：</p><figure><img class="lazy" alt="1569202059745" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1569202059745-3d93708c.png" tabindex="0"/><figcaption>1569202059745</figcaption></figure></li></ol><p>我们发现当前消息也正常存在，并且开启消息追踪后，会多出一条消息是 <strong>amq.rabbitmq.trace</strong> 交换机发给当前队列的消息，消息中的内容是比较完整的。</p><blockquote><p>建议：在开发阶段我们可以开启消息追踪，在实际生产环境建议将其关闭</p><p>rabbitmqctl trace_off：关闭Firehose命令</p></blockquote><h4 id="_2-消息追踪-rabbitmq-tracing" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-消息追踪-rabbitmq-tracing">#</a> （2） 消息追踪-rabbitmq_tracing</h4><p>rabbitmq_tracing和Firehose在实现上如出一辙，只不过rabbitmq_tracing的方式比Firehose多了一层GUI的包装，更容易使用和管理。</p><p>启用插件：rabbitmq-plugins enable rabbitmq_tracing</p><figure><img class="lazy" alt="1569202861087" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1569202861087-f0450a8a.png" tabindex="0"/><figcaption>1569202861087</figcaption></figure><p>发送消息成功后，我们点击日志文件，要求输入RabbitMQ的登录用户名和密码。</p><figure><img class="lazy" alt="1569203000215" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1569203000215-8bca3152.png" tabindex="0"/><figcaption>1569203000215</figcaption></figure><blockquote><p>建议：在开发阶段我们可以开启消息追踪插件，在实际生产环境不建议建议开启，除非是非常特殊的业务场景，大家根据实际情况选择开启即可。</p></blockquote><h2 id="第二章-rabbitmq应用问题-面试" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第二章-rabbitmq应用问题-面试">#</a> 第二章 RabbitMQ应用问题-面试</h2><h3 id="_1、消息可靠性保障" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、消息可靠性保障">#</a> 1、消息可靠性保障</h3><p>提出需求：如何能够保证消息的 100% 发送成功？</p><p>首先大家要明确任何一个系统都不能保证消息的 100% 投递成功，我们是可以保证消息以最高最可靠的发送给目标方。</p><p>在RabbitMQ中采用 <strong>消息补充机制</strong> 来保证消息的可靠性</p><figure><img class="lazy" alt="1569203830553" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1569203830553-12ba52fc.png" tabindex="0"/><figcaption>1569203830553</figcaption></figure><p>消息勾兑</p><p>步骤分析：</p><p>参与部分：消息生产者、消息消费者、数据库、三个队列（Q1、Q2、Q3）、交换机、回调检查服务、定时检查服务</p><ol><li>消息的生产者将业务数据存到数据库中</li><li>发送消息给 队列Q1</li><li>消息的生产者等待一定的时间后，在发送一个延迟消息给队列 Q3</li><li>消息的消费方监听 Q1 队列消息，成功接收后</li><li>消息的消费方会 发送 一条确认消息给 队列Q2</li><li>回调检查服务监听 队列Q2 发送的确认消息</li><li>回调检查服务接收到确认消息后，将消息写入到 消息的数据库表中</li><li>回调检查服务同时也会监听 队列Q3延迟消息， 如果接收到消息会和数据库比对消息的唯一标识</li><li>如果发现没有接收到确认消息，那么回调检查服务就会远程调用 消息生产者，重新发送消息</li><li>重新执行 2-7 步骤，保证消息的可靠性传输</li><li>如果发送消息和延迟消息都出现异常，定时检查服务会监控 消息库中的消息数据，如果发现不一致的消息然后远程调用消息的生产者重新发送消息。</li></ol><h3 id="_2、-消息幂等性处理" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、-消息幂等性处理">#</a> 2、 消息幂等性处理</h3><p>幂等性指一次和多次请求某一个资源，对于资源本身应该具有同样的结果。也就是说，其任意多次执行对资源本身所产生的影响均与一次执行的影响相同。</p><p>在MQ中指，消费多条相同的消息，得到与消费该消息一次相同的结果。</p><p>在本教程中使用 <strong>乐观锁机制</strong> 保证消息的幂等操作</p><figure><img class="lazy" alt="1569210134160" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1569210134160-a4f5d228.png" tabindex="0"/><figcaption>1569210134160</figcaption></figure><h3 id="_3、rabbitmq集群搭建-运维" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、rabbitmq集群搭建-运维">#</a> 3、RabbitMQ集群搭建-运维</h3><p>摘要：实际生产应用中都会采用消息队列的集群方案，如果选择RabbitMQ那么有必要了解下它的集群方案原理</p><p>一般来说，如果只是为了学习RabbitMQ或者验证业务工程的正确性那么在本地环境或者测试环境上使用其单实例部署就可以了，但是出于MQ中间件本身的可靠性、并发性、吞吐量和消息堆积能力等问题的考虑，在生产环境上一般都会考虑使用RabbitMQ的集群方案。</p><h4 id="_1-集群方案的原理" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-集群方案的原理">#</a> （1） 集群方案的原理</h4><p>RabbitMQ这款消息队列中间件产品本身是基于Erlang编写，Erlang语言天生具备分布式特性（通过同步Erlang集群各节点的magic cookie来实现）。因此，RabbitMQ天然支持Clustering。这使得RabbitMQ本身不需要像ActiveMQ、Kafka那样通过ZooKeeper分别来实现HA方案和保存集群的元数据。集群是保证可靠性的一种方式，同时可以通过水平扩展以达到增加消息吞吐量能力的目的。</p><figure><img class="lazy" alt="1565245219265" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1566073768274-526c9994.png" tabindex="0"/><figcaption>1565245219265</figcaption></figure><h4 id="_2-单机多实例部署" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-单机多实例部署">#</a> （2）单机多实例部署</h4><p>由于某些因素的限制，有时候你不得不在一台机器上去搭建一个rabbitmq集群，这个有点类似zookeeper的单机版。真实生成环境还是要配成多机集群的。有关怎么配置多机集群的可以参考其他的资料，这里主要论述如何在单机中配置多个rabbitmq实例。</p><p>主要参考官方文档：<a href="https://www.rabbitmq.com/clustering.html" rel="noopener noreferrer" target="_blank">https://www.rabbitmq.com/clustering.html<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>首先确保RabbitMQ运行没有问题</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@super ~]# rabbitmqctl status<br>Status of node rabbit@super ...<br>[&#123;pid,10232&#125;,<br> &#123;running_applications,<br>     [&#123;rabbitmq_management,<span class="hljs-string">&quot;RabbitMQ Management Console&quot;</span>,<span class="hljs-string">&quot;3.6.5&quot;</span>&#125;,<br>      &#123;rabbitmq_web_dispatch,<span class="hljs-string">&quot;RabbitMQ Web Dispatcher&quot;</span>,<span class="hljs-string">&quot;3.6.5&quot;</span>&#125;,<br>      &#123;webmachine,<span class="hljs-string">&quot;webmachine&quot;</span>,<span class="hljs-string">&quot;1.10.3&quot;</span>&#125;,<br>      &#123;mochiweb,<span class="hljs-string">&quot;MochiMedia Web Server&quot;</span>,<span class="hljs-string">&quot;2.13.1&quot;</span>&#125;,<br>      &#123;rabbitmq_management_agent,<span class="hljs-string">&quot;RabbitMQ Management Agent&quot;</span>,<span class="hljs-string">&quot;3.6.5&quot;</span>&#125;,<br>      &#123;rabbit,<span class="hljs-string">&quot;RabbitMQ&quot;</span>,<span class="hljs-string">&quot;3.6.5&quot;</span>&#125;,<br>      &#123;os_mon,<span class="hljs-string">&quot;CPO  CXC 138 46&quot;</span>,<span class="hljs-string">&quot;2.4&quot;</span>&#125;,<br>      &#123;syntax_tools,<span class="hljs-string">&quot;Syntax tools&quot;</span>,<span class="hljs-string">&quot;1.7&quot;</span>&#125;,<br>      &#123;inets,<span class="hljs-string">&quot;INETS  CXC 138 49&quot;</span>,<span class="hljs-string">&quot;6.2&quot;</span>&#125;,<br>      &#123;amqp_client,<span class="hljs-string">&quot;RabbitMQ AMQP Client&quot;</span>,<span class="hljs-string">&quot;3.6.5&quot;</span>&#125;,<br>      &#123;rabbit_common,[],<span class="hljs-string">&quot;3.6.5&quot;</span>&#125;,<br>      &#123;ssl,<span class="hljs-string">&quot;Erlang/OTP SSL application&quot;</span>,<span class="hljs-string">&quot;7.3&quot;</span>&#125;,<br>      &#123;public_key,<span class="hljs-string">&quot;Public key infrastructure&quot;</span>,<span class="hljs-string">&quot;1.1.1&quot;</span>&#125;,<br>      &#123;asn1,<span class="hljs-string">&quot;The Erlang ASN1 compiler version 4.0.2&quot;</span>,<span class="hljs-string">&quot;4.0.2&quot;</span>&#125;,<br>      &#123;ranch,<span class="hljs-string">&quot;Socket acceptor pool for TCP protocols.&quot;</span>,<span class="hljs-string">&quot;1.2.1&quot;</span>&#125;,<br>      &#123;mnesia,<span class="hljs-string">&quot;MNESIA  CXC 138 12&quot;</span>,<span class="hljs-string">&quot;4.13.3&quot;</span>&#125;,<br>      &#123;compiler,<span class="hljs-string">&quot;ERTS  CXC 138 10&quot;</span>,<span class="hljs-string">&quot;6.0.3&quot;</span>&#125;,<br>      &#123;crypto,<span class="hljs-string">&quot;CRYPTO&quot;</span>,<span class="hljs-string">&quot;3.6.3&quot;</span>&#125;,<br>      &#123;xmerl,<span class="hljs-string">&quot;XML parser&quot;</span>,<span class="hljs-string">&quot;1.3.10&quot;</span>&#125;,<br>      &#123;sasl,<span class="hljs-string">&quot;SASL  CXC 138 11&quot;</span>,<span class="hljs-string">&quot;2.7&quot;</span>&#125;,<br>      &#123;stdlib,<span class="hljs-string">&quot;ERTS  CXC 138 10&quot;</span>,<span class="hljs-string">&quot;2.8&quot;</span>&#125;,<br>      &#123;kernel,<span class="hljs-string">&quot;ERTS  CXC 138 10&quot;</span>,<span class="hljs-string">&quot;4.2&quot;</span>&#125;]&#125;,<br> &#123;os,&#123;unix,linux&#125;&#125;,<br> &#123;erlang_version,<br>     <span class="hljs-string">&quot;Erlang/OTP 18 [erts-7.3] [source] [64-bit] [async-threads:64] [hipe] [kernel-poll:true]\n&quot;</span>&#125;,<br> &#123;memory,<br>     [&#123;total,56066752&#125;,<br>      &#123;connection_readers,0&#125;,<br>      &#123;connection_writers,0&#125;,<br>      &#123;connection_channels,0&#125;,<br>      &#123;connection_other,2680&#125;,<br>      &#123;queue_procs,268248&#125;,<br>      &#123;queue_slave_procs,0&#125;,<br>      &#123;plugins,1131936&#125;,<br>      &#123;other_proc,18144280&#125;,<br>      &#123;mnesia,125304&#125;,<br>      &#123;mgmt_db,921312&#125;,<br>      &#123;msg_index,69440&#125;,<br>      &#123;other_ets,1413664&#125;,<br>      &#123;binary,755736&#125;,<br>      &#123;code,27824046&#125;,<br>      &#123;atom,1000601&#125;,<br>      &#123;other_system,4409505&#125;]&#125;,<br> &#123;alarms,[]&#125;,<br> &#123;listeners,[&#123;clustering,25672,<span class="hljs-string">&quot;::&quot;</span>&#125;,&#123;amqp,5672,<span class="hljs-string">&quot;::&quot;</span>&#125;]&#125;,<br> &#123;vm_memory_high_watermark,0.4&#125;,<br> &#123;vm_memory_limit,411294105&#125;,<br> &#123;disk_free_limit,50000000&#125;,<br> &#123;disk_free,13270233088&#125;,<br> &#123;file_descriptors,<br>     [&#123;total_limit,924&#125;,&#123;total_used,6&#125;,&#123;sockets_limit,829&#125;,&#123;sockets_used,0&#125;]&#125;,<br> &#123;processes,[&#123;<span class="hljs-built_in">limit</span>,1048576&#125;,&#123;used,262&#125;]&#125;,<br> &#123;run_queue,0&#125;,<br> &#123;<span class="hljs-built_in">uptime</span>,43651&#125;,<br> &#123;kernel,&#123;net_ticktime,60&#125;&#125;]<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>停止rabbitmq服务</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@super sbin]# service rabbitmq-server stop<br>Stopping rabbitmq-server: rabbitmq-server.<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>启动第一个节点：</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@super sbin]# RABBITMQ_NODE_PORT=5673 RABBITMQ_NODENAME=rabbit1 rabbitmq-server start<br><br>              RabbitMQ 3.6.5. Copyright (C) 2007-2016 Pivotal Software, Inc.<br>  <span class="hljs-comment">##  ##      Licensed under the MPL.  See http://www.rabbitmq.com/</span><br>  <span class="hljs-comment">##  ##</span><br>  <span class="hljs-comment">##########  Logs: /var/log/rabbitmq/rabbit1.log</span><br>  <span class="hljs-comment">######  ##        /var/log/rabbitmq/rabbit1-sasl.log</span><br>  <span class="hljs-comment">##########</span><br>              Starting broker...<br> completed with 6 plugins.<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动第二个节点：</p><blockquote><p>web管理插件端口占用,所以还要指定其web插件占用的端口号。</p></blockquote><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@super ~]# RABBITMQ_NODE_PORT=5674 RABBITMQ_SERVER_START_ARGS=<span class="hljs-string">&quot;-rabbitmq_management listener [&#123;port,15674&#125;]&quot;</span> RABBITMQ_NODENAME=rabbit2 rabbitmq-server start<br><br>              RabbitMQ 3.6.5. Copyright (C) 2007-2016 Pivotal Software, Inc.<br>  <span class="hljs-comment">##  ##      Licensed under the MPL.  See http://www.rabbitmq.com/</span><br>  <span class="hljs-comment">##  ##</span><br>  <span class="hljs-comment">##########  Logs: /var/log/rabbitmq/rabbit2.log</span><br>  <span class="hljs-comment">######  ##        /var/log/rabbitmq/rabbit2-sasl.log</span><br>  <span class="hljs-comment">##########</span><br>              Starting broker...<br> completed with 6 plugins.<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结束命令：</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">rabbitmqctl -n rabbit1 stop<br>rabbitmqctl -n rabbit2 stop<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>rabbit1操作作为主节点：</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@super ~]# rabbitmqctl -n rabbit1 stop_app  <br>Stopping node rabbit1@super ...<br>[root@super ~]# rabbitmqctl -n rabbit1 reset   <br>Resetting node rabbit1@super ...<br>[root@super ~]# rabbitmqctl -n rabbit1 start_app<br>Starting node rabbit1@super ...<br>[root@super ~]# <br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>rabbit2操作为从节点：</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@super ~]# rabbitmqctl -n rabbit2 stop_app<br>Stopping node rabbit2@super ...<br>[root@super ~]# rabbitmqctl -n rabbit2 reset<br>Resetting node rabbit2@super ...<br>[root@super ~]# rabbitmqctl -n rabbit2 join_cluster rabbit1@<span class="hljs-string">&#x27;super&#x27;</span> <span class="hljs-comment">###&#x27;&#x27;内是主机名换成自己的</span><br>Clustering node rabbit2@super with rabbit1@super ...<br>[root@super ~]# rabbitmqctl -n rabbit2 start_app<br>Starting node rabbit2@super ...<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看集群状态：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">[root@super ~]# rabbitmqctl cluster_status -n rabbit1<br>Cluster status of node rabbit1@super ...<br>[&#123;nodes,[&#123;disc,[rabbit1@super,rabbit2@super]&#125;]&#125;,<br> &#123;running_nodes,[rabbit2@super,rabbit1@super]&#125;,<br> &#123;cluster_name,&amp;lt;&amp;lt;&quot;rabbit1@super&quot;&amp;gt;&amp;gt;&#125;,<br> &#123;partitions,[]&#125;,<br> &#123;alarms,[&#123;rabbit2@super,[]&#125;,&#123;rabbit1@super,[]&#125;]&#125;]<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>web监控：</p><figure><img class="lazy" alt="1566065096459" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1566065096459-f6a3b079.png" tabindex="0"/><figcaption>1566065096459</figcaption></figure><h4 id="_3-集群管理" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-集群管理">#</a> （3）集群管理</h4><p><strong>rabbitmqctl join_cluster {cluster_node} [–ram]</strong> 将节点加入指定集群中。在这个命令执行前需要停止RabbitMQ应用并重置节点。</p><p><strong>rabbitmqctl cluster_status</strong> 显示集群的状态。</p><p><strong>rabbitmqctl change_cluster_node_type {disc|ram}</strong> 修改集群节点的类型。在这个命令执行前需要停止RabbitMQ应用。</p><p><strong>rabbitmqctl forget_cluster_node [–offline]</strong> 将节点从集群中删除，允许离线执行。</p><p><strong>rabbitmqctl update_cluster_nodes {clusternode}</strong></p><p>在集群中的节点应用启动前咨询clusternode节点的最新信息，并更新相应的集群信息。这个和join_cluster不同，它不加入集群。考虑这样一种情况，节点A和节点B都在集群中，当节点A离线了，节点C又和节点B组成了一个集群，然后节点B又离开了集群，当A醒来的时候，它会尝试联系节点B，但是这样会失败，因为节点B已经不在集群中了。</p><p><strong>rabbitmqctl cancel_sync_queue [-p vhost] {queue}</strong> 取消队列queue同步镜像的操作。</p><p><strong>rabbitmqctl set_cluster_name {name}</strong> 设置集群名称。集群名称在客户端连接时会通报给客户端。Federation和Shovel插件也会有用到集群名称的地方。集群名称默认是集群中第一个节点的名称，通过这个命令可以重新设置。</p><h4 id="_4-rabbitmq镜像集群配置" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-rabbitmq镜像集群配置">#</a> （4）RabbitMQ镜像集群配置</h4><blockquote><p>上面已经完成RabbitMQ默认集群模式，但并不保证队列的高可用性，尽管交换机、绑定这些可以复制到集群里的任何一个节点，但是队列内容不会复制。虽然该模式解决一项目组节点压力，但队列节点宕机直接导致该队列无法应用，只能等待重启，所以要想在队列节点宕机或故障也能正常应用，就要复制队列内容到集群里的每个节点，必须要创建镜像队列。</p><p>镜像队列是基于普通的集群模式的，然后再添加一些策略，所以你还是得先配置普通集群，然后才能设置镜像队列，我们就以上面的集群接着做。</p></blockquote><p><strong>设置的镜像队列可以通过开启的网页的管理端Admin-&gt;Policies，也可以通过命令。</strong></p><blockquote><p>rabbitmqctl set_policy my_ha "^" '{"ha-mode":"all"}'</p></blockquote><figure><img class="lazy" alt="1566072300852" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/1566072300852-f79b7823.png" tabindex="0"/><figcaption>1566072300852</figcaption></figure><blockquote><ul><li>Name:策略名称</li><li>Pattern：匹配的规则，如果是匹配所有的队列，是^.</li><li>Definition:使用ha-mode模式中的all，也就是同步所有匹配的队列。问号链接帮助文档。</li></ul></blockquote><h4 id="_5-负载均衡-haproxy" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_5-负载均衡-haproxy">#</a> （5）负载均衡-HAProxy</h4><p>HAProxy提供高可用性、负载均衡以及基于TCP和HTTP应用的代理，支持虚拟主机，它是免费、快速并且可靠的一种解决方案,包括Twitter，Reddit，StackOverflow，GitHub在内的多家知名互联网公司在使用。HAProxy实现了一种事件驱动、单一进程模型，此模型支持非常大的并发连接数。</p><h5 id="a、-安装haproxy" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#a、-安装haproxy">#</a> a、 安装HAProxy</h5><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">//下载依赖包<br>yum install gcc vim wget<br>//上传haproxy源码包<br>//解压<br>tar -zxvf haproxy-1.6.5.tar.gz -C /usr/local<br>//进入目录、进行编译、安装<br><span class="hljs-built_in">cd</span> /usr/local/haproxy-1.6.5<br>make TARGET=linux31 PREFIX=/usr/local/haproxy<br>make install PREFIX=/usr/local/haproxy<br><span class="hljs-built_in">mkdir</span> /etc/haproxy<br>//赋权<br>groupadd -r -g 149 haproxy<br>useradd -g haproxy -r -s /sbin/nologin -u 149 haproxy<br>//创建haproxy配置文件<br><span class="hljs-built_in">mkdir</span> /etc/haproxy<br>vim /etc/haproxy/haproxy.cfg<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="b、配置haproxy" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#b、配置haproxy">#</a> b、配置HAProxy</h5><p>配置文件路径：/etc/haproxy/haproxy.cfg</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#logging options</span><br>global<br>    <span class="hljs-built_in">log</span> 127.0.0.1 local0 info<br>    maxconn 5120<br>    <span class="hljs-built_in">chroot</span> /usr/local/haproxy<br>    uid 99<br>    gid 99<br>    daemon<br>    quiet<br>    nbproc 20<br>    pidfile /var/run/haproxy.pid<br><br>defaults<br>    <span class="hljs-built_in">log</span> global<br><br>    mode tcp<br><br>    option tcplog<br>    option dontlognull<br>    retries 3<br>    option redispatch<br>    maxconn 2000<br>    contimeout 5s<br><br>     clitimeout 60s<br><br>     srvtimeout 15s <br><span class="hljs-comment">#front-end IP for consumers and producters</span><br><br>listen rabbitmq_cluster<br>    <span class="hljs-built_in">bind</span> 0.0.0.0:5672<br><br>    mode tcp<br>    <span class="hljs-comment">#balance url_param userid</span><br>    <span class="hljs-comment">#balance url_param session_id check_post 64</span><br>    <span class="hljs-comment">#balance hdr(User-Agent)</span><br>    <span class="hljs-comment">#balance hdr(host)</span><br>    <span class="hljs-comment">#balance hdr(Host) use_domain_only</span><br>    <span class="hljs-comment">#balance rdp-cookie</span><br>    <span class="hljs-comment">#balance leastconn</span><br>    <span class="hljs-comment">#balance source //ip</span><br><br>    balance roundrobin<br><br>        server node1 127.0.0.1:5673 check inter 5000 rise 2 fall 2<br>        server node2 127.0.0.1:5674 check inter 5000 rise 2 fall 2<br><br>listen stats<br>    <span class="hljs-built_in">bind</span> 172.16.98.133:8100<br>    mode http<br>    option httplog<br>    stats <span class="hljs-built_in">enable</span><br>    stats uri /rabbitmq-stats<br>    stats refresh 5s<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动HAproxy负载</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">/usr/local/haproxy/sbin/haproxy -f /etc/haproxy/haproxy.cfg<br>//查看haproxy进程状态<br>ps -ef | grep haproxy<br><br>访问如下地址对mq节点进行监控<br>http://172.16.98.133:8100/rabbitmq-stats<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>代码中访问mq集群地址，则变为访问haproxy地址:5672</p><p>​</p><p>​</p><p>​</p><p>​</p></div></article>
<div class="article-footer"></div>

<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">回顾上一篇</div><a href="/wiki/YDLDoc3/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMQ/rocketMQ">rocketMQ</a></div><div class="item" id="next"></div></section></div>


  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>快来参与讨论吧~</p>

    </section>
    <section class='body cmt-body waline'>
      

<div id="waline_container" class="waline_thread"><svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg></div>

    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="sitemap"><div class="sitemap-group"><span class="fs15">博客</span><a href="/">近期</a><a href="/categories/">分类</a><a href="/tags/">标签</a><a href="/archives/">归档</a></div><div class="sitemap-group"><span class="fs15">站点</span><a target="_blank" rel="noopener" href="https://status.thatcoder.cn/status/public/">公共服务</a><a target="_blank" rel="noopener" href="https://ai.thatcoder.cn/">ChatGPT</a><a target="_blank" rel="noopener" href="https://alist.thatcdn.cn/">文件资源</a><a target="_blank" rel="noopener" href="https://docs.thatapi.cn/">公共接口</a></div><div class="sitemap-group"><span class="fs15">社交</span><a href="/links/">友人帐</a><a href="/links/#comments">留言板</a><a href="/animes/">在追番</a><a href="/cinemas/">还追剧</a></div><div class="sitemap-group"><span class="fs15">更多</span><a href="/about/#tab_1-1/">本站动态</a><a target="_blank" rel="noopener" href="https://muselink.cc/naive">联系博主</a><a target="_blank" rel="noopener" href="https://github.com/ThatCoders">GitHub</a><a target="_blank" rel="noopener" href="https://gitea.thatcdn.cn/thatcoder">Gitea</a></div></div><div class="text"><p style="text-align:center" >
本站由 <a style="font-weight: bold;" href="/author/ThatCoder/">钟意</a> 使用 <a style="font-weight: bold;" target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.31.0">Stellar 1.31.0</a> 主题创建。
<br>
由 <a style="font-weight: bold;" target="_blank" rel="noopener" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral">又拍云</a> 提供CDN加速/云存储服务
<br>
由 <a style="font-weight: bold;" target="_blank" rel="noopener" href="https://vercel.com/">vercel</a>、<a style="font-weight: bold;" target="_blank" rel="noopener" href="https://www.netlify.com/">netlify</a>、<a style="font-weight: bold;" target="_blank" rel="noopener" href="https://www.cloudflare.com/">cloudflare</a> 提供托管服务
<br>
<a href="https://beian.miit.gov.cn/" target="_blank">湘ICP备2023019799号-1</a>
<br>
<!--不蒜子计数器-->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!--添加一个访问量-->
<span>总访问 <span id="busuanzi_value_site_pv" style="font-weight: bold;"></span> 次 
<!--本页访问 <span id="busuanzi_value_page_pv" style="font-weight: bold;"></span> 次</span>-->
<div id="siteruntime"></div>
</p>
<script>
function siteTime(){
    window.setTimeout("siteTime()", 1000);
    var seconds = 1000
    var minutes = seconds * 60
    var hours = minutes * 60
    var days = hours * 24
    var years = days * 365
    var today = new Date()
    var todayYear = today.getFullYear()
    var todayMonth = today.getMonth()
    var todayDate = today.getDate()
    var todayHour = today.getHours()
    var todayMinute = today.getMinutes()
    var todaySecond = today.getSeconds()
    var t1 = Date.UTC(2020,4,30,08,00,00)
    var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond)
    var diff = t2-t1
    var diffYears = Math.floor(diff/years)
    var diffDays = Math.floor((diff/days)-diffYears*365)
    var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours)
    var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes)
    var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds)
    document.getElementById("siteruntime").innerHTML="<p style=\"text-align:center\">小破站已颠沛流离 "+diffYears+" 年 "+diffDays+" 天 "+diffHours+" 小时 "+diffMinutes+" 分钟 "+diffSeconds+" 秒</p>"
}
siteTime();
</script>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="auto"><div class="widget-header dis-select"><span class="name">本文目录</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%AB%A0-%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%A6%82%E8%BF%B0-%E4%BA%86%E8%A7%A3"><span class="toc-text"> 第一章 消息中间件概述-了解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_1%E3%80%81-%E4%BB%80%E4%B9%88%E6%98%AF%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-text"> 1、 什么是消息中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-mq%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-text"> （1）MQ是什么</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8mq-%E9%9D%A2%E8%AF%95"><span class="toc-text"> （2）为什么使用MQ--面试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-mq%E4%BC%98%E5%8A%BF"><span class="toc-text"> （3）MQ优势</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#a%E3%80%81%E5%BA%94%E7%94%A8%E8%A7%A3%E8%80%A6"><span class="toc-text"> a、应用解耦</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#b%E3%80%81%E5%BC%82%E6%AD%A5%E6%8F%90%E9%80%9F"><span class="toc-text"> b、异步提速</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#c%E3%80%81%E5%89%8A%E5%B3%B0%E5%A1%AB%E8%B0%B7"><span class="toc-text"> c、削峰填谷</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4-mq%E5%8A%A3%E5%8A%BF"><span class="toc-text"> （4）MQ劣势</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_5-%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E7%94%A8mq"><span class="toc-text"> （5）什么时候用MQ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2%E3%80%81amqp-%E5%92%8C-jms"><span class="toc-text"> 2、AMQP 和 JMS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-amqp"><span class="toc-text"> （1）AMQP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-jms"><span class="toc-text"> （2）JMS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-amqp-%E4%B8%8E-jms-%E5%8C%BA%E5%88%AB"><span class="toc-text"> （3）AMQP 与 JMS 区别</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3%E3%80%81%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%BA%A7%E5%93%81"><span class="toc-text"> 3、消息队列产品</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_4%E3%80%81-rabbitmq"><span class="toc-text"> 4、 RabbitMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-rabbitmq%E7%89%B9%E7%82%B9"><span class="toc-text"> （1）RabbitMQ特点：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-%E5%85%B6%E5%AE%83%E7%9B%B8%E5%85%B3%E6%9C%AF%E8%AF%AD"><span class="toc-text"> （2）其它相关术语</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="toc-text"> （3）工作模式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0-rabbitmq%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86-%E9%87%8D%E7%82%B9"><span class="toc-text"> 第二章 RabbitMQ工作原理--重点！</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_1%E3%80%81%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5%E4%BB%8B%E7%BB%8D"><span class="toc-text"> 1、相关概念介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2%E3%80%81rabbitmq%E8%BF%90%E8%BD%AC%E6%B5%81%E7%A8%8B"><span class="toc-text"> 2、RabbitMQ运转流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3%E3%80%81%E7%94%9F%E4%BA%A7%E8%80%85%E6%B5%81%E8%BD%AC%E8%BF%87%E7%A8%8B%E8%AF%B4%E6%98%8E"><span class="toc-text"> 3、生产者流转过程说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_4%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%85%E6%B5%81%E8%BD%AC%E8%BF%87%E7%A8%8B%E8%AF%B4%E6%98%8E"><span class="toc-text"> 4、消费者流转过程说明</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%AB%A0-%E5%AE%89%E8%A3%85%E5%8F%8A%E9%85%8D%E7%BD%AErabbitmq"><span class="toc-text"> 第三章 安装及配置RabbitMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_1%E3%80%81%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85"><span class="toc-text"> 1、下载安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2%E3%80%81%E4%B8%8B%E8%BD%BDerlang"><span class="toc-text"> 2、下载erlang</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3%E3%80%81%E5%AE%89%E8%A3%85rabbitmq"><span class="toc-text"> 3、安装RabbitMQ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_4%E3%80%81%E5%90%AF%E5%8A%A8"><span class="toc-text"> 4、启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_5%E3%80%81%E5%90%AF%E5%8A%A8%E6%88%90%E5%8A%9F-%E7%99%BB%E5%BD%95rabbitmq"><span class="toc-text"> 5、启动成功 登录RabbitMQ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_6%E3%80%81%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-text"> 6、注意事项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_7%E3%80%81%E6%9F%A5%E7%9C%8B%E7%AE%A1%E7%90%86%E6%8E%A7%E5%88%B6%E5%8F%B0"><span class="toc-text"> 7、查看管理控制台</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0-rabbitmq%E5%85%A5%E9%97%A8"><span class="toc-text"> 第四章 RabbitMQ入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_1%E3%80%81%E6%90%AD%E5%BB%BA%E7%A4%BA%E4%BE%8B%E5%B7%A5%E7%A8%8B"><span class="toc-text"> 1、搭建示例工程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-%E5%88%9B%E5%BB%BA%E5%B7%A5%E7%A8%8B"><span class="toc-text"> （1）创建工程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96"><span class="toc-text"> （2）添加依赖</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2%E3%80%81-%E7%BC%96%E5%86%99%E7%94%9F%E4%BA%A7%E8%80%85"><span class="toc-text"> 2、 编写生产者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3%E3%80%81-%E7%BC%96%E5%86%99%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-text"> 3、 编写消费者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_4%E3%80%81%E5%B0%8F%E7%BB%93"><span class="toc-text"> 4、小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E7%AB%A0-rabbitmq%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F-%E9%87%8D%E7%82%B9"><span class="toc-text"> 第五章 RabbitMQ工作模式--重点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_1%E3%80%81work-queues%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97%E6%A8%A1%E5%BC%8F-%E5%8C%85%E5%B7%A5%E5%A4%B4"><span class="toc-text"> 1、Work queues工作队列模式（包工头）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-%E6%A8%A1%E5%BC%8F%E8%AF%B4%E6%98%8E"><span class="toc-text"> （1） 模式说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-%E4%BB%A3%E7%A0%81"><span class="toc-text"> （2）代码</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#a%E3%80%81%E7%94%9F%E4%BA%A7%E8%80%85-%E4%BF%AE%E6%94%B9%E9%98%9F%E5%88%97%E5%90%8D"><span class="toc-text"> a、生产者 修改队列名</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#b%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%851-%E7%9B%91%E5%90%AC%E5%90%8C%E4%B8%80%E4%B8%AA%E9%98%9F%E5%88%97"><span class="toc-text"> b、消费者1 监听同一个队列</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#c%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%852-%E6%B6%88%E8%B4%B9%E8%80%85%E5%86%8D%E8%B5%B7%E4%B8%80%E4%BB%BD"><span class="toc-text"> c、消费者2 消费者再起一份</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3-%E6%B5%8B%E8%AF%95"><span class="toc-text"> （3）测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2%E3%80%81publish-subscribe-%E8%AE%A2%E9%98%85%E5%8F%91%E5%B8%83%E6%A8%A1%E5%BC%8F%E7%B1%BB%E5%9E%8B-%E5%BE%AE%E5%8D%9A"><span class="toc-text"> 2、publish&#x2F;subscribe 订阅发布模式类型（微博）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3%E3%80%81-publish-subscribe%E5%8F%91%E5%B8%83%E4%B8%8E%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F-%E5%BE%AE%E5%8D%9A"><span class="toc-text"> 3、 Publish&#x2F;Subscribe发布与订阅模式（微博）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-%E6%A8%A1%E5%BC%8F%E8%AF%B4%E6%98%8E-1"><span class="toc-text"> （ 1）模式说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-%E4%BB%A3%E7%A0%81-1"><span class="toc-text"> （2）代码</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#a%E3%80%81%E7%94%9F%E4%BA%A7%E8%80%85"><span class="toc-text"> a、生产者</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#b%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%851"><span class="toc-text"> b、消费者1</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#c%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%852"><span class="toc-text"> c、消费者2</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-%E6%B5%8B%E8%AF%95-1"><span class="toc-text"> （3） 测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4-%E5%B0%8F%E7%BB%93"><span class="toc-text"> （4）小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_4%E3%80%81routing%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8F-%E5%88%86%E5%B8%83%E5%BC%8F%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E7%B3%BB%E7%BB%9F"><span class="toc-text"> 4、Routing路由模式（分布式日志收集系统）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-%E6%A8%A1%E5%BC%8F%E8%AF%B4%E6%98%8E-2"><span class="toc-text"> （1）模式说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-%E4%BB%A3%E7%A0%81-2"><span class="toc-text"> （2）代码</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#a%E3%80%81%E7%94%9F%E4%BA%A7%E8%80%85-1"><span class="toc-text"> a、生产者</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#b%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%851-1"><span class="toc-text"> b、消费者1</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#c%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%852-1"><span class="toc-text"> c、消费者2</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-%E6%B5%8B%E8%AF%95-2"><span class="toc-text"> （3）测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4-%E5%B0%8F%E7%BB%93-1"><span class="toc-text"> （4）小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_5%E3%80%81-topics%E9%80%9A%E9%85%8D%E7%AC%A6%E6%A8%A1%E5%BC%8F"><span class="toc-text"> 5、 Topics通配符模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-%E6%A8%A1%E5%BC%8F%E8%AF%B4%E6%98%8E-3"><span class="toc-text"> （1） 模式说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-%E4%BB%A3%E7%A0%81-3"><span class="toc-text"> （2） 代码</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#a%E3%80%81%E7%94%9F%E4%BA%A7%E8%80%85-2"><span class="toc-text"> a、生产者</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#b%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%851-2"><span class="toc-text"> b、消费者1</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#c%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%852-2"><span class="toc-text"> c、消费者2</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-%E6%B5%8B%E8%AF%95-3"><span class="toc-text"> （3）测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4-%E5%B0%8F%E7%BB%93-2"><span class="toc-text"> （4）小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_6%E3%80%81-%E6%A8%A1%E5%BC%8F%E6%80%BB%E7%BB%93"><span class="toc-text"> 6、 模式总结</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-%E7%AE%80%E5%8D%95%E6%A8%A1%E5%BC%8F-helloworld"><span class="toc-text"> （1）简单模式 HelloWorld</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97%E6%A8%A1%E5%BC%8F-work-queue"><span class="toc-text"> （2）工作队列模式 Work Queue</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F-publish-subscribe"><span class="toc-text"> （3）发布订阅模式 Publish&#x2F;subscribe</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4-%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8F-routing"><span class="toc-text"> （4）路由模式 Routing</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_5-%E9%80%9A%E9%85%8D%E7%AC%A6%E6%A8%A1%E5%BC%8F-topic"><span class="toc-text"> （5）通配符模式 Topic</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E7%AB%A0-spring-%E6%95%B4%E5%90%88rabbitmq-%E4%BA%86%E8%A7%A3"><span class="toc-text"> 第六章 Spring 整合RabbitMQ-了解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_1%E3%80%81%E6%90%AD%E5%BB%BA%E7%94%9F%E4%BA%A7%E8%80%85%E5%B7%A5%E7%A8%8B"><span class="toc-text"> 1、搭建生产者工程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-%E5%88%9B%E5%BB%BA%E5%B7%A5%E7%A8%8B-1"><span class="toc-text"> （1）创建工程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96-1"><span class="toc-text"> （2）添加依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-%E9%85%8D%E7%BD%AE%E6%95%B4%E5%90%88"><span class="toc-text"> （3） 配置整合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4-%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF"><span class="toc-text"> （4）发送消息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2%E3%80%81%E6%90%AD%E5%BB%BA%E6%B6%88%E8%B4%B9%E8%80%85%E5%B7%A5%E7%A8%8B"><span class="toc-text"> 2、搭建消费者工程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-%E5%88%9B%E5%BB%BA%E5%B7%A5%E7%A8%8B-2"><span class="toc-text"> （1）创建工程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96-2"><span class="toc-text"> （2）添加依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-%E9%85%8D%E7%BD%AE%E6%95%B4%E5%90%88-1"><span class="toc-text"> （3） 配置整合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4-%E6%B6%88%E6%81%AF%E7%9B%91%E5%90%AC%E5%99%A8"><span class="toc-text"> （4） 消息监听器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#a%E3%80%81%E9%98%9F%E5%88%97%E7%9B%91%E5%90%AC%E5%99%A8"><span class="toc-text"> a、队列监听器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#b%E3%80%81%E5%B9%BF%E6%92%AD%E7%9B%91%E5%90%AC%E5%99%A81"><span class="toc-text"> b、广播监听器1</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#c%E3%80%81%E5%B9%BF%E6%92%AD%E7%9B%91%E5%90%AC%E5%99%A82"><span class="toc-text"> c、广播监听器2</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#d%E3%80%81%E6%98%9F%E5%8F%B7%E9%80%9A%E9%85%8D%E7%AC%A6%E7%9B%91%E5%90%AC%E5%99%A8"><span class="toc-text"> d、星号通配符监听器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#e%E3%80%81%E4%BA%95%E5%8F%B7%E9%80%9A%E9%85%8D%E7%AC%A6%E7%9B%91%E5%90%AC%E5%99%A8"><span class="toc-text"> e、井号通配符监听器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#f%E3%80%81%E4%BA%95%E5%8F%B7%E9%80%9A%E9%85%8D%E7%AC%A6%E7%9B%91%E5%90%AC%E5%99%A82"><span class="toc-text"> f、井号通配符监听器2</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E7%AB%A0-spring-boot%E6%95%B4%E5%90%88rabbitmq"><span class="toc-text"> 第七章 Spring Boot整合RabbitMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_1%E3%80%81-%E7%AE%80%E4%BB%8B"><span class="toc-text"> 1、 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2%E3%80%81%E6%90%AD%E5%BB%BA%E7%94%9F%E4%BA%A7%E8%80%85%E5%B7%A5%E7%A8%8B"><span class="toc-text"> 2、搭建生产者工程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-%E5%88%9B%E5%BB%BA%E5%B7%A5%E7%A8%8B-3"><span class="toc-text"> （1） 创建工程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96-3"><span class="toc-text"> （2） 添加依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-text"> （3） 启动类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4-%E9%85%8D%E7%BD%AErabbitmq"><span class="toc-text"> （4）配置RabbitMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#a%E3%80%81%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text"> a、配置文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#b%E3%80%81%E7%BB%91%E5%AE%9A%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%92%8C%E9%98%9F%E5%88%97"><span class="toc-text"> b、绑定交换机和队列</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3%E3%80%81%E6%90%AD%E5%BB%BA%E6%B6%88%E8%B4%B9%E8%80%85%E5%B7%A5%E7%A8%8B"><span class="toc-text"> 3、搭建消费者工程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-%E5%88%9B%E5%BB%BA%E5%B7%A5%E7%A8%8B-4"><span class="toc-text"> （1） 创建工程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96-4"><span class="toc-text"> （2） 添加依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-%E5%90%AF%E5%8A%A8%E7%B1%BB-1"><span class="toc-text"> （3） 启动类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4-%E9%85%8D%E7%BD%AErabbitmq-1"><span class="toc-text"> （4） 配置RabbitMQ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_5-%E6%B6%88%E6%81%AF%E7%9B%91%E5%90%AC%E5%A4%84%E7%90%86%E7%B1%BB"><span class="toc-text"> （5） 消息监听处理类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_4%E3%80%81-%E6%B5%8B%E8%AF%95"><span class="toc-text"> 4、 测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%AB%A0-rabbitmq-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7"><span class="toc-text"> 第一章 RabbitMQ 高级特性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_1%E3%80%81%E6%B6%88%E6%81%AF%E5%8F%AF%E9%9D%A0%E6%80%A7%E6%8A%95%E9%80%92"><span class="toc-text"> 1、消息可靠性投递</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-confirm%E7%A1%AE%E8%AE%A4%E6%A8%A1%E5%BC%8F%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text"> （1）confirm确认模式代码实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-return%E9%80%80%E5%9B%9E%E6%A8%A1%E5%BC%8F%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text"> （2） return退回模式代码实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-%E5%B0%8F%E7%BB%93"><span class="toc-text"> （3）小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2%E3%80%81consumer-ack"><span class="toc-text"> 2、Consumer ACK</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text"> （1）代码实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-%E5%B0%8F%E7%BB%93"><span class="toc-text"> （2）小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3%E3%80%81%E6%B6%88%E8%B4%B9%E7%AB%AF%E9%99%90%E6%B5%81"><span class="toc-text"> 3、消费端限流</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-1"><span class="toc-text"> （1）代码实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-%E5%B0%8F%E7%BB%93-1"><span class="toc-text"> （2）小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_4%E3%80%81ttl"><span class="toc-text"> 4、TTL</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-2"><span class="toc-text"> （1）代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#a%E3%80%81%E8%AE%BE%E7%BD%AE%E9%98%9F%E5%88%97%E7%9A%84%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4"><span class="toc-text"> a、设置队列的过期时间</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#b%E3%80%81%E8%AE%BE%E7%BD%AE%E5%8D%95%E4%B8%AA%E6%B6%88%E6%81%AF%E7%9A%84%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4"><span class="toc-text"> b、设置单个消息的过期时间</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-%E5%B0%8F%E7%BB%93-2"><span class="toc-text"> （2）小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_5%E3%80%81%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97"><span class="toc-text"> 5、死信队列</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-3"><span class="toc-text"> （1）代码实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-%E5%B0%8F%E7%BB%93-3"><span class="toc-text"> （2）小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_6%E3%80%81%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97-%E9%87%8D%E7%82%B9"><span class="toc-text"> 6、延迟队列-重点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-4"><span class="toc-text"> （1）代码实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-%E5%B0%8F%E7%BB%93-4"><span class="toc-text"> （2） 小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_7%E3%80%81%E6%97%A5%E5%BF%97%E4%B8%8E%E7%9B%91%E6%8E%A7-%E4%BA%86%E8%A7%A3"><span class="toc-text"> 7、日志与监控-了解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-rabbitmq%E6%97%A5%E5%BF%97"><span class="toc-text"> （1）RabbitMQ日志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-web%E7%AE%A1%E6%8E%A7%E5%8F%B0%E7%9B%91%E6%8E%A7"><span class="toc-text"> （2）web管控台监控</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_8%E3%80%81%E6%B6%88%E6%81%AF%E8%BF%BD%E8%B8%AA-%E4%BA%86%E8%A7%A3"><span class="toc-text"> 8、消息追踪-了解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-%E6%B6%88%E6%81%AF%E8%BF%BD%E8%B8%AA-firehose"><span class="toc-text"> （1）消息追踪-Firehose</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-%E6%B6%88%E6%81%AF%E8%BF%BD%E8%B8%AA-rabbitmq-tracing"><span class="toc-text"> （2） 消息追踪-rabbitmq_tracing</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0-rabbitmq%E5%BA%94%E7%94%A8%E9%97%AE%E9%A2%98-%E9%9D%A2%E8%AF%95"><span class="toc-text"> 第二章 RabbitMQ应用问题-面试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#_1%E3%80%81%E6%B6%88%E6%81%AF%E5%8F%AF%E9%9D%A0%E6%80%A7%E4%BF%9D%E9%9A%9C"><span class="toc-text"> 1、消息可靠性保障</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_2%E3%80%81-%E6%B6%88%E6%81%AF%E5%B9%82%E7%AD%89%E6%80%A7%E5%A4%84%E7%90%86"><span class="toc-text"> 2、 消息幂等性处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_3%E3%80%81rabbitmq%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA-%E8%BF%90%E7%BB%B4"><span class="toc-text"> 3、RabbitMQ集群搭建-运维</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1-%E9%9B%86%E7%BE%A4%E6%96%B9%E6%A1%88%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-text"> （1） 集群方案的原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2-%E5%8D%95%E6%9C%BA%E5%A4%9A%E5%AE%9E%E4%BE%8B%E9%83%A8%E7%BD%B2"><span class="toc-text"> （2）单机多实例部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3-%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86"><span class="toc-text"> （3）集群管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4-rabbitmq%E9%95%9C%E5%83%8F%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE"><span class="toc-text"> （4）RabbitMQ镜像集群配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_5-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-haproxy"><span class="toc-text"> （5）负载均衡-HAProxy</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#a%E3%80%81-%E5%AE%89%E8%A3%85haproxy"><span class="toc-text"> a、 安装HAProxy</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#b%E3%80%81%E9%85%8D%E7%BD%AEhaproxy"><span class="toc-text"> b、配置HAProxy</span></a></li></ol></li></ol></li></ol></li></ol></div><div class="widget-footer">

<a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><!-- Icon from Solar by 480 Design - https://creativecommons.org/licenses/by/4.0/ --><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5"><path stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/><path d="M7 3.338A9.95 9.95 0 0 1 12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12c0-1.821.487-3.53 1.338-5"/></g></svg><span>回到顶部</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><!-- Icon from Solar by 480 Design - https://creativecommons.org/licenses/by/4.0/ --><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5" d="M8 10.5h8M8 14h5.5M17 3.338A9.95 9.95 0 0 0 12 2C6.477 2 2 6.477 2 12c0 1.6.376 3.112 1.043 4.453c.178.356.237.763.134 1.148l-.595 2.226a1.3 1.3 0 0 0 1.591 1.592l2.226-.596a1.63 1.63 0 0 1 1.149.133A9.96 9.96 0 0 0 12 22c5.523 0 10-4.477 10-10c0-1.821-.487-3.53-1.338-5"/></svg><span>参与讨论</span></a></div></widget>
</div></aside><div class='float-panel'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Website","@id":"https://blog.thatcoder.cn/wiki/YDLDoc3/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/rabbitMQ","author":{"@type":"Person","name":"钟意","sameAs":[],"image":"https://upyun.thatcdn.cn/hexo/stellar/image/favicon.webp"},"name":"rabbitMQ","description":"# RabbitMQ入门提示课程视频教程链接：https://www.bilibili.com/video/BV1dt4y147CKopen in new window学习目标能够说出什么是消息中间件能够安装RabbitMQ能够编写RabbitMQ的入门程序能够说出RabbitMQ的5种模式特征-重点能够使用Spring整合RabbitMQ# 第一章 消息中间件概述-了解# 1、 什么是消息...","url":"https://blog.thatcoder.cn/wiki/YDLDoc3/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/rabbitMQ","keywords":"那个码农, 码农钟意, 钟意的博客, 钟意博客, That Coder, thatcoder, 源柒拾柒雅舍, 源WebGary, giligili.work, seclusion.work, GalGame, Hexo Stellar, 江西木村拓哉, 江西吴彦祖, 江西胡歌, 龙南木村拓哉, 龙南吴彦祖, 龙南胡歌, 九江职业技术学院, 南昌交通学院"}</script>


<script type="text/javascript">
  window.canonical = {"originalHost":"blog.thatcoder.cn","officialHosts":["localhost","en.blog.thatcoder.cn","hexo.thatcoder.cn","thatcoder.vercel.app","thatcoder.netlify.app","cn-coder.vercel.app","thatcoders.github.io","thatcoder.pages.dev","cncoder.pages.dev"],"encoded":"YmxvZy50aGF0Y29kZXIuY24="};
  const ctx = {
    date_suffix: {
      just: `刚刚`,
      min: `分钟前`,
      hour: `小时前`,
      day: `天前`,
    },
    root : `/`,
    tag_plugins: {
      chat: Object.assign({"api":"https://siteinfo.listentothewind.cn/api/v1"}),
    }
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"post, page, docs","path":"/search.json","content":true,"skip_search":null,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
  };
  const deps = {
    jquery: `https://gcore.jsdelivr.net/npm/jquery@3.7/dist/jquery.min.js`,
    marked: `https://gcore.jsdelivr.net/npm/marked@13.0/lib/marked.umd.min.js`
  }
  

</script>

<script type="text/javascript">
  function RunItem() {
    this.list = []; // 存放回调函数
    this.start = () => {
      for (var i = 0; i < this.list.length; i++) {
        this.list[i].run();
      }
    };
    this.push = (fn, name, setRequestAnimationFrame = true) => {
      let myfn = fn
      if (setRequestAnimationFrame) {
        myfn = () => {
          utils.requestAnimationFrame(fn)
        }
      }
      var f = new Item(myfn, name);
      this.list.push(f);
    };
    this.remove = (name) => {
      for (let index = 0; index < this.list.length; index++) {
        const e = this.list[index];
        if (e.name == name) {
          this.list.splice(index, 1);
        }
      }
    }
    // 构造一个可以run的对象
    function Item(fn, name) {
      // 函数名称
      this.name = name || fn.name;
      // run方法
      this.run = () => {
        try {
          fn()
        } catch (error) {
          console.log(error);
        }
      };
    }
  }

  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')) {
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function () {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },

    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      let retryTimes = 3;
      utils.onLoading(el);
      function req() {
        return new Promise((resolve, reject) => {
          let status = 0; // 0 等待 1 完成 2 超时
          let timer = setTimeout(() => {
            if (status === 0) {
              status = 2;
              timer = null;
              reject('请求超时');
              if (retryTimes == 0) {
                onFailure();
              }
            }
          }, 5000);
          fetch(url).then(function (response) {
            if (status !== 2) {
              clearTimeout(timer);
              resolve(response);
              timer = null;
              status = 1;
            }
            if (response.ok) {
              return response;
            }
            throw new Error('Network response was not ok.');
          }).then(function (data) {
            retryTimes = 0;
            utils.onLoadSuccess(el);
            callback(data);
          }).catch(function (error) {
            if (retryTimes > 0) {
              retryTimes -= 1;
              setTimeout(() => {
                req();
              }, 5000);
            } else {
              utils.onLoadFailure(el);
              onFailure();
            }
          });
        });
      }
      req();
    },
    /********************** requestAnimationFrame ********************************/
    // 1、requestAnimationFrame 会把每一帧中的所有 DOM 操作集中起来，在一次重绘或回流中就完成，并且重绘或回流的时间间隔紧紧跟随浏览器的刷新频率，一般来说，这个频率为每秒60帧。
    // 2、在隐藏或不可见的元素中，requestAnimationFrame 将不会进行重绘或回流，这当然就意味着更少的的 cpu，gpu 和内存使用量。
    requestAnimationFrame: (fn) => {
      if (!window.requestAnimationFrame) {
        window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame;
      }
      window.requestAnimationFrame(fn)
    },
    dark: {},
  };

  // utils.dark.mode 当前模式 dark or light
  // utils.dark.toggle() 暗黑模式触发器
  // utils.dark.push(callBack[,"callBackName"]) 传入触发器回调函数
  utils.dark.method = {
    toggle: new RunItem(),
  };
  utils.dark = Object.assign(utils.dark, {
    push: utils.dark.method.toggle.push,
  });
</script>
<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>
<script type="text/javascript">
  (() => {
    const tagSwitchers = document.querySelectorAll('.tag-subtree.parent-tag > a > .tag-switcher-wrapper')
    for (const tagSwitcher of tagSwitchers) {
      tagSwitcher.addEventListener('click', (e) => {
        const parent = e.target.closest('.tag-subtree.parent-tag')
        parent.classList.toggle('expanded')
        e.preventDefault()
      })
    }

    // Get active tag from query string, then activate it.
    const urlParams = new URLSearchParams(window.location.search)
    const activeTag = urlParams.get('tag')
    if (activeTag) {
      let tag = document.querySelector(`.tag-subtree[data-tag="${activeTag}"]`)
      if (tag) {
        tag.querySelector('a').classList.add('active')
        
        while (tag) {
          tag.classList.add('expanded')
          tag = tag.parentElement.closest('.tag-subtree.parent-tag')
        }
      }
    }
  })()
</script>


<!-- required -->
<script src="/js/main.js?v=1.31.0" defer></script>

<script type="text/javascript">
  const applyTheme = (theme) => {
    if (theme === 'auto') {
      document.documentElement.removeAttribute('data-theme')
    } else {
      document.documentElement.setAttribute('data-theme', theme)
    }

    applyThemeToGiscus(theme)
  }

  const applyThemeToGiscus = (theme) => {
    theme = theme === 'auto' ? 'preferred_color_scheme' : theme

    const cmt = document.getElementById('giscus')
    if (cmt) {
      // This works before giscus load.
      cmt.setAttribute('data-theme', theme)
    }

    const iframe = document.querySelector('#comments > section.giscus > iframe')
    if (iframe) {
      // This works after giscus loaded.
      const src = iframe.src
      const newSrc = src.replace(/theme=[\w]+/, `theme=${theme}`)
      iframe.src = newSrc
    }
  }

  const switchTheme = () => {
    // light -> dark -> auto -> light -> ...
    const currentTheme = document.documentElement.getAttribute('data-theme')
    let newTheme;
    switch (currentTheme) {
      case 'light':
        newTheme = 'dark'
        break
      case 'dark':
        newTheme = 'auto'
        break
      default:
        newTheme = 'light'
    }
    applyTheme(newTheme)
    window.localStorage.setItem('Stellar.theme', newTheme)
    utils.dark.mode = newTheme === 'auto' ? (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light") : newTheme;
    utils.dark.method.toggle.start();

    const messages = {
      light: `切换到浅色模式`,
      dark: `切换到深色模式`,
      auto: `切换到跟随系统配色`,
    }
    hud?.toast?.(messages[newTheme])
  }

  (() => {
    // Apply user's preferred theme, if any.
    const theme = window.localStorage.getItem('Stellar.theme')
    if (theme !== null) {
      applyTheme(theme)
    } else {
      utils.dark.mode = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    }
    utils.dark.method.toggle.start();
  })()
</script>


<!-- optional -->

  <script type="module">
  import { init } from 'https://gcore.jsdelivr.net/npm/@waline/client@3.1/dist/waline.js';

  const el = document.getElementById('waline_container');
  util.viewportLazyload(el, load_waline, false);

  function load_waline(){
    if (!el) return;

    utils.css('https://gcore.jsdelivr.net/npm/@waline/client@3.1/dist/waline.css');
    utils.css('https://gcore.jsdelivr.net/npm/@waline/client@3.1/dist/waline-meta.css');

    const path = el.getAttribute('comment_id') ?? decodeURI(window.location.pathname);
    const waline = init(Object.assign({"js":"https://gcore.jsdelivr.net/npm/@waline/client@3.1/dist/waline.js","css":"https://gcore.jsdelivr.net/npm/@waline/client@3.1/dist/waline.css","meta_css":"https://gcore.jsdelivr.net/npm/@waline/client@3.1/dist/waline-meta.css","serverURL":"https://waline.thatapi.cn/","commentCount":true,"pageview":false,"search":false,"locale":{"placeholder":"  遇事不决, 可问春风..."},"emoji":["https://upyun.thatcdn.cn/public/web/emojis/bilibili","https://upyun.thatcdn.cn/public/web/emojis/qq","https://upyun.thatcdn.cn/public/web/emojis/tieba","https://upyun.thatcdn.cn/public/web/emojis/weibo"],"reaction":["https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_thumbsup.png","https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_cute.png","https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_sunglasses.png","https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_crazy.png","https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_trollface.png"],"meta":["nick","mail","link"],"imageUploader":{"fileName":"file","tokenName":"Authorization","api":"https://lsky.thatcoder.cn/api/v1/upload","token":"Bearer 6|x9vHGJGHAnjqbO0PGEE5vM7r9S9hdqFA9bmdESdm","resp":"data.links.url"}}, {
      el: '#waline_container',
      path: path,
      
        imageUploader: function(file) {
          const headers = new Headers();
          headers.set('Accept', 'application/json');
          
            headers.set('Authorization', 'Bearer 6|x9vHGJGHAnjqbO0PGEE5vM7r9S9hdqFA9bmdESdm')
          
          const formData = new FormData();
          formData.append('file', file);
          return fetch('https://lsky.thatcoder.cn/api/v1/upload',{
            method: 'POST',
            body: formData,
            headers: headers
            }).then((resp) => resp.json())
              .then((resp) => resp.data.links.url)
        },
      
    }));
  }
</script>




<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"friends_and_posts":{"js":"/js/services/friends_and_posts.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"},"voice":{"js":"/js/plugins/voice.js"},"video":{"js":"/js/plugins/video.js"},"download-file":{"js":"/js/plugins/download-file.js"},"twikoo":{"js":"/js/services/twikoo_latest_comment.js"},"waline":{"js":"/js/services/waline_latest_comment.js"},"artalk":{"js":"/js/services/artalk_latest_comment.js"},"giscus":{"js":"/js/services/giscus_latest_comment.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else if (id == 'voice') {
        ctx.voiceAudios = document.querySelectorAll('.voice>audio');
        if (ctx.voiceAudios?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            createVoiceDom(ctx.voiceAudios);
          });
        }
      } else if (id == 'video') {
        ctx.videos = document.querySelectorAll('.video>video');
        if (ctx.videos?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            videoEvents(ctx.videos);
          });
        }
      } else if (id == 'download-file') {
        ctx.files = document.querySelectorAll('.file');
        if (ctx.files?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            downloadFileEvent(ctx.files);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }

    // chat iphone time
    let phoneTimes = document.querySelectorAll('.chat .status-bar .time');

    if (phoneTimes.length > 0) {
      NowTime();
      var date = new Date();
      var sec = date.getSeconds();
      var firstAdjustInterval = setInterval(firstAdjustTime, 1000 * (60 - sec));
    }

    function firstAdjustTime() {
      NowTime();
      clearInterval(firstAdjustInterval);
      setInterval(NowTime, 1000 * 60);
    }

    function NowTime() {
      for (let i = 0; i < phoneTimes.length; ++i) {
        var timeSpan = phoneTimes[i];
        var date = new Date();
        var hour = date.getHours();
        var min = date.getMinutes();
        timeSpan.innerHTML = check(hour) + ":" + check(min);
      }
    };

    function check(val) {
      if (val < 10) {
        return ("0" + val);
      }
      return (val);
    }

    // chat quote
    const chat_quote_obverser = new IntersectionObserver((entries, observer) => {
      entries.filter((entry) => { return entry.isIntersecting }).sort((a, b) => a.intersectionRect.y !== b.intersectionRect.y ? a.intersectionRect.y - b.intersectionRect.y : a.intersectionRect.x - b.intersectionRect.x).forEach((entry, index) => {
          observer.unobserve(entry.target);
          setTimeout(() => {
            entry.target.classList.add('quote-blink');
            setTimeout(() => {
              entry.target.classList.remove('quote-blink');
            }, 1000);
          }, Math.max(100, 16) * (index + 1));
        });
    });

    var chatQuotes = document.querySelectorAll(".chat .talk .quote");
    chatQuotes.forEach((quote) => {
      quote.addEventListener('click', function () {
        var chatCellDom = document.getElementById("quote-" + quote.getAttribute("quotedCellTag"));
        if (chatCellDom) {
          var chatDiv = chatCellDom.parentElement;
          var mid = chatDiv.clientHeight / 2;
          var offsetTop = chatCellDom.offsetTop;
          if (offsetTop > mid - chatCellDom.clientHeight / 2) {
            chatDiv.scrollTo({
              top: chatCellDom.offsetTop - mid + chatCellDom.clientHeight / 2,
              behavior: "smooth"
            });
          } else {
            chatDiv.scrollTo({
              top: 0,
              behavior: "smooth"
            });
          }
          chat_quote_obverser.observe(chatCellDom);
        }
      });
    });
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://gcore.jsdelivr.net/npm/flying-pages@2/flying-pages.min.js"></script><script defer src="https://gcore.jsdelivr.net/npm/vanilla-lazyload@19.1/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });
</script><script>
  ctx.fancybox = {
    selector: `.swiper-slide img, .md-text.content p>img, .md-text.content li img , .wl-content img, waline_container .vcontent img, .timeline .body .image img,  .timeline .gallery img`,
    css: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.min.css`,
    js: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.umd.min.js`
  };
  var selector = '[data-fancybox]:not(.error)';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const els = document.getElementsByClassName('ds-memos');
    if (els != undefined && els.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>




<!-- inject -->
<script type="text/javascript" src="/custom/js/ZYUtil.js"></script><script type="text/javascript" src="/custom/js/ZYDark.js"></script><script type="text/javascript" src="/custom/js/ZYCategory.js"></script><script type="text/javascript" src="/custom/js/ZYCode.js"></script><script type="text/javascript" src="/custom/js/timetmpl.js"></script>
</div></body></html>
