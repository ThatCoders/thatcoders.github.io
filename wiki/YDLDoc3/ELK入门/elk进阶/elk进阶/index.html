
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.33.1" theme-name="Stellar" theme-version="1.33.1">
  <link rel="canonical" href="https://blog.thatcoder.cn/wiki/YDLDoc3/ELK入门/elk进阶/elk进阶">
  
  <meta name="generator" content="Hexo 7.3.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  <meta name="theme-color" content="#f9fafb">
  <title>YDLDoc3：elk进阶 - 钟意博客</title>

  
    <meta name="description" content="# ELK搜索高级课程提示课程视频教程链接：https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1hf4y1E7FDopen in new window# 第十一章 索引Index入门# 一、索引管理# 1、为什么我们要手动创建索引直接put数据 PUT index&#x2F;_doc&#x2F;1,es会自动生成索引，并建立动态映射dynamic mapping。在生产上，我们需要自己手动建立索引和映">
<meta property="og:type" content="website">
<meta property="og:title" content="elk进阶">
<meta property="og:url" content="https://blog.thatcoder.cn/wiki/YDLDoc3/ELK%E5%85%A5%E9%97%A8/elk%E8%BF%9B%E9%98%B6/elk%E8%BF%9B%E9%98%B6/">
<meta property="og:site_name" content="钟意博客">
<meta property="og:description" content="# ELK搜索高级课程提示课程视频教程链接：https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1hf4y1E7FDopen in new window# 第十一章 索引Index入门# 一、索引管理# 1、为什么我们要手动创建索引直接put数据 PUT index&#x2F;_doc&#x2F;1,es会自动生成索引，并建立动态映射dynamic mapping。在生产上，我们需要自己手动建立索引和映">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.thatcoder.cn/favicon.ico">
<meta property="article:published_time" content="2025-07-21T12:21:47.982Z">
<meta property="article:modified_time" content="2025-07-21T12:21:47.982Z">
<meta property="article:author" content="钟意">
<meta property="article:tag" content="那个码农">
<meta property="article:tag" content="码农钟意">
<meta property="article:tag" content="钟意的博客">
<meta property="article:tag" content="钟意博客">
<meta property="article:tag" content="That Coder">
<meta property="article:tag" content="thatcoder">
<meta property="article:tag" content="源柒拾柒雅舍">
<meta property="article:tag" content="源WebGary">
<meta property="article:tag" content="giligili.work">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.thatcoder.cn/favicon.ico">
  
  

  <meta name="keywords" content="那个码农,码农钟意,钟意的博客,钟意博客,That Coder,thatcoder,源柒拾柒雅舍,源WebGary,giligili.work">

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="钟意博客" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/main.css?v=1.33.1">


  
    <link rel="shortcut icon" href="/favicon.ico">
  

  
    
<link rel="stylesheet" href="/custom/css/ZYCode.css">

  

  <script type="application/ld+json">{"@context":"https://schema.org","@type":"Website","@id":"https://blog.thatcoder.cn/wiki/YDLDoc3/ELK%E5%85%A5%E9%97%A8/elk%E8%BF%9B%E9%98%B6/elk%E8%BF%9B%E9%98%B6/","author":{"@type":"Person","name":"钟意","sameAs":[],"image":"/favicon.ico"},"name":"elk进阶","description":"# ELK搜索高级课程提示课程视频教程链接：https://www.bilibili.com/video/BV1hf4y1E7FDopen in new window# 第十一章 索引Index入门# 一、索引管理# 1、为什么我们要手动创建索引直接put数据 PUT index/_doc/1,es会自动生成索引，并建立动态映射dynamic mapping。在生产上，我们需要自己手动建立索...","url":"https://blog.thatcoder.cn/wiki/YDLDoc3/ELK%E5%85%A5%E9%97%A8/elk%E8%BF%9B%E9%98%B6/elk%E8%BF%9B%E9%98%B6/","keywords":["那个码农","码农钟意","钟意的博客","钟意博客","That Coder","thatcoder","源柒拾柒雅舍","源WebGary","giligili.work"]}</script>
  <link rel="Shortcut Icon" href="/favicon.ico" type="image/x-icon" /><link rel='stylesheet' href='https://public.thatcdn.cn/font/old_song/result.css' /><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.5.1/css/all.min.css"><link rel="stylesheet" href="/custom/css/ZYTimetmpl.css" /><meta itemprop="name" content="钟意博客"><meta itemprop="author" content="钟意"><meta itemprop="description" content="笔名钟意, 记录代码与生活."><meta itemprop="image" content="https://upyun.thatcdn.cn/hexo/stellar/image/shot.webp"><link rel="stylesheet" href="/custom/css/ZYGlobal.css"><link rel="stylesheet" href="/custom/css/ZYWaline.css"><link rel="stylesheet" href="/custom/css/ZYPage.css"><script type="text/javascript" src="/custom/js/header.js"></script><!-- Clarity tracking code for https://blog.thatcoder.cn/ -->
<script>    (function(c,l,a,r,i,t,y){        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i+"?ref=bwt";        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);    })(window, document, "clarity", "script", "fi1zg7i5q5");</script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-H6GM3XZWV7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-H6GM3XZWV7');
</script>
<!-- BaiDu-ZhanZhang
<meta name="baidu-site-verification" content="codeva-8tnFVr706d" />
<!-- BaiDu-Tongji -->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?233765a020502d5d6a92d4fe306d36c2";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</head>
<body>



<div class="l_body s:aa content tech " id="start" layout="page" type="tech" ><aside class="l_left"><div class="sidebg"></div><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><div class="icon"><img no-lazy class="icon" src="/custom/img/ydl.png" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></div><a class="title" href="/wiki/YDLDoc3/ELK%E5%85%A5%E9%97%A8/elk%E5%85%A5%E9%97%A8/elk%E5%85%A5%E9%97%A8"><div class="main">YDLDoc3</div><div class="sub normal cap">关于YDLDoc的笔记</div><div class="sub hover cap" style="opacity:0"> 不对之处请指出</div></a></div></header>

<div class="nav-area">

<nav class="menu dis-select"><a class="nav-item" title="博客" href="/"><span>博客</span></a><a class="nav-item active" title="笔记" href="/wiki/"><span>笔记</span></a><a class="nav-item" title="便签" href="/notes/"><span>便签</span></a><a class="nav-item" title="社交" href="/links/"><span>社交</span></a></nav>
</div>
<div class="widgets">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" data-filter="/wiki/YDLDoc3/" placeholder="在 YDLDoc3 中搜索"></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div>


<widget class="widget-wrapper doc-tree post-list"><div class="widget-body fs14"><a class="link" href="/wiki/YDLDoc3/ELK%E5%85%A5%E9%97%A8/elk%E5%85%A5%E9%97%A8/elk%E5%85%A5%E9%97%A8/#start"><span class="toc-text">elk入门</span></a><a class="link active" href="/wiki/YDLDoc3/ELK%E5%85%A5%E9%97%A8/elk%E8%BF%9B%E9%98%B6/elk%E8%BF%9B%E9%98%B6/"><span class="toc-text">elk进阶</span><svg class="active-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M21 11.098v4.993c0 3.096 0 4.645-.734 5.321c-.35.323-.792.526-1.263.58c-.987.113-2.14-.907-4.445-2.946c-1.02-.901-1.529-1.352-2.118-1.47a2.225 2.225 0 0 0-.88 0c-.59.118-1.099.569-2.118 1.47c-2.305 2.039-3.458 3.059-4.445 2.945a2.238 2.238 0 0 1-1.263-.579C3 20.736 3 19.188 3 16.091v-4.994C3 6.81 3 4.666 4.318 3.333C5.636 2 7.758 2 12 2c4.243 0 6.364 0 7.682 1.332C21 4.665 21 6.81 21 11.098" opacity=".5"/><path fill="currentColor" d="M9 5.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5z"/></svg></a><a class="link" href="/wiki/YDLDoc3/kafka/kafka%E5%85%A5%E9%97%A8/kafka%E5%85%A5%E9%97%A8/"><span class="toc-text">kafka入门</span></a><a class="link" href="/wiki/YDLDoc3/kafka/kafka%E8%BF%9B%E9%98%B6/kafka%E8%BF%9B%E9%98%B6/"><span class="toc-text">kafka进阶</span></a><a class="link" href="/wiki/YDLDoc3/springcloud/SpringCloudAlibaba/SpringCloudAlibaba/"><span class="toc-text">SpringCloudAlibaba</span></a><a class="link" href="/wiki/YDLDoc3/springcloud/SpringCloud/SpringCloud/"><span class="toc-text">SpringCloud</span></a><a class="link" href="/wiki/YDLDoc3/%E4%B8%AD%E9%97%B4%E4%BB%B6/nginx%E5%85%A5%E9%97%A8/nginx%E5%85%A5%E9%97%A8/"><span class="toc-text">nginx入门</span></a><a class="link" href="/wiki/YDLDoc3/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rocketMQ/rocketMQ/"><span class="toc-text">rocketMQ</span></a><a class="link" href="/wiki/YDLDoc3/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitMQ/rabbitMQ/"><span class="toc-text">rabbitMQ</span></a></div></widget>

<widget class="widget-wrapper post-card"><div class="widget-header dis-select"><span class="name">更多：开发</span></div><div class="widget-body"><a class="item wiki" href="/wiki/YDLDoc2/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/maven%E5%85%A5%E9%97%A8/maven%E5%85%A5%E9%97%A8/"><span class="title">元动力摘录 - JAVA阶段二</span><span class="excerpt">钟意关于YDLDoc的笔记</span></a><a class="item wiki" href="/wiki/YDLDoc1/mysql%E5%AD%A6%E4%B9%A0/JDBC/JDBC/"><span class="title">元动力摘录 - JAVA阶段一</span><span class="excerpt">钟意关于YDLDoc的笔记</span></a><a class="item wiki" href="/wiki/YDLDoc4/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E5%B7%A5%E4%BD%9C%E6%B5%81/%E5%B7%A5%E4%BD%9C%E6%B5%81/"><span class="title">元动力摘录 - JAVA项目阶段</span><span class="excerpt">钟意关于YDLDoc的笔记</span></a><a class="item wiki" href="/wiki/YuDaoBoot/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%89%8B%E5%86%8C/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%8E%A5%E5%85%A5/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%8E%A5%E5%85%A5/"><span class="title">艿艿若依Boot - 开发指南</span><span class="excerpt">关于艿艿若依Boot的文档</span></a><a class="item wiki" href="/wiki/YuDaoCloud/%E5%90%8E%E7%AB%AF%E6%89%8B%E5%86%8C/OAuth%202.0%EF%BC%88SSO%20%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95)/OAuth%202.0%EF%BC%88SSO%20%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95)/"><span class="title">艿艿若依Cloud - 开发指南</span><span class="excerpt">关于艿艿若依Cloud的文档</span></a><a class="item wiki" href="/wiki/Laf/start/start/"><span class="title">Laf - 开箱即用的 serverless</span><span class="excerpt">钟意关于Laf的笔记</span></a><a class="item wiki" href="/wiki/MySql/basics/select/"><span class="title">MySql - 关系型数据库管理系统</span><span class="excerpt">钟意关于关系型数据库MySql的笔记</span></a><a class="item wiki" href="/wiki/SpringCloud/start/"><span class="title">SpringCloud - JAVA系分布式微服务架构</span><span class="excerpt">钟意关于SpringCloud的笔记</span></a></div></widget>

<widget class="widget-wrapper recent post-list"><div class="widget-header dis-select"><span class="name">最近更新</span></div><div class="widget-body fs14"><a class="item title" href="/wiki/WebWeekly/%E5%89%8D%E6%B2%BF%E6%8A%80%E6%9C%AF/%E3%80%8A%E6%95%B0%E6%8D%AE%E6%90%AD%E5%BB%BA%E5%BC%95%E6%93%8E%20bi-designer%20API-%E8%AE%BE%E8%AE%A1%E5%99%A8%E3%80%8B/"><span class="title"><strong>WebWeekly</strong><span class="dot"></span>《数据搭建引擎 bi-designer API-设计器》</span></a><a class="item title" href="/wiki/WebWeekly/%E5%89%8D%E6%B2%BF%E6%8A%80%E6%9C%AF/%E3%80%8A%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E3%80%8B/"><span class="title"><strong>WebWeekly</strong><span class="dot"></span>《源码学习》</span></a><a class="item title" href="/wiki/WebWeekly/%E7%AE%97%E6%B3%95/%E3%80%8A%E7%AE%97%E6%B3%95%E9%A2%98%20-%20%E5%9C%B0%E4%B8%8B%E5%9F%8E%E6%B8%B8%E6%88%8F%E3%80%8B/"><span class="title"><strong>WebWeekly</strong><span class="dot"></span>《算法题 - 地下城游戏》</span></a><a class="item title" href="/wiki/WebWeekly/%E5%89%8D%E6%B2%BF%E6%8A%80%E6%9C%AF/%E3%80%8A%E5%A6%82%E4%BD%95%E5%81%9A%E5%A5%BD%20CodeReview%E3%80%8B/"><span class="title"><strong>WebWeekly</strong><span class="dot"></span>《如何做好 CodeReview》</span></a><a class="item title" href="/wiki/YuDaoBoot/%E5%A4%A7%E5%B1%8F%E6%89%8B%E5%86%8C/%E5%A4%A7%E5%B1%8F%E8%AE%BE%E8%AE%A1%E5%99%A8/%E5%A4%A7%E5%B1%8F%E8%AE%BE%E8%AE%A1%E5%99%A8/"><span class="title"><strong>YuDaoBoot</strong><span class="dot"></span>大屏设计器</span></a><a class="item title" href="/wiki/YuDaoCloud/%E5%89%8D%E7%AB%AF%E6%89%8B%E5%86%8C%20Vue%203/%E7%B3%BB%E7%BB%9F%E7%BB%84%E4%BB%B6/%E7%B3%BB%E7%BB%9F%E7%BB%84%E4%BB%B6/"><span class="title"><strong>YuDaoCloud</strong><span class="dot"></span>系统组件</span></a></div></widget>
</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" style="grid-column: span 3;height:32px;padding: 0;" href="https://space.bilibili.com/1664687779" target="_blank" rel="external nofollow noopener noreferrer"><img height="32px" src="https://upyun.thatcdn.cn/public/img/icon/bilibili-banner.jpg"/></a><a class="social" style="grid-column: span 3;height:32px;padding: 0;" href="https://muselink.cc/naive" target="_blank" rel="external nofollow noopener noreferrer"><img height="32px" src="https://upyun.thatcdn.cn/public/img/icon/wechat-banner.jpg"/></a><a class="social" style="grid-column: span 3;height:32px;padding: 0;" href="https://github.com/ThatCoders" target="_blank" rel="external nofollow noopener noreferrer"><img height="32px" src="https://upyun.thatcdn.cn/public/img/icon/github-banner.jpg"/></a><a class="social" href="javascript:ThemeChange('dark');" rel="noopener noreferrer"><img id="ThemeM" src="https://upyun.thatcdn.cn/public/img/icon/Moon.png"/></a><a class="social" href="javascript:ThemeChange('light');" rel="noopener noreferrer"><img id="ThemeL" src="https://upyun.thatcdn.cn/public/img/icon/Sun.png"/></a><a class="social" href="javascript:ThemeChange('auto');" rel="noopener noreferrer"><img id="ThemeAI" src="https://upyun.thatcdn.cn/public/img/icon/AI.png"/></a></div></footer>
</div></aside><div class="l_main" id="main">





<div class="article banner top">
    <div class="content">
      <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a>
<span class="sep"></span><a class="cap breadcrumb" id="menu" href="/wiki/">文档</a><span class="sep"></span><a class="cap breadcrumb" id="proj" href="/wiki/YDLDoc3/ELK%E5%85%A5%E9%97%A8/elk%E5%85%A5%E9%97%A8/elk%E5%85%A5%E9%97%A8/">YDLDoc3</a></div>
<div class="flex-row" id="post-meta"><span class="text created">更新于：<time datetime="2025-07-21T12:21:47.982Z">2025-07-21</time></span></div></div></div>
      
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>elk进阶</span></h1>
        
      </div>
    </div>
    
    </div>
    </div><article class="md-text content"><div class="theme-hope-content"><h1 id="elk搜索高级课程" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#elk搜索高级课程">#</a> ELK搜索高级课程</h1><div class="hint-container tip"><p class="hint-container-title">提示</p><p>课程视频教程链接：<a href="https://www.bilibili.com/video/BV1hf4y1E7FD" rel="noopener noreferrer" target="_blank">https://www.bilibili.com/video/BV1hf4y1E7FD<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><h2 id="第十一章-索引index入门" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第十一章-索引index入门">#</a> 第十一章 索引Index入门</h2><h3 id="一、索引管理" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#一、索引管理">#</a> 一、索引管理</h3><h4 id="_1、为什么我们要手动创建索引" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、为什么我们要手动创建索引">#</a> 1、为什么我们要手动创建索引</h4><p>直接put数据 PUT index/_doc/1,es会自动生成索引，并建立动态映射dynamic mapping。</p><p>在生产上，我们需要自己手动建立索引和映射，为了更好地管理索引。就像数据库的建表语句一样。</p><h4 id="_2、索引管理" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、索引管理">#</a> 2、索引管理</h4><h5 id="_1-创建索引" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-创建索引">#</a> （1）创建索引</h5><p>创建索引的语法</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /index<br>&#123;<br>    &quot;settings&quot;: &#123; ... any settings ... &#125;,<br>    &quot;mappings&quot;: &#123;<br>       &quot;properties&quot; : &#123;<br>            &quot;field1&quot; : &#123; &quot;type&quot; : &quot;text&quot; &#125;<br>        &#125;<br>    &#125;,<br>    &quot;aliases&quot;: &#123;<br>        &quot;default_index&quot;: &#123;&#125;<br>  &#125; <br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>举例：</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /my_index<br>&#123;<br>  &quot;settings&quot;: &#123;<br>    &quot;number_of_shards&quot;: 1,<br>    &quot;number_of_replicas&quot;: 1<br>  &#125;,<br>  &quot;mappings&quot;: &#123;<br>    &quot;properties&quot;: &#123;<br>      &quot;field1&quot;:&#123;<br>        &quot;type&quot;: &quot;text&quot;<br>      &#125;,<br>      &quot;field2&quot;:&#123;<br>        &quot;type&quot;: &quot;text&quot;<br>      &#125;<br>    &#125;<br>  &#125;,<br>  &quot;aliases&quot;: &#123;<br>    &quot;default_index&quot;: &#123;&#125;<br>  &#125; <br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>索引别名</strong></p><p>插入数据</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs http">POST /my_index/_doc/1<br>&#123;<br>    &quot;field1&quot;:&quot;java&quot;,<br>    &quot;field2&quot;:&quot;js&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查询数据 都可以查到</p><p>GET /my_index/_doc/1</p><p>GET /default_index/_doc/1</p><h5 id="_2-查询索引" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-查询索引">#</a> （2）查询索引</h5><p>GET /my_index/_mapping</p><p>GET /my_index/_setting</p><h5 id="_3-修改索引" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-修改索引">#</a> （3）修改索引</h5><p>修改副本数</p><div class="language-console line-numbers-mode" data-ext="console"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight console"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs console">PUT /my_index/_settings<br>&#123;<br>    &quot;index&quot; : &#123;<br>        &quot;number_of_replicas&quot; : 2<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_4-删除索引" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-删除索引">#</a> （4）删除索引</h5><p>DELETE /my_index</p><p>DELETE /index_one,index_two</p><p>DELETE /index_*</p><p>DELETE /_all</p><p>为了安全起见，防止恶意删除索引，删除时必须指定索引名：</p><p>elasticsearch.yml</p><p>action.destructive_requires_name: true</p><h3 id="二、定制分词器" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#二、定制分词器">#</a> 二、定制分词器</h3><h4 id="_1、默认的分词器" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、默认的分词器">#</a> 1、默认的分词器</h4><p>standard</p><p>分词三个组件，character filter，tokenizer，token filter</p><p>standard tokenizer：以单词边界进行切分</p><p>standard token filter：什么都不做</p><p>lowercase token filter：将所有字母转换为小写</p><p>stop token filer（默认被禁用）：移除停用词，比如a the it等等</p><h4 id="_2、修改分词器的设置" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、修改分词器的设置">#</a> 2、修改分词器的设置</h4><p>启用english停用词token filter</p><div class="language-json line-numbers-mode" data-ext="json"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight json"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json">PUT /my_index<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;settings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;analysis&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;analyzer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;es_std&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;standard&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;stopwords&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_english_&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试分词</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /my_index/_analyze<br>&#123;<br>  &quot;analyzer&quot;: &quot;standard&quot;, <br>  &quot;text&quot;: &quot;a dog is in the house&quot;<br>&#125;<br><br>GET /my_index/_analyze<br>&#123;<br>  &quot;analyzer&quot;: &quot;es_std&quot;,<br>  &quot;text&quot;:&quot;a dog is in the house&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3、定制化自己的分词器" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、定制化自己的分词器">#</a> 3、定制化自己的分词器</h4><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /my_index<br>&#123;<br>  &quot;settings&quot;: &#123;<br>    &quot;analysis&quot;: &#123;<br>      &quot;char_filter&quot;: &#123;<br>        &quot;&amp;amp;_to_and&quot;: &#123;<br>          &quot;type&quot;: &quot;mapping&quot;,<br>          &quot;mappings&quot;: [&quot;&amp;amp;=&amp;gt; and&quot;]<br>        &#125;<br>      &#125;,<br>      &quot;filter&quot;: &#123;<br>        &quot;my_stopwords&quot;: &#123;<br>          &quot;type&quot;: &quot;stop&quot;,<br>          &quot;stopwords&quot;: [&quot;the&quot;, &quot;a&quot;]<br>        &#125;<br>      &#125;,<br>      &quot;analyzer&quot;: &#123;<br>        &quot;my_analyzer&quot;: &#123;<br>          &quot;type&quot;: &quot;custom&quot;,<br>          &quot;char_filter&quot;: [&quot;html_strip&quot;, &quot;&amp;amp;_to_and&quot;],<br>          &quot;tokenizer&quot;: &quot;standard&quot;,<br>          &quot;filter&quot;: [&quot;lowercase&quot;, &quot;my_stopwords&quot;]<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /my_index/_analyze<br>&#123;<br>  &quot;analyzer&quot;: &quot;my_analyzer&quot;,<br>  &quot;text&quot;: &quot;tom&amp;amp;jerry are a friend in the house, &amp;lt;a&amp;gt;, HAHA!!&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>设置字段使用自定义分词器</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /my_index/_mapping/<br>&#123;<br>  &quot;properties&quot;: &#123;<br>    &quot;content&quot;: &#123;<br>      &quot;type&quot;: &quot;text&quot;,<br>      &quot;analyzer&quot;: &quot;my_analyzer&quot;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="三、type底层结构及弃用原因" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#三、type底层结构及弃用原因">#</a> 三、type底层结构及弃用原因</h3><h4 id="_1、type是什么" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、type是什么">#</a> 1、type是什么</h4><p>type，是一个index中用来区分类似的数据的，类似的数据，但是可能有不同的fields，而且有不同的属性来控制索引建立、分词器. field的value，在底层的lucene中建立索引的时候，全部是opaque bytes类型，不区分类型的。 lucene是没有type的概念的，在document中，实际上将type作为一个document的field来存储，即_type，es通过_type来进行type的过滤和筛选。</p><h4 id="_2、es中不同type存储机制" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、es中不同type存储机制">#</a> 2、es中不同type存储机制</h4><p>一个index中的多个type，实际上是放在一起存储的，因此一个index下，不能有多个type重名，而类型或者其他设置不同的，因为那样是无法处理的</p><div class="language-json line-numbers-mode" data-ext="json"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight json"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>   <span class="hljs-attr">&quot;goods&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;mappings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>         <span class="hljs-attr">&quot;electronic_goods&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>               <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;double&quot;</span><br>               <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;service_period&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><br>                   <span class="hljs-punctuation">&#125;</span>         <br>                <span class="hljs-punctuation">&#125;</span><br>         <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;fresh_goods&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>               <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;double&quot;</span><br>               <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;eat_period&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><br>               <span class="hljs-punctuation">&#125;</span><br>                <span class="hljs-punctuation">&#125;</span><br>         <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><br>   <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /goods/electronic_goods/1<br>&#123;<br>  &quot;name&quot;: &quot;小米空调&quot;,<br>  &quot;price&quot;: 1999.0,<br>  &quot;service_period&quot;: &quot;one year&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /goods/fresh_goods/1<br>&#123;<br>  &quot;name&quot;: &quot;澳洲龙虾&quot;,<br>  &quot;price&quot;: 199.0,<br>  &quot;eat_period&quot;: &quot;one week&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>es文档在底层的存储是这样子的</p><div class="language-json line-numbers-mode" data-ext="json"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight json"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>   <span class="hljs-attr">&quot;goods&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;mappings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;false&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;double&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-attr">&quot;service_period&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;eat_period&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><br>   <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>底层数据存储格式</p><div class="language-json line-numbers-mode" data-ext="json"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight json"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;electronic_goods&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;小米空调&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1999.0</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;service_period&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;one year&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;eat_period&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-json line-numbers-mode" data-ext="json"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight json"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;fresh_goods&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;澳洲龙虾&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">199.0</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;service_period&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;eat_period&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;one week&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3、type弃用" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、type弃用">#</a> 3、type弃用</h4><p>同一索引下，不同type的数据存储其他type的field 大量空值，造成资源浪费。</p><p>所以，不同类型数据，要放到不同的索引中。</p><p>es9中，将会彻底删除type。</p><h3 id="四、定制dynamic-mapping" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#四、定制dynamic-mapping">#</a> 四、定制dynamic mapping</h3><h4 id="_1、定制dynamic策略" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、定制dynamic策略">#</a> 1、定制dynamic策略</h4><p>true：遇到陌生字段，就进行dynamic mapping</p><p>false：新检测到的字段将被忽略。这些字段将不会被索引，因此将无法搜索，但仍将出现在返回点击的源字段中。这些字段不会添加到映射中，必须显式添加新字段。</p><p>strict：遇到陌生字段，就报错</p><p>创建mapping</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /my_index<br>&#123;<br>    &quot;mappings&quot;: &#123;<br>      &quot;dynamic&quot;: &quot;strict&quot;,<br>       &quot;properties&quot;: &#123;<br>        &quot;title&quot;: &#123;<br>          &quot;type&quot;: &quot;text&quot;<br>        &#125;,<br>        &quot;address&quot;: &#123;<br>          &quot;type&quot;: &quot;object&quot;,<br>          &quot;dynamic&quot;: &quot;true&quot;<br>        &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>插入数据</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /my_index/_doc/1<br>&#123;<br>  &quot;title&quot;: &quot;my article&quot;,<br>  &quot;content&quot;: &quot;this is my article&quot;,<br>  &quot;address&quot;: &#123;<br>    &quot;province&quot;: &quot;guangdong&quot;,<br>    &quot;city&quot;: &quot;guangzhou&quot;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>报错</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs http">&#123;<br>  &quot;error&quot;: &#123;<br>    &quot;root_cause&quot;: [<br>      &#123;<br>        &quot;type&quot;: &quot;strict_dynamic_mapping_exception&quot;,<br>        &quot;reason&quot;: &quot;mapping set to strict, dynamic introduction of [content] within [_doc] is not allowed&quot;<br>      &#125;<br>    ],<br>    &quot;type&quot;: &quot;strict_dynamic_mapping_exception&quot;,<br>    &quot;reason&quot;: &quot;mapping set to strict, dynamic introduction of [content] within [_doc] is not allowed&quot;<br>  &#125;,<br>  &quot;status&quot;: 400<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2、自定义-dynamic-mapping策略" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、自定义-dynamic-mapping策略">#</a> 2、自定义 dynamic mapping策略</h4><p>es会根据传入的值，推断类型。</p><figure><img alt="1569123478530" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/ELK%E5%85%A5%E9%97%A8/elk%E8%BF%9B%E9%98%B6/1569123478530-b00805a3.png" tabindex="0"/><figcaption>1569123478530</figcaption></figure><h4 id="date-detection-日期探测" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#date-detection-日期探测">#</a> date_detection 日期探测</h4><p>默认会按照一定格式识别date，比如yyyy-MM-dd。但是如果某个field先过来一个2017-01-01的值，就会被自动dynamic mapping成date，后面如果再来一个"hello world"之类的值，就会报错。可以手动关闭某个type的date_detection，如果有需要，自己手动指定某个field为date类型。</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /my_index<br>&#123;<br>    &quot;mappings&quot;: &#123;<br>      &quot;date_detection&quot;: false,<br>       &quot;properties&quot;: &#123;<br>        &quot;title&quot;: &#123;<br>          &quot;type&quot;: &quot;text&quot;<br>        &#125;,<br>        &quot;address&quot;: &#123;<br>          &quot;type&quot;: &quot;object&quot;,<br>          &quot;dynamic&quot;: &quot;true&quot;<br>        &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /my_index/_doc/1<br>&#123;<br>  &quot;title&quot;: &quot;my article&quot;,<br>  &quot;content&quot;: &quot;this is my article&quot;,<br>  &quot;address&quot;: &#123;<br>    &quot;province&quot;: &quot;guangdong&quot;,<br>    &quot;city&quot;: &quot;guangzhou&quot;<br>  &#125;,<br>  &quot;post_date&quot;:&quot;2019-09-10&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看映射</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /my_index/_mapping<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><h4 id="自定义日期格式" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#自定义日期格式">#</a> 自定义日期格式</h4><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT my_index<br>&#123;<br>  &quot;mappings&quot;: &#123;<br>    &quot;dynamic_date_formats&quot;: [&quot;MM/dd/yyyy&quot;]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>插入数据</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT my_index/_doc/1<br>&#123;<br>  &quot;create_date&quot;: &quot;09/25/2019&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="numeric-detection-数字探测" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#numeric-detection-数字探测">#</a> numeric_detection 数字探测</h4><p>虽然json支持本机浮点和整数数据类型，但某些应用程序或语言有时可能将数字呈现为字符串。通常正确的解决方案是显式地映射这些字段，但是可以启用数字检测（默认情况下禁用）来自动完成这些操作。</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT my_index<br>&#123;<br>  &quot;mappings&quot;: &#123;<br>    &quot;numeric_detection&quot;: true<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT my_index/_doc/1<br>&#123;<br>  &quot;my_float&quot;:   &quot;1.0&quot;, <br>  &quot;my_integer&quot;: &quot;1&quot; <br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3、定制自己的dynamic-mapping-template" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、定制自己的dynamic-mapping-template">#</a> 3、定制自己的dynamic mapping template</h4><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /my_index<br>&#123;<br>    &quot;mappings&quot;: &#123;<br>            &quot;dynamic_templates&quot;: [<br>                &#123; <br>                  &quot;en&quot;: &#123;<br>                      &quot;match&quot;:              &quot;*_en&quot;, <br>                      &quot;match_mapping_type&quot;: &quot;string&quot;,<br>                      &quot;mapping&quot;: &#123;<br>                          &quot;type&quot;:           &quot;text&quot;,<br>                          &quot;analyzer&quot;:       &quot;english&quot;<br>                      &#125;<br>                &#125;                  <br>            &#125;<br>        ]<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>插入数据</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /my_index/_doc/1<br>&#123;<br>  &quot;title&quot;: &quot;this is my first article&quot;<br>&#125;<br><br>PUT /my_index/_doc/2<br>&#123;<br>  &quot;title_en&quot;: &quot;this is my first article&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>搜索</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">GET my_index/_search?q=first<br>GET my_index/_search?q=is<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>title没有匹配到任何的dynamic模板，默认就是standard分词器，不会过滤停用词，is会进入倒排索引，用is来搜索是可以搜索到的</p><p>title_en匹配到了dynamic模板，就是english分词器，会过滤停用词，is这种停用词就会被过滤掉，用is来搜索就搜索不到了</p><h4 id="模板写法" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#模板写法">#</a> 模板写法</h4><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT my_index<br>&#123;<br>  &quot;mappings&quot;: &#123;<br>    &quot;dynamic_templates&quot;: [<br>      &#123;<br>        &quot;integers&quot;: &#123;<br>          &quot;match_mapping_type&quot;: &quot;long&quot;,<br>          &quot;mapping&quot;: &#123;<br>            &quot;type&quot;: &quot;integer&quot;<br>          &#125;<br>        &#125;<br>      &#125;,<br>      &#123;<br>        &quot;strings&quot;: &#123;<br>          &quot;match_mapping_type&quot;: &quot;string&quot;,<br>          &quot;mapping&quot;: &#123;<br>            &quot;type&quot;: &quot;text&quot;,<br>            &quot;fields&quot;: &#123;<br>              &quot;raw&quot;: &#123;<br>                &quot;type&quot;:  &quot;keyword&quot;,<br>                &quot;ignore_above&quot;: 256<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>模板参数</p><div class="language-console line-numbers-mode" data-ext="console"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight console"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs console">&quot;match&quot;:   &quot;long_*&quot;,<br>&quot;unmatch&quot;: &quot;*_text&quot;,<br>&quot;match_mapping_type&quot;: &quot;string&quot;,<br>&quot;path_match&quot;:   &quot;name.*&quot;,<br>&quot;path_unmatch&quot;: &quot;*.middle&quot;,<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-ext="js"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight javascript"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-string">&quot;match_pattern&quot;</span>: <span class="hljs-string">&quot;regex&quot;</span>,<br><span class="hljs-string">&quot;match&quot;</span>: <span class="hljs-string">&quot;^profit_\d+$&quot;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="场景" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#场景">#</a> 场景</h4><p>1结构化搜索</p><p>默认情况下，elasticsearch将字符串字段映射为带有子关键字字段的文本字段。但是，如果只对结构化内容进行索引，而对全文搜索不感兴趣，则可以仅将“字段”映射为“关键字”。请注意，这意味着为了搜索这些字段，必须搜索索引所用的完全相同的值。</p><div class="language-json line-numbers-mode" data-ext="json"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight json"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;strings_as_keywords&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;match_mapping_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;mapping&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2仅搜索</p><p>与前面的示例相反，如果您只关心字符串字段的全文搜索，并且不打算对字符串字段运行聚合、排序或精确搜索，您可以告诉弹性搜索将其仅映射为文本字段（这是5之前的默认行为）</p><div class="language-json line-numbers-mode" data-ext="json"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight json"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;strings_as_text&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;match_mapping_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;mapping&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;text&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3norms 不关心评分</p><p>norms是指标时间的评分因素。如果您不关心评分，例如，如果您从不按评分对文档进行排序，则可以在索引中禁用这些评分因子的存储并节省一些空间。</p><div class="language-json line-numbers-mode" data-ext="json"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight json"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;strings_as_keywords&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;match_mapping_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;mapping&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;text&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;norms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;fields&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;keyword&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;ignore_above&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">256</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="五、零停机重建索引" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#五、零停机重建索引">#</a> 五、零停机重建索引</h3><h4 id="_1、零停机重建索引" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、零停机重建索引">#</a> 1、零停机重建索引</h4><p>场景：</p><p>一个field的设置是不能被修改的，如果要修改一个Field，那么应该重新按照新的mapping，建立一个index，然后将数据批量查询出来，重新用bulk api写入index中。</p><p>批量查询的时候，建议采用scroll api，并且采用多线程并发的方式来reindex数据，每次scoll就查询指定日期的一段数据，交给一个线程即可。</p><p>(1)一开始，依靠dynamic mapping，插入数据，但是不小心有些数据是2019-09-10这种日期格式的，所以title这种field被自动映射为了date类型，实际上它应该是string类型的</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /my_index/_doc/1<br>&#123;<br>  &quot;title&quot;: &quot;2019-09-10&quot;<br>&#125;<br><br>PUT /my_index/_doc/2<br>&#123;<br>  &quot;title&quot;: &quot;2019-09-11&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）当后期向索引中加入string类型的title值的时候，就会报错</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /my_index/_doc/3<br>&#123;<br>  &quot;title&quot;: &quot;my first article&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>报错</p><div class="language-json line-numbers-mode" data-ext="json"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight json"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;error&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;root_cause&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;mapper_parsing_exception&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;reason&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;failed to parse [title]&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;mapper_parsing_exception&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;reason&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;failed to parse [title]&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;caused_by&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;illegal_argument_exception&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;reason&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Invalid format: \&quot;my first article\&quot;&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">400</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（3）如果此时想修改title的类型，是不可能的</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /my_index/_mapping<br>&#123;<br>  &quot;properties&quot;: &#123;<br>    &quot;title&quot;: &#123;<br>      &quot;type&quot;: &quot;text&quot;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>报错</p><div class="language-json line-numbers-mode" data-ext="json"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight json"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;error&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;root_cause&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;illegal_argument_exception&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;reason&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;mapper [title] of different type, current_type [date], merged_type [text]&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;illegal_argument_exception&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;reason&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;mapper [title] of different type, current_type [date], merged_type [text]&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">400</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（4）此时，唯一的办法，就是进行reindex，也就是说，重新建立一个索引，将旧索引的数据查询出来，再导入新索引。</p><p>（5）如果说旧索引的名字，是old_index，新索引的名字是new_index，终端java应用，已经在使用old_index在操作了，难道还要去停止java应用，修改使用的index为new_index，才重新启动java应用吗？这个过程中，就会导致java应用停机，可用性降低。</p><p>（6）所以说，给java应用一个别名，这个别名是指向旧索引的，java应用先用着，java应用先用prod_index alias来操作，此时实际指向的是旧的my_index</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">PUT /my_index/_alias/prod_index<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>（7）新建一个index，调整其title的类型为string</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /my_index_new<br>&#123;<br>  &quot;mappings&quot;: &#123;<br>    &quot;properties&quot;: &#123;<br>        &quot;title&quot;: &#123;<br>         &quot;type&quot;: &quot;text&quot;<br>        &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（8）使用scroll api将数据批量查询出来</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /my_index/_search?scroll=1m<br>&#123;<br>    &quot;query&quot;: &#123;<br>        &quot;match_all&quot;: &#123;&#125;<br>    &#125;,    <br>    &quot;size&quot;:  1<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>返回</p><div class="language-json line-numbers-mode" data-ext="json"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight json"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;_scroll_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;DnF1ZXJ5VGhlbkZldGNoBQAAAAAAADpAFjRvbnNUWVZaVGpHdklqOV9zcFd6MncAAAAAAAA6QRY0b25zVFlWWlRqR3ZJajlfc3BXejJ3AAAAAAAAOkIWNG9uc1RZVlpUakd2SWo5X3NwV3oydwAAAAAAADpDFjRvbnNUWVZaVGpHdklqOV9zcFd6MncAAAAAAAA6RBY0b25zVFlWWlRqR3ZJajlfc3BXejJ3&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;took&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;timed_out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;max_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;my_index&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;my_type&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2019-01-02&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;sort&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-number">0</span><br>                <span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（9）采用bulk api将scoll查出来的一批数据，批量写入新索引</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">POST /_bulk<br>&#123; &quot;index&quot;:  &#123; &quot;_index&quot;: &quot;my_index_new&quot;, &quot;_id&quot;: &quot;1&quot; &#125;&#125;<br>&#123; &quot;title&quot;:    &quot;2019-09-10&quot; &#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（10）反复循环8~9，查询一批又一批的数据出来，采取bulk api将每一批数据批量写入新索引</p><p>（11）将prod_index alias切换到my_index_new上去，java应用会直接通过index别名使用新的索引中的数据，java应用程序不需要停机，零提交，高可用</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">POST /_aliases<br>&#123;<br>    &quot;actions&quot;: [<br>        &#123; &quot;remove&quot;: &#123; &quot;index&quot;: &quot;my_index&quot;, &quot;alias&quot;: &quot;prod_index&quot; &#125;&#125;,<br>        &#123; &quot;add&quot;:    &#123; &quot;index&quot;: &quot;my_index_new&quot;, &quot;alias&quot;: &quot;prod_index&quot; &#125;&#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（12）直接通过prod_index别名来查询，是否ok</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /prod_index/_search<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><h4 id="_2、生产实践-基于alias对client透明切换index" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、生产实践-基于alias对client透明切换index">#</a> 2、生产实践：基于alias对client透明切换index</h4><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">PUT /my_index_v1/_alias/my_index<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>client对my_index进行操作</p><p>reindex操作，完成之后，切换v1到v2</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">POST /_aliases<br>&#123;<br>    &quot;actions&quot;: [<br>        &#123; &quot;remove&quot;: &#123; &quot;index&quot;: &quot;my_index_v1&quot;, &quot;alias&quot;: &quot;my_index&quot; &#125;&#125;,<br>        &#123; &quot;add&quot;:    &#123; &quot;index&quot;: &quot;my_index_v2&quot;, &quot;alias&quot;: &quot;my_index&quot; &#125;&#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="第十二章-中文分词器-ik分词器" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第十二章-中文分词器-ik分词器">#</a> 第十二章 中文分词器 IK分词器</h2><h3 id="一、ik分词器安装使用" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#一、ik分词器安装使用">#</a> 一、Ik分词器安装使用</h3><h4 id="_1、中文分词器" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、中文分词器">#</a> 1、中文分词器</h4><p>standard 分词器，仅适用于英文。</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /_analyze<br>&#123;<br>  &quot;analyzer&quot;: &quot;standard&quot;,<br>  &quot;text&quot;: &quot;中华人民共和国人民大会堂&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们想要的效果是什么：中华人民共和国，人民大会堂</p><p>IK分词器就是目前最流行的es中文分词器</p><h4 id="_2、安装" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、安装">#</a> 2、安装</h4><p>官网：<a href="https://github.com/medcl/elasticsearch-analysis-ik" rel="noopener noreferrer" target="_blank">https://github.com/medcl/elasticsearch-analysis-ik<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>下载地址：<a href="https://github.com/medcl/elasticsearch-analysis-ik/releases" rel="noopener noreferrer" target="_blank">https://github.com/medcl/elasticsearch-analysis-ik/releases<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>根据es版本下载相应版本包。</p><p>解压到 es/plugins/ik中。</p><p>重启es</p><h4 id="_3、ik分词器基础知识" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、ik分词器基础知识">#</a> 3、ik分词器基础知识</h4><p>ik_max_word: 会将文本做最细粒度的拆分，比如会将“中华人民共和国人民大会堂”拆分为“中华人民共和国，中华人民，中华，华人，人民共和国，人民大会堂，人民大会，大会堂”，会穷尽各种可能的组合；</p><p>ik_smart: 会做最粗粒度的拆分，比如会将“中华人民共和国人民大会堂”拆分为“中华人民共和国，人民大会堂”。</p><h4 id="_4、ik分词器的使用" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4、ik分词器的使用">#</a> 4、ik分词器的使用</h4><p>存储时，使用ik_max_word，搜索时，使用ik_smart</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs text">PUT /my_index <br>&#123;<br>  &quot;mappings&quot;: &#123;<br>      &quot;properties&quot;: &#123;<br>        &quot;text&quot;: &#123;<br>          &quot;type&quot;: &quot;text&quot;,<br>          &quot;analyzer&quot;: &quot;ik_max_word&quot;,<br>          &quot;search_analyzer&quot;: &quot;ik_smart&quot;<br>        &#125;<br>      &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>搜索</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /my_index/_search?q=中华人民共和国人民大会堂<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><h3 id="二、-ik配置文件" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#二、-ik配置文件">#</a> 二、 ik配置文件</h3><h4 id="_1、-ik配置文件" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、-ik配置文件">#</a> 1、 ik配置文件</h4><p>ik配置文件地址：es/plugins/ik/config目录</p><p>IKAnalyzer.cfg.xml：用来配置自定义词库</p><p>main.dic：ik原生内置的中文词库，总共有27万多条，只要是这些单词，都会被分在一起</p><p>preposition.dic: 介词</p><p>quantifier.dic：放了一些单位相关的词，量词</p><p>suffix.dic：放了一些后缀</p><p>surname.dic：中国的姓氏</p><p>stopword.dic：英文停用词</p><p>ik原生最重要的两个配置文件</p><p>main.dic：包含了原生的中文词语，会按照这个里面的词语去分词</p><p>stopword.dic：包含了英文的停用词</p><p>停用词，stopword</p><p>a the and at but</p><p>一般，像停用词，会在分词的时候，直接被干掉，不会建立在倒排索引中</p><h4 id="_2、自定义词库" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、自定义词库">#</a> 2、自定义词库</h4><p>（1）自己建立词库：每年都会涌现一些特殊的流行词，网红，蓝瘦香菇，喊麦，鬼畜，一般不会在ik的原生词典里</p><p>自己补充自己的最新的词语，到ik的词库里面</p><p>IKAnalyzer.cfg.xml：ext_dict，创建mydict.dic。</p><p>补充自己的词语，然后需要重启es，才能生效</p><p>（2）自己建立停用词库：比如了，的，啥，么，我们可能并不想去建立索引，让人家搜索</p><p>custom/ext_stopword.dic，已经有了常用的中文停用词，可以补充自己的停用词，然后重启es</p><h3 id="三、使用mysql热更新-词库" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#三、使用mysql热更新-词库">#</a> 三、使用mysql热更新 词库</h3><h4 id="_1、热更新" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、热更新">#</a> 1、热更新</h4><p>每次都是在es的扩展词典中，手动添加新词语，很坑</p><p>（1）每次添加完，都要重启es才能生效，非常麻烦</p><p>（2）es是分布式的，可能有数百个节点，你不能每次都一个一个节点上面去修改</p><p>es不停机，直接我们在外部某个地方添加新的词语，es中立即热加载到这些新词语</p><p>热更新的方案</p><p>（1）基于ik分词器原生支持的热更新方案，部署一个web服务器，提供一个http接口，通过modified和tag两个http响应头，来提供词语的热更新</p><p>（2）修改ik分词器源码，然后手动支持从mysql中每隔一定时间，自动加载新的词库</p><p>用第二种方案，第一种，ik git社区官方都不建议采用，觉得不太稳定</p><h4 id="_2、步骤" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、步骤">#</a> 2、步骤</h4><p>1、下载源码</p><p><a href="https://github.com/medcl/elasticsearch-analysis-ik/releases" rel="noopener noreferrer" target="_blank">https://github.com/medcl/elasticsearch-analysis-ik/releases<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>ik分词器，是个标准的java maven工程，直接导入eclipse就可以看到源码</p><p>2、修改源</p><p>org.wltea.analyzer.dic.Dictionary类，160行Dictionary单例类的初始化方法，在这里需要创建一个我们自定义的线程，并且启动它</p><p>org.wltea.analyzer.dic.HotDictReloadThread类：就是死循环，不断调用Dictionary.getSingleton().reLoadMainDict()，去重新加载词典</p><p>Dictionary类，399行：this.loadMySQLExtDict(); 加载mymsql字典。</p><p>Dictionary类，609行：this.loadMySQLStopwordDict();加载mysql停用词</p><p>config下jdbc-reload.properties。mysql配置文件</p><p>3、mvn package打包代码</p><p>target\releases\elasticsearch-analysis-ik-7.3.0.zip</p><p>4、解压缩ik压缩包</p><p>将mysql驱动jar，放入ik的目录下</p><p>5、修改jdbc相关配置</p><p>6、重启es</p><p>观察日志，日志中就会显示我们打印的那些东西，比如加载了什么配置，加载了什么词语，什么停用词</p><p>7、在mysql中添加词库与停用词</p><p>8、分词实验，验证热更新生效</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /_analyze<br>&#123;<br>  &quot;analyzer&quot;: &quot;ik_smart&quot;,<br>  &quot;text&quot;: &quot;传智播客&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="第十三章-java-api-实现索引管理" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第十三章-java-api-实现索引管理">#</a> 第十三章 java api 实现索引管理</h2><p>代码</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestIndex</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    RestHighLevelClient client;<br><br>    <span class="hljs-comment">//    @Autowired</span><br>    <span class="hljs-comment">//    RestClient restClient;</span><br>    <span class="hljs-comment">//创建索引</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCreateIndex</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">//创建索引对象</span><br>        <span class="hljs-type">CreateIndexRequest</span> <span class="hljs-variable">createIndexRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CreateIndexRequest</span>(<span class="hljs-string">&quot;ydlclass_book&quot;</span>);<br>        <span class="hljs-comment">//设置参数</span><br>        createIndexRequest.settings(Settings.builder().put(<span class="hljs-string">&quot;number_of_shards&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>).put(<span class="hljs-string">&quot;number_of_replicas&quot;</span>, <span class="hljs-string">&quot;0&quot;</span>));<br>        <span class="hljs-comment">//指定映射1</span><br>        createIndexRequest.mapping(<span class="hljs-string">&quot; &#123;\n&quot;</span> +<br>                                   <span class="hljs-string">&quot; \t\&quot;properties\&quot;: &#123;\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;            \&quot;name\&quot;:&#123;\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;             \&quot;type\&quot;:\&quot;keyword\&quot;\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;           &#125;,\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;           \&quot;description\&quot;: &#123;\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;              \&quot;type\&quot;: \&quot;text\&quot;\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;           &#125;,\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;            \&quot;price\&quot;:&#123;\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;             \&quot;type\&quot;:\&quot;long\&quot;\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;           &#125;,\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;           \&quot;pic\&quot;:&#123;\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;             \&quot;type\&quot;:\&quot;text\&quot;,\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;             \&quot;index\&quot;:false\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;           &#125;\n&quot;</span> +<br>                                   <span class="hljs-string">&quot; \t&#125;\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;&#125;&quot;</span>, XContentType.JSON);<br><br>        <span class="hljs-comment">//指定映射2</span><br><br><br>        <span class="hljs-comment">//        Map&amp;lt;String, Object&amp;gt; message = new HashMap&amp;lt;&amp;gt;();</span><br>        <span class="hljs-comment">//        message.put(&quot;type&quot;, &quot;text&quot;);</span><br>        <span class="hljs-comment">//        Map&amp;lt;String, Object&amp;gt; properties = new HashMap&amp;lt;&amp;gt;();</span><br>        <span class="hljs-comment">//        properties.put(&quot;message&quot;, message);</span><br>        <span class="hljs-comment">//        Map&amp;lt;String, Object&amp;gt; mapping = new HashMap&amp;lt;&amp;gt;();</span><br>        <span class="hljs-comment">//        mapping.put(&quot;properties&quot;, properties);</span><br>        <span class="hljs-comment">//        createIndexRequest.mapping(mapping);</span><br><br>        <span class="hljs-comment">//指定映射3</span><br><br><br>        <span class="hljs-comment">//        XContentBuilder builder = XContentFactory.jsonBuilder();</span><br>        <span class="hljs-comment">//        builder.startObject();</span><br>        <span class="hljs-comment">//        &#123;</span><br>        <span class="hljs-comment">//            builder.startObject(&quot;properties&quot;);</span><br>        <span class="hljs-comment">//            &#123;</span><br>        <span class="hljs-comment">//                builder.startObject(&quot;message&quot;);</span><br>        <span class="hljs-comment">//                &#123;</span><br>        <span class="hljs-comment">//                    builder.field(&quot;type&quot;, &quot;text&quot;);</span><br>        <span class="hljs-comment">//                &#125;</span><br>        <span class="hljs-comment">//                builder.endObject();</span><br>        <span class="hljs-comment">//            &#125;</span><br>        <span class="hljs-comment">//            builder.endObject();</span><br>        <span class="hljs-comment">//        &#125;</span><br>        <span class="hljs-comment">//        builder.endObject();</span><br>        <span class="hljs-comment">//        createIndexRequest.mapping(builder);</span><br><br><br>        <span class="hljs-comment">//设置别名</span><br>        createIndexRequest.alias(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Alias</span>(<span class="hljs-string">&quot;ydlclass_index_new&quot;</span>));<br><br>        <span class="hljs-comment">// 额外参数</span><br>        <span class="hljs-comment">//设置超时时间</span><br>        createIndexRequest.setTimeout(TimeValue.timeValueMinutes(<span class="hljs-number">2</span>));<br>        <span class="hljs-comment">//设置主节点超时时间</span><br>        createIndexRequest.setMasterTimeout(TimeValue.timeValueMinutes(<span class="hljs-number">1</span>));<br>        <span class="hljs-comment">//在创建索引API返回响应之前等待的活动分片副本的数量，以int形式表示</span><br>        createIndexRequest.waitForActiveShards(ActiveShardCount.from(<span class="hljs-number">2</span>));<br>        createIndexRequest.waitForActiveShards(ActiveShardCount.DEFAULT);<br><br>        <span class="hljs-comment">//操作索引的客户端</span><br>        <span class="hljs-type">IndicesClient</span> <span class="hljs-variable">indices</span> <span class="hljs-operator">=</span> client.indices();<br>        <span class="hljs-comment">//执行创建索引库</span><br>        <span class="hljs-type">CreateIndexResponse</span> <span class="hljs-variable">createIndexResponse</span> <span class="hljs-operator">=</span> indices.create(createIndexRequest, RequestOptions.DEFAULT);<br><br>        <span class="hljs-comment">//得到响应（全部）</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">acknowledged</span> <span class="hljs-operator">=</span> createIndexResponse.isAcknowledged();<br>        <span class="hljs-comment">//得到响应 指示是否在超时前为索引中的每个分片启动了所需数量的碎片副本</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">shardsAcknowledged</span> <span class="hljs-operator">=</span> createIndexResponse.isShardsAcknowledged();<br><br>        System.out.println(<span class="hljs-string">&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot;</span> + acknowledged);<br>        System.out.println(shardsAcknowledged);<br><br>    &#125;<br><br><br>    <span class="hljs-comment">//异步新增索引</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCreateIndexAsync</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">//创建索引对象</span><br>        <span class="hljs-type">CreateIndexRequest</span> <span class="hljs-variable">createIndexRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CreateIndexRequest</span>(<span class="hljs-string">&quot;ydlclass_book2&quot;</span>);<br>        <span class="hljs-comment">//设置参数</span><br>        createIndexRequest.settings(Settings.builder().put(<span class="hljs-string">&quot;number_of_shards&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>).put(<span class="hljs-string">&quot;number_of_replicas&quot;</span>, <span class="hljs-string">&quot;0&quot;</span>));<br>        <span class="hljs-comment">//指定映射1</span><br>        createIndexRequest.mapping(<span class="hljs-string">&quot; &#123;\n&quot;</span> +<br>                                   <span class="hljs-string">&quot; \t\&quot;properties\&quot;: &#123;\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;            \&quot;name\&quot;:&#123;\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;             \&quot;type\&quot;:\&quot;keyword\&quot;\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;           &#125;,\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;           \&quot;description\&quot;: &#123;\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;              \&quot;type\&quot;: \&quot;text\&quot;\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;           &#125;,\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;            \&quot;price\&quot;:&#123;\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;             \&quot;type\&quot;:\&quot;long\&quot;\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;           &#125;,\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;           \&quot;pic\&quot;:&#123;\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;             \&quot;type\&quot;:\&quot;text\&quot;,\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;             \&quot;index\&quot;:false\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;           &#125;\n&quot;</span> +<br>                                   <span class="hljs-string">&quot; \t&#125;\n&quot;</span> +<br>                                   <span class="hljs-string">&quot;&#125;&quot;</span>, XContentType.JSON);<br><br>        <span class="hljs-comment">//监听方法</span><br>        ActionListener&amp;lt;CreateIndexResponse&amp;gt; listener =<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActionListener</span>&amp;lt;CreateIndexResponse&amp;gt;() &#123;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResponse</span><span class="hljs-params">(CreateIndexResponse createIndexResponse)</span> &#123;<br>                System.out.println(<span class="hljs-string">&quot;!!!!!!!!创建索引成功&quot;</span>);<br>                System.out.println(createIndexResponse.toString());<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFailure</span><span class="hljs-params">(Exception e)</span> &#123;<br>                System.out.println(<span class="hljs-string">&quot;!!!!!!!!创建索引失败&quot;</span>);<br>                e.printStackTrace();<br>            &#125;<br>        &#125;;<br><br>        <span class="hljs-comment">//操作索引的客户端</span><br>        <span class="hljs-type">IndicesClient</span> <span class="hljs-variable">indices</span> <span class="hljs-operator">=</span> client.indices();<br>        <span class="hljs-comment">//执行创建索引库</span><br>        indices.createAsync(createIndexRequest, RequestOptions.DEFAULT, listener);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">5000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br><br><br>    <span class="hljs-comment">//删除索引库</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDeleteIndex</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">//删除索引对象</span><br>        <span class="hljs-type">DeleteIndexRequest</span> <span class="hljs-variable">deleteIndexRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeleteIndexRequest</span>(<span class="hljs-string">&quot;ydlclass_book2&quot;</span>);<br>        <span class="hljs-comment">//操作索引的客户端</span><br>        <span class="hljs-type">IndicesClient</span> <span class="hljs-variable">indices</span> <span class="hljs-operator">=</span> client.indices();<br>        <span class="hljs-comment">//执行删除索引</span><br>        <span class="hljs-type">AcknowledgedResponse</span> <span class="hljs-variable">delete</span> <span class="hljs-operator">=</span> indices.delete(deleteIndexRequest, RequestOptions.DEFAULT);<br>        <span class="hljs-comment">//得到响应</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">acknowledged</span> <span class="hljs-operator">=</span> delete.isAcknowledged();<br>        System.out.println(acknowledged);<br><br>    &#125;<br><br>    <span class="hljs-comment">//异步删除索引库</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDeleteIndexAsync</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">//删除索引对象</span><br>        <span class="hljs-type">DeleteIndexRequest</span> <span class="hljs-variable">deleteIndexRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeleteIndexRequest</span>(<span class="hljs-string">&quot;ydlclass_book2&quot;</span>);<br>        <span class="hljs-comment">//操作索引的客户端</span><br>        <span class="hljs-type">IndicesClient</span> <span class="hljs-variable">indices</span> <span class="hljs-operator">=</span> client.indices();<br><br>        <span class="hljs-comment">//监听方法</span><br>        ActionListener&amp;lt;AcknowledgedResponse&amp;gt; listener =<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActionListener</span>&amp;lt;AcknowledgedResponse&amp;gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResponse</span><span class="hljs-params">(AcknowledgedResponse deleteIndexResponse)</span> &#123;<br>                System.out.println(<span class="hljs-string">&quot;!!!!!!!!删除索引成功&quot;</span>);<br>                System.out.println(deleteIndexResponse.toString());<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFailure</span><span class="hljs-params">(Exception e)</span> &#123;<br>                System.out.println(<span class="hljs-string">&quot;!!!!!!!!删除索引失败&quot;</span>);<br>                e.printStackTrace();<br>            &#125;<br>        &#125;;<br>        <span class="hljs-comment">//执行删除索引</span><br>        indices.deleteAsync(deleteIndexRequest, RequestOptions.DEFAULT, listener);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">5000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-comment">// Indices Exists API</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testExistIndex</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">GetIndexRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GetIndexRequest</span>(<span class="hljs-string">&quot;ydlclass_book&quot;</span>);<br>        request.local(<span class="hljs-literal">false</span>);<span class="hljs-comment">//从主节点返回本地信息或检索状态</span><br>        request.humanReadable(<span class="hljs-literal">true</span>);<span class="hljs-comment">//以适合人类的格式返回结果</span><br>        request.includeDefaults(<span class="hljs-literal">false</span>);<span class="hljs-comment">//是否返回每个索引的所有默认设置</span><br><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">exists</span> <span class="hljs-operator">=</span> client.indices().exists(request, RequestOptions.DEFAULT);<br>        System.out.println(exists);<br>    &#125;<br><br><br>    <span class="hljs-comment">// Indices Open API</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testOpenIndex</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">OpenIndexRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenIndexRequest</span>(<span class="hljs-string">&quot;ydlclass_book&quot;</span>);<br><br>        <span class="hljs-type">OpenIndexResponse</span> <span class="hljs-variable">openIndexResponse</span> <span class="hljs-operator">=</span> client.indices().open(request, RequestOptions.DEFAULT);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">acknowledged</span> <span class="hljs-operator">=</span> openIndexResponse.isAcknowledged();<br>        System.out.println(<span class="hljs-string">&quot;!!!!!!!!!&quot;</span>+acknowledged);<br>    &#125;<br><br>    <span class="hljs-comment">// Indices Close API</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCloseIndex</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">CloseIndexRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CloseIndexRequest</span>(<span class="hljs-string">&quot;index&quot;</span>);<br>        <span class="hljs-type">AcknowledgedResponse</span> <span class="hljs-variable">closeIndexResponse</span> <span class="hljs-operator">=</span> client.indices().close(request, RequestOptions.DEFAULT);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">acknowledged</span> <span class="hljs-operator">=</span> closeIndexResponse.isAcknowledged();<br>        System.out.println(<span class="hljs-string">&quot;!!!!!!!!!&quot;</span>+acknowledged);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="第十四章-search搜索入门" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第十四章-search搜索入门">#</a> 第十四章 search搜索入门</h2><h3 id="一、搜索语法入门" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#一、搜索语法入门">#</a> 一、搜索语法入门</h3><h4 id="_1、query-string-search" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、query-string-search">#</a> 1、query string search</h4><p>无条件搜索所有</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_search<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><div class="language-json line-numbers-mode" data-ext="json"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight json"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;took&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">969</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;timed_out&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;_shards&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;total&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;successful&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;skipped&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;failed&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;hits&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;total&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;value&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;relation&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eq&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;max_score&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1.0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hits&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>      <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;_index&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;book&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;_type&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;_score&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1.0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;_source&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Bootstrap开发&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;description&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Bootstrap是由Twitter推出的一个前台页面开发css框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长css页面开发的程序人员）轻松的实现一个css，不受浏览器限制的精美界面css效果。&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;studymodel&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;201002&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;price&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">38.6</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;timestamp&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2019-08-25 19:11:35&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;pic&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;tags&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-string">&quot;bootstrap&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-string">&quot;dev&quot;</span><br>          <span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;_index&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;book&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;_type&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;_score&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1.0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;_source&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java编程思想&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;description&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java语言是世界第一编程语言，在软件开发领域使用人数最多。&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;studymodel&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;201001&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;price&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">68.6</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;timestamp&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2019-08-25 19:11:35&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;pic&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;tags&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-string">&quot;java&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-string">&quot;dev&quot;</span><br>          <span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;_index&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;book&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;_type&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;3&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;_score&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1.0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;_source&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;spring开发基础&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;description&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;spring 在java领域非常流行，java程序员都在用。&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;studymodel&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;201001&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;price&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">88.6</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;timestamp&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2019-08-24 19:11:35&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;pic&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;tags&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-string">&quot;spring&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-string">&quot;java&quot;</span><br>          <span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>解释</p><p>took：耗费了几毫秒</p><p>timed_out：是否超时，这里是没有</p><p>_shards：到几个分片搜索，成功几个，跳过几个，失败几个。</p><p>hits.total：查询结果的数量，3个document</p><p>hits.max_score：score的含义，就是document对于一个search的相关度的匹配分数，越相关，就越匹配，分数也高</p><p>hits.hits：包含了匹配搜索的document的所有详细数据</p><h4 id="_2、传参" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、传参">#</a> 2、传参</h4><p>与http请求传参类似</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_search?q=name:java&amp;amp;sort=price:desc<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>类比sql: select * from book where name like ’ %java%’ order by price desc</p><div class="language-json line-numbers-mode" data-ext="json"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight json"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;took&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;timed_out&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;_shards&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;total&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;successful&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;skipped&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;failed&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;hits&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;total&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;value&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;relation&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eq&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;max_score&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hits&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>      <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;_index&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;book&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;_type&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;_score&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;_source&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;name&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java编程思想&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;description&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java语言是世界第一编程语言，在软件开发领域使用人数最多。&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;studymodel&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;201001&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;price&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">68.6</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;timestamp&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2019-08-25 19:11:35&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;pic&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;tags&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-string">&quot;java&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-string">&quot;dev&quot;</span><br>          <span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;sort&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>          <span class="hljs-number">68.6</span><br>        <span class="hljs-punctuation">]</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3、图解timeout" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、图解timeout">#</a> 3、图解timeout</h4><p>GET /book/_search?timeout=10ms</p><p>全局设置：配置文件中设置 search.default_search_timeout：100ms。默认不超时。</p><h3 id="二、multi-index-多索引搜索" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#二、multi-index-多索引搜索">#</a> 二、multi-index 多索引搜索</h3><h4 id="_1、multi-index搜索模式" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、multi-index搜索模式">#</a> 1、multi-index搜索模式</h4><p>告诉你如何一次性搜索多个index和多个type下的数据</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">/_search：所有索引下的所有数据都搜索出来<br>/index1/_search：指定一个index，搜索其下所有的数据<br>/index1,index2/_search：同时搜索两个index下的数据<br>/index*/_search：按照通配符去匹配多个索引<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>应用场景：生产环境log索引可以按照日期分开。</p><p>log_to_es_20190910</p><p>log_to_es_20190911</p><p>log_to_es_20180910</p><h4 id="_2、初步图解一下简单的搜索原理" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、初步图解一下简单的搜索原理">#</a> 2、初步图解一下简单的搜索原理</h4><p>搜索原理初步图解</p><h3 id="三、分页搜索" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#三、分页搜索">#</a> 三、分页搜索</h3><h4 id="_1、分页搜索的语法" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、分页搜索的语法">#</a> 1、分页搜索的语法</h4><p>sql: select * from book limit 1,5</p><p>size，from</p><p>GET /book/_search?size=10</p><p>GET /book/_search?size=10&amp;from=0</p><p>GET /book/_search?size=10&amp;from=20</p><p>GET /book_search?from=0&amp;size=3</p><h4 id="_2、deep-paging" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、deep-paging">#</a> 2、deep paging</h4><h5 id="什么是deep-paging" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#什么是deep-paging">#</a> 什么是deep paging</h5><p>根据相关度评分倒排序，所以分页过深，协调节点会将大量数据聚合分析。</p><h5 id="deep-paging-性能问题" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#deep-paging-性能问题">#</a> deep paging 性能问题</h5><p>1消耗网络带宽，因为所搜过深的话，各 shard 要把数据传递给 coordinate node，这个过程是有大量数据传递的，消耗网络。</p><p>2消耗内存，各 shard 要把数据传送给 coordinate node，这个传递回来的数据，是被 coordinate node 保存在内存中的，这样会大量消耗内存。</p><p>3消耗cup，coordinate node 要把传回来的数据进行排序，这个排序过程很消耗cpu。 所以：鉴于deep paging的性能问题，所有应尽量减少使用。</p><h3 id="四、-query-string基础语法" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#四、-query-string基础语法">#</a> 四、 query string基础语法</h3><h4 id="_1、query-string基础语法" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、query-string基础语法">#</a> 1、query string基础语法</h4><p>GET /book/_search?q=name:java</p><p>GET /book/_search?q=+name:java</p><p>GET /book/_search?q=-name:java</p><p>一个是掌握q=field:search content的语法，还有一个是掌握+和-的含义</p><h4 id="_2、-all-metadata的原理和作用" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、-all-metadata的原理和作用">#</a> 2、_all metadata的原理和作用</h4><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /book/_search?q=java<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>直接可以搜索所有的field，任意一个field包含指定的关键字就可以搜索出来。我们在进行中搜索的时候，难道是对document中的每一个field都进行一次搜索吗？不是的。</p><p>es中_all元数据。建立索引的时候，插入一条docunment，es会将所有的field值经行全量分词，把这些分词，放到_all field中。在搜索的时候，没有指定field，就在_all搜索。</p><p>举例</p><div class="language-json line-numbers-mode" data-ext="json"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight json"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    name<span class="hljs-punctuation">:</span>jack<br>    email<span class="hljs-punctuation">:</span><span class="hljs-number">123</span>@qq.com<br>    address<span class="hljs-punctuation">:</span>beijing<br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>_all : <a href="mailto:jack,123@qq.com">jack,123@qq.com</a>,beijing</p><h3 id="五、query-dsl入门" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#五、query-dsl入门">#</a> 五、query DSL入门</h3><h4 id="_1、dsl" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、dsl">#</a> 1、DSL</h4><p>query string 后边的参数原来越多，搜索条件越来越复杂，不能满足需求。</p><p>GET /book/_search?q=name:java&amp;size=10&amp;from=0&amp;sort=price:desc</p><p>DSL:Domain Specified Language，特定领域的语言</p><p>es特有的搜索语言，可在请求体中携带搜索条件，功能强大。</p><p>查询全部 GET /book/_search</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /book/_search<br>&#123;<br>  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>排序 GET /book/_search?sort=price:desc</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /book/_search <br>&#123;<br>    &quot;query&quot; : &#123;<br>        &quot;match&quot; : &#123;<br>            &quot;name&quot; : &quot; java&quot;<br>        &#125;<br>    &#125;,<br>    &quot;sort&quot;: [<br>        &#123; &quot;price&quot;: &quot;desc&quot; &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>分页查询 GET /book/_search?size=10&amp;from=0</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs http">GET  /book/_search <br>&#123;<br>  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;,<br>  &quot;from&quot;: 0,<br>  &quot;size&quot;: 1<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>指定返回字段 GET /book/ _search? _source=name,studymodel</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /book/_search <br>&#123;<br>  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;,<br>  &quot;_source&quot;: [&quot;name&quot;, &quot;studymodel&quot;]<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过组合以上各种类型查询，实现复杂查询。</p><h4 id="_2、-query-dsl语法" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、-query-dsl语法">#</a> 2、 Query DSL语法</h4><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs http">&#123;<br>    QUERY_NAME: &#123;<br>        ARGUMENT: VALUE,<br>        ARGUMENT: VALUE,...<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs http">&#123;<br>    QUERY_NAME: &#123;<br>        FIELD_NAME: &#123;<br>            ARGUMENT: VALUE,<br>            ARGUMENT: VALUE,...<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /test_index/_search <br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;match&quot;: &#123;<br>      &quot;test_field&quot;: &quot;test&quot;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3、组合多个搜索条件" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、组合多个搜索条件">#</a> 3、组合多个搜索条件</h4><p>搜索需求：title必须包含elasticsearch，content可以包含elasticsearch也可以不包含，author_id必须不为111</p><p>sql where and or !=</p><p>初始数据：</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs http">POST /website/_doc/1<br>&#123;<br>          &quot;title&quot;: &quot;my hadoop article&quot;,<br>          &quot;content&quot;: &quot;hadoop is very bad&quot;,<br>          &quot;author_id&quot;: 111<br>&#125;<br><br>POST /website/_doc/2<br>&#123;<br>          &quot;title&quot;: &quot;my elasticsearch  article&quot;,<br>          &quot;content&quot;: &quot;es is very bad&quot;,<br>          &quot;author_id&quot;: 112<br>&#125;<br>POST /website/_doc/3<br>&#123;<br>          &quot;title&quot;: &quot;my elasticsearch article&quot;,<br>          &quot;content&quot;: &quot;es is very goods&quot;,<br>          &quot;author_id&quot;: 111<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>搜索：</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /website/_doc/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;bool&quot;: &#123;<br>      &quot;must&quot;: [<br>        &#123;<br>          &quot;match&quot;: &#123;<br>            &quot;title&quot;: &quot;elasticsearch&quot;<br>          &#125;<br>        &#125;<br>      ],<br>      &quot;should&quot;: [<br>        &#123;<br>          &quot;match&quot;: &#123;<br>            &quot;content&quot;: &quot;elasticsearch&quot;<br>          &#125;<br>        &#125;<br>      ],<br>      &quot;must_not&quot;: [<br>        &#123;<br>          &quot;match&quot;: &#123;<br>            &quot;author_id&quot;: 111<br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>返回：</p><div class="language-json line-numbers-mode" data-ext="json"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight json"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;took&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">488</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;timed_out&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;_shards&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;total&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;successful&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;skipped&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;failed&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;hits&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;total&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;value&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;relation&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eq&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;max_score&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">0.47000363</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hits&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>      <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;_index&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;website&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;_type&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;_score&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">0.47000363</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;_source&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;title&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;my elasticsearch  article&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;content&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;es is very bad&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;author_id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">112</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>更复杂的搜索需求：</p><p>select * from test_index where name='tom' or (hired =true and (personality ='good' and rude != true ))</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /test_index/_search<br>&#123;<br>    &quot;query&quot;: &#123;<br>            &quot;bool&quot;: &#123;<br>                &quot;must&quot;: &#123; &quot;match&quot;:&#123; &quot;name&quot;: &quot;tom&quot; &#125;&#125;,<br>                &quot;should&quot;: [<br>                    &#123; &quot;match&quot;:&#123; &quot;hired&quot;: true &#125;&#125;,<br>                    &#123; &quot;bool&quot;: &#123;<br>                        &quot;must&quot;:&#123; &quot;match&quot;: &#123; &quot;personality&quot;: &quot;good&quot; &#125;&#125;,<br>                        &quot;must_not&quot;: &#123; &quot;match&quot;: &#123; &quot;rude&quot;: true &#125;&#125;<br>                    &#125;&#125;<br>                ],<br>                &quot;minimum_should_match&quot;: 1<br>            &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="六、full-text-search-全文检索" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#六、full-text-search-全文检索">#</a> 六、full-text search 全文检索</h3><h4 id="_1、全文检索" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、全文检索">#</a> 1、全文检索</h4><p>重新创建book索引</p><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /book/<br>&#123;<br>  &quot;settings&quot;: &#123;<br>    &quot;number_of_shards&quot;: 1,<br>    &quot;number_of_replicas&quot;: 0<br>  &#125;,<br>  &quot;mappings&quot;: &#123;<br>    &quot;properties&quot;: &#123;<br>      &quot;name&quot;:&#123;<br>        &quot;type&quot;: &quot;text&quot;,<br>        &quot;analyzer&quot;: &quot;ik_max_word&quot;,<br>        &quot;search_analyzer&quot;: &quot;ik_smart&quot;<br>      &#125;,<br>      &quot;description&quot;:&#123;<br>        &quot;type&quot;: &quot;text&quot;,<br>        &quot;analyzer&quot;: &quot;ik_max_word&quot;,<br>        &quot;search_analyzer&quot;: &quot;ik_smart&quot;<br>      &#125;,<br>      &quot;studymodel&quot;:&#123;<br>        &quot;type&quot;: &quot;keyword&quot;<br>      &#125;,<br>      &quot;price&quot;:&#123;<br>        &quot;type&quot;: &quot;double&quot;<br>      &#125;,<br>      &quot;timestamp&quot;: &#123;<br>         &quot;type&quot;: &quot;date&quot;,<br>         &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis&quot;<br>      &#125;,<br>      &quot;pic&quot;:&#123;<br>        &quot;type&quot;:&quot;text&quot;,<br>        &quot;index&quot;:false<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;插入数据<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-http line-numbers-mode" data-ext="http"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight http"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /book/_doc/1<br>&#123;<br>&quot;name&quot;: &quot;Bootstrap开发&quot;,<br>&quot;description&quot;: &quot;Bootstrap是由Twitter推出的一个前台页面开发css框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长css页面开发的程序人员）轻松的实现一个css，不受浏览器限制的精美界面css效果。&quot;,<br>&quot;studymodel&quot;: &quot;201002&quot;,<br>&quot;price&quot;:38.6,<br>&quot;timestamp&quot;:&quot;2019-08-25 19:11:35&quot;,<br>&quot;pic&quot;:&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,<br>&quot;tags&quot;: [ &quot;bootstrap&quot;, &quot;dev&quot;]<br>&#125;<br><br>PUT /book/_doc/2<br>&#123;<br>&quot;name&quot;: &quot;java编程思想&quot;,<br>&quot;description&quot;: &quot;java语言是世界第一编程语言，在软件开发领域使用人数最多。&quot;,<br>&quot;studymodel&quot;: &quot;201001&quot;,<br>&quot;price&quot;:68.6,<br>&quot;timestamp&quot;:&quot;2019-08-25 19:11:35&quot;,<br>&quot;pic&quot;:&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,<br>&quot;tags&quot;: [ &quot;java&quot;, &quot;dev&quot;]<br>&#125;<br><br>PUT /book/_doc/3<br>&#123;<br>&quot;name&quot;: &quot;spring开发基础&quot;,<br>&quot;description&quot;: &quot;spring 在java领域非常流行，java程序员都在用。&quot;,<br>&quot;studymodel&quot;: &quot;201001&quot;,<br>&quot;price&quot;:88.6,<br>&quot;timestamp&quot;:&quot;2019-08-24 19:11:35&quot;,<br>&quot;pic&quot;:&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,<br>&quot;tags&quot;: [ &quot;spring&quot;, &quot;java&quot;]<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>搜索</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">GET  /book/_search <br>&#123;<br>    &quot;query&quot; : &#123;<br>        &quot;match&quot; : &#123;<br>            &quot;description&quot; : &quot;java程序员&quot;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2、-score初探" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、-score初探">#</a> 2、_score初探</h4><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs text">&#123;<br>  &quot;took&quot; : 1,<br>  &quot;timed_out&quot; : false,<br>  &quot;_shards&quot; : &#123;<br>    &quot;total&quot; : 1,<br>    &quot;successful&quot; : 1,<br>    &quot;skipped&quot; : 0,<br>    &quot;failed&quot; : 0<br>  &#125;,<br>  &quot;hits&quot; : &#123;<br>    &quot;total&quot; : &#123;<br>      &quot;value&quot; : 2,<br>      &quot;relation&quot; : &quot;eq&quot;<br>    &#125;,<br>    &quot;max_score&quot; : 2.137549,<br>    &quot;hits&quot; : [<br>      &#123;<br>        &quot;_index&quot; : &quot;book&quot;,<br>        &quot;_type&quot; : &quot;_doc&quot;,<br>        &quot;_id&quot; : &quot;3&quot;,<br>        &quot;_score&quot; : 2.137549,<br>        &quot;_source&quot; : &#123;<br>          &quot;name&quot; : &quot;spring开发基础&quot;,<br>          &quot;description&quot; : &quot;spring 在java领域非常流行，java程序员都在用。&quot;,<br>          &quot;studymodel&quot; : &quot;201001&quot;,<br>          &quot;price&quot; : 88.6,<br>          &quot;timestamp&quot; : &quot;2019-08-24 19:11:35&quot;,<br>          &quot;pic&quot; : &quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,<br>          &quot;tags&quot; : [<br>            &quot;spring&quot;,<br>            &quot;java&quot;<br>          ]<br>        &#125;<br>      &#125;,<br>      &#123;<br>        &quot;_index&quot; : &quot;book&quot;,<br>        &quot;_type&quot; : &quot;_doc&quot;,<br>        &quot;_id&quot; : &quot;2&quot;,<br>        &quot;_score&quot; : 0.57961315,<br>        &quot;_source&quot; : &#123;<br>          &quot;name&quot; : &quot;java编程思想&quot;,<br>          &quot;description&quot; : &quot;java语言是世界第一编程语言，在软件开发领域使用人数最多。&quot;,<br>          &quot;studymodel&quot; : &quot;201001&quot;,<br>          &quot;price&quot; : 68.6,<br>          &quot;timestamp&quot; : &quot;2019-08-25 19:11:35&quot;,<br>          &quot;pic&quot; : &quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,<br>          &quot;tags&quot; : [<br>            &quot;java&quot;,<br>            &quot;dev&quot;<br>          ]<br>        &#125;<br>      &#125;<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结果分析</p><p>1、建立索引时, description字段 term倒排索引</p><p>java 2,3</p><p>程序员 3</p><p>2、搜索时，直接找description中含有java的文档 2,3，并且3号文档含有两个java字段，一个程序员，所以得分高，排在前面。2号文档含有一个java，排在后面。</p><h3 id="七、dsl-语法练习" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#七、dsl-语法练习">#</a> 七、DSL 语法练习</h3><h4 id="_1、match-all" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、match-all">#</a> 1、match_all</h4><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_search<br>&#123;<br>    &quot;query&quot;: &#123;<br>        &quot;match_all&quot;: &#123;&#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2、match" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、match">#</a> 2、match</h4><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_search<br>&#123;<br>    &quot;query&quot;: &#123; <br>        &quot;match&quot;: &#123; <br>            &quot;description&quot;: &quot;java程序员&quot;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3、multi-match" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、multi-match">#</a> 3、multi_match</h4><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;multi_match&quot;: &#123;<br>      &quot;query&quot;: &quot;java程序员&quot;,<br>      &quot;fields&quot;: [&quot;name&quot;, &quot;description&quot;]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4、range-query-范围查询" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4、range-query-范围查询">#</a> 4、range query 范围查询</h4><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;range&quot;: &#123;<br>      &quot;price&quot;: &#123;<br>        &quot;gte&quot;: 80,<br>        &quot;lte&quot;: 90<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5、term-query" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_5、term-query">#</a> 5、term query</h4><p>字段为keyword时，存储和搜索都不分词</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;term&quot;: &#123;<br>      &quot;description&quot;: &quot;java程序员&quot;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6、terms-query" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_6、terms-query">#</a> 6、terms query</h4><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_search<br>&#123;<br>    &quot;query&quot;: &#123; &quot;terms&quot;: &#123; &quot;tag&quot;: [ &quot;search&quot;, &quot;full_text&quot;, &quot;nosql&quot; ] &#125;&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7、exist-query-查询有某些字段值的文档" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_7、exist-query-查询有某些字段值的文档">#</a> 7、exist query 查询有某些字段值的文档</h4><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /_search<br>&#123;<br>    &quot;query&quot;: &#123;<br>        &quot;exists&quot;: &#123;<br>            &quot;field&quot;: &quot;join_date&quot;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8、fuzzy-query" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_8、fuzzy-query">#</a> 8、Fuzzy query</h4><p>返回包含与搜索词类似的词的文档，该词由Levenshtein编辑距离度量。</p><p>包括以下几种情况：</p><ul><li><p>更改角色（box→fox）</p></li><li><p>删除字符（aple→apple）</p></li><li><p>插入字符（sick→sic）</p></li><li><p>调换两个相邻字符（ACT→CAT）</p></li></ul><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_search<br>&#123;<br>    &quot;query&quot;: &#123;<br>        &quot;fuzzy&quot;: &#123;<br>            &quot;description&quot;: &#123;<br>                &quot;value&quot;: &quot;jave&quot;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_9、ids" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_9、ids">#</a> 9、IDs</h4><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_search<br>&#123;<br>    &quot;query&quot;: &#123;<br>        &quot;ids&quot; : &#123;<br>            &quot;values&quot; : [&quot;1&quot;, &quot;4&quot;, &quot;100&quot;]<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10、prefix-前缀查询" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_10、prefix-前缀查询">#</a> 10、prefix 前缀查询</h4><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_search<br>&#123;<br>    &quot;query&quot;: &#123;<br>        &quot;prefix&quot;: &#123;<br>            &quot;description&quot;: &#123;<br>                &quot;value&quot;: &quot;spring&quot;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_11、regexp-query-正则查询" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_11、regexp-query-正则查询">#</a> 11、regexp query 正则查询</h4><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_search<br>&#123;<br>    &quot;query&quot;: &#123;<br>        &quot;regexp&quot;: &#123;<br>            &quot;description&quot;: &#123;<br>                &quot;value&quot;: &quot;j.*a&quot;,<br>                &quot;flags&quot; : &quot;ALL&quot;,<br>                &quot;max_determinized_states&quot;: 10000,<br>                &quot;rewrite&quot;: &quot;constant_score&quot;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="八、-filter" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#八、-filter">#</a> 八、 Filter</h3><h4 id="_1、-filter与query示例" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、-filter与query示例">#</a> 1、 filter与query示例</h4><p>需求：用户查询description中有"java程序员"，并且价格大于80小于90的数据。</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;bool&quot;: &#123;<br>      &quot;must&quot;: [<br>        &#123;<br>          &quot;match&quot;: &#123;<br>            &quot;description&quot;: &quot;java程序员&quot;<br>          &#125;<br>        &#125;,<br>        &#123;<br>          &quot;range&quot;: &#123;<br>            &quot;price&quot;: &#123;<br>              &quot;gte&quot;: 80,<br>              &quot;lte&quot;: 90<br>            &#125;<br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用filter:</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;bool&quot;: &#123;<br>      &quot;must&quot;: [<br>        &#123;<br>          &quot;match&quot;: &#123;<br>            &quot;description&quot;: &quot;java程序员&quot;<br>          &#125;<br>        &#125;<br>      ],<br>      &quot;filter&quot;: &#123;<br>        &quot;range&quot;: &#123;<br>          &quot;price&quot;: &#123;<br>            &quot;gte&quot;: 80,<br>             &quot;lte&quot;: 90<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2、filter与query对比" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、filter与query对比">#</a> 2、filter与query对比</h4><p>filter，仅仅只是按照搜索条件过滤出需要的数据而已，不计算任何相关度分数，对相关度没有任何影响。</p><p>query，会去计算每个document相对于搜索条件的相关度，并按照相关度进行排序。</p><p>应用场景：</p><p>一般来说，如果你是在进行搜索，需要将最匹配搜索条件的数据先返回，那么用query 如果你只是要根据一些条件筛选出一部分数据，不关注其排序，那么用filter</p><h4 id="_3、filter与query性能" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、filter与query性能">#</a> 3、filter与query性能</h4><p>filter，不需要计算相关度分数，不需要按照相关度分数进行排序，同时还有内置的自动cache最常使用filter的数据</p><p>query，相反，要计算相关度分数，按照分数进行排序，而且无法cache结果</p><h3 id="九、定位错误语法" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#九、定位错误语法">#</a> 九、定位错误语法</h3><p>验证错误语句：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_validate/query?explain<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;mach&quot;: &#123;<br>      &quot;description&quot;: &quot;java程序员&quot;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>返回：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">&#123;<br>  &quot;valid&quot; : false,<br>  &quot;error&quot; : &quot;org.elasticsearch.common.ParsingException: no [query] registered for [mach]&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>正确</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_validate/query?explain<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;match&quot;: &#123;<br>      &quot;description&quot;: &quot;java程序员&quot;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>返回</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs text">&#123;<br>  &quot;_shards&quot; : &#123;<br>    &quot;total&quot; : 1,<br>    &quot;successful&quot; : 1,<br>    &quot;failed&quot; : 0<br>  &#125;,<br>  &quot;valid&quot; : true,<br>  &quot;explanations&quot; : [<br>    &#123;<br>      &quot;index&quot; : &quot;book&quot;,<br>      &quot;valid&quot; : true,<br>      &quot;explanation&quot; : &quot;description:java description:程序员&quot;<br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>一般用在那种特别复杂庞大的搜索下，比如你一下子写了上百行的搜索，这个时候可以先用validate api去验证一下，搜索是否合法。</p><p>合法以后，explain就像mysql的执行计划，可以看到搜索的目标等信息。</p><h3 id="十、定制排序规则" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#十、定制排序规则">#</a> 十、定制排序规则</h3><h4 id="_1、默认排序规则" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、默认排序规则">#</a> 1、默认排序规则</h4><p>默认情况下，是按照_score降序排序的</p><p>然而，某些情况下，可能没有有用的_score，比如说filter</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs text">GET book/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;bool&quot;: &#123;<br>      &quot;must&quot;: [<br>        &#123;<br>          &quot;match&quot;: &#123;<br>            &quot;description&quot;: &quot;java程序员&quot;<br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当然，也可以是constant_score</p><h4 id="_2、定制排序规则" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、定制排序规则">#</a> 2、定制排序规则</h4><p>相当于sql中order by ?sort=sprice:desc</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_search <br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;constant_score&quot;: &#123;<br>      &quot;filter&quot; : &#123;<br>            &quot;term&quot; : &#123;<br>                &quot;studymodel&quot; : &quot;201001&quot;<br>            &#125;<br>        &#125;<br>    &#125;<br>  &#125;,<br>  &quot;sort&quot;: [<br>    &#123;<br>      &quot;price&quot;: &#123;<br>        &quot;order&quot;: &quot;asc&quot;<br>      &#125;<br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="十一、-text字段排序问题" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#十一、-text字段排序问题">#</a> 十一、 Text字段排序问题</h3><p>如果对一个text field进行排序，结果往往不准确，因为分词后是多个单词，再排序就不是我们想要的结果了。</p><p>通常解决方案是，将一个text field建立两次索引，一个分词，用来进行搜索；一个不分词，用来进行排序。</p><p>fielddate:true</p><pre><code>PUT /website 
&#123;
  "mappings": &#123;
  "properties": &#123;
    "title": &#123;
      "type": "text",
      "fields": &#123;
        "keyword": &#123;
          "type": "keyword"
        &#125;        
      &#125;      
    &#125;,
    "content": &#123;
      "type": "text"
    &#125;,
    "post_date": &#123;
      "type": "date"
    &#125;,
    "author_id": &#123;
      "type": "long"
    &#125;
  &#125;
 &#125;
&#125;
</code></pre><p>插入数据</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs text">PUT /website/_doc/1<br>&#123;<br>  &quot;title&quot;: &quot;first article&quot;,<br>  &quot;content&quot;: &quot;this is my second article&quot;,<br>  &quot;post_date&quot;: &quot;2019-01-01&quot;,<br>  &quot;author_id&quot;: 110<br>&#125;<br><br>PUT /website/_doc/2<br>&#123;<br>    &quot;title&quot;: &quot;second article&quot;,<br>    &quot;content&quot;: &quot;this is my second article&quot;,<br>     &quot;post_date&quot;: &quot;2019-01-01&quot;,<br>    &quot;author_id&quot;: 110<br>&#125;<br><br>PUT /website/_doc/3<br>&#123;<br>     &quot;title&quot;: &quot;third article&quot;,<br>     &quot;content&quot;: &quot;this is my third article&quot;,<br>     &quot;post_date&quot;: &quot;2019-01-02&quot;,<br>     &quot;author_id&quot;: 110<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>搜索</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /website/_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;match_all&quot;: &#123;&#125;<br>  &#125;,<br>  &quot;sort&quot;: [<br>    &#123;<br>      &quot;title.keyword&quot;: &#123;<br>        &quot;order&quot;: &quot;desc&quot;<br>      &#125;<br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="十二、scroll分批查询" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#十二、scroll分批查询">#</a> 十二、Scroll分批查询</h3><p>场景：下载某一个索引中1亿条数据，到文件或是数据库。</p><p>不能一下全查出来，系统内存溢出。所以使用scoll滚动搜索技术，一批一批查询。</p><p>scoll搜索会在第一次搜索的时候，保存一个当时的视图快照，之后只会基于该旧的视图快照提供数据搜索，如果这个期间数据变更，是不会让用户看到的</p><p>每次发送scroll请求，我们还需要指定一个scoll参数，指定一个时间窗口，每次搜索请求只要在这个时间窗口内能完成就可以了。</p><p>搜索</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_search?scroll=1m<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;match_all&quot;: &#123;&#125;<br>  &#125;,<br>  &quot;size&quot;: 3<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>返回</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs text">&#123;<br>  &quot;_scroll_id&quot; : &quot;DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAMOkWTURBNDUtcjZTVUdKMFp5cXloVElOQQ==&quot;,<br>  &quot;took&quot; : 3,<br>  &quot;timed_out&quot; : false,<br>  &quot;_shards&quot; : &#123;<br>    &quot;total&quot; : 1,<br>    &quot;successful&quot; : 1,<br>    &quot;skipped&quot; : 0,<br>    &quot;failed&quot; : 0<br>  &#125;,<br>  &quot;hits&quot; : &#123;<br>    &quot;total&quot; : &#123;<br>      &quot;value&quot; : 3,<br>      &quot;relation&quot; : &quot;eq&quot;<br>    &#125;,<br>    &quot;max_score&quot; : 1.0,<br>    &quot;hits&quot; : [<br><br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>获得的结果会有一个scoll_id，下一次再发送scoll请求的时候，必须带上这个scoll_id</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /_search/scroll<br>&#123;<br>    &quot;scroll&quot;: &quot;1m&quot;, <br>    &quot;scroll_id&quot; : &quot;DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAMOkWTURBNDUtcjZTVUdKMFp5cXloVElOQQ==&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>与分页区别：</p><p>分页给用户看的 deep paging</p><p>scroll是用户系统内部操作，如下载批量数据，数据转移。零停机改变索引映射。</p><h2 id="第十五章-java-api实现搜索" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第十五章-java-api实现搜索">#</a> 第十五章 java api实现搜索</h2><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.es;<br><br><span class="hljs-keyword">import</span> org.elasticsearch.action.search.SearchRequest;<br><span class="hljs-keyword">import</span> org.elasticsearch.action.search.SearchResponse;<br><span class="hljs-keyword">import</span> org.elasticsearch.client.RequestOptions;<br><span class="hljs-keyword">import</span> org.elasticsearch.client.RestHighLevelClient;<br><span class="hljs-keyword">import</span> org.elasticsearch.index.query.*;<br><span class="hljs-keyword">import</span> org.elasticsearch.search.SearchHit;<br><span class="hljs-keyword">import</span> org.elasticsearch.search.SearchHits;<br><span class="hljs-keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;<br><span class="hljs-keyword">import</span> org.elasticsearch.search.sort.SortOrder;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * creste by itheima.itcast</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestSearch</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    RestHighLevelClient client;<br><br>    <span class="hljs-comment">//搜索全部记录</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSearchAll</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><br><span class="hljs-comment">//        GET book/_search</span><br><span class="hljs-comment">//        &#123;</span><br><span class="hljs-comment">//            &quot;query&quot;: &#123;</span><br><span class="hljs-comment">//                &quot;match_all&quot;: &#123;&#125;</span><br><span class="hljs-comment">//             &#125;</span><br><span class="hljs-comment">//        &#125;</span><br>        <span class="hljs-comment">//1构建搜索请求</span><br>        <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">searchRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;book&quot;</span>);<br><br>        <span class="hljs-type">SearchSourceBuilder</span> <span class="hljs-variable">searchSourceBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchSourceBuilder</span>();<br>        searchSourceBuilder.query(QueryBuilders.matchAllQuery());<br><br>        <span class="hljs-comment">//获取某些字段</span><br>        searchSourceBuilder.fetchSource(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;name&quot;</span>&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;&#125;);<br><br>        searchRequest.source(searchSourceBuilder);<br><br>        <span class="hljs-comment">//2执行搜索</span><br>        <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">searchResponse</span> <span class="hljs-operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);<br><br>        <span class="hljs-comment">//3获取结果</span><br>        <span class="hljs-type">SearchHits</span> <span class="hljs-variable">hits</span> <span class="hljs-operator">=</span> searchResponse.getHits();<br><br>        <span class="hljs-comment">//数据数据</span><br>        SearchHit[] searchHits = hits.getHits();<br>        System.out.println(<span class="hljs-string">&quot;--------------------------&quot;</span>);<br>        <span class="hljs-keyword">for</span> (SearchHit hit : searchHits) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> hit.getId();<br>            <span class="hljs-type">float</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> hit.getScore();<br>            Map&amp;lt;String, Object&amp;gt; sourceAsMap = hit.getSourceAsMap();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> (String) sourceAsMap.get(<span class="hljs-string">&quot;name&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">description</span> <span class="hljs-operator">=</span> (String) sourceAsMap.get(<span class="hljs-string">&quot;description&quot;</span>);<br>            <span class="hljs-type">Double</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> (Double) sourceAsMap.get(<span class="hljs-string">&quot;price&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;name:&quot;</span> + name);<br>            System.out.println(<span class="hljs-string">&quot;description:&quot;</span> + description);<br>            System.out.println(<span class="hljs-string">&quot;price:&quot;</span> + price);<br>            System.out.println(<span class="hljs-string">&quot;==========================&quot;</span>);<br><br>        &#125;<br>    &#125;<br><br><br><br>    <span class="hljs-comment">//搜索分页</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSearchPage</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><span class="hljs-comment">//    GET book/_search</span><br><span class="hljs-comment">//    &#123;</span><br><span class="hljs-comment">//        &quot;query&quot;: &#123;</span><br><span class="hljs-comment">//          &quot;match_all&quot;: &#123;&#125;</span><br><span class="hljs-comment">//       &#125;,</span><br><span class="hljs-comment">//        &quot;from&quot;: 0,</span><br><span class="hljs-comment">//        &quot;size&quot;: 2</span><br><span class="hljs-comment">//    &#125;</span><br>        <span class="hljs-comment">//1构建搜索请求</span><br>        <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">searchRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;book&quot;</span>);<br><br>        <span class="hljs-type">SearchSourceBuilder</span> <span class="hljs-variable">searchSourceBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchSourceBuilder</span>();<br>        searchSourceBuilder.query(QueryBuilders.matchAllQuery());<br><br><br>        <span class="hljs-comment">//第几页</span><br>        <span class="hljs-type">int</span> page=<span class="hljs-number">1</span>;<br>        <span class="hljs-comment">//每页几个</span><br>        <span class="hljs-type">int</span> size=<span class="hljs-number">2</span>;<br>        <span class="hljs-comment">//下标计算</span><br>        <span class="hljs-type">int</span> from=(page-<span class="hljs-number">1</span>)*size;<br><br><br>        searchSourceBuilder.from(from);<br>        searchSourceBuilder.size(size);<br><br><br>        searchRequest.source(searchSourceBuilder);<br><br>        <span class="hljs-comment">//2执行搜索</span><br>        <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">searchResponse</span> <span class="hljs-operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);<br><br>        <span class="hljs-comment">//3获取结果</span><br>        <span class="hljs-type">SearchHits</span> <span class="hljs-variable">hits</span> <span class="hljs-operator">=</span> searchResponse.getHits();<br><br>        <span class="hljs-comment">//数据数据</span><br>        SearchHit[] searchHits = hits.getHits();<br>        System.out.println(<span class="hljs-string">&quot;--------------------------&quot;</span>);<br>        <span class="hljs-keyword">for</span> (SearchHit hit : searchHits) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> hit.getId();<br>            <span class="hljs-type">float</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> hit.getScore();<br>            Map&amp;lt;String, Object&amp;gt; sourceAsMap = hit.getSourceAsMap();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> (String) sourceAsMap.get(<span class="hljs-string">&quot;name&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">description</span> <span class="hljs-operator">=</span> (String) sourceAsMap.get(<span class="hljs-string">&quot;description&quot;</span>);<br>            <span class="hljs-type">Double</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> (Double) sourceAsMap.get(<span class="hljs-string">&quot;price&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;id:&quot;</span> + id);<br>            System.out.println(<span class="hljs-string">&quot;name:&quot;</span> + name);<br>            System.out.println(<span class="hljs-string">&quot;description:&quot;</span> + description);<br>            System.out.println(<span class="hljs-string">&quot;price:&quot;</span> + price);<br>            System.out.println(<span class="hljs-string">&quot;==========================&quot;</span>);<br><br>        &#125;<br>    &#125;<br><br><br><br>    <span class="hljs-comment">//ids搜索</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSearchIds</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><span class="hljs-comment">//    GET /book/_search</span><br><span class="hljs-comment">//    &#123;</span><br><span class="hljs-comment">//        &quot;query&quot;: &#123;</span><br><span class="hljs-comment">//           &quot;ids&quot; : &#123;</span><br><span class="hljs-comment">//             &quot;values&quot; : [&quot;1&quot;, &quot;4&quot;, &quot;100&quot;]</span><br><span class="hljs-comment">//          &#125;</span><br><span class="hljs-comment">//     &#125;</span><br><span class="hljs-comment">//    &#125;</span><br>        <span class="hljs-comment">//1构建搜索请求</span><br>        <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">searchRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;book&quot;</span>);<br><br>        <span class="hljs-type">SearchSourceBuilder</span> <span class="hljs-variable">searchSourceBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchSourceBuilder</span>();<br>        searchSourceBuilder.query(QueryBuilders.idsQuery().addIds(<span class="hljs-string">&quot;1&quot;</span>,<span class="hljs-string">&quot;4&quot;</span>,<span class="hljs-string">&quot;100&quot;</span>));<br><br><br><br><br>        searchRequest.source(searchSourceBuilder);<br><br>        <span class="hljs-comment">//2执行搜索</span><br>        <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">searchResponse</span> <span class="hljs-operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);<br><br>        <span class="hljs-comment">//3获取结果</span><br>        <span class="hljs-type">SearchHits</span> <span class="hljs-variable">hits</span> <span class="hljs-operator">=</span> searchResponse.getHits();<br><br>        <span class="hljs-comment">//数据数据</span><br>        SearchHit[] searchHits = hits.getHits();<br>        System.out.println(<span class="hljs-string">&quot;--------------------------&quot;</span>);<br>        <span class="hljs-keyword">for</span> (SearchHit hit : searchHits) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> hit.getId();<br>            <span class="hljs-type">float</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> hit.getScore();<br>            Map&amp;lt;String, Object&amp;gt; sourceAsMap = hit.getSourceAsMap();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> (String) sourceAsMap.get(<span class="hljs-string">&quot;name&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">description</span> <span class="hljs-operator">=</span> (String) sourceAsMap.get(<span class="hljs-string">&quot;description&quot;</span>);<br>            <span class="hljs-type">Double</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> (Double) sourceAsMap.get(<span class="hljs-string">&quot;price&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;id:&quot;</span> + id);<br>            System.out.println(<span class="hljs-string">&quot;name:&quot;</span> + name);<br>            System.out.println(<span class="hljs-string">&quot;description:&quot;</span> + description);<br>            System.out.println(<span class="hljs-string">&quot;price:&quot;</span> + price);<br>            System.out.println(<span class="hljs-string">&quot;==========================&quot;</span>);<br><br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-comment">//match搜索</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSearchMatch</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><span class="hljs-comment">//</span><br><span class="hljs-comment">//    GET /book/_search</span><br><span class="hljs-comment">//    &#123;</span><br><span class="hljs-comment">//        &quot;query&quot;: &#123;</span><br><span class="hljs-comment">//           &quot;match&quot;: &#123;</span><br><span class="hljs-comment">//            &quot;description&quot;: &quot;java程序员&quot;</span><br><span class="hljs-comment">//        &#125;</span><br><span class="hljs-comment">//      &#125;</span><br><span class="hljs-comment">//    &#125;</span><br>        <span class="hljs-comment">//1构建搜索请求</span><br>        <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">searchRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;book&quot;</span>);<br><br>        <span class="hljs-type">SearchSourceBuilder</span> <span class="hljs-variable">searchSourceBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchSourceBuilder</span>();<br>        searchSourceBuilder.query(QueryBuilders.matchQuery(<span class="hljs-string">&quot;description&quot;</span>, <span class="hljs-string">&quot;java程序员&quot;</span>));<br><br><br><br><br>        searchRequest.source(searchSourceBuilder);<br><br>        <span class="hljs-comment">//2执行搜索</span><br>        <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">searchResponse</span> <span class="hljs-operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);<br><br>        <span class="hljs-comment">//3获取结果</span><br>        <span class="hljs-type">SearchHits</span> <span class="hljs-variable">hits</span> <span class="hljs-operator">=</span> searchResponse.getHits();<br><br>        <span class="hljs-comment">//数据数据</span><br>        SearchHit[] searchHits = hits.getHits();<br>        System.out.println(<span class="hljs-string">&quot;--------------------------&quot;</span>);<br>        <span class="hljs-keyword">for</span> (SearchHit hit : searchHits) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> hit.getId();<br>            <span class="hljs-type">float</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> hit.getScore();<br>            Map&amp;lt;String, Object&amp;gt; sourceAsMap = hit.getSourceAsMap();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> (String) sourceAsMap.get(<span class="hljs-string">&quot;name&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">description</span> <span class="hljs-operator">=</span> (String) sourceAsMap.get(<span class="hljs-string">&quot;description&quot;</span>);<br>            <span class="hljs-type">Double</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> (Double) sourceAsMap.get(<span class="hljs-string">&quot;price&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;id:&quot;</span> + id);<br>            System.out.println(<span class="hljs-string">&quot;name:&quot;</span> + name);<br>            System.out.println(<span class="hljs-string">&quot;description:&quot;</span> + description);<br>            System.out.println(<span class="hljs-string">&quot;price:&quot;</span> + price);<br>            System.out.println(<span class="hljs-string">&quot;==========================&quot;</span>);<br><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//term 搜索</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSearchTerm</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><span class="hljs-comment">//</span><br><span class="hljs-comment">//    GET /book/_search</span><br><span class="hljs-comment">//    &#123;</span><br><span class="hljs-comment">//        &quot;query&quot;: &#123;</span><br><span class="hljs-comment">//           &quot;term&quot;: &#123;</span><br><span class="hljs-comment">//            &quot;description&quot;: &quot;java程序员&quot;</span><br><span class="hljs-comment">//        &#125;</span><br><span class="hljs-comment">//      &#125;</span><br><span class="hljs-comment">//    &#125;</span><br>        <span class="hljs-comment">//1构建搜索请求</span><br>        <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">searchRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;book&quot;</span>);<br><br>        <span class="hljs-type">SearchSourceBuilder</span> <span class="hljs-variable">searchSourceBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchSourceBuilder</span>();<br>        searchSourceBuilder.query(QueryBuilders.termQuery(<span class="hljs-string">&quot;description&quot;</span>, <span class="hljs-string">&quot;java程序员&quot;</span>));<br><br><br><br><br>        searchRequest.source(searchSourceBuilder);<br><br>        <span class="hljs-comment">//2执行搜索</span><br>        <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">searchResponse</span> <span class="hljs-operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);<br><br>        <span class="hljs-comment">//3获取结果</span><br>        <span class="hljs-type">SearchHits</span> <span class="hljs-variable">hits</span> <span class="hljs-operator">=</span> searchResponse.getHits();<br><br>        <span class="hljs-comment">//数据数据</span><br>        SearchHit[] searchHits = hits.getHits();<br>        System.out.println(<span class="hljs-string">&quot;--------------------------&quot;</span>);<br>        <span class="hljs-keyword">for</span> (SearchHit hit : searchHits) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> hit.getId();<br>            <span class="hljs-type">float</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> hit.getScore();<br>            Map&amp;lt;String, Object&amp;gt; sourceAsMap = hit.getSourceAsMap();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> (String) sourceAsMap.get(<span class="hljs-string">&quot;name&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">description</span> <span class="hljs-operator">=</span> (String) sourceAsMap.get(<span class="hljs-string">&quot;description&quot;</span>);<br>            <span class="hljs-type">Double</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> (Double) sourceAsMap.get(<span class="hljs-string">&quot;price&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;id:&quot;</span> + id);<br>            System.out.println(<span class="hljs-string">&quot;name:&quot;</span> + name);<br>            System.out.println(<span class="hljs-string">&quot;description:&quot;</span> + description);<br>            System.out.println(<span class="hljs-string">&quot;price:&quot;</span> + price);<br>            System.out.println(<span class="hljs-string">&quot;==========================&quot;</span>);<br><br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-comment">//multi_match搜索</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSearchMultiMatch</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><span class="hljs-comment">//    GET /book/_search</span><br><span class="hljs-comment">//    &#123;</span><br><span class="hljs-comment">//        &quot;query&quot;: &#123;</span><br><span class="hljs-comment">//          &quot;multi_match&quot;: &#123;</span><br><span class="hljs-comment">//            &quot;query&quot;: &quot;java程序员&quot;,</span><br><span class="hljs-comment">//            &quot;fields&quot;: [&quot;name&quot;, &quot;description&quot;]</span><br><span class="hljs-comment">//        &#125;</span><br><span class="hljs-comment">//      &#125;</span><br><span class="hljs-comment">//    &#125;</span><br>        <span class="hljs-comment">//1构建搜索请求</span><br>        <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">searchRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;book&quot;</span>);<br><br>        <span class="hljs-type">SearchSourceBuilder</span> <span class="hljs-variable">searchSourceBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchSourceBuilder</span>();<br>        searchSourceBuilder.query(QueryBuilders.multiMatchQuery(<span class="hljs-string">&quot;java程序员&quot;</span>,<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;description&quot;</span>));<br><br><br><br><br>        searchRequest.source(searchSourceBuilder);<br><br>        <span class="hljs-comment">//2执行搜索</span><br>        <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">searchResponse</span> <span class="hljs-operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);<br><br>        <span class="hljs-comment">//3获取结果</span><br>        <span class="hljs-type">SearchHits</span> <span class="hljs-variable">hits</span> <span class="hljs-operator">=</span> searchResponse.getHits();<br><br>        <span class="hljs-comment">//数据数据</span><br>        SearchHit[] searchHits = hits.getHits();<br>        System.out.println(<span class="hljs-string">&quot;--------------------------&quot;</span>);<br>        <span class="hljs-keyword">for</span> (SearchHit hit : searchHits) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> hit.getId();<br>            <span class="hljs-type">float</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> hit.getScore();<br>            Map&amp;lt;String, Object&amp;gt; sourceAsMap = hit.getSourceAsMap();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> (String) sourceAsMap.get(<span class="hljs-string">&quot;name&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">description</span> <span class="hljs-operator">=</span> (String) sourceAsMap.get(<span class="hljs-string">&quot;description&quot;</span>);<br>            <span class="hljs-type">Double</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> (Double) sourceAsMap.get(<span class="hljs-string">&quot;price&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;id:&quot;</span> + id);<br>            System.out.println(<span class="hljs-string">&quot;name:&quot;</span> + name);<br>            System.out.println(<span class="hljs-string">&quot;description:&quot;</span> + description);<br>            System.out.println(<span class="hljs-string">&quot;price:&quot;</span> + price);<br>            System.out.println(<span class="hljs-string">&quot;==========================&quot;</span>);<br><br>        &#125;<br>    &#125;<br><span class="hljs-comment">//    GET /book/_search</span><br><span class="hljs-comment">//    &#123;</span><br><span class="hljs-comment">//        &quot;query&quot;: &#123;</span><br><span class="hljs-comment">//        &quot;bool&quot;: &#123;</span><br><span class="hljs-comment">//            &quot;must&quot;: [</span><br><span class="hljs-comment">//            &#123;</span><br><span class="hljs-comment">//                &quot;multi_match&quot;: &#123;</span><br><span class="hljs-comment">//                &quot;query&quot;: &quot;java程序员&quot;,</span><br><span class="hljs-comment">//                        &quot;fields&quot;: [&quot;name&quot;,&quot;description&quot;]</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//      ],</span><br><span class="hljs-comment">//            &quot;should&quot;: [</span><br><span class="hljs-comment">//            &#123;</span><br><span class="hljs-comment">//                &quot;match&quot;: &#123;</span><br><span class="hljs-comment">//                &quot;studymodel&quot;: &quot;201001&quot;</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//      ]</span><br><span class="hljs-comment">//        &#125;</span><br><span class="hljs-comment">//    &#125;</span><br><span class="hljs-comment">//    &#125;</span><br><br>    <span class="hljs-comment">//bool搜索</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSearchBool</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><span class="hljs-comment">//    GET /book/_search</span><br><span class="hljs-comment">//    &#123;</span><br><span class="hljs-comment">//        &quot;query&quot;: &#123;</span><br><span class="hljs-comment">//          &quot;bool&quot;: &#123;</span><br><span class="hljs-comment">//            &quot;must&quot;: [</span><br><span class="hljs-comment">//            &#123;</span><br><span class="hljs-comment">//                &quot;multi_match&quot;: &#123;</span><br><span class="hljs-comment">//                  &quot;query&quot;: &quot;java程序员&quot;,</span><br><span class="hljs-comment">//                  &quot;fields&quot;: [&quot;name&quot;,&quot;description&quot;]</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//      ],</span><br><span class="hljs-comment">//            &quot;should&quot;: [</span><br><span class="hljs-comment">//            &#123;</span><br><span class="hljs-comment">//                &quot;match&quot;: &#123;</span><br><span class="hljs-comment">//                &quot;studymodel&quot;: &quot;201001&quot;</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//      ]</span><br><span class="hljs-comment">//        &#125;</span><br><span class="hljs-comment">//    &#125;</span><br><span class="hljs-comment">//    &#125;</span><br>        <span class="hljs-comment">//1构建搜索请求</span><br>        <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">searchRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;book&quot;</span>);<br><br>        <span class="hljs-type">SearchSourceBuilder</span> <span class="hljs-variable">searchSourceBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchSourceBuilder</span>();<br><br>        <span class="hljs-comment">//构建multiMatch请求</span><br>        <span class="hljs-type">MultiMatchQueryBuilder</span> <span class="hljs-variable">multiMatchQueryBuilder</span> <span class="hljs-operator">=</span> QueryBuilders.multiMatchQuery(<span class="hljs-string">&quot;java程序员&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;description&quot;</span>);<br>        <span class="hljs-comment">//构建match请求</span><br>        <span class="hljs-type">MatchQueryBuilder</span> <span class="hljs-variable">matchQueryBuilder</span> <span class="hljs-operator">=</span> QueryBuilders.matchQuery(<span class="hljs-string">&quot;studymodel&quot;</span>, <span class="hljs-string">&quot;201001&quot;</span>);<br><br>        BoolQueryBuilder boolQueryBuilder=QueryBuilders.boolQuery();<br>        boolQueryBuilder.must(multiMatchQueryBuilder);<br>        boolQueryBuilder.should(matchQueryBuilder);<br><br>        searchSourceBuilder.query(boolQueryBuilder);<br><br><br><br><br>        searchRequest.source(searchSourceBuilder);<br><br>        <span class="hljs-comment">//2执行搜索</span><br>        <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">searchResponse</span> <span class="hljs-operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);<br><br>        <span class="hljs-comment">//3获取结果</span><br>        <span class="hljs-type">SearchHits</span> <span class="hljs-variable">hits</span> <span class="hljs-operator">=</span> searchResponse.getHits();<br><br>        <span class="hljs-comment">//数据数据</span><br>        SearchHit[] searchHits = hits.getHits();<br>        System.out.println(<span class="hljs-string">&quot;--------------------------&quot;</span>);<br>        <span class="hljs-keyword">for</span> (SearchHit hit : searchHits) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> hit.getId();<br>            <span class="hljs-type">float</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> hit.getScore();<br>            Map&amp;lt;String, Object&amp;gt; sourceAsMap = hit.getSourceAsMap();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> (String) sourceAsMap.get(<span class="hljs-string">&quot;name&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">description</span> <span class="hljs-operator">=</span> (String) sourceAsMap.get(<span class="hljs-string">&quot;description&quot;</span>);<br>            <span class="hljs-type">Double</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> (Double) sourceAsMap.get(<span class="hljs-string">&quot;price&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;id:&quot;</span> + id);<br>            System.out.println(<span class="hljs-string">&quot;name:&quot;</span> + name);<br>            System.out.println(<span class="hljs-string">&quot;description:&quot;</span> + description);<br>            System.out.println(<span class="hljs-string">&quot;price:&quot;</span> + price);<br>            System.out.println(<span class="hljs-string">&quot;==========================&quot;</span>);<br><br>        &#125;<br>    &#125;<br><br><span class="hljs-comment">//    GET /book/_search</span><br><span class="hljs-comment">//    &#123;</span><br><span class="hljs-comment">//        &quot;query&quot;: &#123;</span><br><span class="hljs-comment">//          &quot;bool&quot;: &#123;</span><br><span class="hljs-comment">//            &quot;must&quot;: [</span><br><span class="hljs-comment">//            &#123;</span><br><span class="hljs-comment">//                &quot;multi_match&quot;: &#123;</span><br><span class="hljs-comment">//                &quot;query&quot;: &quot;java程序员&quot;,</span><br><span class="hljs-comment">//                        &quot;fields&quot;: [&quot;name&quot;,&quot;description&quot;]</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//      ],</span><br><span class="hljs-comment">//            &quot;should&quot;: [</span><br><span class="hljs-comment">//            &#123;</span><br><span class="hljs-comment">//                &quot;match&quot;: &#123;</span><br><span class="hljs-comment">//                &quot;studymodel&quot;: &quot;201001&quot;</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//      ],</span><br><span class="hljs-comment">//            &quot;filter&quot;: &#123;</span><br><span class="hljs-comment">//                &quot;range&quot;: &#123;</span><br><span class="hljs-comment">//                    &quot;price&quot;: &#123;</span><br><span class="hljs-comment">//                        &quot;gte&quot;: 50,</span><br><span class="hljs-comment">//                                &quot;lte&quot;: 90</span><br><span class="hljs-comment">//                    &#125;</span><br><span class="hljs-comment">//                &#125;</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//        &#125;</span><br><span class="hljs-comment">//    &#125;</span><br><span class="hljs-comment">//    &#125;</span><br><br>    <span class="hljs-comment">//filter搜索</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSearchFilter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><span class="hljs-comment">//    GET /book/_search</span><br><span class="hljs-comment">//    &#123;</span><br><span class="hljs-comment">//        &quot;query&quot;: &#123;</span><br><span class="hljs-comment">//          &quot;bool&quot;: &#123;</span><br><span class="hljs-comment">//            &quot;must&quot;: [</span><br><span class="hljs-comment">//            &#123;</span><br><span class="hljs-comment">//                &quot;multi_match&quot;: &#123;</span><br><span class="hljs-comment">//                &quot;query&quot;: &quot;java程序员&quot;,</span><br><span class="hljs-comment">//                        &quot;fields&quot;: [&quot;name&quot;,&quot;description&quot;]</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//      ],</span><br><span class="hljs-comment">//            &quot;should&quot;: [</span><br><span class="hljs-comment">//            &#123;</span><br><span class="hljs-comment">//                &quot;match&quot;: &#123;</span><br><span class="hljs-comment">//                &quot;studymodel&quot;: &quot;201001&quot;</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//          ],</span><br><span class="hljs-comment">//            &quot;filter&quot;: &#123;</span><br><span class="hljs-comment">//                &quot;range&quot;: &#123;</span><br><span class="hljs-comment">//                    &quot;price&quot;: &#123;</span><br><span class="hljs-comment">//                        &quot;gte&quot;: 50,</span><br><span class="hljs-comment">//                         &quot;lte&quot;: 90</span><br><span class="hljs-comment">//                    &#125;</span><br><span class="hljs-comment">//                &#125;</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//        &#125;</span><br><span class="hljs-comment">//    &#125;</span><br><span class="hljs-comment">//    &#125;</span><br>        <span class="hljs-comment">//1构建搜索请求</span><br>        <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">searchRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;book&quot;</span>);<br><br>        <span class="hljs-type">SearchSourceBuilder</span> <span class="hljs-variable">searchSourceBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchSourceBuilder</span>();<br><br>        <span class="hljs-comment">//构建multiMatch请求</span><br>        <span class="hljs-type">MultiMatchQueryBuilder</span> <span class="hljs-variable">multiMatchQueryBuilder</span> <span class="hljs-operator">=</span> QueryBuilders.multiMatchQuery(<span class="hljs-string">&quot;java程序员&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;description&quot;</span>);<br>        <span class="hljs-comment">//构建match请求</span><br>        <span class="hljs-type">MatchQueryBuilder</span> <span class="hljs-variable">matchQueryBuilder</span> <span class="hljs-operator">=</span> QueryBuilders.matchQuery(<span class="hljs-string">&quot;studymodel&quot;</span>, <span class="hljs-string">&quot;201001&quot;</span>);<br><br>        BoolQueryBuilder boolQueryBuilder=QueryBuilders.boolQuery();<br>        boolQueryBuilder.must(multiMatchQueryBuilder);<br>        boolQueryBuilder.should(matchQueryBuilder);<br><br>        boolQueryBuilder.filter(QueryBuilders.rangeQuery(<span class="hljs-string">&quot;price&quot;</span>).gte(<span class="hljs-number">50</span>).lte(<span class="hljs-number">90</span>));<br><br>        searchSourceBuilder.query(boolQueryBuilder);<br><br><br>        searchRequest.source(searchSourceBuilder);<br><br>        <span class="hljs-comment">//2执行搜索</span><br>        <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">searchResponse</span> <span class="hljs-operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);<br><br>        <span class="hljs-comment">//3获取结果</span><br>        <span class="hljs-type">SearchHits</span> <span class="hljs-variable">hits</span> <span class="hljs-operator">=</span> searchResponse.getHits();<br><br>        <span class="hljs-comment">//数据数据</span><br>        SearchHit[] searchHits = hits.getHits();<br>        System.out.println(<span class="hljs-string">&quot;--------------------------&quot;</span>);<br>        <span class="hljs-keyword">for</span> (SearchHit hit : searchHits) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> hit.getId();<br>            <span class="hljs-type">float</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> hit.getScore();<br>            Map&amp;lt;String, Object&amp;gt; sourceAsMap = hit.getSourceAsMap();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> (String) sourceAsMap.get(<span class="hljs-string">&quot;name&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">description</span> <span class="hljs-operator">=</span> (String) sourceAsMap.get(<span class="hljs-string">&quot;description&quot;</span>);<br>            <span class="hljs-type">Double</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> (Double) sourceAsMap.get(<span class="hljs-string">&quot;price&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;id:&quot;</span> + id);<br>            System.out.println(<span class="hljs-string">&quot;name:&quot;</span> + name);<br>            System.out.println(<span class="hljs-string">&quot;description:&quot;</span> + description);<br>            System.out.println(<span class="hljs-string">&quot;price:&quot;</span> + price);<br>            System.out.println(<span class="hljs-string">&quot;==========================&quot;</span>);<br><br>        &#125;<br>    &#125;<br><br><br><br><br>    <span class="hljs-comment">//sort搜索</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSearchSort</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><span class="hljs-comment">//    GET /book/_search</span><br><span class="hljs-comment">//    &#123;</span><br><span class="hljs-comment">//        &quot;query&quot;: &#123;</span><br><span class="hljs-comment">//        &quot;bool&quot;: &#123;</span><br><span class="hljs-comment">//            &quot;must&quot;: [</span><br><span class="hljs-comment">//            &#123;</span><br><span class="hljs-comment">//                &quot;multi_match&quot;: &#123;</span><br><span class="hljs-comment">//                &quot;query&quot;: &quot;java程序员&quot;,</span><br><span class="hljs-comment">//                        &quot;fields&quot;: [&quot;name&quot;,&quot;description&quot;]</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//      ],</span><br><span class="hljs-comment">//            &quot;should&quot;: [</span><br><span class="hljs-comment">//            &#123;</span><br><span class="hljs-comment">//                &quot;match&quot;: &#123;</span><br><span class="hljs-comment">//                &quot;studymodel&quot;: &quot;201001&quot;</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//      ],</span><br><span class="hljs-comment">//            &quot;filter&quot;: &#123;</span><br><span class="hljs-comment">//                &quot;range&quot;: &#123;</span><br><span class="hljs-comment">//                    &quot;price&quot;: &#123;</span><br><span class="hljs-comment">//                        &quot;gte&quot;: 50,</span><br><span class="hljs-comment">//                                &quot;lte&quot;: 90</span><br><span class="hljs-comment">//                    &#125;</span><br><span class="hljs-comment">//                &#125;</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//        &#125;</span><br><span class="hljs-comment">//    &#125;,</span><br><span class="hljs-comment">//        &quot;sort&quot;: [</span><br><span class="hljs-comment">//        &#123;</span><br><span class="hljs-comment">//            &quot;price&quot;: &#123;</span><br><span class="hljs-comment">//            &quot;order&quot;: &quot;asc&quot;</span><br><span class="hljs-comment">//        &#125;</span><br><span class="hljs-comment">//        &#125;</span><br><span class="hljs-comment">//  ]</span><br><span class="hljs-comment">//    &#125;</span><br>        <span class="hljs-comment">//1构建搜索请求</span><br>        <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">searchRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;book&quot;</span>);<br><br>        <span class="hljs-type">SearchSourceBuilder</span> <span class="hljs-variable">searchSourceBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchSourceBuilder</span>();<br><br>        <span class="hljs-comment">//构建multiMatch请求</span><br>        <span class="hljs-type">MultiMatchQueryBuilder</span> <span class="hljs-variable">multiMatchQueryBuilder</span> <span class="hljs-operator">=</span> QueryBuilders.multiMatchQuery(<span class="hljs-string">&quot;java程序员&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;description&quot;</span>);<br>        <span class="hljs-comment">//构建match请求</span><br>        <span class="hljs-type">MatchQueryBuilder</span> <span class="hljs-variable">matchQueryBuilder</span> <span class="hljs-operator">=</span> QueryBuilders.matchQuery(<span class="hljs-string">&quot;studymodel&quot;</span>, <span class="hljs-string">&quot;201001&quot;</span>);<br><br>        BoolQueryBuilder boolQueryBuilder=QueryBuilders.boolQuery();<br>        boolQueryBuilder.must(multiMatchQueryBuilder);<br>        boolQueryBuilder.should(matchQueryBuilder);<br><br>        boolQueryBuilder.filter(QueryBuilders.rangeQuery(<span class="hljs-string">&quot;price&quot;</span>).gte(<span class="hljs-number">50</span>).lte(<span class="hljs-number">90</span>));<br><br>        searchSourceBuilder.query(boolQueryBuilder);<br><br>        <span class="hljs-comment">//按照价格升序</span><br>        searchSourceBuilder.sort(<span class="hljs-string">&quot;price&quot;</span>, SortOrder.ASC);<br><br><br>        searchRequest.source(searchSourceBuilder);<br><br>        <span class="hljs-comment">//2执行搜索</span><br>        <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">searchResponse</span> <span class="hljs-operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);<br><br>        <span class="hljs-comment">//3获取结果</span><br>        <span class="hljs-type">SearchHits</span> <span class="hljs-variable">hits</span> <span class="hljs-operator">=</span> searchResponse.getHits();<br><br>        <span class="hljs-comment">//数据数据</span><br>        SearchHit[] searchHits = hits.getHits();<br>        System.out.println(<span class="hljs-string">&quot;--------------------------&quot;</span>);<br>        <span class="hljs-keyword">for</span> (SearchHit hit : searchHits) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> hit.getId();<br>            <span class="hljs-type">float</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> hit.getScore();<br>            Map&amp;lt;String, Object&amp;gt; sourceAsMap = hit.getSourceAsMap();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> (String) sourceAsMap.get(<span class="hljs-string">&quot;name&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">description</span> <span class="hljs-operator">=</span> (String) sourceAsMap.get(<span class="hljs-string">&quot;description&quot;</span>);<br>            <span class="hljs-type">Double</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> (Double) sourceAsMap.get(<span class="hljs-string">&quot;price&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;id:&quot;</span> + id);<br>            System.out.println(<span class="hljs-string">&quot;name:&quot;</span> + name);<br>            System.out.println(<span class="hljs-string">&quot;description:&quot;</span> + description);<br>            System.out.println(<span class="hljs-string">&quot;price:&quot;</span> + price);<br>            System.out.println(<span class="hljs-string">&quot;==========================&quot;</span>);<br>        &#125;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="第十六章-评分机制详解" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第十六章-评分机制详解">#</a> 第十六章 评分机制详解</h2><h3 id="一、评分机制-tf-idf" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#一、评分机制-tf-idf">#</a> 一、评分机制 TF\IDF</h3><h4 id="_1、算法介绍" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、算法介绍">#</a> 1、算法介绍</h4><p>relevance score算法，简单来说，就是计算出，一个索引中的文本，与搜索文本，他们之间的关联匹配程度。</p><p>Elasticsearch使用的是 term frequency/inverse document frequency算法，简称为TF/IDF算法。TF词频(Term Frequency)，IDF逆向文件频率(Inverse Document Frequency)</p><p><strong>Term frequency</strong>：搜索文本中的各个词条在field文本中出现了多少次，出现次数越多，就越相关。</p><figure><img alt="1571494142950" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/ELK%E5%85%A5%E9%97%A8/elk%E8%BF%9B%E9%98%B6/1571494142950-c13777bd.png" tabindex="0"/><figcaption>1571494142950</figcaption></figure><p>举例：搜索请求：hello world</p><p>doc1 : hello you and me,and world is very good.</p><p>doc2 : hello,how are you</p><p><strong>Inverse document frequency</strong>：搜索文本中的各个词条在整个索引的所有文档中出现了多少次，出现的次数越多，就越不相关.</p><figure><img alt="1571494159465" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/ELK%E5%85%A5%E9%97%A8/elk%E8%BF%9B%E9%98%B6/1571494159465-ae0d7678.png" tabindex="0"/><figcaption>1571494159465</figcaption></figure><figure><img alt="1571494176760" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/ELK%E5%85%A5%E9%97%A8/elk%E8%BF%9B%E9%98%B6/1571494176760-350e0734.png" tabindex="0"/><figcaption>1571494176760</figcaption></figure><p>举例：搜索请求：hello world</p><p>doc1 : hello ,today is very good</p><p>doc2 : hi world ,how are you</p><p>整个index中1亿条数据。hello的document 1000个，有world的document 有100个。</p><p>doc2 更相关</p><p><strong>Field-length norm</strong>：field长度，field越长，相关度越弱</p><p>举例：搜索请求：hello world</p><p><code>doc1 : &#123;"title":"hello article","content ":"balabalabal 1万个"&#125;</code></p><p><code>doc2 : &#123;"title":"my article","content ":"balabalabal 1万个,world"&#125;</code></p><h4 id="_2、-score是如何被计算出来的" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、-score是如何被计算出来的">#</a> 2、_score是如何被计算出来的</h4><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_search?explain=true<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;match&quot;: &#123;<br>      &quot;description&quot;: &quot;java程序员&quot;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>返回</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br></pre></td><td class="code"><pre><code class="hljs text">&#123;<br>  &quot;took&quot; : 5,<br>  &quot;timed_out&quot; : false,<br>  &quot;_shards&quot; : &#123;<br>    &quot;total&quot; : 1,<br>    &quot;successful&quot; : 1,<br>    &quot;skipped&quot; : 0,<br>    &quot;failed&quot; : 0<br>  &#125;,<br>  &quot;hits&quot; : &#123;<br>    &quot;total&quot; : &#123;<br>      &quot;value&quot; : 2,<br>      &quot;relation&quot; : &quot;eq&quot;<br>    &#125;,<br>    &quot;max_score&quot; : 2.137549,<br>    &quot;hits&quot; : [<br>      &#123;<br>        &quot;_shard&quot; : &quot;[book][0]&quot;,<br>        &quot;_node&quot; : &quot;MDA45-r6SUGJ0ZyqyhTINA&quot;,<br>        &quot;_index&quot; : &quot;book&quot;,<br>        &quot;_type&quot; : &quot;_doc&quot;,<br>        &quot;_id&quot; : &quot;3&quot;,<br>        &quot;_score&quot; : 2.137549,<br>        &quot;_source&quot; : &#123;<br>          &quot;name&quot; : &quot;spring开发基础&quot;,<br>          &quot;description&quot; : &quot;spring 在java领域非常流行，java程序员都在用。&quot;,<br>          &quot;studymodel&quot; : &quot;201001&quot;,<br>          &quot;price&quot; : 88.6,<br>          &quot;timestamp&quot; : &quot;2019-08-24 19:11:35&quot;,<br>          &quot;pic&quot; : &quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,<br>          &quot;tags&quot; : [<br>            &quot;spring&quot;,<br>            &quot;java&quot;<br>          ]<br>        &#125;,<br>        &quot;_explanation&quot; : &#123;<br>          &quot;value&quot; : 2.137549,<br>          &quot;description&quot; : &quot;sum of:&quot;,<br>          &quot;details&quot; : [<br>            &#123;<br>              &quot;value&quot; : 0.7936629,<br>              &quot;description&quot; : &quot;weight(description:java in 0) [PerFieldSimilarity], result of:&quot;,<br>              &quot;details&quot; : [<br>                &#123;<br>                  &quot;value&quot; : 0.7936629,<br>                  &quot;description&quot; : &quot;score(freq=2.0), product of:&quot;,<br>                  &quot;details&quot; : [<br>                    &#123;<br>                      &quot;value&quot; : 2.2,<br>                      &quot;description&quot; : &quot;boost&quot;,<br>                      &quot;details&quot; : [ ]<br>                    &#125;,<br>                    &#123;<br>                      &quot;value&quot; : 0.47000363,<br>                      &quot;description&quot; : &quot;idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:&quot;,<br>                      &quot;details&quot; : [<br>                        &#123;<br>                          &quot;value&quot; : 2,<br>                          &quot;description&quot; : &quot;n, number of documents containing term&quot;,<br>                          &quot;details&quot; : [ ]<br>                        &#125;,<br>                        &#123;<br>                          &quot;value&quot; : 3,<br>                          &quot;description&quot; : &quot;N, total number of documents with field&quot;,<br>                          &quot;details&quot; : [ ]<br>                        &#125;<br>                      ]<br>                    &#125;,<br>                    &#123;<br>                      &quot;value&quot; : 0.7675597,<br>                      &quot;description&quot; : &quot;tf, computed as freq / (freq + k1 * (1 - b + b * dl / avgdl)) from:&quot;,<br>                      &quot;details&quot; : [<br>                        &#123;<br>                          &quot;value&quot; : 2.0,<br>                          &quot;description&quot; : &quot;freq, occurrences of term within document&quot;,<br>                          &quot;details&quot; : [ ]<br>                        &#125;,<br>                        &#123;<br>                          &quot;value&quot; : 1.2,<br>                          &quot;description&quot; : &quot;k1, term saturation parameter&quot;,<br>                          &quot;details&quot; : [ ]<br>                        &#125;,<br>                        &#123;<br>                          &quot;value&quot; : 0.75,<br>                          &quot;description&quot; : &quot;b, length normalization parameter&quot;,<br>                          &quot;details&quot; : [ ]<br>                        &#125;,<br>                        &#123;<br>                          &quot;value&quot; : 12.0,<br>                          &quot;description&quot; : &quot;dl, length of field&quot;,<br>                          &quot;details&quot; : [ ]<br>                        &#125;,<br>                        &#123;<br>                          &quot;value&quot; : 35.333332,<br>                          &quot;description&quot; : &quot;avgdl, average length of field&quot;,<br>                          &quot;details&quot; : [ ]<br>                        &#125;<br>                      ]<br>                    &#125;<br>                  ]<br>                &#125;<br>              ]<br>            &#125;,<br>            &#123;<br>              &quot;value&quot; : 1.3438859,<br>              &quot;description&quot; : &quot;weight(description:程序员 in 0) [PerFieldSimilarity], result of:&quot;,<br>              &quot;details&quot; : [<br>                &#123;<br>                  &quot;value&quot; : 1.3438859,<br>                  &quot;description&quot; : &quot;score(freq=1.0), product of:&quot;,<br>                  &quot;details&quot; : [<br>                    &#123;<br>                      &quot;value&quot; : 2.2,<br>                      &quot;description&quot; : &quot;boost&quot;,<br>                      &quot;details&quot; : [ ]<br>                    &#125;,<br>                    &#123;<br>                      &quot;value&quot; : 0.98082924,<br>                      &quot;description&quot; : &quot;idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:&quot;,<br>                      &quot;details&quot; : [<br>                        &#123;<br>                          &quot;value&quot; : 1,<br>                          &quot;description&quot; : &quot;n, number of documents containing term&quot;,<br>                          &quot;details&quot; : [ ]<br>                        &#125;,<br>                        &#123;<br>                          &quot;value&quot; : 3,<br>                          &quot;description&quot; : &quot;N, total number of documents with field&quot;,<br>                          &quot;details&quot; : [ ]<br>                        &#125;<br>                      ]<br>                    &#125;,<br>                    &#123;<br>                      &quot;value&quot; : 0.6227967,<br>                      &quot;description&quot; : &quot;tf, computed as freq / (freq + k1 * (1 - b + b * dl / avgdl)) from:&quot;,<br>                      &quot;details&quot; : [<br>                        &#123;<br>                          &quot;value&quot; : 1.0,<br>                          &quot;description&quot; : &quot;freq, occurrences of term within document&quot;,<br>                          &quot;details&quot; : [ ]<br>                        &#125;,<br>                        &#123;<br>                          &quot;value&quot; : 1.2,<br>                          &quot;description&quot; : &quot;k1, term saturation parameter&quot;,<br>                          &quot;details&quot; : [ ]<br>                        &#125;,<br>                        &#123;<br>                          &quot;value&quot; : 0.75,<br>                          &quot;description&quot; : &quot;b, length normalization parameter&quot;,<br>                          &quot;details&quot; : [ ]<br>                        &#125;,<br>                        &#123;<br>                          &quot;value&quot; : 12.0,<br>                          &quot;description&quot; : &quot;dl, length of field&quot;,<br>                          &quot;details&quot; : [ ]<br>                        &#125;,<br>                        &#123;<br>                          &quot;value&quot; : 35.333332,<br>                          &quot;description&quot; : &quot;avgdl, average length of field&quot;,<br>                          &quot;details&quot; : [ ]<br>                        &#125;<br>                      ]<br>                    &#125;<br>                  ]<br>                &#125;<br>              ]<br>            &#125;<br>          ]<br>        &#125;<br>      &#125;,<br>      &#123;<br>        &quot;_shard&quot; : &quot;[book][0]&quot;,<br>        &quot;_node&quot; : &quot;MDA45-r6SUGJ0ZyqyhTINA&quot;,<br>        &quot;_index&quot; : &quot;book&quot;,<br>        &quot;_type&quot; : &quot;_doc&quot;,<br>        &quot;_id&quot; : &quot;2&quot;,<br>        &quot;_score&quot; : 0.57961315,<br>        &quot;_source&quot; : &#123;<br>          &quot;name&quot; : &quot;java编程思想&quot;,<br>          &quot;description&quot; : &quot;java语言是世界第一编程语言，在软件开发领域使用人数最多。&quot;,<br>          &quot;studymodel&quot; : &quot;201001&quot;,<br>          &quot;price&quot; : 68.6,<br>          &quot;timestamp&quot; : &quot;2019-08-25 19:11:35&quot;,<br>          &quot;pic&quot; : &quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,<br>          &quot;tags&quot; : [<br>            &quot;java&quot;,<br>            &quot;dev&quot;<br>          ]<br>        &#125;,<br>        &quot;_explanation&quot; : &#123;<br>          &quot;value&quot; : 0.57961315,<br>          &quot;description&quot; : &quot;sum of:&quot;,<br>          &quot;details&quot; : [<br>            &#123;<br>              &quot;value&quot; : 0.57961315,<br>              &quot;description&quot; : &quot;weight(description:java in 0) [PerFieldSimilarity], result of:&quot;,<br>              &quot;details&quot; : [<br>                &#123;<br>                  &quot;value&quot; : 0.57961315,<br>                  &quot;description&quot; : &quot;score(freq=1.0), product of:&quot;,<br>                  &quot;details&quot; : [<br>                    &#123;<br>                      &quot;value&quot; : 2.2,<br>                      &quot;description&quot; : &quot;boost&quot;,<br>                      &quot;details&quot; : [ ]<br>                    &#125;,<br>                    &#123;<br>                      &quot;value&quot; : 0.47000363,<br>                      &quot;description&quot; : &quot;idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:&quot;,<br>                      &quot;details&quot; : [<br>                        &#123;<br>                          &quot;value&quot; : 2,<br>                          &quot;description&quot; : &quot;n, number of documents containing term&quot;,<br>                          &quot;details&quot; : [ ]<br>                        &#125;,<br>                        &#123;<br>                          &quot;value&quot; : 3,<br>                          &quot;description&quot; : &quot;N, total number of documents with field&quot;,<br>                          &quot;details&quot; : [ ]<br>                        &#125;<br>                      ]<br>                    &#125;,<br>                    &#123;<br>                      &quot;value&quot; : 0.56055,<br>                      &quot;description&quot; : &quot;tf, computed as freq / (freq + k1 * (1 - b + b * dl / avgdl)) from:&quot;,<br>                      &quot;details&quot; : [<br>                        &#123;<br>                          &quot;value&quot; : 1.0,<br>                          &quot;description&quot; : &quot;freq, occurrences of term within document&quot;,<br>                          &quot;details&quot; : [ ]<br>                        &#125;,<br>                        &#123;<br>                          &quot;value&quot; : 1.2,<br>                          &quot;description&quot; : &quot;k1, term saturation parameter&quot;,<br>                          &quot;details&quot; : [ ]<br>                        &#125;,<br>                        &#123;<br>                          &quot;value&quot; : 0.75,<br>                          &quot;description&quot; : &quot;b, length normalization parameter&quot;,<br>                          &quot;details&quot; : [ ]<br>                        &#125;,<br>                        &#123;<br>                          &quot;value&quot; : 19.0,<br>                          &quot;description&quot; : &quot;dl, length of field&quot;,<br>                          &quot;details&quot; : [ ]<br>                        &#125;,<br>                        &#123;<br>                          &quot;value&quot; : 35.333332,<br>                          &quot;description&quot; : &quot;avgdl, average length of field&quot;,<br>                          &quot;details&quot; : [ ]<br>                        &#125;<br>                      ]<br>                    &#125;<br>                  ]<br>                &#125;<br>              ]<br>            &#125;<br>          ]<br>        &#125;<br>      &#125;<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3、分析一个document是如何被匹配上的" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、分析一个document是如何被匹配上的">#</a> 3、分析一个document是如何被匹配上的</h4><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_explain/3<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;match&quot;: &#123;<br>      &quot;description&quot;: &quot;java程序员&quot;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="二、doc-value" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#二、doc-value">#</a> 二、Doc value</h3><p>搜索的时候，要依靠倒排索引；排序的时候，需要依靠正排索引，看到每个document的每个field，然后进行排序，所谓的正排索引，其实就是doc values</p><p>在建立索引的时候，一方面会建立倒排索引，以供搜索用；一方面会建立正排索引，也就是doc values，以供排序，聚合，过滤等操作使用</p><p>doc values是被保存在磁盘上的，此时如果内存足够，os会自动将其缓存在内存中，性能还是会很高；如果内存不足够，os会将其写入磁盘上</p><p><strong>倒排索引</strong></p><p>doc1: hello world you and me</p><p>doc2: hi, world, how are you</p><table><thead><tr><th>term</th><th>doc1</th><th>doc2</th></tr></thead><tbody><tr><td>hello</td><td>*</td><td></td></tr><tr><td>world</td><td>*</td><td>*</td></tr><tr><td>you</td><td>*</td><td>*</td></tr><tr><td>and</td><td>*</td><td></td></tr><tr><td>me</td><td>*</td><td></td></tr><tr><td>hi</td><td></td><td>*</td></tr><tr><td>how</td><td></td><td>*</td></tr><tr><td>are</td><td></td><td>*</td></tr></tbody></table><p>搜索时：</p><p>hello you --&gt; hello, you</p><p>hello --&gt; doc1</p><p>you --&gt; doc1,doc2</p><p>doc1: hello world you and me</p><p>doc2: hi, world, how are you</p><p>sort by 出现问题</p><p><strong>正排索引</strong></p><p><code>doc1: &#123; "name": "jack", "age": 27 &#125;</code></p><p><code>doc2: &#123; "name": "tom", "age": 30 &#125;</code></p><table><thead><tr><th>document</th><th>name</th><th>age</th></tr></thead><tbody><tr><td>doc1</td><td>jack</td><td>27</td></tr><tr><td>doc2</td><td>tom</td><td>30</td></tr></tbody></table><h3 id="三、query-phase" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#三、query-phase">#</a> 三、query phase</h3><h4 id="_1、query-phase" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、query-phase">#</a> 1、query phase</h4><p>（1）搜索请求发送到某一个coordinate node，构构建一个priority queue，长度以paging操作from和size为准，默认为10</p><p>（2）coordinate node将请求转发到所有shard，每个shard本地搜索，并构建一个本地的priority queue</p><p>（3）各个shard将自己的priority queue返回给coordinate node，并构建一个全局的priority queue</p><h4 id="_2、replica-shard如何提升搜索吞吐量" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、replica-shard如何提升搜索吞吐量">#</a> 2、replica shard如何提升搜索吞吐量</h4><p>一次请求要打到所有shard的一个replica/primary上去，如果每个shard都有多个replica，那么同时并发过来的搜索请求可以同时打到其他的replica上去</p><h3 id="四、-fetch-phase" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#四、-fetch-phase">#</a> 四、 fetch phase</h3><h4 id="_1、fetch-phbase工作流程" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、fetch-phbase工作流程">#</a> 1、fetch phbase工作流程</h4><p>（1）coordinate node构建完priority queue之后，就发送mget请求去所有shard上获取对应的document</p><p>（2）各个shard将document返回给coordinate node</p><p>（3）coordinate node将合并后的document结果返回给client客户端</p><h4 id="_2、一般搜索-如果不加from和size-就默认搜索前10条-按照-score排序" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、一般搜索-如果不加from和size-就默认搜索前10条-按照-score排序">#</a> 2、一般搜索，如果不加from和size，就默认搜索前10条，按照_score排序</h4><h3 id="五、搜索参数小总结" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#五、搜索参数小总结">#</a> 五、搜索参数小总结</h3><h4 id="_1、preference" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、preference">#</a> 1、preference</h4><p>决定了哪些shard会被用来执行搜索操作</p><p>_primary, _primary_first, _local, _only_node:xyz, _prefer_node:xyz, _shards:2,3</p><p>bouncing results问题，两个document排序，field值相同；不同的shard上，可能排序不同；每次请求轮询打到不同的replica shard上；每次页面上看到的搜索结果的排序都不一样。这就是bouncing result，也就是跳跃的结果。</p><p>搜索的时候，是轮询将搜索请求发送到每一个replica shard（primary shard），但是在不同的shard上，可能document的排序不同</p><p>解决方案就是将preference设置为一个字符串，比如说user_id，让每个user每次搜索的时候，都使用同一个replica shard去执行，就不会看到bouncing results了</p><h4 id="_2、timeout" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、timeout">#</a> 2、timeout</h4><p>已经讲解过原理了，主要就是限定在一定时间内，将部分获取到的数据直接返回，避免查询耗时过长</p><h4 id="_3、routing" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、routing">#</a> 3、routing</h4><p>document文档路由，_id路由，routing=user_id，这样的话可以让同一个user对应的数据到一个shard上去</p><h4 id="_4、search-type" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4、search-type">#</a> 4、search_type</h4><p>default：query_then_fetch</p><p>dfs_query_then_fetch，可以提升revelance sort精准度</p><h2 id="第十七章-聚合入门" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第十七章-聚合入门">#</a> 第十七章 聚合入门</h2><h3 id="一、聚合示例" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#一、聚合示例">#</a> 一、聚合示例</h3><h4 id="_1、需求-计算每个studymodel下的商品数量" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、需求-计算每个studymodel下的商品数量">#</a> 1、需求：计算每个studymodel下的商品数量</h4><p>sql语句： select studymodel，count(*) from book group by studymodel</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_search<br>&#123;<br>  &quot;size&quot;: 0, <br>  &quot;query&quot;: &#123;<br>    &quot;match_all&quot;: &#123;&#125;<br>  &#125;, <br>  &quot;aggs&quot;: &#123;<br>    &quot;group_by_model&quot;: &#123;<br>      &quot;terms&quot;: &#123; &quot;field&quot;: &quot;studymodel&quot; &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2、需求-计算每个tags下的商品数量" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、需求-计算每个tags下的商品数量">#</a> 2、需求：计算每个tags下的商品数量</h4><p>设置字段"fielddata": true</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs text">PUT /book/_mapping/<br>&#123;<br>  &quot;properties&quot;: &#123;<br>    &quot;tags&quot;: &#123;<br>      &quot;type&quot;: &quot;text&quot;,<br>      &quot;fielddata&quot;: true<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查询</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_search<br>&#123;<br>  &quot;size&quot;: 0, <br>  &quot;query&quot;: &#123;<br>    &quot;match_all&quot;: &#123;&#125;<br>  &#125;, <br>  &quot;aggs&quot;: &#123;<br>    &quot;group_by_tags&quot;: &#123;<br>      &quot;terms&quot;: &#123; &quot;field&quot;: &quot;tags&quot; &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3、需求-加上搜索条件-计算每个tags下的商品数量" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、需求-加上搜索条件-计算每个tags下的商品数量">#</a> 3、需求：加上搜索条件，计算每个tags下的商品数量</h4><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_search<br>&#123;<br>  &quot;size&quot;: 0, <br>  &quot;query&quot;: &#123;<br>    &quot;match&quot;: &#123;<br>      &quot;description&quot;: &quot;java程序员&quot;<br>    &#125;<br>  &#125;, <br>  &quot;aggs&quot;: &#123;<br>    &quot;group_by_tags&quot;: &#123;<br>      &quot;terms&quot;: &#123; &quot;field&quot;: &quot;tags&quot; &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4、需求-先分组-再算每组的平均值-计算每个tag下的商品的平均价格" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4、需求-先分组-再算每组的平均值-计算每个tag下的商品的平均价格">#</a> 4、需求：先分组，再算每组的平均值，计算每个tag下的商品的平均价格</h4><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_search<br>&#123;<br>    &quot;size&quot;: 0,<br>    &quot;aggs&quot; : &#123;<br>        &quot;group_by_tags&quot; : &#123;<br>            &quot;terms&quot; : &#123; <br>              &quot;field&quot; : &quot;tags&quot; <br>            &#125;,<br>            &quot;aggs&quot; : &#123;<br>                &quot;avg_price&quot; : &#123;<br>                    &quot;avg&quot; : &#123; &quot;field&quot; : &quot;price&quot; &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5、需求-计算每个tag下的商品的平均价格-并且按照平均价格降序排序" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_5、需求-计算每个tag下的商品的平均价格-并且按照平均价格降序排序">#</a> 5、需求：计算每个tag下的商品的平均价格，并且按照平均价格降序排序</h4><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_search<br>&#123;<br>    &quot;size&quot;: 0,<br>    &quot;aggs&quot; : &#123;<br>        &quot;group_by_tags&quot; : &#123;<br>            &quot;terms&quot; : &#123; <br>              &quot;field&quot; : &quot;tags&quot;,<br>              &quot;order&quot;: &#123;<br>                &quot;avg_price&quot;: &quot;desc&quot;<br>              &#125;<br>            &#125;,<br>            &quot;aggs&quot; : &#123;<br>                &quot;avg_price&quot; : &#123;<br>                    &quot;avg&quot; : &#123; &quot;field&quot; : &quot;price&quot; &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6、需求-按照指定的价格范围区间进行分组-然后在每组内再按照tag进行分组-最后再计算每组的平均价格" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_6、需求-按照指定的价格范围区间进行分组-然后在每组内再按照tag进行分组-最后再计算每组的平均价格">#</a> 6、需求：按照指定的价格范围区间进行分组，然后在每组内再按照tag进行分组，最后再计算每组的平均价格</h4><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /book/_search<br>&#123;<br>  &quot;size&quot;: 0,<br>  &quot;aggs&quot;: &#123;<br>    &quot;group_by_price&quot;: &#123;<br>      &quot;range&quot;: &#123;<br>        &quot;field&quot;: &quot;price&quot;,<br>        &quot;ranges&quot;: [<br>          &#123;<br>            &quot;from&quot;: 0,<br>            &quot;to&quot;: 40<br>          &#125;,<br>          &#123;<br>            &quot;from&quot;: 40,<br>            &quot;to&quot;: 60<br>          &#125;,<br>          &#123;<br>            &quot;from&quot;: 60,<br>            &quot;to&quot;: 80<br>          &#125;<br>        ]<br>      &#125;,<br>      &quot;aggs&quot;: &#123;<br>        &quot;group_by_tags&quot;: &#123;<br>          &quot;terms&quot;: &#123;<br>            &quot;field&quot;: &quot;tags&quot;<br>          &#125;,<br>          &quot;aggs&quot;: &#123;<br>            &quot;average_price&quot;: &#123;<br>              &quot;avg&quot;: &#123;<br>                &quot;field&quot;: &quot;price&quot;<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="二、两个核心概念-bucket和metric" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#二、两个核心概念-bucket和metric">#</a> 二、两个核心概念：bucket和metric</h3><h4 id="_1、bucket-一个数据分组" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、bucket-一个数据分组">#</a> 1、bucket：一个数据分组</h4><p>city name 北京 张三 北京 李四 天津 王五 天津 赵六</p><p>天津 王麻子</p><p>划分出来两个bucket，一个是北京bucket，一个是天津bucket 北京bucket：包含了2个人，张三，李四 上海bucket：包含了3个人，王五，赵六，王麻子</p><h4 id="_2、metric-对一个数据分组执行的统计" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、metric-对一个数据分组执行的统计">#</a> 2、metric：对一个数据分组执行的统计</h4><p>metric，就是对一个bucket执行的某种聚合分析的操作，比如说求平均值，求最大值，求最小值</p><p>select count(*) from book group studymodel</p><p>bucket：group by studymodel --&gt; 那些studymodel相同的数据，就会被划分到一个bucket中 metric：count(*)，对每个user_id bucket中所有的数据，计算一个数量。还有avg()，sum()，max()，min()</p><h4 id="_3、电视案例" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、电视案例">#</a> 3、电视案例</h4><p>创建索引及映射</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs text">PUT /tvs<br>PUT /tvs/_search<br>&#123;           <br>            &quot;properties&quot;: &#123;<br>                &quot;price&quot;: &#123;<br>                    &quot;type&quot;: &quot;long&quot;<br>                &#125;,<br>                &quot;color&quot;: &#123;<br>                    &quot;type&quot;: &quot;keyword&quot;<br>                &#125;,<br>                &quot;brand&quot;: &#123;<br>                    &quot;type&quot;: &quot;keyword&quot;<br>                &#125;,<br>                &quot;sold_date&quot;: &#123;<br>                    &quot;type&quot;: &quot;date&quot;<br>                &#125;<br>            &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>插入数据</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs text">POST /tvs/_bulk<br>&#123; &quot;index&quot;: &#123;&#125;&#125;<br>&#123; &quot;price&quot; : 1000, &quot;color&quot; : &quot;红色&quot;, &quot;brand&quot; : &quot;长虹&quot;, &quot;sold_date&quot; : &quot;2019-10-28&quot; &#125;<br>&#123; &quot;index&quot;: &#123;&#125;&#125;<br>&#123; &quot;price&quot; : 2000, &quot;color&quot; : &quot;红色&quot;, &quot;brand&quot; : &quot;长虹&quot;, &quot;sold_date&quot; : &quot;2019-11-05&quot; &#125;<br>&#123; &quot;index&quot;: &#123;&#125;&#125;<br>&#123; &quot;price&quot; : 3000, &quot;color&quot; : &quot;绿色&quot;, &quot;brand&quot; : &quot;小米&quot;, &quot;sold_date&quot; : &quot;2019-05-18&quot; &#125;<br>&#123; &quot;index&quot;: &#123;&#125;&#125;<br>&#123; &quot;price&quot; : 1500, &quot;color&quot; : &quot;蓝色&quot;, &quot;brand&quot; : &quot;TCL&quot;, &quot;sold_date&quot; : &quot;2019-07-02&quot; &#125;<br>&#123; &quot;index&quot;: &#123;&#125;&#125;<br>&#123; &quot;price&quot; : 1200, &quot;color&quot; : &quot;绿色&quot;, &quot;brand&quot; : &quot;TCL&quot;, &quot;sold_date&quot; : &quot;2019-08-19&quot; &#125;<br>&#123; &quot;index&quot;: &#123;&#125;&#125;<br>&#123; &quot;price&quot; : 2000, &quot;color&quot; : &quot;红色&quot;, &quot;brand&quot; : &quot;长虹&quot;, &quot;sold_date&quot; : &quot;2019-11-05&quot; &#125;<br>&#123; &quot;index&quot;: &#123;&#125;&#125;<br>&#123; &quot;price&quot; : 8000, &quot;color&quot; : &quot;红色&quot;, &quot;brand&quot; : &quot;三星&quot;, &quot;sold_date&quot; : &quot;2020-01-01&quot; &#125;<br>&#123; &quot;index&quot;: &#123;&#125;&#125;<br>&#123; &quot;price&quot; : 2500, &quot;color&quot; : &quot;蓝色&quot;, &quot;brand&quot; : &quot;小米&quot;, &quot;sold_date&quot; : &quot;2020-02-12&quot; &#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="需求1-统计哪种颜色的电视销量最高" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#需求1-统计哪种颜色的电视销量最高">#</a> 需求1 统计哪种颜色的电视销量最高</h5><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /tvs/_search<br>&#123;<br>    &quot;size&quot; : 0,<br>    &quot;aggs&quot; : &#123; <br>        &quot;popular_colors&quot; : &#123; <br>            &quot;terms&quot; : &#123; <br>              &quot;field&quot; : &quot;color&quot;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查询条件解析</p><p>size：只获取聚合结果，而不要执行聚合的原始数据 aggs：固定语法，要对一份数据执行分组聚合操作 popular_colors：就是对每个aggs，都要起一个名字， terms：根据字段的值进行分组 field：根据指定的字段的值进行分组</p><p>返回</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs text">&#123;<br>  &quot;took&quot; : 18,<br>  &quot;timed_out&quot; : false,<br>  &quot;_shards&quot; : &#123;<br>    &quot;total&quot; : 1,<br>    &quot;successful&quot; : 1,<br>    &quot;skipped&quot; : 0,<br>    &quot;failed&quot; : 0<br>  &#125;,<br>  &quot;hits&quot; : &#123;<br>    &quot;total&quot; : &#123;<br>      &quot;value&quot; : 8,<br>      &quot;relation&quot; : &quot;eq&quot;<br>    &#125;,<br>    &quot;max_score&quot; : null,<br>    &quot;hits&quot; : [ ]<br>  &#125;,<br>  &quot;aggregations&quot; : &#123;<br>    &quot;popular_colors&quot; : &#123;<br>      &quot;doc_count_error_upper_bound&quot; : 0,<br>      &quot;sum_other_doc_count&quot; : 0,<br>      &quot;buckets&quot; : [<br>        &#123;<br>          &quot;key&quot; : &quot;红色&quot;,<br>          &quot;doc_count&quot; : 4<br>        &#125;,<br>        &#123;<br>          &quot;key&quot; : &quot;绿色&quot;,<br>          &quot;doc_count&quot; : 2<br>        &#125;,<br>        &#123;<br>          &quot;key&quot; : &quot;蓝色&quot;,<br>          &quot;doc_count&quot; : 2<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>返回结果解析</p><p>hits.hits：我们指定了size是0，所以hits.hits就是空的 aggregations：聚合结果 popular_color：我们指定的某个聚合的名称 buckets：根据我们指定的field划分出的buckets key：每个bucket对应的那个值 doc_count：这个bucket分组内，有多少个数据 数量，其实就是这种颜色的销量</p><p>每种颜色对应的bucket中的数据的默认的排序规则：按照doc_count降序排序</p><h5 id="需求2-统计每种颜色电视平均价格" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#需求2-统计每种颜色电视平均价格">#</a> 需求2 统计每种颜色电视平均价格</h5><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /tvs/_search<br>&#123;<br>   &quot;size&quot; : 0,<br>   &quot;aggs&quot;: &#123;<br>      &quot;colors&quot;: &#123;<br>         &quot;terms&quot;: &#123;<br>            &quot;field&quot;: &quot;color&quot;<br>         &#125;,<br>         &quot;aggs&quot;: &#123; <br>            &quot;avg_price&quot;: &#123; <br>               &quot;avg&quot;: &#123;<br>                  &quot;field&quot;: &quot;price&quot; <br>               &#125;<br>            &#125;<br>         &#125;<br>      &#125;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在一个aggs执行的bucket操作（terms），平级的json结构下，再加一个aggs，这个第二个aggs内部，同样取个名字，执行一个metric操作，avg，对之前的每个bucket中的数据的指定的field，price field，求一个平均值</p><p>返回：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs text">&#123;<br>  &quot;took&quot; : 4,<br>  &quot;timed_out&quot; : false,<br>  &quot;_shards&quot; : &#123;<br>    &quot;total&quot; : 1,<br>    &quot;successful&quot; : 1,<br>    &quot;skipped&quot; : 0,<br>    &quot;failed&quot; : 0<br>  &#125;,<br>  &quot;hits&quot; : &#123;<br>    &quot;total&quot; : &#123;<br>      &quot;value&quot; : 8,<br>      &quot;relation&quot; : &quot;eq&quot;<br>    &#125;,<br>    &quot;max_score&quot; : null,<br>    &quot;hits&quot; : [ ]<br>  &#125;,<br>  &quot;aggregations&quot; : &#123;<br>    &quot;colors&quot; : &#123;<br>      &quot;doc_count_error_upper_bound&quot; : 0,<br>      &quot;sum_other_doc_count&quot; : 0,<br>      &quot;buckets&quot; : [<br>        &#123;<br>          &quot;key&quot; : &quot;红色&quot;,<br>          &quot;doc_count&quot; : 4,<br>          &quot;avg_price&quot; : &#123;<br>            &quot;value&quot; : 3250.0<br>          &#125;<br>        &#125;,<br>        &#123;<br>          &quot;key&quot; : &quot;绿色&quot;,<br>          &quot;doc_count&quot; : 2,<br>          &quot;avg_price&quot; : &#123;<br>            &quot;value&quot; : 2100.0<br>          &#125;<br>        &#125;,<br>        &#123;<br>          &quot;key&quot; : &quot;蓝色&quot;,<br>          &quot;doc_count&quot; : 2,<br>          &quot;avg_price&quot; : &#123;<br>            &quot;value&quot; : 2000.0<br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>buckets，除了key和doc_count avg_price：我们自己取的metric aggs的名字 value：我们的metric计算的结果，每个bucket中的数据的price字段求平均值后的结果</p><p>相当于sql: select avg(price) from tvs group by color</p><h5 id="需求3-继续下钻分析" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#需求3-继续下钻分析">#</a> 需求3 继续下钻分析</h5><p>每个颜色下，平均价格及每个颜色下，每个品牌的平均价格</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /tvs/_search <br>&#123;<br>  &quot;size&quot;: 0,<br>  &quot;aggs&quot;: &#123;<br>    &quot;group_by_color&quot;: &#123;<br>      &quot;terms&quot;: &#123;<br>        &quot;field&quot;: &quot;color&quot;<br>      &#125;,<br>      &quot;aggs&quot;: &#123;<br>        &quot;color_avg_price&quot;: &#123;<br>          &quot;avg&quot;: &#123;<br>            &quot;field&quot;: &quot;price&quot;<br>          &#125;<br>        &#125;,<br>        &quot;group_by_brand&quot;: &#123;<br>          &quot;terms&quot;: &#123;<br>            &quot;field&quot;: &quot;brand&quot;<br>          &#125;,<br>          &quot;aggs&quot;: &#123;<br>            &quot;brand_avg_price&quot;: &#123;<br>              &quot;avg&quot;: &#123;<br>                &quot;field&quot;: &quot;price&quot;<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="需求4-更多的metric" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#需求4-更多的metric">#</a> 需求4：更多的metric</h5><p>count：bucket，terms，自动就会有一个doc_count，就相当于是count avg：avg aggs，求平均值 max：求一个bucket内，指定field值最大的那个数据 min：求一个bucket内，指定field值最小的那个数据 sum：求一个bucket内，指定field值的总和</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /tvs/_search<br>&#123;<br>   &quot;size&quot; : 0,<br>   &quot;aggs&quot;: &#123;<br>      &quot;colors&quot;: &#123;<br>         &quot;terms&quot;: &#123;<br>            &quot;field&quot;: &quot;color&quot;<br>         &#125;,<br>         &quot;aggs&quot;: &#123;<br>            &quot;avg_price&quot;: &#123; &quot;avg&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125;,<br>            &quot;min_price&quot; : &#123; &quot;min&quot;: &#123; &quot;field&quot;: &quot;price&quot;&#125; &#125;, <br>            &quot;max_price&quot; : &#123; &quot;max&quot;: &#123; &quot;field&quot;: &quot;price&quot;&#125; &#125;,<br>            &quot;sum_price&quot; : &#123; &quot;sum&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125; <br>         &#125;<br>      &#125;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="需求5-划分范围-histogram" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#需求5-划分范围-histogram">#</a> 需求5：划分范围 histogram</h5><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /tvs/_search<br>&#123;<br>   &quot;size&quot; : 0,<br>   &quot;aggs&quot;:&#123;<br>      &quot;price&quot;:&#123;<br>         &quot;histogram&quot;:&#123; <br>            &quot;field&quot;: &quot;price&quot;,<br>            &quot;interval&quot;: 2000<br>         &#125;,<br>         &quot;aggs&quot;:&#123;<br>            &quot;income&quot;: &#123;<br>               &quot;sum&quot;: &#123; <br>                 &quot;field&quot; : &quot;price&quot;<br>               &#125;<br>             &#125;<br>         &#125;<br>      &#125;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>histogram：类似于terms，也是进行bucket分组操作，接收一个field，按照这个field的值的各个范围区间，进行bucket分组操作</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">&quot;histogram&quot;:&#123; <br>  &quot;field&quot;: &quot;price&quot;,<br>  &quot;interval&quot;: 2000<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>interval：2000，划分范围，0<sub>2000，2000</sub>4000，4000<sub>6000，6000</sub>8000，8000~10000，buckets</p><p>bucket有了之后，一样的，去对每个bucket执行avg，count，sum，max，min，等各种metric操作，聚合分析</p><h5 id="需求6-按照日期分组聚合" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#需求6-按照日期分组聚合">#</a> 需求6：按照日期分组聚合</h5><p>date_histogram，按照我们指定的某个date类型的日期field，以及日期interval，按照一定的日期间隔，去划分bucket</p><p>min_doc_count：即使某个日期interval，2017-01-01~2017-01-31中，一条数据都没有，那么这个区间也是要返回的，不然默认是会过滤掉这个区间的 extended_bounds，min，max：划分bucket的时候，会限定在这个起始日期，和截止日期内</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /tvs/_search<br>&#123;<br>   &quot;size&quot; : 0,<br>   &quot;aggs&quot;: &#123;<br>      &quot;sales&quot;: &#123;<br>         &quot;date_histogram&quot;: &#123;<br>            &quot;field&quot;: &quot;sold_date&quot;,<br>            &quot;interval&quot;: &quot;month&quot;, <br>            &quot;format&quot;: &quot;yyyy-MM-dd&quot;,<br>            &quot;min_doc_count&quot; : 0, <br>            &quot;extended_bounds&quot; : &#123; <br>                &quot;min&quot; : &quot;2019-01-01&quot;,<br>                &quot;max&quot; : &quot;2020-12-31&quot;<br>            &#125;<br>         &#125;<br>      &#125;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="需求7-统计每季度每个品牌的销售额" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#需求7-统计每季度每个品牌的销售额">#</a> 需求7 统计每季度每个品牌的销售额</h5><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /tvs/_search <br>&#123;<br>  &quot;size&quot;: 0,<br>  &quot;aggs&quot;: &#123;<br>    &quot;group_by_sold_date&quot;: &#123;<br>      &quot;date_histogram&quot;: &#123;<br>        &quot;field&quot;: &quot;sold_date&quot;,<br>        &quot;interval&quot;: &quot;quarter&quot;,<br>        &quot;format&quot;: &quot;yyyy-MM-dd&quot;,<br>        &quot;min_doc_count&quot;: 0,<br>        &quot;extended_bounds&quot;: &#123;<br>          &quot;min&quot;: &quot;2019-01-01&quot;,<br>          &quot;max&quot;: &quot;2020-12-31&quot;<br>        &#125;<br>      &#125;,<br>      &quot;aggs&quot;: &#123;<br>        &quot;group_by_brand&quot;: &#123;<br>          &quot;terms&quot;: &#123;<br>            &quot;field&quot;: &quot;brand&quot;<br>          &#125;,<br>          &quot;aggs&quot;: &#123;<br>            &quot;sum_price&quot;: &#123;<br>              &quot;sum&quot;: &#123;<br>                &quot;field&quot;: &quot;price&quot;<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;,<br>        &quot;total_sum_price&quot;: &#123;<br>          &quot;sum&quot;: &#123;<br>            &quot;field&quot;: &quot;price&quot;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="需求8-搜索与聚合结合-查询某个品牌按颜色销量" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#需求8-搜索与聚合结合-查询某个品牌按颜色销量">#</a> 需求8 ：搜索与聚合结合，查询某个品牌按颜色销量</h5><p>搜索与聚合可以结合起来。</p><p>sql select count(*)</p><p>from tvs</p><p>where brand like "%小米%"</p><p>group by color</p><p>es aggregation，scope，任何的聚合，都必须在搜索出来的结果数据中之行，搜索结果，就是聚合分析操作的scope</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /tvs/_search <br>&#123;<br>  &quot;size&quot;: 0,<br>  &quot;query&quot;: &#123;<br>    &quot;term&quot;: &#123;<br>      &quot;brand&quot;: &#123;<br>        &quot;value&quot;: &quot;小米&quot;<br>      &#125;<br>    &#125;<br>  &#125;,<br>  &quot;aggs&quot;: &#123;<br>    &quot;group_by_color&quot;: &#123;<br>      &quot;terms&quot;: &#123;<br>        &quot;field&quot;: &quot;color&quot;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="需求9-global-bucket-单个品牌与所有品牌销量对比" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#需求9-global-bucket-单个品牌与所有品牌销量对比">#</a> 需求9 global bucket：单个品牌与所有品牌销量对比</h5><p>aggregation，scope，一个聚合操作，必须在query的搜索结果范围内执行</p><p>出来两个结果，一个结果，是基于query搜索结果来聚合的; 一个结果，是对所有数据执行聚合的</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /tvs/_search <br>&#123;<br>  &quot;size&quot;: 0, <br>  &quot;query&quot;: &#123;<br>    &quot;term&quot;: &#123;<br>      &quot;brand&quot;: &#123;<br>        &quot;value&quot;: &quot;小米&quot;<br>      &#125;<br>    &#125;<br>  &#125;,<br>  &quot;aggs&quot;: &#123;<br>    &quot;single_brand_avg_price&quot;: &#123;<br>      &quot;avg&quot;: &#123;<br>        &quot;field&quot;: &quot;price&quot;<br>      &#125;<br>    &#125;,<br>    &quot;all&quot;: &#123;<br>      &quot;global&quot;: &#123;&#125;,<br>      &quot;aggs&quot;: &#123;<br>        &quot;all_brand_avg_price&quot;: &#123;<br>          &quot;avg&quot;: &#123;<br>            &quot;field&quot;: &quot;price&quot;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="需求10-过滤-聚合-统计价格大于1200的电视平均价格" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#需求10-过滤-聚合-统计价格大于1200的电视平均价格">#</a> 需求10：过滤+聚合：统计价格大于1200的电视平均价格</h5><p>搜索+聚合</p><p>过滤+聚合</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /tvs/_search <br>&#123;<br>  &quot;size&quot;: 0,<br>  &quot;query&quot;: &#123;<br>    &quot;constant_score&quot;: &#123;<br>      &quot;filter&quot;: &#123;<br>        &quot;range&quot;: &#123;<br>          &quot;price&quot;: &#123;<br>            &quot;gte&quot;: 1200<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;,<br>  &quot;aggs&quot;: &#123;<br>    &quot;avg_price&quot;: &#123;<br>      &quot;avg&quot;: &#123;<br>        &quot;field&quot;: &quot;price&quot;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="需求11-bucket-filter-统计品牌最近一个月的平均价格" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#需求11-bucket-filter-统计品牌最近一个月的平均价格">#</a> 需求11 bucket filter：统计品牌最近一个月的平均价格</h5><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /tvs/_search <br>&#123;<br>  &quot;size&quot;: 0,<br>  &quot;query&quot;: &#123;<br>    &quot;term&quot;: &#123;<br>      &quot;brand&quot;: &#123;<br>        &quot;value&quot;: &quot;小米&quot;<br>      &#125;<br>    &#125;<br>  &#125;,<br>  &quot;aggs&quot;: &#123;<br>    &quot;recent_150d&quot;: &#123;<br>      &quot;filter&quot;: &#123;<br>        &quot;range&quot;: &#123;<br>          &quot;sold_date&quot;: &#123;<br>            &quot;gte&quot;: &quot;now-150d&quot;<br>          &#125;<br>        &#125;<br>      &#125;,<br>      &quot;aggs&quot;: &#123;<br>        &quot;recent_150d_avg_price&quot;: &#123;<br>          &quot;avg&quot;: &#123;<br>            &quot;field&quot;: &quot;price&quot;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;,<br>    &quot;recent_140d&quot;: &#123;<br>      &quot;filter&quot;: &#123;<br>        &quot;range&quot;: &#123;<br>          &quot;sold_date&quot;: &#123;<br>            &quot;gte&quot;: &quot;now-140d&quot;<br>          &#125;<br>        &#125;<br>      &#125;,<br>      &quot;aggs&quot;: &#123;<br>        &quot;recent_140d_avg_price&quot;: &#123;<br>          &quot;avg&quot;: &#123;<br>            &quot;field&quot;: &quot;price&quot;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;,<br>    &quot;recent_130d&quot;: &#123;<br>      &quot;filter&quot;: &#123;<br>        &quot;range&quot;: &#123;<br>          &quot;sold_date&quot;: &#123;<br>            &quot;gte&quot;: &quot;now-130d&quot;<br>          &#125;<br>        &#125;<br>      &#125;,<br>      &quot;aggs&quot;: &#123;<br>        &quot;recent_130d_avg_price&quot;: &#123;<br>          &quot;avg&quot;: &#123;<br>            &quot;field&quot;: &quot;price&quot;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>aggs.filter，针对的是聚合去做的</p><p>如果放query里面的filter，是全局的，会对所有的数据都有影响</p><p>但是，如果，比如说，你要统计，长虹电视，最近1个月的平均值; 最近3个月的平均值; 最近6个月的平均值</p><p>bucket filter：对不同的bucket下的aggs，进行filter</p><h5 id="需求12-排序-按每种颜色的平均销售额降序排序" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#需求12-排序-按每种颜色的平均销售额降序排序">#</a> 需求12 排序：按每种颜色的平均销售额降序排序</h5><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /tvs/_search <br>&#123;<br>  &quot;size&quot;: 0,<br>  &quot;aggs&quot;: &#123;<br>    &quot;group_by_color&quot;: &#123;<br>      &quot;terms&quot;: &#123;<br>        &quot;field&quot;: &quot;color&quot;,<br>        &quot;order&quot;: &#123;<br>          &quot;avg_price&quot;: &quot;asc&quot;<br>        &#125;<br>      &#125;,<br>      &quot;aggs&quot;: &#123;<br>        &quot;avg_price&quot;: &#123;<br>          &quot;avg&quot;: &#123;<br>            &quot;field&quot;: &quot;price&quot;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>相当于sql子表数据字段可以立刻使用。</p><h5 id="需求13-排序-按每种颜色的每种品牌平均销售额降序排序" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#需求13-排序-按每种颜色的每种品牌平均销售额降序排序">#</a> 需求13 排序：按每种颜色的每种品牌平均销售额降序排序</h5><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs text">GET /tvs/_search  <br>&#123;<br>  &quot;size&quot;: 0,<br>  &quot;aggs&quot;: &#123;<br>    &quot;group_by_color&quot;: &#123;<br>      &quot;terms&quot;: &#123;<br>        &quot;field&quot;: &quot;color&quot;<br>      &#125;,<br>      &quot;aggs&quot;: &#123;<br>        &quot;group_by_brand&quot;: &#123;<br>          &quot;terms&quot;: &#123;<br>            &quot;field&quot;: &quot;brand&quot;,<br>            &quot;order&quot;: &#123;<br>              &quot;avg_price&quot;: &quot;desc&quot;<br>            &#125;<br>          &#125;,<br>          &quot;aggs&quot;: &#123;<br>            &quot;avg_price&quot;: &#123;<br>              &quot;avg&quot;: &#123;<br>                &quot;field&quot;: &quot;price&quot;<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="第十八章-java-api实现聚合" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第十八章-java-api实现聚合">#</a> 第十八章 java api实现聚合</h2><p>简单聚合，多种聚合，详见代码。</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydlclass.es;<br><br><span class="hljs-keyword">import</span> org.elasticsearch.action.search.SearchRequest;<br><span class="hljs-keyword">import</span> org.elasticsearch.action.search.SearchResponse;<br><span class="hljs-keyword">import</span> org.elasticsearch.client.RequestOptions;<br><span class="hljs-keyword">import</span> org.elasticsearch.client.RestHighLevelClient;<br><span class="hljs-keyword">import</span> org.elasticsearch.index.query.QueryBuilders;<br><span class="hljs-keyword">import</span> org.elasticsearch.search.aggregations.Aggregation;<br><span class="hljs-keyword">import</span> org.elasticsearch.search.aggregations.AggregationBuilders;<br><span class="hljs-keyword">import</span> org.elasticsearch.search.aggregations.Aggregations;<br><span class="hljs-keyword">import</span> org.elasticsearch.search.aggregations.bucket.histogram.*;<br><span class="hljs-keyword">import</span> org.elasticsearch.search.aggregations.bucket.terms.Terms;<br><span class="hljs-keyword">import</span> org.elasticsearch.search.aggregations.bucket.terms.TermsAggregationBuilder;<br><span class="hljs-keyword">import</span> org.elasticsearch.search.aggregations.metrics.*;<br><span class="hljs-keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * creste by ydlclass.ydl</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestAggs</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    RestHighLevelClient client;<br><br>    <span class="hljs-comment">//需求一：按照颜色分组，计算每个颜色卖出的个数</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testAggs</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// GET /tvs/_search</span><br>        <span class="hljs-comment">// &#123;</span><br>        <span class="hljs-comment">//     &quot;size&quot;: 0,</span><br>        <span class="hljs-comment">//     &quot;query&quot;: &#123;&quot;match_all&quot;: &#123;&#125;&#125;,</span><br>        <span class="hljs-comment">//     &quot;aggs&quot;: &#123;</span><br>        <span class="hljs-comment">//       &quot;group_by_color&quot;: &#123;</span><br>        <span class="hljs-comment">//         &quot;terms&quot;: &#123;</span><br>        <span class="hljs-comment">//             &quot;field&quot;: &quot;color&quot;</span><br>        <span class="hljs-comment">//         &#125;</span><br>        <span class="hljs-comment">//     &#125;</span><br>        <span class="hljs-comment">// &#125;</span><br>        <span class="hljs-comment">// &#125;</span><br><br>        <span class="hljs-comment">//1 构建请求</span><br>        SearchRequest searchRequest=<span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;tvs&quot;</span>);<br><br>        <span class="hljs-comment">//请求体</span><br>        SearchSourceBuilder searchSourceBuilder=<span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchSourceBuilder</span>();<br>        searchSourceBuilder.size(<span class="hljs-number">0</span>);<br>        searchSourceBuilder.query(QueryBuilders.matchAllQuery());<br><br>        <span class="hljs-type">TermsAggregationBuilder</span> <span class="hljs-variable">termsAggregationBuilder</span> <span class="hljs-operator">=</span> AggregationBuilders.terms(<span class="hljs-string">&quot;group_by_color&quot;</span>).field(<span class="hljs-string">&quot;color&quot;</span>);<br>        searchSourceBuilder.aggregation(termsAggregationBuilder);<br><br>        <span class="hljs-comment">//请求体放入请求头</span><br>        searchRequest.source(searchSourceBuilder);<br><br>        <span class="hljs-comment">//2 执行</span><br>        <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">searchResponse</span> <span class="hljs-operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);<br><br>        <span class="hljs-comment">//3 获取结果</span><br>      <span class="hljs-comment">//   &quot;aggregations&quot; : &#123;</span><br>      <span class="hljs-comment">//       &quot;group_by_color&quot; : &#123;</span><br>      <span class="hljs-comment">//           &quot;doc_count_error_upper_bound&quot; : 0,</span><br>      <span class="hljs-comment">//           &quot;sum_other_doc_count&quot; : 0,</span><br>      <span class="hljs-comment">//            &quot;buckets&quot; : [</span><br>      <span class="hljs-comment">//           &#123;</span><br>      <span class="hljs-comment">//               &quot;key&quot; : &quot;红色&quot;,</span><br>      <span class="hljs-comment">//               &quot;doc_count&quot; : 4</span><br>      <span class="hljs-comment">//           &#125;,</span><br>      <span class="hljs-comment">//           &#123;</span><br>      <span class="hljs-comment">//               &quot;key&quot; : &quot;绿色&quot;,</span><br>      <span class="hljs-comment">//                   &quot;doc_count&quot; : 2</span><br>      <span class="hljs-comment">//           &#125;,</span><br>      <span class="hljs-comment">//           &#123;</span><br>      <span class="hljs-comment">//               &quot;key&quot; : &quot;蓝色&quot;,</span><br>      <span class="hljs-comment">//                   &quot;doc_count&quot; : 2</span><br>      <span class="hljs-comment">//           &#125;</span><br>      <span class="hljs-comment">// ]</span><br>      <span class="hljs-comment">//       &#125;</span><br>        <span class="hljs-type">Aggregations</span> <span class="hljs-variable">aggregations</span> <span class="hljs-operator">=</span> searchResponse.getAggregations();<br>        <span class="hljs-type">Terms</span> <span class="hljs-variable">group_by_color</span> <span class="hljs-operator">=</span> aggregations.get(<span class="hljs-string">&quot;group_by_color&quot;</span>);<br>        List&amp;lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Terms</span>.Bucket&amp;gt; buckets = group_by_color.getBuckets();<br>        <span class="hljs-keyword">for</span> (Terms.Bucket bucket : buckets) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> bucket.getKeyAsString();<br>            System.out.println(<span class="hljs-string">&quot;key:&quot;</span>+key);<br><br>            <span class="hljs-type">long</span> <span class="hljs-variable">docCount</span> <span class="hljs-operator">=</span> bucket.getDocCount();<br>            System.out.println(<span class="hljs-string">&quot;docCount:&quot;</span>+docCount);<br><br>            System.out.println(<span class="hljs-string">&quot;=================================&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// #需求二：按照颜色分组，计算每个颜色卖出的个数，每个颜色卖出的平均价格</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testAggsAndAvg</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// GET /tvs/_search</span><br>        <span class="hljs-comment">// &#123;</span><br>        <span class="hljs-comment">//     &quot;size&quot;: 0,</span><br>        <span class="hljs-comment">//      &quot;query&quot;: &#123;&quot;match_all&quot;: &#123;&#125;&#125;,</span><br>        <span class="hljs-comment">//     &quot;aggs&quot;: &#123;</span><br>        <span class="hljs-comment">//     &quot;group_by_color&quot;: &#123;</span><br>        <span class="hljs-comment">//         &quot;terms&quot;: &#123;</span><br>        <span class="hljs-comment">//             &quot;field&quot;: &quot;color&quot;</span><br>        <span class="hljs-comment">//         &#125;,</span><br>        <span class="hljs-comment">//         &quot;aggs&quot;: &#123;</span><br>        <span class="hljs-comment">//             &quot;avg_price&quot;: &#123;</span><br>        <span class="hljs-comment">//                 &quot;avg&quot;: &#123;</span><br>        <span class="hljs-comment">//                     &quot;field&quot;: &quot;price&quot;</span><br>        <span class="hljs-comment">//                 &#125;</span><br>        <span class="hljs-comment">//             &#125;</span><br>        <span class="hljs-comment">//         &#125;</span><br>        <span class="hljs-comment">//     &#125;</span><br>        <span class="hljs-comment">// &#125;</span><br>        <span class="hljs-comment">// &#125;</span><br><br>        <span class="hljs-comment">//1 构建请求</span><br>        SearchRequest searchRequest=<span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;tvs&quot;</span>);<br><br>        <span class="hljs-comment">//请求体</span><br>        SearchSourceBuilder searchSourceBuilder=<span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchSourceBuilder</span>();<br>        searchSourceBuilder.size(<span class="hljs-number">0</span>);<br>        searchSourceBuilder.query(QueryBuilders.matchAllQuery());<br><br>        <span class="hljs-type">TermsAggregationBuilder</span> <span class="hljs-variable">termsAggregationBuilder</span> <span class="hljs-operator">=</span> AggregationBuilders.terms(<span class="hljs-string">&quot;group_by_color&quot;</span>).field(<span class="hljs-string">&quot;color&quot;</span>);<br><br>        <span class="hljs-comment">//terms聚合下填充一个子聚合</span><br>        <span class="hljs-type">AvgAggregationBuilder</span> <span class="hljs-variable">avgAggregationBuilder</span> <span class="hljs-operator">=</span> AggregationBuilders.avg(<span class="hljs-string">&quot;avg_price&quot;</span>).field(<span class="hljs-string">&quot;price&quot;</span>);<br>        termsAggregationBuilder.subAggregation(avgAggregationBuilder);<br><br>        searchSourceBuilder.aggregation(termsAggregationBuilder);<br><br>        <span class="hljs-comment">//请求体放入请求头</span><br>        searchRequest.source(searchSourceBuilder);<br><br>        <span class="hljs-comment">//2 执行</span><br>        <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">searchResponse</span> <span class="hljs-operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);<br><br>        <span class="hljs-comment">//3 获取结果</span><br>        <span class="hljs-comment">// &#123;</span><br>        <span class="hljs-comment">//     &quot;key&quot; : &quot;红色&quot;,</span><br>        <span class="hljs-comment">//      &quot;doc_count&quot; : 4,</span><br>        <span class="hljs-comment">//      &quot;avg_price&quot; : &#123;</span><br>        <span class="hljs-comment">//        &quot;value&quot; : 3250.0</span><br>        <span class="hljs-comment">//       &#125;</span><br>        <span class="hljs-comment">// &#125;</span><br>        <span class="hljs-type">Aggregations</span> <span class="hljs-variable">aggregations</span> <span class="hljs-operator">=</span> searchResponse.getAggregations();<br>        <span class="hljs-type">Terms</span> <span class="hljs-variable">group_by_color</span> <span class="hljs-operator">=</span> aggregations.get(<span class="hljs-string">&quot;group_by_color&quot;</span>);<br>        List&amp;lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Terms</span>.Bucket&amp;gt; buckets = group_by_color.getBuckets();<br>        <span class="hljs-keyword">for</span> (Terms.Bucket bucket : buckets) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> bucket.getKeyAsString();<br>            System.out.println(<span class="hljs-string">&quot;key:&quot;</span>+key);<br><br>            <span class="hljs-type">long</span> <span class="hljs-variable">docCount</span> <span class="hljs-operator">=</span> bucket.getDocCount();<br>            System.out.println(<span class="hljs-string">&quot;docCount:&quot;</span>+docCount);<br><br>            <span class="hljs-type">Aggregations</span> <span class="hljs-variable">aggregations1</span> <span class="hljs-operator">=</span> bucket.getAggregations();<br>            <span class="hljs-type">Avg</span> <span class="hljs-variable">avg_price</span> <span class="hljs-operator">=</span> aggregations1.get(<span class="hljs-string">&quot;avg_price&quot;</span>);<br>            <span class="hljs-type">double</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> avg_price.getValue();<br>            System.out.println(<span class="hljs-string">&quot;value:&quot;</span>+value);<br><br>            System.out.println(<span class="hljs-string">&quot;=================================&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// #需求三：按照颜色分组，计算每个颜色卖出的个数，以及每个颜色卖出的平均值、最大值、最小值、总和。</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testAggsAndMore</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// GET /tvs/_search</span><br>        <span class="hljs-comment">// &#123;</span><br>        <span class="hljs-comment">//     &quot;size&quot; : 0,</span><br>        <span class="hljs-comment">//     &quot;aggs&quot;: &#123;</span><br>        <span class="hljs-comment">//      &quot;group_by_color&quot;: &#123;</span><br>        <span class="hljs-comment">//         &quot;terms&quot;: &#123;</span><br>        <span class="hljs-comment">//             &quot;field&quot;: &quot;color&quot;</span><br>        <span class="hljs-comment">//         &#125;,</span><br>        <span class="hljs-comment">//         &quot;aggs&quot;: &#123;</span><br>        <span class="hljs-comment">//             &quot;avg_price&quot;: &#123; &quot;avg&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125;,</span><br>        <span class="hljs-comment">//             &quot;min_price&quot; : &#123; &quot;min&quot;: &#123; &quot;field&quot;: &quot;price&quot;&#125; &#125;,</span><br>        <span class="hljs-comment">//             &quot;max_price&quot; : &#123; &quot;max&quot;: &#123; &quot;field&quot;: &quot;price&quot;&#125; &#125;,</span><br>        <span class="hljs-comment">//             &quot;sum_price&quot; : &#123; &quot;sum&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125;</span><br>        <span class="hljs-comment">//         &#125;</span><br>        <span class="hljs-comment">//     &#125;</span><br>        <span class="hljs-comment">// &#125;</span><br>        <span class="hljs-comment">// &#125;</span><br><br>        <span class="hljs-comment">//1 构建请求</span><br>        SearchRequest searchRequest=<span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;tvs&quot;</span>);<br><br>        <span class="hljs-comment">//请求体</span><br>        SearchSourceBuilder searchSourceBuilder=<span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchSourceBuilder</span>();<br>        searchSourceBuilder.size(<span class="hljs-number">0</span>);<br>        searchSourceBuilder.query(QueryBuilders.matchAllQuery());<br><br>        <span class="hljs-type">TermsAggregationBuilder</span> <span class="hljs-variable">termsAggregationBuilder</span> <span class="hljs-operator">=</span> AggregationBuilders.terms(<span class="hljs-string">&quot;group_by_color&quot;</span>).field(<span class="hljs-string">&quot;color&quot;</span>);<br><br><br>        <span class="hljs-comment">//termsAggregationBuilder里放入多个子聚合</span><br>        <span class="hljs-type">AvgAggregationBuilder</span> <span class="hljs-variable">avgAggregationBuilder</span> <span class="hljs-operator">=</span> AggregationBuilders.avg(<span class="hljs-string">&quot;avg_price&quot;</span>).field(<span class="hljs-string">&quot;price&quot;</span>);<br>        <span class="hljs-type">MinAggregationBuilder</span> <span class="hljs-variable">minAggregationBuilder</span> <span class="hljs-operator">=</span> AggregationBuilders.min(<span class="hljs-string">&quot;min_price&quot;</span>).field(<span class="hljs-string">&quot;price&quot;</span>);<br>        <span class="hljs-type">MaxAggregationBuilder</span> <span class="hljs-variable">maxAggregationBuilder</span> <span class="hljs-operator">=</span> AggregationBuilders.max(<span class="hljs-string">&quot;max_price&quot;</span>).field(<span class="hljs-string">&quot;price&quot;</span>);<br>        <span class="hljs-type">SumAggregationBuilder</span> <span class="hljs-variable">sumAggregationBuilder</span> <span class="hljs-operator">=</span> AggregationBuilders.sum(<span class="hljs-string">&quot;sum_price&quot;</span>).field(<span class="hljs-string">&quot;price&quot;</span>);<br><br>        termsAggregationBuilder.subAggregation(avgAggregationBuilder);<br>        termsAggregationBuilder.subAggregation(minAggregationBuilder);<br>        termsAggregationBuilder.subAggregation(maxAggregationBuilder);<br>        termsAggregationBuilder.subAggregation(sumAggregationBuilder);<br><br><br>        searchSourceBuilder.aggregation(termsAggregationBuilder);<br><br>        <span class="hljs-comment">//请求体放入请求头</span><br>        searchRequest.source(searchSourceBuilder);<br><br>        <span class="hljs-comment">//2 执行</span><br>        <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">searchResponse</span> <span class="hljs-operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);<br><br>        <span class="hljs-comment">//3 获取结果</span><br>        <span class="hljs-comment">// &#123;</span><br>        <span class="hljs-comment">//     &quot;key&quot; : &quot;红色&quot;,</span><br>        <span class="hljs-comment">//     &quot;doc_count&quot; : 4,</span><br>        <span class="hljs-comment">//     &quot;max_price&quot; : &#123;</span><br>        <span class="hljs-comment">//          &quot;value&quot; : 8000.0</span><br>        <span class="hljs-comment">//     &#125;,</span><br>        <span class="hljs-comment">//     &quot;min_price&quot; : &#123;</span><br>        <span class="hljs-comment">//          &quot;value&quot; : 1000.0</span><br>        <span class="hljs-comment">// &#125;,</span><br>        <span class="hljs-comment">//     &quot;avg_price&quot; : &#123;</span><br>        <span class="hljs-comment">//         &quot;value&quot; : 3250.0</span><br>        <span class="hljs-comment">// &#125;,</span><br>        <span class="hljs-comment">//     &quot;sum_price&quot; : &#123;</span><br>        <span class="hljs-comment">//         &quot;value&quot; : 13000.0</span><br>        <span class="hljs-comment">// &#125;</span><br>        <span class="hljs-comment">// &#125;</span><br>        <span class="hljs-type">Aggregations</span> <span class="hljs-variable">aggregations</span> <span class="hljs-operator">=</span> searchResponse.getAggregations();<br>        <span class="hljs-type">Terms</span> <span class="hljs-variable">group_by_color</span> <span class="hljs-operator">=</span> aggregations.get(<span class="hljs-string">&quot;group_by_color&quot;</span>);<br>        List&amp;lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Terms</span>.Bucket&amp;gt; buckets = group_by_color.getBuckets();<br>        <span class="hljs-keyword">for</span> (Terms.Bucket bucket : buckets) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> bucket.getKeyAsString();<br>            System.out.println(<span class="hljs-string">&quot;key:&quot;</span>+key);<br><br>            <span class="hljs-type">long</span> <span class="hljs-variable">docCount</span> <span class="hljs-operator">=</span> bucket.getDocCount();<br>            System.out.println(<span class="hljs-string">&quot;docCount:&quot;</span>+docCount);<br><br>            <span class="hljs-type">Aggregations</span> <span class="hljs-variable">aggregations1</span> <span class="hljs-operator">=</span> bucket.getAggregations();<br><br>            <span class="hljs-type">Max</span> <span class="hljs-variable">max_price</span> <span class="hljs-operator">=</span> aggregations1.get(<span class="hljs-string">&quot;max_price&quot;</span>);<br>            <span class="hljs-type">double</span> <span class="hljs-variable">maxPriceValue</span> <span class="hljs-operator">=</span> max_price.getValue();<br>            System.out.println(<span class="hljs-string">&quot;maxPriceValue:&quot;</span>+maxPriceValue);<br><br>            <span class="hljs-type">Min</span> <span class="hljs-variable">min_price</span> <span class="hljs-operator">=</span> aggregations1.get(<span class="hljs-string">&quot;min_price&quot;</span>);<br>            <span class="hljs-type">double</span> <span class="hljs-variable">minPriceValue</span> <span class="hljs-operator">=</span> min_price.getValue();<br>            System.out.println(<span class="hljs-string">&quot;minPriceValue:&quot;</span>+minPriceValue);<br><br>            <span class="hljs-type">Avg</span> <span class="hljs-variable">avg_price</span> <span class="hljs-operator">=</span> aggregations1.get(<span class="hljs-string">&quot;avg_price&quot;</span>);<br>            <span class="hljs-type">double</span> <span class="hljs-variable">avgPriceValue</span> <span class="hljs-operator">=</span> avg_price.getValue();<br>            System.out.println(<span class="hljs-string">&quot;avgPriceValue:&quot;</span>+avgPriceValue);<br><br>            <span class="hljs-type">Sum</span> <span class="hljs-variable">sum_price</span> <span class="hljs-operator">=</span> aggregations1.get(<span class="hljs-string">&quot;sum_price&quot;</span>);<br>            <span class="hljs-type">double</span> <span class="hljs-variable">sumPriceValue</span> <span class="hljs-operator">=</span> sum_price.getValue();<br>            System.out.println(<span class="hljs-string">&quot;sumPriceValue:&quot;</span>+sumPriceValue);<br><br>            System.out.println(<span class="hljs-string">&quot;=================================&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// #需求四：按照售价每2000价格划分范围，算出每个区间的销售总额 histogram</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testAggsAndHistogram</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// GET /tvs/_search</span><br>        <span class="hljs-comment">// &#123;</span><br>        <span class="hljs-comment">//     &quot;size&quot; : 0,</span><br>        <span class="hljs-comment">//     &quot;aggs&quot;:&#123;</span><br>        <span class="hljs-comment">//      &quot;by_histogram&quot;:&#123;</span><br>        <span class="hljs-comment">//         &quot;histogram&quot;:&#123;</span><br>        <span class="hljs-comment">//             &quot;field&quot;: &quot;price&quot;,</span><br>        <span class="hljs-comment">//             &quot;interval&quot;: 2000</span><br>        <span class="hljs-comment">//         &#125;,</span><br>        <span class="hljs-comment">//         &quot;aggs&quot;:&#123;</span><br>        <span class="hljs-comment">//             &quot;income&quot;: &#123;</span><br>        <span class="hljs-comment">//                 &quot;sum&quot;: &#123;</span><br>        <span class="hljs-comment">//                     &quot;field&quot; : &quot;price&quot;</span><br>        <span class="hljs-comment">//                 &#125;</span><br>        <span class="hljs-comment">//             &#125;</span><br>        <span class="hljs-comment">//         &#125;</span><br>        <span class="hljs-comment">//     &#125;</span><br>        <span class="hljs-comment">// &#125;</span><br>        <span class="hljs-comment">// &#125;</span><br><br>        <span class="hljs-comment">//1 构建请求</span><br>        SearchRequest searchRequest=<span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;tvs&quot;</span>);<br><br>        <span class="hljs-comment">//请求体</span><br>        SearchSourceBuilder searchSourceBuilder=<span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchSourceBuilder</span>();<br>        searchSourceBuilder.size(<span class="hljs-number">0</span>);<br>        searchSourceBuilder.query(QueryBuilders.matchAllQuery());<br><br>        <span class="hljs-type">HistogramAggregationBuilder</span> <span class="hljs-variable">histogramAggregationBuilder</span> <span class="hljs-operator">=</span> AggregationBuilders.histogram(<span class="hljs-string">&quot;by_histogram&quot;</span>).field(<span class="hljs-string">&quot;price&quot;</span>).interval(<span class="hljs-number">2000</span>);<br><br>        <span class="hljs-type">SumAggregationBuilder</span> <span class="hljs-variable">sumAggregationBuilder</span> <span class="hljs-operator">=</span> AggregationBuilders.sum(<span class="hljs-string">&quot;income&quot;</span>).field(<span class="hljs-string">&quot;price&quot;</span>);<br>        histogramAggregationBuilder.subAggregation(sumAggregationBuilder);<br>        searchSourceBuilder.aggregation(histogramAggregationBuilder);<br><br>        <span class="hljs-comment">//请求体放入请求头</span><br>        searchRequest.source(searchSourceBuilder);<br><br>        <span class="hljs-comment">//2 执行</span><br>        <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">searchResponse</span> <span class="hljs-operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);<br><br>        <span class="hljs-comment">//3 获取结果</span><br>        <span class="hljs-comment">// &#123;</span><br>        <span class="hljs-comment">//     &quot;key&quot; : 0.0,</span><br>        <span class="hljs-comment">//     &quot;doc_count&quot; : 3,</span><br>        <span class="hljs-comment">//      income&quot; : &#123;</span><br>        <span class="hljs-comment">//          &quot;value&quot; : 3700.0</span><br>        <span class="hljs-comment">//       &#125;</span><br>        <span class="hljs-comment">// &#125;</span><br>        <span class="hljs-type">Aggregations</span> <span class="hljs-variable">aggregations</span> <span class="hljs-operator">=</span> searchResponse.getAggregations();<br>        <span class="hljs-type">Histogram</span> <span class="hljs-variable">group_by_color</span> <span class="hljs-operator">=</span> aggregations.get(<span class="hljs-string">&quot;by_histogram&quot;</span>);<br>        List&amp;lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Histogram</span>.Bucket&amp;gt; buckets = group_by_color.getBuckets();<br>        <span class="hljs-keyword">for</span> (Histogram.Bucket bucket : buckets) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">keyAsString</span> <span class="hljs-operator">=</span> bucket.getKeyAsString();<br>            System.out.println(<span class="hljs-string">&quot;keyAsString:&quot;</span>+keyAsString);<br>            <span class="hljs-type">long</span> <span class="hljs-variable">docCount</span> <span class="hljs-operator">=</span> bucket.getDocCount();<br>            System.out.println(<span class="hljs-string">&quot;docCount:&quot;</span>+docCount);<br><br>            <span class="hljs-type">Aggregations</span> <span class="hljs-variable">aggregations1</span> <span class="hljs-operator">=</span> bucket.getAggregations();<br>            <span class="hljs-type">Sum</span> <span class="hljs-variable">income</span> <span class="hljs-operator">=</span> aggregations1.get(<span class="hljs-string">&quot;income&quot;</span>);<br>            <span class="hljs-type">double</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> income.getValue();<br>            System.out.println(<span class="hljs-string">&quot;value:&quot;</span>+value);<br><br>            System.out.println(<span class="hljs-string">&quot;=================================&quot;</span>);<br><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// #需求五：计算每个季度的销售总额</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testAggsAndDateHistogram</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// GET /tvs/_search</span><br>        <span class="hljs-comment">// &#123;</span><br>        <span class="hljs-comment">//     &quot;size&quot; : 0,</span><br>        <span class="hljs-comment">//     &quot;aggs&quot;: &#123;</span><br>        <span class="hljs-comment">//     &quot;sales&quot;: &#123;</span><br>        <span class="hljs-comment">//         &quot;date_histogram&quot;: &#123;</span><br>        <span class="hljs-comment">//                      &quot;field&quot;: &quot;sold_date&quot;,</span><br>        <span class="hljs-comment">//                     &quot;interval&quot;: &quot;quarter&quot;,</span><br>        <span class="hljs-comment">//                     &quot;format&quot;: &quot;yyyy-MM-dd&quot;,</span><br>        <span class="hljs-comment">//                     &quot;min_doc_count&quot; : 0,</span><br>        <span class="hljs-comment">//                     &quot;extended_bounds&quot; : &#123;</span><br>        <span class="hljs-comment">//                         &quot;min&quot; : &quot;2019-01-01&quot;,</span><br>        <span class="hljs-comment">//                         &quot;max&quot; : &quot;2020-12-31&quot;</span><br>        <span class="hljs-comment">//             &#125;</span><br>        <span class="hljs-comment">//         &#125;,</span><br>        <span class="hljs-comment">//         &quot;aggs&quot;: &#123;</span><br>        <span class="hljs-comment">//             &quot;income&quot;: &#123;</span><br>        <span class="hljs-comment">//                 &quot;sum&quot;: &#123;</span><br>        <span class="hljs-comment">//                     &quot;field&quot;: &quot;price&quot;</span><br>        <span class="hljs-comment">//                 &#125;</span><br>        <span class="hljs-comment">//             &#125;</span><br>        <span class="hljs-comment">//         &#125;</span><br>        <span class="hljs-comment">//     &#125;</span><br>        <span class="hljs-comment">// &#125;</span><br>        <span class="hljs-comment">// &#125;</span><br><br>        <span class="hljs-comment">//1 构建请求</span><br>        SearchRequest searchRequest=<span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;tvs&quot;</span>);<br><br>        <span class="hljs-comment">//请求体</span><br>        SearchSourceBuilder searchSourceBuilder=<span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchSourceBuilder</span>();<br>        searchSourceBuilder.size(<span class="hljs-number">0</span>);<br>        searchSourceBuilder.query(QueryBuilders.matchAllQuery());<br><br>        <span class="hljs-type">DateHistogramAggregationBuilder</span> <span class="hljs-variable">dateHistogramAggregationBuilder</span> <span class="hljs-operator">=</span> AggregationBuilders.dateHistogram(<span class="hljs-string">&quot;date_histogram&quot;</span>).field(<span class="hljs-string">&quot;sold_date&quot;</span>).calendarInterval(DateHistogramInterval.QUARTER)<br>                .format(<span class="hljs-string">&quot;yyyy-MM-dd&quot;</span>).minDocCount(<span class="hljs-number">0</span>).extendedBounds(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ExtendedBounds</span>(<span class="hljs-string">&quot;2019-01-01&quot;</span>, <span class="hljs-string">&quot;2020-12-31&quot;</span>));<br>        <span class="hljs-type">SumAggregationBuilder</span> <span class="hljs-variable">sumAggregationBuilder</span> <span class="hljs-operator">=</span> AggregationBuilders.sum(<span class="hljs-string">&quot;income&quot;</span>).field(<span class="hljs-string">&quot;price&quot;</span>);<br>        dateHistogramAggregationBuilder.subAggregation(sumAggregationBuilder);<br><br>        searchSourceBuilder.aggregation(dateHistogramAggregationBuilder);<br>        <span class="hljs-comment">//请求体放入请求头</span><br>        searchRequest.source(searchSourceBuilder);<br><br>        <span class="hljs-comment">//2 执行</span><br>        <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">searchResponse</span> <span class="hljs-operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);<br><br>        <span class="hljs-comment">//3 获取结果</span><br>        <span class="hljs-comment">// &#123;</span><br>        <span class="hljs-comment">//     &quot;key_as_string&quot; : &quot;2019-01-01&quot;,</span><br>        <span class="hljs-comment">//      &quot;key&quot; : 1546300800000,</span><br>        <span class="hljs-comment">//      &quot;doc_count&quot; : 0,</span><br>        <span class="hljs-comment">//      &quot;income&quot; : &#123;</span><br>        <span class="hljs-comment">//         &quot;value&quot; : 0.0</span><br>        <span class="hljs-comment">//      &#125;</span><br>        <span class="hljs-comment">// &#125;</span><br>        <span class="hljs-type">Aggregations</span> <span class="hljs-variable">aggregations</span> <span class="hljs-operator">=</span> searchResponse.getAggregations();<br>        <span class="hljs-type">ParsedDateHistogram</span> <span class="hljs-variable">date_histogram</span> <span class="hljs-operator">=</span> aggregations.get(<span class="hljs-string">&quot;date_histogram&quot;</span>);<br>        List&amp;lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Histogram</span>.Bucket&amp;gt; buckets = date_histogram.getBuckets();<br>        <span class="hljs-keyword">for</span> (Histogram.Bucket bucket : buckets) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">keyAsString</span> <span class="hljs-operator">=</span> bucket.getKeyAsString();<br>            System.out.println(<span class="hljs-string">&quot;keyAsString:&quot;</span>+keyAsString);<br>            <span class="hljs-type">long</span> <span class="hljs-variable">docCount</span> <span class="hljs-operator">=</span> bucket.getDocCount();<br>            System.out.println(<span class="hljs-string">&quot;docCount:&quot;</span>+docCount);<br><br>            <span class="hljs-type">Aggregations</span> <span class="hljs-variable">aggregations1</span> <span class="hljs-operator">=</span> bucket.getAggregations();<br>            <span class="hljs-type">Sum</span> <span class="hljs-variable">income</span> <span class="hljs-operator">=</span> aggregations1.get(<span class="hljs-string">&quot;income&quot;</span>);<br>            <span class="hljs-type">double</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> income.getValue();<br>            System.out.println(<span class="hljs-string">&quot;value:&quot;</span>+value);<br><br>            System.out.println(<span class="hljs-string">&quot;====================&quot;</span>);<br>        &#125;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="第十九章-es7-sql新特性" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第十九章-es7-sql新特性">#</a> 第十九章 es7 sql新特性</h2><h3 id="一、快速入门" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#一、快速入门">#</a> 一、快速入门</h3><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">POST /_sql?format=txt<br>&#123;<br>    &quot;query&quot;: &quot;SELECT * FROM tvs &quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="二、启动方式" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#二、启动方式">#</a> 二、启动方式</h3><p>1、http 请求</p><p>2、客户端：elasticsearch-sql-cli.bat</p><p>3、代码</p><h3 id="三、显示方式" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#三、显示方式">#</a> 三、显示方式</h3><figure><img alt="1573212830146" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/ELK%E5%85%A5%E9%97%A8/elk%E8%BF%9B%E9%98%B6/1573212830146-cecc6733.png" tabindex="0"/><figcaption>1573212830146</figcaption></figure><h3 id="四、sql-翻译" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#四、sql-翻译">#</a> 四、sql 翻译</h3><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">POST /_sql/translate<br>&#123;<br>    &quot;query&quot;: &quot;SELECT * FROM tvs &quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>返回：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs text">&#123;<br>  &quot;size&quot; : 1000,<br>  &quot;_source&quot; : false,<br>  &quot;stored_fields&quot; : &quot;_none_&quot;,<br>  &quot;docvalue_fields&quot; : [<br>    &#123;<br>      &quot;field&quot; : &quot;brand&quot;<br>    &#125;,<br>    &#123;<br>      &quot;field&quot; : &quot;color&quot;<br>    &#125;,<br>    &#123;<br>      &quot;field&quot; : &quot;price&quot;<br>    &#125;,<br>    &#123;<br>      &quot;field&quot; : &quot;sold_date&quot;,<br>      &quot;format&quot; : &quot;epoch_millis&quot;<br>    &#125;<br>  ],<br>  &quot;sort&quot; : [<br>    &#123;<br>      &quot;_doc&quot; : &#123;<br>        &quot;order&quot; : &quot;asc&quot;<br>      &#125;<br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="五、与其他dsl结合" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#五、与其他dsl结合">#</a> 五、与其他DSL结合</h3><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs text">POST /_sql?format=txt<br>&#123;<br>    &quot;query&quot;: &quot;SELECT * FROM tvs&quot;,<br>    &quot;filter&quot;: &#123;<br>        &quot;range&quot;: &#123;<br>            &quot;price&quot;: &#123;<br>                &quot;gte&quot; : 1200,<br>                &quot;lte&quot; : 2000<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="六、-java-代码实现sql功能" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#六、-java-代码实现sql功能">#</a> 六、 java 代码实现sql功能</h3><p>1、前提 es拥有白金版功能</p><p>kibana中管理-》许可管理 开启白金版试用</p><p>2、导入依赖</p><pre><code>    &lt;dependency&gt;
        &lt;groupId&gt;org.elasticsearch.plugin&lt;/groupId&gt;
        &lt;artifactId&gt;x-pack-sql-jdbc&lt;/artifactId&gt;
        &lt;version&gt;7.3.0&lt;/version&gt;
    &lt;/dependency&gt;

<pre><code>&amp;lt;repositories&amp;gt;
    &amp;lt;repository&amp;gt;
        &amp;lt;id&amp;gt;elastic.co&amp;lt;/id&amp;gt;
        &amp;lt;url&amp;gt;https://artifacts.elastic.co/maven&amp;lt;/url&amp;gt;
    &amp;lt;/repository&amp;gt;
&amp;lt;/repositories&amp;gt;
</code></pre>
<p></code></pre><p>3、代码</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button></p>
<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs text">public static void main(String[] args) &#123;<br>        try  &#123;<br>            Connection connection = DriverManager.getConnection(&quot;jdbc:es://http://localhost:9200&quot;);<br>            Statement statement = connection.createStatement();<br>            ResultSet results = statement.executeQuery(<br>                    &quot;select * from tvs&quot;);<br>            while(results.next())&#123;<br>                System.out.println(results.getString(1));<br>                System.out.println(results.getString(2));<br>                System.out.println(results.getString(3));<br>                System.out.println(results.getString(4));<br>                System.out.println(&quot;============================&quot;);<br>            &#125;<br>        &#125;catch (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>大型企业可以购买白金版，增加Machine Learning、高级安全性x-pack。</p><h2 id="第二十章-logstash学习" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第二十章-logstash学习">#</a> 第二十章 Logstash学习</h2><h3 id="一、logstash基本语法组成" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#一、logstash基本语法组成">#</a> 一、Logstash基本语法组成</h3><figure><img alt="1573291947262" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5/ELK%E5%85%A5%E9%97%A8/elk%E8%BF%9B%E9%98%B6/1573291947262-0ca3aea7.png" tabindex="0"/><figcaption>1573291947262</figcaption></figure><h4 id="_1、什么是logstash" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、什么是logstash">#</a> 1、什么是Logstash</h4><p>logstash是一个数据抽取工具，将数据从一个地方转移到另一个地方。如hadoop生态圈的sqoop等。下载地址：<a href="https://www.elastic.co/cn/downloads/logstash" rel="noopener noreferrer" target="_blank">https://www.elastic.co/cn/downloads/logstash<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>logstash之所以功能强大和流行，还与其丰富的过滤器插件是分不开的，过滤器提供的并不单单是过滤的功能，还可以对进入过滤器的原始数据进行复杂的逻辑处理，甚至添加独特的事件到后续流程中。 Logstash配置文件有如下三部分组成，其中input、output部分是必须配置，filter部分是可选配置，而filter就是过滤器插件，可以在这部分实现各种日志过滤功能。</p><h4 id="_2、配置文件" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、配置文件">#</a> 2、配置文件：</h4><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs text">input &#123;<br>    #输入插件<br>&#125;<br>filter &#123;<br>    #过滤匹配插件<br>&#125;<br>output &#123;<br>    #输出插件<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3、启动操作" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、启动操作">#</a> 3、启动操作：</h4><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">logstash.bat -e &#x27;input&#123;stdin&#123;&#125;&#125; output&#123;stdout&#123;&#125;&#125;&#x27;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>为了好维护，将配置写入文件，启动</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">logstash.bat -f ../config/test1.conf<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><h3 id="二、logstash输入插件-input" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#二、logstash输入插件-input">#</a> 二、Logstash输入插件（input）</h3><p><a href="https://www.elastic.co/guide/en/logstash/current/input-plugins.html" rel="noopener noreferrer" target="_blank">https://www.elastic.co/guide/en/logstash/current/input-plugins.html<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h4 id="_1、标准输入-stdin" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、标准输入-stdin">#</a> 1、标准输入(Stdin)</h4><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs text">input&#123;<br>    stdin&#123;<br><br>    &#125;<br>&#125;<br>output &#123;<br>    stdout&#123;<br>        codec=&amp;gt;rubydebug    <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2、读取文件-file" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、读取文件-file">#</a> 2、读取文件(File)</h4><p>logstash使用一个名为filewatch的ruby gem库来监听文件变化,并通过一个叫.sincedb的数据库文件来记录被监听的日志文件的读取进度（时间戳），这个sincedb数据文件的默认路径在 &lt;path.data&gt;/plugins/inputs/file下面，文件名类似于.sincedb_123456，而&lt;path.data&gt;表示logstash插件存储目录，默认是LOGSTASH_HOME/data。</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs text">input &#123;<br>    file &#123;<br>        path =&amp;gt; [&quot;/var/*/*&quot;]<br>        start_position =&amp;gt; &quot;beginning&quot;<br>    &#125;<br>&#125;<br>output &#123;<br>    stdout&#123;<br>        codec=&amp;gt;rubydebug    <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>默认情况下，logstash会从文件的结束位置开始读取数据，也就是说logstash进程会以类似tail -f命令的形式逐行获取数据。</p><h4 id="_3、读取tcp网络数据" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、读取tcp网络数据">#</a> 3、读取TCP网络数据</h4><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs text">input &#123;<br>  tcp &#123;<br>    port =&amp;gt; &quot;1234&quot;<br>  &#125;<br>&#125;<br><br>filter &#123;<br>  grok &#123;<br>    match =&amp;gt; &#123; &quot;message&quot; =&amp;gt; &quot;%&#123;SYSLOGLINE&#125;&quot; &#125;<br>  &#125;<br>&#125;<br><br>output &#123;<br>    stdout&#123;<br>        codec=&amp;gt;rubydebug<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="三、logstash过滤器插件-filter" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#三、logstash过滤器插件-filter">#</a> 三、Logstash过滤器插件(Filter)</h3><p><a href="https://www.elastic.co/guide/en/logstash/current/filter-plugins.html" rel="noopener noreferrer" target="_blank">https://www.elastic.co/guide/en/logstash/current/filter-plugins.html<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h4 id="_1、grok-正则捕获" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、grok-正则捕获">#</a> 1、Grok 正则捕获</h4><p>grok是一个十分强大的logstash filter插件，他可以通过正则解析任意文本，将非结构化日志数据弄成结构化和方便查询的结构。他是目前logstash 中解析非结构化日志数据最好的方式。</p><p>Grok 的语法规则是：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">%&#123;语法: 语义&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>例如输入的内容为：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">172.16.213.132 [07/Feb/2019:16:24:19 +0800] &quot;GET / HTTP/1.1&quot; 403 5039<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>%{IP:clientip}匹配模式将获得的结果为：clientip: 172.16.213.132 %{HTTPDATE:timestamp}匹配模式将获得的结果为：timestamp: 07/Feb/2018:16:24:19 +0800 而%{QS:referrer}匹配模式将获得的结果为：referrer: "GET / HTTP/1.1"</p><p>下面是一个组合匹配模式，它可以获取上面输入的所有内容：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">%&#123;IP:clientip&#125;\ \[%&#123;HTTPDATE:timestamp&#125;\]\ %&#123;QS:referrer&#125;\ %&#123;NUMBER:response&#125;\ %&#123;NUMBER:bytes&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>通过上面这个组合匹配模式，我们将输入的内容分成了五个部分，即五个字段，将输入内容分割为不同的数据字段，这对于日后解析和查询日志数据非常有用，这正是使用grok的目的。</p><p>例子：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs text">input&#123;<br>    stdin&#123;&#125;<br>&#125;<br>filter&#123;<br>    grok&#123;<br>        match =&amp;gt; [&quot;message&quot;,&quot;%&#123;IP:clientip&#125;\ \[%&#123;HTTPDATE:timestamp&#125;\]\ %&#123;QS:referrer&#125;\ %&#123;NUMBER:response&#125;\ %&#123;NUMBER:bytes&#125;&quot;]<br>    &#125;<br>&#125;<br>output&#123;<br>    stdout&#123;<br>        codec =&amp;gt; &quot;rubydebug&quot;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输入内容：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">172.16.213.132 [07/Feb/2019:16:24:19 +0800] &quot;GET / HTTP/1.1&quot; 403 5039<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><h4 id="_2、时间处理-date" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、时间处理-date">#</a> 2、时间处理(Date)</h4><p>date插件是对于排序事件和回填旧数据尤其重要，它可以用来转换日志记录中的时间字段，变成LogStash::Timestamp对象，然后转存到@timestamp字段里，这在之前已经做过简单的介绍。 下面是date插件的一个配置示例（这里仅仅列出filter部分）：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">filter &#123;<br>    grok &#123;<br>        match =&amp;gt; [&quot;message&quot;, &quot;%&#123;HTTPDATE:timestamp&#125;&quot;]<br>    &#125;<br>    date &#123;<br>        match =&amp;gt; [&quot;timestamp&quot;, &quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3、数据修改-mutate" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、数据修改-mutate">#</a> 3、数据修改(Mutate)</h4><h5 id="_1-正则表达式替换匹配字段" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-正则表达式替换匹配字段">#</a> （1）正则表达式替换匹配字段</h5><p>gsub可以通过正则表达式替换字段中匹配到的值，只对字符串字段有效，下面是一个关于mutate插件中gsub的示例（仅列出filter部分）：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">filter &#123;<br>    mutate &#123;<br>        gsub =&amp;gt; [&quot;filed_name_1&quot;, &quot;/&quot; , &quot;_&quot;]<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个示例表示将filed_name_1字段中所有"/"字符替换为"_"。</p><h5 id="_2-分隔符分割字符串为数组" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-分隔符分割字符串为数组">#</a> （2）分隔符分割字符串为数组</h5><p>split可以通过指定的分隔符分割字段中的字符串为数组，下面是一个关于mutate插件中split的示例（仅列出filter部分）：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">filter &#123;<br>    mutate &#123;<br>        split =&amp;gt; [&quot;filed_name_2&quot;, &quot;|&quot;]<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个示例表示将filed_name_2字段以"|"为区间分隔为数组。</p><h5 id="_3-重命名字段" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-重命名字段">#</a> （3）重命名字段</h5><p>rename可以实现重命名某个字段的功能，下面是一个关于mutate插件中rename的示例（仅列出filter部分）：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">filter &#123;<br>    mutate &#123;<br>        rename =&amp;gt; &#123; &quot;old_field&quot; =&amp;gt; &quot;new_field&quot; &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个示例表示将字段old_field重命名为new_field。</p><h5 id="_4-删除字段" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4-删除字段">#</a> （4）删除字段</h5><p>remove_field可以实现删除某个字段的功能，下面是一个关于mutate插件中remove_field的示例（仅列出filter部分）：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">filter &#123;<br>    mutate &#123;<br>        remove_field  =&amp;gt;  [&quot;timestamp&quot;]<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个示例表示将字段timestamp删除。</p><h5 id="_5-geoip-地址查询归类" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_5-geoip-地址查询归类">#</a> （5）GeoIP 地址查询归类</h5><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">filter &#123;<br>    geoip &#123;<br>        source =&amp;gt; &quot;ip_field&quot;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="综合例子" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#综合例子">#</a> 综合例子：</h5><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs text">input &#123;<br>    stdin &#123;&#125;<br>&#125;<br>filter &#123;<br>    grok &#123;<br>        match =&amp;gt; &#123; &quot;message&quot; =&amp;gt; &quot;%&#123;IP:clientip&#125;\ \[%&#123;HTTPDATE:timestamp&#125;\]\ %&#123;QS:referrer&#125;\ %&#123;NUMBER:response&#125;\ %&#123;NUMBER:bytes&#125;&quot; &#125;<br>        remove_field =&amp;gt; [ &quot;message&quot; ]<br>   &#125;<br>date &#123;<br>        match =&amp;gt; [&quot;timestamp&quot;, &quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]<br>    &#125;<br>mutate &#123;<br>          convert =&amp;gt; [ &quot;response&quot;,&quot;float&quot; ]<br>           rename =&amp;gt; &#123; &quot;response&quot; =&amp;gt; &quot;response_new&quot; &#125;   <br>           gsub =&amp;gt; [&quot;referrer&quot;,&quot;\&quot;&quot;,&quot;&quot;]          <br>           split =&amp;gt; [&quot;clientip&quot;, &quot;.&quot;]<br>        &#125;<br>&#125;<br>output &#123;<br>    stdout &#123;<br>        codec =&amp;gt; &quot;rubydebug&quot;<br>    &#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="四、logstash输出插件-output" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#四、logstash输出插件-output">#</a> 四、Logstash输出插件（output）</h3><p><a href="https://www.elastic.co/guide/en/logstash/current/output-plugins.html" rel="noopener noreferrer" target="_blank">https://www.elastic.co/guide/en/logstash/current/output-plugins.html<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>output是Logstash的最后阶段，一个事件可以经过多个输出，而一旦所有输出处理完成，整个事件就执行完成。 一些常用的输出包括：</p><ul><li>file： 表示将日志数据写入磁盘上的文件。</li><li>elasticsearch：表示将日志数据发送给Elasticsearch。Elasticsearch可以高效方便和易于查询的保存数据。</li></ul><p>1、输出到标准输出(stdout)</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">output &#123;<br>    stdout &#123;<br>        codec =&amp;gt; rubydebug<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、保存为文件（file）</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">output &#123;<br>    file &#123;<br>        path =&amp;gt; &quot;/data/log/%&#123;+yyyy-MM-dd&#125;/%&#123;host&#125;_%&#123;+HH&#125;.log&quot;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3、输出到elasticsearch</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs text">output &#123;<br>    elasticsearch &#123;<br>        host =&amp;gt; [&quot;192.168.1.1:9200&quot;,&quot;172.16.213.77:9200&quot;]<br>        index =&amp;gt; &quot;logstash-%&#123;+YYYY.MM.dd&#125;&quot;       <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>host：是一个数组类型的值，后面跟的值是elasticsearch节点的地址与端口，默认端口是9200。可添加多个地址。</li><li>index：写入elasticsearch的索引的名称，这里可以使用变量。Logstash提供了%{+YYYY.MM.dd}这种写法。在语法解析的时候，看到以+ 号开头的，就会自动认为后面是时间格式，尝试用时间格式来解析后续字符串。这种以天为单位分割的写法，可以很容易的删除老的数据或者搜索指定时间范围内的数据。此外，注意索引名中不能有大写字母。</li><li>manage_template:用来设置是否开启logstash自动管理模板功能，如果设置为false将关闭自动管理模板功能。如果我们自定义了模板，那么应该设置为false。</li><li>template_name:这个配置项用来设置在Elasticsearch中模板的名称。</li></ul><h3 id="五、综合案例" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#五、综合案例">#</a> 五、综合案例</h3><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs text">input &#123;<br>    file &#123;<br>        path =&amp;gt; [&quot;D:/ES/logstash-7.3.0/nginx.log&quot;]        <br>        start_position =&amp;gt; &quot;beginning&quot;<br>    &#125;<br>&#125;<br><br>filter &#123;<br>    grok &#123;<br>        match =&amp;gt; &#123; &quot;message&quot; =&amp;gt; &quot;%&#123;IP:clientip&#125;\ \[%&#123;HTTPDATE:timestamp&#125;\]\ %&#123;QS:referrer&#125;\ %&#123;NUMBER:response&#125;\ %&#123;NUMBER:bytes&#125;&quot; &#125;<br>        remove_field =&amp;gt; [ &quot;message&quot; ]<br>   &#125;<br>    date &#123;<br>        match =&amp;gt; [&quot;timestamp&quot;, &quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]<br>    &#125;<br>    mutate &#123;<br>           rename =&amp;gt; &#123; &quot;response&quot; =&amp;gt; &quot;response_new&quot; &#125;<br>           convert =&amp;gt; [ &quot;response&quot;,&quot;float&quot; ]<br>           gsub =&amp;gt; [&quot;referrer&quot;,&quot;\&quot;&quot;,&quot;&quot;]<br>           remove_field =&amp;gt; [&quot;timestamp&quot;]<br>           split =&amp;gt; [&quot;clientip&quot;, &quot;.&quot;]<br>        &#125;<br>&#125;<br><br>output &#123;<br>    stdout &#123;<br>        codec =&amp;gt; &quot;rubydebug&quot;<br>    &#125;<br><br>elasticsearch &#123;<br>    host =&amp;gt; [&quot;localhost:9200&quot;]<br>    index =&amp;gt; &quot;logstash-%&#123;+YYYY.MM.dd&#125;&quot;       <br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="第二十一章-kibana学习" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第二十一章-kibana学习">#</a> 第二十一章 kibana学习</h2><h3 id="一、基本查询" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#一、基本查询">#</a> 一、基本查询</h3><p>1、是什么：elk中数据展现工具。</p><p>2、下载：<a href="https://www.elastic.co/cn/downloads/kibana" rel="noopener noreferrer" target="_blank">https://www.elastic.co/cn/downloads/kibana<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>3、使用：建立索引模式，index partten</p><p>discover 中使用DSL搜索。</p><h3 id="二、可视化" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#二、可视化">#</a> 二、可视化</h3><p>绘制图形</p><h3 id="三、仪表盘" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#三、仪表盘">#</a> 三、仪表盘</h3><p>将各种可视化图形放入，形成大屏幕。</p><h3 id="四、使用模板数据指导绘图" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#四、使用模板数据指导绘图">#</a> 四、使用模板数据指导绘图</h3><p>点击主页的添加模板数据，可以看到很多模板数据以及绘图。</p><h3 id="五、其他功能" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#五、其他功能">#</a> 五、其他功能</h3><p>监控，日志，APM等功能非常丰富。</p><h2 id="第二十二章-集群部署" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第二十二章-集群部署">#</a> 第二十二章 集群部署</h2><p>见部署图</p><h3 id="结点的三个角色" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#结点的三个角色">#</a> 结点的三个角色</h3><p>主结点：master节点主要用于集群的管理及索引 比如新增结点、分片分配、索引的新增和删除等。 数据结点：data 节点上保存了数据分片，它负责索引和搜索操作。 客户端结点：client 节点仅作为请求客户端存在，client的作用也作为负载均衡器，client 节点不存数据，只是将请求均衡转发到其它结点。</p><p>通过下边两项参数来配置结点的功能：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">node.master: #是否允许为主结点<br>node.data: #允许存储数据作为数据结点<br>node.ingest: #是否允许成为协调节点<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>四种组合方式：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">master=true，data=true：即是主结点又是数据结点<br>master=false，data=true：仅是数据结点<br>master=true，data=false：仅是主结点，不存储数据<br>master=false，data=false：即不是主结点也不是数据结点，此时可设置ingest为true表示它是一个客户端。<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="第二十三章-项目实战" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第二十三章-项目实战">#</a> 第二十三章 项目实战</h2><h3 id="一、项目一-elk用于日志分析" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#一、项目一-elk用于日志分析">#</a> 一、项目一：ELK用于日志分析</h3><p>需求：集中收集分布式服务的日志</p><p>1逻辑模块程序随时输出日志</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ydlclass.es;<br><br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;<br><br><span class="hljs-keyword">import</span> java.util.Random;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * creste by ydlclass.ydl</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestLog</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger LOGGER= LoggerFactory.getLogger(TestLog.class);<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testLog</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span><span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();<br><br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>            <span class="hljs-type">int</span> userid=random.nextInt(<span class="hljs-number">10</span>);<br>            LOGGER.info(<span class="hljs-string">&quot;userId:&#123;&#125;,send:&#123;&#125;&quot;</span>,userid,<span class="hljs-string">&quot;hello world.I am &quot;</span>+userid);<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">500</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2logstash收集日志到es</p><p><strong>grok 内置类型</strong></p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs text">USERNAME [a-zA-Z0-9._-]+<br>USER %&#123;USERNAME&#125;<br>INT (?:[+-]?(?:[0-9]+))<br>BASE10NUM (?&amp;lt;![0-9.+-])(?&amp;gt;[+-]?(?:(?:[0-9]+(?:\.[0-9]+)?)|(?:\.[0-9]+)))<br>NUMBER (?:%&#123;BASE10NUM&#125;)<br>BASE16NUM (?&amp;lt;![0-9A-Fa-f])(?:[+-]?(?:0x)?(?:[0-9A-Fa-f]+))<br>BASE16FLOAT \b(?&amp;lt;![0-9A-Fa-f.])(?:[+-]?(?:0x)?(?:(?:[0-9A-Fa-f]+(?:\.[0-9A-Fa-f]*)?)|(?:\.[0-9A-Fa-f]+)))\b<br><br>POSINT \b(?:[1-9][0-9]*)\b<br>NONNEGINT \b(?:[0-9]+)\b<br>WORD \b\w+\b<br>NOTSPACE \S+<br>SPACE \s*<br>DATA .*?<br>GREEDYDATA .*<br>QUOTEDSTRING (?&amp;gt;(?&amp;lt;!\\)(?&amp;gt;&quot;(?&amp;gt;\\.|[^\\&quot;]+)+&quot;|&quot;&quot;|(?&amp;gt;&#x27;(?&amp;gt;\\.|[^\\&#x27;]+)+&#x27;)|&#x27;&#x27;|(?&amp;gt;`(?&amp;gt;\\.|[^\\`]+)+`)|``))<br>UUID [A-Fa-f0-9]&#123;8&#125;-(?:[A-Fa-f0-9]&#123;4&#125;-)&#123;3&#125;[A-Fa-f0-9]&#123;12&#125;<br><br># Networking<br>MAC (?:%&#123;CISCOMAC&#125;|%&#123;WINDOWSMAC&#125;|%&#123;COMMONMAC&#125;)<br>CISCOMAC (?:(?:[A-Fa-f0-9]&#123;4&#125;\.)&#123;2&#125;[A-Fa-f0-9]&#123;4&#125;)<br>WINDOWSMAC (?:(?:[A-Fa-f0-9]&#123;2&#125;-)&#123;5&#125;[A-Fa-f0-9]&#123;2&#125;)<br>COMMONMAC (?:(?:[A-Fa-f0-9]&#123;2&#125;:)&#123;5&#125;[A-Fa-f0-9]&#123;2&#125;)<br>IPV6 ((([0-9A-Fa-f]&#123;1,4&#125;:)&#123;7&#125;([0-9A-Fa-f]&#123;1,4&#125;|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;6&#125;(:[0-9A-Fa-f]&#123;1,4&#125;|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;)|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;5&#125;(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,2&#125;)|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;)|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;4&#125;(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,3&#125;)|((:[0-9A-Fa-f]&#123;1,4&#125;)?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;))|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;3&#125;(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,4&#125;)|((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;0,2&#125;:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;))|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;2&#125;(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,5&#125;)|((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;0,3&#125;:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;))|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;1&#125;(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,6&#125;)|((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;0,4&#125;:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;))|:))|(:(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,7&#125;)|((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;0,5&#125;:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;))|:)))(%.+)?<br>IPV4 (?&amp;lt;![0-9])(?:(?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]&#123;1,2&#125;)[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]&#123;1,2&#125;)[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]&#123;1,2&#125;)[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]&#123;1,2&#125;))(?![0-9])<br>IP (?:%&#123;IPV6&#125;|%&#123;IPV4&#125;)<br>HOSTNAME \b(?:[0-9A-Za-z][0-9A-Za-z-]&#123;0,62&#125;)(?:\.(?:[0-9A-Za-z][0-9A-Za-z-]&#123;0,62&#125;))*(\.?|\b)<br>HOST %&#123;HOSTNAME&#125;<br>IPORHOST (?:%&#123;HOSTNAME&#125;|%&#123;IP&#125;)<br>HOSTPORT %&#123;IPORHOST&#125;:%&#123;POSINT&#125;<br><br># paths<br>PATH (?:%&#123;UNIXPATH&#125;|%&#123;WINPATH&#125;)<br>UNIXPATH (?&amp;gt;/(?&amp;gt;[\w_%!$@:.,-]+|\\.)*)+<br>TTY (?:/dev/(pts|tty([pq])?)(\w+)?/?(?:[0-9]+))<br>WINPATH (?&amp;gt;[A-Za-z]+:|\\)(?:\\[^\\?*]*)+<br>URIPROTO [A-Za-z]+(\+[A-Za-z+]+)?<br>URIHOST %&#123;IPORHOST&#125;(?::%&#123;POSINT:port&#125;)?<br># uripath comes loosely from RFC1738, but mostly from what Firefox<br># doesn&#x27;t turn into %XX<br>URIPATH (?:/[A-Za-z0-9$.+!*&#x27;()&#123;&#125;,~:;=@#%_\-]*)+<br>#URIPARAM \?(?:[A-Za-z0-9]+(?:=(?:[^&amp;amp;]*))?(?:&amp;amp;(?:[A-Za-z0-9]+(?:=(?:[^&amp;amp;]*))?)?)*)?<br>URIPARAM \?[A-Za-z0-9$.+!*&#x27;|()&#123;&#125;,~@#%&amp;amp;/=:;_?\-\[\]]*<br>URIPATHPARAM %&#123;URIPATH&#125;(?:%&#123;URIPARAM&#125;)?<br>URI %&#123;URIPROTO&#125;://(?:%&#123;USER&#125;(?::[^@]*)?@)?(?:%&#123;URIHOST&#125;)?(?:%&#123;URIPATHPARAM&#125;)?<br><br># Months: January, Feb, 3, 03, 12, December<br>MONTH \b(?:Jan(?:uary)?|Feb(?:ruary)?|Mar(?:ch)?|Apr(?:il)?|May|Jun(?:e)?|Jul(?:y)?|Aug(?:ust)?|Sep(?:tember)?|Oct(?:ober)?|Nov(?:ember)?|Dec(?:ember)?)\b<br>MONTHNUM (?:0?[1-9]|1[0-2])<br>MONTHNUM2 (?:0[1-9]|1[0-2])<br>MONTHDAY (?:(?:0[1-9])|(?:[12][0-9])|(?:3[01])|[1-9])<br><br># Days: Monday, Tue, Thu, etc...<br>DAY (?:Mon(?:day)?|Tue(?:sday)?|Wed(?:nesday)?|Thu(?:rsday)?|Fri(?:day)?|Sat(?:urday)?|Sun(?:day)?)<br><br># Years?<br>YEAR (?&amp;gt;\d\d)&#123;1,2&#125;<br>HOUR (?:2[0123]|[01]?[0-9])<br>MINUTE (?:[0-5][0-9])<br># &#x27;60&#x27; is a leap second in most time standards and thus is valid.<br>SECOND (?:(?:[0-5]?[0-9]|60)(?:[:.,][0-9]+)?)<br>TIME (?!&amp;lt;[0-9])%&#123;HOUR&#125;:%&#123;MINUTE&#125;(?::%&#123;SECOND&#125;)(?![0-9])<br># datestamp is YYYY/MM/DD-HH:MM:SS.UUUU (or something like it)<br>DATE_US %&#123;MONTHNUM&#125;[/-]%&#123;MONTHDAY&#125;[/-]%&#123;YEAR&#125;<br>DATE_EU %&#123;MONTHDAY&#125;[./-]%&#123;MONTHNUM&#125;[./-]%&#123;YEAR&#125;<br>ISO8601_TIMEZONE (?:Z|[+-]%&#123;HOUR&#125;(?::?%&#123;MINUTE&#125;))<br>ISO8601_SECOND (?:%&#123;SECOND&#125;|60)<br>TIMESTAMP_ISO8601 %&#123;YEAR&#125;-%&#123;MONTHNUM&#125;-%&#123;MONTHDAY&#125;[T ]%&#123;HOUR&#125;:?%&#123;MINUTE&#125;(?::?%&#123;SECOND&#125;)?%&#123;ISO8601_TIMEZONE&#125;?<br>DATE %&#123;DATE_US&#125;|%&#123;DATE_EU&#125;<br>DATESTAMP %&#123;DATE&#125;[- ]%&#123;TIME&#125;<br>TZ (?:[PMCE][SD]T|UTC)<br>DATESTAMP_RFC822 %&#123;DAY&#125; %&#123;MONTH&#125; %&#123;MONTHDAY&#125; %&#123;YEAR&#125; %&#123;TIME&#125; %&#123;TZ&#125;<br>DATESTAMP_RFC2822 %&#123;DAY&#125;, %&#123;MONTHDAY&#125; %&#123;MONTH&#125; %&#123;YEAR&#125; %&#123;TIME&#125; %&#123;ISO8601_TIMEZONE&#125;<br>DATESTAMP_OTHER %&#123;DAY&#125; %&#123;MONTH&#125; %&#123;MONTHDAY&#125; %&#123;TIME&#125; %&#123;TZ&#125; %&#123;YEAR&#125;<br>DATESTAMP_EVENTLOG %&#123;YEAR&#125;%&#123;MONTHNUM2&#125;%&#123;MONTHDAY&#125;%&#123;HOUR&#125;%&#123;MINUTE&#125;%&#123;SECOND&#125;<br><br># Syslog Dates: Month Day HH:MM:SS<br>SYSLOGTIMESTAMP %&#123;MONTH&#125; +%&#123;MONTHDAY&#125; %&#123;TIME&#125;<br>PROG (?:[\w._/%-]+)<br>SYSLOGPROG %&#123;PROG:program&#125;(?:\[%&#123;POSINT:pid&#125;\])?<br>SYSLOGHOST %&#123;IPORHOST&#125;<br>SYSLOGFACILITY &amp;lt;%&#123;NONNEGINT:facility&#125;.%&#123;NONNEGINT:priority&#125;&amp;gt;<br>HTTPDATE %&#123;MONTHDAY&#125;/%&#123;MONTH&#125;/%&#123;YEAR&#125;:%&#123;TIME&#125; %&#123;INT&#125;<br><br># Shortcuts<br>QS %&#123;QUOTEDSTRING&#125;<br><br># Log formats<br>SYSLOGBASE %&#123;SYSLOGTIMESTAMP:timestamp&#125; (?:%&#123;SYSLOGFACILITY&#125; )?%&#123;SYSLOGHOST:logsource&#125; %&#123;SYSLOGPROG&#125;:<br>COMMONAPACHELOG %&#123;IPORHOST:clientip&#125; %&#123;USER:ident&#125; %&#123;USER:auth&#125; \[%&#123;HTTPDATE:timestamp&#125;\] &quot;(?:%&#123;WORD:verb&#125; %&#123;NOTSPACE:request&#125;(?: HTTP/%&#123;NUMBER:httpversion&#125;)?|%&#123;DATA:rawrequest&#125;)&quot; %&#123;NUMBER:response&#125; (?:%&#123;NUMBER:bytes&#125;|-)<br>COMBINEDAPACHELOG %&#123;COMMONAPACHELOG&#125; %&#123;QS:referrer&#125; %&#123;QS:agent&#125;<br><br># Log Levels<br>LOGLEVEL ([Aa]lert|ALERT|[Tt]race|TRACE|[Dd]ebug|DEBUG|[Nn]otice|NOTICE|[Ii]nfo|INFO|[Ww]arn?(?:ing)?|WARN?(?:ING)?|[Ee]rr?(?:or)?|ERR?(?:OR)?|[Cc]rit?(?:ical)?|CRIT?(?:ICAL)?|[Ff]atal|FATAL|[Ss]evere|SEVERE|EMERG(?:ENCY)?|[Ee]merg(?:ency)?)<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>写logstash配置文件。</p><p>3kibana展现数据</p><h3 id="二、项目二-学成在线站内搜索模块" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#二、项目二-学成在线站内搜索模块">#</a> 二、项目二：学成在线站内搜索模块</h3><h4 id="_1、mysql导入course-pub表" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、mysql导入course-pub表">#</a> 1、mysql导入course_pub表</h4><h4 id="_2、创建索引xc-course" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、创建索引xc-course">#</a> 2、创建索引xc_course</h4><h4 id="_3、创建映射" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、创建映射">#</a> 3、创建映射</h4><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs text">PUT /xc_course<br>&#123;<br>  &quot;settings&quot;: &#123;<br>    &quot;number_of_shards&quot;: 1,<br>    &quot;number_of_replicas&quot;: 0<br>  &#125;,<br>  &quot;mappings&quot;: &#123;<br>    &quot;properties&quot;: &#123;<br>      &quot;description&quot; : &#123;<br>                &quot;analyzer&quot; : &quot;ik_max_word&quot;,<br>                &quot;search_analyzer&quot;: &quot;ik_smart&quot;,<br>               &quot;type&quot; : &quot;text&quot;<br>            &#125;,<br>            &quot;grade&quot; : &#123;<br>               &quot;type&quot; : &quot;keyword&quot;<br>            &#125;,<br>            &quot;id&quot; : &#123;<br>               &quot;type&quot; : &quot;keyword&quot;<br>            &#125;,<br>            &quot;mt&quot; : &#123;<br>               &quot;type&quot; : &quot;keyword&quot;<br>            &#125;,<br>            &quot;name&quot; : &#123;<br>                &quot;analyzer&quot; : &quot;ik_max_word&quot;,<br>           &quot;search_analyzer&quot;: &quot;ik_smart&quot;,<br>               &quot;type&quot; : &quot;text&quot;<br>            &#125;,<br>            &quot;users&quot; : &#123;<br>               &quot;index&quot; : false,<br>               &quot;type&quot; : &quot;text&quot;<br>            &#125;,<br>            &quot;charge&quot; : &#123;<br>               &quot;type&quot; : &quot;keyword&quot;<br>            &#125;,<br>            &quot;valid&quot; : &#123;<br>               &quot;type&quot; : &quot;keyword&quot;<br>            &#125;,<br>            &quot;pic&quot; : &#123;<br>               &quot;index&quot; : false,<br>               &quot;type&quot; : &quot;keyword&quot;<br>            &#125;,<br>            &quot;qq&quot; : &#123;<br>               &quot;index&quot; : false,<br>               &quot;type&quot; : &quot;keyword&quot;<br>            &#125;,<br>            &quot;price&quot; : &#123;<br>               &quot;type&quot; : &quot;float&quot;<br>            &#125;,<br>            &quot;price_old&quot; : &#123;<br>               &quot;type&quot; : &quot;float&quot;<br>            &#125;,<br>            &quot;st&quot; : &#123;<br>               &quot;type&quot; : &quot;keyword&quot;<br>            &#125;,<br>            &quot;status&quot; : &#123;<br>               &quot;type&quot; : &quot;keyword&quot;<br>            &#125;,<br>            &quot;studymodel&quot; : &#123;<br>               &quot;type&quot; : &quot;keyword&quot;<br>            &#125;,<br>            &quot;teachmode&quot; : &#123;<br>               &quot;type&quot; : &quot;keyword&quot;<br>            &#125;,<br>            &quot;teachplan&quot; : &#123;<br>                &quot;analyzer&quot; : &quot;ik_max_word&quot;,<br>           &quot;search_analyzer&quot;: &quot;ik_smart&quot;,<br>               &quot;type&quot; : &quot;text&quot;<br>            &#125;,<br>           &quot;expires&quot; : &#123;<br>               &quot;type&quot; : &quot;date&quot;,<br>            &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;<br>            &#125;,<br>            &quot;pub_time&quot; : &#123;<br>               &quot;type&quot; : &quot;date&quot;,<br>             &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;<br>            &#125;,<br>            &quot;start_time&quot; : &#123;<br>               &quot;type&quot; : &quot;date&quot;,<br>           &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;<br>            &#125;,<br>          &quot;end_time&quot; : &#123;<br>                 &quot;type&quot; : &quot;date&quot;,<br>           &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;<br>            &#125;<br>    &#125;<br>  &#125; <br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4、logstash创建模板文件" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4、logstash创建模板文件">#</a> 4、logstash创建模板文件</h4><p>Logstash的工作是从MySQL中读取数据，向ES中创建索引，这里需要提前创建mapping的模板文件以便logstash使用。</p><p>在logstach的config目录创建xc_course_template.json，内容如下：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs text">&#123;<br>   &quot;mappings&quot; : &#123;<br>      &quot;doc&quot; : &#123;<br>         &quot;properties&quot; : &#123;<br>            &quot;charge&quot; : &#123;<br>               &quot;type&quot; : &quot;keyword&quot;<br>            &#125;,<br>            &quot;description&quot; : &#123;<br>               &quot;analyzer&quot; : &quot;ik_max_word&quot;,<br>               &quot;search_analyzer&quot; : &quot;ik_smart&quot;,<br>               &quot;type&quot; : &quot;text&quot;<br>            &#125;,<br>            &quot;end_time&quot; : &#123;<br>               &quot;format&quot; : &quot;yyyy-MM-dd HH:mm:ss&quot;,<br>               &quot;type&quot; : &quot;date&quot;<br>            &#125;,<br>            &quot;expires&quot; : &#123;<br>               &quot;format&quot; : &quot;yyyy-MM-dd HH:mm:ss&quot;,<br>               &quot;type&quot; : &quot;date&quot;<br>            &#125;,<br>            &quot;grade&quot; : &#123;<br>               &quot;type&quot; : &quot;keyword&quot;<br>            &#125;,<br>            &quot;id&quot; : &#123;<br>               &quot;type&quot; : &quot;keyword&quot;<br>            &#125;,<br>            &quot;mt&quot; : &#123;<br>               &quot;type&quot; : &quot;keyword&quot;<br>            &#125;,<br>            &quot;name&quot; : &#123;<br>               &quot;analyzer&quot; : &quot;ik_max_word&quot;,<br>               &quot;search_analyzer&quot; : &quot;ik_smart&quot;,<br>               &quot;type&quot; : &quot;text&quot;<br>            &#125;,<br>            &quot;pic&quot; : &#123;<br>               &quot;index&quot; : false,<br>               &quot;type&quot; : &quot;keyword&quot;<br>            &#125;,<br>            &quot;price&quot; : &#123;<br>               &quot;type&quot; : &quot;float&quot;<br>            &#125;,<br>            &quot;price_old&quot; : &#123;<br>               &quot;type&quot; : &quot;float&quot;<br>            &#125;,<br>            &quot;pub_time&quot; : &#123;<br>               &quot;format&quot; : &quot;yyyy-MM-dd HH:mm:ss&quot;,<br>               &quot;type&quot; : &quot;date&quot;<br>            &#125;,<br>            &quot;qq&quot; : &#123;<br>               &quot;index&quot; : false,<br>               &quot;type&quot; : &quot;keyword&quot;<br>            &#125;,<br>            &quot;st&quot; : &#123;<br>               &quot;type&quot; : &quot;keyword&quot;<br>            &#125;,<br>            &quot;start_time&quot; : &#123;<br>               &quot;format&quot; : &quot;yyyy-MM-dd HH:mm:ss&quot;,<br>               &quot;type&quot; : &quot;date&quot;<br>            &#125;,<br>            &quot;status&quot; : &#123;<br>               &quot;type&quot; : &quot;keyword&quot;<br>            &#125;,<br>            &quot;studymodel&quot; : &#123;<br>               &quot;type&quot; : &quot;keyword&quot;<br>            &#125;,<br>            &quot;teachmode&quot; : &#123;<br>               &quot;type&quot; : &quot;keyword&quot;<br>            &#125;,<br>            &quot;teachplan&quot; : &#123;<br>               &quot;analyzer&quot; : &quot;ik_max_word&quot;,<br>               &quot;search_analyzer&quot; : &quot;ik_smart&quot;,<br>               &quot;type&quot; : &quot;text&quot;<br>            &#125;,<br>            &quot;users&quot; : &#123;<br>               &quot;index&quot; : false,<br>               &quot;type&quot; : &quot;text&quot;<br>            &#125;,<br>            &quot;valid&quot; : &#123;<br>               &quot;type&quot; : &quot;keyword&quot;<br>            &#125;<br>         &#125;<br>      &#125;<br>   &#125;,<br>   &quot;template&quot; : &quot;xc_course&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5、logstash配置mysql-conf" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_5、logstash配置mysql-conf">#</a> 5、logstash配置mysql.conf</h4><p>1、ES采用UTC时区问题</p><p>ES采用UTC 时区，比北京时间早8小时，所以ES读取数据时让最后更新时间加8小时</p><p>where timestamp &gt; date_add(:sql_last_value,INTERVAL 8 HOUR)</p><p>2、logstash每个执行完成会在/config/logstash_metadata记录执行时间下次以此时间为基准进行增量同步数据到索引库。</p><h4 id="_6、启动" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_6、启动">#</a> 6、启动</h4><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">.\logstash.bat -f ..\config\mysql.conf<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><h4 id="_7、后端代码" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_7、后端代码">#</a> 7、后端代码</h4><p>（1）Controller</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/search/course&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EsCourseController</span>  &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    EsCourseService esCourseService;<br><br>    <span class="hljs-meta">@GetMapping(value=&quot;/list/&#123;page&#125;/&#123;size&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> QueryResponseResult&amp;lt;CoursePub&amp;gt; list(<span class="hljs-meta">@PathVariable(&quot;page&quot;)</span> <span class="hljs-type">int</span> page, <span class="hljs-meta">@PathVariable(&quot;size&quot;)</span> <span class="hljs-type">int</span> size, CourseSearchParam courseSearchParam) &#123;<br>        <span class="hljs-keyword">return</span> esCourseService.list(page,size,courseSearchParam);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）</p><div class="language-java line-numbers-mode" data-ext="java"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight java"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EsCourseService</span> &#123;<br>    <span class="hljs-meta">@Value(&quot;$&#123;heima.course.source_field&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String source_field;<br><br>    <span class="hljs-meta">@Autowired</span><br>    RestHighLevelClient restHighLevelClient;<br><br>    <span class="hljs-comment">//课程搜索</span><br>    <span class="hljs-keyword">public</span> QueryResponseResult&amp;lt;CoursePub&amp;gt; list(<span class="hljs-type">int</span> page, <span class="hljs-type">int</span> size, CourseSearchParam courseSearchParam) &#123;<br>        <span class="hljs-keyword">if</span> (courseSearchParam == <span class="hljs-literal">null</span>) &#123;<br>            courseSearchParam = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CourseSearchParam</span>();<br>        &#125;<br>        <span class="hljs-comment">//1创建搜索请求对象</span><br>        <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">searchRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;xc_course&quot;</span>);<br><br>        <span class="hljs-type">SearchSourceBuilder</span> <span class="hljs-variable">searchSourceBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchSourceBuilder</span>();<br>        <span class="hljs-comment">//过虑源字段</span><br>        String[] source_field_array = source_field.split(<span class="hljs-string">&quot;,&quot;</span>);<br>        searchSourceBuilder.fetchSource(source_field_array, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;&#125;);<br>        <span class="hljs-comment">//创建布尔查询对象</span><br>        <span class="hljs-type">BoolQueryBuilder</span> <span class="hljs-variable">boolQueryBuilder</span> <span class="hljs-operator">=</span> QueryBuilders.boolQuery();<br>        <span class="hljs-comment">//搜索条件</span><br>        <span class="hljs-comment">//根据关键字搜索</span><br>        <span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(courseSearchParam.getKeyword())) &#123;<br>            <span class="hljs-type">MultiMatchQueryBuilder</span> <span class="hljs-variable">multiMatchQueryBuilder</span> <span class="hljs-operator">=</span> QueryBuilders.multiMatchQuery(courseSearchParam.getKeyword(), <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;description&quot;</span>, <span class="hljs-string">&quot;teachplan&quot;</span>)<br>                .minimumShouldMatch(<span class="hljs-string">&quot;70%&quot;</span>)<br>                .field(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-number">10</span>);<br>            boolQueryBuilder.must(multiMatchQueryBuilder);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(courseSearchParam.getMt())) &#123;<br>            <span class="hljs-comment">//根据一级分类</span><br>            boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="hljs-string">&quot;mt&quot;</span>, courseSearchParam.getMt()));<br>        &#125;<br>        <span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(courseSearchParam.getSt())) &#123;<br>            <span class="hljs-comment">//根据二级分类</span><br>            boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="hljs-string">&quot;st&quot;</span>, courseSearchParam.getSt()));<br>        &#125;<br>        <span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(courseSearchParam.getGrade())) &#123;<br>            <span class="hljs-comment">//根据难度等级</span><br>            boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="hljs-string">&quot;grade&quot;</span>, courseSearchParam.getGrade()));<br>        &#125;<br><br>        <span class="hljs-comment">//设置boolQueryBuilder到searchSourceBuilder</span><br>        searchSourceBuilder.query(boolQueryBuilder);<br>        <span class="hljs-comment">//设置分页参数</span><br>        <span class="hljs-keyword">if</span> (page &amp;lt;= <span class="hljs-number">0</span>) &#123;<br>            page = <span class="hljs-number">1</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (size &amp;lt;= <span class="hljs-number">0</span>) &#123;<br>            size = <span class="hljs-number">12</span>;<br>        &#125;<br>        <span class="hljs-comment">//起始记录下标</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">from</span> <span class="hljs-operator">=</span> (page - <span class="hljs-number">1</span>) * size;<br>        searchSourceBuilder.from(from);<br>        searchSourceBuilder.size(size);<br><br>        <span class="hljs-comment">//设置高亮</span><br>        <span class="hljs-type">HighlightBuilder</span> <span class="hljs-variable">highlightBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HighlightBuilder</span>();<br>        highlightBuilder.preTags(<span class="hljs-string">&quot;&amp;lt;font class=&#x27;eslight&#x27;&amp;gt;&quot;</span>);<br>        highlightBuilder.postTags(<span class="hljs-string">&quot;&amp;lt;/font&amp;gt;&quot;</span>);<br>        <span class="hljs-comment">//设置高亮字段</span><br>        <span class="hljs-comment">//        &amp;lt;font class=&#x27;eslight&#x27;&amp;gt;node&amp;lt;/font&amp;gt;学习</span><br>        highlightBuilder.fields().add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HighlightBuilder</span>.Field(<span class="hljs-string">&quot;name&quot;</span>));<br>        searchSourceBuilder.highlighter(highlightBuilder);<br><br>        searchRequest.source(searchSourceBuilder);<br><br>        QueryResult&amp;lt;CoursePub&amp;gt; queryResult = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryResult</span>();<br>        List&amp;lt;CoursePub&amp;gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&amp;lt;CoursePub&amp;gt;();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//2执行搜索</span><br>            <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">searchResponse</span> <span class="hljs-operator">=</span> restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);<br>            <span class="hljs-comment">//3获取响应结果</span><br>            <span class="hljs-type">SearchHits</span> <span class="hljs-variable">hits</span> <span class="hljs-operator">=</span> searchResponse.getHits();<br>            <span class="hljs-type">long</span> totalHits=hits.getTotalHits().value;<br>            <span class="hljs-comment">//匹配的总记录数</span><br>            <span class="hljs-comment">//            long totalHits = hits.totalHits;</span><br>            queryResult.setTotal(totalHits);<br>            SearchHit[] searchHits = hits.getHits();<br>            <span class="hljs-keyword">for</span> (SearchHit hit : searchHits) &#123;<br>                <span class="hljs-type">CoursePub</span> <span class="hljs-variable">coursePub</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CoursePub</span>();<br>                <span class="hljs-comment">//源文档</span><br>                Map&amp;lt;String, Object&amp;gt; sourceAsMap = hit.getSourceAsMap();<br>                <span class="hljs-comment">//取出id</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> (String) sourceAsMap.get(<span class="hljs-string">&quot;id&quot;</span>);<br>                coursePub.setId(id);<br>                <span class="hljs-comment">//取出name</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> (String) sourceAsMap.get(<span class="hljs-string">&quot;name&quot;</span>);<br>                <span class="hljs-comment">//取出高亮字段name</span><br>                Map&amp;lt;String, HighlightField&amp;gt; highlightFields = hit.getHighlightFields();<br>                <span class="hljs-keyword">if</span> (highlightFields != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-type">HighlightField</span> <span class="hljs-variable">highlightFieldName</span> <span class="hljs-operator">=</span> highlightFields.get(<span class="hljs-string">&quot;name&quot;</span>);<br>                    <span class="hljs-keyword">if</span> (highlightFieldName != <span class="hljs-literal">null</span>) &#123;<br>                        Text[] fragments = highlightFieldName.fragments();<br>                        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">stringBuffer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>                        <span class="hljs-keyword">for</span> (Text text : fragments) &#123;<br>                            stringBuffer.append(text);<br>                        &#125;<br>                        name = stringBuffer.toString();<br>                    &#125;<br>                &#125;<br>                coursePub.setName(name);<br>                <span class="hljs-comment">//图片</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">pic</span> <span class="hljs-operator">=</span> (String) sourceAsMap.get(<span class="hljs-string">&quot;pic&quot;</span>);<br>                coursePub.setPic(pic);<br>                <span class="hljs-comment">//价格</span><br>                <span class="hljs-type">Double</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-keyword">if</span> (sourceAsMap.get(<span class="hljs-string">&quot;price&quot;</span>) != <span class="hljs-literal">null</span>) &#123;<br>                        price = (Double) sourceAsMap.get(<span class="hljs-string">&quot;price&quot;</span>);<br>                    &#125;<br><br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>                coursePub.setPrice(price);<br>                <span class="hljs-comment">//旧价格</span><br>                <span class="hljs-type">Double</span> <span class="hljs-variable">price_old</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-keyword">if</span> (sourceAsMap.get(<span class="hljs-string">&quot;price_old&quot;</span>) != <span class="hljs-literal">null</span>) &#123;<br>                        price_old = (Double) sourceAsMap.get(<span class="hljs-string">&quot;price_old&quot;</span>);<br>                    &#125;<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>                coursePub.setPrice_old(price_old);<br>                <span class="hljs-comment">//将coursePub对象放入list</span><br>                list.add(coursePub);<br>            &#125;<br><br><br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        queryResult.setList(list);<br>        QueryResponseResult&amp;lt;CoursePub&amp;gt; queryResponseResult = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryResponseResult</span>&amp;lt;CoursePub&amp;gt;(CommonCode.SUCCESS, queryResult);<br><br>        <span class="hljs-keyword">return</span> queryResponseResult;<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div></article>
<div class="article-footer">

</div>

<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">回顾上一篇</div><a href="/wiki/YDLDoc3/ELK%E5%85%A5%E9%97%A8/elk%E5%85%A5%E9%97%A8/elk%E5%85%A5%E9%97%A8/">elk入门</a></div><div class="item" id="next"><div class="note">接下来阅读</div><a href="/wiki/YDLDoc3/kafka/kafka%E5%85%A5%E9%97%A8/kafka%E5%85%A5%E9%97%A8/">kafka入门</a></div></section></div>


  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>快来参与讨论吧~</p>

    </section>
    <section class='body cmt-body waline'>
      

<div id="waline_container" class="waline_thread"><svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg></div>

    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="text"><p style="text-align:center" >
本站由 <a style="font-weight: bold;" href="/author/ThatCoder/">钟意</a> 使用 <a style="font-weight: bold;" target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.33.1">Stellar 1.33.1</a> 主题创建。
<br>
由 <a style="font-weight: bold;" target="_blank" rel="noopener" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral">又拍云</a> 提供CDN加速/云存储服务
<br>
由 <a style="font-weight: bold;" target="_blank" rel="noopener" href="https://vercel.com/">vercel</a>、<a style="font-weight: bold;" target="_blank" rel="noopener" href="https://www.netlify.com/">netlify</a>、<a style="font-weight: bold;" target="_blank" rel="noopener" href="https://www.cloudflare.com/">cloudflare</a> 提供托管服务
<br>
<a href="https://beian.miit.gov.cn/" target="_blank">湘ICP备2023019799号-1</a>
<br>
<!--不蒜子计数器-->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!--添加一个访问量-->
<span>总访问 <span id="busuanzi_value_site_pv" style="font-weight: bold;"></span> 次 
<!--本页访问 <span id="busuanzi_value_page_pv" style="font-weight: bold;"></span> 次</span>-->
<div id="siteruntime"></div>
</p>
<script>
function siteTime(){
    window.setTimeout("siteTime()", 1000);
    var seconds = 1000
    var minutes = seconds * 60
    var hours = minutes * 60
    var days = hours * 24
    var years = days * 365
    var today = new Date()
    var todayYear = today.getFullYear()
    var todayMonth = today.getMonth()
    var todayDate = today.getDate()
    var todayHour = today.getHours()
    var todayMinute = today.getMinutes()
    var todaySecond = today.getSeconds()
    var t1 = Date.UTC(2020,4,30,08,00,00)
    var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond)
    var diff = t2-t1
    var diffYears = Math.floor(diff/years)
    var diffDays = Math.floor((diff/days)-diffYears*365)
    var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours)
    var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes)
    var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds)
    document.getElementById("siteruntime").innerHTML="<p style=\"text-align:center\">小破站已颠沛流离 "+diffYears+" 年 "+diffDays+" 天 "+diffHours+" 小时 "+diffMinutes+" 分钟 "+diffSeconds+" 秒</p>"
}
siteTime();
</script>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="auto"><div class="widget-header dis-select"><span class="name">本文目录</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0-%E7%B4%A2%E5%BC%95index%E5%85%A5%E9%97%A8"><span class="toc-text"> 第十一章 索引Index入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86"><span class="toc-text"> 一、索引管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E4%BB%AC%E8%A6%81%E6%89%8B%E5%8A%A8%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="toc-text"> 1、为什么我们要手动创建索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86"><span class="toc-text"> 2、索引管理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#_1-%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="toc-text"> （1）创建索引</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#_2-%E6%9F%A5%E8%AF%A2%E7%B4%A2%E5%BC%95"><span class="toc-text"> （2）查询索引</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#_3-%E4%BF%AE%E6%94%B9%E7%B4%A2%E5%BC%95"><span class="toc-text"> （3）修改索引</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#_4-%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95"><span class="toc-text"> （4）删除索引</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%AE%9A%E5%88%B6%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-text"> 二、定制分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81%E9%BB%98%E8%AE%A4%E7%9A%84%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-text"> 1、默认的分词器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E4%BF%AE%E6%94%B9%E5%88%86%E8%AF%8D%E5%99%A8%E7%9A%84%E8%AE%BE%E7%BD%AE"><span class="toc-text"> 2、修改分词器的设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81%E5%AE%9A%E5%88%B6%E5%8C%96%E8%87%AA%E5%B7%B1%E7%9A%84%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-text"> 3、定制化自己的分词器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81type%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84%E5%8F%8A%E5%BC%83%E7%94%A8%E5%8E%9F%E5%9B%A0"><span class="toc-text"> 三、type底层结构及弃用原因</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81type%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-text"> 1、type是什么</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81es%E4%B8%AD%E4%B8%8D%E5%90%8Ctype%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6"><span class="toc-text"> 2、es中不同type存储机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81type%E5%BC%83%E7%94%A8"><span class="toc-text"> 3、type弃用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%AE%9A%E5%88%B6dynamic-mapping"><span class="toc-text"> 四、定制dynamic mapping</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81%E5%AE%9A%E5%88%B6dynamic%E7%AD%96%E7%95%A5"><span class="toc-text"> 1、定制dynamic策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89-dynamic-mapping%E7%AD%96%E7%95%A5"><span class="toc-text"> 2、自定义 dynamic mapping策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#date-detection-%E6%97%A5%E6%9C%9F%E6%8E%A2%E6%B5%8B"><span class="toc-text"> date_detection 日期探测</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%97%A5%E6%9C%9F%E6%A0%BC%E5%BC%8F"><span class="toc-text"> 自定义日期格式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#numeric-detection-%E6%95%B0%E5%AD%97%E6%8E%A2%E6%B5%8B"><span class="toc-text"> numeric_detection 数字探测</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81%E5%AE%9A%E5%88%B6%E8%87%AA%E5%B7%B1%E7%9A%84dynamic-mapping-template"><span class="toc-text"> 3、定制自己的dynamic mapping template</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E5%86%99%E6%B3%95"><span class="toc-text"> 模板写法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF"><span class="toc-text"> 场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E9%9B%B6%E5%81%9C%E6%9C%BA%E9%87%8D%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="toc-text"> 五、零停机重建索引</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81%E9%9B%B6%E5%81%9C%E6%9C%BA%E9%87%8D%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="toc-text"> 1、零停机重建索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5-%E5%9F%BA%E4%BA%8Ealias%E5%AF%B9client%E9%80%8F%E6%98%8E%E5%88%87%E6%8D%A2index"><span class="toc-text"> 2、生产实践：基于alias对client透明切换index</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%BA%8C%E7%AB%A0-%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D%E5%99%A8-ik%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-text"> 第十二章 中文分词器 IK分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81ik%E5%88%86%E8%AF%8D%E5%99%A8%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8"><span class="toc-text"> 一、Ik分词器安装使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-text"> 1、中文分词器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E5%AE%89%E8%A3%85"><span class="toc-text"> 2、安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81ik%E5%88%86%E8%AF%8D%E5%99%A8%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-text"> 3、ik分词器基础知识</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4%E3%80%81ik%E5%88%86%E8%AF%8D%E5%99%A8%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text"> 4、ik分词器的使用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81-ik%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text"> 二、 ik配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81-ik%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text"> 1、 ik配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AF%8D%E5%BA%93"><span class="toc-text"> 2、自定义词库</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E4%BD%BF%E7%94%A8mysql%E7%83%AD%E6%9B%B4%E6%96%B0-%E8%AF%8D%E5%BA%93"><span class="toc-text"> 三、使用mysql热更新 词库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81%E7%83%AD%E6%9B%B4%E6%96%B0"><span class="toc-text"> 1、热更新</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E6%AD%A5%E9%AA%A4"><span class="toc-text"> 2、步骤</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%B8%89%E7%AB%A0-java-api-%E5%AE%9E%E7%8E%B0%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86"><span class="toc-text"> 第十三章 java api 实现索引管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E5%9B%9B%E7%AB%A0-search%E6%90%9C%E7%B4%A2%E5%85%A5%E9%97%A8"><span class="toc-text"> 第十四章 search搜索入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%90%9C%E7%B4%A2%E8%AF%AD%E6%B3%95%E5%85%A5%E9%97%A8"><span class="toc-text"> 一、搜索语法入门</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81query-string-search"><span class="toc-text"> 1、query string search</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E4%BC%A0%E5%8F%82"><span class="toc-text"> 2、传参</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81%E5%9B%BE%E8%A7%A3timeout"><span class="toc-text"> 3、图解timeout</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81multi-index-%E5%A4%9A%E7%B4%A2%E5%BC%95%E6%90%9C%E7%B4%A2"><span class="toc-text"> 二、multi-index 多索引搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81multi-index%E6%90%9C%E7%B4%A2%E6%A8%A1%E5%BC%8F"><span class="toc-text"> 1、multi-index搜索模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E5%88%9D%E6%AD%A5%E5%9B%BE%E8%A7%A3%E4%B8%80%E4%B8%8B%E7%AE%80%E5%8D%95%E7%9A%84%E6%90%9C%E7%B4%A2%E5%8E%9F%E7%90%86"><span class="toc-text"> 2、初步图解一下简单的搜索原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%88%86%E9%A1%B5%E6%90%9C%E7%B4%A2"><span class="toc-text"> 三、分页搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81%E5%88%86%E9%A1%B5%E6%90%9C%E7%B4%A2%E7%9A%84%E8%AF%AD%E6%B3%95"><span class="toc-text"> 1、分页搜索的语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81deep-paging"><span class="toc-text"> 2、deep paging</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFdeep-paging"><span class="toc-text"> 什么是deep paging</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#deep-paging-%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98"><span class="toc-text"> deep paging 性能问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81-query-string%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95"><span class="toc-text"> 四、 query string基础语法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81query-string%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95"><span class="toc-text"> 1、query string基础语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81-all-metadata%E7%9A%84%E5%8E%9F%E7%90%86%E5%92%8C%E4%BD%9C%E7%94%A8"><span class="toc-text"> 2、_all metadata的原理和作用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E3%80%81query-dsl%E5%85%A5%E9%97%A8"><span class="toc-text"> 五、query DSL入门</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81dsl"><span class="toc-text"> 1、DSL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81-query-dsl%E8%AF%AD%E6%B3%95"><span class="toc-text"> 2、 Query DSL语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81%E7%BB%84%E5%90%88%E5%A4%9A%E4%B8%AA%E6%90%9C%E7%B4%A2%E6%9D%A1%E4%BB%B6"><span class="toc-text"> 3、组合多个搜索条件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AD%E3%80%81full-text-search-%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2"><span class="toc-text"> 六、full-text search 全文检索</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2"><span class="toc-text"> 1、全文检索</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81-score%E5%88%9D%E6%8E%A2"><span class="toc-text"> 2、_score初探</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%83%E3%80%81dsl-%E8%AF%AD%E6%B3%95%E7%BB%83%E4%B9%A0"><span class="toc-text"> 七、DSL 语法练习</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81match-all"><span class="toc-text"> 1、match_all</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81match"><span class="toc-text"> 2、match</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81multi-match"><span class="toc-text"> 3、multi_match</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4%E3%80%81range-query-%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2"><span class="toc-text"> 4、range query 范围查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_5%E3%80%81term-query"><span class="toc-text"> 5、term query</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_6%E3%80%81terms-query"><span class="toc-text"> 6、terms query</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_7%E3%80%81exist-query-%E6%9F%A5%E8%AF%A2%E6%9C%89%E6%9F%90%E4%BA%9B%E5%AD%97%E6%AE%B5%E5%80%BC%E7%9A%84%E6%96%87%E6%A1%A3"><span class="toc-text"> 7、exist query 查询有某些字段值的文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_8%E3%80%81fuzzy-query"><span class="toc-text"> 8、Fuzzy query</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_9%E3%80%81ids"><span class="toc-text"> 9、IDs</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_10%E3%80%81prefix-%E5%89%8D%E7%BC%80%E6%9F%A5%E8%AF%A2"><span class="toc-text"> 10、prefix 前缀查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_11%E3%80%81regexp-query-%E6%AD%A3%E5%88%99%E6%9F%A5%E8%AF%A2"><span class="toc-text"> 11、regexp query 正则查询</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AB%E3%80%81-filter"><span class="toc-text"> 八、 Filter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81-filter%E4%B8%8Equery%E7%A4%BA%E4%BE%8B"><span class="toc-text"> 1、 filter与query示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81filter%E4%B8%8Equery%E5%AF%B9%E6%AF%94"><span class="toc-text"> 2、filter与query对比</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81filter%E4%B8%8Equery%E6%80%A7%E8%83%BD"><span class="toc-text"> 3、filter与query性能</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E5%AE%9A%E4%BD%8D%E9%94%99%E8%AF%AF%E8%AF%AD%E6%B3%95"><span class="toc-text"> 九、定位错误语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E3%80%81%E5%AE%9A%E5%88%B6%E6%8E%92%E5%BA%8F%E8%A7%84%E5%88%99"><span class="toc-text"> 十、定制排序规则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81%E9%BB%98%E8%AE%A4%E6%8E%92%E5%BA%8F%E8%A7%84%E5%88%99"><span class="toc-text"> 1、默认排序规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E5%AE%9A%E5%88%B6%E6%8E%92%E5%BA%8F%E8%A7%84%E5%88%99"><span class="toc-text"> 2、定制排序规则</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E4%B8%80%E3%80%81-text%E5%AD%97%E6%AE%B5%E6%8E%92%E5%BA%8F%E9%97%AE%E9%A2%98"><span class="toc-text"> 十一、 Text字段排序问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81scroll%E5%88%86%E6%89%B9%E6%9F%A5%E8%AF%A2"><span class="toc-text"> 十二、Scroll分批查询</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%BA%94%E7%AB%A0-java-api%E5%AE%9E%E7%8E%B0%E6%90%9C%E7%B4%A2"><span class="toc-text"> 第十五章 java api实现搜索</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E5%85%AD%E7%AB%A0-%E8%AF%84%E5%88%86%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3"><span class="toc-text"> 第十六章 评分机制详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E8%AF%84%E5%88%86%E6%9C%BA%E5%88%B6-tf-idf"><span class="toc-text"> 一、评分机制 TF\IDF</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81%E7%AE%97%E6%B3%95%E4%BB%8B%E7%BB%8D"><span class="toc-text"> 1、算法介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81-score%E6%98%AF%E5%A6%82%E4%BD%95%E8%A2%AB%E8%AE%A1%E7%AE%97%E5%87%BA%E6%9D%A5%E7%9A%84"><span class="toc-text"> 2、_score是如何被计算出来的</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81%E5%88%86%E6%9E%90%E4%B8%80%E4%B8%AAdocument%E6%98%AF%E5%A6%82%E4%BD%95%E8%A2%AB%E5%8C%B9%E9%85%8D%E4%B8%8A%E7%9A%84"><span class="toc-text"> 3、分析一个document是如何被匹配上的</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81doc-value"><span class="toc-text"> 二、Doc value</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81query-phase"><span class="toc-text"> 三、query phase</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81query-phase"><span class="toc-text"> 1、query phase</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81replica-shard%E5%A6%82%E4%BD%95%E6%8F%90%E5%8D%87%E6%90%9C%E7%B4%A2%E5%90%9E%E5%90%90%E9%87%8F"><span class="toc-text"> 2、replica shard如何提升搜索吞吐量</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81-fetch-phase"><span class="toc-text"> 四、 fetch phase</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81fetch-phbase%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-text"> 1、fetch phbase工作流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E4%B8%80%E8%88%AC%E6%90%9C%E7%B4%A2-%E5%A6%82%E6%9E%9C%E4%B8%8D%E5%8A%A0from%E5%92%8Csize-%E5%B0%B1%E9%BB%98%E8%AE%A4%E6%90%9C%E7%B4%A2%E5%89%8D10%E6%9D%A1-%E6%8C%89%E7%85%A7-score%E6%8E%92%E5%BA%8F"><span class="toc-text"> 2、一般搜索，如果不加from和size，就默认搜索前10条，按照_score排序</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%90%9C%E7%B4%A2%E5%8F%82%E6%95%B0%E5%B0%8F%E6%80%BB%E7%BB%93"><span class="toc-text"> 五、搜索参数小总结</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81preference"><span class="toc-text"> 1、preference</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81timeout"><span class="toc-text"> 2、timeout</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81routing"><span class="toc-text"> 3、routing</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4%E3%80%81search-type"><span class="toc-text"> 4、search_type</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%B8%83%E7%AB%A0-%E8%81%9A%E5%90%88%E5%85%A5%E9%97%A8"><span class="toc-text"> 第十七章 聚合入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E8%81%9A%E5%90%88%E7%A4%BA%E4%BE%8B"><span class="toc-text"> 一、聚合示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81%E9%9C%80%E6%B1%82-%E8%AE%A1%E7%AE%97%E6%AF%8F%E4%B8%AAstudymodel%E4%B8%8B%E7%9A%84%E5%95%86%E5%93%81%E6%95%B0%E9%87%8F"><span class="toc-text"> 1、需求：计算每个studymodel下的商品数量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E9%9C%80%E6%B1%82-%E8%AE%A1%E7%AE%97%E6%AF%8F%E4%B8%AAtags%E4%B8%8B%E7%9A%84%E5%95%86%E5%93%81%E6%95%B0%E9%87%8F"><span class="toc-text"> 2、需求：计算每个tags下的商品数量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81%E9%9C%80%E6%B1%82-%E5%8A%A0%E4%B8%8A%E6%90%9C%E7%B4%A2%E6%9D%A1%E4%BB%B6-%E8%AE%A1%E7%AE%97%E6%AF%8F%E4%B8%AAtags%E4%B8%8B%E7%9A%84%E5%95%86%E5%93%81%E6%95%B0%E9%87%8F"><span class="toc-text"> 3、需求：加上搜索条件，计算每个tags下的商品数量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4%E3%80%81%E9%9C%80%E6%B1%82-%E5%85%88%E5%88%86%E7%BB%84-%E5%86%8D%E7%AE%97%E6%AF%8F%E7%BB%84%E7%9A%84%E5%B9%B3%E5%9D%87%E5%80%BC-%E8%AE%A1%E7%AE%97%E6%AF%8F%E4%B8%AAtag%E4%B8%8B%E7%9A%84%E5%95%86%E5%93%81%E7%9A%84%E5%B9%B3%E5%9D%87%E4%BB%B7%E6%A0%BC"><span class="toc-text"> 4、需求：先分组，再算每组的平均值，计算每个tag下的商品的平均价格</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_5%E3%80%81%E9%9C%80%E6%B1%82-%E8%AE%A1%E7%AE%97%E6%AF%8F%E4%B8%AAtag%E4%B8%8B%E7%9A%84%E5%95%86%E5%93%81%E7%9A%84%E5%B9%B3%E5%9D%87%E4%BB%B7%E6%A0%BC-%E5%B9%B6%E4%B8%94%E6%8C%89%E7%85%A7%E5%B9%B3%E5%9D%87%E4%BB%B7%E6%A0%BC%E9%99%8D%E5%BA%8F%E6%8E%92%E5%BA%8F"><span class="toc-text"> 5、需求：计算每个tag下的商品的平均价格，并且按照平均价格降序排序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_6%E3%80%81%E9%9C%80%E6%B1%82-%E6%8C%89%E7%85%A7%E6%8C%87%E5%AE%9A%E7%9A%84%E4%BB%B7%E6%A0%BC%E8%8C%83%E5%9B%B4%E5%8C%BA%E9%97%B4%E8%BF%9B%E8%A1%8C%E5%88%86%E7%BB%84-%E7%84%B6%E5%90%8E%E5%9C%A8%E6%AF%8F%E7%BB%84%E5%86%85%E5%86%8D%E6%8C%89%E7%85%A7tag%E8%BF%9B%E8%A1%8C%E5%88%86%E7%BB%84-%E6%9C%80%E5%90%8E%E5%86%8D%E8%AE%A1%E7%AE%97%E6%AF%8F%E7%BB%84%E7%9A%84%E5%B9%B3%E5%9D%87%E4%BB%B7%E6%A0%BC"><span class="toc-text"> 6、需求：按照指定的价格范围区间进行分组，然后在每组内再按照tag进行分组，最后再计算每组的平均价格</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E4%B8%A4%E4%B8%AA%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5-bucket%E5%92%8Cmetric"><span class="toc-text"> 二、两个核心概念：bucket和metric</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81bucket-%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%88%86%E7%BB%84"><span class="toc-text"> 1、bucket：一个数据分组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81metric-%E5%AF%B9%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%88%86%E7%BB%84%E6%89%A7%E8%A1%8C%E7%9A%84%E7%BB%9F%E8%AE%A1"><span class="toc-text"> 2、metric：对一个数据分组执行的统计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81%E7%94%B5%E8%A7%86%E6%A1%88%E4%BE%8B"><span class="toc-text"> 3、电视案例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9C%80%E6%B1%821-%E7%BB%9F%E8%AE%A1%E5%93%AA%E7%A7%8D%E9%A2%9C%E8%89%B2%E7%9A%84%E7%94%B5%E8%A7%86%E9%94%80%E9%87%8F%E6%9C%80%E9%AB%98"><span class="toc-text"> 需求1 统计哪种颜色的电视销量最高</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9C%80%E6%B1%822-%E7%BB%9F%E8%AE%A1%E6%AF%8F%E7%A7%8D%E9%A2%9C%E8%89%B2%E7%94%B5%E8%A7%86%E5%B9%B3%E5%9D%87%E4%BB%B7%E6%A0%BC"><span class="toc-text"> 需求2 统计每种颜色电视平均价格</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9C%80%E6%B1%823-%E7%BB%A7%E7%BB%AD%E4%B8%8B%E9%92%BB%E5%88%86%E6%9E%90"><span class="toc-text"> 需求3 继续下钻分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9C%80%E6%B1%824-%E6%9B%B4%E5%A4%9A%E7%9A%84metric"><span class="toc-text"> 需求4：更多的metric</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9C%80%E6%B1%825-%E5%88%92%E5%88%86%E8%8C%83%E5%9B%B4-histogram"><span class="toc-text"> 需求5：划分范围 histogram</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9C%80%E6%B1%826-%E6%8C%89%E7%85%A7%E6%97%A5%E6%9C%9F%E5%88%86%E7%BB%84%E8%81%9A%E5%90%88"><span class="toc-text"> 需求6：按照日期分组聚合</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9C%80%E6%B1%827-%E7%BB%9F%E8%AE%A1%E6%AF%8F%E5%AD%A3%E5%BA%A6%E6%AF%8F%E4%B8%AA%E5%93%81%E7%89%8C%E7%9A%84%E9%94%80%E5%94%AE%E9%A2%9D"><span class="toc-text"> 需求7 统计每季度每个品牌的销售额</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9C%80%E6%B1%828-%E6%90%9C%E7%B4%A2%E4%B8%8E%E8%81%9A%E5%90%88%E7%BB%93%E5%90%88-%E6%9F%A5%E8%AF%A2%E6%9F%90%E4%B8%AA%E5%93%81%E7%89%8C%E6%8C%89%E9%A2%9C%E8%89%B2%E9%94%80%E9%87%8F"><span class="toc-text"> 需求8 ：搜索与聚合结合，查询某个品牌按颜色销量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9C%80%E6%B1%829-global-bucket-%E5%8D%95%E4%B8%AA%E5%93%81%E7%89%8C%E4%B8%8E%E6%89%80%E6%9C%89%E5%93%81%E7%89%8C%E9%94%80%E9%87%8F%E5%AF%B9%E6%AF%94"><span class="toc-text"> 需求9 global bucket：单个品牌与所有品牌销量对比</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9C%80%E6%B1%8210-%E8%BF%87%E6%BB%A4-%E8%81%9A%E5%90%88-%E7%BB%9F%E8%AE%A1%E4%BB%B7%E6%A0%BC%E5%A4%A7%E4%BA%8E1200%E7%9A%84%E7%94%B5%E8%A7%86%E5%B9%B3%E5%9D%87%E4%BB%B7%E6%A0%BC"><span class="toc-text"> 需求10：过滤+聚合：统计价格大于1200的电视平均价格</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9C%80%E6%B1%8211-bucket-filter-%E7%BB%9F%E8%AE%A1%E5%93%81%E7%89%8C%E6%9C%80%E8%BF%91%E4%B8%80%E4%B8%AA%E6%9C%88%E7%9A%84%E5%B9%B3%E5%9D%87%E4%BB%B7%E6%A0%BC"><span class="toc-text"> 需求11 bucket filter：统计品牌最近一个月的平均价格</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9C%80%E6%B1%8212-%E6%8E%92%E5%BA%8F-%E6%8C%89%E6%AF%8F%E7%A7%8D%E9%A2%9C%E8%89%B2%E7%9A%84%E5%B9%B3%E5%9D%87%E9%94%80%E5%94%AE%E9%A2%9D%E9%99%8D%E5%BA%8F%E6%8E%92%E5%BA%8F"><span class="toc-text"> 需求12 排序：按每种颜色的平均销售额降序排序</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9C%80%E6%B1%8213-%E6%8E%92%E5%BA%8F-%E6%8C%89%E6%AF%8F%E7%A7%8D%E9%A2%9C%E8%89%B2%E7%9A%84%E6%AF%8F%E7%A7%8D%E5%93%81%E7%89%8C%E5%B9%B3%E5%9D%87%E9%94%80%E5%94%AE%E9%A2%9D%E9%99%8D%E5%BA%8F%E6%8E%92%E5%BA%8F"><span class="toc-text"> 需求13 排序：按每种颜色的每种品牌平均销售额降序排序</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E5%85%AB%E7%AB%A0-java-api%E5%AE%9E%E7%8E%B0%E8%81%9A%E5%90%88"><span class="toc-text"> 第十八章 java api实现聚合</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%B9%9D%E7%AB%A0-es7-sql%E6%96%B0%E7%89%B9%E6%80%A7"><span class="toc-text"> 第十九章 es7 sql新特性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-text"> 一、快速入门</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%90%AF%E5%8A%A8%E6%96%B9%E5%BC%8F"><span class="toc-text"> 二、启动方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%98%BE%E7%A4%BA%E6%96%B9%E5%BC%8F"><span class="toc-text"> 三、显示方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81sql-%E7%BF%BB%E8%AF%91"><span class="toc-text"> 四、sql 翻译</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E4%B8%8E%E5%85%B6%E4%BB%96dsl%E7%BB%93%E5%90%88"><span class="toc-text"> 五、与其他DSL结合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AD%E3%80%81-java-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0sql%E5%8A%9F%E8%83%BD"><span class="toc-text"> 六、 java 代码实现sql功能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E5%8D%81%E7%AB%A0-logstash%E5%AD%A6%E4%B9%A0"><span class="toc-text"> 第二十章 Logstash学习</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81logstash%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95%E7%BB%84%E6%88%90"><span class="toc-text"> 一、Logstash基本语法组成</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFlogstash"><span class="toc-text"> 1、什么是Logstash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text"> 2、配置文件：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81%E5%90%AF%E5%8A%A8%E6%93%8D%E4%BD%9C"><span class="toc-text"> 3、启动操作：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81logstash%E8%BE%93%E5%85%A5%E6%8F%92%E4%BB%B6-input"><span class="toc-text"> 二、Logstash输入插件（input）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81%E6%A0%87%E5%87%86%E8%BE%93%E5%85%A5-stdin"><span class="toc-text"> 1、标准输入(Stdin)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6-file"><span class="toc-text"> 2、读取文件(File)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81%E8%AF%BB%E5%8F%96tcp%E7%BD%91%E7%BB%9C%E6%95%B0%E6%8D%AE"><span class="toc-text"> 3、读取TCP网络数据</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81logstash%E8%BF%87%E6%BB%A4%E5%99%A8%E6%8F%92%E4%BB%B6-filter"><span class="toc-text"> 三、Logstash过滤器插件(Filter)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81grok-%E6%AD%A3%E5%88%99%E6%8D%95%E8%8E%B7"><span class="toc-text"> 1、Grok 正则捕获</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E6%97%B6%E9%97%B4%E5%A4%84%E7%90%86-date"><span class="toc-text"> 2、时间处理(Date)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81%E6%95%B0%E6%8D%AE%E4%BF%AE%E6%94%B9-mutate"><span class="toc-text"> 3、数据修改(Mutate)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#_1-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%9B%BF%E6%8D%A2%E5%8C%B9%E9%85%8D%E5%AD%97%E6%AE%B5"><span class="toc-text"> （1）正则表达式替换匹配字段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#_2-%E5%88%86%E9%9A%94%E7%AC%A6%E5%88%86%E5%89%B2%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%BA%E6%95%B0%E7%BB%84"><span class="toc-text"> （2）分隔符分割字符串为数组</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#_3-%E9%87%8D%E5%91%BD%E5%90%8D%E5%AD%97%E6%AE%B5"><span class="toc-text"> （3）重命名字段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#_4-%E5%88%A0%E9%99%A4%E5%AD%97%E6%AE%B5"><span class="toc-text"> （4）删除字段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#_5-geoip-%E5%9C%B0%E5%9D%80%E6%9F%A5%E8%AF%A2%E5%BD%92%E7%B1%BB"><span class="toc-text"> （5）GeoIP 地址查询归类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%BC%E5%90%88%E4%BE%8B%E5%AD%90"><span class="toc-text"> 综合例子：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81logstash%E8%BE%93%E5%87%BA%E6%8F%92%E4%BB%B6-output"><span class="toc-text"> 四、Logstash输出插件（output）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B"><span class="toc-text"> 五、综合案例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%B8%80%E7%AB%A0-kibana%E5%AD%A6%E4%B9%A0"><span class="toc-text"> 第二十一章 kibana学习</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2"><span class="toc-text"> 一、基本查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="toc-text"> 二、可视化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E4%BB%AA%E8%A1%A8%E7%9B%98"><span class="toc-text"> 三、仪表盘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E4%BD%BF%E7%94%A8%E6%A8%A1%E6%9D%BF%E6%95%B0%E6%8D%AE%E6%8C%87%E5%AF%BC%E7%BB%98%E5%9B%BE"><span class="toc-text"> 四、使用模板数据指导绘图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E5%85%B6%E4%BB%96%E5%8A%9F%E8%83%BD"><span class="toc-text"> 五、其他功能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E7%AB%A0-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="toc-text"> 第二十二章 集群部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E7%82%B9%E7%9A%84%E4%B8%89%E4%B8%AA%E8%A7%92%E8%89%B2"><span class="toc-text"> 结点的三个角色</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%B8%89%E7%AB%A0-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98"><span class="toc-text"> 第二十三章 项目实战</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E9%A1%B9%E7%9B%AE%E4%B8%80-elk%E7%94%A8%E4%BA%8E%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90"><span class="toc-text"> 一、项目一：ELK用于日志分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E9%A1%B9%E7%9B%AE%E4%BA%8C-%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E7%AB%99%E5%86%85%E6%90%9C%E7%B4%A2%E6%A8%A1%E5%9D%97"><span class="toc-text"> 二、项目二：学成在线站内搜索模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81mysql%E5%AF%BC%E5%85%A5course-pub%E8%A1%A8"><span class="toc-text"> 1、mysql导入course_pub表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95xc-course"><span class="toc-text"> 2、创建索引xc_course</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81%E5%88%9B%E5%BB%BA%E6%98%A0%E5%B0%84"><span class="toc-text"> 3、创建映射</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4%E3%80%81logstash%E5%88%9B%E5%BB%BA%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6"><span class="toc-text"> 4、logstash创建模板文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_5%E3%80%81logstash%E9%85%8D%E7%BD%AEmysql-conf"><span class="toc-text"> 5、logstash配置mysql.conf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_6%E3%80%81%E5%90%AF%E5%8A%A8"><span class="toc-text"> 6、启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_7%E3%80%81%E5%90%8E%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="toc-text"> 7、后端代码</span></a></li></ol></li></ol></li></ol></div><div class="widget-footer"><a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><!-- Icon from Solar by 480 Design - https://creativecommons.org/licenses/by/4.0/ --><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5"><path stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/><path d="M7 3.338A9.95 9.95 0 0 1 12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12c0-1.821.487-3.53 1.338-5"/></g></svg><span>回到顶部</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><!-- Icon from Solar by 480 Design - https://creativecommons.org/licenses/by/4.0/ --><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5" d="M8 10.5h8M8 14h5.5M17 3.338A9.95 9.95 0 0 0 12 2C6.477 2 2 6.477 2 12c0 1.6.376 3.112 1.043 4.453c.178.356.237.763.134 1.148l-.595 2.226a1.3 1.3 0 0 0 1.591 1.592l2.226-.596a1.63 1.63 0 0 1 1.149.133A9.96 9.96 0 0 0 12 22c5.523 0 10-4.477 10-10c0-1.821-.487-3.53-1.338-5"/></svg><span>参与讨论</span></a></div></widget>
</div></aside><div class='float-panel'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">


<script type="text/javascript">
  window.canonical = {"originalHost":"blog.thatcoder.cn","officialHosts":["localhost","en.blog.thatcoder.cn","hexo.thatcoder.cn","thatcoder.vercel.app","thatcoder.netlify.app","cn-coder.vercel.app","thatcoders.github.io","thatcoder.pages.dev","cncoder.pages.dev"],"encoded":"YmxvZy50aGF0Y29kZXIuY24="};
  const ctx = {
    date_suffix: {
      just: `刚刚`,
      min: `分钟前`,
      hour: `小时前`,
      day: `天前`,
    },
    root : `/`,
    tag_plugins: {
      chat: Object.assign({"api":"https://siteinfo.listentothewind.cn/api/v1"}),
    }
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"post, page, docs","path":"/search.json","content":true,"skip_search":null,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
    loading: `https://api.iconify.design/eos-icons:three-dots-loading.svg?color=%231cd0fd`,
  };
  const deps = {
    jquery: `https://gcore.jsdelivr.net/npm/jquery@3.7/dist/jquery.min.js`,
    marked: `https://gcore.jsdelivr.net/npm/marked@13.0/lib/marked.umd.min.js`,
    lazyload: `/%5Bobject%20Object%5D`
  }
  

</script>

<script type="text/javascript">
  
  function RunItem() {
    this.list = []; // 存放回调函数
    this.start = () => {
      for (var i = 0; i < this.list.length; i++) {
        this.list[i].run();
      }
    };
    this.push = (fn, name, setRequestAnimationFrame = true) => {
      let myfn = fn
      if (setRequestAnimationFrame) {
        myfn = () => {
          utils.requestAnimationFrame(fn)
        }
      }
      var f = new Item(myfn, name);
      this.list.push(f);
    };
    this.remove = (name) => {
      for (let index = 0; index < this.list.length; index++) {
        const e = this.list[index];
        if (e.name == name) {
          this.list.splice(index, 1);
        }
      }
    }
    // 构造一个可以run的对象
    function Item(fn, name) {
      // 函数名称
      this.name = name || fn.name;
      // run方法
      this.run = () => {
        try {
          fn()
        } catch (error) {
          console.log(error);
        }
      };
    }
  }

  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')) {
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function () {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },

    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      const maxRetry = 3;
      let retryCount = 0;

      return new Promise((resolve, reject) => {
        const load = () => {
          utils.onLoading?.(el);

          let timedOut = false;
          const timeout = setTimeout(() => {
            timedOut = true;
            console.warn('[request] 超时:', url);

            if (++retryCount >= maxRetry) {
              utils.onLoadFailure?.(el);
              onFailure?.();
              reject('请求超时');
            } else {
              setTimeout(load, 1000);
            }
          }, 5000);

          fetch(url).then(resp => {
            if (timedOut) return;
            clearTimeout(timeout);

            if (!resp.ok) throw new Error('响应失败');
            return resp;
          }).then(data => {
            if (timedOut) return;
            utils.onLoadSuccess?.(el);
            callback(data);
            resolve(data);
          }).catch(err => {
            clearTimeout(timeout);
            console.warn('[request] 错误:', err);

            if (++retryCount >= maxRetry) {
              utils.onLoadFailure?.(el);
              onFailure?.();
              reject(err);
            } else {
              setTimeout(load, 1000);
            }
          });
        };

        load();
      });
    },
    requestWithoutLoading: (url, options = {}, maxRetry = 2, timeout = 5000) => {
      return new Promise((resolve, reject) => {
        let retryCount = 0;

        const tryRequest = () => {
          let timedOut = false;
          const timer = setTimeout(() => {
            timedOut = true;
            if (++retryCount > maxRetry) reject('timeout');
            else tryRequest();
          }, timeout);

          fetch(url, options)
            .then(resp => {
              clearTimeout(timer);
              if (!resp.ok) throw new Error('bad response');
              resolve(resp);
            })
            .catch(err => {
              clearTimeout(timer);
              if (++retryCount > maxRetry) reject(err);
              else setTimeout(tryRequest, 500);
            });
        };

        tryRequest();
      });
    },
    /********************** requestAnimationFrame ********************************/
    // 1、requestAnimationFrame 会把每一帧中的所有 DOM 操作集中起来，在一次重绘或回流中就完成，并且重绘或回流的时间间隔紧紧跟随浏览器的刷新频率，一般来说，这个频率为每秒60帧。
    // 2、在隐藏或不可见的元素中，requestAnimationFrame 将不会进行重绘或回流，这当然就意味着更少的的 cpu，gpu 和内存使用量。
    requestAnimationFrame: (fn) => {
      if (!window.requestAnimationFrame) {
        window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame;
      }
      window.requestAnimationFrame(fn)
    },
    dark: {},
  };

  // utils.dark.mode 当前模式 dark or light
  // utils.dark.toggle() 暗黑模式触发器
  // utils.dark.push(callBack[,"callBackName"]) 传入触发器回调函数
  utils.dark.method = {
    toggle: new RunItem(),
  };
  utils.dark = Object.assign(utils.dark, {
    push: utils.dark.method.toggle.push,
  });
</script>
<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>
<script type="text/javascript">
  (() => {
    const tagSwitchers = document.querySelectorAll('.tag-subtree.parent-tag > a > .tag-switcher-wrapper')
    for (const tagSwitcher of tagSwitchers) {
      tagSwitcher.addEventListener('click', (e) => {
        const parent = e.target.closest('.tag-subtree.parent-tag')
        parent.classList.toggle('expanded')
        e.preventDefault()
      })
    }

    // Get active tag from query string, then activate it.
    const urlParams = new URLSearchParams(window.location.search)
    const activeTag = urlParams.get('tag')
    if (activeTag) {
      let tag = document.querySelector(`.tag-subtree[data-tag="${activeTag}"]`)
      if (tag) {
        tag.querySelector('a').classList.add('active')
        
        while (tag) {
          tag.classList.add('expanded')
          tag = tag.parentElement.closest('.tag-subtree.parent-tag')
        }
      }
    }
  })()
</script>

<script async src="https://gcore.jsdelivr.net/npm/vanilla-lazyload@19.1/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
    callback_loaded: (el) => {
      el.classList.add('loaded');
      const wrapper = el.closest('.lazy-box');
      const icon = wrapper?.querySelector('.lazy-icon');
      if (icon) icon.remove();
    }
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });

  window.wrapLazyloadImages = (container) => {
    if (typeof container === 'string') {
      container = document.querySelector(container);
    }
    if (!container) return;
    
    const images = container.querySelectorAll('img');
    images.forEach((img) => {
      if (img.classList.contains('lazy')) return;

      const src = img.getAttribute('src');
      if (!src) return;

      const wrapper = document.createElement('div');
      wrapper.className = 'lazy-box';

      const newImg = img.cloneNode();
      newImg.removeAttribute('src');
      newImg.setAttribute('data-src', src);
      newImg.classList.add('lazy');

      const icon = document.createElement('div');
      icon.className = 'lazy-icon';
      if (def.loading) {
        icon.style.backgroundImage = `url("${def.loading}")`;
      }

      wrapper.appendChild(newImg);
      wrapper.appendChild(icon);

      img.replaceWith(wrapper);
    });

    // 通知 LazyLoad 更新
    if (window.lazyLoadInstance?.update) {
      window.lazyLoadInstance.update();
    }
  }
  
</script>

<!-- required -->
<script src="/js/main.js?v=1.33.1" defer></script>

<script type="text/javascript">
  const applyTheme = (theme) => {
    if (theme === 'auto') {
      document.documentElement.removeAttribute('data-theme')
    } else {
      document.documentElement.setAttribute('data-theme', theme)
    }

    // applyThemeToGiscus(theme)
  }

  // FIXME: 这会导致无法使用 preferred_color_scheme 以外的主题
  const applyThemeToGiscus = (theme) => {
    // theme = theme === 'auto' ? 'preferred_color_scheme' : theme
    const cmt = document.getElementById('giscus')
    if (cmt) {
      // This works before giscus load.
      cmt.setAttribute('data-theme', theme)
    }

    const iframe = document.querySelector('#comments > section.giscus > iframe')
    if (iframe) {
      // This works after giscus loaded.
      const src = iframe.src
      const newSrc = src.replace(/theme=[\w]+/, `theme=${theme}`)
      iframe.src = newSrc
    }
  }

  const switchTheme = () => {
    // light -> dark -> auto -> light -> ...
    const currentTheme = document.documentElement.getAttribute('data-theme')
    let newTheme;
    switch (currentTheme) {
      case 'light':
        newTheme = 'dark'
        break
      case 'dark':
        newTheme = 'auto'
        break
      default:
        newTheme = 'light'
    }
    applyTheme(newTheme)
    window.localStorage.setItem('Stellar.theme', newTheme)
    utils.dark.mode = newTheme === 'auto' ? (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light") : newTheme;
    utils.dark.method.toggle.start();

    const messages = {
      light: `切换到浅色模式`,
      dark: `切换到深色模式`,
      auto: `切换到跟随系统配色`,
    }
    hud?.toast?.(messages[newTheme])
  }

  (() => {
    // Apply user's preferred theme, if any.
    const theme = window.localStorage.getItem('Stellar.theme')
    if (theme !== null) {
      applyTheme(theme)
    } else {
      utils.dark.mode = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    }
    utils.dark.method.toggle.start();
  })()
</script>


<!-- optional -->

  <script type="module">
  import { init } from 'https://gcore.jsdelivr.net/npm/@waline/client@3.1/dist/waline.js';

  const el = document.getElementById('waline_container');
  util.viewportLazyload(el, load_waline, false);

  function load_waline(){
    if (!el) return;

    utils.css('https://gcore.jsdelivr.net/npm/@waline/client@3.1/dist/waline.css');
    utils.css('https://gcore.jsdelivr.net/npm/@waline/client@3.1/dist/waline-meta.css');

    const path = el.getAttribute('comment_id') ?? decodeURI(window.location.pathname);
    const waline = init(Object.assign({"js":"https://gcore.jsdelivr.net/npm/@waline/client@3.1/dist/waline.js","css":"https://gcore.jsdelivr.net/npm/@waline/client@3.1/dist/waline.css","meta_css":"https://gcore.jsdelivr.net/npm/@waline/client@3.1/dist/waline-meta.css","serverURL":"https://waline.thatapi.cn/","commentCount":true,"pageview":false,"search":false,"locale":{"placeholder":"  遇事不决, 可问春风..."},"emoji":["https://upyun.thatcdn.cn/public/web/emojis/bilibili","https://upyun.thatcdn.cn/public/web/emojis/qq","https://upyun.thatcdn.cn/public/web/emojis/tieba","https://upyun.thatcdn.cn/public/web/emojis/weibo"],"reaction":["https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_thumbsup.png","https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_cute.png","https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_sunglasses.png","https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_crazy.png","https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_trollface.png"],"meta":["nick","mail","link"],"imageUploader":{"fileName":"file","tokenName":"Authorization","api":"https://lsky.thatcoder.cn/api/v1/upload","token":"Bearer 6|x9vHGJGHAnjqbO0PGEE5vM7r9S9hdqFA9bmdESdm","resp":"data.links.url"}}, {
      el: '#waline_container',
      path: path,
      
        imageUploader: function(file) {
          const headers = new Headers();
          headers.set('Accept', 'application/json');
          
            headers.set('Authorization', 'Bearer 6|x9vHGJGHAnjqbO0PGEE5vM7r9S9hdqFA9bmdESdm')
          
          const formData = new FormData();
          formData.append('file', file);
          return fetch('https://lsky.thatcoder.cn/api/v1/upload',{
            method: 'POST',
            body: formData,
            headers: headers
            }).then((resp) => resp.json())
              .then((resp) => resp.data.links.url)
        },
      
    }));
  }
</script>




<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"rating":{"js":"/js/services/rating.js","api":"https://star-vote.xaox.cc/api/rating"},"vote":{"js":"/js/services/vote.js","api":"https://star-vote.xaox.cc/api/vote"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"friends_and_posts":{"js":"/js/services/friends_and_posts.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"},"voice":{"js":"/js/plugins/voice.js"},"video":{"js":"/js/plugins/video.js"},"download-file":{"js":"/js/plugins/download-file.js"},"twikoo":{"js":"/js/services/twikoo_latest_comment.js"},"waline":{"js":"/js/services/waline_latest_comment.js"},"artalk":{"js":"/js/services/artalk_latest_comment.js"},"giscus":{"js":"/js/services/giscus_latest_comment.js"},"contributors":{"edit_this_page":{"_posts/":null,"wiki/stellar/":"https://github.com/xaoxuu/hexo-theme-stellar-docs/blob/main/"},"js":"/js/services/contributors.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else if (id == 'voice') {
        ctx.voiceAudios = document.querySelectorAll('.voice>audio');
        if (ctx.voiceAudios?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            createVoiceDom(ctx.voiceAudios);
          });
        }
      } else if (id == 'video') {
        ctx.videos = document.querySelectorAll('.video>video');
        if (ctx.videos?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            videoEvents(ctx.videos);
          });
        }
      } else if (id == 'download-file') {
        ctx.files = document.querySelectorAll('.file');
        if (ctx.files?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            downloadFileEvent(ctx.files);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }

    // chat iphone time
    let phoneTimes = document.querySelectorAll('.chat .status-bar .time');

    if (phoneTimes.length > 0) {
      NowTime();
      var date = new Date();
      var sec = date.getSeconds();
      var firstAdjustInterval = setInterval(firstAdjustTime, 1000 * (60 - sec));
    }

    function firstAdjustTime() {
      NowTime();
      clearInterval(firstAdjustInterval);
      setInterval(NowTime, 1000 * 60);
    }

    function NowTime() {
      for (let i = 0; i < phoneTimes.length; ++i) {
        var timeSpan = phoneTimes[i];
        var date = new Date();
        var hour = date.getHours();
        var min = date.getMinutes();
        timeSpan.innerHTML = check(hour) + ":" + check(min);
      }
    };

    function check(val) {
      if (val < 10) {
        return ("0" + val);
      }
      return (val);
    }

    // chat quote
    const chat_quote_obverser = new IntersectionObserver((entries, observer) => {
      entries.filter((entry) => { return entry.isIntersecting }).sort((a, b) => a.intersectionRect.y !== b.intersectionRect.y ? a.intersectionRect.y - b.intersectionRect.y : a.intersectionRect.x - b.intersectionRect.x).forEach((entry, index) => {
          observer.unobserve(entry.target);
          setTimeout(() => {
            entry.target.classList.add('quote-blink');
            setTimeout(() => {
              entry.target.classList.remove('quote-blink');
            }, 1000);
          }, Math.max(100, 16) * (index + 1));
        });
    });

    var chatQuotes = document.querySelectorAll(".chat .talk .quote");
    chatQuotes.forEach((quote) => {
      quote.addEventListener('click', function () {
        var chatCellDom = document.getElementById("quote-" + quote.getAttribute("quotedCellTag"));
        if (chatCellDom) {
          var chatDiv = chatCellDom.parentElement;
          var mid = chatDiv.clientHeight / 2;
          var offsetTop = chatCellDom.offsetTop;
          if (offsetTop > mid - chatCellDom.clientHeight / 2) {
            chatDiv.scrollTo({
              top: chatCellDom.offsetTop - mid + chatCellDom.clientHeight / 2,
              behavior: "smooth"
            });
          } else {
            chatDiv.scrollTo({
              top: 0,
              behavior: "smooth"
            });
          }
          chat_quote_obverser.observe(chatCellDom);
        }
      });
    });
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://gcore.jsdelivr.net/npm/flying-pages@2/flying-pages.min.js"></script><script>
  ctx.fancybox = {
    selector: `.swiper-slide img, .md-text.content p>img, .md-text.content li img , .wl-content img, waline_container .vcontent img, .timeline .body .image img,  .timeline .gallery img`,
    css: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.min.css`,
    js: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.umd.min.js`
  };
  var selector = '[data-fancybox]:not(.error), .with-fancybox .atk-content img:not([atk-emoticon])';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const memos = document.getElementsByClassName('ds-memos');
    if (memos != undefined && memos.length > 0) {
      needFancybox = true;
    }
    const fancybox = document.getElementsByClassName('with-fancybox');
    if (fancybox != undefined && fancybox.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>




<!-- inject -->
<script type="text/javascript" src="/custom/js/ZYUtil.js"></script><script type="text/javascript" src="/custom/js/ZYDark.js"></script><script type="text/javascript" src="/custom/js/ZYCategory.js"></script><script type="text/javascript" src="/custom/js/ZYCode.js"></script><script type="text/javascript" src="/custom/js/timetmpl.js"></script>
</div></body></html>
