
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.33.1" theme-name="Stellar" theme-version="1.33.1">
  <link rel="canonical" href="https://blog.thatcoder.cn/wiki/YDLDoc1/mysql学习/mysql进阶/mysql进阶">
  
  <meta name="generator" content="Hexo 7.3.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  <meta name="theme-color" content="#f9fafb">
  <title>YDLDoc1：mysql进阶 - 钟意博客</title>

  
    <meta name="description" content="# mysql进阶-下提示课程视频教程链接：https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1eU4y117txopen in new window# 第六章 索引学习本章节内容，我们最好能模拟一个数据量比较大的环境，我使用nodejs模拟了600多万条数据，大家可自行下载：数据库表如下：  From: 元动力1234567891011121314DROP TABLE IF EX">
<meta property="og:type" content="website">
<meta property="og:title" content="mysql进阶">
<meta property="og:url" content="https://blog.thatcoder.cn/wiki/YDLDoc1/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/mysql%E8%BF%9B%E9%98%B6/">
<meta property="og:site_name" content="钟意博客">
<meta property="og:description" content="# mysql进阶-下提示课程视频教程链接：https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1eU4y117txopen in new window# 第六章 索引学习本章节内容，我们最好能模拟一个数据量比较大的环境，我使用nodejs模拟了600多万条数据，大家可自行下载：数据库表如下：  From: 元动力1234567891011121314DROP TABLE IF EX">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.thatcoder.cn/favicon.ico">
<meta property="article:published_time" content="2025-07-21T12:21:48.058Z">
<meta property="article:modified_time" content="2025-07-21T12:21:48.058Z">
<meta property="article:author" content="钟意">
<meta property="article:tag" content="那个码农">
<meta property="article:tag" content="码农钟意">
<meta property="article:tag" content="钟意的博客">
<meta property="article:tag" content="钟意博客">
<meta property="article:tag" content="That Coder">
<meta property="article:tag" content="thatcoder">
<meta property="article:tag" content="源柒拾柒雅舍">
<meta property="article:tag" content="源WebGary">
<meta property="article:tag" content="giligili.work">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.thatcoder.cn/favicon.ico">
  
  

  <meta name="keywords" content="那个码农,码农钟意,钟意的博客,钟意博客,That Coder,thatcoder,源柒拾柒雅舍,源WebGary,giligili.work">

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="钟意博客" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/main.css?v=1.33.1">


  
    <link rel="shortcut icon" href="/favicon.ico">
  

  
    
<link rel="stylesheet" href="/custom/css/ZYCode.css">

  

  <script type="application/ld+json">{"@context":"https://schema.org","@type":"Website","@id":"https://blog.thatcoder.cn/wiki/YDLDoc1/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/mysql%E8%BF%9B%E9%98%B6/","author":{"@type":"Person","name":"钟意","sameAs":[],"image":"/favicon.ico"},"name":"mysql进阶","description":"# mysql进阶-下提示课程视频教程链接：https://www.bilibili.com/video/BV1eU4y117txopen in new window# 第六章 索引学习本章节内容，我们最好能模拟一个数据量比较大的环境，我使用nodejs模拟了600多万条数据，大家可自行下载：数据库表如下：\n\nFrom: 元动力1234567891011121314DROP TABLE IF...","url":"https://blog.thatcoder.cn/wiki/YDLDoc1/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/mysql%E8%BF%9B%E9%98%B6/","keywords":["那个码农","码农钟意","钟意的博客","钟意博客","That Coder","thatcoder","源柒拾柒雅舍","源WebGary","giligili.work"]}</script>
  <link rel="Shortcut Icon" href="/favicon.ico" type="image/x-icon" /><link rel='stylesheet' href='https://public.thatcdn.cn/font/old_song/result.css' /><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.5.1/css/all.min.css"><link rel="stylesheet" href="/custom/css/ZYTimetmpl.css" /><meta itemprop="name" content="钟意博客"><meta itemprop="author" content="钟意"><meta itemprop="description" content="笔名钟意, 记录代码与生活."><meta name="sogou_site_verification" content="spLj7Zz5dI" /><meta itemprop="image" content="https://upyun.thatcdn.cn/hexo/stellar/image/shot.webp"><link rel="stylesheet" href="/custom/css/ZYGlobal.css"><link rel="stylesheet" href="/custom/css/ZYWaline.css"><link rel="stylesheet" href="/custom/css/ZYPage.css"><script type="text/javascript" src="/custom/js/header.js"></script><!-- Clarity tracking code for https://blog.thatcoder.cn/ -->
<script>    (function(c,l,a,r,i,t,y){        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i+"?ref=bwt";        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);    })(window, document, "clarity", "script", "fi1zg7i5q5");</script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-H6GM3XZWV7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-H6GM3XZWV7');
</script>
<!-- BaiDu-ZhanZhang
<meta name="baidu-site-verification" content="codeva-8tnFVr706d" />
<!-- BaiDu-Tongji -->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?233765a020502d5d6a92d4fe306d36c2";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</head>
<body>



<div class="l_body s:aa content tech " id="start" layout="page" type="tech" ><aside class="l_left"><div class="sidebg"></div><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><div class="icon"><img no-lazy class="icon" src="/custom/img/ydl.png" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></div><a class="title" href="/wiki/YDLDoc1/mysql%E5%AD%A6%E4%B9%A0/JDBC/JDBC"><div class="main">YDLDoc1</div><div class="sub normal cap">关于YDLDoc的笔记</div><div class="sub hover cap" style="opacity:0"> 不对之处请指出</div></a></div></header>

<div class="nav-area">

<nav class="menu dis-select"><a class="nav-item" title="博客" href="/"><span>博客</span></a><a class="nav-item active" title="笔记" href="/wiki/"><span>笔记</span></a><a class="nav-item" title="便签" href="/notes/"><span>便签</span></a><a class="nav-item" title="社交" href="/links/"><span>社交</span></a></nav>
</div>
<div class="widgets">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" data-filter="/wiki/YDLDoc1/" placeholder="在 YDLDoc1 中搜索"></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div>


<widget class="widget-wrapper doc-tree post-list"><div class="widget-body fs14"><a class="link" href="/wiki/YDLDoc1/mysql%E5%AD%A6%E4%B9%A0/JDBC/JDBC/#start"><span class="toc-text">JDBC</span></a><a class="link active" href="/wiki/YDLDoc1/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/mysql%E8%BF%9B%E9%98%B6/"><span class="toc-text">mysql进阶</span><svg class="active-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M21 11.098v4.993c0 3.096 0 4.645-.734 5.321c-.35.323-.792.526-1.263.58c-.987.113-2.14-.907-4.445-2.946c-1.02-.901-1.529-1.352-2.118-1.47a2.225 2.225 0 0 0-.88 0c-.59.118-1.099.569-2.118 1.47c-2.305 2.039-3.458 3.059-4.445 2.945a2.238 2.238 0 0 1-1.263-.579C3 20.736 3 19.188 3 16.091v-4.994C3 6.81 3 4.666 4.318 3.333C5.636 2 7.758 2 12 2c4.243 0 6.364 0 7.682 1.332C21 4.665 21 6.81 21 11.098" opacity=".5"/><path fill="currentColor" d="M9 5.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5z"/></svg></a><a class="link" href="/wiki/YDLDoc1/mysql%E5%AD%A6%E4%B9%A0/mysql%E5%85%A5%E9%97%A8/mysql%E5%85%A5%E9%97%A8/"><span class="toc-text">mysql入门</span></a><a class="link" href="/wiki/YDLDoc1/javase/IO%E6%B5%81/IO%E6%B5%81/"><span class="toc-text">IO流</span></a><a class="link" href="/wiki/YDLDoc1/javase/%E5%8F%98%E9%87%8F%E5%92%8C%E6%A0%87%E8%AF%86%E7%AC%A6/%E5%8F%98%E9%87%8F%E5%92%8C%E6%A0%87%E8%AF%86%E7%AC%A6/"><span class="toc-text">变量和标识符</span></a><a class="link" href="/wiki/YDLDoc1/javase/nio/nio/"><span class="toc-text">nio</span></a><a class="link" href="/wiki/YDLDoc1/javase/java%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/java%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"><span class="toc-text">java正则表达式</span></a><a class="link" href="/wiki/YDLDoc1/javase/%E6%95%B0%E7%BB%84%E5%92%8C%E7%AE%97%E6%B3%95/%E6%95%B0%E7%BB%84%E5%92%8C%E7%AE%97%E6%B3%95/"><span class="toc-text">数组和算法</span></a><a class="link" href="/wiki/YDLDoc1/javase/%E5%BC%82%E5%B8%B8%E6%9C%BA%E5%88%B6/%E5%BC%82%E5%B8%B8%E6%9C%BA%E5%88%B6/"><span class="toc-text">异常机制</span></a><a class="link" href="/wiki/YDLDoc1/javase/%E5%B8%B8%E7%94%A8api/%E5%B8%B8%E7%94%A8api/"><span class="toc-text">常用api</span></a><a class="link" href="/wiki/YDLDoc1/javase/%E6%A0%91/%E6%A0%91/"><span class="toc-text">树</span></a><a class="link" href="/wiki/YDLDoc1/javase/%E5%A4%9A%E7%BA%BF%E7%A8%8B/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"><span class="toc-text">多线程</span></a><a class="link" href="/wiki/YDLDoc1/javase/%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5/%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5/"><span class="toc-text">流程控制语句</span></a><a class="link" href="/wiki/YDLDoc1/javase/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"><span class="toc-text">网络编程</span></a><a class="link" href="/wiki/YDLDoc1/javase/%E5%8F%8D%E5%B0%84/%E5%8F%8D%E5%B0%84/"><span class="toc-text">反射</span></a><a class="link" href="/wiki/YDLDoc1/javase/%E6%B3%9B%E5%9E%8B%E5%92%8C%E6%9E%9A%E4%B8%BE/%E6%B3%9B%E5%9E%8B%E5%92%8C%E6%9E%9A%E4%B8%BE/"><span class="toc-text">泛型和枚举</span></a><a class="link" href="/wiki/YDLDoc1/javase/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/"><span class="toc-text">计算机基础</span></a><a class="link" href="/wiki/YDLDoc1/javase/%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6/%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6/"><span class="toc-text">集合框架</span></a><a class="link" href="/wiki/YDLDoc1/web/css/css/"><span class="toc-text">css</span></a><a class="link" href="/wiki/YDLDoc1/web/bom/bom/"><span class="toc-text">bom</span></a><a class="link" href="/wiki/YDLDoc1/web/html/html/"><span class="toc-text">html</span></a><a class="link" href="/wiki/YDLDoc1/web/js/js/"><span class="toc-text">js</span></a><a class="link" href="/wiki/YDLDoc1/javase/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/"><span class="toc-text">面向对象</span></a><a class="link" href="/wiki/YDLDoc1/%E5%85%B6%E4%BB%96/git%E5%85%A5%E9%97%A8/git%E5%85%A5%E9%97%A8/"><span class="toc-text">git入门</span></a><a class="link" href="/wiki/YDLDoc1/%E5%85%B6%E4%BB%96/linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"><span class="toc-text">linux操作系统</span></a><a class="link" href="/wiki/YDLDoc1/web/jsp/jsp/"><span class="toc-text">jsp</span></a></div></widget>

<widget class="widget-wrapper post-card"><div class="widget-header dis-select"><span class="name">更多：开发</span></div><div class="widget-body"><a class="item wiki" href="/wiki/YDLDoc3/ELK%E5%85%A5%E9%97%A8/elk%E5%85%A5%E9%97%A8/elk%E5%85%A5%E9%97%A8/"><span class="title">元动力摘录 - JAVA阶段三</span><span class="excerpt">钟意关于YDLDoc的笔记</span></a><a class="item wiki" href="/wiki/YDLDoc2/%E6%A1%86%E6%9E%B6/mybatisplus/mybatisplus/"><span class="title">元动力摘录 - JAVA阶段二</span><span class="excerpt">钟意关于YDLDoc的笔记</span></a><a class="item wiki" href="/wiki/YDLDoc4/%E9%A1%B9%E7%9B%AE%E8%BF%9B%E9%98%B6/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/%E7%9F%AD%E4%BF%A1%E9%80%9A%E9%81%93/"><span class="title">元动力摘录 - JAVA项目阶段</span><span class="excerpt">钟意关于YDLDoc的笔记</span></a><a class="item wiki" href="/wiki/YuDaoCloud/%E5%89%8D%E7%AB%AF%E6%89%8B%E5%86%8C%20Vue%203/Icon%20%E5%9B%BE%E6%A0%87/Icon%20%E5%9B%BE%E6%A0%87/"><span class="title">艿艿若依Cloud - 开发指南</span><span class="excerpt">关于艿艿若依Cloud的文档</span></a><a class="item wiki" href="/wiki/Laf/start/start/"><span class="title">Laf - 开箱即用的 serverless</span><span class="excerpt">钟意关于Laf的笔记</span></a><a class="item wiki" href="/wiki/MySql/basics/select/"><span class="title">MySql - 关系型数据库管理系统</span><span class="excerpt">钟意关于关系型数据库MySql的笔记</span></a><a class="item wiki" href="/wiki/YuDaoBoot/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%89%8B%E5%86%8C/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%8E%A5%E5%85%A5/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%8E%A5%E5%85%A5/"><span class="title">艿艿若依Boot - 开发指南</span><span class="excerpt">关于艿艿若依Boot的文档</span></a><a class="item wiki" href="/wiki/SpringCloud/start/"><span class="title">SpringCloud - JAVA系分布式微服务架构</span><span class="excerpt">钟意关于SpringCloud的笔记</span></a></div></widget>

<widget class="widget-wrapper recent post-list"><div class="widget-header dis-select"><span class="name">最近更新</span></div><div class="widget-body fs14"><a class="item title" href="/wiki/forgejo/cache/"><span class="title"><strong>forgejo</strong><span class="dot"></span>Forgejo Redis缓存</span></a><a class="item title" href="/wiki/forgejo/s3/"><span class="title"><strong>forgejo</strong><span class="dot"></span>Forgejo S3存储桶</span></a><a class="item title" href="/wiki/forgejo/start/"><span class="title"><strong>forgejo</strong><span class="dot"></span>Forgejo 容器部署</span></a><a class="item title" href="/wiki/forgejo/ssh/"><span class="title"><strong>forgejo</strong><span class="dot"></span>Forgejo SSH端口修改</span></a><a class="item title" href="/notes/"><span class="title"><strong>便签</strong><span class="dot"></span>钟意的便签</span></a><a class="item title" href="/notes/develop/"><span class="title"><strong>开发速查</strong><span class="dot"></span>开发助手</span></a></div></widget>
</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" style="grid-column: span 3;height:32px;padding: 0;" href="https://space.bilibili.com/1664687779" target="_blank" rel="external nofollow noopener noreferrer"><img height="32px" src="https://upyun.thatcdn.cn/public/img/icon/bilibili-banner.jpg"/></a><a class="social" style="grid-column: span 3;height:32px;padding: 0;" href="https://muselink.cc/naive" target="_blank" rel="external nofollow noopener noreferrer"><img height="32px" src="https://upyun.thatcdn.cn/public/img/icon/wechat-banner.jpg"/></a><a class="social" style="grid-column: span 3;height:32px;padding: 0;" href="https://github.com/ThatCoders" target="_blank" rel="external nofollow noopener noreferrer"><img height="32px" src="https://upyun.thatcdn.cn/public/img/icon/github-banner.jpg"/></a><a class="social" href="javascript:ThemeChange('dark');" rel="noopener noreferrer"><img id="ThemeM" src="https://upyun.thatcdn.cn/public/img/icon/Moon.png"/></a><a class="social" href="javascript:ThemeChange('light');" rel="noopener noreferrer"><img id="ThemeL" src="https://upyun.thatcdn.cn/public/img/icon/Sun.png"/></a><a class="social" href="javascript:ThemeChange('auto');" rel="noopener noreferrer"><img id="ThemeAI" src="https://upyun.thatcdn.cn/public/img/icon/AI.png"/></a></div></footer>
</div></aside><div class="l_main" id="main">





<div class="article banner top">
    <div class="content">
      <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a>
<span class="sep"></span><a class="cap breadcrumb" id="menu" href="/wiki/">文档</a><span class="sep"></span><a class="cap breadcrumb" id="proj" href="/wiki/YDLDoc1/mysql%E5%AD%A6%E4%B9%A0/JDBC/JDBC/">YDLDoc1</a></div>
<div class="flex-row" id="post-meta"><span class="text created">更新于：<time datetime="2025-07-21T12:21:48.058Z">2025-07-21</time></span></div></div><div class="right"><div class="flex-row" id="post-meta" style="justify-content: flex-end;">
            <span class="text updated" id="busuanzi_value_page_pv"></span><span class="text updated"> 阅</span>
            <span class="sep updated"></span>
            <span class="text">27.6k 字</span>
            <span class="sep"></span>
            <span class="text">104 分</span>
        </div></div></div>
      
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>mysql进阶</span></h1>
        
      </div>
    </div>
    
    </div>
    </div><article class="md-text content"><div class="theme-hope-content"><h1 id="mysql进阶-下" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#mysql进阶-下">#</a> mysql进阶-下</h1><div class="hint-container tip"><p class="hint-container-title">提示</p><p>课程视频教程链接：<a href="https://www.bilibili.com/video/BV1eU4y117tx" rel="noopener noreferrer" target="_blank">https://www.bilibili.com/video/BV1eU4y117tx<span><svg aria-hidden="true" class="external-link-icon" focusable="false" height="15" viewbox="0 0 100 100" width="15" x="0px" xmlns="http://www.w3.org/2000/svg" y="0px"><path d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z" fill="currentColor"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><h2 id="第六章-索引" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第六章-索引">#</a> 第六章 索引</h2><p>学习本章节内容，我们最好能模拟一个数据量比较大的环境，我使用nodejs模拟了600多万条数据，大家可自行下载：</p><p>数据库表如下：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `<span class="hljs-keyword">user</span>`;<br><span class="hljs-keyword">CREATE TABLE</span> `<span class="hljs-keyword">user</span>`  (<br>  `user_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">&#x27;用户ID&#x27;</span>,<br>  `user_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">CHARACTER SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="hljs-keyword">NOT NULL</span> COMMENT <span class="hljs-string">&#x27;用户账号&#x27;</span>,<br>  `nick_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">CHARACTER SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="hljs-keyword">NOT NULL</span> COMMENT <span class="hljs-string">&#x27;用户昵称&#x27;</span>,<br>  `email` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">CHARACTER SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;&#x27;</span> COMMENT <span class="hljs-string">&#x27;用户邮箱&#x27;</span>,<br>  `sex` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">CHARACTER SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0&#x27;</span> COMMENT <span class="hljs-string">&#x27;用户性别（0男 1女 2未知）&#x27;</span>,<br>  `avatar` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">CHARACTER SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;&#x27;</span> COMMENT <span class="hljs-string">&#x27;头像地址&#x27;</span>,<br>  `password` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">CHARACTER SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;&#x27;</span> COMMENT <span class="hljs-string">&#x27;密码&#x27;</span>,<br>  `login_ip` <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">CHARACTER SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;&#x27;</span> COMMENT <span class="hljs-string">&#x27;最后登录IP&#x27;</span>,<br>  `login_date` datetime <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;最后登录时间&#x27;</span>,<br>   `text` text <span class="hljs-keyword">CHARACTER SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci COMMENT <span class="hljs-string">&#x27;测试文本&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY KEY</span> (`user_id`) <span class="hljs-keyword">USING</span> BTREE<br>) ENGINE <span class="hljs-operator">=</span> InnoDB AUTO_INCREMENT <span class="hljs-operator">=</span> <span class="hljs-number">2</span> <span class="hljs-keyword">CHARACTER SET</span> <span class="hljs-operator">=</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> <span class="hljs-operator">=</span> utf8mb4_0900_ai_ci COMMENT <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;用户信息表&#x27;</span> ROW_FORMAT <span class="hljs-operator">=</span> <span class="hljs-keyword">Dynamic</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我这里使用nodejs（后边会学）的脚本导入了600万条数据，用来模拟，脚本如下，大家也可以在我们网站自行获取：</p><div class="language-javascript line-numbers-mode" data-ext="js"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight javascript"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 使用 Mock</span><br><span class="hljs-keyword">var</span> <span class="hljs-title class_">Mock</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;mockjs&#x27;</span>)<br><span class="hljs-comment">// mysql8.0需要执行下边的sql，否则nodejs不支持</span><br><span class="hljs-comment">// ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED WITH mysql_native_password BY &#x27;自己的密码&#x27;;</span><br><span class="hljs-keyword">var</span> mysql = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;mysql&#x27;</span>);<br><span class="hljs-comment">// 定义连接池</span><br><span class="hljs-keyword">const</span> pool = mysql.<span class="hljs-title function_">createPool</span>(&#123;<br>    <span class="hljs-attr">host</span>: <span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-comment">// 主机地址</span><br>    <span class="hljs-attr">port</span>: <span class="hljs-number">3306</span>,<br>    <span class="hljs-attr">database</span>: <span class="hljs-string">&quot;ydl&quot;</span>, <span class="hljs-comment">// 数据库名字</span><br>    <span class="hljs-attr">user</span>: <span class="hljs-string">&quot;root&quot;</span>, <span class="hljs-comment">// 连接数据库的用户名</span><br>    <span class="hljs-attr">password</span>: <span class="hljs-string">&quot;root&quot;</span>, <span class="hljs-comment">// 连接数据库密码</span><br>    <span class="hljs-attr">connectionLimit</span>: <span class="hljs-number">30</span>, <span class="hljs-comment">// 连接池最大连接数</span><br>    <span class="hljs-attr">multipleStatements</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 允许执行多条sql语句</span><br>&#125;)<br><br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">insert</span>(<span class="hljs-params">connection</span>) &#123;<br>    <span class="hljs-keyword">let</span> content = <span class="hljs-string">&#x27;&#x27;</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &amp;lt; <span class="hljs-number">100</span>; i++) &#123;<br>        <span class="hljs-comment">// 使用mock.js模拟数据</span><br>        <span class="hljs-keyword">var</span> user = <span class="hljs-title class_">Mock</span>.<span class="hljs-title function_">mock</span>(&#123;<br>            <span class="hljs-attr">userName</span>: <span class="hljs-title class_">Mock</span>.<span class="hljs-title function_">mock</span>(<span class="hljs-string">&#x27;@name(true)&#x27;</span>),<br>            <span class="hljs-attr">nickName</span>: <span class="hljs-title class_">Mock</span>.<span class="hljs-title function_">mock</span>(<span class="hljs-string">&#x27;@cname()&#x27;</span>),<br>            <span class="hljs-attr">email</span>: <span class="hljs-title class_">Mock</span>.<span class="hljs-title function_">mock</span>(<span class="hljs-string">&#x27;@email()&#x27;</span>),<br>            <span class="hljs-attr">sex</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &amp;gt; <span class="hljs-number">0.5</span> ? <span class="hljs-string">&#x27;男&#x27;</span> : <span class="hljs-string">&#x27;女&#x27;</span>,<br>            <span class="hljs-attr">loginIp</span>: <span class="hljs-title class_">Mock</span>.<span class="hljs-title function_">mock</span>(<span class="hljs-string">&#x27;@ip()&#x27;</span>),<br>            <span class="hljs-attr">loginDate</span>: <span class="hljs-title class_">Mock</span>.<span class="hljs-title function_">mock</span>(<span class="hljs-string">&#x27;@datetime()&#x27;</span>),<br>            <span class="hljs-attr">password</span>: <span class="hljs-title class_">Mock</span>.<span class="hljs-title function_">mock</span>(<span class="hljs-string">&#x27;@word(5, 10)&#x27;</span>),<br>            <span class="hljs-attr">avatar</span>: <span class="hljs-title class_">Mock</span>.<span class="hljs-title function_">mock</span>(<span class="hljs-string">&#x27;@url()&#x27;</span>),<br>            <span class="hljs-attr">text</span>: <span class="hljs-title class_">Mock</span>.<span class="hljs-title function_">mock</span>(<span class="hljs-string">&#x27;@cparagraph(30)&#x27;</span>),<br>        &#125;);<br><br>        <span class="hljs-comment">// 每次存入1000条</span><br>        <span class="hljs-keyword">let</span> insertData = <span class="hljs-string">&#x27;(&#x27;</span><br>        <span class="hljs-keyword">for</span> (key <span class="hljs-keyword">in</span> user) &#123;<br>            insertData += <span class="hljs-string">&#x27;\&#x27;&#x27;</span> + user[key] + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> + <span class="hljs-string">&#x27;,&#x27;</span><br>        &#125;<br>        insertData = insertData.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, insertData.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) + <span class="hljs-string">&#x27;)&#x27;</span>;<br>        content += insertData + <span class="hljs-string">&#x27;,&#x27;</span>;<br>    &#125;<br><br>    content = content.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, content.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">let</span> sql = <span class="hljs-string">`insert into user (user_name,</span><br><span class="hljs-string">        nick_name,email,sex,login_ip,login_date,password,avatar,text) values</span><br><span class="hljs-string">        <span class="hljs-subst">$&#123;content&#125;</span>`</span>;<br>    connection.<span class="hljs-title function_">query</span>(sql);<br>    connection.<span class="hljs-title function_">release</span>();<br>&#125;<br><span class="hljs-comment">// 循环60000万次，总计能插入600万条</span><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &amp;lt; <span class="hljs-number">60000</span>; i++)<br> &#123;<br><br>    pool.<span class="hljs-title function_">getConnection</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">err, connection</span>) &#123;<br>        <span class="hljs-comment">// 代码</span><br>        <span class="hljs-title function_">insert</span>(connection)<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;第&#x27;</span>+i+<span class="hljs-string">&#x27;条sql执行成功！&#x27;</span>)<br>    &#125;) <br>&#125;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应的sql文件也准备好了，文件大小1.18G，大家可以自行下载：</p><figure><img alt="image-20220429163430651" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220429163430651-514ed3af.png" tabindex="0"/><figcaption>image-20220429163430651</figcaption></figure><p>准备工作做好之后，我们就可以深入的去学习这些知识了。</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">select count(*) from ydl_user;  -- 5.429<br>select * from ydl_user where user_id = 1000000; -- 0.355s<br>select * from ydl_user where user_name = &#x27;Jennifer Susan Johnson&#x27;;   -- 4.715s<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="一、数据结构" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#一、数据结构">#</a> 一、数据结构</h3><p>一方面mysql的数据是存储在磁盘上的，另一方面还要满足对日常操作如【增删改查】的高效稳定的支持，我们当然可以采用更好的硬件来提升性能，但是选用合适的数据结构也很关键，innodb采用的是一种名为【b+树】的数据结构。</p><p>我们之前已经学习过innodb中的数据是以【行】为单位，存在一个个大小为16k的【页】中，刚才的b+树的作用就是按照一个的组织形式，将所有的【页】组织关联起来。</p><h4 id="_1、b-树" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、b-树">#</a> 1、B-树</h4><p>我们要了解【B+树】，首先要了解一下【B-树】，这里的 B 表示 balance( 平衡的意思)，B-树是一种【多路自平衡的搜索树】，它类似普通的平衡二叉树，不同的一点是B-树允许每个节点有更多的子节点。下图是 B-树的简化图.</p><figure><img alt="image-20220429152229620" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220429152229620-0c8ec149.png" tabindex="0"/><figcaption>image-20220429152229620</figcaption></figure><p>B-树有如下特点:</p><ol><li>所有键值分布在整颗树中；</li><li>任何一个关键字出现且只出现在一个结点中；</li><li>搜索有可能在非叶子结点结束；</li><li>在关键字全集内做一次查找，性能逼近二分查找；</li></ol><h4 id="_2、b-树" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、b-树">#</a> 2、B+树</h4><p>【B+树】是【B-树】的变体，也是一种多路搜索树, 它与 B- 树的不同之处在于:</p><ol><li>所有关键字存储在叶子节点</li><li>为所有叶子结点增加了一个双向指针</li></ol><p>简化 B+树 如下图：</p><figure><img alt="image-20220429152436442" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220429152436442-1eacd588.png" tabindex="0"/><figcaption>image-20220429152436442</figcaption></figure><h4 id="_3、选型缘由" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、选型缘由">#</a> 3、选型缘由</h4><p><strong>问题一：为什么在b-树或b+树中选择？</strong></p><ul><li>mysql数据模型更适合用这类数据结构，一条数据中通常包含【id】+【其他列数据】，我们可以很轻松的根据id组织一颗B+树。</li><li>我们知道innodb使用【页】（这是inndb管理数据的最小单位）保存数据，一页（16k），b+树中的每个节点都是一页数据。</li></ul><p><strong>问题二：为什么选择B+树？</strong></p><ul><li>相同的空间，不存放【整行数据】就能存【更多的id】，b+树能使每个节点能检索的【范围更大、更精确，极大的减少了I/O操作，保证b+树的层高较低，通常3到4层的层高就能支持百万级别的访问】。</li><li>Mysql是一种关系型数据库，【区间访问】是很常见的一种情况，B+树叶节点增加的双向指针，加强了区间访问性，可使用在范围区间查询的情况。</li></ul><h4 id="_4、发现索引" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4、发现索引">#</a> 4、发现索引</h4><p>我们发现当使用id去查询数据时，效率很高，因为使用id可以利用B+树的特性，加速查询，请看以下两条sql的执行效率：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> ydl_user <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>                              <span class="hljs-comment">-- 使用时间0.011s</span><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> ydl_user <span class="hljs-keyword">where</span> email <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;m.szi@xwsrnhp.pl&#x27;</span>          <span class="hljs-comment">-- 使用时间4.284s</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>我们发现，查询相同的记录，使用【id列】比使用【emil列】快了389倍，原因如下：</p><ul><li>使用id列可以利用B+树的特性，由上自下查询。</li><li>使用email列只能从叶子节点进行【全表扫描】，一个一个的比较。</li></ul><p>那么如果我想提升使用其他字段的查询效率，应该怎么做呢？</p><p>首先，我们应该想到的思路就是，按照这个逻辑再给其他的字段也创建一个这样的结构不就好了，如下：</p><figure><img alt="image-20220429114638247" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220429114638247-8094d895.png" tabindex="0"/><figcaption>image-20220429114638247</figcaption></figure><p>但是我们会发现，如果我们不断的创建类似的结构，数据会保存很多次，1个G的数据可以膨胀为5G甚至10G，所以我们可以进行优化，在叶子节点中只【保存id】而不保存全部数据，查到id后再【回表】（回到原来的结构中根据id进行查询）查询整条记录，其结构如下：</p><figure><img alt="image-20220429114616461" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220429114616461-2471a114.png" tabindex="0"/><figcaption>image-20220429114616461</figcaption></figure><p>其实这就是我们日常工作中经常创建的【索引】。</p><h3 id="二、索引的分类和创建" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#二、索引的分类和创建">#</a> 二、索引的分类和创建</h3><h4 id="_1、聚簇索引和非聚簇索引" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、聚簇索引和非聚簇索引">#</a> 1、聚簇索引和非聚簇索引</h4><p>我们在上边的例子中，【主键和数据】共存的索引被称之为【聚簇索引】，其他的，比如我们使用【姓名列+主键】建立的索引，可以称为【非聚簇索引】，或者【辅助索引】，或者【二级索引】，同时聚簇索引只有在innodb引擎中才存在，而在myIsam中是不存在的，如下图：</p><figure><img alt="image-20220513141318848" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220513141318848-e4599efe.png" tabindex="0"/><figcaption>image-20220513141318848</figcaption></figure><p>InnoDB使用的是【聚簇索引】，他会将【主键】组织到一棵B+树中，而【行数据】就储存在叶子节点上，若使用<code>where id = 14</code>这样的条件查找主键，则按照B+树的检索算法即可查找到对应的叶节点，之后获得行数据。</p><p>若对Name列进行条件搜索，且name列已建立【索引】，则需要两个步骤：</p><ul><li>第一步在辅助索引B+树中检索Name，到达其叶子节点获取对应的主键。</li><li>第二步使用主键在主索引B+树种再执行一次B+树检索操作，最终到达叶子节点即可获取整行数据。（重点在于通过其他键需要建立辅助索引）</li></ul><p>如下图：</p><figure><img alt="image-20220429171436220" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220429171436220-e060a1c3.png" tabindex="0"/><figcaption>image-20220429171436220</figcaption></figure><p>MyIsam使用的是【非聚簇索引】，非聚簇索引的两棵B+树看上去没什么不同，节点的结构完全一致只是存储的内容不同而已，主键索引B+树的节点存储了主键，辅助键索引B+树存储了辅助列。表数据存储在独立的地方，这两颗B+树的叶子节点都使用一个【地址指向真正的表数据】，对于表数据来说，这两个键没有任何差别。由于索引树是独立的，通过辅助键检索无需访问主键的索引树。</p><p><strong>tips：</strong></p><ul><li><p>聚簇索引【默认使用主键】，如果表中没有定义主键，InnoDB 会选择一个【唯一且非空】的列代替。如果没有这样的列，InnoDB 会隐式定义一个主键【类似oracle中的RowId】rowid来作为聚簇索引的列。</p></li><li><p>如果涉及到大数据量的排序、全表扫描、count之类的操作的话，还是MyIsam占优势些，因为索引所占空间小，这些操作是需要在内存中完成的。</p></li></ul><p><strong>小问题：主键为什么建议使用自增id?</strong></p><ul><li>主键最好不要使用uuid，因为uuid的值太过离散，不适合排序且可能出现新增加记录的uuid，会插入在索引树中间的位置，出现页分裂，导致索引树调整复杂度变大，消耗更多的时间和资源。</li><li>聚簇索引的数据的物理存放顺序与索引顺序是一致的，即：只要索引是相邻的，那么对应的数据一定也是相邻地存放在磁盘上的。如果主键不是自增id，它会不断地调整数据的物理地址、分页，当然也有其他一些措施来减少这些操作，但却无法彻底避免。但如果是自增的id，它只需要一 页一页地写，索引结构相对紧凑，磁盘碎片少，效率也高。</li></ul><p>本章节中讲述了聚簇索引和二级键索引，对于【二级索引】而言，根据其不同的特性，我们又可以分为普通索引、唯一索引、复合索引等，接下来会一一讲解。</p><h4 id="_2、普通索引-常规索引-normal" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、普通索引-常规索引-normal">#</a> 2、普通索引 （常规索引）(normal)</h4><p>就是普普通通的索引，没有什么特殊要求，理论上任何列都可以当做普通索引，创建方式如下：</p><p>**第一步：**创建索引前先执行下列语句，观察执行时间：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">where</span> user_name <span class="hljs-operator">=</span><span class="hljs-string">&#x27;Dorothy William Harris&#x27;</span>;  <span class="hljs-comment">-- 整个执行时间为4.297s</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>第二步：创建user_name列的索引：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> index idx_user_name <span class="hljs-keyword">on</span> <span class="hljs-keyword">user</span>(user_name);   <span class="hljs-comment">-- 整个索引创建时间为24.502s</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>**结论：**创建索引是一个很费时间的操作。</p><p>**第三步：**再次执行下列语句</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> ydl_user <span class="hljs-keyword">where</span> user_name <span class="hljs-operator">=</span><span class="hljs-string">&#x27;Dorothy William Harris&#x27;</span>;   <span class="hljs-comment">-- 执行时间0.031s</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>**结论：**创建索引后，我们的执行效率提升了138倍。</p><p>**第四部：**删除索引</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">drop</span> index idx_user_name <span class="hljs-keyword">on</span> ydl_user; <br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>其他创建索引的方法，如下：</p><p>（1）创建email列的索引，索引可以截取length长度，只使用这一列的前几个字符</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> index idx_email <span class="hljs-keyword">on</span> <span class="hljs-keyword">user</span>(email(<span class="hljs-number">5</span>));     <span class="hljs-comment">--执行时间16.174s</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p><strong>重点：</strong></p><p>有的列【数据量比较大】，使用前几个字符就能【很快标识】出来一行数据，那我们就可以使用这种方式建立索引，比如我们的邮箱，邮箱很多后缀是相同的我们完全可以忽略。</p><p>（2）使用修改表的方式添加索引</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter table</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">add</span> index idx_email (email);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>（3）建表时时，同时创建索引</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create table</span> tbl_name(<br>    tid <span class="hljs-type">int</span>,<br>    tname <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>),<br>    gender <span class="hljs-type">varchar</span>(<span class="hljs-number">1</span>),<br>    index [indexName] (fieldName(length))<br>)<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3、唯一索引-unique" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、唯一索引-unique">#</a> 3、唯一索引（UNIQUE ）</h4><p>对列的要求：索引列的值不能重复</p><p>创建表的同时，创建索引：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create table</span> tbl_name(<br>    tid <span class="hljs-type">int</span>,<br>    tname <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>),<br>    gender <span class="hljs-type">varchar</span>(<span class="hljs-number">1</span>),<br>    <span class="hljs-keyword">unique</span> index unique_index_tname (tname)<br>)<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>独立的sql语句创建索引，我们的邮箱，用户名就应该创建唯一索引，姓名就应该是普通索引：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">unique</span> index idx_email <span class="hljs-keyword">on</span> <span class="hljs-keyword">user</span>(email);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>通过alter语句添加索引：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">ALTER table</span> mytable <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">UNIQUE</span> [ux_indexName] (username(length))<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>唯一索引和主键的区别：</p><ul><li>唯一索引列允许空值，而主键列不允许为空值。</li><li>主键列在创建时，已经默认为非空值 + 唯一索引了。</li><li>主键可以被其他表引用为外键，而唯一索引不能。</li><li>一个表最多只能创建一个主键，但可以创建多个唯一索引。</li><li>主键更适合那些不容易更改的唯一标识，如自动递增列、身份证号等。</li></ul><p>唯一约束和唯一索引的区别：</p><ul><li>唯一约束和唯一索引，都可以实现列数据的唯一，列值可以为null。</li><li>创建唯一约束，会自动创建一个同名的唯一索引，该索引不能单独删除，删除约束会自动删除索引。唯一约束是通过唯一索引来实现数据唯一。</li><li>创建一个唯一索引，这个索引就是独立的索引，可以单独删除。</li><li>如果一个列上想有约束和索引，且两者可以单独的删除。可以先建唯一索引，再建同名的唯一约束。</li></ul><h4 id="_4、多个二级索引的组合使用" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4、多个二级索引的组合使用">#</a> 4、多个二级索引的组合使用</h4><p><strong>记住一点</strong>：mysql在执行查询语句的时候一般只会使用【一个索引】，除非是使【用or连接的两个索引列】会产生索引合并。</p><p>我们针对某电商平台的检索功能做了优化，添加了三个索引，三个字段分别为【品牌】、【价格】、【销量】这三个的索引结构如下:</p><p><strong>（1）品牌的索引结构：</strong></p><figure><img alt="image-20220517162932935" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220517162932935-819a308c.png" tabindex="0"/><figcaption>image-20220517162932935</figcaption></figure><p><strong>（2）价格的索引结构：</strong></p><figure><img alt="image-20220516145308003" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220516145308003-e5328734.png" tabindex="0"/><figcaption>image-20220516145308003</figcaption></figure><p><strong>（3）销量的索引结构：</strong></p><figure><img alt="image-20220516145354413" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220516145354413-ca508ef0.png" tabindex="0"/><figcaption>image-20220516145354413</figcaption></figure><p>针对以上的索引我们进行如下的查询，分析检索过程：</p><ol><li><p>我们要检索品牌为阿玛尼（Armani）的包包</p><p>**第一步：**通过【品牌索引】检索出所有阿玛尼的商品id，回表查询，得到结果。</p><p>**结论：**会使用一个索引。</p></li><li><p>我们要检索名称为阿玛尼（Armani），价格在1万到3万之间的包包</p><p>查询的步骤如下：</p><p>**第一步：**通过【品牌索引】检索出所有阿玛尼的商品id。</p><p>**第二步：**直接回表扫描，根据剩余条件检索结果。</p><p>**结论：**只会使用第一个索引。</p></li><li><p>我们要检索名称为阿玛尼（Armani），价格为26800，且销量在50以上的包包</p><p>查询的步骤如下：</p><p>**第一步：**通过【品牌索引】检索出所有阿玛尼的商品id，进行缓存。</p><p>**第二步：**直接回表扫描，根据剩余条件检索结果。</p><p>**结论：**只会使用第一个索引。</p></li><li><p>我们要检索名称为阿玛尼（Armani）或名称为LV的包包</p><p>**第一步：**通过【品牌索引】检索出所有阿玛尼的商品id，得到结果。</p><p>**结论：**我们经常听说，有or索引会失效，但是像这样的【type =‘Armani’ or type = ‘LV’】并不会，他相当于一个in关键字，会使用一个索引。</p></li><li><p>我们要检索名称为阿玛尼（Armani）或价格大于8000的包包</p><p>**第一步：**通过【品牌索引】检索出所有阿玛尼的商品id，进行缓存。</p><p>**第二步：**通过【价格索引】检索出价格在5万到7万之间的商品id，这是一个连接条件带有【or的查询】，所以需要和上一步的结果进行【并集】，得到结果。</p><p>**结论：**这个过程叫【索引合并】当检索条件有or但是所有的条件都有索引时，索引不失效，可以走【两个索引】。</p></li><li><p>我们要检索名称为阿玛尼（Armani），且价格大于8000，且【产地（该列无索引）】在北京的包包</p><p>**第一步：**通过【品牌索引】检索出所有阿玛尼的商品id。</p><p>**第二步：**直接回表扫描，根据剩余条件检索结果。</p><p>**结论：**只会使用第一个索引。</p></li><li><p>我们要检索名称为阿玛尼（Armani）或价格大于8000，或【产地（该列无索引）】在北京的包包</p><p>**第一步：**优化器发现【产地列】无索引，同时连接的逻辑是【or】没有办法利用【索引】优化，只能全表扫描，索引失效。</p><p>**结论：**发生全表扫描，索引失效，条件中有没建立索引的列，同时关联条件是or。</p></li></ol><h4 id="_5、复合索引-联合索引-重要" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_5、复合索引-联合索引-重要">#</a> 5、复合索引（联合索引）重要</h4><p>当【查询语句】中包含【多个查询条件，且查询的顺序基本保持一致】时，我们推荐使用复合索引，索引的【组合使用】效率是低于【复合索引】的。</p><p>比如：我们经常按照A列、B列、C列进行查询时，通常的做法是建立一个由三个列共同组成的【复合索引】而不是对每一个列建立【普通索引】。</p><p>创建联合索引的方式如下：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">alert <span class="hljs-keyword">table</span> test <span class="hljs-keyword">add</span> idx_a1_a2_a3 <span class="hljs-keyword">table</span> (a1,a2,a3) <br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 28.531s</span><br><span class="hljs-keyword">create</span> index idx_user_nick_name <span class="hljs-keyword">on</span> ydl_user(user_name,nick_name,email(<span class="hljs-number">7</span>));<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>复合索引的结构如下，复合索引会优先按照第一列排序，第一列相同的情况下会按照第二列排序，以此类推，如下图：</p><figure><img alt="image-20220516130601156" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220516130601156-241ed88b.png" tabindex="0"/><figcaption>image-20220516130601156</figcaption></figure><p>我们不妨把上边的图，转化为下边的表格，看起来会好一些：</p><table><thead><tr><th>品牌</th><th>价格</th><th>销量</th><th>id</th></tr></thead><tbody><tr><td>Armani</td><td>16800</td><td>35</td><td>13,24,76</td></tr><tr><td>Armani</td><td>26800</td><td>35</td><td>12,14,16</td></tr><tr><td>Armani</td><td>26800</td><td>100</td><td>34,56,17</td></tr><tr><td>Armani</td><td>68888</td><td>15</td><td>1,4,5,6,7</td></tr><tr><td>GUCCI</td><td>8999</td><td>135</td><td>78,92</td></tr><tr><td>LV</td><td>9999</td><td>326</td><td>55,63</td></tr><tr><td>LV</td><td>12888</td><td>99</td><td>57,99</td></tr><tr><td>LV</td><td>42888</td><td>69</td><td>11,22</td></tr><tr><td>PRADA</td><td>9588</td><td>125</td><td>111,202</td></tr></tbody></table><p>认真阅读了上边的介绍和图形，我们再次思考以下几个问题：</p><ol><li><p>我们要检索名称为阿玛尼（Armani）的包包</p><p>**第一步：**通过【品牌索引】检索出所有阿玛尼的商品id，回表查询，得到结果。</p><p>**结论：**会使用第一部分索引。</p></li><li><p>我们要检索名称为阿玛尼（Armani），价格在1万到3万之间的包包</p><p>查询的步骤如下：</p><p>**第一步：**通过【品牌索引】检索出所有阿玛尼的叶子节点。</p><p>**第二步：**在【满足上一步条件的叶子节点中】查询价格在1万到3万之间的包包的列，查询出对应的id，回表查询列数据。</p><p>**结论：**会使用复合索引的两个部分。</p></li><li><p>我们要检索名称为阿玛尼（Armani）或价格大于8000的包包</p><p>**第一步：**优化器发现我们并没有一个【价格列】的单独的二级索引，此时要查询价格大于8000的包，必须进行全表扫描。</p><p>**结论：**但凡查询的条件中没有【复合索引的第一部分】，索引直接【失效】，全表扫描。</p></li><li><p>我们要检索名称为阿玛尼（Armani），且价格大于8000，且【产地（该列无索引）】在北京的包包</p><p>**第一步：**通过【品牌索引】检索出所有阿玛尼的叶子节点。</p><p>**第二步：**在【满足上一步条件的叶子节点中】查询价格大于8000元的包包的叶子节点。</p><p>**第三步：**因为【产地列】无索引，但是是【and】的关系，我们只需要将上一步得到的结果回表查询，在这个很小的范围内，检索产地是不是北京即可。</p><p>**结论：**可以使用复合索引的两个部分。</p></li><li><p>我们要检索名称为阿玛尼（Armani）和LV之间，价格为在1万到3万的包包</p><p>查询的步骤如下：</p><p>**第一步：**通过【品牌索引】检索出所有阿玛尼和LV的所有叶子节点。</p><p>**第二步：**我们本想在第一步的结果中，快速定位价格的范围，但是发现一个问题，由于第一步不是等值查询，会导致后边的结果不连续，必须对【上一步的结果】全部遍历，才能拿到对应的结果。</p><p>**结论：**只会使用复合索引的第一个部分，这个就引出了【复合索引中特别重要的一个概念】-【最左前缀原则】。</p></li></ol><p>**重点：**最左前缀原则：</p><p>（1）最左前缀匹配原则，非常重要的原则，mysql会一直向右匹配直到遇到范围查询（&gt;、&lt;、between、like）就停止匹配，比如a = 1 and b = 2 and c &gt; 3 and d = 4 ，如果建立（a,b,c,d）顺序的联合索引，d是用不到索引的，如果建立(a,b,d,c)的索引则都可以用到，a,b,d的顺序可以任意调整。</p><p>（2）=和in可以乱序，比如a = 1 and b &lt; 2 and c = 3 ，咱们建立的索引就可以是（a,c,b）或者（c,a,b）。</p><p>**思考：**为什么联合索引的性能会比索引的组合使用效率高。</p><h4 id="_6、全文索引-fulltext" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_6、全文索引-fulltext">#</a> 6、全文索引（FULLTEXT）</h4><p>做全文检索（不如百度的搜索功能）使用的索引，但是这种场景，我们有更好的替代品，如：ElacticSearch，所以实际使用不多，只当了解。</p><p>使用 like + % 实现的模糊匹配有点类似全文索引。但是对于大量的文本数据检索，全文索引比 like + % 快 N 倍，速度不是一个数量级，但是全文索引可能存在【精度问题】。同时普通索引在使用like时如果%放在首位，索引会失效。</p><blockquote><p>全文索引的版本支持</p></blockquote><ol><li>MySQL 5.6 以前的版本，只有 MyIsam 存储引擎支持全文索引。</li><li>MySQL 5.6 及以后的版本，MyIsam 和 InnoDB 存储引擎均支持全文索引。</li><li>只有字段的数据类型为 char、varchar、text 及其系列才可以建全文索引。</li></ol><blockquote><p>使用全文索引的注意</p></blockquote><ol><li>使用全文索引前，搞清楚版本支持情况。</li><li>全文索引比 like + % 快 N 倍，但是可能存在精度问题。</li><li>如果需要全文索引的是大量数据，建议先添加数据，再创建索引。</li><li>对于中文，可以使用 MySQL 5.7.6 之后的版本，或者第三方插件。</li></ol><p>（1）创建表时创建全文索引</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create table</span> ydlclass_user (    <br>    ..   <br>    FULLTEXT KEY fulltext_text(text)  <br>) <br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）在已存在的表上创建全文索引</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> fulltext index fulltext_text  <span class="hljs-keyword">on</span> ydlclass_user(text);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>本次创建用时143s：</p><figure><img alt="image-20220517172713080" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220517172713080-7a8ee702.png" tabindex="0"/><figcaption>image-20220517172713080</figcaption></figure><p>（3）通过 SQL 语句 ALTER TABLE 创建全文索引</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter table</span> ydlclass_user <span class="hljs-keyword">add</span> fulltext index fulltext_text(text);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>（4）直接使用 DROP INDEX 删除全文索引</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">drop</span> index fulltext index <span class="hljs-keyword">on</span> ydlclass_user;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>（5）全文检索的语法</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> ydlclass_user <span class="hljs-keyword">where</span> <span class="hljs-keyword">match</span>(text) against(<span class="hljs-string">&#x27;高号便法还历只办二主厂向际&#x27;</span>);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><h4 id="_8、hash索引" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_8、hash索引">#</a> 8、hash索引</h4><p>hash索引是Memory存储引擎的默认方式，而且只有memory引擎支持hash索引，memory的数据是放在内存中的，一旦服务关闭，表中的数据就会丢失，我们可以使用如下的sql创建一张表:</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE TABLE</span> `hash_user`  (<br>  `user_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">&#x27;用户ID&#x27;</span>,<br>  `user_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">CHARACTER SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="hljs-keyword">NOT NULL</span> COMMENT <span class="hljs-string">&#x27;用户账号&#x27;</span>,<br>  ......<br>) ENGINE <span class="hljs-operator">=</span> Memory <span class="hljs-keyword">CHARACTER SET</span> <span class="hljs-operator">=</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> <span class="hljs-operator">=</span> utf8mb4_0900_ai_ci COMMENT <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;用户信息表&#x27;</span> ROW_FORMAT <span class="hljs-operator">=</span> <span class="hljs-keyword">Dynamic</span>;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>合理的使用memory引擎可以极大的提升性能，针对memory引擎的特点重启丢失），我们最好在其中存储一些公共的、常用的、不经常发生改变的数据，比如一些字典数据、配置数据等。同时，这些数据最好持久化在一些其他的地方，比如配置文件、其他的表，在程序启动的时候，主动的进行加载，我们可以使用如下sql，将一张表的数据加载到内存中：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert into</span> hash_user <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> ydl_user <span class="hljs-keyword">where</span> user_id <span class="hljs-operator">&amp;</span>lt; <span class="hljs-number">2000000</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>我们在执行的过程种，可能有如下错误：</p><figure><img alt="image-20220517192903131" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/4PwjlY6B.png" tabindex="0"/><figcaption>image-20220517192903131</figcaption></figure><p>他告诉我，这个表使用的内存满了，放不下了，我们只需要调节下边两个参数，修改配置文件重启即可：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">tmp_table_size = 4096M<br>max_heap_table_size = 4096M<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>基础工作完成，写几个sql语句尝试一下，我们发现真的一个字：快。</p><p>我们执行一下的sql</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> hash_user <span class="hljs-keyword">where</span> email <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;i.jnoyelrsg@rpnglcvh.museum&#x27;</span>  <span class="hljs-comment">-- 0.189s</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>创建一个hash索引</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> index hash_idx_user_name <span class="hljs-keyword">using</span> hash <span class="hljs-keyword">on</span> hash_user(email);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>再次查询</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> hash_user <span class="hljs-keyword">where</span> email <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;i.jnoyelrsg@rpnglcvh.museum&#x27;</span>  <span class="hljs-comment">-- 0.017s</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>也有不错的效果。</p><p>关于hash索引需要了解的几点：</p><ul><li>hash是一种key-value形式的数据结构。实现一般是数组+链表的结构，通过hash函数计算出key在数组中的位置，然后如果出现hash冲突就通过链表来解决。当然还有其他的解决hash冲突的方法。hash这种数据结构是很常用的，比如我们系统使用HashMap来构建热点数据缓存，存取效率很好。</li><li>即使是相近的key，hash的取值也完全没有规律，索引hash索引不支持范围查询。</li><li>hash索引存储的是hash值和行指针，所以通过hash索引查询数据需要进行两次查询（首先查询行的位置，然后找到具体的数据）。</li><li>hash索引查询数据的前提就是计算hash值，也就是要求key为一个能准确指向一条数据的key，所以对于like等一类的匹配查询是不支持的。</li><li>只要是只需要做等值比较查询，而不包含排序或范围查询的需求，都适合使用哈希索引。</li></ul><h4 id="_7、空间索引-spatial" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_7、空间索引-spatial">#</a> 7、空间索引（SPATIAL）</h4><p>MySQL在5.7之后的版本支持了空间索引，而且支持OpenGIS几何数据模型。这是在地理位置领域使用的一种索引，其他场景用的很少，所以不需要深入学习。</p><h3 id="三、explain的用法" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#三、explain的用法">#</a> 三、explain的用法</h3><p>explain关键字可以模拟MySQL优化器执行SQL语句，可以很好的分析SQL语句或表结构的性能瓶颈。</p><p>explain的使用很简单，只需要在目标sql前加上这个关键字就可以了：</p><figure><img alt="image-20220513190241307" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220513190241307-0f115ff8.png" tabindex="0"/><figcaption>image-20220513190241307</figcaption></figure><p><strong>执行explain会产生以下11列内容，如下：</strong></p><table><thead><tr><th>列号</th><th>列</th><th>说明</th></tr></thead><tbody><tr><td>1</td><td>id</td><td>select查询的序列号，包含一组数字，表示查询中执行select子句或操作表的顺序</td></tr><tr><td>2</td><td>select_type</td><td>查询类型</td></tr><tr><td>3</td><td>table</td><td>正在访问哪个表</td></tr><tr><td>4</td><td>partitions</td><td>匹配的分区</td></tr><tr><td>5</td><td>type</td><td>/访问的类型</td></tr><tr><td>6</td><td>possible_keys</td><td>显示可能应用在这张表中的索引，一个或多个，但不一定实际使用到</td></tr><tr><td>7</td><td>key</td><td>实际使用到的索引，如果为NULL，则没有使用索引</td></tr><tr><td>8</td><td>key_len</td><td>表示索引中使用的字节数，可通过该列计算查询中使用的索引的长度</td></tr><tr><td>9</td><td>ref</td><td>显示索引的哪一列被使用了，如果可能的话，是一个常数，哪些列或常量被用于查找索引列上的值</td></tr><tr><td>10</td><td>rows</td><td>根据表统计信息及索引选用情况，大致估算出找到所需的记录所需读取的行数 filtered //查询的表行占表的百分比</td></tr><tr><td>11</td><td>filtered</td><td>查询的表行占表的百分比</td></tr><tr><td>12</td><td>Extra</td><td>包含不适合在其它列中显示但十分重要的额外信息</td></tr></tbody></table><h4 id="_1、id字段" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、id字段">#</a> 1、id字段</h4><p>select查询的序列号，包含一组数字，表示查询中执行select子句或操作表的顺序</p><p>（1） id相同</p><p>id如果相同，可以认为是一组，执行顺序从上至下，如下查询语句：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> student s, scores sc <span class="hljs-keyword">where</span> s.id <span class="hljs-operator">=</span> sc.s_id<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img alt="image-20220516175632471" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220516175632471-aec555f3.png" tabindex="0"/><figcaption>image-20220516175632471</figcaption></figure><p>（2） id不同</p><p>如果是子查询，id的序号会递增，id的值越大优先级越高，越先被执行例子</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> student <span class="hljs-keyword">where</span> age <span class="hljs-operator">&amp;</span>gt; (<br>    <span class="hljs-keyword">select</span> age <span class="hljs-keyword">from</span> student <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;连宇栋&#x27;</span><br>);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img alt="image-20220516180258900" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220516180258900-0f568bab.png" tabindex="0"/><figcaption>image-20220516180258900</figcaption></figure><p>（3）id部分相同部分不同</p><p>id如果相同，可以认为是一组，从上往下顺序执行在所有组中，id值越大，优先级越高，越先执行例子：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> student s, scores sc <span class="hljs-keyword">where</span> s.id <span class="hljs-operator">=</span> sc.s_id<br><span class="hljs-keyword">union</span><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> student s, scores sc <span class="hljs-keyword">where</span> s.id <span class="hljs-operator">=</span> sc.s_id;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img alt="image-20220516180459139" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220516180459139-b4df1b84.png" tabindex="0"/><figcaption>image-20220516180459139</figcaption></figure><h4 id="_2、select-type字段" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、select-type字段">#</a> 2、select_type字段</h4><p><strong>（1）SIMPLE</strong></p><p>简单查询，不包含子查询或Union查询的sql语句。</p><p><strong>（2）PRIMARY</strong></p><p>查询中若包含任何复杂的子部分，最外层查询则被标记为主查询。</p><p><strong>（3） SUBQUERY</strong></p><p>在select或where中包含子查询。</p><p><strong>（4）UNION</strong></p><p>若第二个select出现在uion之后，则被标记为UNION。</p><p><strong>（6）UNION RESULT</strong></p><p>从UNION表获取结果的合并操作。</p><h4 id="_3、type字段" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、type字段">#</a> 3、type字段</h4><p>最好到最差备注：掌握以下10种常见的即可NULL&gt;system&gt;const&gt;eq_ref&gt;ref&gt;ref_or_null&gt;index_merge&gt;range&gt;index&gt;ALL</p><p><strong>（1） NULL</strong></p><p>MySQL能够在优化阶段分解查询语句，在执行阶段用不着再访问表或索引，比如通过id没有找到例子：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-built_in">min</span>(id) <span class="hljs-keyword">from</span> student;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img alt="image-20220516180830093" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220516180830093-f1e439bd.png" tabindex="0"/><figcaption>image-20220516180830093</figcaption></figure><p><strong>（2）system</strong></p><p>表只有一行记录（等于系统表），这是const类型的特列，平时不大会出现，可以忽略，我也没有实测出来。</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">explain select * from mysql.proxies_priv<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>我实测一个只有一行记录的系统表，同样是all。</p><figure><img alt="image-20220518115948496" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220518115948496-44153fd6.png" tabindex="0"/><figcaption>image-20220518115948496</figcaption></figure><p><strong>（3） const</strong></p><p>表示通过索引一次就找到了，const用于比较primary key或uique索引，因为只匹配一行数据，所以很快，如主键置于where列表中，MySQL就能将该查询转换为一个常量例子：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> student <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img alt="image-20220516181115548" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220516181115548-7e73b3f8.png" tabindex="0"/><figcaption>image-20220516181115548</figcaption></figure><p><strong>4. eq_ref</strong></p><p>唯一性索引扫描，对于每个索引键，表中只有一条记录与之匹配，常见于主键或唯一索引扫描例子：</p><p>被驱动表使用主键索面，结果唯一</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> scores sc <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> student s <span class="hljs-keyword">on</span> s.id <span class="hljs-operator">=</span> sc.s_id<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img alt="image-20220516183031354" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220516183031354-2de188ef.png" tabindex="0"/><figcaption>image-20220516183031354</figcaption></figure><p><strong>5. ref</strong></p><p>非唯一性索引扫描，返回匹配某个单独值的所有行，本质上也是一种索引访问，返回所有匹配某个单独值的行，然而可能会找到多个符合条件的行，应该属于查找和扫描的混合体例子：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> student <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;白杰&#x27;</span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> student s <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> scores sc <span class="hljs-keyword">on</span> s.id <span class="hljs-operator">=</span> sc.s_id<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img alt="image-20220516183118398" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220516183118398-d08c2df6.png" tabindex="0"/><figcaption>image-20220516183118398</figcaption></figure><p><strong>6. ref_or_null</strong></p><p>类似ref，但是可以搜索值为NULL的行例子：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> student s <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;白杰&#x27;</span> <span class="hljs-keyword">or</span> name <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img alt="image-20220516183229589" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220516183229589-daa35de1.png" tabindex="0"/><figcaption>image-20220516183229589</figcaption></figure><p><strong>7. index_merge</strong></p><p>表示使用了索引合并的优化方法例子：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">explain select * from student where id = 1 or name =&#x27;李兴&#x27;;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img alt="image-20220516181626267" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220516181626267-12ca24b4.png" tabindex="0"/><figcaption>image-20220516181626267</figcaption></figure><p><strong>8. range</strong></p><p>只检索给定范围的行，使用一个索引来选择行，key列显示使用了哪个索引一般就是在你的where语句中出现between、&lt;&gt;、in等的查询。例子：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">explain select * from student where id between 4 and 7;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img alt="image-20220516181716830" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220516181716830-9c6ab949.png" tabindex="0"/><figcaption>image-20220516181716830</figcaption></figure><p><strong>9. index</strong>（全索引扫描）</p><p>Full index Scan，Index与All区别：index只遍历索引树，通常比All快因为索引文件通常比数据文件小，也就是虽然all和index都是读全表，但index是从索引中读取的，而all是从硬盘读的。例子：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">explain select name from student;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img alt="image-20220516181813844" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220516181813844-c49ee252.png" tabindex="0"/><figcaption>image-20220516181813844</figcaption></figure><p><strong>10. ALL</strong>（全表扫）</p><p>Full Table Scan，将遍历全表以找到匹配行例子：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">explain select * from student;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img alt="image-20220516181840924" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220516181840924-dcb02ba6.png" tabindex="0"/><figcaption>image-20220516181840924</figcaption></figure><h4 id="_4、table字段" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4、table字段">#</a> 4、table字段</h4><p>表示数据来自哪张表</p><h4 id="_5、possible-keys字段" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_5、possible-keys字段">#</a> 5、possible_keys字段</h4><p>显示可能应用在这张表中的索引，一个或多个查询涉及到的字段若存在索引，则该索引将被列出，但不一定被实际使用</p><h4 id="_6、key字段" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_6、key字段">#</a> 6、key字段</h4><p>实际使用到的索引，如果为NULL，则没有使用索引查询中若使用了覆盖索引（查询的列刚好是索引），则该索引仅出现在key列表</p><h4 id="_7、key-len字段" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_7、key-len字段">#</a> 7、key_len字段</h4><p>表示索引中使用的字节数，可通过该列计算查询中使用的索引的长度在不损失精确度的情况下，长度越短越好key_len显示的值为索引字段最大的可能长度，并非实际使用长度即key_len是根据定义计算而得，不是通过表内检索出的</p><h4 id="_8、ref字段" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_8、ref字段">#</a> 8、ref字段</h4><p>哪些列或常量被用于查找索引列上的值</p><h4 id="_9、rows字段" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_9、rows字段">#</a> 9、rows字段</h4><p>根据表统计信息及索引选用情况，大致估算出找到所需的记录所需读取的行数</p><h4 id="_10、partitions字段" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_10、partitions字段">#</a> 10、partitions字段</h4><p>匹配的分区</p><h4 id="_11、filtered字段" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_11、filtered字段">#</a> 11、filtered字段</h4><p>它指返回结果的行占需要读到的行(rows列的值)的百分比</p><h4 id="_12、extra字段" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_12、extra字段">#</a> 12、Extra字段</h4><p>该列包含不适合在其它列中显示，但十分重要的额外信息，我们列举几个例子：</p><p><strong>（1）Using filesort</strong></p><p>只要使用非索引字段排序，就会出现这样的内容。</p><p><strong>（2）Using temporary</strong></p><p>使用了临时表保存中间结果，MySQL在对结果排序时使用临时表，常见于排序order by 和分组查询group by例子：</p><p><strong>（3）Using where</strong></p><p>使用了where条件例子：</p><p><strong>（4）impossible where</strong></p><p>where子句的值总是false，不能用来获取任何数据：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">explain select * from student where name = &#x27;白洁&#x27; and name = &#x27;李兴&#x27;;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img alt="image-20220516182510228" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220516182510228-1803ac6c.png" tabindex="0"/><figcaption>image-20220516182510228</figcaption></figure><p><strong>（5）Select tables optimized away</strong></p><p>SELECT操作已经优化到不能再优化了（MySQL根本没有遍历表或索引就返回数据了）例子：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-built_in">min</span>(id) <span class="hljs-keyword">from</span> student;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img alt="image-20220516182125161" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220516182125161-920194f5.png" tabindex="0"/><figcaption>image-20220516182125161</figcaption></figure><p><strong>（6）no matching row in const table</strong></p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">explain select * from student where id &amp;lt; 100 and id &amp;gt; 200;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img alt="image-20220516182318832" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220516182318832-7e012d1a.png" tabindex="0"/><figcaption>image-20220516182318832</figcaption></figure><h3 id="三、使用索引的问题" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#三、使用索引的问题">#</a> 三、使用索引的问题</h3><p>设计好MySql的索引可以让你的数据库飞起来。但是，不合理的创建索引同样会产生很多问题？我们在设计MySql索引的时候有一下几点注意：</p><h4 id="_1、哪些情况下适合建索引" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、哪些情况下适合建索引">#</a> 1、哪些情况下适合建索引</h4><ul><li>频繁作为where条件语句查询的字段</li><li>关联字段需要建立索引</li><li>分组，排序字段可以建立索引</li><li>统计字段可以建立索引，例如count()，max()等</li></ul><p><strong>小案例</strong>：还记得在学习临时表时，分析过group by的执行流程吗（分组字段没有索引）？有了索引之后的分组执行流程如下：</p><figure><img alt="image-20220512173224645" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220512173224645-3b81778d.png" tabindex="0"/><figcaption>image-20220512173224645</figcaption></figure><p>直接使用索引信息，统计每个组的人数，直接返回。</p><h4 id="_2、哪些情况下不适合建索引" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、哪些情况下不适合建索引">#</a> 2、哪些情况下不适合建索引</h4><ul><li><p>频繁更新的字段不适合建立索引</p></li><li><p>where条件中用不到的字段不适合建立索引</p></li><li><p>表数据可以确定比较少的不需要建索引</p></li><li><p>数据重复且发布比较均匀的的字段不适合建索引（唯一性太差的字段不适合建立索引），例如性别，真假值</p></li><li><p>参与列计算的列不适合建索引，索引会失效</p></li></ul><h4 id="_3、能用复合索引的要使用复合索引" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、能用复合索引的要使用复合索引">#</a> 3、能用复合索引的要使用复合索引</h4><h4 id="_4、null值也是可以走索引的-他被处理成最小值放在b-树的最左侧" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4、null值也是可以走索引的-他被处理成最小值放在b-树的最左侧">#</a> 4、null值也是可以走索引的，他被处理成最小值放在b+树的最左侧</h4><h4 id="_5、使用短索引" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_5、使用短索引">#</a> 5、使用短索引</h4><p>对字符串的列创建索引，如果可能，应该指定一个前缀长度。例如，如果有一个CHAR(255)的 列，如果在前10 个或20 个字符内，多数值是惟一的，那么就不要对整个列进行索引。短索引不仅可以提高查询速度而且可以节省磁盘空间和I/O操作。</p><h4 id="_6-排序的索引问题" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_6-排序的索引问题">#</a> 6，排序的索引问题</h4><p>mysql查询只使用一个索引，因此如果where子句中已经使用了索引的话，那么order by中的列是不会使用索引的。因此数据库默认排序可以符合要求的情况下不要使用排序操作；尽量不要包含多个列的排序，如果需要，最好给这些列创建<code>复合索引</code>。</p><h4 id="_7、mysql索引失效的几种情况" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_7、mysql索引失效的几种情况">#</a> 7、MySQL索引失效的几种情况</h4><ul><li>如果条件中有or，即使其中有条件带索引也不会使用走索引，除非全部条件都有索引</li><li>复合索引不满足最左原则就不能使用全部索引</li><li>like查询以%开头</li><li>存在列计算</li></ul><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">explain select * from student where age = (18-1)<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><ul><li>如果mysql估计使用全表扫描要比使用索引快，则不使用索引，比如结果的量很大</li><li>存在类型转化</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 索引不失效</span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> student <span class="hljs-keyword">where</span> age <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;18&#x27;</span>  <br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> ydl_user <span class="hljs-keyword">where</span> login_date <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-05-31 17:20:54&#x27;</span><br><span class="hljs-comment">-- 索引失效 本来是字符串，你使用数字和他比较</span><br>explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> student <span class="hljs-keyword">where</span> gander <span class="hljs-operator">=</span> <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img alt="image-20220518183149811" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220518183149811-7d62b011.png" tabindex="0"/><figcaption>image-20220518183149811</figcaption></figure><figure><img alt="image-20220518183122831" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220518183122831-b15ccfd6.png" tabindex="0"/><figcaption>image-20220518183122831</figcaption></figure><h2 id="第七章-锁机制" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第七章-锁机制">#</a> 第七章 锁机制</h2><p>锁是为了保证数据库中数据的一致性，使各种【共享资源】在被访问时变得【有序】而设计的一种规则。</p><p>MysQL中不同的存储引擎支持不同的锁机制。 InoDB支持【行锁】，有时也会升级为表锁，MyIsam只支持表锁。</p><ul><li><p>【表锁】的特点就是开销小、加锁快，不会出现死锁。锁粒度大，发生锁冲突的概率小，并发度相对低。</p></li><li><p>【行锁】的特点就是开销大、加锁慢，会出现死锁。锁粒度小，发生锁冲突的概率高，并发度高。</p><p>今天我们讲锁主要从InnoDB引擎来讲，因为它既支持行锁、也支持表锁。</p></li></ul><h3 id="一、innodb的锁类型" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#一、innodb的锁类型">#</a> 一、InnoDB的锁类型</h3><p>InnoDB的锁类型主要有读锁(共享锁)、写锁(排他锁)、意向锁和MDL锁。</p><h4 id="_1、s锁" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、s锁">#</a> 1、s锁</h4><p>读锁（共享锁，shared lock）简称S锁。一个事务获取了一个数据行的读锁，其他事务也能获得该行对应的读锁，但不能获得写锁，即一个事务在读取一个数据行时，其他事务也可以读，但不能对该数行增删改的操作。</p><p>**注：**读锁是共享锁，多个事务可以同时持有，当有一个或多个事务持有共享锁时，被锁的数据就不能修改。</p><p>简而言之：就是可以多个事务读，但只能一个事务写。</p><p>读锁是通过【select.... lock in share mode】语句给被读取的行记录或行记录的范围上加一个读锁,让其他事务可以读，但是要想申请加写锁，那就会被阻塞。</p><p>事务一：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">begin</span>;<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> ydl_student <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span> lock <span class="hljs-keyword">in</span> share mode;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>事务二：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">begin</span>;<br><span class="hljs-keyword">update</span> ydl_student <span class="hljs-keyword">set</span> score <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;90&#x27;</span> <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>卡住了，说明程序被阻塞，确实加了锁。</p><figure><img alt="image-20220517195919549" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220517195919549-32b88fda.png" tabindex="0"/><figcaption>image-20220517195919549</figcaption></figure><p>s锁是可以被多个事务同时获取的，我们在两个不同的事务中分别对同一行数据加上s锁，结果都可以成功，如下图：</p><figure><img alt="image-20220517202512738" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220517202512738-401cab24.png" tabindex="0"/><figcaption>image-20220517202512738</figcaption></figure><h4 id="_2、x锁" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、x锁">#</a> 2、x锁</h4><p>写锁，也叫排他锁，或者叫独占所，简称x锁（exclusive）。一个事务获取了一个数据行的写锁，既可以读该行的记录，也可以修改该行的记录。但其他事务就不能再获取该行的其他任何的锁，包括s锁，直到当前事务将锁释放。【这保证了其他事务在当前事务释放锁之前不能再修改数据】。</p><p>**注：**写锁是独占锁，只有一个事务可以持有，当这个事务持有写锁时，被锁的数据就不能被其他事务修改。</p><p>（1）一些DML语句的操作都会对行记录加写锁。</p><p>事务一：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">begin</span>;<br><span class="hljs-keyword">update</span> ydl_student <span class="hljs-keyword">set</span> score <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;90&#x27;</span> <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>事务二：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">begin</span>;<br><span class="hljs-keyword">update</span> ydl_student <span class="hljs-keyword">set</span> score <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;88&#x27;</span> <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>卡住了，说明程序被阻塞，确实加了锁。但是，我们发现其他事务还能读，有点不符合逻辑，这是应为mysql实现了MVCC模型，后边会详细介绍。</p><p>（2）比较特殊的就是select for update，它会对读取的行记录上加一个写锁，那么其他任何事务不能对被锁定的行上加任何锁了，要不然会被阻塞。</p><p>事务一：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">begin</span>;<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> ydl_student <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> <span class="hljs-keyword">update</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>事务二：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">begin</span>;<br><span class="hljs-keyword">update</span> teacher <span class="hljs-keyword">set</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;lucy2&#x27;</span> <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>卡住了，说明加了锁了。</p><p>（3）x锁是只能被一个事务获取，我们在两个不同的事务中分别对同一行数据加上x锁，发现后者会被阻塞，如下图：</p><figure><img alt="image-20220517202800421" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220517202800421-b9a51153.png" tabindex="0"/><figcaption>image-20220517202800421</figcaption></figure><h4 id="_3、记录锁-record-lock" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、记录锁-record-lock">#</a> 3、记录锁（Record Lock）</h4><p>记录锁就是我们常说的行锁，只有innodb才支持，我们使用以下四个案例来验证记录锁的存在：</p><p>（1）两个事务修改【同一行】记录，该场景下，where条件中的列不加索引。</p><p>事务一：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">begin</span>;<br><span class="hljs-keyword">update</span> ydl_student <span class="hljs-keyword">set</span> score <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;77&#x27;</span> <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;jack&#x27;</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>事务二：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">begin</span>;<br><span class="hljs-keyword">update</span> ydl_student <span class="hljs-keyword">set</span> score <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;80&#x27;</span> <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;jack&#x27;</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>发现事务二卡住了，只有事务一提交了，事务二才能继续执行，很明显，这一行数据被【锁】住了。</p><p>（2）两个事务修改同表【不同行】记录，此时where条件也不加索。</p><p>事务一：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">begin</span>;<br><span class="hljs-keyword">update</span> ydl_student <span class="hljs-keyword">set</span> score <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;76&#x27;</span> <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;hellen&#x27;</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>事务二：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">begin</span>;<br><span class="hljs-keyword">update</span> ydl_student <span class="hljs-keyword">set</span> score <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;66&#x27;</span> <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;jack&#x27;</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>现事务二卡住了，只有事务一提交了，事务二才能继续执行，很明显，表被【锁】住了。</p><p>（3）两个事务修改【同一行】记录，where条件加索引</p><p>事务一：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">begin</span>;<br><span class="hljs-keyword">update</span> ydl_student <span class="hljs-keyword">set</span> score <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;99&#x27;</span> <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;jack&#x27;</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>事务二：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">begin</span>;<br><span class="hljs-keyword">update</span> ydl_student <span class="hljs-keyword">set</span> score <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;79&#x27;</span> <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;jack&#x27;</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>现事务二卡住了，只有事务一提交了，事务二才能继续执行，很明显，这一行数据被【锁】住了。</p><p>（4）两个事务修改同表【不同行】记录，此时where条件加索。</p><p>事务一：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">begin</span>;<br><span class="hljs-keyword">update</span> ydl_student <span class="hljs-keyword">set</span> score <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;77&#x27;</span> <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;hellen&#x27;</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>事务二：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">begin</span>;<br><span class="hljs-keyword">update</span> ydl_student <span class="hljs-keyword">set</span> score <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;77&#x27;</span> <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;jack&#x27;</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>发现都可以顺利修改，说明锁的的确是行。</p><p>**证明：**行锁是加在索引上的，这是标准的行级锁。</p><h4 id="_4、间隙锁-gap-lock" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4、间隙锁-gap-lock">#</a> 4、间隙锁（GAP Lock）</h4><p>间隙锁帮我们解决了mysql在rr级别下的一部分幻读问题。间隙锁锁定的是记录范围，不包含记录本身，也就是不允许在某个范围内插入数据。</p><p>间隙锁生成的条件：</p><p>1、A事务使用where进行范围检索时未提交事务，此时B事务向A满足检索条件的范围内插入数据。</p><p>2、where条件必须有索引。</p><p>第一步把teacher表的id的4改成8</p><p>事务一：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">begin</span>;<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> ydl_student <span class="hljs-keyword">where</span> id <span class="hljs-keyword">between</span> <span class="hljs-number">3</span> <span class="hljs-keyword">and</span> <span class="hljs-number">7</span> lock <span class="hljs-keyword">in</span> share mode;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>事务二：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">begin</span>;<br><span class="hljs-keyword">insert into</span> ydl_student <span class="hljs-keyword">values</span> (<span class="hljs-number">5</span>,<span class="hljs-string">&#x27;tom&#x27;</span>,<span class="hljs-number">66</span>,<span class="hljs-string">&#x27;d&#x27;</span>);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>发现卡住了，第一个事务会将id在3到7之间的数据全部锁定，不允许在缝隙间插入。</p><p>事务三：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">begin</span>;<br><span class="hljs-keyword">insert into</span> ydl_student <span class="hljs-keyword">values</span> (<span class="hljs-number">11</span>,<span class="hljs-string">&#x27;tom&#x27;</span>,<span class="hljs-number">66</span>,<span class="hljs-string">&#x27;d&#x27;</span>);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>插入一个id为11的数据，竟然成功了，因为11不在事务一的检索的范围。</p><h4 id="_5、记录锁和间隙锁的组合-next-key-lock" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_5、记录锁和间隙锁的组合-next-key-lock">#</a> 5、记录锁和间隙锁的组合（next-key lock）</h4><p><strong>临键锁</strong>，是<strong>记录锁与间隙锁的组合</strong>，它的封锁范围，既包含【索引记录】，又包含【索引区间】。</p><p><strong>注：<strong>临键锁的主要目的，也是为了避免</strong>幻读</strong>(Phantom Read)。如果把事务的隔离级别降级为RC，临键锁则也会失效。</p><h4 id="_6、mdl锁" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_6、mdl锁">#</a> 6、MDL锁</h4><p>MySQL 5.5引入了meta data lock，简称MDL锁，用于保证表中<code>元数据</code>的信息。在会话A中，表开启了查询事务后，会自动获得一个MDL锁，会话B就不可以执行任何DDL语句，不能执行为表中添加字段的操作，会用MDL锁来保证数据之间的一致性。</p><p>元数据就是描述数据的数据，也就是你的表结构。意识是在你开启了事务之后获得了意向锁，其他事务就不能更改你的表结构。MDL锁都是为了防止在事务进行中，执行DDL语句导致数据不一致。</p><h4 id="_7、死锁问题" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_7、死锁问题">#</a> 7、死锁问题</h4><p>发生死锁的<strong>必要条件</strong>有4个，分别为互斥条件、不可剥夺条件、请求与保持条件和循环等待条件：</p><ul><li><strong>互斥条件</strong>，在一段时间内，计算机中的某个资源只能被一个进程占用。此时，如果其他进程请求该资源，则只能等待。</li><li><strong>不可剥夺条件</strong>，某个进程获得的资源在使用完毕之前，不能被其他进程强行夺走，只能由获得资源的进程主动释放。</li><li><strong>请求与保持条件</strong>，进程已经获得了至少一个资源，又要请求其他资源，但请求的资源已经被其他进程占有，此时请求的进程就会被阻塞，并且不会释放自己已获得的资源。</li><li><strong>循环等待条件</strong>，系统中的进程之间相互等待，同时各自占用的资源又会被下一个进程所请求。例如有进程A、进程B和进程C三个进程，进程A请求的资源被进程B占用，进程B请求的资源被进程C占用，进程C请求的资源被进程A占用，于是形成了循环等待条件，如图1-7所示。</li></ul><p>我模拟了一个死锁场景，如下：</p><figure><img alt="image-20220517205641323" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220517205641323-59d24a58.png" tabindex="0"/><figcaption>image-20220517205641323</figcaption></figure><p>InnoDB使用的是行级锁，在某种情况下会产生死锁问题，所以InnoDB存储引擎采用了一种叫作<strong>等待图</strong>（wait-for graph）的方法来自动检测死锁，如果发现死锁，就会自动回滚一个事务。</p><figure><img alt="image-20220517205123881" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220517205123881-a8b4a1ca.png" tabindex="0"/><figcaption>image-20220517205123881</figcaption></figure><p><strong>在MySQL中，通常通过以下几种方式来避免死锁。</strong></p><ul><li>尽量让数据表中的数据检索都通过索引来完成，避免无效索引导致行锁升级为表锁。</li><li>合理设计索引，尽量缩小锁的范围。</li><li>尽量减少查询条件的范围，尽量避免间隙锁或缩小间隙锁的范围。</li><li>尽量控制事务的大小，减少一次事务锁定的资源数量，缩短锁定资源的时间。如果一条SQL语句涉及事务加锁操作，则尽量将其放在整个事务的最后执行。</li></ul><h3 id="二、表锁" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#二、表锁">#</a> 二、表锁</h3><p>1、对于InnoDB表，在绝大部分情况下都应该使用【行级锁】，因为事务和行锁往往是我们之所以选择InnoDB表的理由。但在个另特殊事务中，也可以考虑使用表级锁。</p><ul><li><p>第一种情况是：事务需要更新【大部分或全部数据】，表又比较大，如果使用默认的行锁，不仅这个事务执行效率低，而且可能造成其他事务长时间锁等待和锁冲突，这种情况下可以考虑使用表锁来提高该事务的执行速度。</p></li><li><p>第二种情况是：事务涉及多个表，比较复杂，很可能引起死锁，造成大量事务回滚。这种情况也可以考虑一次性锁定事务涉及的表，从而避免死锁、减少数据库因事务回滚带来的开销。</p></li></ul><p>2、在InnoDB下 ，主动上表锁的方式如下：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">lock tables teacher write,student read;<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> teacher;<br><span class="hljs-keyword">commit</span>;<br>unlock tables;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用时有几点需要额外注意：</p><ul><li><p>使用【LOCK TALBES】虽然可以给InnoDB加表级锁，但必须说明的是，表锁不是由InnoDB存储引擎层管理的，而是由其上一层ＭySQL Server负责的，仅当autocommit=0、innodb_table_lock=1（默认设置）时，InnoDB层才能感知MySQL加的表锁，ＭySQL Server才能感知InnoDB加的行锁，这种情况下，InnoDB才能自动识别涉及表级锁的死锁；否则，InnoDB将无法自动检测并处理这种死锁。</p></li><li><p>在用LOCAK TABLES对InnoDB加锁时要注意，事务结束前，不要用UNLOCAK TABLES释放表锁，因为UNLOCK TABLES会隐含地提交事务；COMMIT或ROLLBACK不能释放用LOCAK TABLES加的表级锁，必须用UNLOCK TABLES释放表锁，正确的方式见如下语句。</p></li><li><p>表锁的力度很大，慎用。</p></li></ul><h3 id="三、从另一个角度区分锁的分类" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#三、从另一个角度区分锁的分类">#</a> 三、从另一个角度区分锁的分类</h3><h4 id="_1、乐观锁" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、乐观锁">#</a> 1、乐观锁</h4><p>乐观锁大多是基于数据【版本记录机制】实现，一般是给数据库表增加一个"version"字段。</p><p>读取数据时，将此版本号一同读出，</p><p>更新时，对此版本号加一。此时将提交数据的版本数据与数据库表对应记录的当前版本信息进行比对，如果提交的数据版本号大于数据库表当前版本号，则予以更新，否则认为是过期数据。</p><p>事务一：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">select * from ydl_student where id = 1;<br><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>事务二：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> ydl_student <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><span class="hljs-keyword">update</span> ydl_student <span class="hljs-keyword">set</span> score <span class="hljs-operator">=</span> <span class="hljs-number">99</span>,version <span class="hljs-operator">=</span> version <span class="hljs-operator">+</span> <span class="hljs-number">1</span> <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> version <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><span class="hljs-keyword">commit</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>事务一：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">update</span> ydl_student <span class="hljs-keyword">set</span> score <span class="hljs-operator">=</span> <span class="hljs-number">100</span>,version <span class="hljs-operator">=</span> version <span class="hljs-operator">+</span> <span class="hljs-number">1</span> <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> version <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><span class="hljs-keyword">commit</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>发现更新失败，应为版本号被事务二、提前修改了，这使用了不加锁的方式，实现了一个事务修改期间，禁止其他事务修改的能力。</p><h4 id="_2、悲观锁" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、悲观锁">#</a> 2、悲观锁</h4><p>总有刁民想害朕</p><p>悲观锁依靠数据库提供的锁机制实现。MySQL中的共享锁和排它锁都是悲观锁。数据库的增删改操作默认都会加排他锁，而查询不会加任何锁。此处不赘述。</p><h2 id="第八章-日志系统" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第八章-日志系统">#</a> 第八章 日志系统</h2><p>mysql给我们提供了很多有用的日志，这是mysql服务层给我们提供的：</p><table><thead><tr><th>日志类型</th><th>写入日志的信息</th></tr></thead><tbody><tr><td>二进制日志</td><td>记录了对MySQL数据库执行更改的所有操作</td></tr><tr><td>慢查询日志</td><td>记录所有执行时间超过 long_query_time 秒的所有查询或不使用索引的查询</td></tr><tr><td>错误日志</td><td>记录在启动，运行或停止mysqld时遇到的问题</td></tr><tr><td>通用查询日志</td><td>记录建立的客户端连接和执行的语句</td></tr><tr><td>中继日志</td><td>从复制主服务器接收的数据更改</td></tr></tbody></table><h3 id="一、bin-log日志" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#一、bin-log日志">#</a> 一、bin log日志</h3><h4 id="_1、概述" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、概述">#</a> 1、概述</h4><p>二进制日志（binnary log）以【事件形式】记录了对MySQL数据库执行更改的所有操作。</p><p>binlog记录了所有数据库【表结构】变更（例如CREATE、ALTER TABLE…）以及【表数据】修改（INSERT、UPDATE、DELETE…）的二进制日志。不会记录SELECT和SHOW这类操作，因为这类操作对数据本身并没有修改，但可以通过查询通用日志来查看MySQL执行过的所有语句。</p><p>binlog是mysql server层维护的，跟采用何种引擎没有关系，记录的是所有的更新操作的日志记录。binlog是在事务最终commit前写入的。我们执行SELECT等不涉及数据更新的语句是不会记binlog的，而涉及到数据更新则会记录。要注意的是，对支持事务的引擎如innodb而言，必须要提交了事务才会记录binlog。</p><p>binlog 文件写满后，会自动切换到下一个日志文件继续写，而不会覆盖以前的日志，这个也区别于 redo log，redo log 是循环写入的，即后面写入的可能会覆盖前面写入的。</p><p>binlog有两个常用的使用场景：</p><ul><li>主从复制：我们会专门有一个章节代领大家搭建一个主从同步的两台mysql服务。</li><li>数据恢复：通过mysqlbinlog工具来恢复数据。</li></ul><p>mysql8中的binLog默认是开启的，5.7默认是关闭的，可以通过参数<code>log_bin</code>控制：</p><h4 id="_2、数据恢复" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、数据恢复">#</a> 2、数据恢复</h4><p>（1）确认binlog开启，log_bin变量的值为ON代表binlog是开启状态：</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">show variables like <span class="hljs-string">&#x27;%log_bin%&#x27;</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>（2）为了防止干扰，我们flush刷新log日志，自此刻会产生一个新编号的binlog日志文件：</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">flush logs;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>（3）查看所有binlog日志列表：</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">show master logs;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img alt="image-20220507135555872" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220507135555872-fabcd807.png" tabindex="0"/><figcaption>image-20220507135555872</figcaption></figure><p>（4）查看master状态，即最后(最新)一个binlog日志的编号名称，及其最后一个操作事件pos结束点(Position)值，这一步可有可无： <img alt="image-20220507135613665" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/YGAQAAYD.png"/> （5）执行sql</p><p>先创建表，并插入一些数据：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> ydl_student;<br><span class="hljs-keyword">CREATE TABLE</span> `ydl_student` (<br>  `id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT NULL</span>,<br>  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `score` <span class="hljs-type">int</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `grade` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY KEY</span> (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4;<br><span class="hljs-keyword">INSERT INTO</span> `ydl_student`(`id`, `name`, `score`, `grade`) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;lucy&#x27;</span>, <span class="hljs-number">80</span>, <span class="hljs-string">&#x27;a&#x27;</span>);<br><span class="hljs-keyword">INSERT INTO</span> `ydl_student`(`id`, `name`, `score`, `grade`) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;lily&#x27;</span>, <span class="hljs-number">90</span>, <span class="hljs-string">&#x27;a&#x27;</span>);<br><span class="hljs-keyword">INSERT INTO</span> `ydl_student`(`id`, `name`, `score`, `grade`) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;jack&#x27;</span>, <span class="hljs-number">60</span>, <span class="hljs-string">&#x27;c&#x27;</span>);<br><span class="hljs-keyword">INSERT INTO</span> `ydl_student`(`id`, `name`, `score`, `grade`) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;hellen&#x27;</span>, <span class="hljs-number">40</span>, <span class="hljs-string">&#x27;d&#x27;</span>);<br><span class="hljs-keyword">INSERT INTO</span> `ydl_student`(`id`, `name`, `score`, `grade`) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">5</span>, <span class="hljs-string">&#x27;tom&#x27;</span>, <span class="hljs-number">60</span>, <span class="hljs-string">&#x27;c&#x27;</span>);<br><span class="hljs-keyword">INSERT INTO</span> `ydl_student`(`id`, `name`, `score`, `grade`) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">6</span>, <span class="hljs-string">&#x27;jerry&#x27;</span>, <span class="hljs-number">10</span>, <span class="hljs-string">&#x27;d&#x27;</span>);<br><span class="hljs-keyword">INSERT INTO</span> `ydl_student`(`id`, `name`, `score`, `grade`) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">7</span>, <span class="hljs-string">&#x27;sily&#x27;</span>, <span class="hljs-number">20</span>, <span class="hljs-string">&#x27;d&#x27;</span>);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行删除操作，假装误删除，直接全部删除也可以，把表删了都行，一样的道理：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">delete</span> <span class="hljs-keyword">from</span> ydl_student <span class="hljs-keyword">where</span> id <span class="hljs-keyword">in</span> (<span class="hljs-number">3</span>,<span class="hljs-number">5</span>);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>（6）查看binlog日志，我们因为刷新了日志，所以本次操作都会在最新的日志文件上：</p><p>因为 binlog 的日志文件是二进制文件，不能用文本编辑器直接打开，需要用特定的工具来打开，MySQL 提供了 mysqlbinlog 来帮助我们查看日志文件内容：</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看全部的日志信息</span><br>/www/server/mysql/bin/mysqlbinlog -v mysql-bin.000008<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 指定位置范围</span><br>/usr/bin/mysqlbinlog -v mysql-bin.000013 --start-position=0 --stop-position=986<br><span class="hljs-comment"># 指定时间范围</span><br>/usr/bin/mysqlbinlog -v mysql-bin.000013 --start-datetime=<span class="hljs-string">&quot;2022-06-01 11:18:00&quot;</span> --stop-datetime=<span class="hljs-string">&quot;2022-06-01 12:18:00&quot;</span> <br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>真实的情况下，我们的日志文件比较复杂，内容比较多使用时间范围查询后任然可能需要花费时间去排查问题，这里我们找到了误删除的位置：</p><figure><img alt="image-20220507143313649" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220507143313649-eea2e039.png" tabindex="0"/><figcaption>image-20220507143313649</figcaption></figure><p>（7）执行恢复，通过上一步的操作，我们找到了删除的位置3228（即第二个红框），执行下面的语句：</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">/www/server/mysql/bin/mysqlbinlog -v mysql-bin.000008 --stop-position=3228 -v | mysql -uroot -p<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>（8）至此，数据已完全恢复了：</p><figure><img alt="image-20220507143456337" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220507143456337-cf176c97.png" tabindex="0"/><figcaption>image-20220507143456337</figcaption></figure><p>binlog的数据恢复的本质，就是将之前执行过的sql，从开始到指定位置全部执行一遍，如果报错【当前表已经存在】，就将数据库的表删除，重新恢复。</p><h4 id="_3、格式分类" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、格式分类">#</a> 3、格式分类</h4><p>binlog 有三种格式， 使用变量<code>binlog_format</code>查看当前使用的是哪一种：</p><ul><li>Statement（Statement-Based Replication,SBR）：每一条会修改数据的 SQL 都会记录在 binlog 中。</li><li>Row（Row-Based Replication,RBR）：不记录 SQL 语句上下文信息，仅保存哪条记录被修改。</li><li>Mixed（Mixed-Based Replication,MBR）：Statement 和 Row 的混合体，当前默认的选项，5.7中默认row。</li></ul><p>我们举一个例子来说明row和statement的区别，在下面的插入语句中我们有一个函数uuid()，如果日志文件仅仅保存sql语句，下一次执行的结果可能不一致，所以Row格式的文件，他保存的是具体哪一行，修改成了什么数据，记录的是数据的变化，不是简单的sql：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert into</span> ydl_student <span class="hljs-keyword">values</span> (<span class="hljs-number">8</span>,UUID(),<span class="hljs-number">45</span>,<span class="hljs-string">&#x27;d&#x27;</span>);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img alt="image-20220507150522596" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220507150522596-8036d797.png" tabindex="0"/><figcaption>image-20220507150522596</figcaption></figure><blockquote><p>Statement和row的优劣</p></blockquote><ul><li>Statement 模式只记录执行的 SQL，不需要记录每一行数据的变化，因此极大的减少了 binlog 的日志量，避免了大量的 IO 操作，提升了系统的性能。</li><li>由于 Statement 模式只记录 SQL，而如果一些 SQL 中 包含了函数，那么可能会出现执行结果不一致的情况。比如说 uuid() 函数，每次执行的时候都会生成一个随机字符串，在 master 中记录了 uuid，当同步到 slave 之后，再次执行，就得到另外一个结果了。所以使用 Statement 格式会出现一些数据一致性问题。</li><li>从 MySQL5.1.5 版本开始，binlog 引入了 Row 格式，Row 格式不记录 SQL 语句上下文相关信息，仅仅只需要记录某一条记录被修改成什么样子了。</li><li>不过 Row 格式也有一个很大的问题，那就是日志量太大了，特别是批量 update、整表 delete、alter 表等操作，由于要记录每一行数据的变化，此时会产生大量的日志，大量的日志也会带来 IO 性能问题。</li></ul><h4 id="_4、日志格式" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4、日志格式">#</a> 4、日志格式</h4><ul><li>binlog文件以一个值为0Xfe62696e的魔数开头，这个魔数对应0xfebin。</li><li>binlog由一系列的binlog event构成。每个binlog event包含header和data两部分。 <ul><li>header部分提供的是event的公共的类型信息，包括event的创建时间，服务器等等。</li><li>data部分提供的是针对该event的具体信息，如具体数据的修改。</li></ul></li></ul><blockquote><p>常见的事件类型有：</p></blockquote><ul><li><strong>FORMAT_DESCRIPTION_EVENT</strong>：该部分位于整个文件的头部，每个binlog文件都必定会有唯一一个该event</li><li><strong>WRITE_ROW_EVENT</strong>：插入操作。</li><li><strong>DELETE_ROW_EVENT</strong>：删除操作。</li><li><strong>UPDATE_ROW_EVENT</strong>：更新操作。记载的是一条记录的完整的变化情况，即从<strong>前量</strong>变为<strong>后量</strong>的过程</li><li><strong>ROTATE_EVENT</strong>：Binlog结束时的事件，用于说明下一个binlog文件。</li></ul><p>一个event的结构如下，我们在恢复数据的时候已经看到了：</p><figure><img alt="image-20220507142122405" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220507142122405-84f6da7b.png" tabindex="0"/><figcaption>image-20220507142122405</figcaption></figure><ul><li>每个日志的最后都包含一个<code>rotate event</code>用于说明下一个binlog文件。</li><li>binlog索引文件是一个文本文件，其中内容为当前的binlog文件列表，比如下面就是一个mysql-bin.index文件的内容。</li></ul><figure><img alt="image-20220507153011412" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220507153011412-b6b2b640.png" tabindex="0"/><figcaption>image-20220507153011412</figcaption></figure><h4 id="_5、binlog刷盘" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_5、binlog刷盘">#</a> 5、binlog刷盘</h4><p>​ 二进制日志文件并不是每次写的时候同步到磁盘。因此当数据库所在操作系统发生宕机时，可能会有最后一部分数据没有写入二进制日志文件中，这给恢复和复制带来了问题。 ​ 参数<code>sync_binlog=[N]</code>表示每写多少次就同步到磁盘。如果将N设为1，即sync_binlog=1表示采用同步写磁盘的方式来写二进制日志，这时写操作不使用操作系统的缓冲来写二进制日志。（备注：该值默认为0，采用操作系统机制进行缓冲数据同步）。</p><h4 id="_6、binlog实现主从同步" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_6、binlog实现主从同步">#</a> 6、binlog实现主从同步</h4><p>数据库单点部署的问题：</p><ul><li>服务器宕机，会导致业务停顿，影响客户体验。</li><li>服务器损坏，数据丢失，不能及时备份，造成巨大损失。</li><li>读写操作都在同一台服务器，在并发量大的情况下性能存在瓶颈。</li></ul><p>那么我们就可以使用mysql的binlog搭建一个一主多从的mysql集群服务。这样的服务可以帮助我们异地备份数据、进行读写分离，提高系统的可用性。</p><h5 id="_1-主从复制工作原理剖析" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-主从复制工作原理剖析">#</a> <strong>（1） 主从复制工作原理剖析</strong></h5><ul><li>Master 数据库只要发生变化，立马记录到Binary log 日志文件中</li><li>Slave数据库启动一个I/O thread连接Master数据库，请求Master变化的二进制日志</li><li>Slave I/O获取到的二进制日志，保存到自己的Relay log 日志文件中。</li><li>Slave 有一个 SQL thread定时检查Realy log是否变化，变化那么就更新数据</li></ul><figure><img alt="image-20220424200331288" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220424200331288-9a3461d4.png" tabindex="0"/><figcaption>image-20220424200331288</figcaption></figure><h5 id="_2-怎么配置mysql主从复制" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-怎么配置mysql主从复制">#</a> <strong>（2）怎么配置mysql主从复制</strong></h5><hr/><blockquote><p>环境准备</p></blockquote><p>安装两个mysql，使用vmvare安装两个linux系统就可以：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">mysql1(master): 42.192.181.133:3306<br>mysql2(slave):  124.220.197.17:3306<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>mysql 配置文件配</p></blockquote><p>mysql1（master）: 配置文件设置，开启bin_log（已经开启的可以忽略）且需要配置一个server-id</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#mysql master1 config </span><br>[mysqld]<br>server-id = 1            <span class="hljs-comment"># 节点ID，确保唯一</span><br><br><span class="hljs-comment"># log config</span><br>log-bin = master-bin     <span class="hljs-comment">#开启mysql的binlog日志功能</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>mysql2（slave）: 需要开启中继日志</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[mysqld]<br>server-id=2<br>relay-log=mysql-relay-bin<br>replicate-wild-ignore-table=mysql.%<br>replicate-wild-ignore-table=sys.%<br>replicate-wild-ignore-table=information_schema.%<br>replicate-wild-ignore-table=performance_schema.%<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启两个mysql，让配置生效。</p><p><strong>第三步 在master数据库创建复制用户并授权</strong></p><p>1.进入master的数据库，为master创建复制用户</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">&#x27;repl&#x27;</span>@<span class="hljs-string">&#x27;124.220.197.17&#x27;</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">&#x27;Root12345_&#x27;</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>2.赋予该用户复制的权利</p><div class="language-csharp line-numbers-mode" data-ext="cs"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight csharp"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs csharp">grant replication slave <span class="hljs-keyword">on</span> *.* to <span class="hljs-string">&#x27;repl&#x27;</span>@<span class="hljs-string">&#x27;124.220.197.17&#x27;</span> <br>FLUSH PRIVILEGES;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>3.查看master的状态</p><div class="language-ruby line-numbers-mode" data-ext="rb"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight ruby"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ruby">show master status;<br>mysql&amp;gt; show master status;<br>+------------------+----------+--------------+------------------+-------------------+<br>|<span class="hljs-params"> File             </span>| <span class="hljs-title class_">Position</span> |<span class="hljs-params"> Binlog_Do_DB </span>| <span class="hljs-title class_">Binlog</span>_Ignore_DB |<span class="hljs-params"> Executed_Gtid_Set </span>|<br>+------------------+----------+--------------+------------------+-------------------+<br>|<span class="hljs-params"> mysql-bin.000005      120</span>|              |<span class="hljs-params"> mysql            </span>|                   |<span class="hljs-params"></span><br><span class="hljs-params">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="hljs-params">1 row <span class="hljs-keyword">in</span> set (0.00 sec)</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4,配置从库</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">CHANGE MASTER TO <br>MASTER_HOST = <span class="hljs-string">&#x27;42.192.181.133&#x27;</span>,  <br>MASTER_USER = <span class="hljs-string">&#x27;repl&#x27;</span>, <br>MASTER_PASSWORD = <span class="hljs-string">&#x27;Root12345_&#x27;</span>,<br>MASTER_PORT = 3306,<br>MASTER_LOG_FILE=<span class="hljs-string">&#x27;mysql-bin.000020&#x27;</span>,<br>MASTER_LOG_POS=2735,<br>MASTER_HEARTBEAT_PERIOD = 10000; <br><br><span class="hljs-comment"># MASTER_LOG_FILE与主库File 保持一致</span><br><span class="hljs-comment"># MASTER_LOG_POS=120 , #与主库Position 保持一致</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>解释：MASTER_HEARTBEAT_PERIOD表示心跳的周期。当MASTER_HEARTBEAT_PERIOD时间之内，master没有binlog event发送给slave的时候，就会发送心跳数据给slave。</p><p>5.启动从库slave进程</p><div class="language-css line-numbers-mode" data-ext="css"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight css"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs css">mysql&amp;gt; start slave;<br>Query OK, <span class="hljs-number">0</span> rows affected (<span class="hljs-number">0.04</span> sec)<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>6.查看是否配置成功</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">show slave status \G;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><ul><li><p>Slave_IO_Running：从库的IO线程，用来接收master发送的binlog，并将其写入到中继日志relag log</p></li><li><p>Slave_SQL_Running：从库的SQL线程，用来从relay log中读取并执行binlog。</p></li><li><p>Slave_IO_Running、Slave_SQL_Running：这两个进程的状态需全部为 YES，只要有一个为 NO，则复制就会停止。</p></li><li><p>Master_Log_File：要同步的主库的binlog文件名。</p></li><li><p>Read_Master_Log_Pos：已同步的位置，即同步的 binlog 文件内的字节偏移量，该值会随着主从同步的进行而不断地增长。</p></li><li><p>Relay_Log_File：从库的中继日志文件，对接收到的主库的 binlog 进行缓冲。从库的SQL线程不断地从 relay log 中读取 binlog 并执行。</p></li><li><p>Relay_Log_Pos：relay log 中已读取的位置偏移量。</p></li><li><p>Seconds_Behind_Master: 主从同步延时, 值为 0 为正常情况，正值表示已经出现延迟，数字越大从库落后主库越多。</p></li></ul><p>7.在主库创建一个数据库、创建一张表，执行一些sql语句进行测试。</p><h5 id="_3-可能遇到的问题" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3-可能遇到的问题">#</a> （3）可能遇到的问题</h5><p>在配置mysql主从复制的时候可能出现一下错误：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">Fatal error: The slave I/O thread stops because master and slave have equal MySQL server UUIDs; these UUIDs must be different for replication to work.<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p><strong>原因</strong></p><p>如果你使用了两台虚拟机，一主一从，从库的mysql是直接克隆的。在mysql 5.6的复制引入了uuid的概念，各个复制结构中的server_uuid得保证不一样，但是查看到直接克隆data文件夹后server_uuid是相同的。</p><p><strong>解决</strong></p><p>找到data文件夹下的auto.cnf文件，修改里面的server_uuid值，保证各个db的server_uuid不一样，重启db即可。</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /www/server/data<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>修改server_uuid的值</p><figure><img alt="image-20220517180545563" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220517180545563-de94e863.png" tabindex="0"/><figcaption>image-20220517180545563</figcaption></figure><p>使用</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> uuid();<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>生成一个uuid即可，重启数据库。</p><h3 id="二、其他日志" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#二、其他日志">#</a> 二、其他日志</h3><h4 id="_1、通用查询日志-默认关闭" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、通用查询日志-默认关闭">#</a> 1、通用查询日志，默认关闭</h4><p>MySQL通用查询日志，它是记录建立的客户端连接和执行的所有DDL和DML语句(不管是成功语句还是执行有错误的语句)，默认情况下，它是不开启的。请注意，它也是一个文本文件。</p><p>可以通过以下的sql查看查询日志的状态：</p><figure><img alt="image-20220507154040417" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220507154040417-4f619c0d.png" tabindex="0"/><figcaption>image-20220507154040417</figcaption></figure><p>使用以下命令开启通用查询日志，一般不开启，这是为了测试，当然也可以修改配置文件，重启服务：</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 在全局模式下，开启通用查询日志，1表示开启，0表示关闭</span><br>SET global general_log=1;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>开启后，我们随便执行sql语句之后，你会发现data目录多了以下文件：</p><figure><img alt="image-20220507154728204" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220507154728204-b2cfd978.png" tabindex="0"/><figcaption>image-20220507154728204</figcaption></figure><p>使用more命令查看该文件：</p><div class="language-text line-numbers-mode" data-ext="text"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight text"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">more VM-12-17-centos.log <br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img alt="image-20220507154844881" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220507154844881-2734c9b5.png" tabindex="0"/><figcaption>image-20220507154844881</figcaption></figure><h4 id="_2、慢查询日志" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、慢查询日志">#</a> 2、慢查询日志</h4><p>当前版本慢查询日志默认是开启的，有的版本是关闭的，使用如下命令查看慢查询日志的状态：</p><figure><img alt="image-20220507160012005" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220507160012005-cee5dfa1.png" tabindex="0"/><figcaption>image-20220507160012005</figcaption></figure><p>那么，何为慢？mysql通过一个变量‘long_query_time’来确定sql慢不慢，执行时间大于该值就会被记录在慢查询日志中，默认是3s：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> variables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;long_query_time&#x27;</span><br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><figure><img alt="image-20220507160149874" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220507160149874-196fb203.png" tabindex="0"/><figcaption>image-20220507160149874</figcaption></figure><p>以下是【慢查询日志】的记录文本：</p><figure><img alt="image-20220507154539012" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220507154539012-bfc82d0b.png" tabindex="0"/><figcaption>image-20220507154539012</figcaption></figure><h4 id="_3、错误日志" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、错误日志">#</a> 3、错误日志</h4><p>错误日志（Error Log）主要记录 MySQL 服务器启动和停止过程中的信息、服务器在运行过程中发生的故障和异常情况等。一旦发生mysql服务无法启动、程序崩溃一定要记得去查询错误日志：</p><figure><img alt="image-20220507155123988" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220507155123988-72e86ff4.png" tabindex="0"/><figcaption>image-20220507155123988</figcaption></figure><p>我们随便人为一个错误导致他无法启动，重新启动mysql命令如下：</p><div class="language-bash line-numbers-mode" data-ext="sh"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight bash"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">service mysqld restart<br>systemctl mysqld restart<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>我们将inndb的系统表空间文件重命名，重新启动mysql服务，发生问题：</p><figure><img alt="image-20220507161525384" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220507161525384-b896b188.png" tabindex="0"/><figcaption>image-20220507161525384</figcaption></figure><p>查询错误日志，寻找蛛丝马迹：</p><figure><img alt="image-20220507161639367" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220507161639367-14d97ab2.png" tabindex="0"/><figcaption>image-20220507161639367</figcaption></figure><p>修改回正确的名字，重新启动成功：</p><figure><img alt="image-20220507161102642" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220507161102642-5881b0da.png" tabindex="0"/><figcaption>image-20220507161102642</figcaption></figure><h3 id="三、redo-log日志" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#三、redo-log日志">#</a> 三、redo log日志</h3><p>接下来的两个日志，是innodb为解决不同问题而引出的两类日志文件。</p><p>redo log（重做日志）的设计主要是为了防止因系统崩溃而导致的数据丢失，其实解决因系统崩溃导致数据丢失的思路如下：</p><p>1、每次提交事务之前，必须将所有和当前事务相关的【buffer pool中的脏页】刷入磁盘，但是，这个效率比较低，可能会影响主线程的效率，产生用户等待，降低响应速度，因为刷盘是I/O操作，同时一个事务的读写操作也不是顺序读写。</p><p>2、把当前事务中修改的数据内容在日志中记录下来，日志记录是顺序写，性能很高。其实mysql就是这么做的，这个日志被称为redo log。执行事务中，每执行一条语句，就可能有若干redo日志，并按产生的顺序写入磁盘，redo日志占用的空间非常小，当redo log空间满了之后又会从头开始以循环的方式进行覆盖式的写入。</p><p>redo log的格式比较简单，包含一下几个部分：</p><ul><li><p>type：该日志的类型，在5.7版本中，大概有53种不同类型的redo log，占用一个字节</p></li><li><p>space id：表空间id</p></li><li><p>page number：页号</p></li><li><p>data：日志数据</p></li></ul><h4 id="_1、mtr" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、mtr">#</a> 1、MTR</h4><p>在innodb执行任务时，有很多操作，必须具有原子性，我们把这一类操作称之为MIni Transaction，我们以下边的例子为例：</p><p>在我们向B+树中插入一条记录的时候，需要定位这条数据将要插入的【数据页】，因为插入的位置不同，可能会有以下情况：</p><p>1、待插入的页拥有【充足的剩余空间】，足以容纳这条数据，那就直接插入就好了，这种情况需要记录一条【MLOG_COMP_REC_INSERT类型】的redo日志就好了，这种情况成为乐观插入。</p><figure><img alt="image-20220510121537504" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220510121537504-a3ac363a.png" tabindex="0"/><figcaption>image-20220510121537504</figcaption></figure><p>2、待插入的页【剩余空间不足】以容纳该条记录，这样就比较麻烦了，必须进行【页分裂】了。必须新建一个页面，将原始页面的数据拷贝一部分到新页面，然后插入数据。这其中对应了好几个操作，必须记录多条rede log，包括申请新的数据页、修改段、区的信息、修改各种链表信息等操作，需要记录的redo log可能就有二三十条，但是本次操作必须是一个【原子性操作】，在记录的过程中，要全部记录，要么全部失败，这种情况就被称之为一个MIni Transaction（最小事务）。</p><figure><img alt="image-20220510121522561" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220510121522561-cee67760.png" tabindex="0"/><figcaption>image-20220510121522561</figcaption></figure><p><strong>（1）MTR的按组写入</strong></p><p>对于一个【MTR】操作必须是原子的，为了保证原子性，innodb使用了组的形式来记录redo 日志，在恢复时，要么这一组的的日志全部恢复，要么一条也不恢复。innodb使用一条类型为<code>MLO_MULTI_REC_END</code>类型的redo log作为组的结尾标志，在系统崩溃恢复时只有解析到该项日志，才认为解析到了一组完整的redo log，否则直接放弃前边解析的日志。</p><img alt="image-20220510121447118" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220510121447118-6fc6234d.png" style="zoom:50%;"/><p><strong>（2）单条redolog的标识方法</strong></p><p>有些操作只会产生一条redo log，innodb是通过【类型标识】的第一个字符来判断，这个日志是单一日志还是组日志，如下图：</p><img alt="image-20220510121610230" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220510121610230-f3c4f4b4.png" style="zoom:50%;"/><p><strong>（3）事务、sql、MTR、redolog的关系如下</strong></p><ul><li>一个事务包含一条或多条sql</li><li>一条sql包含一个或多个MTR</li><li>一个MTR包含一个或多个redo log</li></ul><h4 id="_2、log-buffer" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、log-buffer">#</a> 2、log buffer</h4><p>任何可能产生大量I/O的操作，一般情况下都会设计【缓冲层】，mysql启动时也会向操作系统申请一片空间作为redo log的【缓冲区】，innodb使用一个变量<code>buf_free</code>来标记下一条redo log的插入位置（标记偏移量），log buffer会在合适的时机进行刷盘：</p><ul><li>log buffer空间不足。logbuffer的容量由<code>innodb_log_buffer_size</code>指定，当写入log buffer的日志大于容量的50%，就会进行刷盘。</li><li>提交事务时，如果需要实现崩溃恢复，保证数据的持久性，提交事务时必须提交redo log，当然你也可以为了效率不去提交，可以通过修改配置文件设置该项目。</li><li>后台有独立线程大约每隔一秒会刷新盘一次。</li><li>正常关闭服务器。</li><li>做checkpoint时，后边会讲。</li></ul><p>有缓冲就可能存在数据不一致，咱们接着往下看。</p><h4 id="_3、checkpoint" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、checkpoint">#</a> 3、checkpoint</h4><p>redolog日志文件容量是有限的，需要循环使用，redo log的作用仅仅是为了在崩溃时恢复脏页数据使用的，如果脏页已经刷到磁盘上，其对应的redo log也就没用了，他也就可以被重复利用了。<strong>checkpoint的作用就是用来标记哪些旧的redo log可以被覆盖。</strong></p><p>我们已经知道，判断redo log占用的磁盘空间是否可以被重新利用的标志就是，对应的脏页有没有被刷新到磁盘。为了实现这个目的，我们需要了解一下下边几个记录值的作用：</p><p><strong>（1）lsn</strong></p><p>lsn（log sequence number）是一个全局变量。mysql在运行期间，会不断的产生redo log，日志的量会不断增加，innodb使用lsn来记录当前总计写入的日志量，lsn的初始值不是0，而是8704，原因未知。系统在记录lsn时是按照【偏移量】不断累加的。<strong>lsn的值越小说明redo log产生的越早。</strong></p><p>每一组redo log都有一个唯一的lsn值和他对应，你可以理解为lsn是redo log的年龄。</p><p><strong>（2）flush_to_disk_lsn</strong></p><p><code>flush_to_disk_lsn</code>也是一个全局变量，表示已经刷入磁盘的redo log的量，他小于等于lsn，举个例子：</p><p>1、将redo log写入log buffer，lsn增加，假如：8704+1024 = 9728，此时flush_to_disk_lsn不变。</p><p>2、刷如512字节到磁盘，此时flush_to_disk_lsn=8704+512=9256。</p><p>如果两者数据相同，说明已经全部刷盘。</p><p><strong>（3）flush链中的lsn</strong></p><p>其实要保证数据不丢失，核心的工作是要将buffer pool中的脏页进行刷盘，但是刷盘工作比较损耗性能，需要独立的线程在后台静默操作。</p><p>回顾一下flush链，当第一次修改某个已经加载到buffer pool中的页面时，他会变成【脏页】，会把他放置在flush链表的头部，flush链表是按照第一次修改的时间排序的。再第一次修改缓冲页时，会在【缓冲页对应的控制块】中，记录以下两个属性：</p><ul><li>oldest_modification：<strong>第一次</strong>修改缓冲页时，就将【修改该页面的第一组redo log的lsn值】记录在对应的控制块。</li><li>newest_modification：<strong>每一次</strong>修改缓冲页时，就将【修改该页面的最后组redo log的lsn值】记录在对应的控制块。</li></ul><p>既然flush链表是按照修改日期排序的，那么也就意味着，oldest_modification的值也是有序的。</p><p><strong>（4）checkpoint过程</strong></p><p>执行一个check point可以分为两个步骤</p><p>**第一步：**计算当前redo log文件中可以被覆盖的redo日志对应的lsn的值是多少：</p><p>1、flush链是按照第一次修改的时间排序的，当然控制块内的【oldest_modification】记录的lsn值也是有序的。</p><p>2、我们找到flush链表的头节点上的【oldest_modification】所记录的lsn值，也就找到了一个可以刷盘的最大的lsn值，小于这个值的脏页，肯定已经刷入磁盘。</p><p>3、所有小于这个lsn值的redo log，都可以被覆盖重用。</p><p>4、将这个lsn值赋值给一个全局变量checkpoint_lsn，他代表可以被覆盖的量。</p><p>**第二步：**将checkpoint_lsn与对应的redo log日志文件组偏移量以及此次checkpoint的编号（checkpoint_no也是一个变量，记录了checkpoint的次数）全部记录在日志文件的管理信息内。</p><h4 id="_4、一个事务的执行流程" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4、一个事务的执行流程">#</a> 4、一个事务的执行流程</h4><figure><img alt="image-20220510174411661" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220510174411661-951cbbb0.png" tabindex="0"/><figcaption>image-20220510174411661</figcaption></figure><p>主线程</p><p>1、客户端访问mysql服务，在buffer pool中进行操作（如果目标页不在缓冲区，需要加载进入缓冲区），此时会形成脏页。</p><p>2、记录redo log，可能产生很多组日志，redo log优先记录在缓冲区，会在提交事务前刷盘。</p><p>3、刷盘时根据checkpoint的结果，选择可以使用的日志空间进行记录。</p><p>4、成功后即可返回，此时数据不会落盘，这个过程很多操作只在内存进行，只需要记录redo log（顺序写），所以速度很快。</p><p>线程1：</p><p>1、不断的对flush链表的脏页进行刷盘，对响应时间没有过高要求。</p><p>线程2：</p><p>1、不断的进行checkpoin操作，保证redo log可以及时写入。</p><h4 id="_5、系统崩溃的影响" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_5、系统崩溃的影响">#</a> 5、系统崩溃的影响</h4><p>（1）**log buffer中的日志丢失，**log buffer中的日志会在每次事务前进行刷盘，如果在事务进行中崩溃，事务本来就需要回滚。</p><p>（2）<strong>buffer pool中的脏页丢失</strong>，崩溃后可以通过redo log恢复，通过checkpoint操作，我们可以确保，内存中脏页对应的记录都会在redo log日志中存在。</p><p>redo log保证了崩溃后，数据不丢失，但是一个事务进行中，如果一部分redo log已经刷盘，那么系统会将本应回滚的数据同样恢复，为了解决回滚的问题，innodb提出了undo log。</p><h3 id="四、undo-log日志" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#四、undo-log日志">#</a> 四、undo log日志</h3><h4 id="_1、概述-1" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、概述-1">#</a> 1、概述</h4><p>undo log（也叫撤销日志或者回滚日志），他的主要作用是为了实现回滚操作。同时，他是MVCC多版本控制的核心模块。undo log保存在共享表空间【ibdata1文件】中。</p><figure><img alt="image-20220511132907318" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220511132907318-a045fd84.png" tabindex="0"/><figcaption>image-20220511132907318</figcaption></figure><p>**注意：**8.0以后undolog有了独立的表空间：</p><figure><img alt="image-20220511132953019" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220511132953019-0170b963.png" tabindex="0"/><figcaption>image-20220511132953019</figcaption></figure><p>在讲undo log之前需要先了解行数据中的两个隐藏列：</p><h4 id="_2、事务id-trx-id" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、事务id-trx-id">#</a> 2、事务id（trx_id）</h4><p>我们已经讲过，在innodb的行数据中，会自动添加两个隐藏列，一个是【trx_id】，一个是【roll_pointer】，本章节会详细介绍这两列的具体作用，如果该表中没有定义主键，也没有定义【非空唯一】列，则还会生成一个隐藏列【row_id】，这个我们之间也讲过，是为了生成聚簇索引使用的。</p><p>事务id是一个自增的全局变量，如果一个【事务】对任意表做了【增删改】的操作，那么innodb就会给他分配一个独一无二的事务id。</p><p><strong>冷知识：</strong></p><ul><li>事务id保存在一个全局变量【MAX_TRX_ID】上，每次事务需要分配事务id，就会从这个全局变量中获取，然后自增1。</li><li>该变量每次自增到256的倍数会进行一个落盘（保存在表空间页号为5的页面中），发生服务停止或者系统崩溃后，再起启动服务，会读取这个数字，然后再加256。这样做既保证不会有太多I/O操作，还能保证id的有序增长。比如：读到256进行落盘，后来有涨到302，突然崩溃了，下次启动后，第一个事务的id就是256+256=512，保证新的事务id一定大。</li></ul><h4 id="_3、roll-pointer" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、roll-pointer">#</a> 3、roll_pointer</h4><p>undo log在记录日志时是这样记录的，每次修改数据，都会将修改的数据标记一个【新的版本】，同时，这个版本的数据的地址会保存在修改之前的数据的roll_pointer列中，如下：</p><figure><img alt="image-20220512155454781" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220512155454781-dbad9b39.png" tabindex="0"/><figcaption>image-20220512155454781</figcaption></figure><h4 id="_4、分类" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4、分类">#</a> 4、分类</h4><p>当我们对数据库的数据进行一个操作时必须记录之前的信息，将来才能【悔棋】，如下：</p><ul><li>插入一条数据时，至少要把这条数据的主键记录下来，以后不想要了直接根据主键删除。</li><li>删除一条数据时，至少要把这个数据所有的内容全部记录下来，以后才能全量恢复。但事实上不需要，每行数据都有一个delete_flag，事务中将其置1，记录id，如需要回滚根据id复原即可，提交事务后又purge线程处理垃圾。</li><li>修改一条数据时，至少要将修改前后的数据都保存下来。</li></ul><p>innodb将undo log分为两类：</p><ul><li>一类日志只记录插入类型的操作（insert）</li><li>一类日志只记录修改类型的操作（delete，update）</li></ul><p>什么分为这两类呢？</p><ul><li>插入型的记录不需要记录版本，事务提交以后这一片空间就可以重复利用了。</li><li>修改型的必须将每次修改作为一个版本记录下来，即使当前事务已经提交，也不一定能回收空间，应为其他事务可能在用。</li></ul><h4 id="_5、物理存储结构" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_5、物理存储结构">#</a> 5、物理存储结构</h4><p>undo同样是以页的形式进行存储的，多个页是使用链表的形式进行管理，针对【普通表和零时表】，【插入型和修改型】的数据，一个事务可能会产生以下四种链表：</p><figure><img alt="image-20220511190027272" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220511190027272-aa4a4815.png" tabindex="0"/><figcaption>image-20220511190027272</figcaption></figure><p>这是物理存储模型，分成四种类型，是为了更好的管理。</p><h4 id="_6、记录流程" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_6、记录流程">#</a> 6、记录流程</h4><ol><li><p>开启事务，执行【增删改】时获得【事务id】。</p></li><li><p>在系统表空间中第5号页中，分配一个回滚段，回滚段是轮动分配的，比如，当前事务使用第5个回滚段，下个事务就使用第6个。</p><p>【回滚段】是一个【数据页】，里边划分了1024个undo slot，用来存储日志链表的头节点地址。</p></li><li><p>在当前回滚段的cached链表（回收可复用的）和空闲solt中，找到一个可用的slot，找不到就报错。</p></li><li><p>创建或复用一个undo log页，作为first undo page，并把他的地址写入undo solt中。</p></li></ol><figure><img alt="image-20220511150345487" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220511150345487-f4cdf002.png" tabindex="0"/><figcaption>image-20220511150345487</figcaption></figure><h4 id="_7、回滚过程" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_7、回滚过程">#</a> 7、回滚过程</h4><ol><li>服务再次启动时，通过表空间5号页面定位到128个回滚段的位置，</li><li>遍历所有的slot，找到所有状态不为空闲的slot，并且通过undolog的标记为找到现在活跃（未提交）的所有的事务id</li><li>根据undo log的记录，将数据全部回滚</li></ol><h2 id="第九章、隔离级别和mvcc" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第九章、隔离级别和mvcc">#</a> 第九章、隔离级别和MVCC</h2><p>【MVCC】，全称Multi-Version Concurrency Control，即【多版本并发控制】。MVCC在MySQL InnoDB中的实现主要是为了提高数据库的并发性能，用更好的方式去处理【读-写冲突】，做到即使有【读写冲突】时，也能做到不加锁，非阻塞并发读，学习mvcc之前我们需要学习一些新的概念。</p><h3 id="一、read-view-读视图" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#一、read-view-读视图">#</a> 一、Read View（读视图）</h3><p>在学习MVCC多版本并发控制之前，我们必须先了解一下，什么是MySQL InnoDB下的【当前读】和【快照读】，我们都知道undo log会记录一个事务对一条数据的所有修改，并形成版本链：</p><ul><li><strong>当前读</strong>：像select lock in share mode（锁）、 select for update、 update、insert、delete（排他锁）这些操作都是【当前读】，他读取的是记录的【最新版本】，读取时还要保证其他【并发事务】不能修改当前记录，会对读取的记录进行加锁。</li><li><strong>快照读</strong>：像不加锁的select操作就是快照读，即不加锁的【非阻塞读】；快照读的前提是【隔离级别不是串行级别】，串行级别下的快照读会【退化成当前读】，顾名思义，快照读读取的是【快照】，他是通过readView实现的。</li></ul><h4 id="_1、实现原理" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、实现原理">#</a> 1、实现原理</h4><p>Read View就是事务进行【快照读】的时候生产的【读视图】(Read View)，在该事务【执行快照读】的那一刻，会生成数据库系统当前的一个快照。</p><p><strong>注意：</strong>【快照】不是说将数据库复制一份，【Read View】的主要作用是做【可见性判断】， 快照的实现逻辑是通过undo log的【版本链】，配合一些【参数】，比如事务id，来确定当前事务可以读取的版本。</p><h4 id="_2、readview的结构" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、readview的结构">#</a> 2、readView的结构</h4><p>举一个列子，当前有事务id为12、13、14、16、20的五个事务，他们在同时修改一条数据，此时，事务13发生读取行为，在【事务13】读取之前【事务14】已经提交，当前场景下，将产生一个readview如下：</p><p>一个readView就是一个【结构体】，你甚至可以理解成为java里的实例（readview）和属性，包含属性如下：</p><ul><li>m_ids：生成该readview时，当前系统中【活跃的事务】id列表。对于当前案例，因为14已经提交，就不活跃了，所以该变量的值为[12,13,16,20]。</li><li>min_trx_id：当前系统【活跃事务】中最小的【事务id】，他也是m_ids的最小值，当前案例的值就是12。</li><li>max_trx_id：当前系统中计划分配给下一个事务的id，他可能是m_ids的最大值+1，也可能比他大。当前案例值假设为22。</li><li>creator_trx_id：生成这个readView的事务id，当前案例的值为12。</li></ul><p>以上readview配合undo log就可以形成一个【快照】，那他是怎么读取的呢？</p><h3 id="二、快照读原理解析" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#二、快照读原理解析">#</a> 二、快照读原理解析</h3><p>在一个事务读取数据时，会根据当前数据形成一个readview，读取时会按照以下逻辑进行读取：</p><ul><li><p>如果【被访问数据的事务trx_id】和readView中的【creator_trx_id值】相同，意味着自己在访问自己修改过的记录，当然可以被访问。</p></li><li><p>如果【被访问数据的事务trx_id】小于readView中的【min_trx_id】值，说明生成这个版本数据的事务，在生成readview前已经提交，这样的数据也可以访问。</p><p>**通俗一点：**这个数据之前被其他的事务修改过，但是事务已经提交，所以这个版本的数据是可以使用的，这样不会产生脏读。</p></li><li><p>如果【被访问数据的事务trx_id】大于等于readView中的max_trx_id值，说明生成这个版本数据的事务，是在生成readview后开启，这样的数据不应该被访问。</p><p>**通俗一点：**你读取数据之后，有人修改了当前数据，那人家后边修改的数据，你也不能读。</p></li><li><p>如果【被访问数据的事务trx_id】如果在min_trx_id和max_trx_id范围内，则需要判断是不是在【m_ids】中（目的是判断这个数据是不是已经提交）。如果在，说明生成这个版本的事务还是活跃的，没有提交的事务产生的数据当然不能读，如果不在，说明事务已经提交，该数据可以被访问。</p><p>**通俗一点：**这个数据被现在活跃的其他事务正在修改中，读取时要看此时这个事务是不是已经提交，目的也是为了不要读取别人未提交的事务。</p></li></ul><p>我们用下边的案例来看一下这个过程：</p><figure><img alt="image-20220512152116264" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220512152116264-d7d80219.png" tabindex="0"/><figcaption>image-20220512152116264</figcaption></figure><h3 id="三、解决脏读和不可重复读" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#三、解决脏读和不可重复读">#</a> 三、解决脏读和不可重复读</h3><p>对于RU隔离级别的事务来说，由于可以读取到未提交的事务，所有直接读取【最新的记录】（当前读）就可以，对于serializable的事务来说，必须使用加锁的方式来访问。</p><h4 id="_1、解决脏读" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、解决脏读">#</a> 1、解决脏读</h4><p>先思考一个问题，脏读指的是在当前事务中读取到了其他事务未提交的数据，那解决的思路是什么：</p><p><strong>（1）没有undo+mvcc</strong></p><p>一个事务读取了数据之后，立马给这个数据加写锁，不允许其他事务进行修改，这是加锁解决脏读。</p><p><strong>（2）使用undo+mvcc</strong></p><p>所有事务对数据的修改，记录成版本链，使用readview进行版本选择，每个事务只能读取满足条件的数据，这个过程不需要加锁。</p><p>使用mvcc很好的解决了【读写操作】的并发执行，而且采用了无锁机制。</p><h4 id="_2、解决不可重复读" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、解决不可重复读">#</a> 2、解决不可重复读</h4><p>RC和RR两个隔离级别解决不可重复读是通过生成readview时间不同</p><p><strong>（1）RC隔离级别</strong>，同一个事务中【每次读取数据时都生成一个新的ReadView】，两次读取时，如果中间有其他事务进行提交，可能会生成两个不同的readview，导致当前事务中，两次读取的数据不一致，这就是不可重复读。具体的执行流程如下：</p><figure><img alt="image-20220512154853148" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220512154853148-129aabc5.png" tabindex="0"/><figcaption>image-20220512154853148</figcaption></figure><p><strong>（2）RR隔离级别</strong>，同一个事务中【只在第一次读取数据时生成一个ReadView】，以后这个事务中一直使用这个readview，那么同一个事务中就能保证多次读取的数据是一致的，具体的执行流程如下：</p><figure><img alt="image-20220512155222410" loading="lazy" src="https://upyun.thatcdn.cn/public/img/ydldoc/YDLImages/%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5/mysql%E5%AD%A6%E4%B9%A0/mysql%E8%BF%9B%E9%98%B6/image-20220512155222410-cf20dd90.png" tabindex="0"/><figcaption>image-20220512155222410</figcaption></figure><h4 id="_3、解决幻读" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、解决幻读">#</a> 3、解决幻读</h4><p>他是通过间隙锁实现的，一旦锁定某一个范围的数据，就会对这个范围的数据加锁，间隙锁保证我们<strong>不能在这个范围内插入新的数据。</strong></p><h2 id="第十章-其他知识" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#第十章-其他知识">#</a> 第十章 其他知识</h2><h3 id="一、触发器" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#一、触发器">#</a> 一、触发器</h3><p>与表有关的数据对象，在满足某种条件的时候，被动执行的SQL语句。</p><h4 id="_1、触发器的特性" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、触发器的特性">#</a> 1、触发器的特性</h4><ol><li>有begin、end的结构体（多条sql语句）</li><li>需要指定触发的条件：INSERT，UPDATE，DELETE</li><li>有指定的触发时间：BEFORE，AFTER</li></ol><h4 id="_2、触发器的创建" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、触发器的创建">#</a> 2、触发器的创建</h4><ul><li>单条业务逻辑的触发器创建</li></ul><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mysql">/*<br>CREATE TRIGGER 触发器名称 BEFORE|AFTER INSERT|UPDATE|DELETE ON 表名<br>FOR EACH ROW 业务逻辑<br>*/<br>#当b_user表中插入数据后，b_log表中也插入一条数据<br>CREATE TRIGGER trigger_insert AFTER INSERT ON b_user<br>FOR EACH ROW INSERT INTO b_log(字段) VALUES(&#x27;插入数据&#x27;)<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>多条业务逻辑的触发器</li></ul><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs mysql">/*<br>DELIMITER $<br>CREATE TRIGGER 触发器名称 BEFORE|AFTER INSERT|UPDATE|DELETE ON 表名<br>FOR EACH ROW<br>BIGIN<br>INSERT...;<br>UPDATE...;<br>END;$<br>*/<br>#在b_user表中插入数据前，b_log表中插入2条数据<br>DELIMITER $<br>CREATE TRIGGER trigger_ insert_before BEFORE INSERT ON b_user<br>FOR EACH ROW<br>BEGIN<br>INSERT INTO b_log(comments,name) values(&#x27;insert1&#x27; ，NEW.name);<br>INSERT INTO b_log(comments,name) values(&#x27;insert2&#x27; , NEW.name) ;<br>END;$<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>总结</strong></p><ul><li>BEFORE|AFTER INSERT用于获取将要插入的数据</li><li>BEFORE|AFTER UPDATE|DELETE用于获取已经修改或删除的数据</li></ul><h4 id="_3、删除触发器" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、删除触发器">#</a> 3、删除触发器</h4><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">DROP TRIGGER 触发器名称<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><h3 id="二、存储过程" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#二、存储过程">#</a> 二、存储过程</h3><h4 id="_1、-变量" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、-变量">#</a> 1、 变量</h4><h5 id="_1-1-系统变量" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-1-系统变量">#</a> 1.1 系统变量</h5><p>由mysql数据库管理系统提供的，变量名称固定，可以修改和查看值，分为<strong>全局变量</strong>和<strong>会话变量</strong></p><p><strong>全局变量</strong>：当mysql服务没有重启时，我们可以查看和修改的变量</p><p><strong>会话变量</strong>：和MySQL连接形成的会话，生命周期在整个会话过程中</p><p>全局变量用global修饰，会话变量用session修饰，通常session可以省略</p><ul><li>查看系统变量</li></ul><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SHOW GLOBAL variables; -- 查看全局变量<br>SHOW SESSION variables; -- 查看会话变量<br>SHOW variables; -- 查看会话变量<br>SHOW GLOBAL variables like &#x27;%dir%&#x27;; -- 模糊查询环境变量<br>SELECT @@datadir; -- 查看全局系统变量<br>SELECT @@session_track_transaction_info;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>修改系统变量</li></ul><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SHOW GLOBAL variables like &#x27;autocommit&#x27;; -- 全局系统变量中为自动提交事务<br>SET GLOBAL autocommit=0; -- 将全局的自动提交的事务改为手动提交<br>SHOW SESSION variables link &#x27;autocommit&#x27;; -- 查看会话变量中自动提交事务<br>SET SESSION autocommit=0; -- 将会话变量中自动提交的事务改为手动提交<br>SET @@session.autocommit=1;<br>SET @@global.autocommit=1;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>全局变量</strong>在修改后，在不同的会话中都会立即生效，但是在重新启动mysql服务后，全局变量会恢复为默认值，如果想让全局变量依旧有效，需要去修改.ini文件（MySQL配置文件）</p><p><strong>会话变量</strong>在修改后只对当前会话有效。一般在开发过程中修改会话变量。如：字符编码格式等可以在ini文件中进行设置</p><h5 id="_1-2-用户变量" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1-2-用户变量">#</a> 1.2 用户变量</h5><p>MySQL允许用户自定义变量，分为用户变量和局部变量</p><ul><li><p>用户变量</p><p>作用域：当前会话有效</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#设置方式1，先去声明并初始化用户变量，赋值操作既可以使用=进行赋值，也可以使用:=进行赋值<br>SET @变量名=值;<br>SET @变量名:=值;<br>SELECT @变量名:=值;<br>#设置方式2<br>SELECT 字段 into @变量名 FROM 表名;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>局部变量</p><p>作用域：在begin end的结构体中，声明必须是begin end结构体的第一句</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#声明方式，必须在begin后面从第一行开始<br>DECLARE 变量名 类型;<br>DECLARE 变量名 类型 DEFAULT 值;<br><br>#局部变量的赋值<br>SET 变量名:=值;<br>SELECT @变量名:=值;<br>SELECT 字段 into 变量名 FROM 表名;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h4 id="_2、存储过程的创建" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、存储过程的创建">#</a> 2、存储过程的创建</h4><p>存储过程是一组已经预先编译好的sql语句的集合，理解为批处理语句（增加流程控制语句），一般在复杂逻辑中才会使用存储过程</p><ul><li><p>存储过程的优点</p><ul><li>提供了代码的可用性</li><li>简化了数据库操作，将业务逻辑的细节隐藏在存储过程中</li><li>减少了编译次数，减少了网络IO的次数，从而提高操作效率</li></ul></li><li><p>存储过程的创建</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mysql">/*<br>DELIMITER $<br>CREATE PROCEDURE 存储过程的名称(参数列表)<br>BEGIN<br>局部变量的定义<br>多条sql语句<br>流程控制语句<br>END;$<br>*/<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果存储过程中只有一条SQL语句可以省略BEGIN END</p><p>参数列表</p><table><thead><tr><th>参数模式</th><th>形参名称</th><th>参数类型</th></tr></thead><tbody><tr><td>IN</td><td>username</td><td>mysql数据库中的数据类型（数值型，字符型，日期型）</td></tr><tr><td>OUT</td><td>pwd</td><td>mysql数据库中的数据类型（数值型，字符型，日期型）</td></tr><tr><td>INOUT</td><td>xxx</td><td>mysql数据库中的数据类型（数值型，字符型，日期型）</td></tr></tbody></table><p>IN：声明该参数是一个输入姓参数（类似于java中的形参）</p><p>OUT：声明该参数为一个输出型参数（类似于java中的返回值），在一个存储过程中可以定义多个out类型的参数</p><p>INOUT：声明该参数可以为输入型参数，也可以为输出型参数</p><ul><li><p>存储过程调用</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CALL 存储过程的名称(实参列表) <br>-- 实参列表中包含由输出类型的参数<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>存储过程演示</p><ul><li><p>无参的存储过程</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#用于向b_user表中插入2条数据<br>DELIMITER $<br>CREATE PROCEDURE pro_insert()<br>BEGIN<br>INSERT INTO b_user(name,sex) VALUES(&#x27;1&#x27;,&#x27;1&#x27;);<br>INSERT INTO b_user(name,sex) VALUES(&#x27;2&#x27;,&#x27;2&#x27;);<br>END;$<br><br>CALL pro_insert();<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>带有IN模式参数的存储过程</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#用于向b_user插入2条数据，性别由客户输入<br>DELIMITER $<br>CREATE PROCEDURE pro_insert2(IN sex CHAR(1))<br>BEGIN<br>INSERT INTO b_user(name,sex) VALUES(&#x27;1&#x27;,sex);<br>INSERT INTO b_user(name,sex) VALUES(&#x27;2&#x27;,sex);<br>END;$<br><br>CALl pro_insert2(&#x27;男&#x27;);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>多个带有IN参数的存储过程</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#用于向b_user插入2条数据，用户名和密码由客户输入<br>DELIMITER $<br>CREATE PROCEDURE pro_insert3(IN name VARCHAR(10),IN sex VARCHAR(20))<br>BEGIN<br>INSERT INTO b_user(name,sex) VALUES(name,sex);<br>INSERT INTO b_user(name,sex) VALUES(name,sex);<br>END;$<br><br>CALL pro_insert2(&#x27;uname&#x27;,&#x27;男&#x27;);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>带IN，OUT参数的存储过程</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#判断用户登录，如果用户名和密码输入正确登录成功，否则登录失败<br>#根据输入的用户名和密码作为条件去b_user表中查询，如果查询总行数==1，则认为登录成功，让result返回登录成功，否则登录失败<br>DELIMITER $<br>CREATE PROCEDURE pro_login(IN name VARCHAR(20),IN pwd VARCHAR(20),OUT result VARCHAR(20))<br>BEGIN<br>DECLARE total INT DEFAULT 0;-- 用于存放查询总行数<br>select count(*) from b_user u where u.name=name and u.pwd=pwd;-- 将查询结果赋值给total局部变量<br>SET result:=IF(total=1,&#x27;登录成功&#x27;,&#x27;登录失败&#x27;);<br>END;$<br>#存储过程如何执行<br>-- 解决判断，使用自定义变量<br>SET @result:=&#x27;&#x27;;<br>CAll pro_login(&#x27;李四&#x27;,&#x27;123&#x27;,@result);<br>select @result;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>删除存储过程</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">DROP PROCEDURE 存储过程名称<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div></li><li><p>查看存储过程</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SHOW CREATE PROCEDURE 存储过程名称;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div></li><li><p>修改存储过程</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">DROP<br>CREATE<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li></ul></li></ul><h5 id="_2-1-流程控制语句" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2-1-流程控制语句">#</a> 2.1 流程控制语句</h5><blockquote><p>选择结构</p></blockquote><ul><li><p>IF函数</p><ul><li>功能：三目运算</li><li>语法：IF(逻辑表达式，表达式1，表达式2)</li></ul></li><li><p>IF结构</p><ul><li><p>功能：实现多路选择</p></li><li><p>注意：只能用在BEGIN END结构体中</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mysql">/*<br>IF 逻辑表达式 THEN 语句1;<br>ELSEIF 逻辑表达式2 THEN 语句2;<br>...<br>ELSE 语句n;<br>END IF;<br>*/<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li><p>CASE结构</p><ul><li>等值选择</li></ul><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CASE 字段|变量|表达式<br>WHEN 值 THEN 值|语句<br>WHEN 值 THEN 值<br>...<br>ELSE 值<br>END<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>不等值选择</li></ul><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CASE<br>WHEN 逻辑表达式 THEN 语句1<br>...<br>ELSE 语句n<br>END<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><blockquote><p>循环结构</p></blockquote><ul><li><p>WHILE</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs mysql">/*<br>WHILE 逻辑表达式 DO<br>循环体<br>END WHILE;<br>*/<br>#需求：创建存储过程，输入一个值，返回1到该值的和<br>#分析：一个输入参数，一个返回值，在结构体中，从1循环到输入的值，求和<br>DELIMITER //<br>CREATE PROCEDURE pro_sum(IN input INT,OUT total INT)<br>BEGIN<br>DECLARE i INT DEFAULT 1;<br>DECLARE sum_ INT DEFAULT 0;<br>WHILE i&amp;lt;=input do<br>SET sum_=sum_+i;<br>SET i=i+1;<br>END WHILE;<br>SET totle:=sum_;<br>END;//<br><br>SET @result=0;<br>CALL por_sun(10,@result);<br>SELECT @result;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>LOOP</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#Loopnaem是定义的循环名称，为了跳出循环时指定跳出的循环<br>loopname:LOOP;<br>    IF 逻辑表达式 THEN<br>    LEAVE loopname; -- 跳出当前指定的循环，类似于java中的break<br>    END IF;<br>END LOOP;<br><br>DElIMITER //<br>CREATE PROCEDURE pro_sum_loop(IN input INT,OUT total INT)<br>BEGIN <br>DECLARE i INT DEFAULT 1;<br>DECLARE sum_ INT DEFAULT 0;<br>a:LOOP;<br>SET sum_:=sum_+i;<br>SET i:=i+1;<br>IF i&amp;gt;input THEN<br>LEAVE a;<br>END IF;<br>END LOOP;<br>SET total:=sum_;<br>END;//<br><br>SET @result=0;<br>CALL por_sum_loop(10,@result);<br>SELECT @result;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>REPEAT</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs mysql">REPEAT<br>循环体<br>UNTIL 逻辑表达式 -- 当满足逻辑表达式，跳出循环<br>END REPEAT;<br><br>DELIMITER //<br>CREATE PROCEDURE pro_sum_loop(IN input INT,OUT total INT)<br>BEGIN <br>DECLARE i INT DEFAULT 1;<br>DECLARE sum_ INT DEFAULT 0;<br>REPEAT<br>SET sum_:=sum_+i;<br>SET i:=i+1<br>UNTIL i&amp;gt;input<br>END REPEAT;<br>SET total:=sum_;<br>END;//<br><br>SET @result=0;<br>CALL por_sum_loop(10,@result);<br>SELECT @result;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="三、存储函数" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#三、存储函数">#</a> 三、存储函数</h3><p>函数也是一组预先编译好的sql的集合，基本和存储过程相似</p><p><strong>函数和存储过程的区别</strong></p><ol><li>存储过程可以有0个，1个或多个返回值，适用于insert、update、delete操作</li><li>函数只能有一个返回值，适用于在处理数据以后，返回一个已知的结果</li></ol><h4 id="_1、创建函数" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、创建函数">#</a> 1、创建函数</h4><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE FUNCTION 函数名称(参数列表) RETURNS 返回类型 BINLOG参数<br>BEGIN<br>函数体<br>END<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>参数列表</strong>：参数名称 参数类型</p><p><strong>BINLOG参数</strong></p><ul><li>NO SQL：函数体中没有sql语句， 也不会改参数</li><li>READS SQL DATE：函数体中存在sql语句，但是整个数据是只读的，不会修改数据</li><li>MODIFIES SQL DATE ：函数体中存在SQL语句，并且会修改数据</li><li>CONTAINS SQL：函数体中包含有SQL语句</li></ul><p><strong>函数体</strong>：在函数体汇总必须包含return语句，将return放在函数体最后一行执行</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#写一个函数，用于求两数之和<br>DELIMITER //<br>CREATE FUNCTION sum_(input1 INT,input2 INT) RETURNS INT NO SQL<br>BEGIN<br>return input1+input2;<br>END;//<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2、使用函数" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、使用函数">#</a> 2、使用函数</h4><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT 函数名(参数列表);<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><h4 id="_3、查看函数" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、查看函数">#</a> 3、查看函数</h4><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SHOW CREATE FUNCTION 函数名;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><h4 id="_4、删除函数" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4、删除函数">#</a> 4、删除函数</h4><div class="language-mysql line-numbers-mode" data-ext="mysql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight plaintext"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">DROP FUNCTION 函数名;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><h3 id="四、定时任务" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#四、定时任务">#</a> 四、定时任务</h3><h4 id="_1、查看定时策略是否开启" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_1、查看定时策略是否开启">#</a> 1、查看定时策略是否开启</h4><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> variables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%event_sche%&#x27;</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>开启定时策略：</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">set</span> <span class="hljs-keyword">global</span> event_scheduler<span class="hljs-operator">=</span><span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><h4 id="_2、创建定时任务" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_2、创建定时任务">#</a> 2、创建定时任务</h4><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> event run_event<br><span class="hljs-keyword">on</span> schedule <span class="hljs-keyword">every</span> <span class="hljs-number">1</span> <span class="hljs-keyword">minute</span><br><span class="hljs-keyword">on</span> completion preserve disable<br>do <span class="hljs-keyword">call</span> test_procedure ();<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1、create event day_event：是创建名为run_event的事件 2、创建周期定时的规则，意思是每分钟执行一次 3、on completion preserve disable是表示创建后并不开始生效。 4、do call test_procedure ()是该event(事件)的操作内容</p><h4 id="_3、定时任务操作" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_3、定时任务操作">#</a> 3、定时任务操作</h4><p>1、查看定期任务</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> event_name,event_definition,interval_value,interval_field,status <br><span class="hljs-keyword">FROM</span> information_schema.EVENTS;<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>2、开启或关闭定时任务</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> event run_event <span class="hljs-keyword">on</span> completion preserve enable;<span class="hljs-operator">/</span><span class="hljs-operator">/</span>开启定时任务<br><span class="hljs-keyword">alter</span> event run_event <span class="hljs-keyword">on</span> completion preserve disable;<span class="hljs-operator">/</span><span class="hljs-operator">/</span>关闭定时任务<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4、定时规则" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#_4、定时规则">#</a> 4、定时规则</h4><p>1、周期执行–关键字 EVERY 单位有：second、minute、hour、day、week(周)、quarter(季度)、month、year</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">on</span> schedule <span class="hljs-keyword">every</span> <span class="hljs-number">1</span> week <span class="hljs-operator">/</span><span class="hljs-operator">/</span>每周执行<span class="hljs-number">1</span>次<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div></div></div><p>2、在具体某个时间执行–关键字 AT</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">on</span> schedule <span class="hljs-keyword">at</span> <span class="hljs-built_in">current_timestamp</span>()<span class="hljs-operator">+</span><span class="hljs-type">interval</span> <span class="hljs-number">5</span> <span class="hljs-keyword">day</span> <span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-number">5</span>天后执行<br><span class="hljs-keyword">on</span> schedule <span class="hljs-keyword">at</span> <span class="hljs-string">&#x27;2019-01-01 00:00:00&#x27;</span> <span class="hljs-operator">/</span><span class="hljs-operator">/</span>在<span class="hljs-number">2019</span>年<span class="hljs-number">1</span>月<span class="hljs-number">1</span>日，<span class="hljs-number">0</span>点整执行<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><p>3、在某个时间段执行–关键字STARTS ENDS</p><div class="language-sql line-numbers-mode" data-ext="sql"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight sql"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">on</span> schedule <span class="hljs-keyword">every</span> <span class="hljs-number">1</span> <span class="hljs-keyword">day</span> starts <span class="hljs-built_in">current_timestamp</span>()<span class="hljs-operator">+</span><span class="hljs-type">interval</span> <span class="hljs-number">5</span> <span class="hljs-keyword">day</span> ends <span class="hljs-built_in">current_timestamp</span>()<span class="hljs-operator">+</span><span class="hljs-type">interval</span> <span class="hljs-number">1</span> <span class="hljs-keyword">month</span> <span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-number">5</span>天后开始每天都执行执行到下个月底<br><span class="hljs-keyword">on</span> schedule <span class="hljs-keyword">every</span> <span class="hljs-number">1</span> <span class="hljs-keyword">day</span> ends <span class="hljs-built_in">current_timestamp</span>()<span class="hljs-operator">+</span><span class="hljs-type">interval</span> <span class="hljs-number">5</span> <span class="hljs-keyword">day</span> <span class="hljs-operator">/</span><span class="hljs-operator">/</span>从现在起每天执行，执行<span class="hljs-number">5</span>天<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="附录" tabindex="-1"><a aria-hidden="true" class="header-anchor" href="#附录">#</a> 附录：</h2><p>1、配置文件的举例</p><div class="language-ini line-numbers-mode" data-ext="ini"><button aria-label="复制代码" class="copy-code-button" data-copied="已复制"><div class="copy-icon"></div></button>

<figure class="highlight ini"><figcaption><span>From: 元动力</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment">#[client]</span><br><span class="hljs-comment">#MySQL默认密码</span><br><span class="hljs-comment">#password=88888888</span><br><span class="hljs-section">[mysqld]</span><br><span class="hljs-comment">#MySQL以什么用户运行</span><br><span class="hljs-comment">#user=mysql</span><br><span class="hljs-comment">#MySQL运行在哪个端口</span><br><span class="hljs-comment">#port=3306</span><br><span class="hljs-comment">#改参数指定了安装MySQL的安装路径，填写全路径可以解决相对路径所造成的问题</span><br><span class="hljs-comment">#basedir</span><br><span class="hljs-comment">#指定MySQL的数据库文件放在什么路径下</span><br><span class="hljs-attr">datadir</span>=/usr/local/mysql/data<br><span class="hljs-comment">#mysql以socket方式运行的sock文件位置</span><br><span class="hljs-attr">socket</span>=/usr/local/mysql/mysql.sock<br><span class="hljs-comment">#是否支持符号链接，即数据库或表可以存储在my.cnf中指定datadir之外的分区或者目录，为0不开启</span><br><span class="hljs-attr">symbolic-links</span>=<span class="hljs-number">0</span><br><span class="hljs-comment">#服务器使用的字符集</span><br><span class="hljs-attr">character-set-server</span>=utf8<br><span class="hljs-comment">#默认存储引擎</span><br><span class="hljs-attr">default-storage-engine</span>=INNODB<br><span class="hljs-comment">#表示默认将日志文件存入文件，默认值是&#x27;FILE&#x27; </span><br><span class="hljs-comment">#如果时候log-output=TABLE表示将日志存入数据库，这样日志信息就会被写入到mysql.slow_log表中</span><br><span class="hljs-attr">log-output</span>=FILE<br><span class="hljs-comment">#1开启，0关闭 将所有到达MySQL Server的SQL语句记录下来</span><br><span class="hljs-attr">general-log</span>=<span class="hljs-number">0</span><br><span class="hljs-comment">#设置日志文件保存位置</span><br><span class="hljs-attr">general_log_file</span>=<span class="hljs-string">&quot;JOYWANG.log&quot;</span><br><span class="hljs-comment">#慢查询日志是否开启1,0</span><br><span class="hljs-attr">slow-query-log</span>=<span class="hljs-number">1</span><br><span class="hljs-comment">#慢查询日志文件保存</span><br><span class="hljs-attr">slow_query_log_file</span>=<span class="hljs-string">&quot;JOYWANG-slow.log&quot;</span><br><span class="hljs-comment">#慢查询日志设置时间单位秒 S</span><br><span class="hljs-attr">long_query_time</span>=<span class="hljs-number">10</span><br><span class="hljs-comment">#是否启用错误日志的功能和错误日志的存储位置</span><br><span class="hljs-attr">log-error</span>=<span class="hljs-string">&quot;JOYWANG.err&quot;</span><br><span class="hljs-comment">#如果不设置则server-id是根据服务器ip地址后2位生成的，默认0或1</span><br><span class="hljs-comment">#当配置MySQL复制时，是必填项，用来区分复制拓扑中的各个实例</span><br><span class="hljs-attr">server-id</span>=<span class="hljs-number">1</span><br><span class="hljs-comment">#限制导入和导出的目录权限NULL表示禁止、如果是文件目录，允许该目录下文件（测试子目录不行）、如果为空则表示不限制目录，一定要有等号，否则mysql无法启动</span><br>secure-file-priv=<br><span class="hljs-comment">#最大并发连接数，mysql会为每个连接提供缓冲区，会开销越多的内存，所以要适当的调整该值，不能盲目的提高设置值</span><br><span class="hljs-attr">max_connections</span>=<span class="hljs-number">151</span><br><span class="hljs-comment">#指定高速缓存的大小，每当MySQL访问一个表时，如果在表缓冲区中还有空间，该表就被打开并放入其中，这样可以更快地访问表内容单位M</span><br><span class="hljs-attr">table_open_cache</span>=<span class="hljs-number">2000</span><br><span class="hljs-comment">#增加一张临时表大小，提高查询速度</span><br><span class="hljs-attr">tmp_table_size</span>=<span class="hljs-number">16</span>M<br><span class="hljs-comment">#线程池缓存大小，当客户端断开连接后，将当前线程缓存起来，当在接到新的连接请求时快速响应，无需创建新的线程</span><br><span class="hljs-attr">thread_cache_size</span>=<span class="hljs-number">10</span><br><span class="hljs-comment">#MySQL重建索引时允许使用的临时文件最大大小</span><br><span class="hljs-attr">MyIsam_max_sort_file_size</span>=<span class="hljs-number">100</span>G<br><span class="hljs-comment">#设置在REPAIR TABLE，或者用 CREATE INDEX 创建索引或 ALTER TABLE 的过程中排序索引所分配的缓冲区大小。可设置范围4Bytes 至 4GB，默认为8MB。</span><br><span class="hljs-attr">MyIsam_sort_buffer_size</span>=<span class="hljs-number">8</span>M<br><span class="hljs-comment">#指定索引缓冲区的大小，决定了索引处理的速度，尤其是索引读的速度，建议设置成物理内存的1/4，甚至物理内存的30%-40%，如果设置太大，系统就会频繁的换页，降低系统性能</span><br><span class="hljs-attr">key_buffer_size</span>=<span class="hljs-number">8</span>M<br><span class="hljs-comment">#MySQL读入缓冲区大小，对表进行顺序扫描的请求将分配一个读入缓冲区，MySQL会为它分配一段内存缓冲区。read_buffer_size变量控制这一缓冲区的大小。如果对表的顺序扫描请求非常频繁，并且你认为频繁扫描进行得太慢，可以通过增加该变量值以及内存缓冲区大小提高其性能。</span><br><span class="hljs-attr">read_buffer_size</span>=<span class="hljs-number">0</span><br><span class="hljs-comment">#参数用在sort查询之后 ，以保证获取以顺序的方式获取到查询的数据。如果你有很多order by 查询语句，增长这值能够提升性能</span><br><span class="hljs-attr">read_rnd_buffer_size</span>=<span class="hljs-number">0</span><br><span class="hljs-comment">#0：log buffer将每秒一次地写入log file中，并且log file的flush(刷到磁盘)操作同时进行。该模式下在事务提交的时候，不会主动触发写入磁盘的操作。</span><br><span class="hljs-comment">#1：每次事务提交时MySQL都会把log buffer的数据写入log file，并且flush(刷到磁盘)中去，该模式为系统默认。</span><br><span class="hljs-comment">#2：每次事务提交时MySQL都会把log buffer的数据写入log file，但是flush(刷到磁盘)操作并不会同时进行。该模式下，MySQL会每秒执行一次 flush(刷到磁盘)操作。</span><br><span class="hljs-attr">innodb_flush_log_at_trx_commit</span>=<span class="hljs-number">1</span><br><span class="hljs-comment">#确保有足够大的日志缓冲区来保存脏数据在被写入到日志文件之前</span><br><span class="hljs-attr">innodb_log_buffer_size</span>=<span class="hljs-number">1</span>M<br><span class="hljs-comment">#指定表数据和索引存储的空间，可以是一个或者多个文件。最后一个数据文件必须是自动扩充的，也只有最后一个文件允许自动扩充。这样，当空间用完后，自动扩充数据文件就会自动增长（以8MB为单位）以容纳额外的数据。例如： innodb_data_file_path=/disk1/ibdata1:900M;/disk2/ibdata2:50M:autoextend两个数据文件放在不同的磁盘上。数据首先放在ibdata1中，当达到900M以后，数据就放在ibdata2中。一旦达到50MB，ibdata2将以 8MB为单位自动增长。如果磁盘满了，需要在另外的磁盘上面增加一个数据文件。</span><br><span class="hljs-attr">innodb_data_file_path</span>=/disk1/ibdata1:<span class="hljs-number">900</span>M<span class="hljs-comment">;/disk2/ibdata2:50M:autoextend</span><br><span class="hljs-comment">#这是InnoDB最重要的设置，对InnoDB性能有决定性的影响。默认的设置只有8M，所以默认的数据库设置下面InnoDB性能很差。在只有InnoDB存储引擎的数据库服务器上面，可以设置60-80%的内存。更精确一点，在内存容量允许的情况下面设置比InnoDB tablespaces大10%的内存大小。</span><br><span class="hljs-attr">innodb_buffer_pool_size</span>=<span class="hljs-number">8</span>M<br><span class="hljs-comment">#放置表空间数据的目录，默认在mysql的数据目录，设置到和MySQL安装文件不同的分区可以提高性能。</span><br>innodb_data_home_dir=<br><span class="hljs-comment">#该参数决定了recovery speed。太大的话recovery就会比较慢，太小了影响查询性能，一般取256M可以兼顾性能和recovery的速度</span><br><span class="hljs-attr">innodb_log_file_size</span>=<span class="hljs-number">48</span>M<br><span class="hljs-comment">#该参数设定了事务提交时内存中log信息的处理。</span><br>1) =1时，在每个事务提交时，日志缓冲被写到日志文件，对日志文件做到磁盘操作的刷新。Truly ACID。速度慢。<br>2) =2时，在每个事务提交时，日志缓冲被写到文件， 但不对日志文件做到磁盘操作的刷新。只有操作系统崩溃或掉电才会删除最后一秒的事务，不然不会丢失事务。<br>3) =0时， 日志缓冲每秒一次地被写到日志文件，并且对日志文件做到磁盘操作的刷新。任何mysqld进程的崩溃会删除崩溃前最后一秒的事务<br><span class="hljs-attr">innodb_flush_logs_at_trx_commit</span>=<span class="hljs-number">2</span><br><span class="hljs-comment">#设置InnoDB同步IO的方式：</span><br>) Default – 使用fsync（）。<br>2) O_SYNC 以sync模式打开文件，通常比较慢。<br>3) O_DIRECT，在Linux上使用Direct IO。可以显著提高速度，特别是在RAID系统上。避免额外的数据复制和double buffering（mysql buffering 和OS buffering）。<br><span class="hljs-attr">innodb_flush_method</span>=Default<br><span class="hljs-comment">#InnoDB kernel最大的线程数。</span><br>1) 最少设置为(num_disks+num_cpus)*2。<br>2) 可以通过设置成1000来禁止这个限制<br><span class="hljs-attr">innodb_thread_concurrency</span>=<span class="hljs-number">25</span><br><span class="hljs-comment">#此配置项作用主要是当tablespace 空间已经满了后，需要MySQL系统需要自动扩展多少空间，每次tablespace 扩展都会让各个SQL 处于等待状态。增加自动扩展Size可以减少tablespace自动扩展次数。</span><br><span class="hljs-attr">innodb_autoextend_increment</span>=<span class="hljs-number">64</span><br><span class="hljs-comment">#可以开启多个内存缓冲池，把需要缓冲的数据hash到不同的缓冲池中，这样可以并行的内存读写。</span><br><span class="hljs-attr">innodb_buffer_pool_instances</span>=<span class="hljs-number">8</span><br><span class="hljs-comment">#这个参数设置为一种tickets,默认是5000，我也不清楚到底它代表多久，从官方文档来看它和事物处理的行数有关，大事物需要处理的行数自然更多，小事物当然也就越少至少我们可以想成获得CPU的时间，干活期间他会不断减少，如果减少到0，这个线程将被提出innodb层次，进入前面说的等待队列，当然也就在队尾部了，这里假设有一个小的事物正在排队进入innodb层，又或者它已经进入了innodb层没有获得CPU时间轮片，突然一个大的事物tickets耗尽被提出了innodb层，那么这个小事物就自然而然能够获得CPU轮片干活，而小事物执行非常快，执行完成后，另外的事物又能尽快的获得CPU干活，不会由于OS线程调度不均匀的问题而造成的小事物饥饿问题，这很好理解。也就是前面我说的与其依赖OS的调度策略不如自己设置一种规则，让用到了一定时间轮片的线程先处于睡眠态放弃CPU的使用</span><br><span class="hljs-attr">innodb_concurrency_tickets</span>=<span class="hljs-number">5000</span><br><span class="hljs-attr">innodb_old_blocks_time</span>=<span class="hljs-number">1000</span><br><span class="hljs-attr">innodb_open_files</span>=<span class="hljs-number">300</span><br><span class="hljs-attr">innodb_stats_on_metadata</span>=<span class="hljs-number">0</span><br><span class="hljs-comment">#可以存储每个InnoDB表和它的索引在它自己的文件中。</span><br><span class="hljs-attr">innodb_file_per_table</span>=<span class="hljs-number">1</span><br><span class="hljs-comment">#如果应用程序可以运行在READ-COMMITED隔离级别，做此设定会有一定的性能提升。</span><br><span class="hljs-attr">transaction-isolation</span>=READ-COMITTED<br><span class="hljs-comment">#这个参数用来表示 页读取到mid位置后，需要等待多久才会被加入到LRU列表的热端。使LRU列表中的热点数据不被刷出</span><br><span class="hljs-attr">innodb_checksum_algorithm</span>=<span class="hljs-number">0</span><br><span class="hljs-comment">#MySQL暂时停止回答新请求之前的短时间内多少个请求可以被存在堆栈中</span><br><span class="hljs-attr">back_log</span>=<span class="hljs-number">80</span><br><span class="hljs-attr">flush_time</span>=<span class="hljs-number">0</span><br><span class="hljs-comment">#如果按照检索的性能方式来细分，那么无论是两表 INNER JOIN 还是多表 INNER JOIN，都大致可以分为以下几类：1.JOIN KEY 有索引，主键2.JOIN KEY 有索引， 二级索引3.JOIN KEY 无索引；JOIN BUFFER 是 MySQL 用来缓存以上第二、第三这两类 JOIN 检索的一个 BUFFER 内存区域块。</span><br><span class="hljs-attr">join_buffer_size</span>=<span class="hljs-number">256</span>K<br><span class="hljs-comment">#可以增大此值以便于server端接收更大的SQL</span><br><span class="hljs-attr">max_allowed_packet</span>=<span class="hljs-number">4</span>M<br><span class="hljs-comment">#同一主机最大连续请求错误次数，如果还没成功建立连接，mysql服务器会组织这台主机后续的所有请求</span><br><span class="hljs-attr">max_connect_errors</span>=<span class="hljs-number">100</span><br><span class="hljs-comment">#限制mysqld能打开文件的最大数</span><br><span class="hljs-attr">open_files_limit</span>=<span class="hljs-number">4161</span><br><span class="hljs-comment">#一个connection级参数，在每个connection第一次需要使用这个buffer的时候，一次性分配设置的内存</span><br><span class="hljs-attr">sort_buffer_size</span>=<span class="hljs-number">256</span>K<br><span class="hljs-comment">#就是控制总frm文件的数量，还是个hash表，内部维护。如果打开的表实例的数量超过了table_definition_cache设置，LRU机制将开始标记表实例以进行清除，并最终将它们从数据字典缓存中删除。简单通俗点frm文件有多少，就设置多少了</span><br><span class="hljs-attr">table_definition_cache</span>=<span class="hljs-number">1400</span><br><span class="hljs-comment">#指定基于行的二进制日志事件的最大大小</span><br><span class="hljs-attr">binlog_row_event_max_size</span>=<span class="hljs-number">8</span>K<br><span class="hljs-comment">#本参数用于主从库中配置从库大于0作用为每个命令之后刷盘，小与0作为为永不刷盘，默认均为1000</span><br><span class="hljs-attr">sync_master_info</span>=<span class="hljs-number">10000</span><br><span class="hljs-comment">#这个参数和sync_binlog是一样的，当设置为1时，slave的I/O线程每次接收到master发送过来的binlog日志都要写入系统缓冲区，然后刷入relay log中继日志里，这样是最安全的，因为在崩溃的时候，你最多会丢失一个事务，但会造成磁盘的大量I/O。当设置为0时，并不是马上就刷入中继日志里，而是由操作系统决定何时来写入，虽然安全性降低了，但减少了大量的磁盘I/O操作。这个值默认是0，可动态修改，建议采用默认值。</span><br><span class="hljs-attr">sync_relay_log</span>=<span class="hljs-number">10000</span><br><span class="hljs-comment">#这个参数和sync_relay_log参数一样，当设置为1时，slave的I/O线程每次接收到master发送过来的binlog日志都要写入系统缓冲区，然后刷入relay-log.info里，这样是最安全的，因为在崩溃的时候，你最多会丢失一个事务，但会造成磁盘的大量I/O。当设置为0时，并不是马上就刷入relay-log.info里，而是由操作系统决定何时来写入，虽然安全性降低了，但减少了大量的磁盘I/O操作。这个值默认是0，可动态修改，建议采用默认值</span><br><span class="hljs-attr">sync_relay_log_info</span>=<span class="hljs-number">10000</span><br><span class="hljs-comment">#参数不可动态修改，必须重启数据库</span><br><span class="hljs-comment">#1:存储在磁盘是小写，比较时不区分大小写</span><br><span class="hljs-comment">#2:存储为给定的大小写但是比较时是小写</span><br><span class="hljs-comment">#0:存储为给定的大小写和比较时区分大小写的</span><br><span class="hljs-attr">lower_case_table_names</span> = <span class="hljs-number">1</span><br><span class="hljs-comment">#ONLY_FULL_GROUP_BY：归于GROUP BY聚合操作，如果在SELECT中的列，没有在GROUP BY中出现，那么这个SQL是不合法的，因为列不在GROUP BY从句中</span><br><span class="hljs-comment">#NO_AUTO_VALUE_ON_ZERO：该值影响自增常烈的插入。默认设置下，插入0或者NULL代表生成下一个自增长值。如果用户希望插入的值为0，而该列又是自增长的，那么这个选项就有用了</span><br><span class="hljs-comment">#STRICT_TRANS_TABLES：如果一个值不能插入到一个事物中，则中断当前操作，对非事物不做限制</span><br><span class="hljs-comment">#NO_ZERO_IN_DATE：在严格模式下，不允许日期和月份为零</span><br><span class="hljs-comment">#NO_ZERO_DATE：mysql不允许插入零日期，插入零日期会抛出错误而不是警告</span><br><span class="hljs-comment">#ERROR_FOR_DIVISION_BY_ZERO：在insert或update过程中，如果数据被清除，则产生错误而非警告。如果未给出该模式，那么数据被清除时Mysql返回NULL</span><br><span class="hljs-comment">#NO_AUTO_CREATE_USER：禁止GRANT创建密码为空的用户</span><br><span class="hljs-comment">#NO_ENGINE_SUBSTITUTION：如果需要的存储引擎被禁用或未编译，那么抛出错误。不设置此值时，用默认的存储引擎替代，并抛出一个异常</span><br><span class="hljs-comment">#PIPES_AS_CONCAT：将“||”是为字符串的链接操作符而非运算符，这和Oracle数据库是一样是，也和字符串的拼接函数Concat相类似</span><br><span class="hljs-comment">#ANSI_QUOTES：不能用双引号来引用字符串，因为它被解释为识别符</span><br><span class="hljs-attr">sql_mode</span>=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION<br></code></pre></td></tr></table></figure>

<div aria-hidden="true" class="line-numbers"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div></article>
<div class="article-footer">

</div>

<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">回顾上一篇</div><a href="/wiki/YDLDoc1/mysql%E5%AD%A6%E4%B9%A0/JDBC/JDBC/">JDBC</a></div><div class="item" id="next"><div class="note">接下来阅读</div><a href="/wiki/YDLDoc1/mysql%E5%AD%A6%E4%B9%A0/mysql%E5%85%A5%E9%97%A8/mysql%E5%85%A5%E9%97%A8/">mysql入门</a></div></section></div>


  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>快来参与讨论吧~</p>

    </section>
    <section class='body cmt-body waline'>
      

<div id="waline_container" class="waline_thread"><svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg></div>

    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="text"><p style="text-align:center" >
本站由 <a style="font-weight: bold;" href="/author/ThatCoder/">钟意</a> 使用 <a style="font-weight: bold;" target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.33.1">Stellar 1.33.1</a> 主题创建。
<br>
由 <a style="font-weight: bold;" target="_blank" rel="noopener" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral">又拍云</a> 提供CDN加速/云存储服务
<br>
由 <a style="font-weight: bold;" target="_blank" rel="noopener" href="https://vercel.com/">vercel</a>、<a style="font-weight: bold;" target="_blank" rel="noopener" href="https://www.netlify.com/">netlify</a>、<a style="font-weight: bold;" target="_blank" rel="noopener" href="https://www.cloudflare.com/">cloudflare</a> 提供托管服务
<br>
<a href="https://beian.miit.gov.cn/" target="_blank">湘ICP备2023019799号-1</a>
<br>
<!--不蒜子计数器-->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!--添加一个访问量-->
<span>总访问 <span id="busuanzi_value_site_pv" style="font-weight: bold;"></span> 次 
<!--本页访问 <span id="busuanzi_value_page_pv" style="font-weight: bold;"></span> 次</span>-->
<div id="siteruntime"></div>
</p>
<script>
function siteTime(){
    window.setTimeout("siteTime()", 1000);
    var seconds = 1000
    var minutes = seconds * 60
    var hours = minutes * 60
    var days = hours * 24
    var years = days * 365
    var today = new Date()
    var todayYear = today.getFullYear()
    var todayMonth = today.getMonth()
    var todayDate = today.getDate()
    var todayHour = today.getHours()
    var todayMinute = today.getMinutes()
    var todaySecond = today.getSeconds()
    var t1 = Date.UTC(2020,4,30,08,00,00)
    var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond)
    var diff = t2-t1
    var diffYears = Math.floor(diff/years)
    var diffDays = Math.floor((diff/days)-diffYears*365)
    var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours)
    var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes)
    var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds)
    document.getElementById("siteruntime").innerHTML="<p style=\"text-align:center\">小破站已颠沛流离 "+diffYears+" 年 "+diffDays+" 天 "+diffHours+" 小时 "+diffMinutes+" 分钟 "+diffSeconds+" 秒</p>"
}
siteTime();
</script>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="auto"><div class="widget-header dis-select"><span class="name">本文目录</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E7%AB%A0-%E7%B4%A2%E5%BC%95"><span class="toc-text"> 第六章 索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-text"> 一、数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81b-%E6%A0%91"><span class="toc-text"> 1、B-树</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81b-%E6%A0%91"><span class="toc-text"> 2、B+树</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81%E9%80%89%E5%9E%8B%E7%BC%98%E7%94%B1"><span class="toc-text"> 3、选型缘由</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4%E3%80%81%E5%8F%91%E7%8E%B0%E7%B4%A2%E5%BC%95"><span class="toc-text"> 4、发现索引</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E7%B4%A2%E5%BC%95%E7%9A%84%E5%88%86%E7%B1%BB%E5%92%8C%E5%88%9B%E5%BB%BA"><span class="toc-text"> 二、索引的分类和创建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81%E8%81%9A%E7%B0%87%E7%B4%A2%E5%BC%95%E5%92%8C%E9%9D%9E%E8%81%9A%E7%B0%87%E7%B4%A2%E5%BC%95"><span class="toc-text"> 1、聚簇索引和非聚簇索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E6%99%AE%E9%80%9A%E7%B4%A2%E5%BC%95-%E5%B8%B8%E8%A7%84%E7%B4%A2%E5%BC%95-normal"><span class="toc-text"> 2、普通索引 （常规索引）(normal)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95-unique"><span class="toc-text"> 3、唯一索引（UNIQUE ）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4%E3%80%81%E5%A4%9A%E4%B8%AA%E4%BA%8C%E7%BA%A7%E7%B4%A2%E5%BC%95%E7%9A%84%E7%BB%84%E5%90%88%E4%BD%BF%E7%94%A8"><span class="toc-text"> 4、多个二级索引的组合使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_5%E3%80%81%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95-%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95-%E9%87%8D%E8%A6%81"><span class="toc-text"> 5、复合索引（联合索引）重要</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_6%E3%80%81%E5%85%A8%E6%96%87%E7%B4%A2%E5%BC%95-fulltext"><span class="toc-text"> 6、全文索引（FULLTEXT）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_8%E3%80%81hash%E7%B4%A2%E5%BC%95"><span class="toc-text"> 8、hash索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_7%E3%80%81%E7%A9%BA%E9%97%B4%E7%B4%A2%E5%BC%95-spatial"><span class="toc-text"> 7、空间索引（SPATIAL）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81explain%E7%9A%84%E7%94%A8%E6%B3%95"><span class="toc-text"> 三、explain的用法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81id%E5%AD%97%E6%AE%B5"><span class="toc-text"> 1、id字段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81select-type%E5%AD%97%E6%AE%B5"><span class="toc-text"> 2、select_type字段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81type%E5%AD%97%E6%AE%B5"><span class="toc-text"> 3、type字段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4%E3%80%81table%E5%AD%97%E6%AE%B5"><span class="toc-text"> 4、table字段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_5%E3%80%81possible-keys%E5%AD%97%E6%AE%B5"><span class="toc-text"> 5、possible_keys字段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_6%E3%80%81key%E5%AD%97%E6%AE%B5"><span class="toc-text"> 6、key字段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_7%E3%80%81key-len%E5%AD%97%E6%AE%B5"><span class="toc-text"> 7、key_len字段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_8%E3%80%81ref%E5%AD%97%E6%AE%B5"><span class="toc-text"> 8、ref字段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_9%E3%80%81rows%E5%AD%97%E6%AE%B5"><span class="toc-text"> 9、rows字段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_10%E3%80%81partitions%E5%AD%97%E6%AE%B5"><span class="toc-text"> 10、partitions字段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_11%E3%80%81filtered%E5%AD%97%E6%AE%B5"><span class="toc-text"> 11、filtered字段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_12%E3%80%81extra%E5%AD%97%E6%AE%B5"><span class="toc-text"> 12、Extra字段</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text"> 三、使用索引的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81%E5%93%AA%E4%BA%9B%E6%83%85%E5%86%B5%E4%B8%8B%E9%80%82%E5%90%88%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="toc-text"> 1、哪些情况下适合建索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E5%93%AA%E4%BA%9B%E6%83%85%E5%86%B5%E4%B8%8B%E4%B8%8D%E9%80%82%E5%90%88%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="toc-text"> 2、哪些情况下不适合建索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81%E8%83%BD%E7%94%A8%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95%E7%9A%84%E8%A6%81%E4%BD%BF%E7%94%A8%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95"><span class="toc-text"> 3、能用复合索引的要使用复合索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4%E3%80%81null%E5%80%BC%E4%B9%9F%E6%98%AF%E5%8F%AF%E4%BB%A5%E8%B5%B0%E7%B4%A2%E5%BC%95%E7%9A%84-%E4%BB%96%E8%A2%AB%E5%A4%84%E7%90%86%E6%88%90%E6%9C%80%E5%B0%8F%E5%80%BC%E6%94%BE%E5%9C%A8b-%E6%A0%91%E7%9A%84%E6%9C%80%E5%B7%A6%E4%BE%A7"><span class="toc-text"> 4、null值也是可以走索引的，他被处理成最小值放在b+树的最左侧</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_5%E3%80%81%E4%BD%BF%E7%94%A8%E7%9F%AD%E7%B4%A2%E5%BC%95"><span class="toc-text"> 5、使用短索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_6-%E6%8E%92%E5%BA%8F%E7%9A%84%E7%B4%A2%E5%BC%95%E9%97%AE%E9%A2%98"><span class="toc-text"> 6，排序的索引问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_7%E3%80%81mysql%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E7%9A%84%E5%87%A0%E7%A7%8D%E6%83%85%E5%86%B5"><span class="toc-text"> 7、MySQL索引失效的几种情况</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E7%AB%A0-%E9%94%81%E6%9C%BA%E5%88%B6"><span class="toc-text"> 第七章 锁机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81innodb%E7%9A%84%E9%94%81%E7%B1%BB%E5%9E%8B"><span class="toc-text"> 一、InnoDB的锁类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81s%E9%94%81"><span class="toc-text"> 1、s锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81x%E9%94%81"><span class="toc-text"> 2、x锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81%E8%AE%B0%E5%BD%95%E9%94%81-record-lock"><span class="toc-text"> 3、记录锁（Record Lock）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4%E3%80%81%E9%97%B4%E9%9A%99%E9%94%81-gap-lock"><span class="toc-text"> 4、间隙锁（GAP Lock）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_5%E3%80%81%E8%AE%B0%E5%BD%95%E9%94%81%E5%92%8C%E9%97%B4%E9%9A%99%E9%94%81%E7%9A%84%E7%BB%84%E5%90%88-next-key-lock"><span class="toc-text"> 5、记录锁和间隙锁的组合（next-key lock）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_6%E3%80%81mdl%E9%94%81"><span class="toc-text"> 6、MDL锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_7%E3%80%81%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98"><span class="toc-text"> 7、死锁问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E8%A1%A8%E9%94%81"><span class="toc-text"> 二、表锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E4%BB%8E%E5%8F%A6%E4%B8%80%E4%B8%AA%E8%A7%92%E5%BA%A6%E5%8C%BA%E5%88%86%E9%94%81%E7%9A%84%E5%88%86%E7%B1%BB"><span class="toc-text"> 三、从另一个角度区分锁的分类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81%E4%B9%90%E8%A7%82%E9%94%81"><span class="toc-text"> 1、乐观锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E6%82%B2%E8%A7%82%E9%94%81"><span class="toc-text"> 2、悲观锁</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E7%AB%A0-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F"><span class="toc-text"> 第八章 日志系统</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81bin-log%E6%97%A5%E5%BF%97"><span class="toc-text"> 一、bin log日志</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81%E6%A6%82%E8%BF%B0"><span class="toc-text"> 1、概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D"><span class="toc-text"> 2、数据恢复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81%E6%A0%BC%E5%BC%8F%E5%88%86%E7%B1%BB"><span class="toc-text"> 3、格式分类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4%E3%80%81%E6%97%A5%E5%BF%97%E6%A0%BC%E5%BC%8F"><span class="toc-text"> 4、日志格式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_5%E3%80%81binlog%E5%88%B7%E7%9B%98"><span class="toc-text"> 5、binlog刷盘</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_6%E3%80%81binlog%E5%AE%9E%E7%8E%B0%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5"><span class="toc-text"> 6、binlog实现主从同步</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#_1-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90"><span class="toc-text"> （1） 主从复制工作原理剖析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#_2-%E6%80%8E%E4%B9%88%E9%85%8D%E7%BD%AEmysql%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-text"> （2）怎么配置mysql主从复制</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#_3-%E5%8F%AF%E8%83%BD%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text"> （3）可能遇到的问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%85%B6%E4%BB%96%E6%97%A5%E5%BF%97"><span class="toc-text"> 二、其他日志</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81%E9%80%9A%E7%94%A8%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97-%E9%BB%98%E8%AE%A4%E5%85%B3%E9%97%AD"><span class="toc-text"> 1、通用查询日志，默认关闭</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="toc-text"> 2、慢查询日志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97"><span class="toc-text"> 3、错误日志</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81redo-log%E6%97%A5%E5%BF%97"><span class="toc-text"> 三、redo log日志</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81mtr"><span class="toc-text"> 1、MTR</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81log-buffer"><span class="toc-text"> 2、log buffer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81checkpoint"><span class="toc-text"> 3、checkpoint</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4%E3%80%81%E4%B8%80%E4%B8%AA%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text"> 4、一个事务的执行流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_5%E3%80%81%E7%B3%BB%E7%BB%9F%E5%B4%A9%E6%BA%83%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="toc-text"> 5、系统崩溃的影响</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81undo-log%E6%97%A5%E5%BF%97"><span class="toc-text"> 四、undo log日志</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81%E6%A6%82%E8%BF%B0-1"><span class="toc-text"> 1、概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E4%BA%8B%E5%8A%A1id-trx-id"><span class="toc-text"> 2、事务id（trx_id）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81roll-pointer"><span class="toc-text"> 3、roll_pointer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4%E3%80%81%E5%88%86%E7%B1%BB"><span class="toc-text"> 4、分类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_5%E3%80%81%E7%89%A9%E7%90%86%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84"><span class="toc-text"> 5、物理存储结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_6%E3%80%81%E8%AE%B0%E5%BD%95%E6%B5%81%E7%A8%8B"><span class="toc-text"> 6、记录流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_7%E3%80%81%E5%9B%9E%E6%BB%9A%E8%BF%87%E7%A8%8B"><span class="toc-text"> 7、回滚过程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B9%9D%E7%AB%A0%E3%80%81%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E5%92%8Cmvcc"><span class="toc-text"> 第九章、隔离级别和MVCC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81read-view-%E8%AF%BB%E8%A7%86%E5%9B%BE"><span class="toc-text"> 一、Read View（读视图）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text"> 1、实现原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81readview%E7%9A%84%E7%BB%93%E6%9E%84"><span class="toc-text"> 2、readView的结构</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%BF%AB%E7%85%A7%E8%AF%BB%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90"><span class="toc-text"> 二、快照读原理解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E8%A7%A3%E5%86%B3%E8%84%8F%E8%AF%BB%E5%92%8C%E4%B8%8D%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB"><span class="toc-text"> 三、解决脏读和不可重复读</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81%E8%A7%A3%E5%86%B3%E8%84%8F%E8%AF%BB"><span class="toc-text"> 1、解决脏读</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E8%A7%A3%E5%86%B3%E4%B8%8D%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB"><span class="toc-text"> 2、解决不可重复读</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81%E8%A7%A3%E5%86%B3%E5%B9%BB%E8%AF%BB"><span class="toc-text"> 3、解决幻读</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E7%AB%A0-%E5%85%B6%E4%BB%96%E7%9F%A5%E8%AF%86"><span class="toc-text"> 第十章 其他知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-text"> 一、触发器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81%E8%A7%A6%E5%8F%91%E5%99%A8%E7%9A%84%E7%89%B9%E6%80%A7"><span class="toc-text"> 1、触发器的特性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E8%A7%A6%E5%8F%91%E5%99%A8%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="toc-text"> 2、触发器的创建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81%E5%88%A0%E9%99%A4%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-text"> 3、删除触发器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-text"> 二、存储过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81-%E5%8F%98%E9%87%8F"><span class="toc-text"> 1、 变量</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#_1-1-%E7%B3%BB%E7%BB%9F%E5%8F%98%E9%87%8F"><span class="toc-text"> 1.1 系统变量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#_1-2-%E7%94%A8%E6%88%B7%E5%8F%98%E9%87%8F"><span class="toc-text"> 1.2 用户变量</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="toc-text"> 2、存储过程的创建</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#_2-1-%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5"><span class="toc-text"> 2.1 流程控制语句</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%AD%98%E5%82%A8%E5%87%BD%E6%95%B0"><span class="toc-text"> 三、存储函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81%E5%88%9B%E5%BB%BA%E5%87%BD%E6%95%B0"><span class="toc-text"> 1、创建函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E4%BD%BF%E7%94%A8%E5%87%BD%E6%95%B0"><span class="toc-text"> 2、使用函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81%E6%9F%A5%E7%9C%8B%E5%87%BD%E6%95%B0"><span class="toc-text"> 3、查看函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4%E3%80%81%E5%88%A0%E9%99%A4%E5%87%BD%E6%95%B0"><span class="toc-text"> 4、删除函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-text"> 四、定时任务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_1%E3%80%81%E6%9F%A5%E7%9C%8B%E5%AE%9A%E6%97%B6%E7%AD%96%E7%95%A5%E6%98%AF%E5%90%A6%E5%BC%80%E5%90%AF"><span class="toc-text"> 1、查看定时策略是否开启</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_2%E3%80%81%E5%88%9B%E5%BB%BA%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-text"> 2、创建定时任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_3%E3%80%81%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%93%8D%E4%BD%9C"><span class="toc-text"> 3、定时任务操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_4%E3%80%81%E5%AE%9A%E6%97%B6%E8%A7%84%E5%88%99"><span class="toc-text"> 4、定时规则</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%BD%95"><span class="toc-text"> 附录：</span></a></li></ol></div><div class="widget-footer"><a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><!-- Icon from Solar by 480 Design - https://creativecommons.org/licenses/by/4.0/ --><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5"><path stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/><path d="M7 3.338A9.95 9.95 0 0 1 12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12c0-1.821.487-3.53 1.338-5"/></g></svg><span>回到顶部</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><!-- Icon from Solar by 480 Design - https://creativecommons.org/licenses/by/4.0/ --><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5" d="M8 10.5h8M8 14h5.5M17 3.338A9.95 9.95 0 0 0 12 2C6.477 2 2 6.477 2 12c0 1.6.376 3.112 1.043 4.453c.178.356.237.763.134 1.148l-.595 2.226a1.3 1.3 0 0 0 1.591 1.592l2.226-.596a1.63 1.63 0 0 1 1.149.133A9.96 9.96 0 0 0 12 22c5.523 0 10-4.477 10-10c0-1.821-.487-3.53-1.338-5"/></svg><span>参与讨论</span></a></div></widget>
</div></aside><div class='float-panel'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">


<script type="text/javascript">
  window.canonical = {"originalHost":"blog.thatcoder.cn","officialHosts":["localhost","en.blog.thatcoder.cn","hexo.thatcoder.cn","thatcoder.vercel.app","thatcoder.netlify.app","cn-coder.vercel.app","thatcoders.github.io","thatcoder.pages.dev","cncoder.pages.dev"],"encoded":"YmxvZy50aGF0Y29kZXIuY24="};
  const ctx = {
    date_suffix: {
      just: `刚刚`,
      min: `分钟前`,
      hour: `小时前`,
      day: `天前`,
    },
    root : `/`,
    tag_plugins: {
      chat: Object.assign({"api":"https://siteinfo.listentothewind.cn/api/v1"}),
    }
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"post, page, docs","path":"/search.json","content":true,"skip_search":null,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
    loading: `https://api.iconify.design/eos-icons:three-dots-loading.svg?color=%231cd0fd`,
  };
  const deps = {
    jquery: `https://gcore.jsdelivr.net/npm/jquery@3.7/dist/jquery.min.js`,
    marked: `https://gcore.jsdelivr.net/npm/marked@13.0/lib/marked.umd.min.js`,
    lazyload: `/%5Bobject%20Object%5D`
  }
  

</script>

<script type="text/javascript">
  
  function RunItem() {
    this.list = []; // 存放回调函数
    this.start = () => {
      for (var i = 0; i < this.list.length; i++) {
        this.list[i].run();
      }
    };
    this.push = (fn, name, setRequestAnimationFrame = true) => {
      let myfn = fn
      if (setRequestAnimationFrame) {
        myfn = () => {
          utils.requestAnimationFrame(fn)
        }
      }
      var f = new Item(myfn, name);
      this.list.push(f);
    };
    this.remove = (name) => {
      for (let index = 0; index < this.list.length; index++) {
        const e = this.list[index];
        if (e.name == name) {
          this.list.splice(index, 1);
        }
      }
    }
    // 构造一个可以run的对象
    function Item(fn, name) {
      // 函数名称
      this.name = name || fn.name;
      // run方法
      this.run = () => {
        try {
          fn()
        } catch (error) {
          console.log(error);
        }
      };
    }
  }

  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')) {
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function () {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },

    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      const maxRetry = 3;
      let retryCount = 0;

      return new Promise((resolve, reject) => {
        const load = () => {
          utils.onLoading?.(el);

          let timedOut = false;
          const timeout = setTimeout(() => {
            timedOut = true;
            console.warn('[request] 超时:', url);

            if (++retryCount >= maxRetry) {
              utils.onLoadFailure?.(el);
              onFailure?.();
              reject('请求超时');
            } else {
              setTimeout(load, 1000);
            }
          }, 5000);

          fetch(url).then(resp => {
            if (timedOut) return;
            clearTimeout(timeout);

            if (!resp.ok) throw new Error('响应失败');
            return resp;
          }).then(data => {
            if (timedOut) return;
            utils.onLoadSuccess?.(el);
            callback(data);
            resolve(data);
          }).catch(err => {
            clearTimeout(timeout);
            console.warn('[request] 错误:', err);

            if (++retryCount >= maxRetry) {
              utils.onLoadFailure?.(el);
              onFailure?.();
              reject(err);
            } else {
              setTimeout(load, 1000);
            }
          });
        };

        load();
      });
    },
    requestWithoutLoading: (url, options = {}, maxRetry = 2, timeout = 5000) => {
      return new Promise((resolve, reject) => {
        let retryCount = 0;

        const tryRequest = () => {
          let timedOut = false;
          const timer = setTimeout(() => {
            timedOut = true;
            if (++retryCount > maxRetry) reject('timeout');
            else tryRequest();
          }, timeout);

          fetch(url, options)
            .then(resp => {
              clearTimeout(timer);
              if (!resp.ok) throw new Error('bad response');
              resolve(resp);
            })
            .catch(err => {
              clearTimeout(timer);
              if (++retryCount > maxRetry) reject(err);
              else setTimeout(tryRequest, 500);
            });
        };

        tryRequest();
      });
    },
    /********************** requestAnimationFrame ********************************/
    // 1、requestAnimationFrame 会把每一帧中的所有 DOM 操作集中起来，在一次重绘或回流中就完成，并且重绘或回流的时间间隔紧紧跟随浏览器的刷新频率，一般来说，这个频率为每秒60帧。
    // 2、在隐藏或不可见的元素中，requestAnimationFrame 将不会进行重绘或回流，这当然就意味着更少的的 cpu，gpu 和内存使用量。
    requestAnimationFrame: (fn) => {
      if (!window.requestAnimationFrame) {
        window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame;
      }
      window.requestAnimationFrame(fn)
    },
    dark: {},
  };

  // utils.dark.mode 当前模式 dark or light
  // utils.dark.toggle() 暗黑模式触发器
  // utils.dark.push(callBack[,"callBackName"]) 传入触发器回调函数
  utils.dark.method = {
    toggle: new RunItem(),
  };
  utils.dark = Object.assign(utils.dark, {
    push: utils.dark.method.toggle.push,
  });
</script>
<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>
<script type="text/javascript">
  (() => {
    const tagSwitchers = document.querySelectorAll('.tag-subtree.parent-tag > a > .tag-switcher-wrapper')
    for (const tagSwitcher of tagSwitchers) {
      tagSwitcher.addEventListener('click', (e) => {
        const parent = e.target.closest('.tag-subtree.parent-tag')
        parent.classList.toggle('expanded')
        e.preventDefault()
      })
    }

    // Get active tag from query string, then activate it.
    const urlParams = new URLSearchParams(window.location.search)
    const activeTag = urlParams.get('tag')
    if (activeTag) {
      let tag = document.querySelector(`.tag-subtree[data-tag="${activeTag}"]`)
      if (tag) {
        tag.querySelector('a').classList.add('active')
        
        while (tag) {
          tag.classList.add('expanded')
          tag = tag.parentElement.closest('.tag-subtree.parent-tag')
        }
      }
    }
  })()
</script>

<script async src="https://gcore.jsdelivr.net/npm/vanilla-lazyload@19.1/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
    callback_loaded: (el) => {
      el.classList.add('loaded');
      const wrapper = el.closest('.lazy-box');
      const icon = wrapper?.querySelector('.lazy-icon');
      if (icon) icon.remove();
    }
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });

  window.wrapLazyloadImages = (container) => {
    if (typeof container === 'string') {
      container = document.querySelector(container);
    }
    if (!container) return;
    
    const images = container.querySelectorAll('img');
    images.forEach((img) => {
      if (img.classList.contains('lazy')) return;

      const src = img.getAttribute('src');
      if (!src) return;

      const wrapper = document.createElement('div');
      wrapper.className = 'lazy-box';

      const newImg = img.cloneNode();
      newImg.removeAttribute('src');
      newImg.setAttribute('data-src', src);
      newImg.classList.add('lazy');

      const icon = document.createElement('div');
      icon.className = 'lazy-icon';
      if (def.loading) {
        icon.style.backgroundImage = `url("${def.loading}")`;
      }

      wrapper.appendChild(newImg);
      wrapper.appendChild(icon);

      img.replaceWith(wrapper);
    });

    // 通知 LazyLoad 更新
    if (window.lazyLoadInstance?.update) {
      window.lazyLoadInstance.update();
    }
  }
  
</script>

<!-- required -->
<script src="/js/main.js?v=1.33.1" defer></script>

<script type="text/javascript">
  const applyTheme = (theme) => {
    if (theme === 'auto') {
      document.documentElement.removeAttribute('data-theme')
    } else {
      document.documentElement.setAttribute('data-theme', theme)
    }

    // applyThemeToGiscus(theme)
  }

  // FIXME: 这会导致无法使用 preferred_color_scheme 以外的主题
  const applyThemeToGiscus = (theme) => {
    // theme = theme === 'auto' ? 'preferred_color_scheme' : theme
    const cmt = document.getElementById('giscus')
    if (cmt) {
      // This works before giscus load.
      cmt.setAttribute('data-theme', theme)
    }

    const iframe = document.querySelector('#comments > section.giscus > iframe')
    if (iframe) {
      // This works after giscus loaded.
      const src = iframe.src
      const newSrc = src.replace(/theme=[\w]+/, `theme=${theme}`)
      iframe.src = newSrc
    }
  }

  const switchTheme = () => {
    // light -> dark -> auto -> light -> ...
    const currentTheme = document.documentElement.getAttribute('data-theme')
    let newTheme;
    switch (currentTheme) {
      case 'light':
        newTheme = 'dark'
        break
      case 'dark':
        newTheme = 'auto'
        break
      default:
        newTheme = 'light'
    }
    applyTheme(newTheme)
    window.localStorage.setItem('Stellar.theme', newTheme)
    utils.dark.mode = newTheme === 'auto' ? (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light") : newTheme;
    utils.dark.method.toggle.start();

    const messages = {
      light: `切换到浅色模式`,
      dark: `切换到深色模式`,
      auto: `切换到跟随系统配色`,
    }
    hud?.toast?.(messages[newTheme])
  }

  (() => {
    // Apply user's preferred theme, if any.
    const theme = window.localStorage.getItem('Stellar.theme')
    if (theme !== null) {
      applyTheme(theme)
    } else {
      utils.dark.mode = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    }
    utils.dark.method.toggle.start();
  })()
</script>


<!-- optional -->

  <script type="module">
  import { init } from 'https://gcore.jsdelivr.net/npm/@waline/client@3.1/dist/waline.js';

  const el = document.getElementById('waline_container');
  util.viewportLazyload(el, load_waline, false);

  function load_waline(){
    if (!el) return;

    utils.css('https://gcore.jsdelivr.net/npm/@waline/client@3.1/dist/waline.css');
    utils.css('https://gcore.jsdelivr.net/npm/@waline/client@3.1/dist/waline-meta.css');

    const path = el.getAttribute('comment_id') ?? decodeURI(window.location.pathname);
    const waline = init(Object.assign({"js":"https://gcore.jsdelivr.net/npm/@waline/client@3.1/dist/waline.js","css":"https://gcore.jsdelivr.net/npm/@waline/client@3.1/dist/waline.css","meta_css":"https://gcore.jsdelivr.net/npm/@waline/client@3.1/dist/waline-meta.css","serverURL":"https://waline.thatapi.cn/","commentCount":true,"pageview":false,"search":false,"locale":{"placeholder":"  遇事不决, 可问春风..."},"emoji":["https://upyun.thatcdn.cn/public/web/emojis/bilibili","https://upyun.thatcdn.cn/public/web/emojis/qq","https://upyun.thatcdn.cn/public/web/emojis/tieba","https://upyun.thatcdn.cn/public/web/emojis/weibo"],"reaction":["https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_thumbsup.png","https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_cute.png","https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_sunglasses.png","https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_crazy.png","https://upyun.thatcdn.cn/public/web/emojis/bilibili/bb_trollface.png"],"meta":["nick","mail","link"],"imageUploader":{"fileName":"file","tokenName":"Authorization","api":"https://lsky.thatcoder.cn/api/v1/upload","token":"Bearer 6|x9vHGJGHAnjqbO0PGEE5vM7r9S9hdqFA9bmdESdm","resp":"data.links.url"}}, {
      el: '#waline_container',
      path: path,
      
        imageUploader: function(file) {
          const headers = new Headers();
          headers.set('Accept', 'application/json');
          
            headers.set('Authorization', 'Bearer 6|x9vHGJGHAnjqbO0PGEE5vM7r9S9hdqFA9bmdESdm')
          
          const formData = new FormData();
          formData.append('file', file);
          return fetch('https://lsky.thatcoder.cn/api/v1/upload',{
            method: 'POST',
            body: formData,
            headers: headers
            }).then((resp) => resp.json())
              .then((resp) => resp.data.links.url)
        },
      
    }));
  }
</script>




<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"rating":{"js":"/js/services/rating.js","api":"https://star-vote.xaox.cc/api/rating"},"vote":{"js":"/js/services/vote.js","api":"https://star-vote.xaox.cc/api/vote"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"friends_and_posts":{"js":"/js/services/friends_and_posts.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"},"voice":{"js":"/js/plugins/voice.js"},"video":{"js":"/js/plugins/video.js"},"download-file":{"js":"/js/plugins/download-file.js"},"twikoo":{"js":"/js/services/twikoo_latest_comment.js"},"waline":{"js":"/js/services/waline_latest_comment.js"},"artalk":{"js":"/js/services/artalk_latest_comment.js"},"giscus":{"js":"/js/services/giscus_latest_comment.js"},"contributors":{"edit_this_page":{"_posts/":null,"wiki/stellar/":"https://github.com/xaoxuu/hexo-theme-stellar-docs/blob/main/"},"js":"/js/services/contributors.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else if (id == 'voice') {
        ctx.voiceAudios = document.querySelectorAll('.voice>audio');
        if (ctx.voiceAudios?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            createVoiceDom(ctx.voiceAudios);
          });
        }
      } else if (id == 'video') {
        ctx.videos = document.querySelectorAll('.video>video');
        if (ctx.videos?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            videoEvents(ctx.videos);
          });
        }
      } else if (id == 'download-file') {
        ctx.files = document.querySelectorAll('.file');
        if (ctx.files?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            downloadFileEvent(ctx.files);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }

    // chat iphone time
    let phoneTimes = document.querySelectorAll('.chat .status-bar .time');

    if (phoneTimes.length > 0) {
      NowTime();
      var date = new Date();
      var sec = date.getSeconds();
      var firstAdjustInterval = setInterval(firstAdjustTime, 1000 * (60 - sec));
    }

    function firstAdjustTime() {
      NowTime();
      clearInterval(firstAdjustInterval);
      setInterval(NowTime, 1000 * 60);
    }

    function NowTime() {
      for (let i = 0; i < phoneTimes.length; ++i) {
        var timeSpan = phoneTimes[i];
        var date = new Date();
        var hour = date.getHours();
        var min = date.getMinutes();
        timeSpan.innerHTML = check(hour) + ":" + check(min);
      }
    };

    function check(val) {
      if (val < 10) {
        return ("0" + val);
      }
      return (val);
    }

    // chat quote
    const chat_quote_obverser = new IntersectionObserver((entries, observer) => {
      entries.filter((entry) => { return entry.isIntersecting }).sort((a, b) => a.intersectionRect.y !== b.intersectionRect.y ? a.intersectionRect.y - b.intersectionRect.y : a.intersectionRect.x - b.intersectionRect.x).forEach((entry, index) => {
          observer.unobserve(entry.target);
          setTimeout(() => {
            entry.target.classList.add('quote-blink');
            setTimeout(() => {
              entry.target.classList.remove('quote-blink');
            }, 1000);
          }, Math.max(100, 16) * (index + 1));
        });
    });

    var chatQuotes = document.querySelectorAll(".chat .talk .quote");
    chatQuotes.forEach((quote) => {
      quote.addEventListener('click', function () {
        var chatCellDom = document.getElementById("quote-" + quote.getAttribute("quotedCellTag"));
        if (chatCellDom) {
          var chatDiv = chatCellDom.parentElement;
          var mid = chatDiv.clientHeight / 2;
          var offsetTop = chatCellDom.offsetTop;
          if (offsetTop > mid - chatCellDom.clientHeight / 2) {
            chatDiv.scrollTo({
              top: chatCellDom.offsetTop - mid + chatCellDom.clientHeight / 2,
              behavior: "smooth"
            });
          } else {
            chatDiv.scrollTo({
              top: 0,
              behavior: "smooth"
            });
          }
          chat_quote_obverser.observe(chatCellDom);
        }
      });
    });
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://gcore.jsdelivr.net/npm/flying-pages@2/flying-pages.min.js"></script><script>
  ctx.fancybox = {
    selector: `.swiper-slide img, .md-text.content p>img, .md-text.content li img , .wl-content img, waline_container .vcontent img, .timeline .body .image img,  .timeline .gallery img`,
    css: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.min.css`,
    js: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.umd.min.js`
  };
  var selector = '[data-fancybox]:not(.error), .with-fancybox .atk-content img:not([atk-emoticon])';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const memos = document.getElementsByClassName('ds-memos');
    if (memos != undefined && memos.length > 0) {
      needFancybox = true;
    }
    const fancybox = document.getElementsByClassName('with-fancybox');
    if (fancybox != undefined && fancybox.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>




<!-- inject -->
<script type="text/javascript" src="/custom/js/ZYUtil.js"></script><script type="text/javascript" src="/custom/js/ZYDark.js"></script><script type="text/javascript" src="/custom/js/ZYCategory.js"></script><script type="text/javascript" src="/custom/js/ZYCode.js"></script><script type="text/javascript" src="/custom/js/timetmpl.js"></script>
</div></body></html>
